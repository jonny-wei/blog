# 发生了什么

![从url到页面渲染](/blog/images/javascript/从url到页面渲染.png)

- 输入信息处理
- DNS 查询
- TCP 连接
- 处理请求
- 接受响应
- 渲染页面


## 输入信息处理

处理输入信息，URL 解析。

- 检查用户输入

    当用户在地址栏中输入一个查询关键字时，地址栏会判断输入的关键字是搜索内容，还是请求的 URL。根据输入内容进行自动完成，字符编码等。此外还有安全检查，访问限制等操作。如果是搜索内容，地址栏会使用浏览器默认的搜索引擎，来合成新的带搜索关键字的 URL。如果判断输入内容符合 URL 规则，比如输入的是 time.geekbang.org，那么地址栏会根据规则，把这段内容加上协议，合成为完整的 URL。

- beforeunload 事件

    当用户输入关键字并键入回车之后，这意味着当前页面即将要被替换成新的页面，不过在这个流程继续之前，浏览器还给了当前页面一次执行 beforeunload 事件的机会，beforeunload 事件允许页面在退出之前执行一些数据清理操作，还可以询问用户是否要离开当前页面，比如当前页面可能有未提交完成的表单等情况，因此用户可以通过 beforeunload 事件来取消导航，让浏览器不再执行任何后续工作。

- 浏览器进入加载状态

    当浏览器刚开始加载一个地址之后，标签页上的图标便进入了加载状态。但此时图中页面显示的依然是之前打开的页面内容，并没立即替换为新的页面。因为需要等待提交文档阶段，页面内容才会被替换。

## DNS 查询

- 发送到网络进程

    浏览器进程会通过进程间通信（IPC）把 URL 请求发送至网络进程。

- 检查缓存

    网络进程会查找本地缓存是否缓存了该资源。如果有缓存资源，那么直接返回资源给浏览器进程(浏览器缓存中的强制缓存)，若无缓存，则直接进入网络请求流程。

    [浏览器缓存](./browser-cache)

- DNS 解析

    对 URL进行 DNS 解析(DNS)，以获取请求域名的服务器 IP 地址和端口号。如果没有端口号，http 默认80，https 默认 443 如果请求协议是 HTTPS，那么还需要建立 TLS 连接。

    [DNS 解析](./DNS)

## 建立 TCP 连接

首先，判断是不是 https 的，如果是，则 HTTPS 其实是 HTTP + SSL / TLS 两部分组成，也就是在 HTTP上又加了一层处理加密信息的模块。服务端和客户端的信息传输都会通过 TLS 进行加密，所以传输的数据都是加密后的数据。

进入 TCP 队列（单个域名 TCP 连接数量限制），通过**三次握手机制**与服务器建立连接。Chrome 有个机制，同一个域名同时最多只能建立 6 个TCP 连接，如果在同一个域名下同时有 10 个请求发生，那么其中 4 个请求会进入排队等待状态，直至进行中的请求完成。如果当前请求数量少于6个，会直接建立 TCP 连接。
