<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Modules 相关 | 花帽子的博客</title>
    <meta name="generator" content="VuePress 1.7.1">
    <link rel="icon" href="/blog/logo.png">
    <link rel="manifest" href="/blog/manifest.json">
    <link rel="apple-touch-icon" href="/blog/images/icons/apple-icon-152x152.png">
    <meta name="description" content="我命由我不由天，学习吧少年">
    <meta name="theme-color" content="#3eaf7c">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="msapplication-TileImage" content="/icons/ms-icon-144x144.png">
    <meta name="msapplication-TileColor" content="#000000">
    
    <link rel="preload" href="/blog/assets/css/0.styles.533f0e28.css" as="style"><link rel="preload" href="/blog/assets/js/app.2821f556.js" as="script"><link rel="preload" href="/blog/assets/js/2.2a4e8c54.js" as="script"><link rel="preload" href="/blog/assets/js/41.6eb48082.js" as="script"><link rel="preload" href="/blog/assets/js/3.07d27621.js" as="script"><link rel="prefetch" href="/blog/assets/js/10.3410372d.js"><link rel="prefetch" href="/blog/assets/js/11.6c56b536.js"><link rel="prefetch" href="/blog/assets/js/12.eee35601.js"><link rel="prefetch" href="/blog/assets/js/13.270a6794.js"><link rel="prefetch" href="/blog/assets/js/14.451572de.js"><link rel="prefetch" href="/blog/assets/js/15.ca64dcee.js"><link rel="prefetch" href="/blog/assets/js/16.ba074823.js"><link rel="prefetch" href="/blog/assets/js/17.301089ac.js"><link rel="prefetch" href="/blog/assets/js/18.2036e4f3.js"><link rel="prefetch" href="/blog/assets/js/19.dc4f17ec.js"><link rel="prefetch" href="/blog/assets/js/20.d58dfb58.js"><link rel="prefetch" href="/blog/assets/js/21.18de6651.js"><link rel="prefetch" href="/blog/assets/js/22.e67f6bbb.js"><link rel="prefetch" href="/blog/assets/js/23.52be8b8c.js"><link rel="prefetch" href="/blog/assets/js/24.fe312cae.js"><link rel="prefetch" href="/blog/assets/js/25.6f72a1cb.js"><link rel="prefetch" href="/blog/assets/js/26.bd83302b.js"><link rel="prefetch" href="/blog/assets/js/27.10dc293f.js"><link rel="prefetch" href="/blog/assets/js/28.3d268ed5.js"><link rel="prefetch" href="/blog/assets/js/29.d37af507.js"><link rel="prefetch" href="/blog/assets/js/30.3945b931.js"><link rel="prefetch" href="/blog/assets/js/31.c81caf9f.js"><link rel="prefetch" href="/blog/assets/js/32.bc272819.js"><link rel="prefetch" href="/blog/assets/js/33.58cc081c.js"><link rel="prefetch" href="/blog/assets/js/34.f162aa54.js"><link rel="prefetch" href="/blog/assets/js/35.f719bbdd.js"><link rel="prefetch" href="/blog/assets/js/36.242ccf10.js"><link rel="prefetch" href="/blog/assets/js/37.0963c53b.js"><link rel="prefetch" href="/blog/assets/js/38.9021aae8.js"><link rel="prefetch" href="/blog/assets/js/39.82b23bc1.js"><link rel="prefetch" href="/blog/assets/js/4.d42ebbba.js"><link rel="prefetch" href="/blog/assets/js/40.0abd4217.js"><link rel="prefetch" href="/blog/assets/js/42.c241a12f.js"><link rel="prefetch" href="/blog/assets/js/43.ad9be99f.js"><link rel="prefetch" href="/blog/assets/js/44.bd86ca74.js"><link rel="prefetch" href="/blog/assets/js/45.d0b8236b.js"><link rel="prefetch" href="/blog/assets/js/46.0b7bd0c7.js"><link rel="prefetch" href="/blog/assets/js/5.5d40c251.js"><link rel="prefetch" href="/blog/assets/js/6.08d6e999.js"><link rel="prefetch" href="/blog/assets/js/7.96560134.js"><link rel="prefetch" href="/blog/assets/js/8.f4a7eed1.js"><link rel="prefetch" href="/blog/assets/js/9.0c0116f6.js">
    <link rel="stylesheet" href="/blog/assets/css/0.styles.533f0e28.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/blog/" class="home-link router-link-active"><img src="/blog/logo.png" alt="花帽子的博客" class="logo"> <span class="site-name can-hide">花帽子的博客</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/blog/" class="nav-link">
  主页
</a></div><div class="nav-item"><a href="/blog/vue/" class="nav-link router-link-active">
  Vue
</a></div><div class="nav-item"><a href="/blog/css/" class="nav-link">
  CSS
</a></div><div class="nav-item"><a href="/blog/typescript/" class="nav-link">
  TS
</a></div><div class="nav-item"><a href="/blog/optimization/" class="nav-link">
  优化
</a></div><div class="nav-item"><a href="/blog/mobile/" class="nav-link">
  移动端
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="GitHub" class="dropdown-title"><span class="title">GitHub</span> <span class="arrow down"></span></button> <button type="button" aria-label="GitHub" class="mobile-dropdown-title"><span class="title">GitHub</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/jonny-wei" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub地址
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/blog/" class="nav-link">
  主页
</a></div><div class="nav-item"><a href="/blog/vue/" class="nav-link router-link-active">
  Vue
</a></div><div class="nav-item"><a href="/blog/css/" class="nav-link">
  CSS
</a></div><div class="nav-item"><a href="/blog/typescript/" class="nav-link">
  TS
</a></div><div class="nav-item"><a href="/blog/optimization/" class="nav-link">
  优化
</a></div><div class="nav-item"><a href="/blog/mobile/" class="nav-link">
  移动端
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="GitHub" class="dropdown-title"><span class="title">GitHub</span> <span class="arrow down"></span></button> <button type="button" aria-label="GitHub" class="mobile-dropdown-title"><span class="title">GitHub</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/jonny-wei" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub地址
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Vue秘籍</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/vue/vue/guide.html" class="sidebar-link">js 高级技巧</a></li><li><a href="/blog/vue/vue/vue-render.html" class="sidebar-link">vue渲染原理</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Vue源码解析</span> <!----></p> <!----></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>VueRouter源码解析</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/vue/vue-router/abstract.html" class="sidebar-link">摘要</a></li><li><a href="/blog/vue/vue-router/warmUp.html" class="sidebar-link">准备工作</a></li><li><a href="/blog/vue/vue-router/plugin.html" class="sidebar-link">插件机制</a></li><li><a href="/blog/vue/vue-router/initialization.html" class="sidebar-link">初始化与降级处理</a></li><li><a href="/blog/vue/vue-router/transitions.html" class="sidebar-link">路由过渡与视图渲染</a></li><li><a href="/blog/vue/vue-router/match.html" class="sidebar-link">路由匹配</a></li><li><a href="/blog/vue/vue-router/scroll.html" class="sidebar-link">滚动行为处理</a></li><li><a href="/blog/vue/vue-router/summary.html" class="sidebar-link">总结</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Vuex源码解析</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/vue/vuex/abstract.html" class="sidebar-link">摘要</a></li><li><a href="/blog/vue/vuex/warmUp.html" class="sidebar-link">准备工作</a></li><li><a href="/blog/vue/vuex/initialization.html" class="sidebar-link">初始化与模块安装</a></li><li><a href="/blog/vue/vuex/state.html" class="sidebar-link">State 相关</a></li><li><a href="/blog/vue/vuex/getters.html" class="sidebar-link">Getters 相关</a></li><li><a href="/blog/vue/vuex/mutations.html" class="sidebar-link">Mutations 相关</a></li><li><a href="/blog/vue/vuex/actions.html" class="sidebar-link">Actions 相关</a></li><li><a href="/blog/vue/vuex/modules.html" aria-current="page" class="active sidebar-link">Modules 相关</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/vue/vuex/modules.html#构造器选项之一" class="sidebar-link">构造器选项之一</a></li><li class="sidebar-sub-header"><a href="/blog/vue/vuex/modules.html#模块动态注册" class="sidebar-link">模块动态注册</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/vue/vuex/modules.html#如何动态注册" class="sidebar-link">如何动态注册</a></li><li class="sidebar-sub-header"><a href="/blog/vue/vuex/modules.html#registermodule" class="sidebar-link">registerModule</a></li><li class="sidebar-sub-header"><a href="/blog/vue/vuex/modules.html#unregistermodule" class="sidebar-link">unregisterModule</a></li></ul></li><li class="sidebar-sub-header"><a href="/blog/vue/vuex/modules.html#模块重用" class="sidebar-link">模块重用</a></li></ul></li><li><a href="/blog/vue/vuex/others.html" class="sidebar-link">其他</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Vue3新特性</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/vue/vue3.x/abstract.html" class="sidebar-link">摘要</a></li><li><a href="/blog/vue/vue3.x/reactivity.html" class="sidebar-link">响应式系统</a></li><li><a href="/blog/vue/vue3.x/features.html" class="sidebar-link">功能方面</a></li><li><a href="/blog/vue/vue3.x/performance.html" class="sidebar-link">性能方面</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="modules-相关"><a href="#modules-相关" class="header-anchor">#</a> Modules 相关</h1> <p>Vuex 允许我们将 store 分割成模块（module）。每个模块拥有自己的 state、mutation、action、getter、甚至是嵌套子模块。</p> <p>对于模块内部的 mutation 和 getter，接收的第一个参数是模块的局部状态对象 state 。同样，对于模块内部的 action，局部状态通过 context.state 暴露出来，根节点状态则为 context.rootState。
对于模块内部的 getter，根节点状态会作为第三个参数暴露出来。</p> <p>默认情况下，模块内部的 action、mutation 和 getter 是注册在全局命名空间的——这样使得多个模块能够对同一 mutation 或 action 作出响应。
但可以通过添加 namespaced: true 的方式使其成为带命名空间的模块。当模块被注册后，它的所有 getter、action 及 mutation 都会自动根据模块注册的路径调整命名。
启用了命名空间的 getter 和 action 会收到局部化的 getter，dispatch 和 commit。不需要在同一模块内额外添加空间名前缀。</p> <h2 id="构造器选项之一"><a href="#构造器选项之一" class="header-anchor">#</a> 构造器选项之一</h2> <p><strong>modules</strong> 是 <code>Vuex.Store</code> 构造器选项之一，需要用户设置，官方 API 说明如下：</p> <p>包含了子模块的对象，会被合并到 store：</p> <div class="language-text extra-class"><pre class="language-text"><code>{
  key: {
    state,
    namespaced?,
    mutations,
    actions?,
    getters?,
    modules?
  },
  ...
}
</code></pre></div><p>与根模块的选项一样，每个模块也包含 state 和 mutations 选项。模块的状态使用 key 关联到 store 的根状态。
模块的 mutation 和 getter 只会接收 module 的局部状态作为第一个参数，而不是根状态，并且模块 action 的 context.state 同样指向局部状态。</p> <h2 id="模块动态注册"><a href="#模块动态注册" class="header-anchor">#</a> 模块动态注册</h2> <p>在 Vuex 初始化阶段我们构造了模块树，初始化了模块上各个部分。在有一些场景下，我们需要动态去注入一些新的模块，
Vuex 提供了模块动态注册功能，在 store 上提供了一个 <code>registerModule</code> 的 API。</p> <h3 id="如何动态注册"><a href="#如何动态注册" class="header-anchor">#</a> 如何动态注册</h3> <p>在 store 创建之后，你可以使用 store.registerModule 方法注册模块：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// 注册模块 `myModule`</span>
store<span class="token punctuation">.</span><span class="token function">registerModule</span><span class="token punctuation">(</span><span class="token string">'myModule'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">// 注册嵌套模块 `nested/myModule`</span>
store<span class="token punctuation">.</span><span class="token function">registerModule</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'nested'</span><span class="token punctuation">,</span> <span class="token string">'myModule'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>之后就可以通过 store.state.myModule 和 store.state.nested.myModule 访问模块的状态。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>store<span class="token punctuation">.</span><span class="token function">registerModule</span><span class="token punctuation">(</span><span class="token string">'a'</span><span class="token punctuation">,</span> module<span class="token punctuation">,</span> <span class="token punctuation">{</span> preserveState<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>在注册一个新 module 时，你很有可能想保留过去的 state，例如从一个服务端渲染的应用保留 state。可以设置 <code>{ preserveState: true }</code>，
设置 <code>preserveState</code> 为 <code>true</code> 后，该模块会被注册，<code>action</code>、<code>mutation</code> 和 <code>getter</code> 会被添加到 <code>store</code> 中，<strong>但是 state 不会</strong>。
这里假设 store 的 state 已经包含了这个 module 的 state 并且你不希望将其覆写。</p> <h3 id="registermodule"><a href="#registermodule" class="header-anchor">#</a> registerModule</h3> <p><strong>registerModule</strong> 是<code>Vuex.Store</code> 的实例方法，官方 API 说明如下：</p> <div class="language-text extra-class"><pre class="language-text"><code>registerModule(path: string | Array&lt;string&gt;, module: Module, options?: Object)
  注册一个动态模块。
  options 可以包含 preserveState: true 以允许保留之前的 state。用于服务端渲染。
</code></pre></div><p><code>registerModule</code> 的作用是注册一个动态模块，有的时候当我们异步加载一些业务的时候，可以通过这个 API 接口去动态注册模块。</p> <p><code>registerModule</code> 的实现逻辑如下：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">/* src/store.js */</span>

<span class="token comment">/**
 * 动态注册模块
 * @param {Array|String} path 路径
 * @param {Object} rawModule 原始未加工的模块
 * @param {Object} options 参数选项
 */</span>
<span class="token function">registerModule</span> <span class="token punctuation">(</span><span class="token parameter">path<span class="token punctuation">,</span> rawModule<span class="token punctuation">,</span> options <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">/* 保证path是一个数组（符合vuex安装的规则）*/</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> path <span class="token operator">===</span> <span class="token string">'string'</span><span class="token punctuation">)</span> path <span class="token operator">=</span> <span class="token punctuation">[</span>path<span class="token punctuation">]</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">'production'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">assert</span><span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">module path must be a string or an Array.</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
      <span class="token function">assert</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">'cannot register the root module by using registerModule.'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
     <span class="token comment">/* 调用 moduleCollection 实例的 register 方法，根据 path 动态注册模块 */</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_modules<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> rawModule<span class="token punctuation">)</span>
    <span class="token comment">/* 初始化 */</span>
    <span class="token function">installModule</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">,</span> path<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_modules<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">,</span> options<span class="token punctuation">.</span>preserveState<span class="token punctuation">)</span>
    <span class="token comment">// reset store to update getters...</span>
    <span class="token comment">/* 重新重置所有的state（实例化一个vm存储state和getters）*/</span>
    <span class="token function">resetStoreVM</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
</code></pre></div><p>和<strong>初始化 Store</strong> 的逻辑一样，调用 <code>installModule</code> 和 <code>resetStoreVm</code> 方法安装一遍动态注入的 <code>module</code></p> <p><code>registerModule</code> 支持传入一个 <code>path 模块路径</code> 和 <code>rawModule 模块定义</code>，首先调用 <code>moduleCollection</code> 实例的 <code>register</code> 方法扩展我们的模块树，
接着执行 <code>installModule</code> 去初始化模块，最后执行 <code>resetStoreVM</code> <strong>重新实例化 store._vm</strong>，并<strong>销毁旧的 store._vm</strong>。</p> <p>函数首先对 <code>path</code> 判断，如果 path 是一个 <code>string</code> 则把 path 转换成一个 <code>Array</code>。接着 <code>this._modules.register</code> 把 <code>module</code> 注册到 <code>_modules</code> 中。
<code>this._modules.register</code> 方法如下：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">/* src/module/module-collection.js */</span>

<span class="token comment">/**
  * 根据配置项生成 ModuleCollection 实例，即所有模块集合
  * 一般一个 Vuex 实例只有一个模块集合，一个模块集合又有多个模块实例组成
  * runtime 为 true 时，代表动态注入的模块，初始化时传入 false
  */</span>
  <span class="token function">register</span> <span class="token punctuation">(</span><span class="token parameter">path<span class="token punctuation">,</span> rawModule<span class="token punctuation">,</span> runtime <span class="token operator">=</span> <span class="token boolean">true</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">'production'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">assertRawModule</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> rawModule<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/* 实例化一个module 传入当前 Module 的配置项 */</span>
    <span class="token keyword">const</span> newModule <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Module</span><span class="token punctuation">(</span>rawModule<span class="token punctuation">,</span> runtime<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>path<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">/* path为空数组的代表跟节点 将根module 绑定到root属性上 
      定义唯一的一个实例属性 root，指向根 module 实例*/</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>root <span class="token operator">=</span> newModule
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">/**
      *  获取父级module 找到当前模块的父模块
      *  path.slice(0, -1) 为除去最后一个元素的 path 数组，即当前模块父模块的 path 数组
      */</span>
      <span class="token keyword">const</span> parent <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token comment">/**
      * 在父module中插入一个子module
      * 给当前模块的父模块的 _children 属性添加当前模块
      * 即注册子模块 
      */</span>
      parent<span class="token punctuation">.</span><span class="token function">addChild</span><span class="token punctuation">(</span>path<span class="token punctuation">[</span>path<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> newModule<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// register nested modules </span>
    <span class="token comment">// 递归注册当前 module 的子 modules 遍历子模块，逐个注册，最终形成一个树</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>rawModule<span class="token punctuation">.</span>modules<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">forEachValue</span><span class="token punctuation">(</span>rawModule<span class="token punctuation">.</span>modules<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">rawChildModule<span class="token punctuation">,</span> key</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token comment">/**
        * 将 path 数组合并上当前模块子模块的属性名，
        * 传入递归 register 函数中，作为模块的前缀（命名空间）
        */</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">,</span> rawChildModule<span class="token punctuation">,</span> runtime<span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre></div><p>这个方法之前解析过，可以去 <a href="/blog/vue/vuex/initialization.html#installmodule-的实现">回顾一下</a></p> <h3 id="unregistermodule"><a href="#unregistermodule" class="header-anchor">#</a> unregisterModule</h3> <p><strong>unregisterModule</strong> 是<code>Vuex.Store</code> 的实例方法，官方 API 说明如下：</p> <div class="language-text extra-class"><pre class="language-text"><code>unregisterModule(path: string | Array&lt;string&gt;)
  卸载一个动态模块。
</code></pre></div><p><code>unregisterModule</code> 的实现逻辑如下：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">/* src/store.js */</span>

 <span class="token function">unregisterModule</span> <span class="token punctuation">(</span><span class="token parameter">path</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">/* 转化称Array */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> path <span class="token operator">===</span> <span class="token string">'string'</span><span class="token punctuation">)</span> path <span class="token operator">=</span> <span class="token punctuation">[</span>path<span class="token punctuation">]</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">'production'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">assert</span><span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">module path must be a string or an Array.</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
     <span class="token comment">/* 通过 path 从对应的模块中通过 delete 操作符删除属性 */</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_modules<span class="token punctuation">.</span><span class="token function">unregister</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_withCommit</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token comment">/* 获取父级的state */</span>
      <span class="token keyword">const</span> parentState <span class="token operator">=</span> <span class="token function">getNestedState</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">,</span> path<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token comment">/* 从父级中删除该模块*/</span>
      Vue<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>parentState<span class="token punctuation">,</span> path<span class="token punctuation">[</span>path<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token comment">/* 重制 store */</span>
    <span class="token function">resetStore</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
</code></pre></div><p>函数首先还是对 path 的类型做了判断，这部分逻辑和注册是一样的。接着从 <code>_modules</code> 里删掉模块。<code>this._modules.unregister(path)</code> 方法如下：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">/* src/module/module-collection.js */</span>

<span class="token function">unregister</span> <span class="token punctuation">(</span><span class="token parameter">path</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> parent <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> key <span class="token operator">=</span> path<span class="token punctuation">[</span>path<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>parent<span class="token punctuation">.</span><span class="token function">getChild</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">.</span>runtime<span class="token punctuation">)</span> <span class="token keyword">return</span>

    parent<span class="token punctuation">.</span><span class="token function">removeChild</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
</code></pre></div><p>接着通过 <code>this._withCommit</code> 方法把当前模块的 state 对象<strong>从父 state 上删除</strong>。这里用到了 <code>resetStore()</code>，我们来看一下：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">/* src/store.js */</span>

<span class="token comment">// 重新初始化模块</span>
<span class="token keyword">function</span> <span class="token function">resetStore</span> <span class="token punctuation">(</span><span class="token parameter">store<span class="token punctuation">,</span> hot</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  store<span class="token punctuation">.</span>_actions <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span>
  store<span class="token punctuation">.</span>_mutations <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span>
  store<span class="token punctuation">.</span>_wrappedGetters <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span>
  store<span class="token punctuation">.</span>_modulesNamespaceMap <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span>
  <span class="token comment">// 保留了重置前的所有状态（包括模块）</span>
  <span class="token keyword">const</span> state <span class="token operator">=</span> store<span class="token punctuation">.</span>state
  <span class="token comment">// init all modules</span>
  <span class="token function">installModule</span><span class="token punctuation">(</span>store<span class="token punctuation">,</span> state<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> store<span class="token punctuation">.</span>_modules<span class="token punctuation">.</span>root<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
  <span class="token comment">// reset vm</span>
  <span class="token function">resetStoreVM</span><span class="token punctuation">(</span>store<span class="token punctuation">,</span> state<span class="token punctuation">,</span> hot<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这个方法作用就是<strong>重置 store 对象</strong>，重置清空 store 的 <code>_actions</code>、<code>_mutations</code>、_<code>wrappedGetters</code> 等等属性。
然后重新调用 <code>installModule</code> 重新安装一遍 Module 对应的这些属性，以及 <code>resetStoreVM</code> 重置 <code>store._vm</code>。参数 <code>hot</code> 为true，表示它是一次热更新。
这样在 <code>installModule</code> 这个方法体类，如下这段逻辑就不会执行：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">/* src/store.js */</span>

<span class="token comment">// set state</span>
  <span class="token comment">/* 添加当前模块，作为父模块的 state 对象中的属性，在 state 中建立父子关系 */</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isRoot <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>hot<span class="token punctuation">)</span> <span class="token punctuation">{</span>
     <span class="token comment">/* 获取父级的state */</span>
    <span class="token keyword">const</span> parentState <span class="token operator">=</span> <span class="token function">getNestedState</span><span class="token punctuation">(</span>rootState<span class="token punctuation">,</span> path<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
     <span class="token comment">/* 模块名称 */</span>
    <span class="token keyword">const</span> moduleName <span class="token operator">=</span> path<span class="token punctuation">[</span>path<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span>
    store<span class="token punctuation">.</span><span class="token function">_withCommit</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">'production'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>moduleName <span class="token keyword">in</span> parentState<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          console<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span>
            <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">[vuex] state field &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>moduleName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot; was overridden 
            by a module with the same name at &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">'.'</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;</span><span class="token template-punctuation string">`</span></span>
          <span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      <span class="token comment">/**
      * 在父模块的 state 属性中添加当前模块，属性名是当前模块名，值是 state 对象
      * Vuex 之所以这么做可能是因为需要让所有的模块状态都保存在 state 中
      * 使得在重置模块时能够通过保留 state 从而保留所有的模块依赖关系
      * 将子module设置称响应式的
      */</span>
      Vue<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>parentState<span class="token punctuation">,</span> moduleName<span class="token punctuation">,</span> module<span class="token punctuation">.</span>state<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
</code></pre></div><p>由于 <code>hot</code> 始终为 true，这里我们就<strong>不会重新对状态树做设置</strong>，我们的 <strong>state 保持不变</strong>。因为我们已经明确的删除了对应 path 下的 state 了，
要做的事情只不过就是<strong>重新注册一遍 muations、actions 以及 getters</strong>。</p> <div class="custom-block danger"><p class="custom-block-title">注意</p> <p>你不能使用 unregisterModule 方法卸载静态模块（即创建 store 时声明的模块）, 只能卸载我们运行时动态创建的模块。</p></div> <h2 id="模块重用"><a href="#模块重用" class="header-anchor">#</a> 模块重用</h2> <p>有时我们可能需要创建一个模块的多个实例，例如：</p> <ul><li>创建多个 store，他们公用同一个模块 (例如当 runInNewContext 选项是 false 或 'once' 时，<a href="https://ssr.vuejs.org/guide/structure.html#avoid-stateful-singletons" target="_blank" rel="noopener noreferrer">为了在服务端渲染中避免有状态的单例<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>)</li> <li>在一个 store 中多次注册同一个模块
如果我们使用一个纯对象来声明模块的状态，那么这个状态对象会通过引用被共享，导致状态对象被修改时 store 或模块间数据互相污染的问题。</li></ul> <p>实际上这和 Vue 组件内的 data 是同样的问题。因此解决办法也是相同的——使用一个函数来声明模块状态（仅 2.3.0+ 支持）：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> MyReusableModule <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token function">state</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>
      foo<span class="token operator">:</span> <span class="token string">'bar'</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token comment">// mutation, action 和 getter 等等...</span>
<span class="token punctuation">}</span>
</code></pre></div></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">最近更新:</span> <span class="time">11/11/2020, 9:37:26 AM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/blog/vue/vuex/actions.html" class="prev">
        Actions 相关
      </a></span> <span class="next"><a href="/blog/vue/vuex/others.html">
        其他
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----><!----><!----><!----></div></div>
    <script src="/blog/assets/js/app.2821f556.js" defer></script><script src="/blog/assets/js/2.2a4e8c54.js" defer></script><script src="/blog/assets/js/41.6eb48082.js" defer></script><script src="/blog/assets/js/3.07d27621.js" defer></script>
  </body>
</html>
