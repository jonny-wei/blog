<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Pinia 原理 | 前端那些事儿</title>
    <meta name="generator" content="VuePress 1.9.10">
    <link rel="icon" href="/blog/logo.png">
    <link rel="manifest" href="/blog/manifest.json">
    <link rel="apple-touch-icon" href="/blog/images/icons/apple-icon-152x152.png">
    <meta name="description" content="我命由我不由天，学习吧少年">
    <meta name="theme-color" content="#3eaf7c">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="msapplication-TileImage" content="/icons/ms-icon-144x144.png">
    <meta name="msapplication-TileColor" content="#000000">
    
    <link rel="preload" href="/blog/assets/css/0.styles.f0017422.css" as="style"><link rel="preload" href="/blog/assets/js/app.d7ed97c7.js" as="script"><link rel="preload" href="/blog/assets/js/2.dec2e75d.js" as="script"><link rel="preload" href="/blog/assets/js/1.5b9e135c.js" as="script"><link rel="preload" href="/blog/assets/js/196.fada8913.js" as="script"><link rel="preload" href="/blog/assets/js/20.badbb211.js" as="script"><link rel="prefetch" href="/blog/assets/js/10.cc7e09f3.js"><link rel="prefetch" href="/blog/assets/js/100.9b336fb7.js"><link rel="prefetch" href="/blog/assets/js/101.b3f26860.js"><link rel="prefetch" href="/blog/assets/js/102.eeb09b48.js"><link rel="prefetch" href="/blog/assets/js/103.295a03f7.js"><link rel="prefetch" href="/blog/assets/js/104.717a1120.js"><link rel="prefetch" href="/blog/assets/js/105.07d4a177.js"><link rel="prefetch" href="/blog/assets/js/106.b867c336.js"><link rel="prefetch" href="/blog/assets/js/107.30bc7c42.js"><link rel="prefetch" href="/blog/assets/js/108.483bd993.js"><link rel="prefetch" href="/blog/assets/js/109.76770490.js"><link rel="prefetch" href="/blog/assets/js/11.b60c9933.js"><link rel="prefetch" href="/blog/assets/js/110.c9a362b9.js"><link rel="prefetch" href="/blog/assets/js/111.437e19f6.js"><link rel="prefetch" href="/blog/assets/js/112.a97b06a0.js"><link rel="prefetch" href="/blog/assets/js/113.ad01063e.js"><link rel="prefetch" href="/blog/assets/js/114.a8f8f633.js"><link rel="prefetch" href="/blog/assets/js/115.028538b8.js"><link rel="prefetch" href="/blog/assets/js/116.9887f4cf.js"><link rel="prefetch" href="/blog/assets/js/117.cbe35c59.js"><link rel="prefetch" href="/blog/assets/js/118.09ac2f52.js"><link rel="prefetch" href="/blog/assets/js/119.e8238a8b.js"><link rel="prefetch" href="/blog/assets/js/12.c53283e7.js"><link rel="prefetch" href="/blog/assets/js/120.7f3948b9.js"><link rel="prefetch" href="/blog/assets/js/121.d562c136.js"><link rel="prefetch" href="/blog/assets/js/122.813f1055.js"><link rel="prefetch" href="/blog/assets/js/123.ed542f34.js"><link rel="prefetch" href="/blog/assets/js/124.ad28403f.js"><link rel="prefetch" href="/blog/assets/js/125.82ca87f4.js"><link rel="prefetch" href="/blog/assets/js/126.e4c25686.js"><link rel="prefetch" href="/blog/assets/js/127.cc3b25e8.js"><link rel="prefetch" href="/blog/assets/js/128.ded58ef7.js"><link rel="prefetch" href="/blog/assets/js/129.966c655a.js"><link rel="prefetch" href="/blog/assets/js/13.6bdc6b5d.js"><link rel="prefetch" href="/blog/assets/js/130.84505c68.js"><link rel="prefetch" href="/blog/assets/js/131.cec1f85b.js"><link rel="prefetch" href="/blog/assets/js/132.40001954.js"><link rel="prefetch" href="/blog/assets/js/133.2ebebd9b.js"><link rel="prefetch" href="/blog/assets/js/134.36c81557.js"><link rel="prefetch" href="/blog/assets/js/135.f1ec454a.js"><link rel="prefetch" href="/blog/assets/js/136.66c83721.js"><link rel="prefetch" href="/blog/assets/js/137.9f8b8dad.js"><link rel="prefetch" href="/blog/assets/js/138.988cd2bb.js"><link rel="prefetch" href="/blog/assets/js/139.2cf615e5.js"><link rel="prefetch" href="/blog/assets/js/14.c3201a23.js"><link rel="prefetch" href="/blog/assets/js/140.5c5eb828.js"><link rel="prefetch" href="/blog/assets/js/141.b51af892.js"><link rel="prefetch" href="/blog/assets/js/142.bfa62f8b.js"><link rel="prefetch" href="/blog/assets/js/143.3f55661b.js"><link rel="prefetch" href="/blog/assets/js/144.f9f516ff.js"><link rel="prefetch" href="/blog/assets/js/145.6f138c1a.js"><link rel="prefetch" href="/blog/assets/js/146.0535f35d.js"><link rel="prefetch" href="/blog/assets/js/147.aa51a883.js"><link rel="prefetch" href="/blog/assets/js/148.a4d9d839.js"><link rel="prefetch" href="/blog/assets/js/149.20920577.js"><link rel="prefetch" href="/blog/assets/js/15.a0b9e44e.js"><link rel="prefetch" href="/blog/assets/js/150.20d31db8.js"><link rel="prefetch" href="/blog/assets/js/151.8c8797d3.js"><link rel="prefetch" href="/blog/assets/js/152.d7f2d776.js"><link rel="prefetch" href="/blog/assets/js/153.e2cc8151.js"><link rel="prefetch" href="/blog/assets/js/154.f1652a62.js"><link rel="prefetch" href="/blog/assets/js/155.b19acae0.js"><link rel="prefetch" href="/blog/assets/js/156.e9c9ed76.js"><link rel="prefetch" href="/blog/assets/js/157.3253a5d0.js"><link rel="prefetch" href="/blog/assets/js/158.3f2ba030.js"><link rel="prefetch" href="/blog/assets/js/159.bd59b2f5.js"><link rel="prefetch" href="/blog/assets/js/16.491191e4.js"><link rel="prefetch" href="/blog/assets/js/160.1a686de4.js"><link rel="prefetch" href="/blog/assets/js/161.4e0b6f98.js"><link rel="prefetch" href="/blog/assets/js/162.c0650f65.js"><link rel="prefetch" href="/blog/assets/js/163.ec3b78ac.js"><link rel="prefetch" href="/blog/assets/js/164.d21dfff7.js"><link rel="prefetch" href="/blog/assets/js/165.f930cb5f.js"><link rel="prefetch" href="/blog/assets/js/166.1144a3b5.js"><link rel="prefetch" href="/blog/assets/js/167.d9f85a7a.js"><link rel="prefetch" href="/blog/assets/js/168.196a44b6.js"><link rel="prefetch" href="/blog/assets/js/169.bf573f56.js"><link rel="prefetch" href="/blog/assets/js/17.89ec8c57.js"><link rel="prefetch" href="/blog/assets/js/170.9971d5ae.js"><link rel="prefetch" href="/blog/assets/js/171.35d1ba8d.js"><link rel="prefetch" href="/blog/assets/js/172.9bd9c064.js"><link rel="prefetch" href="/blog/assets/js/173.de70e5d2.js"><link rel="prefetch" href="/blog/assets/js/174.8888c1f8.js"><link rel="prefetch" href="/blog/assets/js/175.e6465260.js"><link rel="prefetch" href="/blog/assets/js/176.027707dc.js"><link rel="prefetch" href="/blog/assets/js/177.e066f5f3.js"><link rel="prefetch" href="/blog/assets/js/178.850415f0.js"><link rel="prefetch" href="/blog/assets/js/179.c11070c0.js"><link rel="prefetch" href="/blog/assets/js/18.b91f1411.js"><link rel="prefetch" href="/blog/assets/js/180.f67ffd4c.js"><link rel="prefetch" href="/blog/assets/js/181.8528bfeb.js"><link rel="prefetch" href="/blog/assets/js/182.54743558.js"><link rel="prefetch" href="/blog/assets/js/183.f7a6ea25.js"><link rel="prefetch" href="/blog/assets/js/184.1f5959df.js"><link rel="prefetch" href="/blog/assets/js/185.1d105f97.js"><link rel="prefetch" href="/blog/assets/js/186.77a337c1.js"><link rel="prefetch" href="/blog/assets/js/187.3bbd3ebb.js"><link rel="prefetch" href="/blog/assets/js/188.20d5d95a.js"><link rel="prefetch" href="/blog/assets/js/189.243f4482.js"><link rel="prefetch" href="/blog/assets/js/19.cb1f17c8.js"><link rel="prefetch" href="/blog/assets/js/190.2a570e90.js"><link rel="prefetch" href="/blog/assets/js/191.ebc7021d.js"><link rel="prefetch" href="/blog/assets/js/192.d64c7526.js"><link rel="prefetch" href="/blog/assets/js/193.afe5f5e6.js"><link rel="prefetch" href="/blog/assets/js/194.b39b2183.js"><link rel="prefetch" href="/blog/assets/js/195.7abe4d78.js"><link rel="prefetch" href="/blog/assets/js/197.6fbcf396.js"><link rel="prefetch" href="/blog/assets/js/198.4ff82464.js"><link rel="prefetch" href="/blog/assets/js/199.c1deed3a.js"><link rel="prefetch" href="/blog/assets/js/200.1748ffa7.js"><link rel="prefetch" href="/blog/assets/js/201.b1e95257.js"><link rel="prefetch" href="/blog/assets/js/202.7a52de85.js"><link rel="prefetch" href="/blog/assets/js/203.88138866.js"><link rel="prefetch" href="/blog/assets/js/204.e6d2f17b.js"><link rel="prefetch" href="/blog/assets/js/205.650b8efa.js"><link rel="prefetch" href="/blog/assets/js/206.11376430.js"><link rel="prefetch" href="/blog/assets/js/207.500b316a.js"><link rel="prefetch" href="/blog/assets/js/208.bddce877.js"><link rel="prefetch" href="/blog/assets/js/209.57413f4b.js"><link rel="prefetch" href="/blog/assets/js/21.bf0041b7.js"><link rel="prefetch" href="/blog/assets/js/210.a0a44e1e.js"><link rel="prefetch" href="/blog/assets/js/211.8e9ab64a.js"><link rel="prefetch" href="/blog/assets/js/212.17214657.js"><link rel="prefetch" href="/blog/assets/js/213.e33a2abb.js"><link rel="prefetch" href="/blog/assets/js/214.d53d39fa.js"><link rel="prefetch" href="/blog/assets/js/215.7d8e6a0e.js"><link rel="prefetch" href="/blog/assets/js/216.3407e98e.js"><link rel="prefetch" href="/blog/assets/js/217.55493374.js"><link rel="prefetch" href="/blog/assets/js/218.635334cf.js"><link rel="prefetch" href="/blog/assets/js/219.1c46332e.js"><link rel="prefetch" href="/blog/assets/js/22.48390d4f.js"><link rel="prefetch" href="/blog/assets/js/220.ebc569c6.js"><link rel="prefetch" href="/blog/assets/js/221.a859e2c2.js"><link rel="prefetch" href="/blog/assets/js/222.0c7fe13e.js"><link rel="prefetch" href="/blog/assets/js/223.7df0d70a.js"><link rel="prefetch" href="/blog/assets/js/224.5c5fb749.js"><link rel="prefetch" href="/blog/assets/js/225.e09e4d9d.js"><link rel="prefetch" href="/blog/assets/js/226.3043cac7.js"><link rel="prefetch" href="/blog/assets/js/227.4e115357.js"><link rel="prefetch" href="/blog/assets/js/23.35c4ba93.js"><link rel="prefetch" href="/blog/assets/js/24.cc3b12df.js"><link rel="prefetch" href="/blog/assets/js/25.632a83cc.js"><link rel="prefetch" href="/blog/assets/js/26.574f1fc1.js"><link rel="prefetch" href="/blog/assets/js/27.ee3c36ec.js"><link rel="prefetch" href="/blog/assets/js/28.2598e102.js"><link rel="prefetch" href="/blog/assets/js/29.6ed063e8.js"><link rel="prefetch" href="/blog/assets/js/3.cb0627fa.js"><link rel="prefetch" href="/blog/assets/js/30.c5bb1b3d.js"><link rel="prefetch" href="/blog/assets/js/31.6ae5d6bc.js"><link rel="prefetch" href="/blog/assets/js/32.63714a18.js"><link rel="prefetch" href="/blog/assets/js/33.0a98d657.js"><link rel="prefetch" href="/blog/assets/js/34.66a4b69e.js"><link rel="prefetch" href="/blog/assets/js/35.efc8ebcf.js"><link rel="prefetch" href="/blog/assets/js/36.28b482d2.js"><link rel="prefetch" href="/blog/assets/js/37.0c70a804.js"><link rel="prefetch" href="/blog/assets/js/38.7b2228d8.js"><link rel="prefetch" href="/blog/assets/js/39.2bc990cf.js"><link rel="prefetch" href="/blog/assets/js/4.cbb57fa7.js"><link rel="prefetch" href="/blog/assets/js/40.5be60d0e.js"><link rel="prefetch" href="/blog/assets/js/41.7524bbf0.js"><link rel="prefetch" href="/blog/assets/js/42.714adee0.js"><link rel="prefetch" href="/blog/assets/js/43.718a9ac3.js"><link rel="prefetch" href="/blog/assets/js/44.cdf11766.js"><link rel="prefetch" href="/blog/assets/js/45.b9f73462.js"><link rel="prefetch" href="/blog/assets/js/46.070617b5.js"><link rel="prefetch" href="/blog/assets/js/47.45dbd8ee.js"><link rel="prefetch" href="/blog/assets/js/48.a5d36e11.js"><link rel="prefetch" href="/blog/assets/js/49.03e700f2.js"><link rel="prefetch" href="/blog/assets/js/5.fe065607.js"><link rel="prefetch" href="/blog/assets/js/50.edafa678.js"><link rel="prefetch" href="/blog/assets/js/51.6e2290a8.js"><link rel="prefetch" href="/blog/assets/js/52.c109d7d5.js"><link rel="prefetch" href="/blog/assets/js/53.50675a1d.js"><link rel="prefetch" href="/blog/assets/js/54.0afdb68d.js"><link rel="prefetch" href="/blog/assets/js/55.f9013f21.js"><link rel="prefetch" href="/blog/assets/js/56.e7ca6c14.js"><link rel="prefetch" href="/blog/assets/js/57.8b42df8f.js"><link rel="prefetch" href="/blog/assets/js/58.7b68fa2c.js"><link rel="prefetch" href="/blog/assets/js/59.e276f401.js"><link rel="prefetch" href="/blog/assets/js/6.68cda050.js"><link rel="prefetch" href="/blog/assets/js/60.4add09d0.js"><link rel="prefetch" href="/blog/assets/js/61.0fe45890.js"><link rel="prefetch" href="/blog/assets/js/62.66b58176.js"><link rel="prefetch" href="/blog/assets/js/63.adc3ee7b.js"><link rel="prefetch" href="/blog/assets/js/64.590e5a37.js"><link rel="prefetch" href="/blog/assets/js/65.bfebad49.js"><link rel="prefetch" href="/blog/assets/js/66.281a5ac4.js"><link rel="prefetch" href="/blog/assets/js/67.3b13d2f2.js"><link rel="prefetch" href="/blog/assets/js/68.e53606db.js"><link rel="prefetch" href="/blog/assets/js/69.2059be22.js"><link rel="prefetch" href="/blog/assets/js/7.3b8d63a0.js"><link rel="prefetch" href="/blog/assets/js/70.c7774f34.js"><link rel="prefetch" href="/blog/assets/js/71.559dfdd3.js"><link rel="prefetch" href="/blog/assets/js/72.cbac4235.js"><link rel="prefetch" href="/blog/assets/js/73.aa1efffb.js"><link rel="prefetch" href="/blog/assets/js/74.de2cf5f9.js"><link rel="prefetch" href="/blog/assets/js/75.d9244242.js"><link rel="prefetch" href="/blog/assets/js/76.93d6b837.js"><link rel="prefetch" href="/blog/assets/js/77.c82da724.js"><link rel="prefetch" href="/blog/assets/js/78.4e6d4811.js"><link rel="prefetch" href="/blog/assets/js/79.0f4aac22.js"><link rel="prefetch" href="/blog/assets/js/80.6a6b99e8.js"><link rel="prefetch" href="/blog/assets/js/81.712bd61b.js"><link rel="prefetch" href="/blog/assets/js/82.181cda89.js"><link rel="prefetch" href="/blog/assets/js/83.7ab5ac5b.js"><link rel="prefetch" href="/blog/assets/js/84.6bbbb8d2.js"><link rel="prefetch" href="/blog/assets/js/85.4adfb728.js"><link rel="prefetch" href="/blog/assets/js/86.2121d070.js"><link rel="prefetch" href="/blog/assets/js/87.e8c62457.js"><link rel="prefetch" href="/blog/assets/js/88.93dd4fca.js"><link rel="prefetch" href="/blog/assets/js/89.a93de9cf.js"><link rel="prefetch" href="/blog/assets/js/90.d4170ea4.js"><link rel="prefetch" href="/blog/assets/js/91.9bc2590d.js"><link rel="prefetch" href="/blog/assets/js/92.e94d0ec0.js"><link rel="prefetch" href="/blog/assets/js/93.3f378b31.js"><link rel="prefetch" href="/blog/assets/js/94.b567445f.js"><link rel="prefetch" href="/blog/assets/js/95.708acdfa.js"><link rel="prefetch" href="/blog/assets/js/96.fe23b2db.js"><link rel="prefetch" href="/blog/assets/js/97.2301b9cf.js"><link rel="prefetch" href="/blog/assets/js/98.6c7c4ab4.js"><link rel="prefetch" href="/blog/assets/js/99.974edfb7.js"><link rel="prefetch" href="/blog/assets/js/vendors~docsearch.bd3cdb54.js">
    <link rel="stylesheet" href="/blog/assets/css/0.styles.f0017422.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/blog/" class="home-link router-link-active"><img src="/blog/logo.png" alt="前端那些事儿" class="logo"> <span class="site-name can-hide">前端那些事儿</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/blog/" class="nav-link">
  主页
</a></div><div class="nav-item"><a href="/blog/base/" class="nav-link">
  前端基础
</a></div><div class="nav-item"><a href="/blog/vue/" class="nav-link router-link-active">
  Vue
</a></div><div class="nav-item"><a href="/blog/react/" class="nav-link">
  React
</a></div><div class="nav-item"><a href="/blog/devops/" class="nav-link">
  前端工程化
</a></div><div class="nav-item"><a href="/blog/mobile/" class="nav-link">
  泛客户端
</a></div><div class="nav-item"><a href="/blog/architecture/" class="nav-link">
  架构与方案
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="GitHub" class="dropdown-title"><span class="title">GitHub</span> <span class="arrow down"></span></button> <button type="button" aria-label="GitHub" class="mobile-dropdown-title"><span class="title">GitHub</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/jonny-wei" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://github.com/jonny-wei/sushi-js" target="_blank" rel="noopener noreferrer" class="nav-link external">
  JS 寿司
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/blog/" class="nav-link">
  主页
</a></div><div class="nav-item"><a href="/blog/base/" class="nav-link">
  前端基础
</a></div><div class="nav-item"><a href="/blog/vue/" class="nav-link router-link-active">
  Vue
</a></div><div class="nav-item"><a href="/blog/react/" class="nav-link">
  React
</a></div><div class="nav-item"><a href="/blog/devops/" class="nav-link">
  前端工程化
</a></div><div class="nav-item"><a href="/blog/mobile/" class="nav-link">
  泛客户端
</a></div><div class="nav-item"><a href="/blog/architecture/" class="nav-link">
  架构与方案
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="GitHub" class="dropdown-title"><span class="title">GitHub</span> <span class="arrow down"></span></button> <button type="button" aria-label="GitHub" class="mobile-dropdown-title"><span class="title">GitHub</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/jonny-wei" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://github.com/jonny-wei/sushi-js" target="_blank" rel="noopener noreferrer" class="nav-link external">
  JS 寿司
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Vue</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/vue/" aria-current="page" class="sidebar-link">Vue 组件通信</a></li><li><a href="/blog/vue/warmup/vue-symbols.html" class="sidebar-link">Vue 修饰符</a></li><li><a href="/blog/vue/warmup/vue-optimization.html" class="sidebar-link">Vue 相关优化</a></li><li><a href="/blog/vue/warmup/vue-router.html" class="sidebar-link">VueRouter 核心原理</a></li><li><a href="/blog/vue/warmup/vue-vuex.html" class="sidebar-link">Vuex 实现原理</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Vue源码解析</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/vue/vue/github.html" class="sidebar-link">源码学习</a></li><li><a href="/blog/vue/vue/vue-render.html" class="sidebar-link">渲染器</a></li><li><a href="/blog/vue/vue/vue-init.html" class="sidebar-link">构建与初始化</a></li><li><a href="/blog/vue/vue/vue-component.html" class="sidebar-link">组件化过程</a></li><li><a href="/blog/vue/vue/vue-observer.html" class="sidebar-link">响应式原理</a></li><li><a href="/blog/vue/vue/vue-template.html" class="sidebar-link">模板编译与渲染</a></li><li><a href="/blog/vue/vue/vue-diff.html" class="sidebar-link">虚拟 DOM 与 Diff 算法</a></li><li><a href="/blog/vue/vue/vue-nextTick.html" class="sidebar-link">异步更新队列</a></li><li><a href="/blog/vue/vue/vue-lifecycle.html" class="sidebar-link">生命周期</a></li><li><a href="/blog/vue/vue/vue-computed.html" class="sidebar-link">计算属性与侦听器</a></li><li><a href="/blog/vue/vue/vue-slot.html" class="sidebar-link">插槽</a></li><li><a href="/blog/vue/vue/vue-directive.html" class="sidebar-link">Vue 指令</a></li><li><a href="/blog/vue/vue/vue-event.html" class="sidebar-link">事件绑定原理</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>VueRouter源码解析</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/vue/vue-router/abstract.html" class="sidebar-link">摘要</a></li><li><a href="/blog/vue/vue-router/warmUp.html" class="sidebar-link">准备工作</a></li><li><a href="/blog/vue/vue-router/plugin.html" class="sidebar-link">插件机制</a></li><li><a href="/blog/vue/vue-router/initialization.html" class="sidebar-link">初始化与降级处理</a></li><li><a href="/blog/vue/vue-router/transitions.html" class="sidebar-link">路由过渡与视图渲染</a></li><li><a href="/blog/vue/vue-router/match.html" class="sidebar-link">路由匹配</a></li><li><a href="/blog/vue/vue-router/summary.html" class="sidebar-link">总结</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Vuex源码解析</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/vue/vuex/abstract.html" class="sidebar-link">摘要</a></li><li><a href="/blog/vue/vuex/warmUp.html" class="sidebar-link">准备工作</a></li><li><a href="/blog/vue/vuex/initialization.html" class="sidebar-link">初始化与模块安装</a></li><li><a href="/blog/vue/vuex/state.html" class="sidebar-link">State 相关</a></li><li><a href="/blog/vue/vuex/getters.html" class="sidebar-link">Getters 相关</a></li><li><a href="/blog/vue/vuex/mutations.html" class="sidebar-link">Mutations 相关</a></li><li><a href="/blog/vue/vuex/actions.html" class="sidebar-link">Actions 相关</a></li><li><a href="/blog/vue/vuex/modules.html" class="sidebar-link">Modules 相关</a></li><li><a href="/blog/vue/vuex/others.html" class="sidebar-link">其他</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Vue3新特性</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/vue/vue3.x/reactivity.html" class="sidebar-link">响应式系统方面</a></li><li><a href="/blog/vue/vue3.x/features.html" class="sidebar-link">功能方面</a></li><li><a href="/blog/vue/vue3.x/performance.html" class="sidebar-link">性能方面</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>VueNext</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/vue/vue3/reactivity.html" class="sidebar-link">设计响应式系统</a></li><li><a href="/blog/vue/vue3/diff.html" class="sidebar-link">快速 Diff 算法</a></li><li><a href="/blog/vue/vue3/components.html" class="sidebar-link">组件化原理</a></li><li><a href="/blog/vue/vue3/inner-components.html" class="sidebar-link">异步与内置组件</a></li><li><a href="/blog/vue/vue3/compiler.html" class="sidebar-link">模板编译与优化</a></li><li><a href="/blog/vue/vue3/hooks.html" class="sidebar-link">Hooks</a></li><li><a href="/blog/vue/vue3/vue-router4.html" class="sidebar-link">VueRouter-V4 原理</a></li><li><a href="/blog/vue/vue3/pinia.html" aria-current="page" class="active sidebar-link">Pinia 原理</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/vue/vue3/pinia.html#vuex5-提案" class="sidebar-link">Vuex5 提案</a></li><li class="sidebar-sub-header"><a href="/blog/vue/vue3/pinia.html#pinia-的使用" class="sidebar-link">Pinia 的使用</a></li><li class="sidebar-sub-header"><a href="/blog/vue/vue3/pinia.html#pinia-的实现" class="sidebar-link">Pinia 的实现</a></li><li class="sidebar-sub-header"><a href="/blog/vue/vue3/pinia.html#pinia-的优点" class="sidebar-link">Pinia 的优点</a></li><li class="sidebar-sub-header"><a href="/blog/vue/vue3/pinia.html#问题" class="sidebar-link">问题</a></li></ul></li><li><a href="/blog/vue/vue3/ssr.html" class="sidebar-link">Vue SSR</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="pinia-原理"><a href="#pinia-原理" class="header-anchor">#</a> Pinia 原理</h1> <h2 id="vuex5-提案"><a href="#vuex5-提案" class="header-anchor">#</a> Vuex5 提案</h2> <p><a href="https://github.com/vuejs/rfcs/blob/34a8b0d541a361a37d05de8d67cb44a7b6f6fd12/active-rfcs/0000-vuex-5.md" target="_blank" rel="noopener noreferrer">Vuex5 提案<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>，旨在解决 Vuex4 的痛点：</p> <ul><li>支持 store creation、 Options API 和 Composition API 的语法。</li> <li>没有 Mutation，仅有 State、Getter 和 Actions, Actions 中可直接改变 state。</li> <li>没有 Nested Modules 嵌套模块（去掉 namespace 功能），只有 Store。</li> <li>支持完整的 TypeScript 支持与类型推导。</li> <li>支持自动代码分割。</li></ul> <p>Vuex5 引入了关于如何定义、创建和管理 Store 的全新想法。这和 Pinia 非常接近：</p> <ul><li>store：可理解为一个单独的组件，其行为与 Vuex3 和 4 中的 Modules 非常相似。新的 Vuex 实例将充当这些 Store 的容器。pinia 采用模块式管理，每个 store 都是独立的，互相不影响。</li> <li>state：与 Vuex3 和 4 中的 state 相同。但是在 Vuex5 中，它必须是一个函数。</li> <li>getters：类似于 Vuex3 和 4 中的 getters，但它不会接收任何参数。要引用 state 需通过 <code>this</code> 上下文访问。</li> <li>actions: 类似于 Vuex 3 和 4 中的 action，但它可以直接改变 state。它也可能是 async 函数。要引用 state 或 getter 需通过 <code>this</code> 上下文访问。</li></ul> <h2 id="pinia-的使用"><a href="#pinia-的使用" class="header-anchor">#</a> Pinia 的使用</h2> <h3 id="定义-store"><a href="#定义-store" class="header-anchor">#</a> 定义 Store</h3> <ul><li>在 <code>src/main.js</code> 中导入 <code>createPinia</code> 方法，通过 <code>createPinia</code> 方法创建 Pinia 的实例后，再通过 <code>app.use</code> 方法注册 Pinia:</li></ul> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> createApp <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'vue'</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> createPinia <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'pinia'</span>
<span class="token keyword">import</span> App <span class="token keyword">from</span> <span class="token string">'./App.vue'</span>

<span class="token keyword">const</span> pinia <span class="token operator">=</span> <span class="token function">createPinia</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">createApp</span><span class="token punctuation">(</span>App<span class="token punctuation">)</span>

app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>pinia<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">mount</span><span class="token punctuation">(</span><span class="token string">'#app'</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><ul><li>通过 Pinia 的 <code>defineStore</code> 方法定义了一个 store，store 内部通过 state 返回一个对象，并且通过 Actions 修改 state。这里使用的语法和 Vuex 比较类似，只是删除了 Mutation 的概念，统一使用 Actions:</li></ul> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> defineStore <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'pinia'</span>

<span class="token comment">// Options API 风格</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> useCounterStore <span class="token operator">=</span> <span class="token function">defineStore</span><span class="token punctuation">(</span><span class="token string">'counter'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token function-variable function">state</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">count</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'Eduardo'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// 必须是函数，推荐使用箭头函数</span>
  <span class="token literal-property property">getters</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token function-variable function">doubleCount</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">state</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> state<span class="token punctuation">.</span>count <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token literal-property property">actions</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token function">increment</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>count<span class="token operator">++</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// Composition API 风格，用使用 ref 或者 reactive 包裹 state</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> useCounterStore <span class="token operator">=</span> <span class="token function">defineStore</span><span class="token punctuation">(</span><span class="token string">'counter'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> count <span class="token operator">=</span> <span class="token function">ref</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> doubleCount <span class="token operator">=</span> <span class="token function">computed</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> count<span class="token punctuation">.</span>value <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span>

  <span class="token keyword">function</span> <span class="token function">increment</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    count<span class="token punctuation">.</span>value<span class="token operator">++</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> <span class="token punctuation">{</span> count<span class="token punctuation">,</span> doubleCount<span class="token punctuation">,</span> increment <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br></div></div><p>在 Option Store 中，可以理解 Store 为一个组件：</p> <ul><li>state 是 store 的数据 (data)</li> <li>getters 是 store 的计算属性 (computed)</li> <li>actions 是 store 的方法 (methods)。</li></ul> <p>在 Setup Store 中，</p> <ul><li>ref() 就是 state 属性</li> <li>computed() 就是 getters</li> <li>function() 就是 actions、</li></ul> <p>注意，要让 pinia 正确识别 state，你必须在 setup store 中返回 state 的所有属性。这意味着，<strong>不能在 store 中使用私有属性。不完整的返回会影响 SSR ，开发工具和其他插件的正常运行</strong>。</p> <p>为了从 store 中提取属性时保持其响应性，需要使用 <code>storeToRefs()</code>。它将<strong>为每一个响应式属性创建引用</strong>。当你只使用 store 的状态而不调用任何 action 时，它会非常有用。请注意，你可以直接从 store 中解构 action，因为它们也被绑定到 store 上：</p> <div class="language-vue line-numbers-mode"><pre class="language-vue"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">setup</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
<span class="token keyword">import</span> <span class="token punctuation">{</span> storeToRefs <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'pinia'</span>
<span class="token keyword">const</span> store <span class="token operator">=</span> <span class="token function">useCounterStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">// `name` 和 `doubleCount` 是响应式的 ref</span>
<span class="token comment">// 同时通过插件添加的属性也会被提取为 ref</span>
<span class="token comment">// 并且会跳过所有的 action 或非响应式 (不是 ref 或 reactive) 的属性</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> name<span class="token punctuation">,</span> doubleCount <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">storeToRefs</span><span class="token punctuation">(</span>store<span class="token punctuation">)</span>
<span class="token comment">// 作为 action 的 increment 可以直接解构</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> increment <span class="token punctuation">}</span> <span class="token operator">=</span> store
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>此外，Setup store 也可以依赖于全局提供的属性，比如<strong>路由</strong>。任何应用层面提供的属性都可以在 store 中使用 <code>inject()</code> 访问，就像在组件中一样：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> inject <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'vue'</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> useRoute <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'vue-router'</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> defineStore <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'pinia'</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> useSearchFilters <span class="token operator">=</span> <span class="token function">defineStore</span><span class="token punctuation">(</span><span class="token string">'search-filters'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> route <span class="token operator">=</span> <span class="token function">useRoute</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token comment">// 这里假定 `app.provide('appProvided', 'value')` 已经调用过</span>
  <span class="token keyword">const</span> appProvided <span class="token operator">=</span> <span class="token function">inject</span><span class="token punctuation">(</span><span class="token string">'appProvided'</span><span class="token punctuation">)</span>

  <span class="token comment">// ...</span>

  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    <span class="token comment">// ... 不用返回 route 它不属于 store。</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><h3 id="使用-state"><a href="#使用-state" class="header-anchor">#</a> 使用 State</h3> <h4 id="访问-state"><a href="#访问-state" class="header-anchor">#</a> 访问 state</h4> <p>默认情况下，你可以通过 store 实例访问 state，直接对其进行读写。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> store <span class="token operator">=</span> <span class="token function">useStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

store<span class="token punctuation">.</span>count<span class="token operator">++</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h4 id="重置-state"><a href="#重置-state" class="header-anchor">#</a> 重置 state</h4> <p>使用 Option API 时，你可以通过调用 store 的 <code>$reset()</code> 方法将 state 重置为初始值。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> store <span class="token operator">=</span> <span class="token function">useStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

store<span class="token punctuation">.</span><span class="token function">$reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>在 <code>$reset()</code> 内部，会调用 <code>state()</code> 函数来创建一个新的状态对象，并用它替换当前状态。</p> <p>在 Setup Stores 中，您<strong>需要创建自己的 <code>$reset()</code> 方法</strong>：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">const</span> useCounterStore <span class="token operator">=</span> <span class="token function">defineStore</span><span class="token punctuation">(</span><span class="token string">'counter'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> count <span class="token operator">=</span> <span class="token function">ref</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>

  <span class="token keyword">function</span> <span class="token function">$reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    count<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token number">0</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> <span class="token punctuation">{</span> count<span class="token punctuation">,</span> $reset <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h4 id="变更-state"><a href="#变更-state" class="header-anchor">#</a> 变更 state</h4> <p>除了用 <code>store.count++</code> 直接改变 store，你还可以调用 <code>$patch</code> 方法。它允许你用一个 state 的补丁对象在同一时间更改多个属性：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>store<span class="token punctuation">.</span><span class="token function">$patch</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token literal-property property">count</span><span class="token operator">:</span> store<span class="token punctuation">.</span>count <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span>
  <span class="token literal-property property">age</span><span class="token operator">:</span> <span class="token number">120</span><span class="token punctuation">,</span>
  <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'DIO'</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p><code>$patch</code> 方法也接受一个函数来组合这种难以用补丁对象实现的变更:</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>store<span class="token punctuation">.</span><span class="token function">$patch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">state</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  state<span class="token punctuation">.</span>items<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'shoes'</span><span class="token punctuation">,</span> <span class="token literal-property property">quantity</span><span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  state<span class="token punctuation">.</span>hasChanged <span class="token operator">=</span> <span class="token boolean">true</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><div class="custom-block tip"><p class="custom-block-title">注意</p> <p>两种变更 store 方法的主要区别是，<code>$patch()</code> 允许你将多个变更归入 devtools 的同一个条目中。同时请注意，直接修改 state，<code>$patch()</code> 也会出现在 devtools 中，而且可以进行 time travel (在 Vue 3 中还没有)。</p></div> <h4 id="替换-state"><a href="#替换-state" class="header-anchor">#</a> 替换 state</h4> <p>你不能完全替换掉 store 的 state，因为那样会破坏其响应性。但是，你可以 patch 它:</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 这实际上并没有替换`$state`</span>
store<span class="token punctuation">.</span>$state <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token literal-property property">count</span><span class="token operator">:</span> <span class="token number">24</span> <span class="token punctuation">}</span>
<span class="token comment">// 在它内部调用 `$patch()`：</span>
store<span class="token punctuation">.</span><span class="token function">$patch</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">count</span><span class="token operator">:</span> <span class="token number">24</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// 你也可以通过变更 pinia 实例的 state 来设置整个应用的初始 state。这常用于 SSR 中的激活过程:</span>

pinia<span class="token punctuation">.</span>state<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h4 id="订阅-state"><a href="#订阅-state" class="header-anchor">#</a> 订阅 state</h4> <p>通过 store 的 <code>$subscribe()</code> 方法侦听 state 及其变化。比起普通的 <code>watch()</code>，使用 <code>$subscribe()</code> 的<strong>好处是 subscriptions 在 <code>patch</code> 后只触发一次</strong>:</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>cartStore<span class="token punctuation">.</span><span class="token function">$subscribe</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">mutation<span class="token punctuation">,</span> state</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// import { MutationType } from 'pinia'</span>
  mutation<span class="token punctuation">.</span>type <span class="token comment">// 'direct' | 'patch object' | 'patch function'</span>
  <span class="token comment">// 和 cartStore.$id 一样</span>
  mutation<span class="token punctuation">.</span>storeId <span class="token comment">// 'cart'</span>
  <span class="token comment">// 只有 mutation.type === 'patch object'的情况下才可用</span>
  mutation<span class="token punctuation">.</span>payload <span class="token comment">// 传递给 cartStore.$patch() 的补丁对象。</span>

  <span class="token comment">// 每当状态发生变化时，将整个 state 持久化到本地存储。</span>
  localStorage<span class="token punctuation">.</span><span class="token function">setItem</span><span class="token punctuation">(</span><span class="token string">'cart'</span><span class="token punctuation">,</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>默认情况下，state subscription 会被绑定到添加它们的组件上 (如果 store 在组件的 setup() 里面)。这意味着，当该组件被卸载时，它们将被自动删除。如果你想在组件卸载后依旧保留它们，请将 <code>{ detached: true }</code> 作为第二个参数，以将 state subscription 从当前组件中分离：</p> <div class="language-vue line-numbers-mode"><pre class="language-vue"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">setup</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
<span class="token keyword">const</span> someStore <span class="token operator">=</span> <span class="token function">useSomeStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">// 此订阅器即便在组件卸载之后仍会被保留</span>
someStore<span class="token punctuation">.</span><span class="token function">$subscribe</span><span class="token punctuation">(</span>callback<span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">detached</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>你可以在 pinia 实例上使用 watch() 函数侦听整个 state。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token function">watch</span><span class="token punctuation">(</span>
  pinia<span class="token punctuation">.</span>state<span class="token punctuation">,</span>
  <span class="token punctuation">(</span><span class="token parameter">state</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// 每当状态发生变化时，将整个 state 持久化到本地存储。</span>
    localStorage<span class="token punctuation">.</span><span class="token function">setItem</span><span class="token punctuation">(</span><span class="token string">'piniaState'</span><span class="token punctuation">,</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span> <span class="token literal-property property">deep</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span>
<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p><a href="https://pinia.vuejs.org/zh/core-concepts/getters.html" target="_blank" rel="noopener noreferrer">Getter、Action、Plugin 的使用见官网<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h2 id="pinia-的实现"><a href="#pinia-的实现" class="header-anchor">#</a> Pinia 的实现</h2> <h3 id="创建-pinia-实例"><a href="#创建-pinia-实例" class="header-anchor">#</a> 创建 Pinia 实例</h3> <p>通过 <code>effectScope</code> 创建一个作用域对象，并且通过 <code>ref</code> 创建了响应式的数据对象 <code>state</code>。然后通过 <code>install</code> 方法支持了通过 <code>app.use</code> 的注册，内部通过 provide 的语法和全局的 $pinia 变量配置 Pinia 对象，并且通过 use 方法和 toBeInstalled 数组实现了 Pinia 的插件机制。最后还通过 <code>pinia.use(devtoolsPlugin)</code> 实现了对 VueDevtools 的支持。</p> <p><code>effectScope</code>：这是一个 Vue 3.x 高阶的响应式的 api，能够对这个 effect 里面的响应式副作用（计算属性、监听器）统一进行操作处理，例如调用 stop 停止监听拦截等。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// packages/pinia/src/createPinia.ts</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">createPinia</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> Pinia <span class="token punctuation">{</span>
  <span class="token keyword">const</span> scope <span class="token operator">=</span> <span class="token function">effectScope</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
  <span class="token comment">// NOTE: here we could check the window object for a state and directly set it</span>
  <span class="token comment">// if there is anything like it with Vue 3 SSR</span>
  <span class="token keyword">const</span> state <span class="token operator">=</span> scope<span class="token punctuation">.</span>run<span class="token operator">&lt;</span>Ref<span class="token operator">&lt;</span>Record<span class="token operator">&lt;</span>string<span class="token punctuation">,</span> StateTree<span class="token operator">&gt;&gt;&gt;</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
    ref<span class="token operator">&lt;</span>Record<span class="token operator">&lt;</span>string<span class="token punctuation">,</span> StateTree<span class="token operator">&gt;&gt;</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">)</span><span class="token operator">!</span>

  <span class="token keyword">let</span> <span class="token literal-property property">_p</span><span class="token operator">:</span> Pinia<span class="token punctuation">[</span><span class="token string">'_p'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token comment">// 所有需要安装的插件</span>
  <span class="token comment">// plugins added before calling app.use(pinia)</span>
  <span class="token keyword">let</span> <span class="token literal-property property">toBeInstalled</span><span class="token operator">:</span> PiniaPlugin<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

  <span class="token comment">// markRaw：标记该 pinia 不会被响应式转换和监听，能够节约内存的使用，提高运行效率</span>
  <span class="token keyword">const</span> <span class="token literal-property property">pinia</span><span class="token operator">:</span> Pinia <span class="token operator">=</span> <span class="token function">markRaw</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token function">install</span><span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">app</span><span class="token operator">:</span> App</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// vue.use(pinia) 执行逻辑</span>
      <span class="token comment">// this allows calling useStore() outside of a component setup after</span>
      <span class="token comment">// installing pinia's plugin</span>
      <span class="token function">setActivePinia</span><span class="token punctuation">(</span>pinia<span class="token punctuation">)</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isVue2<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        pinia<span class="token punctuation">.</span>_a <span class="token operator">=</span> app <span class="token comment">// app实例</span>
        app<span class="token punctuation">.</span><span class="token function">provide</span><span class="token punctuation">(</span>piniaSymbol<span class="token punctuation">,</span> pinia<span class="token punctuation">)</span> <span class="token comment">// 通过 provide 来注入 pinia 实例</span>
        app<span class="token punctuation">.</span>config<span class="token punctuation">.</span>globalProperties<span class="token punctuation">.</span>$pinia <span class="token operator">=</span> pinia <span class="token comment">// 在 vue 项目当中设置全局属性 $pinia</span>
        <span class="token comment">/* istanbul ignore else */</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>__USE_DEVTOOLS__ <span class="token operator">&amp;&amp;</span> <span class="token constant">IS_CLIENT</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">registerPiniaDevtools</span><span class="token punctuation">(</span>app<span class="token punctuation">,</span> pinia<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        toBeInstalled<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">plugin</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> _p<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>plugin<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 处理未执行插件</span>
        toBeInstalled <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token comment">// pinia 使用插件时候调用执行，将 pinia 插件都先塞到一个 _p 的数组当中，后续再进行初始化执行</span>
    <span class="token function">use</span><span class="token punctuation">(</span><span class="token parameter">plugin</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>_a <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>isVue2<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        toBeInstalled<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>plugin<span class="token punctuation">)</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        _p<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>plugin<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">return</span> <span class="token keyword">this</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    _p<span class="token punctuation">,</span>
    <span class="token comment">// it's actually undefined here</span>
    <span class="token comment">// @ts-expect-error</span>
    <span class="token literal-property property">_a</span><span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    <span class="token literal-property property">_e</span><span class="token operator">:</span> scope<span class="token punctuation">,</span> <span class="token comment">// pinia 的 effect 作用域对象，每个store都是单独的scope</span>
    <span class="token literal-property property">_s</span><span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token operator">&lt;</span>string<span class="token punctuation">,</span> StoreGeneric<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// 以 Map 的数据结构形式存储 pinia 数据仓库 store，类似 state</span>
    state<span class="token punctuation">,</span> <span class="token comment">// pinia所有 state 的合集, key 为 pinia 的 id, value为 store下的所有 state（所有可访问变量）</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token comment">// pinia devtools rely on dev only features so they cannot be forced unless</span>
  <span class="token comment">// the dev build of Vue is used. Avoid old browsers like IE11.</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>__USE_DEVTOOLS__ <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> Proxy <span class="token operator">!==</span> <span class="token string">'undefined'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    pinia<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>devtoolsPlugin<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> pinia
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br></div></div><p>Pinia 实例就是 <code>ref({})</code>包裹的响应式对象，项目中用到的 <code>state</code> 都会挂载到 Pinia 这个响应式对象内部。</p> <h3 id="创建-store"><a href="#创建-store" class="header-anchor">#</a> 创建 Store</h3> <p><code>defineStore</code> 利用 TypeScript 函数重载来实现传递不同参数进行数据仓库的初始化处理。其内部通过 <code>useStore</code> 方法去定义 <code>store</code>，并且每个 store 都会标记唯一的 ID。<code>defineStore</code> 里面含有一个 useStore 方法，并且作为其返回值。因此 useStore 才是 Pinia store 的核心创建逻辑。</p> <ul><li>首先通过 <code>getCurrentInstance</code> 获取当前组件的实例，如果 useStore 参数没有 Pinia 的话，就使用 inject 去获取 Pinia 实例，这里 inject 的数据就是 createPinia 函数中 install 方法提供的。</li> <li>然后设置 <code>activePinia</code>，项目中可能会存在很多 Pinia 的实例，设置 activePinia 就是设置当前活跃的 Pinia 实例。这个函数的实现方式和 Vue 中的 <code>componentInstance</code> 很像，每次创建组件的时候都设置当前的组件实例，这样就可以在组件的内部通过 <code>getCurrentInstance</code> 获取。</li> <li>接着通过 <code>createSetupStore</code> 或者 <code>createOptionsStore</code> 创建组件，这就是两种语法创建 store 的不同执行逻辑。</li> <li>最后通过 <code>pinia._s</code> 缓存创建后的 store，<code>_s</code> 就是在 createPinia 的时候创建的一个 Map 对象，<strong>防止 store 多次重复创建</strong>。</li></ul> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// packages\pinia\src\store.ts</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">defineStore</span><span class="token punctuation">(</span>
  <span class="token comment">// TODO: add proper types from above</span>
  <span class="token literal-property property">idOrOptions</span><span class="token operator">:</span> any<span class="token punctuation">,</span>
  setup<span class="token operator">?</span><span class="token operator">:</span> any<span class="token punctuation">,</span>
  setupOptions<span class="token operator">?</span><span class="token operator">:</span> any
<span class="token punctuation">)</span><span class="token operator">:</span> StoreDefinition <span class="token punctuation">{</span>
  <span class="token keyword">let</span> <span class="token literal-property property">id</span><span class="token operator">:</span> string
  <span class="token keyword">let</span> <span class="token literal-property property">options</span><span class="token operator">:</span>
    <span class="token operator">|</span> DefineStoreOptions<span class="token operator">&lt;</span>
        string<span class="token punctuation">,</span>
        StateTree<span class="token punctuation">,</span>
        _GettersTree<span class="token operator">&lt;</span>StateTree<span class="token operator">&gt;</span><span class="token punctuation">,</span>
        _ActionsTree
      <span class="token operator">&gt;</span>
    <span class="token operator">|</span> DefineSetupStoreOptions<span class="token operator">&lt;</span>
        string<span class="token punctuation">,</span>
        StateTree<span class="token punctuation">,</span>
        _GettersTree<span class="token operator">&lt;</span>StateTree<span class="token operator">&gt;</span><span class="token punctuation">,</span>
        _ActionsTree
      <span class="token operator">&gt;</span>

  <span class="token comment">// 不同参数形式的兼容处理</span>
  <span class="token keyword">const</span> isSetupStore <span class="token operator">=</span> <span class="token keyword">typeof</span> setup <span class="token operator">===</span> <span class="token string">'function'</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> idOrOptions <span class="token operator">===</span> <span class="token string">'string'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    id <span class="token operator">=</span> idOrOptions
    <span class="token comment">// the option store setup will contain the actual options in this case</span>
    options <span class="token operator">=</span> isSetupStore <span class="token operator">?</span> setupOptions <span class="token operator">:</span> setup
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    options <span class="token operator">=</span> idOrOptions
    id <span class="token operator">=</span> idOrOptions<span class="token punctuation">.</span>id

    <span class="token keyword">if</span> <span class="token punctuation">(</span>__DEV__ <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> id <span class="token operator">!==</span> <span class="token string">'string'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span>
        <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">[🍍]: &quot;defineStore()&quot; must be passed a store id as its first argument.</span><span class="token template-punctuation string">`</span></span>
      <span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 声明 useStore 函数并且作为 defineStore 函数的返回值</span>
  <span class="token keyword">function</span> <span class="token function">useStore</span><span class="token punctuation">(</span><span class="token parameter">pinia<span class="token operator">?</span><span class="token operator">:</span> Pinia <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">,</span> hot<span class="token operator">?</span><span class="token operator">:</span> StoreGeneric</span><span class="token punctuation">)</span><span class="token operator">:</span> StoreGeneric <span class="token punctuation">{</span>
    <span class="token comment">// 获取当前 Vue 的组件实例</span>
    <span class="token keyword">const</span> hasContext <span class="token operator">=</span> <span class="token function">hasInjectionContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    pinia <span class="token operator">=</span>
      <span class="token comment">// in test mode, ignore the argument provided as we can always retrieve a</span>
      <span class="token comment">// pinia instance with getActivePinia()</span>
      <span class="token punctuation">(</span>__TEST__ <span class="token operator">&amp;&amp;</span> activePinia <span class="token operator">&amp;&amp;</span> activePinia<span class="token punctuation">.</span>_testing <span class="token operator">?</span> <span class="token keyword">null</span> <span class="token operator">:</span> pinia<span class="token punctuation">)</span> <span class="token operator">||</span>
      <span class="token punctuation">(</span>hasContext <span class="token operator">?</span> <span class="token function">inject</span><span class="token punctuation">(</span>piniaSymbol<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">)</span>

    <span class="token comment">// 设置当前 pinia 为当前活跃的 pinia 实例  </span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>pinia<span class="token punctuation">)</span> <span class="token function">setActivePinia</span><span class="token punctuation">(</span>pinia<span class="token punctuation">)</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>__DEV__ <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>activePinia<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span>
        <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">[🍍]: &quot;getActivePinia()&quot; was called but there was no active Pinia. Are you trying to use a store before calling &quot;app.use(pinia)&quot;?\n</span><span class="token template-punctuation string">`</span></span> <span class="token operator">+</span>
          <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">See https://pinia.vuejs.org/core-concepts/outside-component-usage.html for help.\n</span><span class="token template-punctuation string">`</span></span> <span class="token operator">+</span>
          <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">This will fail in production.</span><span class="token template-punctuation string">`</span></span>
      <span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 获取当前活跃的 pinia 实例</span>
    pinia <span class="token operator">=</span> activePinia<span class="token operator">!</span>

    <span class="token comment">// 单例模式：如果 pinia 中已经有对应 id 模块的 store 实例则直接获取该 store 实例返回，否则执行创建 store 逻辑</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>pinia<span class="token punctuation">.</span>_s<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// creating the store registers it in `pinia._s`</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>isSetupStore<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">createSetupStore</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> setup<span class="token punctuation">,</span> options<span class="token punctuation">,</span> pinia<span class="token punctuation">)</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token function">createOptionsStore</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> options <span class="token keyword">as</span> any<span class="token punctuation">,</span> pinia<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>

      <span class="token comment">/* istanbul ignore else */</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>__DEV__<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// @ts-expect-error: not the right inferred type</span>
        useStore<span class="token punctuation">.</span>_pinia <span class="token operator">=</span> pinia
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 获取对应的 store，_s 属性是 Map 的数据结构对 Pinia 所有模块 store 的存储</span>
    <span class="token keyword">const</span> <span class="token literal-property property">store</span><span class="token operator">:</span> StoreGeneric <span class="token operator">=</span> pinia<span class="token punctuation">.</span>_s<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token operator">!</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>__DEV__ <span class="token operator">&amp;&amp;</span> hot<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> hotId <span class="token operator">=</span> <span class="token string">'__hot:'</span> <span class="token operator">+</span> id
      <span class="token keyword">const</span> newStore <span class="token operator">=</span> isSetupStore
        <span class="token operator">?</span> <span class="token function">createSetupStore</span><span class="token punctuation">(</span>hotId<span class="token punctuation">,</span> setup<span class="token punctuation">,</span> options<span class="token punctuation">,</span> pinia<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
        <span class="token operator">:</span> <span class="token function">createOptionsStore</span><span class="token punctuation">(</span>hotId<span class="token punctuation">,</span> <span class="token function">assign</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> options<span class="token punctuation">)</span> <span class="token keyword">as</span> any<span class="token punctuation">,</span> pinia<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>

      hot<span class="token punctuation">.</span><span class="token function">_hotUpdate</span><span class="token punctuation">(</span>newStore<span class="token punctuation">)</span>

      <span class="token comment">// cleanup the state properties and the store from the cache</span>
      <span class="token keyword">delete</span> pinia<span class="token punctuation">.</span>state<span class="token punctuation">.</span>value<span class="token punctuation">[</span>hotId<span class="token punctuation">]</span>
      pinia<span class="token punctuation">.</span>_s<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>hotId<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>__DEV__ <span class="token operator">&amp;&amp;</span> <span class="token constant">IS_CLIENT</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> currentInstance <span class="token operator">=</span> <span class="token function">getCurrentInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token comment">// save stores in instances to access them devtools</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>
        currentInstance <span class="token operator">&amp;&amp;</span>
        currentInstance<span class="token punctuation">.</span>proxy <span class="token operator">&amp;&amp;</span>
        <span class="token comment">// avoid adding stores that are just built for hot module replacement</span>
        <span class="token operator">!</span>hot
      <span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> vm <span class="token operator">=</span> currentInstance<span class="token punctuation">.</span>proxy
        <span class="token keyword">const</span> cache <span class="token operator">=</span> <span class="token string">'_pStores'</span> <span class="token keyword">in</span> vm <span class="token operator">?</span> vm<span class="token punctuation">.</span>_pStores<span class="token operator">!</span> <span class="token operator">:</span> <span class="token punctuation">(</span>vm<span class="token punctuation">.</span>_pStores <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
        cache<span class="token punctuation">[</span>id<span class="token punctuation">]</span> <span class="token operator">=</span> store
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// StoreGeneric cannot be casted towards Store</span>
    <span class="token keyword">return</span> store <span class="token keyword">as</span> any
  <span class="token punctuation">}</span>

  useStore<span class="token punctuation">.</span>$id <span class="token operator">=</span> id

  <span class="token comment">// 返回 store</span>
  <span class="token comment">// 在该 store 被使用之前返回函数不会执行，所以 defineStore 早于在 Vue 种注册 pinia 也不会出现错误。</span>
  <span class="token keyword">return</span> useStore
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br></div></div><h3 id="状态更新"><a href="#状态更新" class="header-anchor">#</a> 状态更新</h3> <h4 id="createoptionsstore"><a href="#createoptionsstore" class="header-anchor">#</a> createOptionsStore</h4> <p><code>createOptionsStore</code> 内部也是调用了 <code>createSetupStore</code> 来创建 store 对象。通过 <code>assign</code> 方法实现了 <code>setup</code> 函数，这里可以看到 <code>computed</code> 的实现，内部就是通过 <code>pinia._s</code> 缓存获取 store 对象，调用 store 的 getters 方法来模拟，最后依然通过 <code>createSetupStore</code> 创建。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> createOptionsStore<span class="token operator">&lt;</span>
  Id <span class="token keyword">extends</span> <span class="token class-name">string</span><span class="token punctuation">,</span>
  <span class="token constant">S</span> <span class="token keyword">extends</span> <span class="token class-name">StateTree</span><span class="token punctuation">,</span>
  <span class="token constant">G</span> <span class="token keyword">extends</span> <span class="token class-name">_GettersTree</span><span class="token operator">&lt;</span><span class="token constant">S</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
  <span class="token constant">A</span> <span class="token keyword">extends</span> <span class="token class-name">_ActionsTree</span><span class="token punctuation">,</span>
<span class="token operator">&gt;</span><span class="token punctuation">(</span>
  <span class="token literal-property property">id</span><span class="token operator">:</span> Id<span class="token punctuation">,</span>
  <span class="token literal-property property">options</span><span class="token operator">:</span> DefineStoreOptions<span class="token operator">&lt;</span>Id<span class="token punctuation">,</span> <span class="token constant">S</span><span class="token punctuation">,</span> <span class="token constant">G</span><span class="token punctuation">,</span> <span class="token constant">A</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
  <span class="token literal-property property">pinia</span><span class="token operator">:</span> Pinia<span class="token punctuation">,</span>
  hot<span class="token operator">?</span><span class="token operator">:</span> boolean
<span class="token punctuation">)</span><span class="token operator">:</span> Store<span class="token operator">&lt;</span>Id<span class="token punctuation">,</span> <span class="token constant">S</span><span class="token punctuation">,</span> <span class="token constant">G</span><span class="token punctuation">,</span> <span class="token constant">A</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> state<span class="token punctuation">,</span> actions<span class="token punctuation">,</span> getters <span class="token punctuation">}</span> <span class="token operator">=</span> options

  <span class="token keyword">const</span> <span class="token literal-property property">initialState</span><span class="token operator">:</span> StateTree <span class="token operator">|</span> <span class="token keyword">undefined</span> <span class="token operator">=</span> pinia<span class="token punctuation">.</span>state<span class="token punctuation">.</span>value<span class="token punctuation">[</span>id<span class="token punctuation">]</span>

  <span class="token keyword">let</span> <span class="token literal-property property">store</span><span class="token operator">:</span> Store<span class="token operator">&lt;</span>Id<span class="token punctuation">,</span> <span class="token constant">S</span><span class="token punctuation">,</span> <span class="token constant">G</span><span class="token punctuation">,</span> <span class="token constant">A</span><span class="token operator">&gt;</span>

  <span class="token comment">// 如果没有初始化过当前 ID 的 state 则使用 options 的 state 方法创建一个响应式的数据</span>
  <span class="token keyword">function</span> <span class="token function">setup</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>initialState <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token operator">!</span>__DEV__ <span class="token operator">||</span> <span class="token operator">!</span>hot<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">/* istanbul ignore if */</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>isVue2<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">set</span><span class="token punctuation">(</span>pinia<span class="token punctuation">.</span>state<span class="token punctuation">.</span>value<span class="token punctuation">,</span> id<span class="token punctuation">,</span> state <span class="token operator">?</span> <span class="token function">state</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        pinia<span class="token punctuation">.</span>state<span class="token punctuation">.</span>value<span class="token punctuation">[</span>id<span class="token punctuation">]</span> <span class="token operator">=</span> state <span class="token operator">?</span> <span class="token function">state</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// avoid creating a state in pinia.state.value</span>
    <span class="token comment">// 通过 toRefs 获取一个解构仍能保持响应式的当前 ID 的 state 数据仓库</span>
    <span class="token comment">// 经过 toRefs 处理后，localState.xx.value 就等同于给 state 中的 xx 赋值</span>
    <span class="token keyword">const</span> localState <span class="token operator">=</span>
      __DEV__ <span class="token operator">&amp;&amp;</span> hot
        <span class="token operator">?</span> <span class="token comment">// use ref() to unwrap refs inside state TODO: check if this is still necessary</span>
          <span class="token function">toRefs</span><span class="token punctuation">(</span><span class="token function">ref</span><span class="token punctuation">(</span>state <span class="token operator">?</span> <span class="token function">state</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span>
        <span class="token operator">:</span> <span class="token function">toRefs</span><span class="token punctuation">(</span>pinia<span class="token punctuation">.</span>state<span class="token punctuation">.</span>value<span class="token punctuation">[</span>id<span class="token punctuation">]</span><span class="token punctuation">)</span>

    <span class="token keyword">return</span> <span class="token function">assign</span><span class="token punctuation">(</span>
      localState<span class="token punctuation">,</span>
      actions<span class="token punctuation">,</span>
      Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>getters <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span>
        <span class="token punctuation">(</span><span class="token parameter">computedGetters<span class="token punctuation">,</span> name</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>__DEV__ <span class="token operator">&amp;&amp;</span> name <span class="token keyword">in</span> localState<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            console<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span>
              <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">[🍍]: A getter cannot have the same name as another state property. Rename one of them. Found with &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot; in store &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>id<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;.</span><span class="token template-punctuation string">`</span></span>
            <span class="token punctuation">)</span>
          <span class="token punctuation">}</span>

          <span class="token comment">// 使用 markRaw 标记对象，防止对象被 Proxy 劫持成为响应式数据</span>
          computedGetters<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">markRaw</span><span class="token punctuation">(</span>
            <span class="token comment">// 使用计算属性处理 options 的 getters -- 也是因为这步操作使得 pinia 的 getters 拥有 Vue.js 的 computed 的能力</span>
            <span class="token function">computed</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
              <span class="token function">setActivePinia</span><span class="token punctuation">(</span>pinia<span class="token punctuation">)</span>
              <span class="token comment">// it was created just before</span>
              <span class="token keyword">const</span> store <span class="token operator">=</span> pinia<span class="token punctuation">.</span>_s<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token operator">!</span>

              <span class="token comment">// allow cross using stores</span>
              <span class="token comment">/* istanbul ignore if */</span>
              <span class="token keyword">if</span> <span class="token punctuation">(</span>isVue2 <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>store<span class="token punctuation">.</span>_r<span class="token punctuation">)</span> <span class="token keyword">return</span>

              <span class="token comment">// @ts-expect-error</span>
              <span class="token comment">// return getters![name].call(context, context)</span>
              <span class="token comment">// TODO: avoid reading the getter while assigning with a global variable</span>
              <span class="token comment">// 将 store 的 this 指向 getters 中实现 getters 中 this 才正常使用</span>
              <span class="token keyword">return</span> getters<span class="token operator">!</span><span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>store<span class="token punctuation">,</span> store<span class="token punctuation">)</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
          <span class="token punctuation">)</span>
          <span class="token keyword">return</span> computedGetters
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token keyword">as</span> Record<span class="token operator">&lt;</span>string<span class="token punctuation">,</span> ComputedRef<span class="token operator">&gt;</span>
      <span class="token punctuation">)</span>
    <span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 最终还是通过 createSetupStore 创建 store</span>
  store <span class="token operator">=</span> <span class="token function">createSetupStore</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> setup<span class="token punctuation">,</span> options<span class="token punctuation">,</span> pinia<span class="token punctuation">,</span> hot<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>

  <span class="token keyword">return</span> store <span class="token keyword">as</span> any
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br></div></div><p><code>createOptionStore</code> 方法内部最主要还是根据 options 对象里面的数据，在方法内部构建并且封装为 <code>setup</code> 函数，setup 函数当中主要是将 options 参数中的 <code>state</code> 与 <code>getters</code> 属性分别使用 <code>toRefs</code> 和 <code>computed</code> 封装转化为 ref 响应式数据与 computed 计算属性。因为这步操作使得 pinia store 的 state 的里面的属性具有响应式能力及 getters 具有计算属性的能力，actions 属性保持原样作为 setup 函数返回的对象属性，后续会在 <code>createSetupStore</code> 内进行进一步处理。</p> <h4 id="createsetupstore-patch-更新"><a href="#createsetupstore-patch-更新" class="header-anchor">#</a> createSetupStore - <code>$patch</code> 更新</h4> <p><code>createSetupStore</code> 函数的实现。这个函数也是 Pinia 中最复杂的函数实现，实现了 <code>$patch</code>、<code>$reset</code>、<code>$dispose</code>、<code>$subscribe</code>、<code>$onAction</code>，其中内部的 <code>$patch</code> 函数可以实现数据的更新。如果传递的参数 <code>partialStateOrMutator</code> 是函数，则直接执行，否则就通过 <code>mergeReactiveObjects</code> 方法合并到 state 中，最后生成 <code>subscriptionMutation</code> 对象，通过 <code>triggerSubscriptions</code> 方法触发数据的更新。</p> <p><code>createSetupStore</code> 等方法内部也会通过 <code>Map</code> 的方式实现缓存，并且 <code>setActivePinia</code> 方法可以在多个 Pinia 实例的时候获取当前的实例。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// $patch 函数实现数据的更新</span>

<span class="token keyword">function</span> <span class="token function">$patch</span><span class="token punctuation">(</span>
    <span class="token literal-property property">partialStateOrMutator</span><span class="token operator">:</span>
      <span class="token operator">|</span> _DeepPartial<span class="token operator">&lt;</span>UnwrapRef<span class="token operator">&lt;</span><span class="token constant">S</span><span class="token operator">&gt;&gt;</span>
      <span class="token operator">|</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">state</span><span class="token operator">:</span> UnwrapRef<span class="token operator">&lt;</span><span class="token constant">S</span><span class="token operator">&gt;</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">void</span><span class="token punctuation">)</span>
  <span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> <span class="token literal-property property">subscriptionMutation</span><span class="token operator">:</span> SubscriptionCallbackMutation<span class="token operator">&lt;</span><span class="token constant">S</span><span class="token operator">&gt;</span>
    isListening <span class="token operator">=</span> isSyncListening <span class="token operator">=</span> <span class="token boolean">false</span>
    <span class="token comment">// reset the debugger events since patches are sync</span>
    <span class="token comment">/* istanbul ignore else */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>__DEV__<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      debuggerEvents <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> partialStateOrMutator <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">partialStateOrMutator</span><span class="token punctuation">(</span>pinia<span class="token punctuation">.</span>state<span class="token punctuation">.</span>value<span class="token punctuation">[</span>$id<span class="token punctuation">]</span> <span class="token keyword">as</span> UnwrapRef<span class="token operator">&lt;</span><span class="token constant">S</span><span class="token operator">&gt;</span><span class="token punctuation">)</span>
      subscriptionMutation <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">type</span><span class="token operator">:</span> MutationType<span class="token punctuation">.</span>patchFunction<span class="token punctuation">,</span>
        <span class="token literal-property property">storeId</span><span class="token operator">:</span> $id<span class="token punctuation">,</span>
        <span class="token literal-property property">events</span><span class="token operator">:</span> debuggerEvents <span class="token keyword">as</span> DebuggerEvent<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token function">mergeReactiveObjects</span><span class="token punctuation">(</span>pinia<span class="token punctuation">.</span>state<span class="token punctuation">.</span>value<span class="token punctuation">[</span>$id<span class="token punctuation">]</span><span class="token punctuation">,</span> partialStateOrMutator<span class="token punctuation">)</span>
      subscriptionMutation <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">type</span><span class="token operator">:</span> MutationType<span class="token punctuation">.</span>patchObject<span class="token punctuation">,</span>
        <span class="token literal-property property">payload</span><span class="token operator">:</span> partialStateOrMutator<span class="token punctuation">,</span>
        <span class="token literal-property property">storeId</span><span class="token operator">:</span> $id<span class="token punctuation">,</span>
        <span class="token literal-property property">events</span><span class="token operator">:</span> debuggerEvents <span class="token keyword">as</span> DebuggerEvent<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">const</span> myListenerId <span class="token operator">=</span> <span class="token punctuation">(</span>activeListener <span class="token operator">=</span> <span class="token function">Symbol</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token function">nextTick</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>activeListener <span class="token operator">===</span> myListenerId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        isListening <span class="token operator">=</span> <span class="token boolean">true</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    isSyncListening <span class="token operator">=</span> <span class="token boolean">true</span>
    <span class="token comment">// because we paused the watcher, we need to manually call the subscriptions</span>
    <span class="token function">triggerSubscriptions</span><span class="token punctuation">(</span>
      subscriptions<span class="token punctuation">,</span>
      subscriptionMutation<span class="token punctuation">,</span>
      pinia<span class="token punctuation">.</span>state<span class="token punctuation">.</span>value<span class="token punctuation">[</span>$id<span class="token punctuation">]</span> <span class="token keyword">as</span> UnwrapRef<span class="token operator">&lt;</span><span class="token constant">S</span><span class="token operator">&gt;</span>
    <span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br></div></div><h4 id="reset-状态重置实现"><a href="#reset-状态重置实现" class="header-anchor">#</a> <code>$reset</code> 状态重置实现</h4> <p>Options Store 支持重置 state，内部还是通过 <code>$patch</code> 实现状态的重置：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> $reset <span class="token operator">=</span> isOptionsStore
    <span class="token operator">?</span> <span class="token keyword">function</span> <span class="token function">$reset</span><span class="token punctuation">(</span><span class="token parameter"><span class="token keyword">this</span><span class="token operator">:</span> _StoreWithState<span class="token operator">&lt;</span>Id<span class="token punctuation">,</span> <span class="token constant">S</span><span class="token punctuation">,</span> <span class="token constant">G</span><span class="token punctuation">,</span> <span class="token constant">A</span><span class="token operator">&gt;</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> <span class="token punctuation">{</span> state <span class="token punctuation">}</span> <span class="token operator">=</span> options <span class="token keyword">as</span> DefineStoreOptions<span class="token operator">&lt;</span>Id<span class="token punctuation">,</span> <span class="token constant">S</span><span class="token punctuation">,</span> <span class="token constant">G</span><span class="token punctuation">,</span> <span class="token constant">A</span><span class="token operator">&gt;</span>
        <span class="token keyword">const</span> <span class="token literal-property property">newState</span><span class="token operator">:</span> _DeepPartial<span class="token operator">&lt;</span>UnwrapRef<span class="token operator">&lt;</span><span class="token constant">S</span><span class="token operator">&gt;&gt;</span> <span class="token operator">=</span> state <span class="token operator">?</span> <span class="token function">state</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
        <span class="token comment">// we use a patch to group all changes into one single subscription</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">$patch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">$state</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token comment">// @ts-expect-error: FIXME: shouldn't error?</span>
          <span class="token function">assign</span><span class="token punctuation">(</span>$state<span class="token punctuation">,</span> newState<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token operator">:</span> <span class="token comment">/* istanbul ignore next */</span>
      __DEV__
      <span class="token operator">?</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span>
            <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">🍍: Store &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>$id<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot; is built using the setup syntax and does not implement $reset().</span><span class="token template-punctuation string">`</span></span>
          <span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token operator">:</span> noop
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><h3 id="store-挂载"><a href="#store-挂载" class="header-anchor">#</a> Store 挂载</h3> <p>通过定义 <code>partialStore</code> 对象去存储 <code>ID</code>、<code>$patch</code>、<code>Pinia</code> 实例，并且新增了 <code>subscribe</code> 方法。再调用 <code>reactive</code> 函数把 <code>partialStore</code> 包裹成响应式对象，通过 <code>pinia._s.set</code> 的方法实现 store 的挂载。</p> <p>最后我们通过 <code>pinia._s.get</code> 获取的就是 <code>partialStore</code> 对象，<code>defineStore</code> 返回的方法 <code>useStore</code> 就可以通过 <code>useStore</code> 去获取缓存的 Pinia 对象，实现对数据的更新和读取。</p> <p>这里我们也可以看到，除了直接执行 <code>Action</code> 方法，还可以通过调用内部的 <code>count.$patch({count:count+1})</code> 的方式来实现数字的累加。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>  <span class="token keyword">const</span> partialStore <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">_p</span><span class="token operator">:</span> pinia<span class="token punctuation">,</span>
    <span class="token comment">// _s: scope,</span>
    $id<span class="token punctuation">,</span>
    <span class="token literal-property property">$onAction</span><span class="token operator">:</span> <span class="token function">addSubscription</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> actionSubscriptions<span class="token punctuation">)</span><span class="token punctuation">,</span>
    $patch<span class="token punctuation">,</span>
    $reset<span class="token punctuation">,</span>
    <span class="token function">$subscribe</span><span class="token punctuation">(</span><span class="token parameter">callback<span class="token punctuation">,</span> options <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> removeSubscription <span class="token operator">=</span> <span class="token function">addSubscription</span><span class="token punctuation">(</span>
        subscriptions<span class="token punctuation">,</span>
        callback<span class="token punctuation">,</span>
        options<span class="token punctuation">.</span>detached<span class="token punctuation">,</span>
        <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">stopWatcher</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">)</span>
      <span class="token keyword">const</span> stopWatcher <span class="token operator">=</span> scope<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
        <span class="token function">watch</span><span class="token punctuation">(</span>
          <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> pinia<span class="token punctuation">.</span>state<span class="token punctuation">.</span>value<span class="token punctuation">[</span>$id<span class="token punctuation">]</span> <span class="token keyword">as</span> UnwrapRef<span class="token operator">&lt;</span><span class="token constant">S</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
          <span class="token punctuation">(</span><span class="token parameter">state</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>flush <span class="token operator">===</span> <span class="token string">'sync'</span> <span class="token operator">?</span> isSyncListening <span class="token operator">:</span> isListening<span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token function">callback</span><span class="token punctuation">(</span>
                <span class="token punctuation">{</span>
                  <span class="token literal-property property">storeId</span><span class="token operator">:</span> $id<span class="token punctuation">,</span>
                  <span class="token literal-property property">type</span><span class="token operator">:</span> MutationType<span class="token punctuation">.</span>direct<span class="token punctuation">,</span>
                  <span class="token literal-property property">events</span><span class="token operator">:</span> debuggerEvents <span class="token keyword">as</span> DebuggerEvent<span class="token punctuation">,</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
                state
              <span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token function">assign</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> $subscribeOptions<span class="token punctuation">,</span> options<span class="token punctuation">)</span>
        <span class="token punctuation">)</span>
      <span class="token punctuation">)</span><span class="token operator">!</span>

      <span class="token keyword">return</span> removeSubscription
    <span class="token punctuation">}</span>
    

  <span class="token keyword">const</span> <span class="token literal-property property">store</span><span class="token operator">:</span> Store<span class="token operator">&lt;</span>Id<span class="token punctuation">,</span> <span class="token constant">S</span><span class="token punctuation">,</span> <span class="token constant">G</span><span class="token punctuation">,</span> <span class="token constant">A</span><span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span>
    <span class="token function">assign</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span>， partialStore <span class="token punctuation">)</span>
  <span class="token punctuation">)</span>

  <span class="token comment">// store the partial store now so the setup of stores can instantiate each other before they are finished without</span>
  <span class="token comment">// creating infinite loops.</span>
  pinia<span class="token punctuation">.</span>_s<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>$id<span class="token punctuation">,</span> store<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br></div></div><h3 id="storetorefs-保证响应式"><a href="#storetorefs-保证响应式" class="header-anchor">#</a> storeToRefs 保证响应式</h3> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">function</span> storeToRefs<span class="token operator">&lt;</span><span class="token constant">SS</span> <span class="token keyword">extends</span> <span class="token class-name">StoreGeneric</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>
  <span class="token literal-property property">store</span><span class="token operator">:</span> <span class="token constant">SS</span>
<span class="token punctuation">)</span><span class="token operator">:</span> StoreToRefs<span class="token operator">&lt;</span><span class="token constant">SS</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// See https://github.com/vuejs/pinia/issues/852</span>
  <span class="token comment">// It's easier to just use toRefs() even if it includes more stuff</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>isVue2<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// @ts-expect-error: toRefs include methods and others</span>
    <span class="token keyword">return</span> <span class="token function">toRefs</span><span class="token punctuation">(</span>store<span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    store <span class="token operator">=</span> <span class="token function">toRaw</span><span class="token punctuation">(</span>store<span class="token punctuation">)</span>

    <span class="token keyword">const</span> refs <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token keyword">as</span> StoreToRefs<span class="token operator">&lt;</span><span class="token constant">SS</span><span class="token operator">&gt;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> key <span class="token keyword">in</span> store<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> value <span class="token operator">=</span> store<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isRef</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token function">isReactive</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// @ts-expect-error: the key is state or getter</span>
        refs<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span>
          <span class="token comment">// ---</span>
          <span class="token function">toRef</span><span class="token punctuation">(</span>store<span class="token punctuation">,</span> key<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> refs
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><p>总结：</p> <p><img src="/blog/images/vue/pinia%E5%8E%9F%E7%90%86.png" alt="pinia原理"></p> <h2 id="pinia-的优点"><a href="#pinia-的优点" class="header-anchor">#</a> Pinia 的优点</h2> <ol><li>简化 API
<ul><li>统一状态修改：Pinia 将状态修改逻辑统一到 actions 中，不再用 mutations，减少了 mutations 和 actions 的心智负担，使得 API 更加简单直观。</li> <li>减少样板代码：不需要在 actions 中调用 commit 方法来触发 mutations，代码更加简洁。</li></ul></li> <li>更好的 TypeScript 支持
<ul><li>类型推断：Pinia 提供了强大的类型推断能力，减少了手动编写类型的负担。</li> <li>类型安全：通过 TypeScript，可以确保状态管理代码的类型安全，减少运行时错误。</li></ul></li> <li>灵活性
<ul><li>同步和异步：actions 既可以是同步的，也可以是异步的，提供了更大的灵活性。</li></ul></li> <li>模块化
<ul><li>可以将状态管理逻辑拆分成多个 store，每个 store 管理一部分状态，使得代码更加模块化和可维护。</li> <li>Composition API 支持，与 Vue 3 集成：Pinia 充分利用了 Vue 3 的 Composition API，使得状态管理逻辑可以与组件模板分离，提高了代码的复用性和组织性。</li></ul></li> <li>依赖注入
<ul><li>全局注册：通过 provide 和 inject 机制，可以轻松地在任何组件中获取 store 实例，无需手动传递 props。</li></ul></li> <li>模块热替换 (HMR)
<ul><li>支持 HMR，使得在开发过程中可以即时看到 store 文件的变化，无需重新加载整个页面。</li></ul></li> <li>体积更小
<ul><li>比 Vuex 体积更小，构建压缩后只有 1KB 左右的大小。</li></ul></li></ol> <h2 id="问题"><a href="#问题" class="header-anchor">#</a> 问题</h2> <h3 id="q1-pinia-或者-vuex5-中-为什么-state-必须是一个函数"><a href="#q1-pinia-或者-vuex5-中-为什么-state-必须是一个函数" class="header-anchor">#</a> Q1. pinia 或者 vuex5 中 为什么 state 必须是一个函数？</h3> <p>在 Option Store 中，state 必须是一个函数以确保每个实例都有自己的状态副本，避免状态共享问题，确保每个组件或模块的状态独立，从而避免意外的状态污染。这其实与 Vue 实例中的 data 遵循同样的规则一个道理。</p> <p>当你定义 state 为一个函数时，每次创建一个新的 store 实例时，都会返回一个新的状态对象，从而确保每个组件实例都有自己的独立状态。这样，多个组件或模块使用相同的 store 时，不会互相影响，保证了数据的隔离性和一致性。此外，这种方式使得状态在热重载时也能保持一致性，提升了开发体验。</p> <h3 id="q2-pinia-中状态是为什么能共享-怎么实现的"><a href="#q2-pinia-中状态是为什么能共享-怎么实现的" class="header-anchor">#</a> Q2. pinia 中状态是为什么能共享，怎么实现的？</h3> <p>在 Vue 3 中，Composition API 通过 setup 函数来定义组件的逻辑。在 setup 函数中，你可以使用 ref 和 reactive 来创建响应式状态。这些状态是局部的，每个组件实例都有自己独立的副本。</p> <p>Pinia 的状态管理是全局的，所有组件实例共享同一个状态。这是通过以下机制实现的：</p> <ol><li>全局注册和依赖注入：
<ul><li>Pinia 使用 Vue 3 的 provide 和 inject 机制来全局注册 store，子组件都可以通过 inject 获取这些 store。</li> <li>在根组件中安装 Pinia 后，所有子组件都可以通过 useStore 钩子来获取 store 实例，相同 id 的 store 被不同组件引用，引用的是同一个 store 实例。</li></ul></li> <li>响应式状态：
<ul><li>Pinia 使用 reactive 来创建响应式状态对象。</li> <li>当组件通过 useStore 获取 store 实例时，实际上获取的是同一个响应式对象的引用。</li></ul></li></ol> <h3 id="q3-为什么访问-definestore-创建的-state-不需要-value"><a href="#q3-为什么访问-definestore-创建的-state-不需要-value" class="header-anchor">#</a> Q3. 为什么访问 defineStore 创建的 state 不需要 <code>.value</code></h3> <p>state 的数据都会被处理为 ref，访问 ref 是需要 <code>.value</code>，但 pinia 从来没有 <code>.value</code>。原因就是 reactive 中嵌套 ref 的时候，修改 reactive 内的值不需要 <code>.value</code>。将一个 ref 赋值给一个 reactive 属性时，该 ref 会被自动解包：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> count <span class="token operator">=</span> <span class="token function">ref</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> obj <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>

obj<span class="token punctuation">.</span>count <span class="token operator">=</span> count

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>obj<span class="token punctuation">.</span>count<span class="token punctuation">)</span> <span class="token comment">// 1</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>obj<span class="token punctuation">.</span>count <span class="token operator">===</span> count<span class="token punctuation">.</span>value<span class="token punctuation">)</span> <span class="token comment">// true</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p><a href="https://juejin.cn/post/7124279061035089927#heading-0" target="_blank" rel="noopener noreferrer">Pinia 源码中常见 API<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><a href="https://juejin.cn/post/7121661056044236831" target="_blank" rel="noopener noreferrer">Pinia 源码解析<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><a href="https://juejin.cn/post/7125618284741230628" target="_blank" rel="noopener noreferrer">Pinia mini 实现<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/blog/vue/vue3/vue-router4.html" class="prev">
        VueRouter-V4 原理
      </a></span> <span class="next"><a href="/blog/vue/vue3/ssr.html">
        Vue SSR
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----><!----><!----><!----></div></div>
    <script src="/blog/assets/js/app.d7ed97c7.js" defer></script><script src="/blog/assets/js/2.dec2e75d.js" defer></script><script src="/blog/assets/js/1.5b9e135c.js" defer></script><script src="/blog/assets/js/196.fada8913.js" defer></script><script src="/blog/assets/js/20.badbb211.js" defer></script>
  </body>
</html>
