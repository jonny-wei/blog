<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>异步与内置组件 | 前端那些事儿</title>
    <meta name="generator" content="VuePress 1.9.10">
    <link rel="icon" href="/blog/logo.png">
    <link rel="manifest" href="/blog/manifest.json">
    <link rel="apple-touch-icon" href="/blog/images/icons/apple-icon-152x152.png">
    <meta name="description" content="我命由我不由天，学习吧少年">
    <meta name="theme-color" content="#3eaf7c">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="msapplication-TileImage" content="/icons/ms-icon-144x144.png">
    <meta name="msapplication-TileColor" content="#000000">
    
    <link rel="preload" href="/blog/assets/css/0.styles.f0017422.css" as="style"><link rel="preload" href="/blog/assets/js/app.d7ed97c7.js" as="script"><link rel="preload" href="/blog/assets/js/2.dec2e75d.js" as="script"><link rel="preload" href="/blog/assets/js/1.5b9e135c.js" as="script"><link rel="preload" href="/blog/assets/js/195.7abe4d78.js" as="script"><link rel="preload" href="/blog/assets/js/20.badbb211.js" as="script"><link rel="prefetch" href="/blog/assets/js/10.cc7e09f3.js"><link rel="prefetch" href="/blog/assets/js/100.9b336fb7.js"><link rel="prefetch" href="/blog/assets/js/101.b3f26860.js"><link rel="prefetch" href="/blog/assets/js/102.eeb09b48.js"><link rel="prefetch" href="/blog/assets/js/103.295a03f7.js"><link rel="prefetch" href="/blog/assets/js/104.717a1120.js"><link rel="prefetch" href="/blog/assets/js/105.07d4a177.js"><link rel="prefetch" href="/blog/assets/js/106.b867c336.js"><link rel="prefetch" href="/blog/assets/js/107.30bc7c42.js"><link rel="prefetch" href="/blog/assets/js/108.483bd993.js"><link rel="prefetch" href="/blog/assets/js/109.76770490.js"><link rel="prefetch" href="/blog/assets/js/11.b60c9933.js"><link rel="prefetch" href="/blog/assets/js/110.c9a362b9.js"><link rel="prefetch" href="/blog/assets/js/111.437e19f6.js"><link rel="prefetch" href="/blog/assets/js/112.a97b06a0.js"><link rel="prefetch" href="/blog/assets/js/113.ad01063e.js"><link rel="prefetch" href="/blog/assets/js/114.a8f8f633.js"><link rel="prefetch" href="/blog/assets/js/115.028538b8.js"><link rel="prefetch" href="/blog/assets/js/116.9887f4cf.js"><link rel="prefetch" href="/blog/assets/js/117.cbe35c59.js"><link rel="prefetch" href="/blog/assets/js/118.09ac2f52.js"><link rel="prefetch" href="/blog/assets/js/119.e8238a8b.js"><link rel="prefetch" href="/blog/assets/js/12.c53283e7.js"><link rel="prefetch" href="/blog/assets/js/120.7f3948b9.js"><link rel="prefetch" href="/blog/assets/js/121.d562c136.js"><link rel="prefetch" href="/blog/assets/js/122.813f1055.js"><link rel="prefetch" href="/blog/assets/js/123.ed542f34.js"><link rel="prefetch" href="/blog/assets/js/124.ad28403f.js"><link rel="prefetch" href="/blog/assets/js/125.82ca87f4.js"><link rel="prefetch" href="/blog/assets/js/126.e4c25686.js"><link rel="prefetch" href="/blog/assets/js/127.cc3b25e8.js"><link rel="prefetch" href="/blog/assets/js/128.ded58ef7.js"><link rel="prefetch" href="/blog/assets/js/129.966c655a.js"><link rel="prefetch" href="/blog/assets/js/13.6bdc6b5d.js"><link rel="prefetch" href="/blog/assets/js/130.84505c68.js"><link rel="prefetch" href="/blog/assets/js/131.cec1f85b.js"><link rel="prefetch" href="/blog/assets/js/132.40001954.js"><link rel="prefetch" href="/blog/assets/js/133.2ebebd9b.js"><link rel="prefetch" href="/blog/assets/js/134.36c81557.js"><link rel="prefetch" href="/blog/assets/js/135.f1ec454a.js"><link rel="prefetch" href="/blog/assets/js/136.66c83721.js"><link rel="prefetch" href="/blog/assets/js/137.9f8b8dad.js"><link rel="prefetch" href="/blog/assets/js/138.988cd2bb.js"><link rel="prefetch" href="/blog/assets/js/139.2cf615e5.js"><link rel="prefetch" href="/blog/assets/js/14.c3201a23.js"><link rel="prefetch" href="/blog/assets/js/140.5c5eb828.js"><link rel="prefetch" href="/blog/assets/js/141.b51af892.js"><link rel="prefetch" href="/blog/assets/js/142.bfa62f8b.js"><link rel="prefetch" href="/blog/assets/js/143.3f55661b.js"><link rel="prefetch" href="/blog/assets/js/144.f9f516ff.js"><link rel="prefetch" href="/blog/assets/js/145.6f138c1a.js"><link rel="prefetch" href="/blog/assets/js/146.0535f35d.js"><link rel="prefetch" href="/blog/assets/js/147.aa51a883.js"><link rel="prefetch" href="/blog/assets/js/148.a4d9d839.js"><link rel="prefetch" href="/blog/assets/js/149.20920577.js"><link rel="prefetch" href="/blog/assets/js/15.a0b9e44e.js"><link rel="prefetch" href="/blog/assets/js/150.20d31db8.js"><link rel="prefetch" href="/blog/assets/js/151.8c8797d3.js"><link rel="prefetch" href="/blog/assets/js/152.d7f2d776.js"><link rel="prefetch" href="/blog/assets/js/153.e2cc8151.js"><link rel="prefetch" href="/blog/assets/js/154.f1652a62.js"><link rel="prefetch" href="/blog/assets/js/155.b19acae0.js"><link rel="prefetch" href="/blog/assets/js/156.e9c9ed76.js"><link rel="prefetch" href="/blog/assets/js/157.3253a5d0.js"><link rel="prefetch" href="/blog/assets/js/158.3f2ba030.js"><link rel="prefetch" href="/blog/assets/js/159.bd59b2f5.js"><link rel="prefetch" href="/blog/assets/js/16.491191e4.js"><link rel="prefetch" href="/blog/assets/js/160.1a686de4.js"><link rel="prefetch" href="/blog/assets/js/161.4e0b6f98.js"><link rel="prefetch" href="/blog/assets/js/162.c0650f65.js"><link rel="prefetch" href="/blog/assets/js/163.ec3b78ac.js"><link rel="prefetch" href="/blog/assets/js/164.d21dfff7.js"><link rel="prefetch" href="/blog/assets/js/165.f930cb5f.js"><link rel="prefetch" href="/blog/assets/js/166.1144a3b5.js"><link rel="prefetch" href="/blog/assets/js/167.d9f85a7a.js"><link rel="prefetch" href="/blog/assets/js/168.196a44b6.js"><link rel="prefetch" href="/blog/assets/js/169.bf573f56.js"><link rel="prefetch" href="/blog/assets/js/17.89ec8c57.js"><link rel="prefetch" href="/blog/assets/js/170.9971d5ae.js"><link rel="prefetch" href="/blog/assets/js/171.35d1ba8d.js"><link rel="prefetch" href="/blog/assets/js/172.9bd9c064.js"><link rel="prefetch" href="/blog/assets/js/173.de70e5d2.js"><link rel="prefetch" href="/blog/assets/js/174.8888c1f8.js"><link rel="prefetch" href="/blog/assets/js/175.e6465260.js"><link rel="prefetch" href="/blog/assets/js/176.027707dc.js"><link rel="prefetch" href="/blog/assets/js/177.e066f5f3.js"><link rel="prefetch" href="/blog/assets/js/178.850415f0.js"><link rel="prefetch" href="/blog/assets/js/179.c11070c0.js"><link rel="prefetch" href="/blog/assets/js/18.b91f1411.js"><link rel="prefetch" href="/blog/assets/js/180.f67ffd4c.js"><link rel="prefetch" href="/blog/assets/js/181.8528bfeb.js"><link rel="prefetch" href="/blog/assets/js/182.54743558.js"><link rel="prefetch" href="/blog/assets/js/183.f7a6ea25.js"><link rel="prefetch" href="/blog/assets/js/184.1f5959df.js"><link rel="prefetch" href="/blog/assets/js/185.1d105f97.js"><link rel="prefetch" href="/blog/assets/js/186.77a337c1.js"><link rel="prefetch" href="/blog/assets/js/187.3bbd3ebb.js"><link rel="prefetch" href="/blog/assets/js/188.20d5d95a.js"><link rel="prefetch" href="/blog/assets/js/189.243f4482.js"><link rel="prefetch" href="/blog/assets/js/19.cb1f17c8.js"><link rel="prefetch" href="/blog/assets/js/190.2a570e90.js"><link rel="prefetch" href="/blog/assets/js/191.ebc7021d.js"><link rel="prefetch" href="/blog/assets/js/192.d64c7526.js"><link rel="prefetch" href="/blog/assets/js/193.afe5f5e6.js"><link rel="prefetch" href="/blog/assets/js/194.b39b2183.js"><link rel="prefetch" href="/blog/assets/js/196.fada8913.js"><link rel="prefetch" href="/blog/assets/js/197.6fbcf396.js"><link rel="prefetch" href="/blog/assets/js/198.4ff82464.js"><link rel="prefetch" href="/blog/assets/js/199.c1deed3a.js"><link rel="prefetch" href="/blog/assets/js/200.1748ffa7.js"><link rel="prefetch" href="/blog/assets/js/201.b1e95257.js"><link rel="prefetch" href="/blog/assets/js/202.7a52de85.js"><link rel="prefetch" href="/blog/assets/js/203.88138866.js"><link rel="prefetch" href="/blog/assets/js/204.e6d2f17b.js"><link rel="prefetch" href="/blog/assets/js/205.650b8efa.js"><link rel="prefetch" href="/blog/assets/js/206.11376430.js"><link rel="prefetch" href="/blog/assets/js/207.500b316a.js"><link rel="prefetch" href="/blog/assets/js/208.bddce877.js"><link rel="prefetch" href="/blog/assets/js/209.57413f4b.js"><link rel="prefetch" href="/blog/assets/js/21.bf0041b7.js"><link rel="prefetch" href="/blog/assets/js/210.a0a44e1e.js"><link rel="prefetch" href="/blog/assets/js/211.8e9ab64a.js"><link rel="prefetch" href="/blog/assets/js/212.17214657.js"><link rel="prefetch" href="/blog/assets/js/213.e33a2abb.js"><link rel="prefetch" href="/blog/assets/js/214.d53d39fa.js"><link rel="prefetch" href="/blog/assets/js/215.7d8e6a0e.js"><link rel="prefetch" href="/blog/assets/js/216.3407e98e.js"><link rel="prefetch" href="/blog/assets/js/217.55493374.js"><link rel="prefetch" href="/blog/assets/js/218.635334cf.js"><link rel="prefetch" href="/blog/assets/js/219.1c46332e.js"><link rel="prefetch" href="/blog/assets/js/22.48390d4f.js"><link rel="prefetch" href="/blog/assets/js/220.ebc569c6.js"><link rel="prefetch" href="/blog/assets/js/221.a859e2c2.js"><link rel="prefetch" href="/blog/assets/js/222.0c7fe13e.js"><link rel="prefetch" href="/blog/assets/js/223.7df0d70a.js"><link rel="prefetch" href="/blog/assets/js/224.5c5fb749.js"><link rel="prefetch" href="/blog/assets/js/225.e09e4d9d.js"><link rel="prefetch" href="/blog/assets/js/226.3043cac7.js"><link rel="prefetch" href="/blog/assets/js/227.4e115357.js"><link rel="prefetch" href="/blog/assets/js/23.35c4ba93.js"><link rel="prefetch" href="/blog/assets/js/24.cc3b12df.js"><link rel="prefetch" href="/blog/assets/js/25.632a83cc.js"><link rel="prefetch" href="/blog/assets/js/26.574f1fc1.js"><link rel="prefetch" href="/blog/assets/js/27.ee3c36ec.js"><link rel="prefetch" href="/blog/assets/js/28.2598e102.js"><link rel="prefetch" href="/blog/assets/js/29.6ed063e8.js"><link rel="prefetch" href="/blog/assets/js/3.cb0627fa.js"><link rel="prefetch" href="/blog/assets/js/30.c5bb1b3d.js"><link rel="prefetch" href="/blog/assets/js/31.6ae5d6bc.js"><link rel="prefetch" href="/blog/assets/js/32.63714a18.js"><link rel="prefetch" href="/blog/assets/js/33.0a98d657.js"><link rel="prefetch" href="/blog/assets/js/34.66a4b69e.js"><link rel="prefetch" href="/blog/assets/js/35.efc8ebcf.js"><link rel="prefetch" href="/blog/assets/js/36.28b482d2.js"><link rel="prefetch" href="/blog/assets/js/37.0c70a804.js"><link rel="prefetch" href="/blog/assets/js/38.7b2228d8.js"><link rel="prefetch" href="/blog/assets/js/39.2bc990cf.js"><link rel="prefetch" href="/blog/assets/js/4.cbb57fa7.js"><link rel="prefetch" href="/blog/assets/js/40.5be60d0e.js"><link rel="prefetch" href="/blog/assets/js/41.7524bbf0.js"><link rel="prefetch" href="/blog/assets/js/42.714adee0.js"><link rel="prefetch" href="/blog/assets/js/43.718a9ac3.js"><link rel="prefetch" href="/blog/assets/js/44.cdf11766.js"><link rel="prefetch" href="/blog/assets/js/45.b9f73462.js"><link rel="prefetch" href="/blog/assets/js/46.070617b5.js"><link rel="prefetch" href="/blog/assets/js/47.45dbd8ee.js"><link rel="prefetch" href="/blog/assets/js/48.a5d36e11.js"><link rel="prefetch" href="/blog/assets/js/49.03e700f2.js"><link rel="prefetch" href="/blog/assets/js/5.fe065607.js"><link rel="prefetch" href="/blog/assets/js/50.edafa678.js"><link rel="prefetch" href="/blog/assets/js/51.6e2290a8.js"><link rel="prefetch" href="/blog/assets/js/52.c109d7d5.js"><link rel="prefetch" href="/blog/assets/js/53.50675a1d.js"><link rel="prefetch" href="/blog/assets/js/54.0afdb68d.js"><link rel="prefetch" href="/blog/assets/js/55.f9013f21.js"><link rel="prefetch" href="/blog/assets/js/56.e7ca6c14.js"><link rel="prefetch" href="/blog/assets/js/57.8b42df8f.js"><link rel="prefetch" href="/blog/assets/js/58.7b68fa2c.js"><link rel="prefetch" href="/blog/assets/js/59.e276f401.js"><link rel="prefetch" href="/blog/assets/js/6.68cda050.js"><link rel="prefetch" href="/blog/assets/js/60.4add09d0.js"><link rel="prefetch" href="/blog/assets/js/61.0fe45890.js"><link rel="prefetch" href="/blog/assets/js/62.66b58176.js"><link rel="prefetch" href="/blog/assets/js/63.adc3ee7b.js"><link rel="prefetch" href="/blog/assets/js/64.590e5a37.js"><link rel="prefetch" href="/blog/assets/js/65.bfebad49.js"><link rel="prefetch" href="/blog/assets/js/66.281a5ac4.js"><link rel="prefetch" href="/blog/assets/js/67.3b13d2f2.js"><link rel="prefetch" href="/blog/assets/js/68.e53606db.js"><link rel="prefetch" href="/blog/assets/js/69.2059be22.js"><link rel="prefetch" href="/blog/assets/js/7.3b8d63a0.js"><link rel="prefetch" href="/blog/assets/js/70.c7774f34.js"><link rel="prefetch" href="/blog/assets/js/71.559dfdd3.js"><link rel="prefetch" href="/blog/assets/js/72.cbac4235.js"><link rel="prefetch" href="/blog/assets/js/73.aa1efffb.js"><link rel="prefetch" href="/blog/assets/js/74.de2cf5f9.js"><link rel="prefetch" href="/blog/assets/js/75.d9244242.js"><link rel="prefetch" href="/blog/assets/js/76.93d6b837.js"><link rel="prefetch" href="/blog/assets/js/77.c82da724.js"><link rel="prefetch" href="/blog/assets/js/78.4e6d4811.js"><link rel="prefetch" href="/blog/assets/js/79.0f4aac22.js"><link rel="prefetch" href="/blog/assets/js/80.6a6b99e8.js"><link rel="prefetch" href="/blog/assets/js/81.712bd61b.js"><link rel="prefetch" href="/blog/assets/js/82.181cda89.js"><link rel="prefetch" href="/blog/assets/js/83.7ab5ac5b.js"><link rel="prefetch" href="/blog/assets/js/84.6bbbb8d2.js"><link rel="prefetch" href="/blog/assets/js/85.4adfb728.js"><link rel="prefetch" href="/blog/assets/js/86.2121d070.js"><link rel="prefetch" href="/blog/assets/js/87.e8c62457.js"><link rel="prefetch" href="/blog/assets/js/88.93dd4fca.js"><link rel="prefetch" href="/blog/assets/js/89.a93de9cf.js"><link rel="prefetch" href="/blog/assets/js/90.d4170ea4.js"><link rel="prefetch" href="/blog/assets/js/91.9bc2590d.js"><link rel="prefetch" href="/blog/assets/js/92.e94d0ec0.js"><link rel="prefetch" href="/blog/assets/js/93.3f378b31.js"><link rel="prefetch" href="/blog/assets/js/94.b567445f.js"><link rel="prefetch" href="/blog/assets/js/95.708acdfa.js"><link rel="prefetch" href="/blog/assets/js/96.fe23b2db.js"><link rel="prefetch" href="/blog/assets/js/97.2301b9cf.js"><link rel="prefetch" href="/blog/assets/js/98.6c7c4ab4.js"><link rel="prefetch" href="/blog/assets/js/99.974edfb7.js"><link rel="prefetch" href="/blog/assets/js/vendors~docsearch.bd3cdb54.js">
    <link rel="stylesheet" href="/blog/assets/css/0.styles.f0017422.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/blog/" class="home-link router-link-active"><img src="/blog/logo.png" alt="前端那些事儿" class="logo"> <span class="site-name can-hide">前端那些事儿</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/blog/" class="nav-link">
  主页
</a></div><div class="nav-item"><a href="/blog/base/" class="nav-link">
  前端基础
</a></div><div class="nav-item"><a href="/blog/vue/" class="nav-link router-link-active">
  Vue
</a></div><div class="nav-item"><a href="/blog/react/" class="nav-link">
  React
</a></div><div class="nav-item"><a href="/blog/devops/" class="nav-link">
  前端工程化
</a></div><div class="nav-item"><a href="/blog/mobile/" class="nav-link">
  泛客户端
</a></div><div class="nav-item"><a href="/blog/architecture/" class="nav-link">
  架构与方案
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="GitHub" class="dropdown-title"><span class="title">GitHub</span> <span class="arrow down"></span></button> <button type="button" aria-label="GitHub" class="mobile-dropdown-title"><span class="title">GitHub</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/jonny-wei" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://github.com/jonny-wei/sushi-js" target="_blank" rel="noopener noreferrer" class="nav-link external">
  JS 寿司
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/blog/" class="nav-link">
  主页
</a></div><div class="nav-item"><a href="/blog/base/" class="nav-link">
  前端基础
</a></div><div class="nav-item"><a href="/blog/vue/" class="nav-link router-link-active">
  Vue
</a></div><div class="nav-item"><a href="/blog/react/" class="nav-link">
  React
</a></div><div class="nav-item"><a href="/blog/devops/" class="nav-link">
  前端工程化
</a></div><div class="nav-item"><a href="/blog/mobile/" class="nav-link">
  泛客户端
</a></div><div class="nav-item"><a href="/blog/architecture/" class="nav-link">
  架构与方案
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="GitHub" class="dropdown-title"><span class="title">GitHub</span> <span class="arrow down"></span></button> <button type="button" aria-label="GitHub" class="mobile-dropdown-title"><span class="title">GitHub</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/jonny-wei" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://github.com/jonny-wei/sushi-js" target="_blank" rel="noopener noreferrer" class="nav-link external">
  JS 寿司
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Vue</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/vue/" aria-current="page" class="sidebar-link">Vue 组件通信</a></li><li><a href="/blog/vue/warmup/vue-symbols.html" class="sidebar-link">Vue 修饰符</a></li><li><a href="/blog/vue/warmup/vue-optimization.html" class="sidebar-link">Vue 相关优化</a></li><li><a href="/blog/vue/warmup/vue-router.html" class="sidebar-link">VueRouter 核心原理</a></li><li><a href="/blog/vue/warmup/vue-vuex.html" class="sidebar-link">Vuex 实现原理</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Vue源码解析</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/vue/vue/github.html" class="sidebar-link">源码学习</a></li><li><a href="/blog/vue/vue/vue-render.html" class="sidebar-link">渲染器</a></li><li><a href="/blog/vue/vue/vue-init.html" class="sidebar-link">构建与初始化</a></li><li><a href="/blog/vue/vue/vue-component.html" class="sidebar-link">组件化过程</a></li><li><a href="/blog/vue/vue/vue-observer.html" class="sidebar-link">响应式原理</a></li><li><a href="/blog/vue/vue/vue-template.html" class="sidebar-link">模板编译与渲染</a></li><li><a href="/blog/vue/vue/vue-diff.html" class="sidebar-link">虚拟 DOM 与 Diff 算法</a></li><li><a href="/blog/vue/vue/vue-nextTick.html" class="sidebar-link">异步更新队列</a></li><li><a href="/blog/vue/vue/vue-lifecycle.html" class="sidebar-link">生命周期</a></li><li><a href="/blog/vue/vue/vue-computed.html" class="sidebar-link">计算属性与侦听器</a></li><li><a href="/blog/vue/vue/vue-slot.html" class="sidebar-link">插槽</a></li><li><a href="/blog/vue/vue/vue-directive.html" class="sidebar-link">Vue 指令</a></li><li><a href="/blog/vue/vue/vue-event.html" class="sidebar-link">事件绑定原理</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>VueRouter源码解析</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/vue/vue-router/abstract.html" class="sidebar-link">摘要</a></li><li><a href="/blog/vue/vue-router/warmUp.html" class="sidebar-link">准备工作</a></li><li><a href="/blog/vue/vue-router/plugin.html" class="sidebar-link">插件机制</a></li><li><a href="/blog/vue/vue-router/initialization.html" class="sidebar-link">初始化与降级处理</a></li><li><a href="/blog/vue/vue-router/transitions.html" class="sidebar-link">路由过渡与视图渲染</a></li><li><a href="/blog/vue/vue-router/match.html" class="sidebar-link">路由匹配</a></li><li><a href="/blog/vue/vue-router/summary.html" class="sidebar-link">总结</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Vuex源码解析</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/vue/vuex/abstract.html" class="sidebar-link">摘要</a></li><li><a href="/blog/vue/vuex/warmUp.html" class="sidebar-link">准备工作</a></li><li><a href="/blog/vue/vuex/initialization.html" class="sidebar-link">初始化与模块安装</a></li><li><a href="/blog/vue/vuex/state.html" class="sidebar-link">State 相关</a></li><li><a href="/blog/vue/vuex/getters.html" class="sidebar-link">Getters 相关</a></li><li><a href="/blog/vue/vuex/mutations.html" class="sidebar-link">Mutations 相关</a></li><li><a href="/blog/vue/vuex/actions.html" class="sidebar-link">Actions 相关</a></li><li><a href="/blog/vue/vuex/modules.html" class="sidebar-link">Modules 相关</a></li><li><a href="/blog/vue/vuex/others.html" class="sidebar-link">其他</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Vue3新特性</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/vue/vue3.x/reactivity.html" class="sidebar-link">响应式系统方面</a></li><li><a href="/blog/vue/vue3.x/features.html" class="sidebar-link">功能方面</a></li><li><a href="/blog/vue/vue3.x/performance.html" class="sidebar-link">性能方面</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>VueNext</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/vue/vue3/reactivity.html" class="sidebar-link">设计响应式系统</a></li><li><a href="/blog/vue/vue3/diff.html" class="sidebar-link">快速 Diff 算法</a></li><li><a href="/blog/vue/vue3/components.html" class="sidebar-link">组件化原理</a></li><li><a href="/blog/vue/vue3/inner-components.html" aria-current="page" class="active sidebar-link">异步与内置组件</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/vue/vue3/inner-components.html#defineasynccomponent" class="sidebar-link">defineAsyncComponent</a></li><li class="sidebar-sub-header"><a href="/blog/vue/vue3/inner-components.html#keepalive" class="sidebar-link">KeepAlive</a></li><li class="sidebar-sub-header"><a href="/blog/vue/vue3/inner-components.html#teleport" class="sidebar-link">Teleport</a></li></ul></li><li><a href="/blog/vue/vue3/compiler.html" class="sidebar-link">模板编译与优化</a></li><li><a href="/blog/vue/vue3/hooks.html" class="sidebar-link">Hooks</a></li><li><a href="/blog/vue/vue3/vue-router4.html" class="sidebar-link">VueRouter-V4 原理</a></li><li><a href="/blog/vue/vue3/pinia.html" class="sidebar-link">Pinia 原理</a></li><li><a href="/blog/vue/vue3/ssr.html" class="sidebar-link">Vue SSR</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="异步与内置组件"><a href="#异步与内置组件" class="header-anchor">#</a> 异步与内置组件</h1> <h2 id="defineasynccomponent"><a href="#defineasynccomponent" class="header-anchor">#</a> defineAsyncComponent</h2> <p>异步组件，即组件懒加载，异步的方式加载并渲染一个组件，在代码分割、服务端下发组件等场景中尤为重要。</p> <p>从根本上来说，异步组件的实现不需要任何框架层面的支持，用户完全可以自行实现：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 页面整体懒加载</span>
<span class="token keyword">const</span> <span class="token function-variable function">loader</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">import</span><span class="token punctuation">(</span><span class="token string">'App.vue'</span><span class="token punctuation">)</span> <span class="token comment">// 动态导入 App.vue 组件</span>
<span class="token function">loader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">App</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> <span class="token comment">// 当 App.vue 导入完成后</span>
  <span class="token function">createApp</span><span class="token punctuation">(</span>App<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">mount</span><span class="token punctuation">(</span><span class="token string">'#app'</span><span class="token punctuation">)</span> <span class="token comment">// 创建一个 Vue 应用实例，并挂载到 id 为 app 的 DOM 元素上</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>若一个页面会由多个组件构成，每个组件负责渲染页面的一部分。那么，如果只想异步渲染部分页面，要怎么办呢？这时，只需要有能力异步加载某一个组件就可以了:</p> <div class="language-vue line-numbers-mode"><pre class="language-vue"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>template</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>CompA</span> <span class="token punctuation">/&gt;</span></span> <span class="token comment">&lt;!-- 渲染 CompA 组件 --&gt;</span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>component</span> <span class="token attr-name">:is</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>asyncComp<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span> <span class="token comment">&lt;!-- 动态渲染 asyncComp 组件 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>template</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
<span class="token keyword">import</span> <span class="token punctuation">{</span> shallowRef <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'vue'</span> <span class="token comment">// 从 Vue 中导入 shallowRef 函数</span>
<span class="token keyword">import</span> CompA <span class="token keyword">from</span> <span class="token string">'CompA.vue'</span> <span class="token comment">// 同步导入 CompA 组件</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">components</span><span class="token operator">:</span> <span class="token punctuation">{</span> CompA <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token comment">// 注册 CompA 组件</span>
  <span class="token function">setup</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> asyncComp <span class="token operator">=</span> <span class="token function">shallowRef</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token comment">// 使用 shallowRef 创建一个响应式引用，初始值为 null</span>

    <span class="token comment">// 异步加载 CompB 组件</span>
    <span class="token keyword">import</span><span class="token punctuation">(</span><span class="token string">'CompB.vue'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">CompB</span> <span class="token operator">=&gt;</span> asyncComp<span class="token punctuation">.</span>value <span class="token operator">=</span> CompB<span class="token punctuation">)</span> <span class="token comment">// 当 CompB.vue 加载完成，更新 asyncComp 的值</span>

    <span class="token keyword">return</span> <span class="token punctuation">{</span>
      asyncComp <span class="token comment">// 返回 asyncComp，使其可以在模板中使用</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><p>虽然可以自己实现异步懒加载组件，但是考虑不全面，开发体验差，若是从框架层面解决，那么对开发者来说就非常友好。如何设计一个异步组件呢？通常在异步加载组件时，我们还要考虑以下几个方面:</p> <ul><li>如果组件加载失败或加载超时，是否要渲染 Error 组件？</li> <li>组件在加载时，是否要展示占位的内容？例如渲染一个Loading 组件。</li> <li>组件加载的速度可能很快，也可能很慢，是否要设置一个延迟展示 Loading 组件的时间？如果组件在 200ms 内没有加载成功才展示 Loading 组件，这样可以避免由组件加载过快所导致的闪烁。</li> <li>组件加载失败后，是否需要重试？</li></ul> <p>为了替用户更好地解决上述问题，我们需要在框架层面为异步组件提供更好的封装支持，与之对应的能力如下：</p> <ul><li>允许用户指定加载出错时要渲染的组件。</li> <li>允许用户指定 Loading 组件，以及展示该组件的延迟时间。</li> <li>允许用户设置加载组件的超时时长。</li> <li>组件加载失败时，为用户提供重试的能力。</li></ul> <h3 id="接口定义"><a href="#接口定义" class="header-anchor">#</a> 接口定义</h3> <p>定义一个异步组件，它在运行时是懒加载的。参数可以是一个异步加载函数，或是对加载行为进行更具体定制的一个选项对象。</p> <p><a href="https://cn.vuejs.org/guide/components/async.html" target="_blank" rel="noopener noreferrer">Vue 异步组件<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">defineAsyncComponent</span><span class="token punctuation">(</span>
  <span class="token parameter"><span class="token literal-property property">source</span><span class="token operator">:</span> AsyncComponentLoader <span class="token operator">|</span> AsyncComponentOptions</span>
<span class="token punctuation">)</span><span class="token operator">:</span> Component

type <span class="token function-variable function">AsyncComponentLoader</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> Promise<span class="token operator">&lt;</span>Component<span class="token operator">&gt;</span>

<span class="token keyword">interface</span> <span class="token class-name">AsyncComponentOptions</span> <span class="token punctuation">{</span>
  <span class="token comment">// 加载函数</span>
  <span class="token literal-property property">loader</span><span class="token operator">:</span> AsyncComponentLoader
  <span class="token comment">// 加载异步组件时使用的组件</span>
  loadingComponent<span class="token operator">?</span><span class="token operator">:</span> Component
  <span class="token comment">// 展示加载组件前的延迟时间，默认为 200ms，防止组件闪烁</span>
  delay<span class="token operator">?</span><span class="token operator">:</span> number
  <span class="token comment">// 加载失败后展示的组件</span>
  errorComponent<span class="token operator">?</span><span class="token operator">:</span> Component
  <span class="token comment">// 如果提供了一个 timeout 时间限制，并超时了也会显示这里配置的报错组件，默认值是：Infinity</span>
  timeout<span class="token operator">?</span><span class="token operator">:</span> number
  suspensible<span class="token operator">?</span><span class="token operator">:</span> boolean
  <span class="token comment">// 错误回调，可以处理失败与重试</span>
  onError<span class="token operator">?</span><span class="token operator">:</span> <span class="token punctuation">(</span>
    <span class="token literal-property property">error</span><span class="token operator">:</span> Error<span class="token punctuation">,</span>
    <span class="token function-variable function">retry</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">void</span><span class="token punctuation">,</span>
    <span class="token function-variable function">fail</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">void</span><span class="token punctuation">,</span>
    <span class="token literal-property property">attempts</span><span class="token operator">:</span> number
  <span class="token punctuation">)</span> <span class="token operator">=&gt;</span> any
<span class="token punctuation">}</span>


<span class="token comment">// 使用</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> defineAsyncComponent <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'vue'</span>

<span class="token keyword">const</span> AsyncComp <span class="token operator">=</span> <span class="token function">defineAsyncComponent</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...从服务器获取组件</span>
    <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token comment">/* 获取到的组件 */</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">// ... 像使用其他一般组件一样使用 `AsyncComp`</span>

<span class="token comment">// 通常结合打包工具这样用，作为打包时的代码分割点</span>
<span class="token keyword">const</span> AsyncComp <span class="token operator">=</span> <span class="token function">defineAsyncComponent</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
  <span class="token keyword">import</span><span class="token punctuation">(</span><span class="token string">'./components/MyComponent.vue'</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br></div></div><p>最后得到的 AsyncComp 是一个外层包装过的组件，仅在页面需要它渲染时才会调用加载内部实际组件的函数。它会将接收到的 props 和插槽传给内部组件，所以你可以使用这个异步的包装组件无缝地替换原始组件，同时实现延迟加载。</p> <p>如果提供了一个加载组件，它将在内部组件加载时先行显示。在加载组件显示之前有一个默认的 200ms 延迟——这是因为在网络状况较好时，加载完成得很快，加载组件和最终组件之间的替换太快可能产生闪烁，反而影响用户感受。</p> <p>如果提供了一个报错组件，则它会在加载器函数返回的 Promise 抛错时被渲染。你还可以指定一个超时时间，在请求耗时超过指定时间时也会渲染报错组件。</p> <p>异步组件可以搭配内置的 <code>&lt;Suspense&gt;</code> 组件一起使用。</p> <h3 id="设计实现"><a href="#设计实现" class="header-anchor">#</a> 设计实现</h3> <ul><li><strong>加载机制</strong>：<code>defineAsyncComponent</code> 本质上是一个高阶组件，它的返回值是一个包装组件。包装组件会根据加载器的状态来决定渲染什么内容。如果加载器成功地加载了组件，则渲染被加载的组件，否则会渲染一个占位内容。通常占位内容是一个注释节点。组件没有被加载成功时，页面中会渲染一个注释节点来占位。</li> <li><strong>延迟与 Loading 组件机制</strong>: 通常，我们会从加载开始的那一刻起就展示 Loading 组件。但在网络状况良好的情况下，异步组件的加载速度会非常快，这会导致 Loading 组件刚完成渲染就立即进入卸载阶段，于是出现闪烁的情况。对于用户来说这是非常不好的体验。因此，我们需要为 Loading 组件设置一个延迟展示的时间。要一个标记变量 <code>loading</code> 来代表组件是否正在加载。如果用户指定了延迟时间，则开启延迟定时器。定时器到时后，再将 <code>loading.value</code> 的值设置为 true。无论组件加载成功与否，都要清除延迟定时器，否则会出现组件已经加载成功，但仍然展示 Loading 组件的问题。在渲染函数中，如果组件正在加载，并且用户指定了 Loading 组件，则渲染该 Loading 组件。</li> <li><strong>超时与错误机制</strong>：要一个标志变量来标识异步组件的加载是否已经超时，即 <code>timeout.value</code>。开始加载组件的同时，开启一个定时器进行计时。当加载超时后，将 <code>timeout.value</code> 的值设置为 true，代表加载已经超时。这里需要注意的是，当包装组件被卸载时，需要清除定时器。包装组件根据 <code>loaded</code> 变量的值以及 <code>timeout</code> 变量的值来决定具体的渲染内容。如果异步组件加载成功，则渲染被加载的组件；如果异步组件加载超时，并且用户指定了 Error 组件，则渲染 Error 组件。为了更细腻度的控制，可为加载器添加 <code>catch</code> 语句来捕获所有加载错误。接着，当加载超时后，我们会创建一个新的错误对象，并将其赋值给 <code>error.value</code> 变量。在组件渲染时，只要 <code>error.value</code> 的值存在，且用户配置了 <code>errorComponent</code> 组件，就直接渲染 <code>errorComponent</code> 组件并将 <code>error.value</code> 的值作为该组件的 <code>props</code> 传递。这样，用户就可以在自己的 Error 组件上，通过定义名为 <code>error</code> 的 <code>props</code> 来接收错误对象，从而实现细粒度的控制。</li> <li><strong>失败重试机制</strong>: 将新的 Promise 实例的 resolve 和 reject 分别封装为 <code>retry</code> 函数和 <code>fail</code> 函数，并将它们作为 onError 回调函数的参数。这样，用户就可以在错误发生时主动选择重试或直接抛出错误。</li></ul> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> ref<span class="token punctuation">,</span> shallowRef<span class="token punctuation">,</span> h<span class="token punctuation">,</span> onBeforeUnmount<span class="token punctuation">,</span> nextTick <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'vue'</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * 加载异步组件
 * @param {Function} loader - 加载器函数
 * @param {Function} onError - 错误处理回调函数
 * @param {number} retries - 当前重试次数
 * @returns {Promise} - 返回一个 Promise 实例
 */</span>
<span class="token keyword">function</span> <span class="token function">load</span><span class="token punctuation">(</span><span class="token parameter">loader<span class="token punctuation">,</span> onError<span class="token punctuation">,</span> retries <span class="token operator">=</span> <span class="token number">0</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">loader</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token comment">// 如果用户指定了 onError 回调，则将控制权交给用户</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>onError<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 返回一个新的 Promise 实例</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token comment">// 重试</span>
          <span class="token keyword">const</span> <span class="token function-variable function">retry</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            retries<span class="token operator">++</span><span class="token punctuation">;</span>
            <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token function">load</span><span class="token punctuation">(</span>loader<span class="token punctuation">,</span> onError<span class="token punctuation">,</span> retries<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span><span class="token punctuation">;</span>
          <span class="token comment">// 失败</span>
          <span class="token keyword">const</span> <span class="token function-variable function">fail</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">reject</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token comment">// 作为 onError 回调函数的参数，让用户来决定下一步怎么做</span>
          <span class="token function">onError</span><span class="token punctuation">(</span>retry<span class="token punctuation">,</span> fail<span class="token punctuation">,</span> retries<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> err<span class="token punctuation">;</span> <span class="token comment">// 如果没有指定 onError，则直接抛出错误</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
 * 定义异步组件
 * @param {Object|Function} options - 异步组件的配置选项或加载器函数
 * @returns {Object} - 返回一个 Vue 组件对象
 */</span>
<span class="token keyword">function</span> <span class="token function">defineAsyncComponent</span><span class="token punctuation">(</span><span class="token parameter">options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 如果 options 是一个函数，则将其转换为对象形式，其中 loader 为该函数</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> options <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    options <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token literal-property property">loader</span><span class="token operator">:</span> options <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">const</span> <span class="token punctuation">{</span>
    loader<span class="token punctuation">,</span>
    loadingComponent<span class="token punctuation">,</span>
    errorComponent<span class="token punctuation">,</span>
    delay <span class="token operator">=</span> <span class="token number">200</span><span class="token punctuation">,</span>
    timeout<span class="token punctuation">,</span>
    onError
  <span class="token punctuation">}</span> <span class="token operator">=</span> options<span class="token punctuation">;</span>

  <span class="token keyword">let</span> InnerComp <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span> <span class="token comment">// 存储加载的组件</span>

  <span class="token comment">// 创建一个 Vue 组件对象</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'AsyncComponentWrapper'</span><span class="token punctuation">,</span>
    <span class="token function">setup</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> loaded <span class="token operator">=</span> <span class="token function">ref</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> error <span class="token operator">=</span> <span class="token function">shallowRef</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> loading <span class="token operator">=</span> <span class="token function">ref</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">let</span> loadingTimer <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span> <span class="token comment">// 延迟加载的定时器</span>
      <span class="token keyword">let</span> timeoutTimer <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span> <span class="token comment">// 超时的定时器</span>

      <span class="token comment">// 如果配置了延迟加载，则设置定时器，在延迟时间后将 loading 设置为 true</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>delay<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        loadingTimer <span class="token operator">=</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          loading<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> delay<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// 如果没有配置延迟，则立即设置为加载中</span>
        loading<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token comment">// 如果配置了超时时间，则设置超时定时器</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>timeout<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        timeoutTimer <span class="token operator">=</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token keyword">const</span> err <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Async component timed out after </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>timeout<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">ms.</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          error<span class="token punctuation">.</span>value <span class="token operator">=</span> err<span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> timeout<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token comment">// 调用 load 函数加载组件</span>
      <span class="token function">load</span><span class="token punctuation">(</span>loader<span class="token punctuation">,</span> onError<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">c</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          InnerComp <span class="token operator">=</span> c<span class="token punctuation">;</span>
          loaded<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          error<span class="token punctuation">.</span>value <span class="token operator">=</span> err<span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">finally</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          loading<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
          <span class="token function">clearTimeout</span><span class="token punctuation">(</span>loadingTimer<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token function">clearTimeout</span><span class="token punctuation">(</span>timeoutTimer<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// 在组件卸载前清理定时器，防止内存泄漏</span>
      <span class="token function">onBeforeUnmount</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token function">clearTimeout</span><span class="token punctuation">(</span>loadingTimer<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">clearTimeout</span><span class="token punctuation">(</span>timeoutTimer<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// 渲染逻辑</span>
      <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>loaded<span class="token punctuation">.</span>value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// 如果组件已加载，则渲染组件</span>
          <span class="token keyword">return</span> <span class="token function">h</span><span class="token punctuation">(</span>InnerComp<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>error<span class="token punctuation">.</span>value <span class="token operator">&amp;&amp;</span> errorComponent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// 如果有错误且提供了错误组件，则渲染错误组件</span>
          <span class="token keyword">return</span> <span class="token function">h</span><span class="token punctuation">(</span>errorComponent<span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">error</span><span class="token operator">:</span> error<span class="token punctuation">.</span>value <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>loading<span class="token punctuation">.</span>value <span class="token operator">&amp;&amp;</span> loadingComponent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// 如果正在加载且提供了加载组件，则渲染加载组件</span>
          <span class="token keyword">return</span> <span class="token function">h</span><span class="token punctuation">(</span>loadingComponent<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          <span class="token comment">// 如果以上条件都不满足，则返回占位符</span>
          <span class="token keyword">return</span> <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">style</span><span class="token operator">:</span> <span class="token string">'visibility: hidden;'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">'Loading...'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br></div></div><h2 id="keepalive"><a href="#keepalive" class="header-anchor">#</a> KeepAlive</h2> <p><code>&lt;KeepAlive&gt;</code> 是一个内置组件，它的功能是在多个组件间动态切换时缓存被移除的组件实例。<code>&lt;KeepAlive&gt;</code> 包裹动态组件时，会缓存不活跃的组件实例，而不是销毁它们。何时候都只能有一个活跃组件实例作为 <code>&lt;KeepAlive&gt;</code> 的直接子节点。当一个组件在 <code>&lt;KeepAlive&gt;</code> 中被切换时，它的 <code>activated</code> 和 <code>deactivated</code> 生命周期钩子将被调用，用来替代 <code>mounted</code> 和 <code>unmounted</code>。这适用于 <code>&lt;KeepAlive&gt;</code> 的直接子节点及其所有子孙节点。</p> <p><a href="https://cn.vuejs.org/guide/built-ins/keep-alive.html" target="_blank" rel="noopener noreferrer">Vue KeepAlive<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h3 id="接口定义-2"><a href="#接口定义-2" class="header-anchor">#</a> 接口定义</h3> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">interface</span> <span class="token class-name">KeepAliveProps</span> <span class="token punctuation">{</span>
  <span class="token comment">/**
   * 如果指定，则只有与 `include` 名称
   * 匹配的组件才会被缓存。
   */</span>
  include<span class="token operator">?</span><span class="token operator">:</span> MatchPattern
  <span class="token comment">/**
   * 任何名称与 `exclude`
   * 匹配的组件都不会被缓存。
   */</span>
  exclude<span class="token operator">?</span><span class="token operator">:</span> MatchPattern
  <span class="token comment">/**
   * 最多可以缓存多少组件实例。
   */</span>
  max<span class="token operator">?</span><span class="token operator">:</span> number <span class="token operator">|</span> string
<span class="token punctuation">}</span>

type MatchPattern <span class="token operator">=</span> string <span class="token operator">|</span> RegExp <span class="token operator">|</span> <span class="token punctuation">(</span>string <span class="token operator">|</span> RegExp<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><h3 id="设计实现-2"><a href="#设计实现-2" class="header-anchor">#</a> 设计实现</h3> <ul><li><strong>标记后不被卸载而是失活</strong>: <code>shouldKeepAlive</code> 该属性会被添加到“内部组件”的 vnode 对象上，这样当渲染器卸载“内部组件”时，可以通过检查该属性得知“内部组件”需要被 <code>KeepAlive</code>。于是，渲染器就不会真的卸载“内部组件”​，而是会调用 <code>_deActivate</code> 函数完成搬运工作。</li> <li><strong>访问缓存的组件实例</strong>：<code>keepAliveInstance</code>​“内部组件”的 <code>vnode</code> 对象会持有 <code>KeepAlive</code> 组件实例，在 <code>unmount</code> 函数中会通过 <code>keepAliveInstance</code> 来访问 <code>_deActivate</code> 函数。</li> <li><strong>执行激活和失活钩子</strong>：失活的本质就是将组件所渲染的内容移动到隐藏容器中，而激活的本质是将组件所渲染的内容从隐藏容器中搬运回原来的容器。</li> <li><strong>缓存策略与管理</strong>：采用 <strong>LRU</strong> 算法，见 <a href="/blog/vue/vue/vue-diff.html#问题">KeepAlive 原理 - 问题Q2</a></li></ul> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> ref<span class="token punctuation">,</span> shallowReactive<span class="token punctuation">,</span> createVNode<span class="token punctuation">,</span> render<span class="token punctuation">,</span> unmount<span class="token punctuation">,</span> createApp<span class="token punctuation">,</span> h<span class="token punctuation">,</span> isVNode <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'vue'</span><span class="token punctuation">;</span>

<span class="token comment">// KeepAlive 组件</span>
<span class="token keyword">const</span> KeepAlive <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token comment">// KeepAlive 组件独有的属性，用作标识</span>
  <span class="token literal-property property">__isKeepAlive</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token literal-property property">props</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">include</span><span class="token operator">:</span> <span class="token punctuation">[</span>String<span class="token punctuation">,</span> RegExp<span class="token punctuation">,</span> Array<span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token literal-property property">exclude</span><span class="token operator">:</span> <span class="token punctuation">[</span>String<span class="token punctuation">,</span> RegExp<span class="token punctuation">,</span> Array<span class="token punctuation">]</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function">setup</span><span class="token punctuation">(</span><span class="token parameter">props<span class="token punctuation">,</span> <span class="token punctuation">{</span> slots <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 创建一个缓存对象，用于存储组件的虚拟节点 [vnode.type, vnode]</span>
    <span class="token keyword">const</span> cache <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 当前 KeepAlive 组件的实例</span>
    <span class="token keyword">const</span> instance <span class="token operator">=</span> <span class="token function">getCurrentInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 对于 KeepAlive 组件来说，它的实例上存在特殊的 keepAliveCtx 对象，该对象由渲染器注入</span>
    <span class="token comment">// 该对象会暴露渲染器的一些内部方法，其中 move 函数用来将一段 DOM 移动到另一个容器中</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> move<span class="token punctuation">,</span> createElement <span class="token punctuation">}</span> <span class="token operator">=</span> instance<span class="token punctuation">.</span>keepAliveCtx<span class="token punctuation">;</span>

    <span class="token comment">// 创建隐藏容器，用于存储缓存的组件</span>
    <span class="token keyword">const</span> storageContainer <span class="token operator">=</span> <span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// KeepAlive 组件的实例上会被添加两个内部函数，分别是 _deActivate 和 _activate</span>
    <span class="token comment">// 这两个函数会在渲染器中被调用</span>
    instance<span class="token punctuation">.</span><span class="token function-variable function">_deActivate</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">vnode</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token comment">// 将组件从当前位置移动到隐藏容器中</span>
      <span class="token function">move</span><span class="token punctuation">(</span>vnode<span class="token punctuation">,</span> storageContainer<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    instance<span class="token punctuation">.</span><span class="token function-variable function">_activate</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">vnode<span class="token punctuation">,</span> container<span class="token punctuation">,</span> anchor</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token comment">// 将组件从隐藏容器中移动到目标容器中</span>
      <span class="token function">move</span><span class="token punctuation">(</span>vnode<span class="token punctuation">,</span> container<span class="token punctuation">,</span> anchor<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token comment">// KeepAlive 的默认插槽就是要被 KeepAlive 的组件</span>
      <span class="token keyword">let</span> rawVNode <span class="token operator">=</span> slots<span class="token punctuation">.</span>default <span class="token operator">?</span> slots<span class="token punctuation">.</span><span class="token function">default</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

      <span class="token comment">// 如果不是组件，直接渲染即可，因为非组件的虚拟节点无法被 KeepAlive</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>rawVNode <span class="token operator">||</span> <span class="token keyword">typeof</span> rawVNode<span class="token punctuation">.</span>type <span class="token operator">!==</span> <span class="token string">'object'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> rawVNode<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token comment">// 获取“内部组件”的 name</span>
      <span class="token keyword">const</span> name <span class="token operator">=</span> <span class="token function">getComponentName</span><span class="token punctuation">(</span>rawVNode<span class="token punctuation">.</span>type<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// 对 name 进行匹配</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>
        name <span class="token operator">&amp;&amp;</span>
        <span class="token punctuation">(</span>
          <span class="token comment">// 如果 name 无法被 include 匹配</span>
          <span class="token punctuation">(</span>props<span class="token punctuation">.</span>include <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">matches</span><span class="token punctuation">(</span>props<span class="token punctuation">.</span>include<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">||</span>
          <span class="token comment">// 或者被 exclude 匹配</span>
          <span class="token punctuation">(</span>props<span class="token punctuation">.</span>exclude <span class="token operator">&amp;&amp;</span> <span class="token function">matches</span><span class="token punctuation">(</span>props<span class="token punctuation">.</span>exclude<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span>
      <span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 则直接渲染“内部组件”，不对其进行后续的缓存操作</span>
        <span class="token keyword">return</span> rawVNode<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token comment">// 在挂载时先获取缓存的组件 vnode</span>
      <span class="token keyword">const</span> cachedVNode <span class="token operator">=</span> cache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>rawVNode<span class="token punctuation">.</span>type<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>cachedVNode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 如果有缓存的内容，则说明不应该执行挂载，而应该执行激活</span>
        <span class="token comment">// 继承组件实例</span>
        rawVNode<span class="token punctuation">.</span>component <span class="token operator">=</span> cachedVNode<span class="token punctuation">.</span>component<span class="token punctuation">;</span>
        <span class="token comment">// 在 vnode 上添加 keptAlive 属性，标记为 true，避免渲染器重新挂载它</span>
        rawVNode<span class="token punctuation">.</span>keptAlive <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// 如果没有缓存，则将其添加到缓存中，这样下次激活组件时就不会执行新的挂载动作了</span>
        cache<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>rawVNode<span class="token punctuation">.</span>type<span class="token punctuation">,</span> rawVNode<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token comment">// 在组件 vnode 上添加 shouldKeepAlive 属性，并标记为 true，避免渲染器真的将组件卸载</span>
      rawVNode<span class="token punctuation">.</span>shouldKeepAlive <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
      <span class="token comment">// 将 KeepAlive 组件的实例也添加到 vnode 上，以便在渲染器中访问</span>
      rawVNode<span class="token punctuation">.</span>keepAliveInstance <span class="token operator">=</span> instance<span class="token punctuation">;</span>

      <span class="token comment">// 渲染组件 vnode</span>
      <span class="token keyword">return</span> rawVNode<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// 获取组件的名称</span>
<span class="token keyword">function</span> <span class="token function">getComponentName</span><span class="token punctuation">(</span><span class="token parameter">Component</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> Component<span class="token punctuation">.</span>name <span class="token operator">||</span> Component<span class="token punctuation">.</span>displayName <span class="token operator">||</span> <span class="token punctuation">(</span>Component<span class="token punctuation">.</span>__file <span class="token operator">&amp;&amp;</span> Component<span class="token punctuation">.</span>__file<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\/([^/]+)\.vue$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 匹配函数</span>
<span class="token keyword">function</span> <span class="token function">matches</span><span class="token punctuation">(</span><span class="token parameter">pattern<span class="token punctuation">,</span> name</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>pattern<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> pattern<span class="token punctuation">.</span><span class="token function">some</span><span class="token punctuation">(</span><span class="token parameter">p</span> <span class="token operator">=&gt;</span> <span class="token function">matches</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> pattern <span class="token operator">===</span> <span class="token string">'string'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> pattern<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">','</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>pattern <span class="token keyword">instanceof</span> <span class="token class-name">RegExp</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> pattern<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 获取当前组件实例</span>
<span class="token keyword">function</span> <span class="token function">getCurrentInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 这里假设有一个全局变量 currentInstance 来存储当前组件实例</span>
  <span class="token comment">// 在实际的 Vue 3 源码中，这个变量是由运行时环境提供的</span>
  <span class="token keyword">return</span> currentInstance<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 卸载操作</span>
<span class="token keyword">function</span> <span class="token function">unmount</span><span class="token punctuation">(</span><span class="token parameter">vnode</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>vnode<span class="token punctuation">.</span>type <span class="token operator">===</span> Fragment<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    vnode<span class="token punctuation">.</span>children<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">c</span> <span class="token operator">=&gt;</span> <span class="token function">unmount</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> vnode<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">'object'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// vnode.shouldKeepAlive 是一个布尔值，用来标识该组件是否应该被 KeepAlive</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>vnode<span class="token punctuation">.</span>shouldKeepAlive<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 对于需要被 KeepAlive 的组件，我们不应该真的卸载它，而应调用该组件的父组件，</span>
      <span class="token comment">// 即 KeepAlive 组件的 _deActivate 函数使其失活</span>
      vnode<span class="token punctuation">.</span>keepAliveInstance<span class="token punctuation">.</span><span class="token function">_deActivate</span><span class="token punctuation">(</span>vnode<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token function">unmount</span><span class="token punctuation">(</span>vnode<span class="token punctuation">.</span>component<span class="token punctuation">.</span>subTree<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">const</span> parent <span class="token operator">=</span> vnode<span class="token punctuation">.</span>el<span class="token punctuation">.</span>parentNode<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>parent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    parent<span class="token punctuation">.</span><span class="token function">removeChild</span><span class="token punctuation">(</span>vnode<span class="token punctuation">.</span>el<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 补丁函数</span>
<span class="token keyword">function</span> <span class="token function">patch</span><span class="token punctuation">(</span><span class="token parameter">n1<span class="token punctuation">,</span> n2<span class="token punctuation">,</span> container<span class="token punctuation">,</span> anchor</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>n1 <span class="token operator">&amp;&amp;</span> n1<span class="token punctuation">.</span>type <span class="token operator">!==</span> n2<span class="token punctuation">.</span>type<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">unmount</span><span class="token punctuation">(</span>n1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    n1 <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">const</span> <span class="token punctuation">{</span> type <span class="token punctuation">}</span> <span class="token operator">=</span> n2<span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> type <span class="token operator">===</span> <span class="token string">'string'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 省略部分代码</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">===</span> Text<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 省略部分代码</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">===</span> Fragment<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 省略部分代码</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> type <span class="token operator">===</span> <span class="token string">'object'</span> <span class="token operator">||</span> <span class="token keyword">typeof</span> type <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// component</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>n1<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 如果该组件已经被 KeepAlive，则不会重新挂载它，而是会调用 _activate 来激活它</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>n2<span class="token punctuation">.</span>keptAlive<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        n2<span class="token punctuation">.</span>keepAliveInstance<span class="token punctuation">.</span><span class="token function">_activate</span><span class="token punctuation">(</span>n2<span class="token punctuation">,</span> container<span class="token punctuation">,</span> anchor<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token function">mountComponent</span><span class="token punctuation">(</span>n2<span class="token punctuation">,</span> container<span class="token punctuation">,</span> anchor<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token function">patchComponent</span><span class="token punctuation">(</span>n1<span class="token punctuation">,</span> n2<span class="token punctuation">,</span> anchor<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 挂载组件</span>
<span class="token keyword">function</span> <span class="token function">mountComponent</span><span class="token punctuation">(</span><span class="token parameter">vnode<span class="token punctuation">,</span> container<span class="token punctuation">,</span> anchor</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> instance <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">state</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token literal-property property">props</span><span class="token operator">:</span> <span class="token function">shallowReactive</span><span class="token punctuation">(</span>vnode<span class="token punctuation">.</span>props <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token literal-property property">isMounted</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    <span class="token literal-property property">subTree</span><span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    <span class="token literal-property property">slots</span><span class="token operator">:</span> vnode<span class="token punctuation">.</span>children<span class="token punctuation">,</span>
    <span class="token literal-property property">mounted</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token comment">// 只有 KeepAlive 组件的实例下会有 keepAliveCtx 属性</span>
    <span class="token literal-property property">keepAliveCtx</span><span class="token operator">:</span> <span class="token keyword">null</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">// 检查当前要挂载的组件是否是 KeepAlive 组件</span>
  <span class="token keyword">const</span> isKeepAlive <span class="token operator">=</span> vnode<span class="token punctuation">.</span>type<span class="token punctuation">.</span>__isKeepAlive<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>isKeepAlive<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 在 KeepAlive 组件实例上添加 keepAliveCtx 对象</span>
    instance<span class="token punctuation">.</span>keepAliveCtx <span class="token operator">=</span> <span class="token punctuation">{</span>
      <span class="token comment">// move 函数用来移动一段 vnode</span>
      <span class="token function">move</span><span class="token punctuation">(</span><span class="token parameter">vnode<span class="token punctuation">,</span> container<span class="token punctuation">,</span> anchor</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 本质上是将组件渲染的内容移动到指定容器中，即隐藏容器中</span>
        <span class="token function">insert</span><span class="token punctuation">(</span>vnode<span class="token punctuation">.</span>component<span class="token punctuation">.</span>subTree<span class="token punctuation">.</span>el<span class="token punctuation">,</span> container<span class="token punctuation">,</span> anchor<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      createElement
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 调用组件的 setup 函数</span>
  <span class="token keyword">const</span> setupResult <span class="token operator">=</span> vnode<span class="token punctuation">.</span>type<span class="token punctuation">.</span>setup <span class="token operator">?</span> vnode<span class="token punctuation">.</span>type<span class="token punctuation">.</span><span class="token function">setup</span><span class="token punctuation">(</span>vnode<span class="token punctuation">.</span>props<span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">slots</span><span class="token operator">:</span> vnode<span class="token punctuation">.</span>children <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

  <span class="token comment">// 如果 setup 返回的是一个渲染函数或 VNode，则直接使用</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> setupResult <span class="token operator">===</span> <span class="token string">'function'</span> <span class="token operator">||</span> <span class="token function">isVNode</span><span class="token punctuation">(</span>setupResult<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    instance<span class="token punctuation">.</span>subTree <span class="token operator">=</span> <span class="token function">createVNode</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">render</span><span class="token punctuation">(</span>instance<span class="token punctuation">.</span>subTree<span class="token punctuation">,</span> container<span class="token punctuation">,</span> anchor<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> setupResult <span class="token operator">===</span> <span class="token string">'object'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 如果 setup 返回的是一个对象，则将其作为组件的上下文</span>
    instance<span class="token punctuation">.</span>ctx <span class="token operator">=</span> setupResult<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 标记组件已挂载</span>
  instance<span class="token punctuation">.</span>isMounted <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br><span class="line-number">156</span><br><span class="line-number">157</span><br><span class="line-number">158</span><br><span class="line-number">159</span><br><span class="line-number">160</span><br><span class="line-number">161</span><br><span class="line-number">162</span><br><span class="line-number">163</span><br><span class="line-number">164</span><br><span class="line-number">165</span><br><span class="line-number">166</span><br><span class="line-number">167</span><br><span class="line-number">168</span><br><span class="line-number">169</span><br><span class="line-number">170</span><br><span class="line-number">171</span><br><span class="line-number">172</span><br><span class="line-number">173</span><br><span class="line-number">174</span><br><span class="line-number">175</span><br><span class="line-number">176</span><br><span class="line-number">177</span><br><span class="line-number">178</span><br><span class="line-number">179</span><br><span class="line-number">180</span><br><span class="line-number">181</span><br><span class="line-number">182</span><br><span class="line-number">183</span><br><span class="line-number">184</span><br><span class="line-number">185</span><br><span class="line-number">186</span><br><span class="line-number">187</span><br><span class="line-number">188</span><br><span class="line-number">189</span><br><span class="line-number">190</span><br><span class="line-number">191</span><br><span class="line-number">192</span><br><span class="line-number">193</span><br><span class="line-number">194</span><br><span class="line-number">195</span><br><span class="line-number">196</span><br><span class="line-number">197</span><br><span class="line-number">198</span><br><span class="line-number">199</span><br><span class="line-number">200</span><br><span class="line-number">201</span><br><span class="line-number">202</span><br><span class="line-number">203</span><br><span class="line-number">204</span><br><span class="line-number">205</span><br></div></div><h2 id="teleport"><a href="#teleport" class="header-anchor">#</a> Teleport</h2> <p><code>&lt;Teleport&gt;</code> 是一个内置组件，它可以将一个组件内部的一部分模板“传送”到该组件的 DOM 结构外层的位置去。常用于 <code>&lt;Teleport&gt;</code> 和 <code>&lt;Transition&gt;</code> 结合使用来创建一个带动画的模态框。</p> <p>痛点：一个组件模板的一部分在逻辑上从属于该组件，但从整个应用视图的角度来看，它在 DOM 中应该被渲染在整个 Vue 应用外部的其他地方。这类场景最常见的例子就是全屏的模态框。理想情况下，我们希望触发模态框的按钮和模态框本身是在同一个组件中，因为它们都与组件的开关状态有关。但这意味着该模态框将与按钮一起渲染在应用 DOM 结构里很深的地方。这会导致该模态框的 CSS 布局代码很难写。这种 “蒙层” 优先级的问题在 Vue.js 2 中我们只能通过原生 DOM API 来手动搬运 DOM 元素实现需求。这么做的缺点在于，手动操作 DOM 元素会使得元素的渲染与 Vue.js 的渲染机制脱节，并导致各种可预见或不可预见的问题。</p> <h3 id="接口定义-3"><a href="#接口定义-3" class="header-anchor">#</a> 接口定义</h3> <p>将其插槽内容渲染到 DOM 中的另一个位置。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">interface</span> <span class="token class-name">TeleportProps</span> <span class="token punctuation">{</span>
  <span class="token comment">/**
   * 必填项。指定目标容器。
   * 可以是选择器或实际元素。
   */</span>
  <span class="token literal-property property">to</span><span class="token operator">:</span> string <span class="token operator">|</span> HTMLElement
  <span class="token comment">/**
   * 当值为 `true` 时，内容将保留在其原始位置
   * 而不是移动到目标容器中。
   * 可以动态更改。
   */</span>
  disabled<span class="token operator">?</span><span class="token operator">:</span> boolean
  <span class="token comment">/**
   * 当值为 `true` 时，Teleport 将推迟
   * 直到应用的其他部分挂载后
   * 再解析其目标。(3.5+)
   */</span>
  defer<span class="token operator">?</span><span class="token operator">:</span> boolean
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><h3 id="设计实现-3"><a href="#设计实现-3" class="header-anchor">#</a> 设计实现</h3> <p>首先我们要将 Teleport 组件的渲染逻辑从渲染器中分离出来，这么做有两点好处：</p> <ul><li>可以避免渲染器逻辑代码“膨胀”​；</li> <li>当用户没有使用 Teleport 组件时，由于 Teleport 的渲染逻辑被分离，因此可以利用 TreeShaking 机制在最终的 bundle 中删除 Teleport 相关的代码，使得最终构建包的体积变小。</li></ul> <p><strong>实现了渲染逻辑分离</strong>：<code>_isTeleport</code> 标识来判断该组件是否是 <code>Teleport</code> 组件。如果是，则直接调用组件选项中定义的 <code>process</code> 函数将渲染控制权完全交接出去，这样就实现了渲染逻辑的分离。
<strong>组件挂载</strong>：即使 Teleport 渲染逻辑被单独分离出来，它的渲染思路仍然与渲染器本身的渲染思路保持一致。通过判断旧的虚拟节点（n1）是否存在，来决定是执行挂载还是执行更新。如果要执行挂载，则需要根据 <code>props.to</code> 属性的值来取得真正的挂载点。最后，遍历 Teleport 组件的 <code>children</code> 属性，并逐一调用 <code>patch</code> 函数完成子节点的挂载。
<strong>组件更新</strong>：只需要调用 <code>patchChildren</code> 函数完成更新操作即可。不过有一点需要额外注意，更新操作可能是由于 Teleport 组件的 to 属性值的变化引起的，因此，在更新时我们应该考虑组件的类型并通过 <code>move</code> 移动节点。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> Teleport <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">__isTeleport</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// 标识该组件为 Teleport 组件</span>
  <span class="token function">process</span><span class="token punctuation">(</span><span class="token parameter">n1<span class="token punctuation">,</span> n2<span class="token punctuation">,</span> container<span class="token punctuation">,</span> anchor<span class="token punctuation">,</span> internals</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 参数解释：</span>
    <span class="token comment">// n1: 旧的 VNode，如果存在则表示这是一个更新操作</span>
    <span class="token comment">// n2: 新的 VNode，表示当前要处理的 VNode</span>
    <span class="token comment">// container: 当前组件的容器，即父组件的挂载点</span>
    <span class="token comment">// anchor: 挂载点的锚点，用于确定子节点在容器中的位置</span>
    <span class="token comment">// internals: 渲染器的内部方法，包括 patch、move 等</span>

    <span class="token comment">// 通过 internals 参数取得渲染器的内部方法</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> patch<span class="token punctuation">,</span> move <span class="token punctuation">}</span> <span class="token operator">=</span> internals<span class="token punctuation">;</span>

    <span class="token comment">// 如果旧 VNode n1 不存在，则是全新的挂载，否则执行更新</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>n1<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 挂载</span>
      <span class="token comment">// 获取容器，即挂载点</span>
      <span class="token keyword">const</span> target <span class="token operator">=</span> <span class="token keyword">typeof</span> n2<span class="token punctuation">.</span>props<span class="token punctuation">.</span>to <span class="token operator">===</span> <span class="token string">'string'</span>
        <span class="token operator">?</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span>n2<span class="token punctuation">.</span>props<span class="token punctuation">.</span>to<span class="token punctuation">)</span> <span class="token comment">// 如果 to 是字符串，使用 querySelector 获取 DOM 元素</span>
        <span class="token operator">:</span> n2<span class="token punctuation">.</span>props<span class="token punctuation">.</span>to<span class="token punctuation">;</span> <span class="token comment">// 如果 to 是 DOM 元素，直接使用</span>

      <span class="token comment">// 将 n2.children 渲染到指定挂载点</span>
      n2<span class="token punctuation">.</span>children<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">c</span> <span class="token operator">=&gt;</span> <span class="token function">patch</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> c<span class="token punctuation">,</span> target<span class="token punctuation">,</span> anchor<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 逐个子节点进行挂载</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// 更新</span>
      <span class="token comment">// 获取新旧挂载点</span>
      <span class="token keyword">const</span> prevTarget <span class="token operator">=</span> n1<span class="token punctuation">.</span>target<span class="token punctuation">;</span> <span class="token comment">// 旧挂载点</span>
      <span class="token keyword">const</span> newTarget <span class="token operator">=</span> <span class="token keyword">typeof</span> n2<span class="token punctuation">.</span>props<span class="token punctuation">.</span>to <span class="token operator">===</span> <span class="token string">'string'</span>
        <span class="token operator">?</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span>n2<span class="token punctuation">.</span>props<span class="token punctuation">.</span>to<span class="token punctuation">)</span> <span class="token comment">// 新挂载点</span>
        <span class="token operator">:</span> n2<span class="token punctuation">.</span>props<span class="token punctuation">.</span>to<span class="token punctuation">;</span>

      <span class="token comment">// 如果新旧挂载点不同，则需要移动子节点</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>prevTarget <span class="token operator">!==</span> newTarget<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 移动子节点到新的挂载点</span>
        n2<span class="token punctuation">.</span>children<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">c</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token comment">// 移动每个子节点</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>c<span class="token punctuation">.</span>component<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 如果子节点是组件，移动其子树的根元素</span>
            <span class="token function">move</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>component<span class="token punctuation">.</span>subTree<span class="token punctuation">,</span> newTarget<span class="token punctuation">,</span> anchor<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment">// 如果子节点是普通元素，直接移动</span>
            <span class="token function">move</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> newTarget<span class="token punctuation">,</span> anchor<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token comment">// 更新子节点</span>
      n2<span class="token punctuation">.</span>children<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">c</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token function">patch</span><span class="token punctuation">(</span>n1<span class="token punctuation">.</span>children<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token parameter">n</span> <span class="token operator">=&gt;</span> n<span class="token punctuation">.</span>key <span class="token operator">===</span> c<span class="token punctuation">.</span>key<span class="token punctuation">)</span><span class="token punctuation">,</span> c<span class="token punctuation">,</span> newTarget<span class="token punctuation">,</span> anchor<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 逐个子节点进行更新</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 将新的挂载点保存到 VNode 上，以便在卸载时使用</span>
    n2<span class="token punctuation">.</span>target <span class="token operator">=</span> newTarget<span class="token punctuation">;</span>
    n2<span class="token punctuation">.</span>targetAnchor <span class="token operator">=</span> anchor<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br></div></div><p>Teleport 本质上是渲染器逻辑的合理抽象，它完全可以作为渲染器的一部分而存在。</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/blog/vue/vue3/components.html" class="prev">
        组件化原理
      </a></span> <span class="next"><a href="/blog/vue/vue3/compiler.html">
        模板编译与优化
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----><!----><!----><!----></div></div>
    <script src="/blog/assets/js/app.d7ed97c7.js" defer></script><script src="/blog/assets/js/2.dec2e75d.js" defer></script><script src="/blog/assets/js/1.5b9e135c.js" defer></script><script src="/blog/assets/js/195.7abe4d78.js" defer></script><script src="/blog/assets/js/20.badbb211.js" defer></script>
  </body>
</html>
