<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>VueRouter-V4 原理 | 前端那些事儿</title>
    <meta name="generator" content="VuePress 1.9.10">
    <link rel="icon" href="/blog/logo.png">
    <link rel="manifest" href="/blog/manifest.json">
    <link rel="apple-touch-icon" href="/blog/images/icons/apple-icon-152x152.png">
    <meta name="description" content="我命由我不由天，学习吧少年">
    <meta name="theme-color" content="#3eaf7c">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="msapplication-TileImage" content="/icons/ms-icon-144x144.png">
    <meta name="msapplication-TileColor" content="#000000">
    
    <link rel="preload" href="/blog/assets/css/0.styles.f0017422.css" as="style"><link rel="preload" href="/blog/assets/js/app.5c0d645f.js" as="script"><link rel="preload" href="/blog/assets/js/2.dec2e75d.js" as="script"><link rel="preload" href="/blog/assets/js/1.5b9e135c.js" as="script"><link rel="preload" href="/blog/assets/js/199.7078abc5.js" as="script"><link rel="preload" href="/blog/assets/js/20.badbb211.js" as="script"><link rel="prefetch" href="/blog/assets/js/10.cc7e09f3.js"><link rel="prefetch" href="/blog/assets/js/100.dabe221b.js"><link rel="prefetch" href="/blog/assets/js/101.1d5ba7da.js"><link rel="prefetch" href="/blog/assets/js/102.5b35a802.js"><link rel="prefetch" href="/blog/assets/js/103.f2e1cfb2.js"><link rel="prefetch" href="/blog/assets/js/104.717a1120.js"><link rel="prefetch" href="/blog/assets/js/105.ef8ecd83.js"><link rel="prefetch" href="/blog/assets/js/106.50c36972.js"><link rel="prefetch" href="/blog/assets/js/107.2497012e.js"><link rel="prefetch" href="/blog/assets/js/108.483bd993.js"><link rel="prefetch" href="/blog/assets/js/109.faf3aefa.js"><link rel="prefetch" href="/blog/assets/js/11.b60c9933.js"><link rel="prefetch" href="/blog/assets/js/110.afdc922e.js"><link rel="prefetch" href="/blog/assets/js/111.b3b30630.js"><link rel="prefetch" href="/blog/assets/js/112.177f2e74.js"><link rel="prefetch" href="/blog/assets/js/113.b934908a.js"><link rel="prefetch" href="/blog/assets/js/114.6cff1ef3.js"><link rel="prefetch" href="/blog/assets/js/115.615df4ef.js"><link rel="prefetch" href="/blog/assets/js/116.acc1996c.js"><link rel="prefetch" href="/blog/assets/js/117.cbe35c59.js"><link rel="prefetch" href="/blog/assets/js/118.2e646bd5.js"><link rel="prefetch" href="/blog/assets/js/119.79ff9ce3.js"><link rel="prefetch" href="/blog/assets/js/12.c53283e7.js"><link rel="prefetch" href="/blog/assets/js/120.97f3f4e6.js"><link rel="prefetch" href="/blog/assets/js/121.d1c9cee4.js"><link rel="prefetch" href="/blog/assets/js/122.813f1055.js"><link rel="prefetch" href="/blog/assets/js/123.83cce4d2.js"><link rel="prefetch" href="/blog/assets/js/124.d2e31263.js"><link rel="prefetch" href="/blog/assets/js/125.e4d752ad.js"><link rel="prefetch" href="/blog/assets/js/126.4e317378.js"><link rel="prefetch" href="/blog/assets/js/127.7aa5abcb.js"><link rel="prefetch" href="/blog/assets/js/128.0d0449cb.js"><link rel="prefetch" href="/blog/assets/js/129.541876d1.js"><link rel="prefetch" href="/blog/assets/js/13.6bdc6b5d.js"><link rel="prefetch" href="/blog/assets/js/130.b50c1756.js"><link rel="prefetch" href="/blog/assets/js/131.14890a2b.js"><link rel="prefetch" href="/blog/assets/js/132.dd38cfb4.js"><link rel="prefetch" href="/blog/assets/js/133.c236699b.js"><link rel="prefetch" href="/blog/assets/js/134.ab2058c9.js"><link rel="prefetch" href="/blog/assets/js/135.20626c27.js"><link rel="prefetch" href="/blog/assets/js/136.66c83721.js"><link rel="prefetch" href="/blog/assets/js/137.7dd15ccf.js"><link rel="prefetch" href="/blog/assets/js/138.6464ecf9.js"><link rel="prefetch" href="/blog/assets/js/139.7fa8e1f4.js"><link rel="prefetch" href="/blog/assets/js/14.c3201a23.js"><link rel="prefetch" href="/blog/assets/js/140.149ebe7f.js"><link rel="prefetch" href="/blog/assets/js/141.b9067bc8.js"><link rel="prefetch" href="/blog/assets/js/142.34e129c4.js"><link rel="prefetch" href="/blog/assets/js/143.9dbd485f.js"><link rel="prefetch" href="/blog/assets/js/144.7f90ff6d.js"><link rel="prefetch" href="/blog/assets/js/145.4b761da4.js"><link rel="prefetch" href="/blog/assets/js/146.213c5d0e.js"><link rel="prefetch" href="/blog/assets/js/147.be23ddb3.js"><link rel="prefetch" href="/blog/assets/js/148.c161cdfc.js"><link rel="prefetch" href="/blog/assets/js/149.ce1a47f4.js"><link rel="prefetch" href="/blog/assets/js/15.a0b9e44e.js"><link rel="prefetch" href="/blog/assets/js/150.c8304db0.js"><link rel="prefetch" href="/blog/assets/js/151.4694bde0.js"><link rel="prefetch" href="/blog/assets/js/152.fb05e213.js"><link rel="prefetch" href="/blog/assets/js/153.70a6fd63.js"><link rel="prefetch" href="/blog/assets/js/154.6a1f9d84.js"><link rel="prefetch" href="/blog/assets/js/155.779fbb83.js"><link rel="prefetch" href="/blog/assets/js/156.eb193c60.js"><link rel="prefetch" href="/blog/assets/js/157.e052eb9d.js"><link rel="prefetch" href="/blog/assets/js/158.87c66efe.js"><link rel="prefetch" href="/blog/assets/js/159.bfac6e97.js"><link rel="prefetch" href="/blog/assets/js/16.491191e4.js"><link rel="prefetch" href="/blog/assets/js/160.1c265a50.js"><link rel="prefetch" href="/blog/assets/js/161.9c8db632.js"><link rel="prefetch" href="/blog/assets/js/162.08656fce.js"><link rel="prefetch" href="/blog/assets/js/163.7ba9ed88.js"><link rel="prefetch" href="/blog/assets/js/164.dc9436f9.js"><link rel="prefetch" href="/blog/assets/js/165.5a379c90.js"><link rel="prefetch" href="/blog/assets/js/166.e508130a.js"><link rel="prefetch" href="/blog/assets/js/167.3463c2ed.js"><link rel="prefetch" href="/blog/assets/js/168.196a44b6.js"><link rel="prefetch" href="/blog/assets/js/169.bf573f56.js"><link rel="prefetch" href="/blog/assets/js/17.89ec8c57.js"><link rel="prefetch" href="/blog/assets/js/170.8825cf2f.js"><link rel="prefetch" href="/blog/assets/js/171.e37cef45.js"><link rel="prefetch" href="/blog/assets/js/172.101ab258.js"><link rel="prefetch" href="/blog/assets/js/173.52f54b75.js"><link rel="prefetch" href="/blog/assets/js/174.d9e8f9f7.js"><link rel="prefetch" href="/blog/assets/js/175.58bd1d44.js"><link rel="prefetch" href="/blog/assets/js/176.01658475.js"><link rel="prefetch" href="/blog/assets/js/177.d84d06e6.js"><link rel="prefetch" href="/blog/assets/js/178.c187efc7.js"><link rel="prefetch" href="/blog/assets/js/179.0e617fe3.js"><link rel="prefetch" href="/blog/assets/js/18.b91f1411.js"><link rel="prefetch" href="/blog/assets/js/180.461b359e.js"><link rel="prefetch" href="/blog/assets/js/181.f6a32104.js"><link rel="prefetch" href="/blog/assets/js/182.16dc1844.js"><link rel="prefetch" href="/blog/assets/js/183.f336285a.js"><link rel="prefetch" href="/blog/assets/js/184.0c197702.js"><link rel="prefetch" href="/blog/assets/js/185.a08d3259.js"><link rel="prefetch" href="/blog/assets/js/186.9256478c.js"><link rel="prefetch" href="/blog/assets/js/187.8e78996f.js"><link rel="prefetch" href="/blog/assets/js/188.86d55068.js"><link rel="prefetch" href="/blog/assets/js/189.243f4482.js"><link rel="prefetch" href="/blog/assets/js/19.cb1f17c8.js"><link rel="prefetch" href="/blog/assets/js/190.0515855c.js"><link rel="prefetch" href="/blog/assets/js/191.5a45d0dd.js"><link rel="prefetch" href="/blog/assets/js/192.b73519d3.js"><link rel="prefetch" href="/blog/assets/js/193.ab975c7d.js"><link rel="prefetch" href="/blog/assets/js/194.d17a7216.js"><link rel="prefetch" href="/blog/assets/js/195.4ef22e15.js"><link rel="prefetch" href="/blog/assets/js/196.d02c94c7.js"><link rel="prefetch" href="/blog/assets/js/197.1c8c2216.js"><link rel="prefetch" href="/blog/assets/js/198.3ad3a1c9.js"><link rel="prefetch" href="/blog/assets/js/200.5c86734c.js"><link rel="prefetch" href="/blog/assets/js/201.cc24eacb.js"><link rel="prefetch" href="/blog/assets/js/202.95ea7e05.js"><link rel="prefetch" href="/blog/assets/js/203.dc92157f.js"><link rel="prefetch" href="/blog/assets/js/204.8d2381f4.js"><link rel="prefetch" href="/blog/assets/js/205.062fc0fa.js"><link rel="prefetch" href="/blog/assets/js/206.f08174cd.js"><link rel="prefetch" href="/blog/assets/js/207.500b316a.js"><link rel="prefetch" href="/blog/assets/js/208.8a3a45ed.js"><link rel="prefetch" href="/blog/assets/js/209.099f2e3e.js"><link rel="prefetch" href="/blog/assets/js/21.bf0041b7.js"><link rel="prefetch" href="/blog/assets/js/210.f1c95bdf.js"><link rel="prefetch" href="/blog/assets/js/211.0ce80fe5.js"><link rel="prefetch" href="/blog/assets/js/212.9bf0e4e5.js"><link rel="prefetch" href="/blog/assets/js/213.a296a4b4.js"><link rel="prefetch" href="/blog/assets/js/214.47d7b502.js"><link rel="prefetch" href="/blog/assets/js/215.2d17a758.js"><link rel="prefetch" href="/blog/assets/js/216.28a77bde.js"><link rel="prefetch" href="/blog/assets/js/217.bce2a65f.js"><link rel="prefetch" href="/blog/assets/js/218.09fcb7a5.js"><link rel="prefetch" href="/blog/assets/js/219.afad10dd.js"><link rel="prefetch" href="/blog/assets/js/22.48390d4f.js"><link rel="prefetch" href="/blog/assets/js/220.ebc569c6.js"><link rel="prefetch" href="/blog/assets/js/221.6a2478b4.js"><link rel="prefetch" href="/blog/assets/js/222.0c7fe13e.js"><link rel="prefetch" href="/blog/assets/js/223.5afa3b79.js"><link rel="prefetch" href="/blog/assets/js/224.51e80330.js"><link rel="prefetch" href="/blog/assets/js/225.09d0c412.js"><link rel="prefetch" href="/blog/assets/js/226.3043cac7.js"><link rel="prefetch" href="/blog/assets/js/227.4e115357.js"><link rel="prefetch" href="/blog/assets/js/23.35c4ba93.js"><link rel="prefetch" href="/blog/assets/js/24.cc3b12df.js"><link rel="prefetch" href="/blog/assets/js/25.94c095ac.js"><link rel="prefetch" href="/blog/assets/js/26.dc0735bf.js"><link rel="prefetch" href="/blog/assets/js/27.bf58c149.js"><link rel="prefetch" href="/blog/assets/js/28.3cdce864.js"><link rel="prefetch" href="/blog/assets/js/29.6c1aebe8.js"><link rel="prefetch" href="/blog/assets/js/3.cb0627fa.js"><link rel="prefetch" href="/blog/assets/js/30.c5bb1b3d.js"><link rel="prefetch" href="/blog/assets/js/31.d9754d97.js"><link rel="prefetch" href="/blog/assets/js/32.bbc6bc42.js"><link rel="prefetch" href="/blog/assets/js/33.d4bb78a0.js"><link rel="prefetch" href="/blog/assets/js/34.66a4b69e.js"><link rel="prefetch" href="/blog/assets/js/35.c25c83f1.js"><link rel="prefetch" href="/blog/assets/js/36.9eaca2ee.js"><link rel="prefetch" href="/blog/assets/js/37.ff149f3c.js"><link rel="prefetch" href="/blog/assets/js/38.a3fb5426.js"><link rel="prefetch" href="/blog/assets/js/39.d5748ea8.js"><link rel="prefetch" href="/blog/assets/js/4.cbb57fa7.js"><link rel="prefetch" href="/blog/assets/js/40.c821fa3c.js"><link rel="prefetch" href="/blog/assets/js/41.72d168e7.js"><link rel="prefetch" href="/blog/assets/js/42.2c94b2fa.js"><link rel="prefetch" href="/blog/assets/js/43.8cfa3228.js"><link rel="prefetch" href="/blog/assets/js/44.f09abcfc.js"><link rel="prefetch" href="/blog/assets/js/45.f87383bf.js"><link rel="prefetch" href="/blog/assets/js/46.3522c1e1.js"><link rel="prefetch" href="/blog/assets/js/47.a2a63e22.js"><link rel="prefetch" href="/blog/assets/js/48.1a27d0ca.js"><link rel="prefetch" href="/blog/assets/js/49.da2e1be3.js"><link rel="prefetch" href="/blog/assets/js/5.fe065607.js"><link rel="prefetch" href="/blog/assets/js/50.64b6e6f6.js"><link rel="prefetch" href="/blog/assets/js/51.44d3299d.js"><link rel="prefetch" href="/blog/assets/js/52.f44c992f.js"><link rel="prefetch" href="/blog/assets/js/53.50675a1d.js"><link rel="prefetch" href="/blog/assets/js/54.f719facc.js"><link rel="prefetch" href="/blog/assets/js/55.b2101926.js"><link rel="prefetch" href="/blog/assets/js/56.e7ca6c14.js"><link rel="prefetch" href="/blog/assets/js/57.5a322bd3.js"><link rel="prefetch" href="/blog/assets/js/58.4492060e.js"><link rel="prefetch" href="/blog/assets/js/59.9239674f.js"><link rel="prefetch" href="/blog/assets/js/6.68cda050.js"><link rel="prefetch" href="/blog/assets/js/60.508d6f1d.js"><link rel="prefetch" href="/blog/assets/js/61.30eca23b.js"><link rel="prefetch" href="/blog/assets/js/62.c8cd84fa.js"><link rel="prefetch" href="/blog/assets/js/63.fc63838e.js"><link rel="prefetch" href="/blog/assets/js/64.77da6ad5.js"><link rel="prefetch" href="/blog/assets/js/65.8e353ed2.js"><link rel="prefetch" href="/blog/assets/js/66.281a5ac4.js"><link rel="prefetch" href="/blog/assets/js/67.6eeb5ab6.js"><link rel="prefetch" href="/blog/assets/js/68.34d9ae87.js"><link rel="prefetch" href="/blog/assets/js/69.aa119714.js"><link rel="prefetch" href="/blog/assets/js/7.3b8d63a0.js"><link rel="prefetch" href="/blog/assets/js/70.550cd861.js"><link rel="prefetch" href="/blog/assets/js/71.6dbd81eb.js"><link rel="prefetch" href="/blog/assets/js/72.6396e72f.js"><link rel="prefetch" href="/blog/assets/js/73.49e2280e.js"><link rel="prefetch" href="/blog/assets/js/74.2aeff695.js"><link rel="prefetch" href="/blog/assets/js/75.f6cf2df8.js"><link rel="prefetch" href="/blog/assets/js/76.4e2a8355.js"><link rel="prefetch" href="/blog/assets/js/77.daaae178.js"><link rel="prefetch" href="/blog/assets/js/78.cfe556c5.js"><link rel="prefetch" href="/blog/assets/js/79.ddf7c94e.js"><link rel="prefetch" href="/blog/assets/js/80.09f7a474.js"><link rel="prefetch" href="/blog/assets/js/81.712bd61b.js"><link rel="prefetch" href="/blog/assets/js/82.7abf5bc4.js"><link rel="prefetch" href="/blog/assets/js/83.81e8cf55.js"><link rel="prefetch" href="/blog/assets/js/84.2577ee3b.js"><link rel="prefetch" href="/blog/assets/js/85.669410bb.js"><link rel="prefetch" href="/blog/assets/js/86.1194b077.js"><link rel="prefetch" href="/blog/assets/js/87.3b6e5595.js"><link rel="prefetch" href="/blog/assets/js/88.8b840ce1.js"><link rel="prefetch" href="/blog/assets/js/89.fb1f77e4.js"><link rel="prefetch" href="/blog/assets/js/90.e0feae73.js"><link rel="prefetch" href="/blog/assets/js/91.1aa48754.js"><link rel="prefetch" href="/blog/assets/js/92.fede14d8.js"><link rel="prefetch" href="/blog/assets/js/93.3f378b31.js"><link rel="prefetch" href="/blog/assets/js/94.d9208461.js"><link rel="prefetch" href="/blog/assets/js/95.0f530084.js"><link rel="prefetch" href="/blog/assets/js/96.2a1bbb0f.js"><link rel="prefetch" href="/blog/assets/js/97.2301b9cf.js"><link rel="prefetch" href="/blog/assets/js/98.9d5643ce.js"><link rel="prefetch" href="/blog/assets/js/99.4445c278.js"><link rel="prefetch" href="/blog/assets/js/vendors~docsearch.bd3cdb54.js">
    <link rel="stylesheet" href="/blog/assets/css/0.styles.f0017422.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/blog/" class="home-link router-link-active"><img src="/blog/logo.png" alt="前端那些事儿" class="logo"> <span class="site-name can-hide">前端那些事儿</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/blog/" class="nav-link">
  主页
</a></div><div class="nav-item"><a href="/blog/base/" class="nav-link">
  前端基础
</a></div><div class="nav-item"><a href="/blog/vue/" class="nav-link router-link-active">
  Vue
</a></div><div class="nav-item"><a href="/blog/react/" class="nav-link">
  React
</a></div><div class="nav-item"><a href="/blog/devops/" class="nav-link">
  前端工程化
</a></div><div class="nav-item"><a href="/blog/mobile/" class="nav-link">
  泛客户端
</a></div><div class="nav-item"><a href="/blog/architecture/" class="nav-link">
  架构与方案
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="GitHub" class="dropdown-title"><span class="title">GitHub</span> <span class="arrow down"></span></button> <button type="button" aria-label="GitHub" class="mobile-dropdown-title"><span class="title">GitHub</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/jonny-wei" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://github.com/jonny-wei/sushi-js" target="_blank" rel="noopener noreferrer" class="nav-link external">
  JS 寿司
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/blog/" class="nav-link">
  主页
</a></div><div class="nav-item"><a href="/blog/base/" class="nav-link">
  前端基础
</a></div><div class="nav-item"><a href="/blog/vue/" class="nav-link router-link-active">
  Vue
</a></div><div class="nav-item"><a href="/blog/react/" class="nav-link">
  React
</a></div><div class="nav-item"><a href="/blog/devops/" class="nav-link">
  前端工程化
</a></div><div class="nav-item"><a href="/blog/mobile/" class="nav-link">
  泛客户端
</a></div><div class="nav-item"><a href="/blog/architecture/" class="nav-link">
  架构与方案
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="GitHub" class="dropdown-title"><span class="title">GitHub</span> <span class="arrow down"></span></button> <button type="button" aria-label="GitHub" class="mobile-dropdown-title"><span class="title">GitHub</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/jonny-wei" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://github.com/jonny-wei/sushi-js" target="_blank" rel="noopener noreferrer" class="nav-link external">
  JS 寿司
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Vue</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/vue/" aria-current="page" class="sidebar-link">Vue 组件通信</a></li><li><a href="/blog/vue/warmup/vue-symbols.html" class="sidebar-link">Vue 修饰符</a></li><li><a href="/blog/vue/warmup/vue-optimization.html" class="sidebar-link">Vue 相关优化</a></li><li><a href="/blog/vue/warmup/vue-router.html" class="sidebar-link">VueRouter 核心原理</a></li><li><a href="/blog/vue/warmup/vue-vuex.html" class="sidebar-link">Vuex 实现原理</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Vue源码解析</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/vue/vue/github.html" class="sidebar-link">源码学习</a></li><li><a href="/blog/vue/vue/vue-render.html" class="sidebar-link">渲染器</a></li><li><a href="/blog/vue/vue/vue-init.html" class="sidebar-link">构建与初始化</a></li><li><a href="/blog/vue/vue/vue-component.html" class="sidebar-link">组件化过程</a></li><li><a href="/blog/vue/vue/vue-observer.html" class="sidebar-link">响应式原理</a></li><li><a href="/blog/vue/vue/vue-template.html" class="sidebar-link">模板编译与渲染</a></li><li><a href="/blog/vue/vue/vue-diff.html" class="sidebar-link">虚拟 DOM 与 Diff 算法</a></li><li><a href="/blog/vue/vue/vue-nextTick.html" class="sidebar-link">异步更新队列</a></li><li><a href="/blog/vue/vue/vue-lifecycle.html" class="sidebar-link">生命周期</a></li><li><a href="/blog/vue/vue/vue-computed.html" class="sidebar-link">计算属性与侦听器</a></li><li><a href="/blog/vue/vue/vue-slot.html" class="sidebar-link">插槽</a></li><li><a href="/blog/vue/vue/vue-directive.html" class="sidebar-link">Vue 指令</a></li><li><a href="/blog/vue/vue/vue-event.html" class="sidebar-link">事件绑定原理</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>VueRouter源码解析</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/vue/vue-router/abstract.html" class="sidebar-link">摘要</a></li><li><a href="/blog/vue/vue-router/warmUp.html" class="sidebar-link">准备工作</a></li><li><a href="/blog/vue/vue-router/plugin.html" class="sidebar-link">插件机制</a></li><li><a href="/blog/vue/vue-router/initialization.html" class="sidebar-link">初始化与降级处理</a></li><li><a href="/blog/vue/vue-router/transitions.html" class="sidebar-link">路由过渡与视图渲染</a></li><li><a href="/blog/vue/vue-router/match.html" class="sidebar-link">路由匹配</a></li><li><a href="/blog/vue/vue-router/summary.html" class="sidebar-link">总结</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Vuex源码解析</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/vue/vuex/abstract.html" class="sidebar-link">摘要</a></li><li><a href="/blog/vue/vuex/warmUp.html" class="sidebar-link">准备工作</a></li><li><a href="/blog/vue/vuex/initialization.html" class="sidebar-link">初始化与模块安装</a></li><li><a href="/blog/vue/vuex/state.html" class="sidebar-link">State 相关</a></li><li><a href="/blog/vue/vuex/getters.html" class="sidebar-link">Getters 相关</a></li><li><a href="/blog/vue/vuex/mutations.html" class="sidebar-link">Mutations 相关</a></li><li><a href="/blog/vue/vuex/actions.html" class="sidebar-link">Actions 相关</a></li><li><a href="/blog/vue/vuex/modules.html" class="sidebar-link">Modules 相关</a></li><li><a href="/blog/vue/vuex/others.html" class="sidebar-link">其他</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Vue3新特性</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/vue/vue3.x/reactivity.html" class="sidebar-link">响应式系统方面</a></li><li><a href="/blog/vue/vue3.x/features.html" class="sidebar-link">功能方面</a></li><li><a href="/blog/vue/vue3.x/performance.html" class="sidebar-link">性能方面</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>VueNext</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/vue/vue3/reactivity.html" class="sidebar-link">设计响应式系统</a></li><li><a href="/blog/vue/vue3/diff.html" class="sidebar-link">快速 Diff 算法</a></li><li><a href="/blog/vue/vue3/components.html" class="sidebar-link">组件化原理</a></li><li><a href="/blog/vue/vue3/inner-components.html" class="sidebar-link">异步与内置组件</a></li><li><a href="/blog/vue/vue3/compiler.html" class="sidebar-link">模板编译与优化</a></li><li><a href="/blog/vue/vue3/hooks.html" class="sidebar-link">Hooks</a></li><li><a href="/blog/vue/vue3/vue-router4.html" aria-current="page" class="active sidebar-link">VueRouter-V4 原理</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/vue/vue3/vue-router4.html#createrouter-入口" class="sidebar-link">createRouter 入口</a></li><li class="sidebar-sub-header"><a href="/blog/vue/vue3/vue-router4.html#路由安装" class="sidebar-link">路由安装</a></li><li class="sidebar-sub-header"><a href="/blog/vue/vue3/vue-router4.html#路由组件" class="sidebar-link">路由组件</a></li><li class="sidebar-sub-header"><a href="/blog/vue/vue3/vue-router4.html#路由更新" class="sidebar-link">路由更新</a></li><li class="sidebar-sub-header"><a href="/blog/vue/vue3/vue-router4.html#路由-hooks" class="sidebar-link">路由 Hooks</a></li></ul></li><li><a href="/blog/vue/vue3/pinia.html" class="sidebar-link">Pinia 原理</a></li><li><a href="/blog/vue/vue3/ssr.html" class="sidebar-link">Vue SSR</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="vuerouter-v4-原理"><a href="#vuerouter-v4-原理" class="header-anchor">#</a> VueRouter-V4 原理</h1> <p>客户端路由的作用是在单页应用 (SPA) 中将浏览器的 URL 和用户看到的内容绑定起来。当用户在应用中浏览不同页面时，URL 会随之更新，但页面不需要从服务器重新加载。</p> <h2 id="createrouter-入口"><a href="#createrouter-入口" class="header-anchor">#</a> createRouter 入口</h2> <p>注册路由插件</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token function">createApp</span><span class="token punctuation">(</span>App<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>router<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">mount</span><span class="token punctuation">(</span><span class="token string">'#app'</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>插件做了什么，它的职责包括：</p> <ul><li>全局注册 <code>RouterView</code> 和 <code>RouterLink</code> 组件。</li> <li>添加全局 <code>$router</code> 和 <code>$route</code> 属性。</li> <li>启用 <code>useRouter()</code> 和 <code>useRoute()</code> 组合式函数。</li> <li>触发路由器解析初始路由。</li></ul> <p>下面是具体源码实现：</p> <p>createRouter 方法来创建路由配置，用 <code>app.use</code> 在 Vue 中加载 vue-router 插件，且给 Vue 注册了两个内置组件，<code>&lt;router-view&gt;</code> 负责渲染当前路由匹配的组件，<code>&lt;router-link&gt;</code> 负责页面的跳转。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// createRouter传递参数的类型</span>
<span class="token keyword">export</span> <span class="token keyword">interface</span> <span class="token class-name">RouterOptions</span> <span class="token keyword">extends</span> <span class="token class-name">PathParserOptions</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">history</span><span class="token operator">:</span> RouterHistory
  <span class="token literal-property property">routes</span><span class="token operator">:</span> RouteRecordRaw<span class="token punctuation">[</span><span class="token punctuation">]</span>
  scrollBehavior<span class="token operator">?</span><span class="token operator">:</span> RouterScrollBehavior
  <span class="token operator">...</span>
<span class="token punctuation">}</span>
<span class="token comment">// 每个路由配置的类型</span>
<span class="token keyword">export</span> type RouteRecordRaw <span class="token operator">=</span>
  <span class="token operator">|</span> RouteRecordSingleView
  <span class="token operator">|</span> RouteRecordMultipleViews
  <span class="token operator">|</span> RouteRecordRedirect

<span class="token comment">//... other config</span>
<span class="token comment">// Router接口的全部方法和属性</span>
<span class="token keyword">export</span> <span class="token keyword">interface</span> <span class="token class-name">Router</span> <span class="token punctuation">{</span>
  readonly currentRoute<span class="token operator">:</span> Ref<span class="token operator">&lt;</span>RouteLocationNormalizedLoaded<span class="token operator">&gt;</span>
  readonly options<span class="token operator">:</span> RouterOptions

  <span class="token function">addRoute</span><span class="token punctuation">(</span>parentName<span class="token operator">:</span> RouteRecordName<span class="token punctuation">,</span> <span class="token literal-property property">route</span><span class="token operator">:</span> RouteRecordRaw<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">void</span>
  <span class="token function">addRoute</span><span class="token punctuation">(</span>route<span class="token operator">:</span> RouteRecordRaw<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">void</span>
  <span class="token function">Route</span><span class="token punctuation">(</span>name<span class="token operator">:</span> RouteRecordName<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span>
  <span class="token function">hasRoute</span><span class="token punctuation">(</span>name<span class="token operator">:</span> RouteRecordName<span class="token punctuation">)</span><span class="token operator">:</span> boolean

  <span class="token function">getRoutes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> RouteRecord<span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token function">resolve</span><span class="token punctuation">(</span>
    <span class="token literal-property property">to</span><span class="token operator">:</span> RouteLocationRaw<span class="token punctuation">,</span>
    currentLocation<span class="token operator">?</span><span class="token operator">:</span> RouteLocationNormalizedLoaded
  <span class="token punctuation">)</span><span class="token operator">:</span> RouteLocation <span class="token operator">&amp;</span> <span class="token punctuation">{</span> <span class="token literal-property property">href</span><span class="token operator">:</span> string <span class="token punctuation">}</span>
  <span class="token function">push</span><span class="token punctuation">(</span>to<span class="token operator">:</span> RouteLocationRaw<span class="token punctuation">)</span><span class="token operator">:</span> Promise<span class="token operator">&lt;</span>NavigationFailure <span class="token operator">|</span> <span class="token keyword">void</span> <span class="token operator">|</span> <span class="token keyword">undefined</span><span class="token operator">&gt;</span>
  <span class="token function">replace</span><span class="token punctuation">(</span>to<span class="token operator">:</span> RouteLocationRaw<span class="token punctuation">)</span><span class="token operator">:</span> Promise<span class="token operator">&lt;</span>NavigationFailure <span class="token operator">|</span> <span class="token keyword">void</span> <span class="token operator">|</span> <span class="token keyword">undefined</span><span class="token operator">&gt;</span>
  <span class="token function">back</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> ReturnType<span class="token operator">&lt;</span>Router<span class="token punctuation">[</span><span class="token string">'go'</span><span class="token punctuation">]</span><span class="token operator">&gt;</span>
  <span class="token function">forward</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> ReturnType<span class="token operator">&lt;</span>Router<span class="token punctuation">[</span><span class="token string">'go'</span><span class="token punctuation">]</span><span class="token operator">&gt;</span>
  <span class="token function">go</span><span class="token punctuation">(</span>delta<span class="token operator">:</span> number<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span>
  <span class="token function">beforeEach</span><span class="token punctuation">(</span>guard<span class="token operator">:</span> NavigationGuardWithThis<span class="token operator">&lt;</span><span class="token keyword">undefined</span><span class="token operator">&gt;</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">void</span>
  <span class="token function">beforeResolve</span><span class="token punctuation">(</span>guard<span class="token operator">:</span> NavigationGuardWithThis<span class="token operator">&lt;</span><span class="token keyword">undefined</span><span class="token operator">&gt;</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">void</span>
  <span class="token function">afterEach</span><span class="token punctuation">(</span>guard<span class="token operator">:</span> NavigationHookAfter<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">void</span>
  <span class="token function">onError</span><span class="token punctuation">(</span>handler<span class="token operator">:</span> _ErrorHandler<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">void</span>
  <span class="token function">isReady</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> Promise<span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token operator">&gt;</span>
  <span class="token function">install</span><span class="token punctuation">(</span>app<span class="token operator">:</span> App<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">createRouter</span><span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">options</span><span class="token operator">:</span> RouterOptions</span><span class="token punctuation">)</span><span class="token operator">:</span> Router <span class="token punctuation">{</span><span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br></div></div><p>参数 <code>RouterOptions</code> 是规范我们配置的路由对象，主要包含 history、routes 等数据。routes 就是我们需要配置的路由对象，类型是 RouteRecordRaw 组成的数组，并且 RouteRecordRaw 的类型是三个类型的合并。然后返回值的类型 Router 就是包含了 <code>addRoute</code>、<code>push</code>、<code>beforeEnter</code>、<code>install</code> 方法的一个对象，并且维护了 <code>currentRoute</code> 和 <code>options</code> 两个属性。</p> <h2 id="路由安装"><a href="#路由安装" class="header-anchor">#</a> 路由安装</h2> <p>在 createRouter 的最后，创建了包含 addRoute、push 等方法的对象，并且 install 方法内部注册了 <code>RouterLink</code> 和 <code>RouterView</code> 两个组件。所以我们可以在任何组件内部直接使用 和 组件，然后注册全局变量 <code>$router</code> 和 <code>$route</code>，其中 <code>$router</code> 就是我们通过 createRouter 返回的<strong>路由对象，包含 <code>addRoute</code>、<code>push</code> 等方法</strong>，<code>$route</code> 使用 <code>defineProperty</code> 的形式返回 currentRoute 的值，可以做到和 currentRoute 值同步。</p> <p>然后使用 <code>computed</code> 把路由变成响应式对象，存储在 <code>reactiveRoute</code> 对象中，再通过 <code>app.provide</code> 给全局注册了 <code>route</code> 和 <code>reactive</code> 包裹后的 <code>reactiveRoute</code> 对象。我们之前介绍 provide 函数的时候也介绍了，<code>provide</code> 提供的数据并没有做响应式的封装，需要响应式的时候需要自己使用 ref 或者 reactive 封装为响应式对象，最后注册 <code>unmount</code> 方法实现 vue-router 的安装。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">createRouter</span><span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">options</span><span class="token operator">:</span> RouterOptions</span><span class="token punctuation">)</span><span class="token operator">:</span> Router <span class="token punctuation">{</span>
<span class="token operator">...</span><span class="token punctuation">.</span>
  <span class="token keyword">let</span> <span class="token literal-property property">started</span><span class="token operator">:</span> boolean <span class="token operator">|</span> <span class="token keyword">undefined</span>
  <span class="token keyword">const</span> installedApps <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token operator">&lt;</span>App<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token comment">// 路由对象</span>
  <span class="token keyword">const</span> <span class="token literal-property property">router</span><span class="token operator">:</span> Router <span class="token operator">=</span> <span class="token punctuation">{</span>
    currentRoute<span class="token punctuation">,</span>

    addRoute<span class="token punctuation">,</span>
    removeRoute<span class="token punctuation">,</span>
    hasRoute<span class="token punctuation">,</span>
    getRoutes<span class="token punctuation">,</span>
    resolve<span class="token punctuation">,</span>
    options<span class="token punctuation">,</span>

    push<span class="token punctuation">,</span>
    replace<span class="token punctuation">,</span>
    go<span class="token punctuation">,</span>
    <span class="token function-variable function">back</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">go</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function-variable function">forward</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">go</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>

    <span class="token literal-property property">beforeEach</span><span class="token operator">:</span> beforeGuards<span class="token punctuation">.</span>add<span class="token punctuation">,</span>
    <span class="token literal-property property">beforeResolve</span><span class="token operator">:</span> beforeResolveGuards<span class="token punctuation">.</span>add<span class="token punctuation">,</span>
    <span class="token literal-property property">afterEach</span><span class="token operator">:</span> afterGuards<span class="token punctuation">.</span>add<span class="token punctuation">,</span>

    <span class="token literal-property property">onError</span><span class="token operator">:</span> errorHandlers<span class="token punctuation">.</span>add<span class="token punctuation">,</span>
    isReady<span class="token punctuation">,</span>
    <span class="token comment">// 插件按章</span>
    <span class="token function">install</span><span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">app</span><span class="token operator">:</span> App</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> router <span class="token operator">=</span> <span class="token keyword">this</span>
      <span class="token comment">// 注册全局组件 router-link和router-view</span>
      app<span class="token punctuation">.</span><span class="token function">component</span><span class="token punctuation">(</span><span class="token string">'RouterLink'</span><span class="token punctuation">,</span> RouterLink<span class="token punctuation">)</span>
      app<span class="token punctuation">.</span><span class="token function">component</span><span class="token punctuation">(</span><span class="token string">'RouterView'</span><span class="token punctuation">,</span> RouterView<span class="token punctuation">)</span>

      app<span class="token punctuation">.</span>config<span class="token punctuation">.</span>globalProperties<span class="token punctuation">.</span>$router <span class="token operator">=</span> router
      Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>app<span class="token punctuation">.</span>config<span class="token punctuation">.</span>globalProperties<span class="token punctuation">,</span> <span class="token string">'$route'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">enumerable</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        <span class="token function-variable function">get</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">unref</span><span class="token punctuation">(</span>currentRoute<span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>
        isBrowser <span class="token operator">&amp;&amp;</span>
        <span class="token operator">!</span>started <span class="token operator">&amp;&amp;</span>
        currentRoute<span class="token punctuation">.</span>value <span class="token operator">===</span> <span class="token constant">START_LOCATION_NORMALIZED</span>
      <span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// see above</span>
        started <span class="token operator">=</span> <span class="token boolean">true</span>
        <span class="token function">push</span><span class="token punctuation">(</span>routerHistory<span class="token punctuation">.</span>location<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token parameter">err</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>__DEV__<span class="token punctuation">)</span> <span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">'Unexpected error when starting the router:'</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">const</span> reactiveRoute <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token keyword">as</span> <span class="token punctuation">{</span>
        <span class="token punctuation">[</span>k <span class="token keyword">in</span> keyof RouteLocationNormalizedLoaded<span class="token punctuation">]</span><span class="token operator">:</span> ComputedRef<span class="token operator">&lt;</span>
          RouteLocationNormalizedLoaded<span class="token punctuation">[</span>k<span class="token punctuation">]</span>
        <span class="token operator">&gt;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> key <span class="token keyword">in</span> <span class="token constant">START_LOCATION_NORMALIZED</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// @ts-expect-error: the key matches</span>
        reactiveRoute<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">computed</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> currentRoute<span class="token punctuation">.</span>value<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// 提供全局配置</span>
      app<span class="token punctuation">.</span><span class="token function">provide</span><span class="token punctuation">(</span>routerKey<span class="token punctuation">,</span> router<span class="token punctuation">)</span>
      app<span class="token punctuation">.</span><span class="token function">provide</span><span class="token punctuation">(</span>routeLocationKey<span class="token punctuation">,</span> <span class="token function">reactive</span><span class="token punctuation">(</span>reactiveRoute<span class="token punctuation">)</span><span class="token punctuation">)</span>
      app<span class="token punctuation">.</span><span class="token function">provide</span><span class="token punctuation">(</span>routerViewLocationKey<span class="token punctuation">,</span> currentRoute<span class="token punctuation">)</span>

      <span class="token keyword">const</span> unmountApp <span class="token operator">=</span> app<span class="token punctuation">.</span>unmount
      installedApps<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span>
      app<span class="token punctuation">.</span><span class="token function-variable function">unmount</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        installedApps<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span>
        <span class="token comment">// ...</span>
        <span class="token function">unmountApp</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>__DEV__ <span class="token operator">||</span> __FEATURE_PROD_DEVTOOLS__<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> isBrowser<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">addDevtools</span><span class="token punctuation">(</span>app<span class="token punctuation">,</span> router<span class="token punctuation">,</span> matcher<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> router
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br></div></div><h2 id="路由组件"><a href="#路由组件" class="header-anchor">#</a> 路由组件</h2> <p>路由对象创建和安装之后，我们下一步需要了解的就是 <code>router-link</code> 和 <code>router-view</code> 两个组件的实现方式。通过下面的代码我们可以看到，RouterView 的 setup 函数返回了一个函数，这个函数就是 RouterView 组件的 <code>render</code> 函数。大部分我们使用的方式就是一个组件，没有 <code>slot</code> 情况下返回的就是 <code>component</code> 变量。component 使用 <code>h</code> 函数返回 ViewComponent 的虚拟 DOM，而 ViewComponent 是根据 <code>matchedRoute.components[props.name]</code> 计算而来。<code>matchedRoute</code> 依赖的 <code>matchedRouteRef</code> 的计算逻辑，数据来源 <code>injectedRoute</code> 就是上面我们注入的 <code>currentRoute</code> 对象。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">const</span> RouterViewImpl <span class="token operator">=</span> <span class="token comment">/*#__PURE__*/</span> <span class="token function">defineComponent</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'RouterView'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">props</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">type</span><span class="token operator">:</span> String <span class="token keyword">as</span> PropType<span class="token operator">&lt;</span>string<span class="token operator">&gt;</span><span class="token punctuation">,</span>
      <span class="token keyword">default</span><span class="token operator">:</span> <span class="token string">'default'</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token literal-property property">route</span><span class="token operator">:</span> Object <span class="token keyword">as</span> PropType<span class="token operator">&lt;</span>RouteLocationNormalizedLoaded<span class="token operator">&gt;</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token comment">// router-view组件源码</span>
  <span class="token function">setup</span><span class="token punctuation">(</span><span class="token parameter">props<span class="token punctuation">,</span> <span class="token punctuation">{</span> attrs<span class="token punctuation">,</span> slots <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 全局的reactiveRoute对象注入</span>
    <span class="token keyword">const</span> injectedRoute <span class="token operator">=</span> <span class="token function">inject</span><span class="token punctuation">(</span>routerViewLocationKey<span class="token punctuation">)</span><span class="token operator">!</span>
    
    <span class="token keyword">const</span> routeToDisplay <span class="token operator">=</span> <span class="token function">computed</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> props<span class="token punctuation">.</span>route <span class="token operator">||</span> injectedRoute<span class="token punctuation">.</span>value<span class="token punctuation">)</span>
    <span class="token keyword">const</span> depth <span class="token operator">=</span> <span class="token function">inject</span><span class="token punctuation">(</span>viewDepthKey<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> matchedRouteRef <span class="token operator">=</span> computed<span class="token operator">&lt;</span>RouteLocationMatched <span class="token operator">|</span> <span class="token keyword">undefined</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>
      <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> routeToDisplay<span class="token punctuation">.</span>value<span class="token punctuation">.</span>matched<span class="token punctuation">[</span>depth<span class="token punctuation">]</span>
    <span class="token punctuation">)</span>
    <span class="token comment">// 嵌套层级</span>
    <span class="token function">provide</span><span class="token punctuation">(</span>viewDepthKey<span class="token punctuation">,</span> depth <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token comment">// 匹配的router对象</span>
    <span class="token function">provide</span><span class="token punctuation">(</span>matchedRouteKey<span class="token punctuation">,</span> matchedRouteRef<span class="token punctuation">)</span>
    <span class="token function">provide</span><span class="token punctuation">(</span>routerViewLocationKey<span class="token punctuation">,</span> routeToDisplay<span class="token punctuation">)</span>

    <span class="token keyword">const</span> viewRef <span class="token operator">=</span> ref<span class="token operator">&lt;</span>ComponentPublicInstance<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">// 返回的render函数</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> route <span class="token operator">=</span> routeToDisplay<span class="token punctuation">.</span>value
      <span class="token keyword">const</span> matchedRoute <span class="token operator">=</span> matchedRouteRef<span class="token punctuation">.</span>value
      <span class="token keyword">const</span> ViewComponent <span class="token operator">=</span> matchedRoute <span class="token operator">&amp;&amp;</span> matchedRoute<span class="token punctuation">.</span>components<span class="token punctuation">[</span>props<span class="token punctuation">.</span>name<span class="token punctuation">]</span>
      <span class="token keyword">const</span> currentName <span class="token operator">=</span> props<span class="token punctuation">.</span>name

      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ViewComponent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">normalizeSlot</span><span class="token punctuation">(</span>slots<span class="token punctuation">.</span>default<span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">Component</span><span class="token operator">:</span> ViewComponent<span class="token punctuation">,</span> route <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>

      <span class="token comment">// props from route configuration</span>
      <span class="token keyword">const</span> routePropsOption <span class="token operator">=</span> matchedRoute<span class="token operator">!</span><span class="token punctuation">.</span>props<span class="token punctuation">[</span>props<span class="token punctuation">.</span>name<span class="token punctuation">]</span>
      <span class="token keyword">const</span> routeProps <span class="token operator">=</span> routePropsOption
        <span class="token operator">?</span> routePropsOption <span class="token operator">===</span> <span class="token boolean">true</span>
          <span class="token operator">?</span> route<span class="token punctuation">.</span>params
          <span class="token operator">:</span> <span class="token keyword">typeof</span> routePropsOption <span class="token operator">===</span> <span class="token string">'function'</span>
          <span class="token operator">?</span> <span class="token function">routePropsOption</span><span class="token punctuation">(</span>route<span class="token punctuation">)</span>
          <span class="token operator">:</span> routePropsOption
        <span class="token operator">:</span> <span class="token keyword">null</span>

      <span class="token keyword">const</span> <span class="token literal-property property">onVnodeUnmounted</span><span class="token operator">:</span> VNodeProps<span class="token punctuation">[</span><span class="token string">'onVnodeUnmounted'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token parameter">vnode</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token comment">// remove the instance reference to prevent leak</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>vnode<span class="token punctuation">.</span>component<span class="token operator">!</span><span class="token punctuation">.</span>isUnmounted<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          matchedRoute<span class="token operator">!</span><span class="token punctuation">.</span>instances<span class="token punctuation">[</span>currentName<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">null</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// 创建需要渲染组件的虚拟dom</span>
      <span class="token keyword">const</span> component <span class="token operator">=</span> <span class="token function">h</span><span class="token punctuation">(</span>
        ViewComponent<span class="token punctuation">,</span>
        <span class="token function">assign</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> routeProps<span class="token punctuation">,</span> attrs<span class="token punctuation">,</span> <span class="token punctuation">{</span>
          onVnodeUnmounted<span class="token punctuation">,</span>
          <span class="token literal-property property">ref</span><span class="token operator">:</span> viewRef<span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">)</span>
  
      <span class="token keyword">return</span> <span class="token punctuation">(</span>
        <span class="token comment">// pass the vnode to the slot as a prop.</span>
        <span class="token comment">// h and &lt;component :is=&quot;...&quot;&gt; both accept vnodes</span>
        <span class="token function">normalizeSlot</span><span class="token punctuation">(</span>slots<span class="token punctuation">.</span>default<span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">Component</span><span class="token operator">:</span> component<span class="token punctuation">,</span> route <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">||</span>
        component
      <span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br></div></div><h2 id="路由更新"><a href="#路由更新" class="header-anchor">#</a> 路由更新</h2> <p>到这我们可以看出，<code>RouterView</code> 渲染的组件是由当前匹配的路由变量 <code>matchedRoute</code> 决定的。接下来我们回到 createRouter 函数中，可以看到 <code>matcher</code> 对象是由 <code>createRouterMatcher</code> 创建，createRouterMatcher 函数传入 routes 配置的路由数组，并且返回创建的 <code>RouterMatcher</code> 对象，内部遍历 routes 数组，通过 addRoute 挨个处理路由配置</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">createRouter</span><span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">options</span><span class="token operator">:</span> RouterOptions</span><span class="token punctuation">)</span><span class="token operator">:</span> Router <span class="token punctuation">{</span>
  <span class="token keyword">const</span> matcher <span class="token operator">=</span> <span class="token function">createRouterMatcher</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span>routes<span class="token punctuation">,</span> options<span class="token punctuation">)</span>
  <span class="token comment">///....</span>
<span class="token punctuation">}</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">createRouterMatcher</span><span class="token punctuation">(</span>
  <span class="token parameter"><span class="token literal-property property">routes</span><span class="token operator">:</span> RouteRecordRaw<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token literal-property property">globalOptions</span><span class="token operator">:</span> PathParserOptions</span>
<span class="token punctuation">)</span><span class="token operator">:</span> RouterMatcher <span class="token punctuation">{</span>
  <span class="token comment">// matchers数组</span>
  <span class="token keyword">const</span> <span class="token literal-property property">matchers</span><span class="token operator">:</span> RouteRecordMatcher<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token comment">// matcher对象</span>
  <span class="token keyword">const</span> matcherMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token operator">&lt;</span>RouteRecordName<span class="token punctuation">,</span> RouteRecordMatcher<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  globalOptions <span class="token operator">=</span> <span class="token function">mergeOptions</span><span class="token punctuation">(</span>
    <span class="token punctuation">{</span> <span class="token literal-property property">strict</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token literal-property property">end</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token literal-property property">sensitive</span><span class="token operator">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span> <span class="token keyword">as</span> PathParserOptions<span class="token punctuation">,</span>
    globalOptions
  <span class="token punctuation">)</span>
  <span class="token keyword">function</span> <span class="token function">addRoute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token keyword">function</span> <span class="token function">remoteRoute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token keyword">function</span> <span class="token function">getRoutes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> matchers
  <span class="token punctuation">}</span>  
  <span class="token keyword">function</span> <span class="token function">insertMatcher</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token keyword">function</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token comment">// add initial routes</span>
  routes<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">route</span> <span class="token operator">=&gt;</span> <span class="token function">addRoute</span><span class="token punctuation">(</span>route<span class="token punctuation">)</span><span class="token punctuation">)</span>

  <span class="token keyword">return</span> <span class="token punctuation">{</span> addRoute<span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> removeRoute<span class="token punctuation">,</span> getRoutes<span class="token punctuation">,</span> getRecordMatcher <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br></div></div><p>在下面的代码中我们可以看到，<code>addRoute</code> 函数内部通过 <code>createRouteRecordMatcher</code> 创建扩展之后的 matcher 对象，包括了 <code>record</code>、<code>parent</code>、<code>children</code> 等树形，可以很好地描述路由之间的嵌套父子关系。这样整个路由对象就已经创建完毕，那我们如何在路由切换的时候寻找到正确的路由对象呢？</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">addRoute</span><span class="token punctuation">(</span>    
  <span class="token parameter"><span class="token literal-property property">record</span><span class="token operator">:</span> RouteRecordRaw<span class="token punctuation">,</span>
  parent<span class="token operator">?</span><span class="token operator">:</span> RouteRecordMatcher<span class="token punctuation">,</span>
  originalRecord<span class="token operator">?</span><span class="token operator">:</span> RouteRecordMatcher</span>
<span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">'alias'</span> <span class="token keyword">in</span> record<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 标准化alias</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> normalizedRecord <span class="token keyword">of</span> normalizedRecords<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
    matcher <span class="token operator">=</span> <span class="token function">createRouteRecordMatcher</span><span class="token punctuation">(</span>normalizedRecord<span class="token punctuation">,</span> parent<span class="token punctuation">,</span> options<span class="token punctuation">)</span>
    <span class="token function">insertMatcher</span><span class="token punctuation">(</span>matcher<span class="token punctuation">)</span>
      
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> originalMatcher
    <span class="token operator">?</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token comment">// since other matchers are aliases, they should be removed by the original matcher</span>
        <span class="token function">removeRoute</span><span class="token punctuation">(</span>originalMatcher<span class="token operator">!</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token operator">:</span> noop

<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">createRouteRecordMatcher</span><span class="token punctuation">(</span>
  <span class="token parameter"><span class="token literal-property property">record</span><span class="token operator">:</span> Readonly<span class="token operator">&lt;</span>RouteRecord<span class="token operator">&gt;</span><span class="token punctuation">,</span>
  <span class="token literal-property property">parent</span><span class="token operator">:</span> RouteRecordMatcher <span class="token operator">|</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span>
  options<span class="token operator">?</span><span class="token operator">:</span> PathParserOptions</span>
<span class="token punctuation">)</span><span class="token operator">:</span> RouteRecordMatcher <span class="token punctuation">{</span>
  <span class="token keyword">const</span> parser <span class="token operator">=</span> <span class="token function">tokensToParser</span><span class="token punctuation">(</span><span class="token function">tokenizePath</span><span class="token punctuation">(</span>record<span class="token punctuation">.</span>path<span class="token punctuation">)</span><span class="token punctuation">,</span> options<span class="token punctuation">)</span>
  <span class="token keyword">const</span> <span class="token literal-property property">matcher</span><span class="token operator">:</span> RouteRecordMatcher <span class="token operator">=</span> <span class="token function">assign</span><span class="token punctuation">(</span>parser<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    record<span class="token punctuation">,</span>
    parent<span class="token punctuation">,</span>
    <span class="token comment">// these needs to be populated by the parent</span>
    <span class="token literal-property property">children</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token literal-property property">alias</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>parent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>matcher<span class="token punctuation">.</span>record<span class="token punctuation">.</span>aliasOf <span class="token operator">===</span> <span class="token operator">!</span>parent<span class="token punctuation">.</span>record<span class="token punctuation">.</span>aliasOf<span class="token punctuation">)</span>
      parent<span class="token punctuation">.</span>children<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>matcher<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> matcher
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br></div></div><p>在 vue-router 中，路由更新可以通过 <code>router-link</code> 渲染的链接实现，也可以使用 <code>router 对象</code>的 <code>push</code> 等方法实现。</p> <p>下面的代码中，<code>router-link</code> 组件内部也是渲染一个 <code>a 标签</code>，并且注册了 a 标签的 <code>onClick</code> 函数，内部也是通过 <code>router.replace</code> 或者 <code>router.push</code> 来实现。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>
<span class="token keyword">export</span> <span class="token keyword">const</span> RouterLinkImpl <span class="token operator">=</span> <span class="token comment">/*#__PURE__*/</span> <span class="token function">defineComponent</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'RouterLink'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">props</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">to</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token punctuation">[</span>String<span class="token punctuation">,</span> Object<span class="token punctuation">]</span> <span class="token keyword">as</span> PropType<span class="token operator">&lt;</span>RouteLocationRaw<span class="token operator">&gt;</span><span class="token punctuation">,</span>
      <span class="token literal-property property">required</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token operator">...</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token comment">// router-link源码</span>
  <span class="token function">setup</span><span class="token punctuation">(</span><span class="token parameter">props<span class="token punctuation">,</span> <span class="token punctuation">{</span> slots <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> link <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span><span class="token function">useLink</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> options <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">inject</span><span class="token punctuation">(</span>routerKey<span class="token punctuation">)</span><span class="token operator">!</span>

    <span class="token keyword">const</span> elClass <span class="token operator">=</span> <span class="token function">computed</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token operator">...</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> children <span class="token operator">=</span> slots<span class="token punctuation">.</span>default <span class="token operator">&amp;&amp;</span> slots<span class="token punctuation">.</span><span class="token function">default</span><span class="token punctuation">(</span>link<span class="token punctuation">)</span>
      <span class="token keyword">return</span> props<span class="token punctuation">.</span>custom
        <span class="token operator">?</span> children
        <span class="token operator">:</span> <span class="token function">h</span><span class="token punctuation">(</span>
            <span class="token string">'a'</span><span class="token punctuation">,</span>
            <span class="token punctuation">{</span>
              <span class="token literal-property property">href</span><span class="token operator">:</span> link<span class="token punctuation">.</span>href<span class="token punctuation">,</span>
              <span class="token literal-property property">onClick</span><span class="token operator">:</span> link<span class="token punctuation">.</span>navigate<span class="token punctuation">,</span>
              <span class="token keyword">class</span><span class="token operator">:</span> elClass<span class="token punctuation">.</span>value<span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            children
          <span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">//  跳转</span>
  <span class="token keyword">function</span> <span class="token function">navigate</span><span class="token punctuation">(</span>
    <span class="token parameter"><span class="token literal-property property">e</span><span class="token operator">:</span> MouseEvent <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token keyword">as</span> MouseEvent</span>
  <span class="token punctuation">)</span><span class="token operator">:</span> Promise<span class="token operator">&lt;</span><span class="token keyword">void</span> <span class="token operator">|</span> NavigationFailure<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">guardEvent</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> router<span class="token punctuation">[</span><span class="token function">unref</span><span class="token punctuation">(</span>props<span class="token punctuation">.</span>replace<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token string">'replace'</span> <span class="token operator">:</span> <span class="token string">'push'</span><span class="token punctuation">]</span><span class="token punctuation">(</span>
        <span class="token function">unref</span><span class="token punctuation">(</span>props<span class="token punctuation">.</span>to<span class="token punctuation">)</span>
        <span class="token comment">// avoid uncaught errors are they are logged anyway</span>
      <span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span>noop<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br></div></div><p>现在我们回到 createRouter 函数中，可以看到 <code>push</code> 函数直接调用了 <code>pushWithRedirect</code> 函数来实现，内部通过 <code>resolve(to)</code> 生成 <code>targetLocation</code> 变量。这个变量会赋值给 <code>toLocation</code>，然后执行 <code>navigate(toLocation)</code> 函数。而这个函数内部会执行一系列的导航守卫函数，最后会执行 <code>finalizeNavigation</code> 函数完成导航。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">push</span><span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">to</span><span class="token operator">:</span> RouteLocationRaw <span class="token operator">|</span> RouteLocation</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">pushWithRedirect</span><span class="token punctuation">(</span>to<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">replace</span><span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">to</span><span class="token operator">:</span> RouteLocationRaw <span class="token operator">|</span> RouteLocationNormalized</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">push</span><span class="token punctuation">(</span><span class="token function">assign</span><span class="token punctuation">(</span><span class="token function">locationAsObject</span><span class="token punctuation">(</span>to<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">replace</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token comment">// 路由跳转函数</span>
<span class="token keyword">function</span> <span class="token function">pushWithRedirect</span><span class="token punctuation">(</span>
  <span class="token parameter"><span class="token literal-property property">to</span><span class="token operator">:</span> RouteLocationRaw <span class="token operator">|</span> RouteLocation<span class="token punctuation">,</span>
  redirectedFrom<span class="token operator">?</span><span class="token operator">:</span> RouteLocation</span>
<span class="token punctuation">)</span><span class="token operator">:</span> Promise<span class="token operator">&lt;</span>NavigationFailure <span class="token operator">|</span> <span class="token keyword">void</span> <span class="token operator">|</span> <span class="token keyword">undefined</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token literal-property property">targetLocation</span><span class="token operator">:</span> RouteLocation <span class="token operator">=</span> <span class="token punctuation">(</span>pendingLocation <span class="token operator">=</span> <span class="token function">resolve</span><span class="token punctuation">(</span>to<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> from <span class="token operator">=</span> currentRoute<span class="token punctuation">.</span>value
  <span class="token keyword">const</span> <span class="token literal-property property">data</span><span class="token operator">:</span> HistoryState <span class="token operator">|</span> <span class="token keyword">undefined</span> <span class="token operator">=</span> <span class="token punctuation">(</span>to <span class="token keyword">as</span> RouteLocationOptions<span class="token punctuation">)</span><span class="token punctuation">.</span>state
  <span class="token keyword">const</span> <span class="token literal-property property">force</span><span class="token operator">:</span> boolean <span class="token operator">|</span> <span class="token keyword">undefined</span> <span class="token operator">=</span> <span class="token punctuation">(</span>to <span class="token keyword">as</span> RouteLocationOptions<span class="token punctuation">)</span><span class="token punctuation">.</span>force
  <span class="token comment">// to could be a string where `replace` is a function</span>
  <span class="token keyword">const</span> replace <span class="token operator">=</span> <span class="token punctuation">(</span>to <span class="token keyword">as</span> RouteLocationOptions<span class="token punctuation">)</span><span class="token punctuation">.</span>replace <span class="token operator">===</span> <span class="token boolean">true</span>



  <span class="token keyword">const</span> toLocation <span class="token operator">=</span> targetLocation <span class="token keyword">as</span> RouteLocationNormalized

  
  <span class="token keyword">return</span> <span class="token punctuation">(</span>failure <span class="token operator">?</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>failure<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">navigate</span><span class="token punctuation">(</span>toLocation<span class="token punctuation">,</span> from<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">error</span><span class="token operator">:</span> NavigationFailure <span class="token operator">|</span> NavigationRedirectError</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
      <span class="token function">isNavigationFailure</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span>
        <span class="token operator">?</span> error
        <span class="token operator">:</span> <span class="token comment">// reject any unknown error</span>
          <span class="token function">triggerError</span><span class="token punctuation">(</span>error<span class="token punctuation">,</span> toLocation<span class="token punctuation">,</span> from<span class="token punctuation">)</span>
    <span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">failure</span><span class="token operator">:</span> NavigationFailure <span class="token operator">|</span> NavigationRedirectError <span class="token operator">|</span> <span class="token keyword">void</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>

        failure <span class="token operator">=</span> <span class="token function">finalizeNavigation</span><span class="token punctuation">(</span>
          toLocation <span class="token keyword">as</span> RouteLocationNormalizedLoaded<span class="token punctuation">,</span>
          from<span class="token punctuation">,</span>
          <span class="token boolean">true</span><span class="token punctuation">,</span>
          replace<span class="token punctuation">,</span>
          data
        <span class="token punctuation">)</span>

      <span class="token function">triggerAfterEach</span><span class="token punctuation">(</span>
        toLocation <span class="token keyword">as</span> RouteLocationNormalizedLoaded<span class="token punctuation">,</span>
        from<span class="token punctuation">,</span>
        failure
      <span class="token punctuation">)</span>
      <span class="token keyword">return</span> failure
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br></div></div><p>在下面的代码中我们可以看到，<code>finalizeNavigation</code> 函数内部通过 <code>routerHistory.push</code> 或者 <code>replace</code> 实现路由跳转，并且更新 <code>currentRoute.value</code>。</p> <p>currentRoute 就是我们在 <code>install</code> 方法中注册的全局变量 <code>$route</code>，每次页面跳转 currentRoute 都会更新为 <code>toLocation</code>，在任意组件中都可以通过 <code>$route</code> 变量来获取当前路由的数据，最后在 <code>handleScroll</code> 设置滚动行为。</p> <p><code>routerHistory</code> 在 createRouter 中通过 <code>option.history</code> 获取，就是我们创建 vue-router 应用时通过 <code>createWebHistory</code> 或者 <code>createWebHashHistory</code> 创建的对象。</p> <ul><li><code>createWebHistory</code> 返回的是 HTML5 的 history 模式路由对象。</li> <li><code>createWebHashHistory</code> 是 hash 模式的路由对象。</li></ul> <div class="language-js line-numbers-mode"><pre class="language-js"><code>  <span class="token keyword">function</span> <span class="token function">finalizeNavigation</span><span class="token punctuation">(</span>
    <span class="token parameter"><span class="token literal-property property">toLocation</span><span class="token operator">:</span> RouteLocationNormalizedLoaded<span class="token punctuation">,</span>
    <span class="token literal-property property">from</span><span class="token operator">:</span> RouteLocationNormalizedLoaded<span class="token punctuation">,</span>
    <span class="token literal-property property">isPush</span><span class="token operator">:</span> boolean<span class="token punctuation">,</span>
    replace<span class="token operator">?</span><span class="token operator">:</span> boolean<span class="token punctuation">,</span>
    data<span class="token operator">?</span><span class="token operator">:</span> HistoryState</span>
  <span class="token punctuation">)</span><span class="token operator">:</span> NavigationFailure <span class="token operator">|</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>



    <span class="token keyword">const</span> isFirstNavigation <span class="token operator">=</span> from <span class="token operator">===</span> <span class="token constant">START_LOCATION_NORMALIZED</span>
    <span class="token keyword">const</span> state <span class="token operator">=</span> <span class="token operator">!</span>isBrowser <span class="token operator">?</span> <span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token operator">:</span> history<span class="token punctuation">.</span>state

    <span class="token keyword">if</span> <span class="token punctuation">(</span>isPush<span class="token punctuation">)</span> <span class="token punctuation">{</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>replace <span class="token operator">||</span> isFirstNavigation<span class="token punctuation">)</span>
        routerHistory<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>
          toLocation<span class="token punctuation">.</span>fullPath
        <span class="token punctuation">)</span>
      <span class="token keyword">else</span> routerHistory<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>toLocation<span class="token punctuation">.</span>fullPath<span class="token punctuation">,</span> data<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// accept current navigation</span>
    currentRoute<span class="token punctuation">.</span>value <span class="token operator">=</span> toLocation
    <span class="token function">handleScroll</span><span class="token punctuation">(</span>toLocation<span class="token punctuation">,</span> from<span class="token punctuation">,</span> isPush<span class="token punctuation">,</span> isFirstNavigation<span class="token punctuation">)</span>

    <span class="token function">markAsReady</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  
  <span class="token keyword">function</span> <span class="token function">markAsReady</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token operator">?</span><span class="token operator">:</span> any</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ready<span class="token punctuation">)</span> <span class="token keyword">return</span>
    ready <span class="token operator">=</span> <span class="token boolean">true</span>
    <span class="token function">setupListeners</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    readyHandlers
      <span class="token punctuation">.</span><span class="token function">list</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">[</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">]</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span>err <span class="token operator">?</span> <span class="token function">reject</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    readyHandlers<span class="token punctuation">.</span><span class="token function">reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br></div></div><p><code>createWebHashHistory</code> 和 <code>createWebHistory</code> 的实现，内部都是通过</p> <ul><li><code>useHistoryListeners</code> 实现路由的监听</li> <li><code>useHistoryStateNavigation</code>实现路由的切换。</li> <li><code>useHistoryStateNavigation</code>会返回 push 或者 replace 方法来更新路由。</li></ul> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">createWebHashHistory</span><span class="token punctuation">(</span><span class="token parameter">base<span class="token operator">?</span><span class="token operator">:</span> string</span><span class="token punctuation">)</span><span class="token operator">:</span> RouterHistory <span class="token punctuation">{</span>
  base <span class="token operator">=</span> location<span class="token punctuation">.</span>host <span class="token operator">?</span> base <span class="token operator">||</span> location<span class="token punctuation">.</span>pathname <span class="token operator">+</span> location<span class="token punctuation">.</span>search <span class="token operator">:</span> <span class="token string">''</span>
  <span class="token comment">// allow the user to provide a `#` in the middle: `/base/#/app`</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>base<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token string">'#'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> base <span class="token operator">+=</span> <span class="token string">'#'</span>
  <span class="token keyword">return</span> <span class="token function">createWebHistory</span><span class="token punctuation">(</span>base<span class="token punctuation">)</span>
<span class="token punctuation">}</span>



<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">createWebHistory</span><span class="token punctuation">(</span><span class="token parameter">base<span class="token operator">?</span><span class="token operator">:</span> string</span><span class="token punctuation">)</span><span class="token operator">:</span> RouterHistory <span class="token punctuation">{</span>
  base <span class="token operator">=</span> <span class="token function">normalizeBase</span><span class="token punctuation">(</span>base<span class="token punctuation">)</span>

  <span class="token keyword">const</span> historyNavigation <span class="token operator">=</span> <span class="token function">useHistoryStateNavigation</span><span class="token punctuation">(</span>base<span class="token punctuation">)</span>
  <span class="token keyword">const</span> historyListeners <span class="token operator">=</span> <span class="token function">useHistoryListeners</span><span class="token punctuation">(</span>
    base<span class="token punctuation">,</span>
    historyNavigation<span class="token punctuation">.</span>state<span class="token punctuation">,</span>
    historyNavigation<span class="token punctuation">.</span>location<span class="token punctuation">,</span>
    historyNavigation<span class="token punctuation">.</span>replace
  <span class="token punctuation">)</span>
  <span class="token keyword">function</span> <span class="token function">go</span><span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">delta</span><span class="token operator">:</span> number<span class="token punctuation">,</span> triggerListeners <span class="token operator">=</span> <span class="token boolean">true</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>triggerListeners<span class="token punctuation">)</span> historyListeners<span class="token punctuation">.</span><span class="token function">pauseListeners</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    history<span class="token punctuation">.</span><span class="token function">go</span><span class="token punctuation">(</span>delta<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">const</span> <span class="token literal-property property">routerHistory</span><span class="token operator">:</span> RouterHistory <span class="token operator">=</span> <span class="token function">assign</span><span class="token punctuation">(</span>
    <span class="token punctuation">{</span>
      <span class="token comment">// it's overridden right after</span>
      <span class="token literal-property property">location</span><span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">,</span>
      base<span class="token punctuation">,</span>
      go<span class="token punctuation">,</span>
      <span class="token literal-property property">createHref</span><span class="token operator">:</span> <span class="token function">createHref</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> base<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    historyNavigation<span class="token punctuation">,</span>
    historyListeners
  <span class="token punctuation">)</span>

  Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>routerHistory<span class="token punctuation">,</span> <span class="token string">'location'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">enumerable</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token function-variable function">get</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> historyNavigation<span class="token punctuation">.</span>location<span class="token punctuation">.</span>value<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>routerHistory<span class="token punctuation">,</span> <span class="token string">'state'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">enumerable</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token function-variable function">get</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> historyNavigation<span class="token punctuation">.</span>state<span class="token punctuation">.</span>value<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token keyword">return</span> routerHistory
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br></div></div><h2 id="路由-hooks"><a href="#路由-hooks" class="header-anchor">#</a> 路由 Hooks</h2> <h3 id="userouter"><a href="#userouter" class="header-anchor">#</a> <code>useRouter</code></h3> <p><strong>路由器实例</strong>，常用于路由的导航和守卫操作。由 <code>createRouter()</code> 返回的对象。在组合式 API 中，它可以通过调用 <code>useRouter()</code> 来访问。在选项式 API 中，它可以通过 <code>this.$router</code> 来访问。</p> <h3 id="useroute"><a href="#useroute" class="header-anchor">#</a> <code>useRoute</code></h3> <p><strong>当前路由对象</strong>，常用语获取路由信息。基于不同 API 风格的组件，它可以通过 <code>useRoute()</code> 或 <code>this.$route</code> 来访问。</p> <p>route 对象是一个<strong>响应式对象</strong>。在多数情况下，你应该<strong>避免监听整个 route 对象</strong>，同时直接监听你期望改变的参数。</p> <p>只在模板中我们仍然可以访问 <code>$router</code> 和 <code>$route</code>，不需要再 <code>useRouter</code> 或 <code>useRoute</code>。</p> <h3 id="uselink"><a href="#uselink" class="header-anchor">#</a> <code>useLink</code></h3> <p>Vue Router 将 RouterLink 的内部行为作为一个组合式函数 (composable) 公开。它接收一个类似 RouterLink 所有 prop 的响应式对象，并暴露底层属性来构建你自己的 RouterLink 组件或生成自定义链接。注意在 RouterLink 的 v-slot 中可以访问与 useLink 组合式函数相同的属性。</p> <div class="language-vue line-numbers-mode"><pre class="language-vue"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">setup</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
<span class="token keyword">import</span> <span class="token punctuation">{</span> RouterLink<span class="token punctuation">,</span> useLink <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'vue-router'</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> computed <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'vue'</span>

<span class="token keyword">const</span> props <span class="token operator">=</span> <span class="token function">defineProps</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token comment">// 如果使用 TypeScript，请添加 @ts-ignore</span>
  <span class="token operator">...</span>RouterLink<span class="token punctuation">.</span>props<span class="token punctuation">,</span>
  <span class="token literal-property property">inactiveClass</span><span class="token operator">:</span> String<span class="token punctuation">,</span>
<span class="token punctuation">}</span>）

<span class="token keyword">const</span> <span class="token punctuation">{</span>
  <span class="token comment">// 解析出来的路由对象</span>
  route<span class="token punctuation">,</span>
  <span class="token comment">// 用在链接里的 href</span>
  href<span class="token punctuation">,</span>
  <span class="token comment">// 布尔类型的 ref 标识链接是否匹配当前路由</span>
  isActive<span class="token punctuation">,</span>
  <span class="token comment">// 布尔类型的 ref 标识链接是否严格匹配当前路由</span>
  isExactActive<span class="token punctuation">,</span>
  <span class="token comment">// 导航至该链接的函数</span>
  navigate
<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">useLink</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span>

<span class="token keyword">const</span> isExternalLink <span class="token operator">=</span> <span class="token function">computed</span><span class="token punctuation">(</span>
  <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">typeof</span> props<span class="token punctuation">.</span>to <span class="token operator">===</span> <span class="token string">'string'</span> <span class="token operator">&amp;&amp;</span> props<span class="token punctuation">.</span>to<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">'http'</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br></div></div><div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">/**
 * Returns the router instance. Equivalent to using `$router` inside
 * templates.
 */</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">useRouter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> Router <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">inject</span><span class="token punctuation">(</span>routerKey<span class="token punctuation">)</span><span class="token operator">!</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
 * Returns the current route location. Equivalent to using `$route` inside
 * templates.
 */</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> useRoute<span class="token operator">&lt;</span>Name <span class="token keyword">extends</span> <span class="token class-name">keyof</span> RouteMap <span class="token operator">=</span> keyof RouteMap<span class="token operator">&gt;</span><span class="token punctuation">(</span>
  _name<span class="token operator">?</span><span class="token operator">:</span> Name
<span class="token punctuation">)</span><span class="token operator">:</span> RouteLocationNormalizedLoaded<span class="token operator">&lt;</span>Name<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">inject</span><span class="token punctuation">(</span>routeLocationKey<span class="token punctuation">)</span><span class="token operator">!</span>
<span class="token punctuation">}</span>


<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">createRouter</span><span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">options</span><span class="token operator">:</span> RouterOptions</span><span class="token punctuation">)</span><span class="token operator">:</span> Router <span class="token punctuation">{</span>
  <span class="token comment">//...</span>
  <span class="token keyword">const</span> <span class="token literal-property property">router</span><span class="token operator">:</span> Router <span class="token operator">=</span> <span class="token punctuation">{</span>
     <span class="token function">install</span><span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">app</span><span class="token operator">:</span> App</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> router <span class="token operator">=</span> <span class="token keyword">this</span>
      app<span class="token punctuation">.</span><span class="token function">component</span><span class="token punctuation">(</span><span class="token string">'RouterLink'</span><span class="token punctuation">,</span> RouterLink<span class="token punctuation">)</span>
      app<span class="token punctuation">.</span><span class="token function">component</span><span class="token punctuation">(</span><span class="token string">'RouterView'</span><span class="token punctuation">,</span> RouterView<span class="token punctuation">)</span>

      app<span class="token punctuation">.</span>config<span class="token punctuation">.</span>globalProperties<span class="token punctuation">.</span>$router <span class="token operator">=</span> router
      Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>app<span class="token punctuation">.</span>config<span class="token punctuation">.</span>globalProperties<span class="token punctuation">,</span> <span class="token string">'$route'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">enumerable</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        <span class="token function-variable function">get</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">unref</span><span class="token punctuation">(</span>currentRoute<span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>

      <span class="token keyword">const</span> reactiveRoute <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token keyword">as</span> RouteLocationNormalizedLoaded
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> key <span class="token keyword">in</span> <span class="token constant">START_LOCATION_NORMALIZED</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>reactiveRoute<span class="token punctuation">,</span> key<span class="token punctuation">,</span> <span class="token punctuation">{</span>
          <span class="token function-variable function">get</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> currentRoute<span class="token punctuation">.</span>value<span class="token punctuation">[</span>key <span class="token keyword">as</span> keyof RouteLocationNormalized<span class="token punctuation">]</span><span class="token punctuation">,</span>
          <span class="token literal-property property">enumerable</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>

      app<span class="token punctuation">.</span><span class="token function">provide</span><span class="token punctuation">(</span>routerKey<span class="token punctuation">,</span> router<span class="token punctuation">)</span>
      app<span class="token punctuation">.</span><span class="token function">provide</span><span class="token punctuation">(</span>routeLocationKey<span class="token punctuation">,</span> <span class="token function">shallowReactive</span><span class="token punctuation">(</span>reactiveRoute<span class="token punctuation">)</span><span class="token punctuation">)</span>
     <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token comment">//...</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br></div></div><p><code>useLink</code> 实现如下：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">function</span> useLink<span class="token operator">&lt;</span>Name <span class="token keyword">extends</span> <span class="token class-name">keyof</span> RouteMap <span class="token operator">=</span> keyof RouteMap<span class="token operator">&gt;</span><span class="token punctuation">(</span>
  <span class="token literal-property property">props</span><span class="token operator">:</span> UseLinkOptions<span class="token operator">&lt;</span>Name<span class="token operator">&gt;</span>
<span class="token punctuation">)</span><span class="token operator">:</span> UseLinkReturn<span class="token operator">&lt;</span>Name<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> router <span class="token operator">=</span> <span class="token function">inject</span><span class="token punctuation">(</span>routerKey<span class="token punctuation">)</span><span class="token operator">!</span>
  <span class="token keyword">const</span> currentRoute <span class="token operator">=</span> <span class="token function">inject</span><span class="token punctuation">(</span>routeLocationKey<span class="token punctuation">)</span><span class="token operator">!</span>

  <span class="token keyword">let</span> hasPrevious <span class="token operator">=</span> <span class="token boolean">false</span>
  <span class="token keyword">let</span> <span class="token literal-property property">previousTo</span><span class="token operator">:</span> unknown <span class="token operator">=</span> <span class="token keyword">null</span>

  <span class="token keyword">const</span> route <span class="token operator">=</span> <span class="token function">computed</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> to <span class="token operator">=</span> <span class="token function">unref</span><span class="token punctuation">(</span>props<span class="token punctuation">.</span>to<span class="token punctuation">)</span>
      <span class="token comment">// ...</span>
      previousTo <span class="token operator">=</span> to
      hasPrevious <span class="token operator">=</span> <span class="token boolean">true</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> router<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>to<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token keyword">const</span> activeRecordIndex <span class="token operator">=</span> computed<span class="token operator">&lt;</span>number<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> matched <span class="token punctuation">}</span> <span class="token operator">=</span> route<span class="token punctuation">.</span>value
    <span class="token keyword">const</span> <span class="token punctuation">{</span> length <span class="token punctuation">}</span> <span class="token operator">=</span> matched
    <span class="token keyword">const</span> <span class="token literal-property property">routeMatched</span><span class="token operator">:</span> RouteRecord <span class="token operator">|</span> <span class="token keyword">undefined</span> <span class="token operator">=</span> matched<span class="token punctuation">[</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span>
    <span class="token keyword">const</span> currentMatched <span class="token operator">=</span> currentRoute<span class="token punctuation">.</span>matched
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>routeMatched <span class="token operator">||</span> <span class="token operator">!</span>currentMatched<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span>
    <span class="token keyword">const</span> index <span class="token operator">=</span> currentMatched<span class="token punctuation">.</span><span class="token function">findIndex</span><span class="token punctuation">(</span>
      <span class="token function">isSameRouteRecord</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> routeMatched<span class="token punctuation">)</span>
    <span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>index <span class="token operator">&gt;</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">return</span> index
    <span class="token comment">// possible parent record</span>
    <span class="token keyword">const</span> parentRecordPath <span class="token operator">=</span> <span class="token function">getOriginalPath</span><span class="token punctuation">(</span>
      matched<span class="token punctuation">[</span>length <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">]</span> <span class="token keyword">as</span> RouteRecord <span class="token operator">|</span> <span class="token keyword">undefined</span>
    <span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>
      <span class="token comment">// we are dealing with nested routes</span>
      length <span class="token operator">&gt;</span> <span class="token number">1</span> <span class="token operator">&amp;&amp;</span>
        <span class="token comment">// if the parent and matched route have the same path, this link is</span>
        <span class="token comment">// referring to the empty child. Or we currently are on a different</span>
        <span class="token comment">// child of the same parent</span>
        <span class="token function">getOriginalPath</span><span class="token punctuation">(</span>routeMatched<span class="token punctuation">)</span> <span class="token operator">===</span> parentRecordPath <span class="token operator">&amp;&amp;</span>
        <span class="token comment">// avoid comparing the child with its parent</span>
        currentMatched<span class="token punctuation">[</span>currentMatched<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>path <span class="token operator">!==</span> parentRecordPath
        <span class="token operator">?</span> currentMatched<span class="token punctuation">.</span><span class="token function">findIndex</span><span class="token punctuation">(</span>
            <span class="token function">isSameRouteRecord</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> matched<span class="token punctuation">[</span>length <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
          <span class="token punctuation">)</span>
        <span class="token operator">:</span> index
    <span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token keyword">const</span> isActive <span class="token operator">=</span> computed<span class="token operator">&lt;</span>boolean<span class="token operator">&gt;</span><span class="token punctuation">(</span>
    <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
      activeRecordIndex<span class="token punctuation">.</span>value <span class="token operator">&gt;</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">&amp;&amp;</span>
      <span class="token function">includesParams</span><span class="token punctuation">(</span>currentRoute<span class="token punctuation">.</span>params<span class="token punctuation">,</span> route<span class="token punctuation">.</span>value<span class="token punctuation">.</span>params<span class="token punctuation">)</span>
  <span class="token punctuation">)</span>
  <span class="token keyword">const</span> isExactActive <span class="token operator">=</span> computed<span class="token operator">&lt;</span>boolean<span class="token operator">&gt;</span><span class="token punctuation">(</span>
    <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
      activeRecordIndex<span class="token punctuation">.</span>value <span class="token operator">&gt;</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">&amp;&amp;</span>
      activeRecordIndex<span class="token punctuation">.</span>value <span class="token operator">===</span> currentRoute<span class="token punctuation">.</span>matched<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span> <span class="token operator">&amp;&amp;</span>
      <span class="token function">isSameRouteLocationParams</span><span class="token punctuation">(</span>currentRoute<span class="token punctuation">.</span>params<span class="token punctuation">,</span> route<span class="token punctuation">.</span>value<span class="token punctuation">.</span>params<span class="token punctuation">)</span>
  <span class="token punctuation">)</span>

  <span class="token keyword">function</span> <span class="token function">navigate</span><span class="token punctuation">(</span>
    <span class="token parameter"><span class="token literal-property property">e</span><span class="token operator">:</span> MouseEvent <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token keyword">as</span> MouseEvent</span>
  <span class="token punctuation">)</span><span class="token operator">:</span> Promise<span class="token operator">&lt;</span><span class="token keyword">void</span> <span class="token operator">|</span> NavigationFailure<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">guardEvent</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> router<span class="token punctuation">[</span><span class="token function">unref</span><span class="token punctuation">(</span>props<span class="token punctuation">.</span>replace<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token string">'replace'</span> <span class="token operator">:</span> <span class="token string">'push'</span><span class="token punctuation">]</span><span class="token punctuation">(</span>
        <span class="token function">unref</span><span class="token punctuation">(</span>props<span class="token punctuation">.</span>to<span class="token punctuation">)</span>
        <span class="token comment">// avoid uncaught errors are they are logged anyway</span>
      <span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span>noop<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// devtools only</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>__DEV__ <span class="token operator">||</span> __FEATURE_PROD_DEVTOOLS__<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> isBrowser<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> instance <span class="token operator">=</span> <span class="token function">getCurrentInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>instance<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> <span class="token literal-property property">linkContextDevtools</span><span class="token operator">:</span> UseLinkDevtoolsContext <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">route</span><span class="token operator">:</span> route<span class="token punctuation">.</span>value<span class="token punctuation">,</span>
        <span class="token literal-property property">isActive</span><span class="token operator">:</span> isActive<span class="token punctuation">.</span>value<span class="token punctuation">,</span>
        <span class="token literal-property property">isExactActive</span><span class="token operator">:</span> isExactActive<span class="token punctuation">.</span>value<span class="token punctuation">,</span>
        <span class="token literal-property property">error</span><span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span>

      <span class="token comment">// @ts-expect-error: this is internal</span>
      instance<span class="token punctuation">.</span>__vrl_devtools <span class="token operator">=</span> instance<span class="token punctuation">.</span>__vrl_devtools <span class="token operator">||</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
      <span class="token comment">// @ts-expect-error: this is internal</span>
      instance<span class="token punctuation">.</span>__vrl_devtools<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>linkContextDevtools<span class="token punctuation">)</span>
      <span class="token function">watchEffect</span><span class="token punctuation">(</span>
        <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          linkContextDevtools<span class="token punctuation">.</span>route <span class="token operator">=</span> route<span class="token punctuation">.</span>value
          linkContextDevtools<span class="token punctuation">.</span>isActive <span class="token operator">=</span> isActive<span class="token punctuation">.</span>value
          linkContextDevtools<span class="token punctuation">.</span>isExactActive <span class="token operator">=</span> isExactActive<span class="token punctuation">.</span>value
          linkContextDevtools<span class="token punctuation">.</span>error <span class="token operator">=</span> <span class="token function">isRouteLocation</span><span class="token punctuation">(</span><span class="token function">unref</span><span class="token punctuation">(</span>props<span class="token punctuation">.</span>to<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token operator">?</span> <span class="token keyword">null</span>
            <span class="token operator">:</span> <span class="token string">'Invalid &quot;to&quot; value'</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span> <span class="token literal-property property">flush</span><span class="token operator">:</span> <span class="token string">'post'</span> <span class="token punctuation">}</span>
      <span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * NOTE: update {@link _RouterLinkI}'s `$slots` type when updating this
   */</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    route<span class="token punctuation">,</span>
    <span class="token literal-property property">href</span><span class="token operator">:</span> <span class="token function">computed</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> route<span class="token punctuation">.</span>value<span class="token punctuation">.</span>href<span class="token punctuation">)</span><span class="token punctuation">,</span>
    isActive<span class="token punctuation">,</span>
    isExactActive<span class="token punctuation">,</span>
    navigate<span class="token punctuation">,</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br></div></div><p><a href="https://juejin.cn/post/7159528677644959758#heading-15" target="_blank" rel="noopener noreferrer">VueRouter4 源码分析<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><a href="https://router.vuejs.org/zh/guide/advanced/dynamic-routing.html" target="_blank" rel="noopener noreferrer">动态路由<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/blog/vue/vue3/hooks.html" class="prev">
        Hooks
      </a></span> <span class="next"><a href="/blog/vue/vue3/pinia.html">
        Pinia 原理
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----><!----><!----><!----></div></div>
    <script src="/blog/assets/js/app.5c0d645f.js" defer></script><script src="/blog/assets/js/2.dec2e75d.js" defer></script><script src="/blog/assets/js/1.5b9e135c.js" defer></script><script src="/blog/assets/js/199.7078abc5.js" defer></script><script src="/blog/assets/js/20.badbb211.js" defer></script>
  </body>
</html>
