<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>组件化原理 | 前端那些事儿</title>
    <meta name="generator" content="VuePress 1.9.10">
    <link rel="icon" href="/blog/logo.png">
    <link rel="manifest" href="/blog/manifest.json">
    <link rel="apple-touch-icon" href="/blog/images/icons/apple-icon-152x152.png">
    <meta name="description" content="我命由我不由天，学习吧少年">
    <meta name="theme-color" content="#3eaf7c">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="msapplication-TileImage" content="/icons/ms-icon-144x144.png">
    <meta name="msapplication-TileColor" content="#000000">
    
    <link rel="preload" href="/blog/assets/css/0.styles.7b6e3ec2.css" as="style"><link rel="preload" href="/blog/assets/js/app.e9b7ea63.js" as="script"><link rel="preload" href="/blog/assets/js/2.dec2e75d.js" as="script"><link rel="preload" href="/blog/assets/js/1.5b9e135c.js" as="script"><link rel="preload" href="/blog/assets/js/177.1a2283d9.js" as="script"><link rel="preload" href="/blog/assets/js/20.badbb211.js" as="script"><link rel="prefetch" href="/blog/assets/js/10.cc7e09f3.js"><link rel="prefetch" href="/blog/assets/js/100.337ef741.js"><link rel="prefetch" href="/blog/assets/js/101.1257f2fc.js"><link rel="prefetch" href="/blog/assets/js/102.131f1e86.js"><link rel="prefetch" href="/blog/assets/js/103.849d9dd6.js"><link rel="prefetch" href="/blog/assets/js/104.552a90e6.js"><link rel="prefetch" href="/blog/assets/js/105.ac2e5d37.js"><link rel="prefetch" href="/blog/assets/js/106.7af79b20.js"><link rel="prefetch" href="/blog/assets/js/107.d6020f8b.js"><link rel="prefetch" href="/blog/assets/js/108.21caa9f0.js"><link rel="prefetch" href="/blog/assets/js/109.0eb1751c.js"><link rel="prefetch" href="/blog/assets/js/11.b60c9933.js"><link rel="prefetch" href="/blog/assets/js/110.8d2fbecf.js"><link rel="prefetch" href="/blog/assets/js/111.20943a01.js"><link rel="prefetch" href="/blog/assets/js/112.cab8e641.js"><link rel="prefetch" href="/blog/assets/js/113.f1eca1b4.js"><link rel="prefetch" href="/blog/assets/js/114.894abd93.js"><link rel="prefetch" href="/blog/assets/js/115.85624fa4.js"><link rel="prefetch" href="/blog/assets/js/116.c5a70ef7.js"><link rel="prefetch" href="/blog/assets/js/117.4453d953.js"><link rel="prefetch" href="/blog/assets/js/118.eefb56cd.js"><link rel="prefetch" href="/blog/assets/js/119.b14d6450.js"><link rel="prefetch" href="/blog/assets/js/12.c53283e7.js"><link rel="prefetch" href="/blog/assets/js/120.cbb7c7cd.js"><link rel="prefetch" href="/blog/assets/js/121.9b31b1a5.js"><link rel="prefetch" href="/blog/assets/js/122.f43b9cef.js"><link rel="prefetch" href="/blog/assets/js/123.257fe662.js"><link rel="prefetch" href="/blog/assets/js/124.4011ea82.js"><link rel="prefetch" href="/blog/assets/js/125.d1e8e0d9.js"><link rel="prefetch" href="/blog/assets/js/126.448fca54.js"><link rel="prefetch" href="/blog/assets/js/127.0f8042b6.js"><link rel="prefetch" href="/blog/assets/js/128.369941f3.js"><link rel="prefetch" href="/blog/assets/js/129.c409f907.js"><link rel="prefetch" href="/blog/assets/js/13.6bdc6b5d.js"><link rel="prefetch" href="/blog/assets/js/130.d645057b.js"><link rel="prefetch" href="/blog/assets/js/131.45ccfc83.js"><link rel="prefetch" href="/blog/assets/js/132.044b86a9.js"><link rel="prefetch" href="/blog/assets/js/133.ce9418b3.js"><link rel="prefetch" href="/blog/assets/js/134.c068e9d4.js"><link rel="prefetch" href="/blog/assets/js/135.cb875c47.js"><link rel="prefetch" href="/blog/assets/js/136.dded7b9f.js"><link rel="prefetch" href="/blog/assets/js/137.aa92a0ec.js"><link rel="prefetch" href="/blog/assets/js/138.c6ae5afe.js"><link rel="prefetch" href="/blog/assets/js/139.afd9803d.js"><link rel="prefetch" href="/blog/assets/js/14.c3201a23.js"><link rel="prefetch" href="/blog/assets/js/140.bfa6c1fe.js"><link rel="prefetch" href="/blog/assets/js/141.80ba11c6.js"><link rel="prefetch" href="/blog/assets/js/142.280c9b87.js"><link rel="prefetch" href="/blog/assets/js/143.84572423.js"><link rel="prefetch" href="/blog/assets/js/144.d60eabb4.js"><link rel="prefetch" href="/blog/assets/js/145.ee097aff.js"><link rel="prefetch" href="/blog/assets/js/146.1ee847d6.js"><link rel="prefetch" href="/blog/assets/js/147.0d80f645.js"><link rel="prefetch" href="/blog/assets/js/148.248ec39a.js"><link rel="prefetch" href="/blog/assets/js/149.abe65cfb.js"><link rel="prefetch" href="/blog/assets/js/15.a0b9e44e.js"><link rel="prefetch" href="/blog/assets/js/150.9b4cbf0f.js"><link rel="prefetch" href="/blog/assets/js/151.83597e3e.js"><link rel="prefetch" href="/blog/assets/js/152.4276f94d.js"><link rel="prefetch" href="/blog/assets/js/153.14722280.js"><link rel="prefetch" href="/blog/assets/js/154.dd293d18.js"><link rel="prefetch" href="/blog/assets/js/155.0ad6ffac.js"><link rel="prefetch" href="/blog/assets/js/156.765a7f18.js"><link rel="prefetch" href="/blog/assets/js/157.02f08cdb.js"><link rel="prefetch" href="/blog/assets/js/158.6e0bf1c0.js"><link rel="prefetch" href="/blog/assets/js/159.e50fb630.js"><link rel="prefetch" href="/blog/assets/js/16.491191e4.js"><link rel="prefetch" href="/blog/assets/js/160.479a263e.js"><link rel="prefetch" href="/blog/assets/js/161.3d7e9515.js"><link rel="prefetch" href="/blog/assets/js/162.45499727.js"><link rel="prefetch" href="/blog/assets/js/163.45bdc0ec.js"><link rel="prefetch" href="/blog/assets/js/164.eeb4f26d.js"><link rel="prefetch" href="/blog/assets/js/165.e8ec1a69.js"><link rel="prefetch" href="/blog/assets/js/166.09e4c5ba.js"><link rel="prefetch" href="/blog/assets/js/167.682e9c17.js"><link rel="prefetch" href="/blog/assets/js/168.a80229c6.js"><link rel="prefetch" href="/blog/assets/js/169.bacba512.js"><link rel="prefetch" href="/blog/assets/js/17.89ec8c57.js"><link rel="prefetch" href="/blog/assets/js/170.1cec8dd4.js"><link rel="prefetch" href="/blog/assets/js/171.0089fe1a.js"><link rel="prefetch" href="/blog/assets/js/172.ea5262e4.js"><link rel="prefetch" href="/blog/assets/js/173.7875bea9.js"><link rel="prefetch" href="/blog/assets/js/174.7aa99a96.js"><link rel="prefetch" href="/blog/assets/js/175.28492d4b.js"><link rel="prefetch" href="/blog/assets/js/176.c79421e2.js"><link rel="prefetch" href="/blog/assets/js/178.ad2555ad.js"><link rel="prefetch" href="/blog/assets/js/179.b576f82d.js"><link rel="prefetch" href="/blog/assets/js/18.b91f1411.js"><link rel="prefetch" href="/blog/assets/js/180.7aa47869.js"><link rel="prefetch" href="/blog/assets/js/181.b82bb8f4.js"><link rel="prefetch" href="/blog/assets/js/182.ed725fa4.js"><link rel="prefetch" href="/blog/assets/js/183.5a57b1b7.js"><link rel="prefetch" href="/blog/assets/js/184.850c643c.js"><link rel="prefetch" href="/blog/assets/js/185.a1629294.js"><link rel="prefetch" href="/blog/assets/js/186.4c59b35b.js"><link rel="prefetch" href="/blog/assets/js/187.b1ee21ec.js"><link rel="prefetch" href="/blog/assets/js/188.e6e1009d.js"><link rel="prefetch" href="/blog/assets/js/189.d4c24933.js"><link rel="prefetch" href="/blog/assets/js/19.cb1f17c8.js"><link rel="prefetch" href="/blog/assets/js/190.52af3d91.js"><link rel="prefetch" href="/blog/assets/js/191.daac205d.js"><link rel="prefetch" href="/blog/assets/js/192.8735a570.js"><link rel="prefetch" href="/blog/assets/js/193.0619ad3e.js"><link rel="prefetch" href="/blog/assets/js/194.83e05501.js"><link rel="prefetch" href="/blog/assets/js/195.d3c64566.js"><link rel="prefetch" href="/blog/assets/js/196.bff584ec.js"><link rel="prefetch" href="/blog/assets/js/197.2db9e539.js"><link rel="prefetch" href="/blog/assets/js/198.2cde63d5.js"><link rel="prefetch" href="/blog/assets/js/199.01c57daa.js"><link rel="prefetch" href="/blog/assets/js/200.c5041eec.js"><link rel="prefetch" href="/blog/assets/js/201.a3c96a9f.js"><link rel="prefetch" href="/blog/assets/js/202.c382b0c1.js"><link rel="prefetch" href="/blog/assets/js/203.56dd6c0b.js"><link rel="prefetch" href="/blog/assets/js/204.cd7bd9b2.js"><link rel="prefetch" href="/blog/assets/js/205.f8ba82b1.js"><link rel="prefetch" href="/blog/assets/js/206.1f62843b.js"><link rel="prefetch" href="/blog/assets/js/207.91b1d1d9.js"><link rel="prefetch" href="/blog/assets/js/208.e8d0fc56.js"><link rel="prefetch" href="/blog/assets/js/209.f4613282.js"><link rel="prefetch" href="/blog/assets/js/21.bf0041b7.js"><link rel="prefetch" href="/blog/assets/js/210.27d0e36b.js"><link rel="prefetch" href="/blog/assets/js/211.0dad5495.js"><link rel="prefetch" href="/blog/assets/js/212.6ff2cec6.js"><link rel="prefetch" href="/blog/assets/js/22.48390d4f.js"><link rel="prefetch" href="/blog/assets/js/23.35c4ba93.js"><link rel="prefetch" href="/blog/assets/js/24.5dc212cd.js"><link rel="prefetch" href="/blog/assets/js/25.01cde98b.js"><link rel="prefetch" href="/blog/assets/js/26.51647c2f.js"><link rel="prefetch" href="/blog/assets/js/27.b0efe319.js"><link rel="prefetch" href="/blog/assets/js/28.6ae36e8b.js"><link rel="prefetch" href="/blog/assets/js/29.09981e94.js"><link rel="prefetch" href="/blog/assets/js/3.cb0627fa.js"><link rel="prefetch" href="/blog/assets/js/30.bcafbd5b.js"><link rel="prefetch" href="/blog/assets/js/31.b99dc8e5.js"><link rel="prefetch" href="/blog/assets/js/32.aaa83642.js"><link rel="prefetch" href="/blog/assets/js/33.84478543.js"><link rel="prefetch" href="/blog/assets/js/34.fa4f18d6.js"><link rel="prefetch" href="/blog/assets/js/35.0835b775.js"><link rel="prefetch" href="/blog/assets/js/36.8f409625.js"><link rel="prefetch" href="/blog/assets/js/37.37e725fb.js"><link rel="prefetch" href="/blog/assets/js/38.f70df6b0.js"><link rel="prefetch" href="/blog/assets/js/39.c62ad3ad.js"><link rel="prefetch" href="/blog/assets/js/4.cbb57fa7.js"><link rel="prefetch" href="/blog/assets/js/40.fa1e4cd7.js"><link rel="prefetch" href="/blog/assets/js/41.b0b54a79.js"><link rel="prefetch" href="/blog/assets/js/42.38f97c50.js"><link rel="prefetch" href="/blog/assets/js/43.c0d731cf.js"><link rel="prefetch" href="/blog/assets/js/44.1ada494a.js"><link rel="prefetch" href="/blog/assets/js/45.f9f0d1d3.js"><link rel="prefetch" href="/blog/assets/js/46.f61ebf44.js"><link rel="prefetch" href="/blog/assets/js/47.1e3244f7.js"><link rel="prefetch" href="/blog/assets/js/48.d5d6e9cf.js"><link rel="prefetch" href="/blog/assets/js/49.874c0d73.js"><link rel="prefetch" href="/blog/assets/js/5.fe065607.js"><link rel="prefetch" href="/blog/assets/js/50.2bde8ac3.js"><link rel="prefetch" href="/blog/assets/js/51.e6c26277.js"><link rel="prefetch" href="/blog/assets/js/52.b5171a6c.js"><link rel="prefetch" href="/blog/assets/js/53.5e07287e.js"><link rel="prefetch" href="/blog/assets/js/54.33ff2540.js"><link rel="prefetch" href="/blog/assets/js/55.ec9542b6.js"><link rel="prefetch" href="/blog/assets/js/56.d99bf778.js"><link rel="prefetch" href="/blog/assets/js/57.6f4b13ff.js"><link rel="prefetch" href="/blog/assets/js/58.63a8354d.js"><link rel="prefetch" href="/blog/assets/js/59.af80b9ec.js"><link rel="prefetch" href="/blog/assets/js/6.68cda050.js"><link rel="prefetch" href="/blog/assets/js/60.63c1fc8d.js"><link rel="prefetch" href="/blog/assets/js/61.b3a0847f.js"><link rel="prefetch" href="/blog/assets/js/62.4ae929a2.js"><link rel="prefetch" href="/blog/assets/js/63.0f8029d4.js"><link rel="prefetch" href="/blog/assets/js/64.69daf65d.js"><link rel="prefetch" href="/blog/assets/js/65.cd1bf692.js"><link rel="prefetch" href="/blog/assets/js/66.5c506ec8.js"><link rel="prefetch" href="/blog/assets/js/67.e76ea4c3.js"><link rel="prefetch" href="/blog/assets/js/68.50e5e983.js"><link rel="prefetch" href="/blog/assets/js/69.d3d5ee70.js"><link rel="prefetch" href="/blog/assets/js/7.3b8d63a0.js"><link rel="prefetch" href="/blog/assets/js/70.9d2c5ae6.js"><link rel="prefetch" href="/blog/assets/js/71.1ff968ec.js"><link rel="prefetch" href="/blog/assets/js/72.a5c66acf.js"><link rel="prefetch" href="/blog/assets/js/73.beb7a9f7.js"><link rel="prefetch" href="/blog/assets/js/74.30f7ec1e.js"><link rel="prefetch" href="/blog/assets/js/75.50b2e636.js"><link rel="prefetch" href="/blog/assets/js/76.e4a2de98.js"><link rel="prefetch" href="/blog/assets/js/77.695fe053.js"><link rel="prefetch" href="/blog/assets/js/78.91e5a782.js"><link rel="prefetch" href="/blog/assets/js/79.b216b823.js"><link rel="prefetch" href="/blog/assets/js/80.c2247050.js"><link rel="prefetch" href="/blog/assets/js/81.f167f26a.js"><link rel="prefetch" href="/blog/assets/js/82.b4d5e9c9.js"><link rel="prefetch" href="/blog/assets/js/83.297d7d3d.js"><link rel="prefetch" href="/blog/assets/js/84.7f7e2cd1.js"><link rel="prefetch" href="/blog/assets/js/85.72b43fe6.js"><link rel="prefetch" href="/blog/assets/js/86.0b4102e0.js"><link rel="prefetch" href="/blog/assets/js/87.707e49df.js"><link rel="prefetch" href="/blog/assets/js/88.d3bd696a.js"><link rel="prefetch" href="/blog/assets/js/89.9c611b54.js"><link rel="prefetch" href="/blog/assets/js/90.001805e9.js"><link rel="prefetch" href="/blog/assets/js/91.3b5b43f2.js"><link rel="prefetch" href="/blog/assets/js/92.70cd30f9.js"><link rel="prefetch" href="/blog/assets/js/93.4e138a06.js"><link rel="prefetch" href="/blog/assets/js/94.0d5ed05c.js"><link rel="prefetch" href="/blog/assets/js/95.07a70e9a.js"><link rel="prefetch" href="/blog/assets/js/96.34b29a24.js"><link rel="prefetch" href="/blog/assets/js/97.af74319a.js"><link rel="prefetch" href="/blog/assets/js/98.f2f367d9.js"><link rel="prefetch" href="/blog/assets/js/99.a1c21720.js"><link rel="prefetch" href="/blog/assets/js/vendors~docsearch.bd3cdb54.js">
    <link rel="stylesheet" href="/blog/assets/css/0.styles.7b6e3ec2.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/blog/" class="home-link router-link-active"><img src="/blog/logo.png" alt="前端那些事儿" class="logo"> <span class="site-name can-hide">前端那些事儿</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/blog/" class="nav-link">
  主页
</a></div><div class="nav-item"><a href="/blog/base/" class="nav-link">
  前端基础
</a></div><div class="nav-item"><a href="/blog/vue/" class="nav-link router-link-active">
  Vue
</a></div><div class="nav-item"><a href="/blog/react/" class="nav-link">
  React
</a></div><div class="nav-item"><a href="/blog/node/" class="nav-link">
  Node
</a></div><div class="nav-item"><a href="/blog/devops/" class="nav-link">
  前端工程化
</a></div><div class="nav-item"><a href="/blog/mobile/" class="nav-link">
  泛客户端
</a></div><div class="nav-item"><a href="/blog/architecture/" class="nav-link">
  架构&amp;方案
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="GitHub" class="dropdown-title"><span class="title">GitHub</span> <span class="arrow down"></span></button> <button type="button" aria-label="GitHub" class="mobile-dropdown-title"><span class="title">GitHub</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/jonny-wei" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://github.com/jonny-wei/sushi-js" target="_blank" rel="noopener noreferrer" class="nav-link external">
  JS 寿司
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/blog/" class="nav-link">
  主页
</a></div><div class="nav-item"><a href="/blog/base/" class="nav-link">
  前端基础
</a></div><div class="nav-item"><a href="/blog/vue/" class="nav-link router-link-active">
  Vue
</a></div><div class="nav-item"><a href="/blog/react/" class="nav-link">
  React
</a></div><div class="nav-item"><a href="/blog/node/" class="nav-link">
  Node
</a></div><div class="nav-item"><a href="/blog/devops/" class="nav-link">
  前端工程化
</a></div><div class="nav-item"><a href="/blog/mobile/" class="nav-link">
  泛客户端
</a></div><div class="nav-item"><a href="/blog/architecture/" class="nav-link">
  架构&amp;方案
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="GitHub" class="dropdown-title"><span class="title">GitHub</span> <span class="arrow down"></span></button> <button type="button" aria-label="GitHub" class="mobile-dropdown-title"><span class="title">GitHub</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/jonny-wei" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://github.com/jonny-wei/sushi-js" target="_blank" rel="noopener noreferrer" class="nav-link external">
  JS 寿司
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Vue</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/vue/" aria-current="page" class="sidebar-link">Vue 组件通信</a></li><li><a href="/blog/vue/warmup/vue-symbols.html" class="sidebar-link">Vue 修饰符</a></li><li><a href="/blog/vue/warmup/vue-optimization.html" class="sidebar-link">Vue 相关优化</a></li><li><a href="/blog/vue/warmup/vue-router.html" class="sidebar-link">VueRouter 核心原理</a></li><li><a href="/blog/vue/warmup/vue-vuex.html" class="sidebar-link">Vuex 实现原理</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Vue源码解析</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/vue/vue/github.html" class="sidebar-link">源码学习</a></li><li><a href="/blog/vue/vue/vue-render.html" class="sidebar-link">渲染器</a></li><li><a href="/blog/vue/vue/vue-init.html" class="sidebar-link">构建与初始化</a></li><li><a href="/blog/vue/vue/vue-component.html" class="sidebar-link">组件化过程</a></li><li><a href="/blog/vue/vue/vue-observer.html" class="sidebar-link">响应式原理</a></li><li><a href="/blog/vue/vue/vue-template.html" class="sidebar-link">模板编译与渲染</a></li><li><a href="/blog/vue/vue/vue-diff.html" class="sidebar-link">虚拟 DOM 与 Diff 算法</a></li><li><a href="/blog/vue/vue/vue-nextTick.html" class="sidebar-link">异步更新队列</a></li><li><a href="/blog/vue/vue/vue-lifecycle.html" class="sidebar-link">生命周期</a></li><li><a href="/blog/vue/vue/vue-computed.html" class="sidebar-link">计算属性与侦听器</a></li><li><a href="/blog/vue/vue/vue-slot.html" class="sidebar-link">插槽</a></li><li><a href="/blog/vue/vue/vue-directive.html" class="sidebar-link">Vue 指令</a></li><li><a href="/blog/vue/vue/vue-event.html" class="sidebar-link">事件绑定原理</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>VueRouter源码解析</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/vue/vue-router/abstract.html" class="sidebar-link">摘要</a></li><li><a href="/blog/vue/vue-router/warmUp.html" class="sidebar-link">准备工作</a></li><li><a href="/blog/vue/vue-router/plugin.html" class="sidebar-link">插件机制</a></li><li><a href="/blog/vue/vue-router/initialization.html" class="sidebar-link">初始化与降级处理</a></li><li><a href="/blog/vue/vue-router/transitions.html" class="sidebar-link">路由过渡与视图渲染</a></li><li><a href="/blog/vue/vue-router/match.html" class="sidebar-link">路由匹配</a></li><li><a href="/blog/vue/vue-router/summary.html" class="sidebar-link">总结</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Vuex源码解析</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/vue/vuex/abstract.html" class="sidebar-link">摘要</a></li><li><a href="/blog/vue/vuex/warmUp.html" class="sidebar-link">准备工作</a></li><li><a href="/blog/vue/vuex/initialization.html" class="sidebar-link">初始化与模块安装</a></li><li><a href="/blog/vue/vuex/state.html" class="sidebar-link">State 相关</a></li><li><a href="/blog/vue/vuex/getters.html" class="sidebar-link">Getters 相关</a></li><li><a href="/blog/vue/vuex/mutations.html" class="sidebar-link">Mutations 相关</a></li><li><a href="/blog/vue/vuex/actions.html" class="sidebar-link">Actions 相关</a></li><li><a href="/blog/vue/vuex/modules.html" class="sidebar-link">Modules 相关</a></li><li><a href="/blog/vue/vuex/others.html" class="sidebar-link">其他</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Vue3新特性</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/vue/vue3.x/reactivity.html" class="sidebar-link">响应式系统方面</a></li><li><a href="/blog/vue/vue3.x/features.html" class="sidebar-link">功能方面</a></li><li><a href="/blog/vue/vue3.x/performance.html" class="sidebar-link">性能方面</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>VueNext</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/vue/vue3/reactivity.html" class="sidebar-link">设计响应式系统</a></li><li><a href="/blog/vue/vue3/diff.html" class="sidebar-link">快速 Diff 算法</a></li><li><a href="/blog/vue/vue3/components.html" aria-current="page" class="active sidebar-link">组件化原理</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/vue/vue3/components.html#组件化过程与更新" class="sidebar-link">组件化过程与更新</a></li><li class="sidebar-sub-header"><a href="/blog/vue/vue3/components.html#setup-函数的作用与实现" class="sidebar-link">setup 函数的作用与实现</a></li><li class="sidebar-sub-header"><a href="/blog/vue/vue3/components.html#组件事件与-emit-的实现" class="sidebar-link">组件事件与 emit 的实现</a></li><li class="sidebar-sub-header"><a href="/blog/vue/vue3/components.html#插槽的原理与实现" class="sidebar-link">插槽的原理与实现</a></li><li class="sidebar-sub-header"><a href="/blog/vue/vue3/components.html#注册生命周期" class="sidebar-link">注册生命周期</a></li><li class="sidebar-sub-header"><a href="/blog/vue/vue3/components.html#ssr" class="sidebar-link">SSR</a></li></ul></li><li><a href="/blog/vue/vue3/inner-components.html" class="sidebar-link">异步与内置组件</a></li><li><a href="/blog/vue/vue3/compiler.html" class="sidebar-link">模板编译与优化</a></li><li><a href="/blog/vue/vue3/hooks.html" class="sidebar-link">Hooks</a></li><li><a href="/blog/vue/vue3/vue-router4.html" class="sidebar-link">VueRouter-V4 原理</a></li><li><a href="/blog/vue/vue3/pinia.html" class="sidebar-link">Pinia 原理</a></li><li><a href="/blog/vue/vue3/ssr.html" class="sidebar-link">Vue SSR</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="组件化原理"><a href="#组件化原理" class="header-anchor">#</a> 组件化原理</h1> <ul><li>组件化的过程是什么？</li> <li>组件是如何挂载渲染和更新的？</li> <li>组件的生命周期是如何执行的？</li> <li>组件被动更新过程是什么？</li> <li><code>setup</code> 的作用是什么，是如何实现的？</li> <li>组件的事件和 emit 是如何实现的？</li> <li>插槽的原理是什么，如何实现的？</li> <li>生命周期是如何注册的？</li></ul> <h2 id="组件化过程与更新"><a href="#组件化过程与更新" class="header-anchor">#</a> 组件化过程与更新</h2> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 任务队列，使用 Set 数据结构自动去重</span>
<span class="token keyword">const</span> queue <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 标志变量，用于避免重复刷新队列</span>
<span class="token keyword">let</span> isFlushing <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token comment">// 立即 resolve 的 Promise 实例，用于在微任务中执行任务</span>
<span class="token keyword">const</span> p <span class="token operator">=</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 任务调度器 将任务加入队列并在微任务中执行</span>
<span class="token keyword">function</span> <span class="token function">queueJob</span><span class="token punctuation">(</span><span class="token parameter">job</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>queue<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>job<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    queue<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>job<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isFlushing<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      isFlushing <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
      p<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
          <span class="token comment">// 执行任务队列中的所有任务</span>
          queue<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">job</span> <span class="token operator">=&gt;</span> <span class="token function">job</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
          isFlushing <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
          queue<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// resolveProps 函数用于解析组件 props 和 attrs 数据</span>
<span class="token keyword">function</span> <span class="token function">resolveProps</span><span class="token punctuation">(</span><span class="token parameter">options<span class="token punctuation">,</span> propsData</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> props <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> attrs <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">// 遍历为组件传递的 props 数据</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> key <span class="token keyword">in</span> propsData<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 以字符串 on 开头的 props，无论是否显式地声明，都将其添加到 props 数据中，而不是添加到 attrs 中</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>key <span class="token keyword">in</span> options <span class="token operator">||</span> key<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">'on'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      props<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> propsData<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      attrs<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> propsData<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 最后返回 props 与 attrs 数据</span>
  <span class="token keyword">return</span> <span class="token punctuation">[</span>props<span class="token punctuation">,</span> attrs<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 检查 props 是否发生变化</span>
<span class="token keyword">function</span> <span class="token function">hasPropsChanged</span><span class="token punctuation">(</span><span class="token parameter">prevProps<span class="token punctuation">,</span> nextProps</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> nextKeys <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>nextProps<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 如果新旧 props 的数量变了，则说明有变化</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>nextKeys<span class="token punctuation">.</span>length <span class="token operator">!==</span> Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>prevProps<span class="token punctuation">)</span><span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 检查每个 prop 是否有变化</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> nextKeys<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> key <span class="token operator">=</span> nextKeys<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token comment">// 有不相等的 props，则说明有变化</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>nextProps<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">!==</span> prevProps<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 当前组件实例的全局变量</span>
<span class="token keyword">let</span> currentInstance <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token comment">// 设置当前组件实例的函数</span>
<span class="token keyword">function</span> <span class="token function">setCurrentInstance</span><span class="token punctuation">(</span><span class="token parameter">instance</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  currentInstance <span class="token operator">=</span> instance<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// onMounted 函数，用于注册 mounted 生命周期钩子</span>
<span class="token keyword">function</span> <span class="token function">onMounted</span><span class="token punctuation">(</span><span class="token parameter">fn</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>currentInstance<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 将生命周期函数添加到 instance.mounted 数组中</span>
    currentInstance<span class="token punctuation">.</span>mounted<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">'onMounted 函数只能在 setup 中调用'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 挂载组件</span>
<span class="token keyword">function</span> <span class="token function">mountComponent</span><span class="token punctuation">(</span><span class="token parameter">vnode<span class="token punctuation">,</span> container<span class="token punctuation">,</span> anchor</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 从虚拟节点中获取组件选项对象</span>
  <span class="token keyword">const</span> componentOptions <span class="token operator">=</span> vnode<span class="token punctuation">.</span>type<span class="token punctuation">;</span>
  <span class="token comment">// 从组件选项对象中提取各种生命周期钩子和方法</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> render<span class="token punctuation">,</span> data<span class="token punctuation">,</span> setup<span class="token punctuation">,</span> <span class="token literal-property property">props</span><span class="token operator">:</span> propsOption<span class="token punctuation">,</span> beforeCreate<span class="token punctuation">,</span> created<span class="token punctuation">,</span> beforeMount<span class="token punctuation">,</span> mounted<span class="token punctuation">,</span> beforeUpdate<span class="token punctuation">,</span> updated <span class="token punctuation">}</span> <span class="token operator">=</span> componentOptions<span class="token punctuation">;</span>

  <span class="token comment">// 调用 beforeCreate 钩子</span>
  beforeCreate <span class="token operator">&amp;&amp;</span> <span class="token function">beforeCreate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 将 data 函数返回的数据转换为响应式对象</span>
  <span class="token keyword">const</span> state <span class="token operator">=</span> data <span class="token operator">?</span> <span class="token function">reactive</span><span class="token punctuation">(</span><span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

  <span class="token comment">// 调用 resolveProps 函数解析出最终的 props 数据与 attrs 数据</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>props<span class="token punctuation">,</span> attrs<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">resolveProps</span><span class="token punctuation">(</span>propsOption<span class="token punctuation">,</span> vnode<span class="token punctuation">.</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 直接使用编译好的 vnode.children 对象作为 slots 对象</span>
  <span class="token keyword">const</span> slots <span class="token operator">=</span> vnode<span class="token punctuation">.</span>children <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">// 创建组件实例对象，并将组件实例绑定到虚拟节点上</span>
  <span class="token keyword">const</span> instance <span class="token operator">=</span> <span class="token punctuation">{</span>
    state<span class="token punctuation">,</span> <span class="token comment">// 组件自身状态</span>
    <span class="token literal-property property">props</span><span class="token operator">:</span> <span class="token function">shallowReactive</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// 将解析出的 props 数据包装为浅响应式并定义到组件实例上</span>
    <span class="token literal-property property">isMounted</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token comment">// 是否已挂载</span>
    <span class="token literal-property property">subTree</span><span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token comment">// 组件所渲染的内容</span>
    attrs<span class="token punctuation">,</span> <span class="token comment">// 保存 attrs 数据</span>
    slots<span class="token punctuation">,</span> <span class="token comment">// 保存 slots 数据</span>
    <span class="token comment">// 在组件实例中添加 mounted 数组，用来存储通过 onMounted 函数注册的生命周期钩子函数</span>
    <span class="token literal-property property">mounted</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  vnode<span class="token punctuation">.</span>component <span class="token operator">=</span> instance<span class="token punctuation">;</span>

  <span class="token comment">// 定义 emit 函数，它接收两个参数</span>
  <span class="token comment">// event: 事件名称</span>
  <span class="token comment">// payload: 传递给事件处理函数的参数</span>
  <span class="token keyword">function</span> <span class="token function">emit</span><span class="token punctuation">(</span><span class="token parameter">event<span class="token punctuation">,</span> <span class="token operator">...</span>payload</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 根据约定对事件名称进行处理，例如 change --&gt; onChange</span>
    <span class="token keyword">const</span> eventName <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">on</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>event<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">toUpperCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> event<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
    <span class="token comment">// 根据处理后的事件名称去 props 中寻找对应的事件处理函数</span>
    <span class="token keyword">const</span> handler <span class="token operator">=</span> instance<span class="token punctuation">.</span>props<span class="token punctuation">[</span>eventName<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>handler<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 调用事件处理函数并传递参数</span>
      <span class="token function">handler</span><span class="token punctuation">(</span><span class="token operator">...</span>payload<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">事件 </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>event<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> 不存在</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// setupContext，包含 attrs、emit、slots</span>
  <span class="token keyword">const</span> setupContext <span class="token operator">=</span> <span class="token punctuation">{</span> attrs<span class="token punctuation">,</span> emit<span class="token punctuation">,</span> slots <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">// 在调用 setup 函数之前，设置当前组件实例</span>
  <span class="token function">setCurrentInstance</span><span class="token punctuation">(</span>instance<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 调用 setup 函数，将只读版本的 props 作为第一个参数传递，避免用户意外地修改 props 的值，</span>
  <span class="token keyword">const</span> setupResult <span class="token operator">=</span> <span class="token function">setup</span><span class="token punctuation">(</span><span class="token function">shallowReadonly</span><span class="token punctuation">(</span>instance<span class="token punctuation">.</span>props<span class="token punctuation">)</span><span class="token punctuation">,</span> setupContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 在 setup 函数执行完毕之后，重置当前组件实例</span>
  <span class="token function">setCurrentInstance</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// setupState 用来存储由 setup 返回的数据</span>
  <span class="token keyword">let</span> setupState <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

  <span class="token comment">// 如果 setup 函数的返回值是函数，则将其作为渲染函数</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> setupResult <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 报告冲突</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>render<span class="token punctuation">)</span> console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">'setup 函数返回渲染函数，render 选项将被忽略'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 将 setupResult 作为渲染函数</span>
    render <span class="token operator">=</span> setupResult<span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// 如果 setup 的返回值不是函数，则作为数据状态赋值给 setupState</span>
    setupState <span class="token operator">=</span> setupResult<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 创建渲染上下文对象，本质上是组件实例的代理</span>
  <span class="token keyword">const</span> renderContext <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>instance<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token function">get</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> k<span class="token punctuation">,</span> r<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> <span class="token punctuation">{</span> state<span class="token punctuation">,</span> props<span class="token punctuation">,</span> slots<span class="token punctuation">,</span> setupState <span class="token punctuation">}</span> <span class="token operator">=</span> t<span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>state <span class="token operator">&amp;&amp;</span> k <span class="token keyword">in</span> state<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 自身 state</span>
        <span class="token keyword">return</span> state<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>k <span class="token keyword">in</span> props<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// props</span>
        <span class="token keyword">return</span> props<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>k <span class="token operator">===</span> <span class="token string">'$slots'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 插槽</span>
        <span class="token keyword">return</span> slots<span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>setupState <span class="token operator">&amp;&amp;</span> k <span class="token keyword">in</span> setupState<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// setupState</span>
        <span class="token keyword">return</span> setupState<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Property '</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>k<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">' does not exist on the component instance.</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function">set</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> k<span class="token punctuation">,</span> v<span class="token punctuation">,</span> r<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> <span class="token punctuation">{</span> state<span class="token punctuation">,</span> props<span class="token punctuation">,</span> setupState <span class="token punctuation">}</span> <span class="token operator">=</span> t<span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>state <span class="token operator">&amp;&amp;</span> k <span class="token keyword">in</span> state<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        state<span class="token punctuation">[</span>k<span class="token punctuation">]</span> <span class="token operator">=</span> v<span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>k <span class="token keyword">in</span> props<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Attempting to mutate prop &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>k<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;. Props are readonly.</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>setupState <span class="token operator">&amp;&amp;</span> k <span class="token keyword">in</span> setupState<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// setupState</span>
        setupState<span class="token punctuation">[</span>k<span class="token punctuation">]</span> <span class="token operator">=</span> v<span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Property '</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>k<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">' does not exist on the component instance.</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 生命周期钩子调用时要绑定渲染上下文对象</span>
  created <span class="token operator">&amp;&amp;</span> <span class="token function">created</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>renderContext<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 创建一个响应式副作用函数，用于组件的渲染和更新，实现组件的自更新</span>
  <span class="token function">effect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// 获取子树渲染内容，this 指向 renderContext，使得 render 函数中通过 this 访问组件自身状态和 props</span>
    <span class="token keyword">const</span> subTree <span class="token operator">=</span> <span class="token function">render</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>renderContext<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>instance<span class="token punctuation">.</span>isMounted<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 调用 beforeMount 钩子</span>
      beforeMount <span class="token operator">&amp;&amp;</span> <span class="token function">beforeMount</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>renderContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 将虚拟 DOM 挂载到容器中，初次挂载第一参数组件实例为 null</span>
      <span class="token function">patch</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> subTree<span class="token punctuation">,</span> container<span class="token punctuation">,</span> anchor<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 防止更新时再次挂载</span>
      instance<span class="token punctuation">.</span>isMounted <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
      <span class="token comment">// 调用 mounted 钩子</span>
      mounted <span class="token operator">&amp;&amp;</span> <span class="token function">mounted</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>renderContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 遍历 instance.mounted 数组并逐个执行即可</span>
      instance<span class="token punctuation">.</span>mounted <span class="token operator">&amp;&amp;</span> instance<span class="token punctuation">.</span>mounted<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">hook</span> <span class="token operator">=&gt;</span> <span class="token function">hook</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>renderContext<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// 调用 beforeUpdate 钩子</span>
      beforeUpdate <span class="token operator">&amp;&amp;</span> <span class="token function">beforeUpdate</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>renderContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 更新虚拟 DOM，instance.subTree 上一次的子树(旧的)，需要更新的子树(新的)</span>
      <span class="token function">patch</span><span class="token punctuation">(</span>instance<span class="token punctuation">.</span>subTree<span class="token punctuation">,</span> subTree<span class="token punctuation">,</span> container<span class="token punctuation">,</span> anchor<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 调用 updated 钩子</span>
      updated <span class="token operator">&amp;&amp;</span> <span class="token function">updated</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>renderContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 更新组件实例的子树</span>
    instance<span class="token punctuation">.</span>subTree <span class="token operator">=</span> subTree<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">scheduler</span><span class="token operator">:</span> queueJob <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 更新组件</span>
<span class="token keyword">function</span> <span class="token function">patchComponent</span><span class="token punctuation">(</span><span class="token parameter">n1<span class="token punctuation">,</span> n2<span class="token punctuation">,</span> anchor</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 获取组件实例，即 n1.component，同时让新的组件虚拟节点 n2.component 也指向组件实例</span>
  <span class="token keyword">const</span> instance <span class="token operator">=</span> <span class="token punctuation">(</span>n2<span class="token punctuation">.</span>component <span class="token operator">=</span> n1<span class="token punctuation">.</span>component<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 获取当前的 props 数据</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> props <span class="token punctuation">}</span> <span class="token operator">=</span> instance<span class="token punctuation">;</span>

  <span class="token comment">// 调用 hasPropsChanged 检测为子组件传递的 props 是否发生变化，如果没有变化，则不需要更新</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">hasPropsChanged</span><span class="token punctuation">(</span>n1<span class="token punctuation">.</span>props<span class="token punctuation">,</span> n2<span class="token punctuation">.</span>props<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 调用 resolveProps 函数重新获取 props 数据</span>
    <span class="token keyword">const</span> <span class="token punctuation">[</span>nextProps<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">resolveProps</span><span class="token punctuation">(</span>n2<span class="token punctuation">.</span>type<span class="token punctuation">.</span>props<span class="token punctuation">,</span> n2<span class="token punctuation">.</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 更新 props</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> k <span class="token keyword">in</span> nextProps<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      props<span class="token punctuation">[</span>k<span class="token punctuation">]</span> <span class="token operator">=</span> nextProps<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 删除不存在的 props</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> k <span class="token keyword">in</span> props<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>k <span class="token keyword">in</span> nextProps<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">delete</span> props<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 调用 beforeUpdate 钩子</span>
  <span class="token keyword">const</span> renderContext <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>instance<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token function">get</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> k<span class="token punctuation">,</span> r<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> <span class="token punctuation">{</span> state<span class="token punctuation">,</span> props <span class="token punctuation">}</span> <span class="token operator">=</span> t<span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>state <span class="token operator">&amp;&amp;</span> k <span class="token keyword">in</span> state<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> state<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>k <span class="token keyword">in</span> props<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> props<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>instance<span class="token punctuation">.</span>setupState <span class="token operator">&amp;&amp;</span> k <span class="token keyword">in</span> instance<span class="token punctuation">.</span>setupState<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 渲染上下文需要增加对 setupState 的支持</span>
        <span class="token keyword">return</span> instance<span class="token punctuation">.</span>setupState<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Property '</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>k<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">' does not exist on the component instance.</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function">set</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> k<span class="token punctuation">,</span> v<span class="token punctuation">,</span> r<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> <span class="token punctuation">{</span> state<span class="token punctuation">,</span> props <span class="token punctuation">}</span> <span class="token operator">=</span> t<span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>state <span class="token operator">&amp;&amp;</span> k <span class="token keyword">in</span> state<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        state<span class="token punctuation">[</span>k<span class="token punctuation">]</span> <span class="token operator">=</span> v<span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>k <span class="token keyword">in</span> props<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Attempting to mutate prop &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>k<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;. Props are readonly.</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>instance<span class="token punctuation">.</span>setupState <span class="token operator">&amp;&amp;</span> k <span class="token keyword">in</span> instance<span class="token punctuation">.</span>setupState<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 渲染上下文需要增加对 setupState 的支持</span>
        instance<span class="token punctuation">.</span>setupState<span class="token punctuation">[</span>k<span class="token punctuation">]</span> <span class="token operator">=</span> v<span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Property '</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>k<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">' does not exist on the component instance.</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 调用 beforeUpdate 钩子</span>
  instance<span class="token punctuation">.</span>type<span class="token punctuation">.</span>beforeUpdate <span class="token operator">&amp;&amp;</span> instance<span class="token punctuation">.</span>type<span class="token punctuation">.</span><span class="token function">beforeUpdate</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>renderContext<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 更新子树</span>
  <span class="token function">patch</span><span class="token punctuation">(</span>instance<span class="token punctuation">.</span>subTree<span class="token punctuation">,</span> n2<span class="token punctuation">.</span>type<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>renderContext<span class="token punctuation">)</span><span class="token punctuation">,</span> instance<span class="token punctuation">.</span>vnode<span class="token punctuation">.</span>el<span class="token punctuation">,</span> anchor<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 调用 updated 钩子</span>
  instance<span class="token punctuation">.</span>type<span class="token punctuation">.</span>updated <span class="token operator">&amp;&amp;</span> instance<span class="token punctuation">.</span>type<span class="token punctuation">.</span><span class="token function">updated</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>renderContext<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 更新组件实例的子树</span>
  instance<span class="token punctuation">.</span>subTree <span class="token operator">=</span> n2<span class="token punctuation">.</span>type<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>renderContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br><span class="line-number">156</span><br><span class="line-number">157</span><br><span class="line-number">158</span><br><span class="line-number">159</span><br><span class="line-number">160</span><br><span class="line-number">161</span><br><span class="line-number">162</span><br><span class="line-number">163</span><br><span class="line-number">164</span><br><span class="line-number">165</span><br><span class="line-number">166</span><br><span class="line-number">167</span><br><span class="line-number">168</span><br><span class="line-number">169</span><br><span class="line-number">170</span><br><span class="line-number">171</span><br><span class="line-number">172</span><br><span class="line-number">173</span><br><span class="line-number">174</span><br><span class="line-number">175</span><br><span class="line-number">176</span><br><span class="line-number">177</span><br><span class="line-number">178</span><br><span class="line-number">179</span><br><span class="line-number">180</span><br><span class="line-number">181</span><br><span class="line-number">182</span><br><span class="line-number">183</span><br><span class="line-number">184</span><br><span class="line-number">185</span><br><span class="line-number">186</span><br><span class="line-number">187</span><br><span class="line-number">188</span><br><span class="line-number">189</span><br><span class="line-number">190</span><br><span class="line-number">191</span><br><span class="line-number">192</span><br><span class="line-number">193</span><br><span class="line-number">194</span><br><span class="line-number">195</span><br><span class="line-number">196</span><br><span class="line-number">197</span><br><span class="line-number">198</span><br><span class="line-number">199</span><br><span class="line-number">200</span><br><span class="line-number">201</span><br><span class="line-number">202</span><br><span class="line-number">203</span><br><span class="line-number">204</span><br><span class="line-number">205</span><br><span class="line-number">206</span><br><span class="line-number">207</span><br><span class="line-number">208</span><br><span class="line-number">209</span><br><span class="line-number">210</span><br><span class="line-number">211</span><br><span class="line-number">212</span><br><span class="line-number">213</span><br><span class="line-number">214</span><br><span class="line-number">215</span><br><span class="line-number">216</span><br><span class="line-number">217</span><br><span class="line-number">218</span><br><span class="line-number">219</span><br><span class="line-number">220</span><br><span class="line-number">221</span><br><span class="line-number">222</span><br><span class="line-number">223</span><br><span class="line-number">224</span><br><span class="line-number">225</span><br><span class="line-number">226</span><br><span class="line-number">227</span><br><span class="line-number">228</span><br><span class="line-number">229</span><br><span class="line-number">230</span><br><span class="line-number">231</span><br><span class="line-number">232</span><br><span class="line-number">233</span><br><span class="line-number">234</span><br><span class="line-number">235</span><br><span class="line-number">236</span><br><span class="line-number">237</span><br><span class="line-number">238</span><br><span class="line-number">239</span><br><span class="line-number">240</span><br><span class="line-number">241</span><br><span class="line-number">242</span><br><span class="line-number">243</span><br><span class="line-number">244</span><br><span class="line-number">245</span><br><span class="line-number">246</span><br><span class="line-number">247</span><br><span class="line-number">248</span><br><span class="line-number">249</span><br><span class="line-number">250</span><br><span class="line-number">251</span><br><span class="line-number">252</span><br><span class="line-number">253</span><br><span class="line-number">254</span><br><span class="line-number">255</span><br><span class="line-number">256</span><br><span class="line-number">257</span><br><span class="line-number">258</span><br><span class="line-number">259</span><br><span class="line-number">260</span><br><span class="line-number">261</span><br><span class="line-number">262</span><br><span class="line-number">263</span><br><span class="line-number">264</span><br><span class="line-number">265</span><br><span class="line-number">266</span><br><span class="line-number">267</span><br><span class="line-number">268</span><br><span class="line-number">269</span><br><span class="line-number">270</span><br><span class="line-number">271</span><br><span class="line-number">272</span><br><span class="line-number">273</span><br><span class="line-number">274</span><br><span class="line-number">275</span><br><span class="line-number">276</span><br><span class="line-number">277</span><br><span class="line-number">278</span><br><span class="line-number">279</span><br><span class="line-number">280</span><br><span class="line-number">281</span><br><span class="line-number">282</span><br><span class="line-number">283</span><br></div></div><ul><li><strong><code>queueJob</code> 任务调度器的目的</strong>：组件自身的响应式数据发生变化，组件就会自动重新执行渲染函数，从而完成更新。但是，由于 effect 的执行是同步的，因此当响应式数据发生变化时，与之关联的副作用函数会同步执行。换句话说，如果多次修改响应式数据的值，将会导致渲染函数执行多次，这实际上是没有必要的。因此，我们需要设计一个机制，以使得无论对响应式数据进行多少次修改，副作用函数都只会重新执行一次。为此，我们需要实现一个调度器，当副作用函数需要重新执行时，我们不会立即执行它，而是将它缓冲到一个微任务队列中，等到执行栈清空后，再将它从微任务队列中取出并执行。有了缓存机制，我们就有机会对任务进行去重，从而避免多次执行副作用函数带来的性能开销。当响应式数据发生变化时，副作用函数不会立即同步执行，而是会被 queueJob 函数调度，最后在一个微任务中执行。</li> <li><strong>组件实例 <code>instance</code></strong>： 组件实例本质上就是一个状态集合（或一个对象）​，它维护着组件运行过程中的所有信息，例如注册到组件的生命周期函数、组件渲染的子树（subTree）​、组件是否已经被挂载、组件自身的状态（data）​，等等。</li> <li><strong>组件的被动更新</strong>：props 本质上是父组件的数据，当 props 发生变化时，会触发父组件重新渲染，父组件会进行自更新。在更新过程中，渲染器发现父组件的 subTree 包含组件类型的虚拟节点，所以会调用 <code>patchComponent</code> 函数完成子组件的更新。所以，把由父组件自更新所引起的子组件更新叫作子组件的被动更新。当子组件发生被动更新时，我们需要做的是：
<ul><li>检测子组件是否真的需要更新，因为子组件的 props 可能是不变的；</li> <li>如果需要更新，则更新子组件的 props、slots 等内容。</li></ul></li> <li><strong>props 浅响应式</strong>：<code>instance.props</code> 对象本身是浅响应的（即<code>shallowReactive</code>）​。因此，在更新组件的 <code>props</code> 时，只需要设置 <code>instance.props</code> 对象下的属性值即可触发组件重新渲染。</li> <li><strong>props 解析 resolveProps</strong>：解析组件的 props 和 attrs 数据，将 on 开头的 props 也视为有效的 props</li> <li><strong>渲染函数上下文对象 <code>renderContext</code></strong>： 由于 props 数据与组件自身的状态数据都需要暴露到渲染函数中，并使得渲染函数能够通过 this 访问它们，因此我们需要封装一个渲染上下文对象，其本质时组件实例的代理。它的意义在于拦截数据状态的读取和设置操作，每当在渲染函数或生命周期钩子中通过 this 来读取数据时，都会优先从组件的自身状态中读取，如果组件本身并没有对应的数据，则再从 props 数据中读取。最后我们将渲染上下文作为渲染函数以及生命周期钩子的 this 值即可。实际上，除了组件自身的数据以及 props 数据之外，完整的组件还包含 methods、computed 等选项中定义的数据和方法，这些内容都应该在渲染上下文对象中处理。</li></ul> <h2 id="setup-函数的作用与实现"><a href="#setup-函数的作用与实现" class="header-anchor">#</a> setup 函数的作用与实现</h2> <p>因为 setup 函数主要用于配合组合式 API，为用户提供一个地方，用于建立组合逻辑、创建响应式数据、创建通用函数、注册生命周期钩子等能力。在组件的整个生命周期中，setup 函数只会在被挂载时执行一次，它的返回值可以有两种情况。</p> <ol><li>返回一个函数，该函数将作为组件的 render 函数：常用于组件不是以模板来表达其渲染内容的情况。如果组件以模板来表达其渲染的内容，那么 setup 函数不可以再返回函数，否则会与模板编译生成的渲染函数产生冲突。</li> <li>返回一个对象，该对象中包含的数据将暴露给模板使用，setup 函数暴露的数据可以在渲染函数中通过 this 来访问。 另外，setup 函数接收两个参数。第一个参数是 props 数据对象，第二个参数也是一个对象，通常称为 setupContext。</li></ol> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 返回一个函数的情况</span>
<span class="token keyword">const</span> Comp1 <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token function">setup</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token punctuation">{</span> <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'div'</span><span class="token punctuation">,</span> <span class="token literal-property property">children</span><span class="token operator">:</span> <span class="token string">'hello'</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 返回一个对象的情况</span>
<span class="token keyword">const</span> Comp2 <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">props</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">foo</span><span class="token operator">:</span> String
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function">setup</span><span class="token punctuation">(</span><span class="token parameter">props<span class="token punctuation">,</span> setupContext</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> count <span class="token operator">=</span> <span class="token function">ref</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> slots<span class="token punctuation">,</span> emit<span class="token punctuation">,</span> attrs<span class="token punctuation">,</span> expose <span class="token punctuation">}</span> <span class="token operator">=</span> setupContext<span class="token punctuation">;</span>

    <span class="token comment">// 使用 props 访问父组件传递的数据</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>props<span class="token punctuation">.</span>foo<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 示例：打印传入的 prop</span>

    <span class="token comment">// 返回一个对象，其中的数据会被暴露给模板或渲染函数</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>
      count<span class="token punctuation">,</span>
      slots<span class="token punctuation">,</span>
      emit<span class="token punctuation">,</span>
      attrs<span class="token punctuation">,</span>
      expose
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 在渲染函数中，通过 this 访问 setup 中暴露的数据</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'div'</span><span class="token punctuation">,</span>
      <span class="token literal-property property">children</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">count is: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">this</span><span class="token punctuation">.</span>count<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>slots<span class="token punctuation">.</span>default <span class="token operator">?</span> <span class="token keyword">this</span><span class="token punctuation">.</span>slots<span class="token punctuation">.</span><span class="token function">default</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">null</span> <span class="token comment">// 渲染默认插槽（如果存在）</span>
      <span class="token punctuation">]</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br></div></div><ul><li><code>setupContext</code> 是一个对象，它包含了组件的一些上下文信息，通常在 setup 函数中使用。这个对象提供了以下属性：
<ul><li><code>attrs</code>: 包含所有未声明为 props 的属性。这些属性通常是由父组件传递给子组件的，但没有在 props 选项中声明。</li> <li><code>emit</code>: 一个函数，用于触发自定义事件。父组件可以通过监听这些事件来接收子组件的状态变化。</li> <li><code>slots</code>: 包含所有插槽内容的对象。插槽是 Vue 中的一种内容分发机制，允许父组件向子组件传递内容。</li></ul></li></ul> <ol start="2"><li><p><code>setupResult</code> 是 setup 函数的返回值。setup 函数可以返回以下几种类型的数据：</p> <ul><li><code>Object</code>: 返回一个对象，该对象中的属性和方法将被合并到组件实例中，可以在模板中直接使用。</li> <li><code>Function</code>: 返回一个渲染函数（render 函数），这个函数将被用作组件的渲染函数，替代 template 或 render 选项。</li></ul></li> <li><p><code>setupState</code> 是一个变量，用于存储 setup 函数返回的对象。如果 setup 函数返回的是一个对象，这个对象会被存储在 setupState 中，并且可以通过渲染上下文对象 renderContext 访问。</p></li> <li><p><code>setup</code> 函数的实现:</p></li></ol> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// setupContext，包含 attrs、emit 和 slots</span>
  <span class="token keyword">const</span> setupContext <span class="token operator">=</span> <span class="token punctuation">{</span> attrs<span class="token punctuation">,</span> <span class="token literal-property property">emit</span><span class="token operator">:</span> instance<span class="token punctuation">.</span>emit<span class="token punctuation">,</span> <span class="token literal-property property">slots</span><span class="token operator">:</span> instance<span class="token punctuation">.</span>slots <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">// 调用 setup 函数，将只读版本的 props 作为第一个参数传递，避免用户意外地修改 props 的值，</span>
  <span class="token comment">// 将 setupContext 作为第二个参数传递</span>
  <span class="token keyword">const</span> setupResult <span class="token operator">=</span> <span class="token function">setup</span><span class="token punctuation">(</span><span class="token function">shallowReadonly</span><span class="token punctuation">(</span>instance<span class="token punctuation">.</span>props<span class="token punctuation">)</span><span class="token punctuation">,</span> setupContext<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// setupState 用来存储由 setup 返回的数据</span>
  <span class="token keyword">let</span> setupState <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

  <span class="token comment">// 如果 setup 函数的返回值是函数，则将其作为渲染函数</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> setupResult <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 报告冲突</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>render<span class="token punctuation">)</span> console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">'setup 函数返回渲染函数，render 选项将被忽略'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 将 setupResult 作为渲染函数</span>
    render <span class="token operator">=</span> setupResult<span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// 如果 setup 的返回值不是函数，则作为数据状态赋值给 setupState</span>
    setupState <span class="token operator">=</span> setupResult<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><h2 id="组件事件与-emit-的实现"><a href="#组件事件与-emit-的实现" class="header-anchor">#</a> 组件事件与 emit 的实现</h2> <p><code>emit</code> 自定义事件的本质就是根据事件名称去 props 数据对象中寻找对应的事件处理函数并执行。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 定义 emit 函数，它接收两个参数</span>
  <span class="token comment">// event: 事件名称</span>
  <span class="token comment">// payload: 传递给事件处理函数的参数</span>
  <span class="token keyword">function</span> <span class="token function">emit</span><span class="token punctuation">(</span><span class="token parameter">event<span class="token punctuation">,</span> <span class="token operator">...</span>payload</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 根据约定对事件名称进行处理，例如 change --&gt; onChange</span>
    <span class="token keyword">const</span> eventName <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">on</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>event<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">toUpperCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> event<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
    <span class="token comment">// 根据处理后的事件名称去 props 中寻找对应的事件处理函数</span>
    <span class="token keyword">const</span> handler <span class="token operator">=</span> instance<span class="token punctuation">.</span>props<span class="token punctuation">[</span>eventName<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>handler<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 调用事件处理函数并传递参数</span>
      <span class="token function">handler</span><span class="token punctuation">(</span><span class="token operator">...</span>payload<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">事件 </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>event<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> 不存在</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 将 emit 函数添加到 setupContext 中，用户可以通过 setupContext 取得 emit 函数</span>
  <span class="token keyword">const</span> setupContext <span class="token operator">=</span> <span class="token punctuation">{</span> attrs<span class="token punctuation">,</span> emit<span class="token punctuation">,</span> slots <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">// 调用 setup 函数</span>
  <span class="token keyword">const</span> setupResult <span class="token operator">=</span> <span class="token function">setup</span><span class="token punctuation">(</span><span class="token function">shallowReadonly</span><span class="token punctuation">(</span>instance<span class="token punctuation">.</span>props<span class="token punctuation">)</span><span class="token punctuation">,</span> setupContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><p>整体实现并不复杂，只需要实现一个 <code>emit</code> 函数并将其添加到 <code>setupContext</code> 对象中，这样用户就可以通过 <code>setupContext</code> 取得 <code>emit</code> 函数了。另外，当 emit 函数被调用时，我们会根据约定对事件名称进行转换，以便能够在 <code>props</code> 数据对象中找到对应的事件处理函数。最后，调用事件处理函数并透传参数即可。</p> <p>这里有一点需要额外注意，我们在讲解 props 时提到，任何没有显式地声明为 <code>props</code> 的属性都会存储到 <code>attrs</code> 中。换句话说，任何事件类型的 props，即 <code>onXxx</code> 类的属性，都不会出现在 props 中。这导致我们无法根据事件名称在 <code>instance.props</code> 中找到对应的事件处理函数。</p> <p>为了解决这个问题，我们需要在解析 props 数据的时候对事件类型的 props 做特殊处理。通过检测 <code>propsData</code> 的 <code>key</code> 值来判断它是否以字符串 <code>on</code> 开头，如果是，则认为该属性是组件的自定义事件。这时，即使组件没有显式地将其声明为 props，我们也将它添加到最终解析的 props 数据对象中，而不是添加到 <code>attrs</code> 对象中。</p> <h2 id="插槽的原理与实现"><a href="#插槽的原理与实现" class="header-anchor">#</a> 插槽的原理与实现</h2> <p>组件件模板中的插槽内容会被编译为插槽函数，而插槽函数的返回值就是具体的插槽内容：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// MyComponent 组件模板的编译结果</span>
<span class="token keyword">function</span> <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'header'</span><span class="token punctuation">,</span>
      <span class="token literal-property property">children</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">.</span>$slots<span class="token punctuation">.</span><span class="token function">header</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'body'</span><span class="token punctuation">,</span>
      <span class="token literal-property property">children</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">.</span>$slots<span class="token punctuation">.</span><span class="token function">body</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'footer'</span><span class="token punctuation">,</span>
      <span class="token literal-property property">children</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">.</span>$slots<span class="token punctuation">.</span><span class="token function">footer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p>渲染插槽内容的过程，就是调用插槽函数并渲染由其返回的内容的过程。这与 React 中 <code>render props</code> 的概念非常相似。</p> <p>在运行时的实现上，插槽则依赖于 <code>setupContext</code> 中的 <code>slots</code> 对象。最基本的 slots 的实现非常简单。只需要将编译好的 <code>vnode.children</code> 作为 <code>slots</code> 对象，然后将 <code>slots</code> 对象添加到 <code>setupContext</code> 对象中。为了在 render 函数内和生命周期钩子函数内能够通过 <code>this.$slots</code> 来访问插槽内容，</p> <p>我们还需要在 renderContext 中特殊对待 <code>$slots</code> 属性。通过对渲染上下文 renderContext 代理对象的 <code>get</code> 拦截函数做了特殊处理，当读取的键是 <code>$slots</code> 时，直接返回组件实例上的 <code>slots</code> 对象，这样用户就可以通过 <code>this.$slots</code> 来访问插槽内容了。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">mountComponent</span><span class="token punctuation">(</span><span class="token parameter">vnode<span class="token punctuation">,</span> container<span class="token punctuation">,</span> anchor</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 省略部分代码</span>

  <span class="token keyword">const</span> slots <span class="token operator">=</span> vnode<span class="token punctuation">.</span>children <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> instance <span class="token operator">=</span> <span class="token punctuation">{</span>
    state<span class="token punctuation">,</span>
    <span class="token literal-property property">props</span><span class="token operator">:</span> <span class="token function">shallowReactive</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token literal-property property">isMounted</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    <span class="token literal-property property">subTree</span><span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    <span class="token comment">// 将插槽添加到组件实例上</span>
    slots
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">// 省略部分代码</span>

  <span class="token keyword">const</span> renderContext <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>instance<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token function">get</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> k<span class="token punctuation">,</span> r<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> <span class="token punctuation">{</span> state<span class="token punctuation">,</span> props<span class="token punctuation">,</span> slots <span class="token punctuation">}</span> <span class="token operator">=</span> t<span class="token punctuation">;</span>
      <span class="token comment">// 当 k 的值为 $slots 时，直接返回组件实例上的 slots</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>k <span class="token operator">===</span> <span class="token string">'$slots'</span><span class="token punctuation">)</span> <span class="token keyword">return</span> slots<span class="token punctuation">;</span>

      <span class="token comment">// 省略部分代码</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function">set</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> k<span class="token punctuation">,</span> v<span class="token punctuation">,</span> r<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 省略部分代码</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 省略部分代码</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br></div></div><h2 id="注册生命周期"><a href="#注册生命周期" class="header-anchor">#</a> 注册生命周期</h2> <p>在 setup 函数中调用 <code>onMounted</code> 函数即可注册 <code>mounted 生命周期钩子函数</code>，并且可以通过多次调用 <code>onMounted</code> 函数来注册多个钩子函数，这些函数会在组件被挂载之后再执行，问在于，在 A 组件的 setup 函数中调用 <code>onMounted</code> 函数会将该钩子函数注册到 A 组件上；而在 B 组件的 setup 函数中调用 <code>onMounted</code> 函数会将钩子函数注册到 B 组件上，这是如何实现的呢？</p> <p>我们需要维护一个变量 <code>currentInstance</code>，用它来存储当前组件实例，每当初始化组件并执行组件的 setup 函数之前，先将 <code>currentInstance</code> 设置为当前组件实例，再执行组件的 setup 函数，这样我们就可以通过 <code>currentInstance</code> 来获取当前正在被初始化的组件实例，从而将那些通过 onMounted 函数注册的钩子函数与组件实例进行关联。</p> <p>以 onMounted 生命周期钩子为例进行说明。为了存储由 onMounted 函数注册的生命周期钩子，我们需要在组件实例对象上添加 <code>instance.mounted</code> 数组。<strong>之所以 <code>instance.mounted</code> 的数据类型是数组，是因为在 setup 函数中，可以多次调用 onMounted 函数来注册不同的生命周期函数，这些生命周期函数都会存储在 <code>instance.mounted</code> 数组中</strong>。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">mountComponent</span><span class="token punctuation">(</span><span class="token parameter">vnode<span class="token punctuation">,</span> container<span class="token punctuation">,</span> anchor</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 省略部分代码</span>

  <span class="token keyword">const</span> instance <span class="token operator">=</span> <span class="token punctuation">{</span>
    state<span class="token punctuation">,</span>
    <span class="token literal-property property">props</span><span class="token operator">:</span> <span class="token function">shallowReactive</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token literal-property property">isMounted</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    <span class="token literal-property property">subTree</span><span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    slots<span class="token punctuation">,</span>
    <span class="token comment">// 在组件实例中添加 mounted 数组，用来存储通过 onMounted 函数注册的生命周期钩子函数</span>
    <span class="token literal-property property">mounted</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">// 省略部分代码</span>

  <span class="token comment">// setup</span>
  <span class="token keyword">const</span> setupContext <span class="token operator">=</span> <span class="token punctuation">{</span> attrs<span class="token punctuation">,</span> emit<span class="token punctuation">,</span> slots <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">// 在调用 setup 函数之前，设置当前组件实例</span>
  <span class="token function">setCurrentInstance</span><span class="token punctuation">(</span>instance<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 执行 setup 函数</span>
  <span class="token keyword">const</span> setupResult <span class="token operator">=</span> <span class="token function">setup</span><span class="token punctuation">(</span><span class="token function">shallowReadonly</span><span class="token punctuation">(</span>instance<span class="token punctuation">.</span>props<span class="token punctuation">)</span><span class="token punctuation">,</span> setupContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 在 setup 函数执行完毕之后，重置当前组件实例</span>
  <span class="token function">setCurrentInstance</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 省略部分代码</span>

  <span class="token comment">// 创建一个响应式副作用函数，用于组件的渲染和更新，实现组件的自更新</span>
  <span class="token function">effect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> subTree <span class="token operator">=</span> <span class="token function">render</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>renderContext<span class="token punctuation">,</span> renderContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>instance<span class="token punctuation">.</span>isMounted<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 省略部分代码</span>

      <span class="token comment">// 遍历 instance.mounted 数组并逐个执行即可</span>
      instance<span class="token punctuation">.</span>mounted <span class="token operator">&amp;&amp;</span> instance<span class="token punctuation">.</span>mounted<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">hook</span> <span class="token operator">=&gt;</span> <span class="token function">hook</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>renderContext<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// 省略部分代码</span>
    <span class="token punctuation">}</span>
    instance<span class="token punctuation">.</span>subTree <span class="token operator">=</span> subTree<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">scheduler</span><span class="token operator">:</span> queueJob
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br></div></div><p>对于除 <code>mounted</code> 以外的生命周期钩子函数，其原理同上.</p> <h2 id="ssr"><a href="#ssr" class="header-anchor">#</a> SSR</h2> <p>对于服务端渲染不，存在数据变更后的重新渲染，所以无须调用 reactive 函数对 data 等数据进行包装，也无须使用shallowReactive 函数对 props 数据进行包装。正因如此，我们也无须调用 beforeUpdate 和 updated 钩子。服务端渲染时，由于不需要渲染真实 DOM 元素，所以无须调用组件的 beforeMount 和 mounted 钩子。</p> <p>客户端激活的原理：在同构渲染过程中，组件的代码会分别在服务端和浏览器中执行一次。在服务端，组件会被渲染为静态的 HTML 字符串，并发送给浏览器。浏览器则会渲染由服务端返回的静态的 HTML 内容，并下载打包在静态资源中的组件代码。当下载完毕后，浏览器会解释并执行该组件代码。当组件代码在客户端执行时，由于页面中已经存在对应的 DOM 元素，所以渲染器并不会执行创建 DOM 元素的逻辑，而是会执行激活操作。激活操作可以总结为两个步骤：</p> <ul><li>在虚拟节点与真实 DOM 元素之间建立联系，即 <code>vnode.el =el</code>。这样才能保证后续更新程序正确运行。</li> <li>为 DOM 元素添加事件绑定。</li></ul> <p>SSR 开发需要注意：</p> <ul><li>组件的生命周期。beforeUpdate、updated、beforeMount、mounted、beforeUnmount、unmounted 等生命周期钩子函数不会在服务端执行。</li> <li>使用跨平台的 API。由于组件的代码既要在浏览器中运行，也要在服务器中运行，所以编写组件代码时，要额外注意代码的跨平台性。通常我们在选择第三方库的时候，会选择支持跨平台的库，例如使用 Axios 作为网络请求库。</li> <li>特定端的实现。无论在客户端还是在服务端，都应该保证功能的一致性。例如，组件需要读取 cookie 信息。在客户端，我们可以通过 document.cookie 来实现读取；而在服务端，则需要根据请求头来实现读取。所以，很多功能模块需要我们为客户端和服务端分别实现。</li> <li>避免交叉请求引起的状态污染。状态污染既可以是应用级的，也可以是模块级的。对于应用，我们应该为每一个请求创建一个独立的应用实例。对于模块，我们应该避免使用模块级的全局变量。这是因为在不做特殊处理的情况下，多个请求会共用模块级的全局变量，造成请求间的交叉污染。</li></ul></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/blog/vue/vue3/diff.html" class="prev">
        快速 Diff 算法
      </a></span> <span class="next"><a href="/blog/vue/vue3/inner-components.html">
        异步与内置组件
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----><!----><!----><!----></div></div>
    <script src="/blog/assets/js/app.e9b7ea63.js" defer></script><script src="/blog/assets/js/2.dec2e75d.js" defer></script><script src="/blog/assets/js/1.5b9e135c.js" defer></script><script src="/blog/assets/js/177.1a2283d9.js" defer></script><script src="/blog/assets/js/20.badbb211.js" defer></script>
  </body>
</html>
