<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Vue SSR | 前端那些事儿</title>
    <meta name="generator" content="VuePress 1.9.10">
    <link rel="icon" href="/blog/logo.png">
    <link rel="manifest" href="/blog/manifest.json">
    <link rel="apple-touch-icon" href="/blog/images/icons/apple-icon-152x152.png">
    <meta name="description" content="我命由我不由天，学习吧少年">
    <meta name="theme-color" content="#3eaf7c">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="msapplication-TileImage" content="/icons/ms-icon-144x144.png">
    <meta name="msapplication-TileColor" content="#000000">
    
    <link rel="preload" href="/blog/assets/css/0.styles.7b6e3ec2.css" as="style"><link rel="preload" href="/blog/assets/js/app.7d500235.js" as="script"><link rel="preload" href="/blog/assets/js/2.dec2e75d.js" as="script"><link rel="preload" href="/blog/assets/js/1.5b9e135c.js" as="script"><link rel="preload" href="/blog/assets/js/175.9b940dba.js" as="script"><link rel="preload" href="/blog/assets/js/20.badbb211.js" as="script"><link rel="prefetch" href="/blog/assets/js/10.cc7e09f3.js"><link rel="prefetch" href="/blog/assets/js/100.e883a701.js"><link rel="prefetch" href="/blog/assets/js/101.44648072.js"><link rel="prefetch" href="/blog/assets/js/102.28843225.js"><link rel="prefetch" href="/blog/assets/js/103.0a38691d.js"><link rel="prefetch" href="/blog/assets/js/104.5facf9f9.js"><link rel="prefetch" href="/blog/assets/js/105.4ec289e3.js"><link rel="prefetch" href="/blog/assets/js/106.7d96bf8d.js"><link rel="prefetch" href="/blog/assets/js/107.d6020f8b.js"><link rel="prefetch" href="/blog/assets/js/108.c35e6688.js"><link rel="prefetch" href="/blog/assets/js/109.0eb1751c.js"><link rel="prefetch" href="/blog/assets/js/11.b60c9933.js"><link rel="prefetch" href="/blog/assets/js/110.8d2fbecf.js"><link rel="prefetch" href="/blog/assets/js/111.84ed7249.js"><link rel="prefetch" href="/blog/assets/js/112.31213946.js"><link rel="prefetch" href="/blog/assets/js/113.64be722c.js"><link rel="prefetch" href="/blog/assets/js/114.ae6f2858.js"><link rel="prefetch" href="/blog/assets/js/115.ca5ff164.js"><link rel="prefetch" href="/blog/assets/js/116.c5a70ef7.js"><link rel="prefetch" href="/blog/assets/js/117.609aacaf.js"><link rel="prefetch" href="/blog/assets/js/118.0e7c4511.js"><link rel="prefetch" href="/blog/assets/js/119.4d4465ef.js"><link rel="prefetch" href="/blog/assets/js/12.c53283e7.js"><link rel="prefetch" href="/blog/assets/js/120.cbb7c7cd.js"><link rel="prefetch" href="/blog/assets/js/121.4af4d2a7.js"><link rel="prefetch" href="/blog/assets/js/122.aa6ed74d.js"><link rel="prefetch" href="/blog/assets/js/123.257fe662.js"><link rel="prefetch" href="/blog/assets/js/124.8f4884cf.js"><link rel="prefetch" href="/blog/assets/js/125.181f8b8c.js"><link rel="prefetch" href="/blog/assets/js/126.cd248b4b.js"><link rel="prefetch" href="/blog/assets/js/127.721f5f87.js"><link rel="prefetch" href="/blog/assets/js/128.0bb043b7.js"><link rel="prefetch" href="/blog/assets/js/129.20a1a93f.js"><link rel="prefetch" href="/blog/assets/js/13.6bdc6b5d.js"><link rel="prefetch" href="/blog/assets/js/130.4917c215.js"><link rel="prefetch" href="/blog/assets/js/131.b66766ff.js"><link rel="prefetch" href="/blog/assets/js/132.86428239.js"><link rel="prefetch" href="/blog/assets/js/133.12ae656b.js"><link rel="prefetch" href="/blog/assets/js/134.3836bf71.js"><link rel="prefetch" href="/blog/assets/js/135.8be69970.js"><link rel="prefetch" href="/blog/assets/js/136.5f3a9d45.js"><link rel="prefetch" href="/blog/assets/js/137.9f861c5f.js"><link rel="prefetch" href="/blog/assets/js/138.11ae9185.js"><link rel="prefetch" href="/blog/assets/js/139.0993576e.js"><link rel="prefetch" href="/blog/assets/js/14.c3201a23.js"><link rel="prefetch" href="/blog/assets/js/140.94062a10.js"><link rel="prefetch" href="/blog/assets/js/141.d598a415.js"><link rel="prefetch" href="/blog/assets/js/142.b2af32f5.js"><link rel="prefetch" href="/blog/assets/js/143.a906b7a7.js"><link rel="prefetch" href="/blog/assets/js/144.d99ab2dc.js"><link rel="prefetch" href="/blog/assets/js/145.31e3bddd.js"><link rel="prefetch" href="/blog/assets/js/146.df2da2e9.js"><link rel="prefetch" href="/blog/assets/js/147.c3071837.js"><link rel="prefetch" href="/blog/assets/js/148.24ad5ac8.js"><link rel="prefetch" href="/blog/assets/js/149.a2dec735.js"><link rel="prefetch" href="/blog/assets/js/15.a0b9e44e.js"><link rel="prefetch" href="/blog/assets/js/150.3e299256.js"><link rel="prefetch" href="/blog/assets/js/151.810ba8d8.js"><link rel="prefetch" href="/blog/assets/js/152.313e3499.js"><link rel="prefetch" href="/blog/assets/js/153.360d31db.js"><link rel="prefetch" href="/blog/assets/js/154.70fa6638.js"><link rel="prefetch" href="/blog/assets/js/155.f7237259.js"><link rel="prefetch" href="/blog/assets/js/156.69884002.js"><link rel="prefetch" href="/blog/assets/js/157.16c9b584.js"><link rel="prefetch" href="/blog/assets/js/158.438cd599.js"><link rel="prefetch" href="/blog/assets/js/159.2e7551ea.js"><link rel="prefetch" href="/blog/assets/js/16.491191e4.js"><link rel="prefetch" href="/blog/assets/js/160.3930fcf7.js"><link rel="prefetch" href="/blog/assets/js/161.dba02343.js"><link rel="prefetch" href="/blog/assets/js/162.fdb54ba3.js"><link rel="prefetch" href="/blog/assets/js/163.4e401238.js"><link rel="prefetch" href="/blog/assets/js/164.7610e666.js"><link rel="prefetch" href="/blog/assets/js/165.c3c46eeb.js"><link rel="prefetch" href="/blog/assets/js/166.55d1720b.js"><link rel="prefetch" href="/blog/assets/js/167.c45c9b8a.js"><link rel="prefetch" href="/blog/assets/js/168.ce8b1546.js"><link rel="prefetch" href="/blog/assets/js/169.63562a92.js"><link rel="prefetch" href="/blog/assets/js/17.89ec8c57.js"><link rel="prefetch" href="/blog/assets/js/170.e35a7d3f.js"><link rel="prefetch" href="/blog/assets/js/171.d7e974f2.js"><link rel="prefetch" href="/blog/assets/js/172.a37254bd.js"><link rel="prefetch" href="/blog/assets/js/173.9300ed70.js"><link rel="prefetch" href="/blog/assets/js/174.fd975955.js"><link rel="prefetch" href="/blog/assets/js/176.caad071a.js"><link rel="prefetch" href="/blog/assets/js/177.4644dd75.js"><link rel="prefetch" href="/blog/assets/js/178.e9951f68.js"><link rel="prefetch" href="/blog/assets/js/179.3cc2d1ec.js"><link rel="prefetch" href="/blog/assets/js/18.b91f1411.js"><link rel="prefetch" href="/blog/assets/js/180.bbf01f25.js"><link rel="prefetch" href="/blog/assets/js/181.65a975d5.js"><link rel="prefetch" href="/blog/assets/js/182.5e9b5d2b.js"><link rel="prefetch" href="/blog/assets/js/183.d8b952a1.js"><link rel="prefetch" href="/blog/assets/js/184.7ab267da.js"><link rel="prefetch" href="/blog/assets/js/185.e86bd4fa.js"><link rel="prefetch" href="/blog/assets/js/186.ecf85931.js"><link rel="prefetch" href="/blog/assets/js/187.a1795c4d.js"><link rel="prefetch" href="/blog/assets/js/188.f6a51896.js"><link rel="prefetch" href="/blog/assets/js/189.ad221742.js"><link rel="prefetch" href="/blog/assets/js/19.cb1f17c8.js"><link rel="prefetch" href="/blog/assets/js/190.b97a0320.js"><link rel="prefetch" href="/blog/assets/js/191.a5dafe3c.js"><link rel="prefetch" href="/blog/assets/js/192.c3daabb6.js"><link rel="prefetch" href="/blog/assets/js/193.df90a07d.js"><link rel="prefetch" href="/blog/assets/js/194.b191ceb1.js"><link rel="prefetch" href="/blog/assets/js/195.8142d418.js"><link rel="prefetch" href="/blog/assets/js/196.1959d8db.js"><link rel="prefetch" href="/blog/assets/js/197.320705ae.js"><link rel="prefetch" href="/blog/assets/js/198.33c6a4bc.js"><link rel="prefetch" href="/blog/assets/js/199.9fc92514.js"><link rel="prefetch" href="/blog/assets/js/200.49a59004.js"><link rel="prefetch" href="/blog/assets/js/201.492702d9.js"><link rel="prefetch" href="/blog/assets/js/202.f0feba4d.js"><link rel="prefetch" href="/blog/assets/js/203.45360fa4.js"><link rel="prefetch" href="/blog/assets/js/204.8176cead.js"><link rel="prefetch" href="/blog/assets/js/21.bf0041b7.js"><link rel="prefetch" href="/blog/assets/js/22.48390d4f.js"><link rel="prefetch" href="/blog/assets/js/23.35c4ba93.js"><link rel="prefetch" href="/blog/assets/js/24.36b663f1.js"><link rel="prefetch" href="/blog/assets/js/25.ebc270ab.js"><link rel="prefetch" href="/blog/assets/js/26.6aca413a.js"><link rel="prefetch" href="/blog/assets/js/27.984ddaac.js"><link rel="prefetch" href="/blog/assets/js/28.2d5b87a5.js"><link rel="prefetch" href="/blog/assets/js/29.e32ce3a4.js"><link rel="prefetch" href="/blog/assets/js/3.cb0627fa.js"><link rel="prefetch" href="/blog/assets/js/30.d0c41458.js"><link rel="prefetch" href="/blog/assets/js/31.a9b4be04.js"><link rel="prefetch" href="/blog/assets/js/32.9ce56840.js"><link rel="prefetch" href="/blog/assets/js/33.29910c72.js"><link rel="prefetch" href="/blog/assets/js/34.00345f09.js"><link rel="prefetch" href="/blog/assets/js/35.a46a1907.js"><link rel="prefetch" href="/blog/assets/js/36.e5e4671d.js"><link rel="prefetch" href="/blog/assets/js/37.3a962caf.js"><link rel="prefetch" href="/blog/assets/js/38.5c12f8ba.js"><link rel="prefetch" href="/blog/assets/js/39.c62ad3ad.js"><link rel="prefetch" href="/blog/assets/js/4.cbb57fa7.js"><link rel="prefetch" href="/blog/assets/js/40.9c8cd8a2.js"><link rel="prefetch" href="/blog/assets/js/41.b7599eeb.js"><link rel="prefetch" href="/blog/assets/js/42.55af0d62.js"><link rel="prefetch" href="/blog/assets/js/43.5e3d5825.js"><link rel="prefetch" href="/blog/assets/js/44.1ada494a.js"><link rel="prefetch" href="/blog/assets/js/45.687a4ff5.js"><link rel="prefetch" href="/blog/assets/js/46.f59401c8.js"><link rel="prefetch" href="/blog/assets/js/47.1e3244f7.js"><link rel="prefetch" href="/blog/assets/js/48.3381609d.js"><link rel="prefetch" href="/blog/assets/js/49.874c0d73.js"><link rel="prefetch" href="/blog/assets/js/5.fe065607.js"><link rel="prefetch" href="/blog/assets/js/50.7d5c52bc.js"><link rel="prefetch" href="/blog/assets/js/51.f8631603.js"><link rel="prefetch" href="/blog/assets/js/52.639f92cf.js"><link rel="prefetch" href="/blog/assets/js/53.1d492ca2.js"><link rel="prefetch" href="/blog/assets/js/54.9ac3c6b5.js"><link rel="prefetch" href="/blog/assets/js/55.1b91fb46.js"><link rel="prefetch" href="/blog/assets/js/56.9218e018.js"><link rel="prefetch" href="/blog/assets/js/57.bc6b8ea2.js"><link rel="prefetch" href="/blog/assets/js/58.01633848.js"><link rel="prefetch" href="/blog/assets/js/59.01489279.js"><link rel="prefetch" href="/blog/assets/js/6.68cda050.js"><link rel="prefetch" href="/blog/assets/js/60.dfbdc64b.js"><link rel="prefetch" href="/blog/assets/js/61.13aa2e5b.js"><link rel="prefetch" href="/blog/assets/js/62.d57c5747.js"><link rel="prefetch" href="/blog/assets/js/63.bebb83cf.js"><link rel="prefetch" href="/blog/assets/js/64.ec347f64.js"><link rel="prefetch" href="/blog/assets/js/65.38cd5666.js"><link rel="prefetch" href="/blog/assets/js/66.95c0d17c.js"><link rel="prefetch" href="/blog/assets/js/67.2323aab3.js"><link rel="prefetch" href="/blog/assets/js/68.96dcbc2f.js"><link rel="prefetch" href="/blog/assets/js/69.7c0c3947.js"><link rel="prefetch" href="/blog/assets/js/7.3b8d63a0.js"><link rel="prefetch" href="/blog/assets/js/70.9d2c5ae6.js"><link rel="prefetch" href="/blog/assets/js/71.98090065.js"><link rel="prefetch" href="/blog/assets/js/72.a5c66acf.js"><link rel="prefetch" href="/blog/assets/js/73.6dc5f3db.js"><link rel="prefetch" href="/blog/assets/js/74.30f7ec1e.js"><link rel="prefetch" href="/blog/assets/js/75.5a43edc2.js"><link rel="prefetch" href="/blog/assets/js/76.169e2ac1.js"><link rel="prefetch" href="/blog/assets/js/77.f842d2c7.js"><link rel="prefetch" href="/blog/assets/js/78.69518f62.js"><link rel="prefetch" href="/blog/assets/js/79.35261041.js"><link rel="prefetch" href="/blog/assets/js/80.06f48ea3.js"><link rel="prefetch" href="/blog/assets/js/81.e7065649.js"><link rel="prefetch" href="/blog/assets/js/82.48317da5.js"><link rel="prefetch" href="/blog/assets/js/83.0ff18ed0.js"><link rel="prefetch" href="/blog/assets/js/84.c2eca043.js"><link rel="prefetch" href="/blog/assets/js/85.bbf3fc62.js"><link rel="prefetch" href="/blog/assets/js/86.e4a8f357.js"><link rel="prefetch" href="/blog/assets/js/87.0ab61aae.js"><link rel="prefetch" href="/blog/assets/js/88.1f451f6e.js"><link rel="prefetch" href="/blog/assets/js/89.1802cd3c.js"><link rel="prefetch" href="/blog/assets/js/90.2190c2c4.js"><link rel="prefetch" href="/blog/assets/js/91.edbd8ef7.js"><link rel="prefetch" href="/blog/assets/js/92.9a151a17.js"><link rel="prefetch" href="/blog/assets/js/93.2f81f8f5.js"><link rel="prefetch" href="/blog/assets/js/94.6673601f.js"><link rel="prefetch" href="/blog/assets/js/95.2a0c4724.js"><link rel="prefetch" href="/blog/assets/js/96.d96bcbb7.js"><link rel="prefetch" href="/blog/assets/js/97.af74319a.js"><link rel="prefetch" href="/blog/assets/js/98.5687a7c1.js"><link rel="prefetch" href="/blog/assets/js/99.a359b4b7.js"><link rel="prefetch" href="/blog/assets/js/vendors~docsearch.bd3cdb54.js">
    <link rel="stylesheet" href="/blog/assets/css/0.styles.7b6e3ec2.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/blog/" class="home-link router-link-active"><img src="/blog/logo.png" alt="前端那些事儿" class="logo"> <span class="site-name can-hide">前端那些事儿</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/blog/" class="nav-link">
  主页
</a></div><div class="nav-item"><a href="/blog/base/" class="nav-link">
  前端基础
</a></div><div class="nav-item"><a href="/blog/vue/" class="nav-link router-link-active">
  Vue
</a></div><div class="nav-item"><a href="/blog/react/" class="nav-link">
  React
</a></div><div class="nav-item"><a href="/blog/node/" class="nav-link">
  Node
</a></div><div class="nav-item"><a href="/blog/devops/" class="nav-link">
  前端工程化
</a></div><div class="nav-item"><a href="/blog/mobile/" class="nav-link">
  泛客户端
</a></div><div class="nav-item"><a href="/blog/architecture/" class="nav-link">
  架构&amp;方案
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="GitHub" class="dropdown-title"><span class="title">GitHub</span> <span class="arrow down"></span></button> <button type="button" aria-label="GitHub" class="mobile-dropdown-title"><span class="title">GitHub</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/jonny-wei" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://github.com/jonny-wei/sushi-js" target="_blank" rel="noopener noreferrer" class="nav-link external">
  JS 寿司
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/blog/" class="nav-link">
  主页
</a></div><div class="nav-item"><a href="/blog/base/" class="nav-link">
  前端基础
</a></div><div class="nav-item"><a href="/blog/vue/" class="nav-link router-link-active">
  Vue
</a></div><div class="nav-item"><a href="/blog/react/" class="nav-link">
  React
</a></div><div class="nav-item"><a href="/blog/node/" class="nav-link">
  Node
</a></div><div class="nav-item"><a href="/blog/devops/" class="nav-link">
  前端工程化
</a></div><div class="nav-item"><a href="/blog/mobile/" class="nav-link">
  泛客户端
</a></div><div class="nav-item"><a href="/blog/architecture/" class="nav-link">
  架构&amp;方案
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="GitHub" class="dropdown-title"><span class="title">GitHub</span> <span class="arrow down"></span></button> <button type="button" aria-label="GitHub" class="mobile-dropdown-title"><span class="title">GitHub</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/jonny-wei" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://github.com/jonny-wei/sushi-js" target="_blank" rel="noopener noreferrer" class="nav-link external">
  JS 寿司
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Vue</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/vue/" aria-current="page" class="sidebar-link">Vue 组件通信</a></li><li><a href="/blog/vue/warmup/vue-symbols.html" class="sidebar-link">Vue 修饰符</a></li><li><a href="/blog/vue/warmup/vue-optimization.html" class="sidebar-link">Vue 相关优化</a></li><li><a href="/blog/vue/warmup/vue-router.html" class="sidebar-link">VueRouter 核心原理</a></li><li><a href="/blog/vue/warmup/vue-vuex.html" class="sidebar-link">Vuex 实现原理</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Vue源码解析</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/vue/vue/github.html" class="sidebar-link">源码学习</a></li><li><a href="/blog/vue/vue/vue-render.html" class="sidebar-link">渲染器</a></li><li><a href="/blog/vue/vue/vue-init.html" class="sidebar-link">构建与初始化</a></li><li><a href="/blog/vue/vue/vue-component.html" class="sidebar-link">组件化过程</a></li><li><a href="/blog/vue/vue/vue-observer.html" class="sidebar-link">响应式原理</a></li><li><a href="/blog/vue/vue/vue-template.html" class="sidebar-link">模板编译与渲染</a></li><li><a href="/blog/vue/vue/vue-diff.html" class="sidebar-link">虚拟 DOM 与 Diff 算法</a></li><li><a href="/blog/vue/vue/vue-nextTick.html" class="sidebar-link">异步更新队列</a></li><li><a href="/blog/vue/vue/vue-lifecycle.html" class="sidebar-link">生命周期</a></li><li><a href="/blog/vue/vue/vue-computed.html" class="sidebar-link">计算属性与侦听器</a></li><li><a href="/blog/vue/vue/vue-slot.html" class="sidebar-link">插槽</a></li><li><a href="/blog/vue/vue/vue-directive.html" class="sidebar-link">Vue 指令</a></li><li><a href="/blog/vue/vue/vue-event.html" class="sidebar-link">事件绑定原理</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>VueRouter源码解析</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/vue/vue-router/abstract.html" class="sidebar-link">摘要</a></li><li><a href="/blog/vue/vue-router/warmUp.html" class="sidebar-link">准备工作</a></li><li><a href="/blog/vue/vue-router/plugin.html" class="sidebar-link">插件机制</a></li><li><a href="/blog/vue/vue-router/initialization.html" class="sidebar-link">初始化与降级处理</a></li><li><a href="/blog/vue/vue-router/transitions.html" class="sidebar-link">路由过渡与视图渲染</a></li><li><a href="/blog/vue/vue-router/match.html" class="sidebar-link">路由匹配</a></li><li><a href="/blog/vue/vue-router/summary.html" class="sidebar-link">总结</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Vuex源码解析</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/vue/vuex/abstract.html" class="sidebar-link">摘要</a></li><li><a href="/blog/vue/vuex/warmUp.html" class="sidebar-link">准备工作</a></li><li><a href="/blog/vue/vuex/initialization.html" class="sidebar-link">初始化与模块安装</a></li><li><a href="/blog/vue/vuex/state.html" class="sidebar-link">State 相关</a></li><li><a href="/blog/vue/vuex/getters.html" class="sidebar-link">Getters 相关</a></li><li><a href="/blog/vue/vuex/mutations.html" class="sidebar-link">Mutations 相关</a></li><li><a href="/blog/vue/vuex/actions.html" class="sidebar-link">Actions 相关</a></li><li><a href="/blog/vue/vuex/modules.html" class="sidebar-link">Modules 相关</a></li><li><a href="/blog/vue/vuex/others.html" class="sidebar-link">其他</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Vue3新特性</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/vue/vue3.x/reactivity.html" class="sidebar-link">响应式系统方面</a></li><li><a href="/blog/vue/vue3.x/features.html" class="sidebar-link">功能方面</a></li><li><a href="/blog/vue/vue3.x/performance.html" class="sidebar-link">性能方面</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>VueNext</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/vue/vue3/vue-router4.html" class="sidebar-link">VueRoute@4 原理</a></li><li><a href="/blog/vue/vue3/pinia.html" class="sidebar-link">Pinia 原理</a></li><li><a href="/blog/vue/vue3/ssr.html" aria-current="page" class="active sidebar-link">Vue SSR</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/vue/vue3/ssr.html#为什么需要-ssr" class="sidebar-link">为什么需要 SSR</a></li><li class="sidebar-sub-header"><a href="/blog/vue/vue3/ssr.html#ssr-权衡考量" class="sidebar-link">SSR 权衡考量</a></li><li class="sidebar-sub-header"><a href="/blog/vue/vue3/ssr.html#ssr-使用" class="sidebar-link">SSR 使用</a></li><li class="sidebar-sub-header"><a href="/blog/vue/vue3/ssr.html#ssr-源码解析" class="sidebar-link">SSR 源码解析</a></li><li class="sidebar-sub-header"><a href="/blog/vue/vue3/ssr.html#同构与其他渲染" class="sidebar-link">同构与其他渲染</a></li></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="vue-ssr"><a href="#vue-ssr" class="header-anchor">#</a> Vue SSR</h1> <h2 id="为什么需要-ssr"><a href="#为什么需要-ssr" class="header-anchor">#</a> 为什么需要 SSR</h2> <h3 id="更快的首屏加载"><a href="#更快的首屏加载" class="header-anchor">#</a> 更快的首屏加载</h3> <p>客户端 CSR 所有的路由和页面都是在客户端进行解析和渲染的。项目部署上线之后的入口文件，body 内部就是一个空的 div 标签，用户访问这个页面后，页面的首屏需要等待 JavaScript 加载和执行完毕才能看到，这样白屏时间肯定比 body 内部写页面标签的要长一些，尤其在客户端网络环境差的情况下，等待 JavaScript 下载和执行的白屏时间影响用户体验。</p> <p>服务端渲染的 HTML 无需等到所有的 JavaScript 都下载并执行完成之后才显示，所以你的用户将会更快地看到完整渲染的页面。除此之外，数据获取过程在首次访问时在服务端完成，相比于从客户端获取，可能有更快的数据库连接。这通常可以带来更高的核心 Web 指标评分、更好的用户体验，而对于那些“首屏加载速度与转化率直接相关”的应用来说，这点可能至关重要。</p> <h3 id="更好的-seo"><a href="#更好的-seo" class="header-anchor">#</a> 更好的 SEO</h3> <p>搜索引擎的爬虫抓取到你的页面数据后，发现 body 是空的，也会认为你这个页面是空的，这对于 SEO 是很不利的。即使现在基于 Google 的搜索引擎爬虫已经能够支持 JavaScript 的执行，但是爬虫不会等待页面的网络数据请求，何况国内主要的搜索引擎还是百度。所以如果你的项目对白屏时间和搜索引擎有要求，我们就需要在用户访问页面的时候，能够把首屏渲染的 HTML 内容写入到 body 内部，也就是说我们需要在服务器端实现组件的渲染，这就是 SSR 的用武之地。</p> <h3 id="统一的心智模型"><a href="#统一的心智模型" class="header-anchor">#</a> 统一的心智模型</h3> <p>你可以使用相同的语言以及相同的声明式、面向组件的心智模型来开发整个应用，而不需要在后端模板系统和前端框架之间来回切换。</p> <h2 id="ssr-权衡考量"><a href="#ssr-权衡考量" class="header-anchor">#</a> SSR 权衡考量</h2> <p>SSR 时还有一些权衡之处需要考量：</p> <ul><li><p><strong>开发中的限制</strong>。浏览器端特定的代码只能在某些生命周期钩子中使用；一些外部库可能需要特殊处理才能在服务端渲染的应用中运行。</p></li> <li><p><strong>更多的与构建配置和部署相关的要求</strong>。服务端渲染的应用需要一个能让 Node.js 服务器运行的环境，不像完全静态的 SPA 那样可以部署在任意的静态文件服务器上。</p></li> <li><p><strong>更高的服务端负载</strong>。在 Node.js 中渲染一个完整的应用要比仅仅托管静态文件更加占用 CPU 资源，因此如果你预期有高流量，请为相应的服务器负载做好准备，并采用合理的缓存策略。</p></li></ul> <h2 id="ssr-使用"><a href="#ssr-使用" class="header-anchor">#</a> SSR 使用</h2> <p>Vue 提供了 @vue/server-renderer 这个专门做服务端解析的库。</p> <p>首先创建一个新的文件夹 vue-ssr，执行下面命令来安装 server-renderer、vue 和 express：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token function">npm</span> init <span class="token parameter variable">-y</span> 
<span class="token function">npm</span> <span class="token function">install</span> @vue/server-renderer vue@next express <span class="token parameter variable">--save</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>然后新建 <code>server.js</code>，核心就是要实现在服务器端解析 Vue 的组件，直接把渲染结果返回给浏览器。下面的代码中我们使用 express 启动了一个服务器，监听 9093 端口，在用户访问首页的时候，通过 <code>createSSRApp</code> 创建一个 Vue 的实例，并且通过 <code>@vue/compiler-ssr</code> 对模板的 template 进行编译，返回的函数配置在 vueapp 的 <code>ssrRender</code> 属性上，最后通过 <code>@vue/server-renderer</code> 的 <code>renderToString()</code> 方法渲染 Vue 的实例，把 <code>renderToString()</code> 返回的字符串通过 <code>res.send</code> 返回给客户端。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 引入express</span>
<span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span> 
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> Vue <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'vue'</span><span class="token punctuation">)</span> <span class="token comment">// vue@next</span>
<span class="token keyword">const</span> renderer3 <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'@vue/server-renderer'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> vue3Compile<span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'@vue/compiler-ssr'</span><span class="token punctuation">)</span>

<span class="token comment">// 一个vue的组件</span>
<span class="token keyword">const</span> vueapp <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">template</span><span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;div&gt;
    &lt;h1 @click=&quot;add&quot;&gt;{{num}}&lt;/h1&gt;
    &lt;ul &gt;
      &lt;li v-for=&quot;(todo,n) in todos&quot; &gt;{{n+1}}--{{todo}}&lt;/li&gt;
    &lt;/ul&gt;
  &lt;/div&gt;</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
  <span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">num</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span>
      <span class="token literal-property property">todos</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token string">'吃饭'</span><span class="token punctuation">,</span><span class="token string">'睡觉'</span><span class="token punctuation">,</span><span class="token string">'学习Vue'</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token literal-property property">methods</span><span class="token operator">:</span><span class="token punctuation">{</span>
    <span class="token function">add</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>num<span class="token operator">++</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> 
<span class="token punctuation">}</span>
<span class="token comment">// 使用@vue/compiler-ssr解析template</span>
vueapp<span class="token punctuation">.</span>ssrRender <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Function</span><span class="token punctuation">(</span><span class="token string">'require'</span><span class="token punctuation">,</span>vue3Compile<span class="token punctuation">.</span><span class="token function">compile</span><span class="token punctuation">(</span>vueapp<span class="token punctuation">.</span>template<span class="token punctuation">)</span><span class="token punctuation">.</span>code<span class="token punctuation">)</span><span class="token punctuation">(</span>require<span class="token punctuation">)</span>
<span class="token comment">// 路由首页返回结果</span>
app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span><span class="token keyword">async</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span>res</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">let</span> vapp <span class="token operator">=</span> Vue<span class="token punctuation">.</span><span class="token function">createSSRApp</span><span class="token punctuation">(</span>vueapp<span class="token punctuation">)</span>
    <span class="token keyword">let</span> html <span class="token operator">=</span> <span class="token keyword">await</span> renderer3<span class="token punctuation">.</span><span class="token function">renderToString</span><span class="token punctuation">(</span>vapp<span class="token punctuation">)</span>
    <span class="token keyword">const</span> title <span class="token operator">=</span> <span class="token string">&quot;Vue SSR&quot;</span>
    <span class="token keyword">let</span> ret <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
&lt;!DOCTYPE html&gt;
&lt;html lang=&quot;en&quot;&gt;
  &lt;head&gt;
    &lt;meta charset=&quot;UTF-8&quot; /&gt;
    &lt;link rel=&quot;icon&quot; href=&quot;/favicon.ico&quot; /&gt;
    &lt;meta name=&quot;viewport&quot; content=&quot;width=device-width, initial-scale=1.0&quot; /&gt;
    &lt;title&gt;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>title<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&lt;/title&gt;
  &lt;/head&gt;
  &lt;body&gt;
    &lt;div id=&quot;app&quot;&gt;
      </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>html<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">
    &lt;/div&gt;
  &lt;/body&gt;
&lt;/html&gt;</span><span class="token template-punctuation string">`</span></span>    
    res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>ret<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">9093</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'listen 9093'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span> 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br></div></div><p>详细参考官网 <a href="https://cn.vuejs.org/guide/scaling-up/ssr" target="_blank" rel="noopener noreferrer">Vue SSR<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 和 <a href="/blog/devops/vite/ssr.html">Vite SSR 工程化</a></p> <h2 id="ssr-源码解析"><a href="#ssr-源码解析" class="header-anchor">#</a> SSR 源码解析</h2> <p>在 CSR 环境下，template 解析的 render 函数用来返回组件的虚拟 DOM，而 SSR 环境下 template 解析的 ssrRender 函数，函数内部是通过 _push 对字符串进行拼接，最终生成组件渲染的结果的。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token literal-property property">mergeProps</span><span class="token operator">:</span> _mergeProps <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;vue&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token literal-property property">ssrRenderAttrs</span><span class="token operator">:</span> _ssrRenderAttrs<span class="token punctuation">,</span> <span class="token literal-property property">ssrInterpolate</span><span class="token operator">:</span> _ssrInterpolate<span class="token punctuation">,</span> <span class="token literal-property property">ssrRenderList</span><span class="token operator">:</span> _ssrRenderList <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;vue/server-renderer&quot;</span><span class="token punctuation">)</span>

<span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token function">ssrRender</span><span class="token punctuation">(</span><span class="token parameter">_ctx<span class="token punctuation">,</span> _push<span class="token punctuation">,</span> _parent<span class="token punctuation">,</span> _attrs<span class="token punctuation">,</span> $props<span class="token punctuation">,</span> $setup<span class="token punctuation">,</span> $data<span class="token punctuation">,</span> $options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> _cssVars <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token literal-property property">style</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">color</span><span class="token operator">:</span> _ctx<span class="token punctuation">.</span>color <span class="token punctuation">}</span><span class="token punctuation">}</span>
  <span class="token function">_push</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;div</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token function">_ssrRenderAttrs</span><span class="token punctuation">(</span><span class="token function">_mergeProps</span><span class="token punctuation">(</span>_attrs<span class="token punctuation">,</span> _cssVars<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&gt;&lt;ul&gt;&lt;!--[--&gt;</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
  <span class="token function">_ssrRenderList</span><span class="token punctuation">(</span>_ctx<span class="token punctuation">.</span>todos<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">todo<span class="token punctuation">,</span> n</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">_push</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;li&gt;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>
      <span class="token function">_ssrInterpolate</span><span class="token punctuation">(</span>n<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">--</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>
      <span class="token function">_ssrInterpolate</span><span class="token punctuation">(</span>todo<span class="token punctuation">)</span>
    <span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&lt;/li&gt;</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token function">_push</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;!--]--&gt;&lt;/ul&gt;&lt;/div&gt;</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>可以看到 <code>ssrRender</code> 函数内部通过传递的 <code>_push</code> 函数拼接组件渲染的结果后，直接返回 <code>renderToString()</code> 函数的执行结果。</p> <p>那 <code>renderToString()</code> 是如何工作的呢？</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// vue-next/packages/server-renderer</span>

<span class="token keyword">export</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">renderToString</span><span class="token punctuation">(</span>
  <span class="token parameter"><span class="token literal-property property">input</span><span class="token operator">:</span> App <span class="token operator">|</span> VNode<span class="token punctuation">,</span>
  <span class="token literal-property property">context</span><span class="token operator">:</span> SSRContext <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span>
<span class="token punctuation">)</span><span class="token operator">:</span> Promise<span class="token operator">&lt;</span>string<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isVNode</span><span class="token punctuation">(</span>input<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// raw vnode, wrap with app (for context)</span>
    <span class="token keyword">return</span> <span class="token function">renderToString</span><span class="token punctuation">(</span><span class="token function">createApp</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token function-variable function">render</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> input <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span> context<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">const</span> vnode <span class="token operator">=</span> <span class="token function">createVNode</span><span class="token punctuation">(</span>input<span class="token punctuation">.</span>_component<span class="token punctuation">,</span> input<span class="token punctuation">.</span>_props<span class="token punctuation">)</span>
  vnode<span class="token punctuation">.</span>appContext <span class="token operator">=</span> input<span class="token punctuation">.</span>_context
  <span class="token comment">// provide the ssr context to the tree</span>
  input<span class="token punctuation">.</span><span class="token function">provide</span><span class="token punctuation">(</span>ssrContextKey<span class="token punctuation">,</span> context<span class="token punctuation">)</span>
  <span class="token keyword">const</span> buffer <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">renderComponentVNode</span><span class="token punctuation">(</span>vnode<span class="token punctuation">)</span>

  <span class="token keyword">await</span> <span class="token function">resolveTeleports</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span>

  <span class="token keyword">return</span> <span class="token function">unrollBuffer</span><span class="token punctuation">(</span>buffer <span class="token keyword">as</span> SSRBuffer<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><p>通过 <code>renderComponentVNode</code> 函数对创建的 <code>Vnode</code> 进行渲染，生成一个 <code>buffer</code> 变量，最后通过 <code>unrollBuffer</code> 返回字符串。</p> <p>我们先继续看 <code>renderComponentVNode</code> 函数，它内部通过 <code>renderComponentSubTree</code> 进行虚拟 DOM 的子树渲染，而 <code>renderComponentSubTree</code> 内部调用组件内部的 <code>ssrRender</code> 函数，这个函数就是我们代码中通过 <code>@vue/compiler-ssr</code> 解析之后的 <code>ssrRender</code> 函数，传递的 <code>push</code> 参数是通过 <code>createBuffer</code> 传递的：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">renderComponentVNode</span><span class="token punctuation">(</span>
  <span class="token parameter"><span class="token literal-property property">vnode</span><span class="token operator">:</span> VNode<span class="token punctuation">,</span>
  <span class="token literal-property property">parentComponent</span><span class="token operator">:</span> ComponentInternalInstance <span class="token operator">|</span> <span class="token keyword">null</span> <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  slotScopeId<span class="token operator">?</span><span class="token operator">:</span> string</span>
<span class="token punctuation">)</span><span class="token operator">:</span> SSRBuffer <span class="token operator">|</span> Promise<span class="token operator">&lt;</span>SSRBuffer<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> instance <span class="token operator">=</span> <span class="token function">createComponentInstance</span><span class="token punctuation">(</span>vnode<span class="token punctuation">,</span> parentComponent<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token function">setupComponent</span><span class="token punctuation">(</span>instance<span class="token punctuation">,</span> <span class="token boolean">true</span> <span class="token comment">/* isSSR */</span><span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>hasAsyncSetup <span class="token operator">||</span> prefetches<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token operator">...</span><span class="token punctuation">.</span>
    <span class="token keyword">return</span> p<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">renderComponentSubTree</span><span class="token punctuation">(</span>instance<span class="token punctuation">,</span> slotScopeId<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">renderComponentSubTree</span><span class="token punctuation">(</span>instance<span class="token punctuation">,</span> slotScopeId<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">renderComponentSubTree</span><span class="token punctuation">(</span><span class="token parameter">instance<span class="token punctuation">,</span>slotScopeId</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> getBuffer<span class="token punctuation">,</span> push <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">createBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> ssrRender <span class="token operator">=</span> instance<span class="token punctuation">.</span>ssrRender <span class="token operator">||</span> comp<span class="token punctuation">.</span>ssrRender
  <span class="token keyword">if</span> <span class="token punctuation">(</span>ssrRender<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">ssrRender</span><span class="token punctuation">(</span>
        instance<span class="token punctuation">.</span>proxy<span class="token punctuation">,</span>
        push<span class="token punctuation">,</span>
        instance<span class="token punctuation">,</span>
        attrs<span class="token punctuation">,</span>
        <span class="token comment">// compiler-optimized bindings</span>
        instance<span class="token punctuation">.</span>props<span class="token punctuation">,</span>
        instance<span class="token punctuation">.</span>setupState<span class="token punctuation">,</span>
        instance<span class="token punctuation">.</span>data<span class="token punctuation">,</span>
        instance<span class="token punctuation">.</span>ctx
      <span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br></div></div><p><code>createBuffer</code> 的实现也很简单，<code>buffer</code> 是一个数组，<code>push</code> 函数就是不停地在数组最后新增数据，如果 <code>item</code> 是字符串，就在数组最后一个数据上直接拼接字符串，否则就在数组尾部新增一个元素，这种提前合并字符串的做法，也算是一个小优化。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">createBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> appendable <span class="token operator">=</span> <span class="token boolean">false</span>
  <span class="token keyword">const</span> <span class="token literal-property property">buffer</span><span class="token operator">:</span> SSRBuffer <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    <span class="token function">getBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> SSRBuffer <span class="token punctuation">{</span>
      <span class="token comment">// Return static buffer and await on items during unroll stage</span>
      <span class="token keyword">return</span> buffer
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function">push</span><span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">item</span><span class="token operator">:</span> SSRBufferItem</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> isStringItem <span class="token operator">=</span> <span class="token function">isString</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>appendable <span class="token operator">&amp;&amp;</span> isStringItem<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        buffer<span class="token punctuation">[</span>buffer<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">+=</span> item <span class="token keyword">as</span> string
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        buffer<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      appendable <span class="token operator">=</span> isStringItem
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isPromise</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span><span class="token function">isArray</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> item<span class="token punctuation">.</span>hasAsync<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// promise, or child buffer with async, mark as async.</span>
        <span class="token comment">// this allows skipping unnecessary await ticks during unroll stage</span>
        buffer<span class="token punctuation">.</span>hasAsync <span class="token operator">=</span> <span class="token boolean">true</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><p>最后我们看下返回字符串的 <code>unrollBuffer</code> 函数，由于 <code>buffer</code> 数组中可能会有异步的组件，服务器返回渲染内容之前，我们要把组件依赖的异步任务使用 <code>await</code> 等待执行完毕后，进行字符串的拼接，最后返回给浏览器。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">unrollBuffer</span><span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">buffer</span><span class="token operator">:</span> SSRBuffer</span><span class="token punctuation">)</span><span class="token operator">:</span> Promise<span class="token operator">&lt;</span>string<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>buffer<span class="token punctuation">.</span>hasAsync<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> ret <span class="token operator">=</span> <span class="token string">''</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> buffer<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">let</span> item <span class="token operator">=</span> buffer<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isPromise</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        item <span class="token operator">=</span> <span class="token keyword">await</span> item
      <span class="token punctuation">}</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isString</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        ret <span class="token operator">+=</span> item
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        ret <span class="token operator">+=</span> <span class="token keyword">await</span> <span class="token function">unrollBuffer</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> ret
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// sync buffer can be more efficiently unrolled without unnecessary await</span>
    <span class="token comment">// ticks</span>
    <span class="token keyword">return</span> <span class="token function">unrollBufferSync</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><p>至此我们就把 Vue 中 SSR 的渲染流程梳理完毕了，通过 <code>compiler-ssr</code> 模块把 <code>template</code> 解析成 <code>ssrRender</code> 函数后，整个组件通过 <code>renderToString</code> 把组件渲染成字符串返回给浏览器。SSR 最终实现了通过服务器端解析 Vue 组件的方式，提高首屏的响应时间和页面的 SEO 友好度。</p> <h2 id="同构与其他渲染"><a href="#同构与其他渲染" class="header-anchor">#</a> 同构与其他渲染</h2> <p>如果我们既需要提供服务器渲染的首屏内容，又需要 CSR 带来的优秀交互体验，这个时候我们就需要使用同构的方式来构建 Vue 的应用。</p> <p><img src="/blog/images/vue/vue-ssr%E5%90%8C%E6%9E%84%E6%9E%B6%E6%9E%84%E5%9B%BE.png" alt="vue-ssr同构架构图"></p> <p>左边可以拆分为 component + store + router 三大模块。这一部分的源码，设置了两个入口，分别是客户端入口 <code>client entry</code> 和服务器端入口 <code>server entry</code>。打包的过程中也有两个打包的配置文件，分别客户端的配置和服务器端的配置。最终在服务端实现用户首次访问页面的时候通过服务器端入口进入，显示服务器渲染的结果，然后用户在后续的操作中由客户端接管，通过 vue-router 来提高页面跳转的交互体验，这就是同构应用的概念。</p> <h3 id="同构的问题"><a href="#同构的问题" class="header-anchor">#</a> 同构的问题</h3> <p>SSR 和同构带来了很好的首屏速度和 SEO 友好度，但是也让我们的项目多了一个 Node 服务器模块。</p> <p>首先，我们部署的难度会提高。之前的静态资源直接上传到服务器的 Nginx 目录下，做好版本管理即可，现在还需要在服务器上部署一个 Node 环境，额外带来了部署和监控的成本。</p> <p>其次，SSR 和同构的架构，实际上，是把客户端渲染组件的计算逻辑移到了服务器端执行，在并发量大的场景中，会加大服务器的负载。所以，所有的同构应用下还需要有降级渲染的逻辑，在服务器负载过高或者服务器有异常报错的情况下，让页面恢复为客户端渲染。</p> <p>总的来说，同构解决问题的同时，也带来了额外的系统复杂度。每个技术架构的出现都是为了解决一些特定的问题，但是它们的出现也必然会带来新的问题。</p> <h3 id="ssg"><a href="#ssg" class="header-anchor">#</a> SSG</h3> <p>针对 SSR 架构的问题，我们也可以使用静态网站生成（Static Site Generation，SSG）的方式来解决，针对页面中变动频率不高的页面，直接渲染成静态页面来展示。</p> <p>比如极客时间的首页变化频率比较高，每次我们都需要对每个课程的销量和评分进行排序，这部分的每次访问都需要从后端读取数据；但是每个课程内部的页面，比如文章详情页，变化频率其实是很低的，虽然课程的文本是存储在数据库里，但是每次上线前，我们可以把课程详情页生成静态的 HTML 页面再上线。Vue 的 SSR 框架 nuxt 就提供了很好的 SSG 功能，由于这一部分页面变化频率低，我们静态化之后还可以通过部署到 CDN 来进行页面加速，每次新文章发布或者修改的时候，重新生成一遍即可。</p> <p>当然 SSG 也不是完全没有问题，比如极客时间如果有一万门课了，每门课几十篇文章，每次部署都全量静态生成一遍，耗时是非常惊人的，所以也不断有新的解决方案出现。</p> <h3 id="nsr"><a href="#nsr" class="header-anchor">#</a> NSR</h3> <p>如果你的页面是内嵌在客户端内部的，可以借助客户端的运算能力，把 SSR 的逻辑移动到客户端进行，使用客户端渲染（Native Side Rendering，NSR）的方式降低服务端的负载，同时也能提高首屏的响应时间。</p> <h3 id="isr"><a href="#isr" class="header-anchor">#</a> ISR</h3> <p>针对 SSG 全量生成的性能问题，我们可以采用增量渲染（Incremental Site Rendering，ISR）的方式，每次只生成核心重点的页面，比如每个课程的开篇词，其他的页面访问的时候先通过 CSR 的方式渲染，然后把渲染结果存储在 CDN 中。</p> <h3 id="esr"><a href="#esr" class="header-anchor">#</a> ESR</h3> <p>此外还有边缘渲染（Edge Side Rendering，ESR），把静态内容和动态的内容都以流的方式返回给用户，在 CDN 节点上返回给用户缓存静态资源，同时在 CDN 上负责发起动态内容的请求。</p> <h3 id="webcontainer"><a href="#webcontainer" class="header-anchor">#</a> WebContainer</h3> <p>新出现的在浏览器里跑 node 的 <a href="https://blog.stackblitz.com/posts/introducing-webcontainers/" target="_blank" rel="noopener noreferrer">WebContainer 技术<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>，技术成熟后，我们甚至可以把 Express、Egg.js 等后端应用也部署到 CDN 节点上，在浏览器端实现服务器应用的 ESR。</p> <p>想了解这些渲染方式可移步 <a href="/blog/architecture">渲染模式通识</a></p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/blog/vue/vue3/pinia.html" class="prev">
        Pinia 原理
      </a></span> <!----></p></div> </main></div><div class="global-ui"><!----><!----><!----><!----></div></div>
    <script src="/blog/assets/js/app.7d500235.js" defer></script><script src="/blog/assets/js/2.dec2e75d.js" defer></script><script src="/blog/assets/js/1.5b9e135c.js" defer></script><script src="/blog/assets/js/175.9b940dba.js" defer></script><script src="/blog/assets/js/20.badbb211.js" defer></script>
  </body>
</html>
