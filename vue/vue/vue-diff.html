<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>虚拟 DOM 与 Diff 算法 | 花帽子的博客</title>
    <meta name="generator" content="VuePress 1.7.1">
    <link rel="icon" href="/blog/logo.png">
    <link rel="manifest" href="/blog/manifest.json">
    <link rel="apple-touch-icon" href="/blog/images/icons/apple-icon-152x152.png">
    <meta name="description" content="我命由我不由天，学习吧少年">
    <meta name="theme-color" content="#3eaf7c">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="msapplication-TileImage" content="/icons/ms-icon-144x144.png">
    <meta name="msapplication-TileColor" content="#000000">
    
    <link rel="preload" href="/blog/assets/css/0.styles.e2df15d6.css" as="style"><link rel="preload" href="/blog/assets/js/app.00a80163.js" as="script"><link rel="preload" href="/blog/assets/js/2.55125c9d.js" as="script"><link rel="preload" href="/blog/assets/js/93.6744b020.js" as="script"><link rel="preload" href="/blog/assets/js/4.f8e09ced.js" as="script"><link rel="prefetch" href="/blog/assets/js/10.d7104175.js"><link rel="prefetch" href="/blog/assets/js/100.f77663d9.js"><link rel="prefetch" href="/blog/assets/js/101.fecc00b2.js"><link rel="prefetch" href="/blog/assets/js/102.a784d984.js"><link rel="prefetch" href="/blog/assets/js/103.1285b8ce.js"><link rel="prefetch" href="/blog/assets/js/104.21b5b344.js"><link rel="prefetch" href="/blog/assets/js/105.2aab9933.js"><link rel="prefetch" href="/blog/assets/js/106.fc18b765.js"><link rel="prefetch" href="/blog/assets/js/107.123ec32a.js"><link rel="prefetch" href="/blog/assets/js/108.fb0dd0d9.js"><link rel="prefetch" href="/blog/assets/js/109.94071645.js"><link rel="prefetch" href="/blog/assets/js/11.28981ed2.js"><link rel="prefetch" href="/blog/assets/js/12.c10ed981.js"><link rel="prefetch" href="/blog/assets/js/13.5d1a37d5.js"><link rel="prefetch" href="/blog/assets/js/14.89bbdd3d.js"><link rel="prefetch" href="/blog/assets/js/15.0c24aef9.js"><link rel="prefetch" href="/blog/assets/js/16.48bed9b2.js"><link rel="prefetch" href="/blog/assets/js/17.a868ffc3.js"><link rel="prefetch" href="/blog/assets/js/18.31f1d223.js"><link rel="prefetch" href="/blog/assets/js/19.56e3200a.js"><link rel="prefetch" href="/blog/assets/js/20.4db161f3.js"><link rel="prefetch" href="/blog/assets/js/21.a24917fa.js"><link rel="prefetch" href="/blog/assets/js/22.90f28985.js"><link rel="prefetch" href="/blog/assets/js/23.7cd980ee.js"><link rel="prefetch" href="/blog/assets/js/24.371b29db.js"><link rel="prefetch" href="/blog/assets/js/25.3dd08f3a.js"><link rel="prefetch" href="/blog/assets/js/26.0245e4b8.js"><link rel="prefetch" href="/blog/assets/js/27.773c6820.js"><link rel="prefetch" href="/blog/assets/js/28.00f277f0.js"><link rel="prefetch" href="/blog/assets/js/29.ba0feb25.js"><link rel="prefetch" href="/blog/assets/js/3.6b7316b6.js"><link rel="prefetch" href="/blog/assets/js/30.45f3e74c.js"><link rel="prefetch" href="/blog/assets/js/31.630c43f9.js"><link rel="prefetch" href="/blog/assets/js/32.4745ffe1.js"><link rel="prefetch" href="/blog/assets/js/33.6ef45acf.js"><link rel="prefetch" href="/blog/assets/js/34.4312ae00.js"><link rel="prefetch" href="/blog/assets/js/35.81451f70.js"><link rel="prefetch" href="/blog/assets/js/36.a16ea5ef.js"><link rel="prefetch" href="/blog/assets/js/37.73282022.js"><link rel="prefetch" href="/blog/assets/js/38.3b34fd3d.js"><link rel="prefetch" href="/blog/assets/js/39.d3791473.js"><link rel="prefetch" href="/blog/assets/js/40.faa8fb6c.js"><link rel="prefetch" href="/blog/assets/js/41.8a1af23d.js"><link rel="prefetch" href="/blog/assets/js/42.4d2b2c2a.js"><link rel="prefetch" href="/blog/assets/js/43.5311575c.js"><link rel="prefetch" href="/blog/assets/js/44.a941f83e.js"><link rel="prefetch" href="/blog/assets/js/45.518378b7.js"><link rel="prefetch" href="/blog/assets/js/46.3edad690.js"><link rel="prefetch" href="/blog/assets/js/47.9844f2d2.js"><link rel="prefetch" href="/blog/assets/js/48.d7e9e2e3.js"><link rel="prefetch" href="/blog/assets/js/49.0829f2e1.js"><link rel="prefetch" href="/blog/assets/js/5.baa33aa4.js"><link rel="prefetch" href="/blog/assets/js/50.64f5b732.js"><link rel="prefetch" href="/blog/assets/js/51.96a9c8a5.js"><link rel="prefetch" href="/blog/assets/js/52.173d1369.js"><link rel="prefetch" href="/blog/assets/js/53.06886e2c.js"><link rel="prefetch" href="/blog/assets/js/54.be113c48.js"><link rel="prefetch" href="/blog/assets/js/55.97bb2ec1.js"><link rel="prefetch" href="/blog/assets/js/56.a00183b9.js"><link rel="prefetch" href="/blog/assets/js/57.6e7609a5.js"><link rel="prefetch" href="/blog/assets/js/58.36961dd6.js"><link rel="prefetch" href="/blog/assets/js/59.468621b8.js"><link rel="prefetch" href="/blog/assets/js/6.a1331773.js"><link rel="prefetch" href="/blog/assets/js/60.715dda88.js"><link rel="prefetch" href="/blog/assets/js/61.f16e5285.js"><link rel="prefetch" href="/blog/assets/js/62.941e0764.js"><link rel="prefetch" href="/blog/assets/js/63.68bccf40.js"><link rel="prefetch" href="/blog/assets/js/64.0c2e1323.js"><link rel="prefetch" href="/blog/assets/js/65.0f4c7849.js"><link rel="prefetch" href="/blog/assets/js/66.4c24609c.js"><link rel="prefetch" href="/blog/assets/js/67.3b282110.js"><link rel="prefetch" href="/blog/assets/js/68.12cfd4d8.js"><link rel="prefetch" href="/blog/assets/js/69.d537a3ba.js"><link rel="prefetch" href="/blog/assets/js/7.c9d98944.js"><link rel="prefetch" href="/blog/assets/js/70.5fc3217b.js"><link rel="prefetch" href="/blog/assets/js/71.2e2bd3a5.js"><link rel="prefetch" href="/blog/assets/js/72.cb382846.js"><link rel="prefetch" href="/blog/assets/js/73.247c7c23.js"><link rel="prefetch" href="/blog/assets/js/74.c2550f58.js"><link rel="prefetch" href="/blog/assets/js/75.cf947607.js"><link rel="prefetch" href="/blog/assets/js/76.1ca6466c.js"><link rel="prefetch" href="/blog/assets/js/77.858ca4e4.js"><link rel="prefetch" href="/blog/assets/js/78.604e80e6.js"><link rel="prefetch" href="/blog/assets/js/79.60821f9f.js"><link rel="prefetch" href="/blog/assets/js/8.441834aa.js"><link rel="prefetch" href="/blog/assets/js/80.d9516d18.js"><link rel="prefetch" href="/blog/assets/js/81.771953a5.js"><link rel="prefetch" href="/blog/assets/js/82.371a3626.js"><link rel="prefetch" href="/blog/assets/js/83.03bfecdb.js"><link rel="prefetch" href="/blog/assets/js/84.c944f614.js"><link rel="prefetch" href="/blog/assets/js/85.ef9f4cd8.js"><link rel="prefetch" href="/blog/assets/js/86.4ddd08ff.js"><link rel="prefetch" href="/blog/assets/js/87.5cde0f8f.js"><link rel="prefetch" href="/blog/assets/js/88.072458a5.js"><link rel="prefetch" href="/blog/assets/js/89.041e77a2.js"><link rel="prefetch" href="/blog/assets/js/9.a921bf18.js"><link rel="prefetch" href="/blog/assets/js/90.0a2c6fd2.js"><link rel="prefetch" href="/blog/assets/js/91.6d72259e.js"><link rel="prefetch" href="/blog/assets/js/92.78eff178.js"><link rel="prefetch" href="/blog/assets/js/94.bacba689.js"><link rel="prefetch" href="/blog/assets/js/95.1ffc3120.js"><link rel="prefetch" href="/blog/assets/js/96.b4bc5675.js"><link rel="prefetch" href="/blog/assets/js/97.5b3b2ffd.js"><link rel="prefetch" href="/blog/assets/js/98.2e20c173.js"><link rel="prefetch" href="/blog/assets/js/99.e78817e1.js">
    <link rel="stylesheet" href="/blog/assets/css/0.styles.e2df15d6.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/blog/" class="home-link router-link-active"><img src="/blog/logo.png" alt="花帽子的博客" class="logo"> <span class="site-name can-hide">花帽子的博客</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/blog/" class="nav-link">
  主页
</a></div><div class="nav-item"><a href="/blog/vue/" class="nav-link router-link-active">
  Vue
</a></div><div class="nav-item"><a href="/blog/css/" class="nav-link">
  CSS
</a></div><div class="nav-item"><a href="/blog/javascript/" class="nav-link">
  JS
</a></div><div class="nav-item"><a href="/blog/typescript/" class="nav-link">
  TS
</a></div><div class="nav-item"><a href="/blog/node/" class="nav-link">
  Node
</a></div><div class="nav-item"><a href="/blog/optimization/" class="nav-link">
  优化
</a></div><div class="nav-item"><a href="/blog/mobile/" class="nav-link">
  移动端
</a></div><div class="nav-item"><a href="/blog/talk/" class="nav-link">
  项目
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="GitHub" class="dropdown-title"><span class="title">GitHub</span> <span class="arrow down"></span></button> <button type="button" aria-label="GitHub" class="mobile-dropdown-title"><span class="title">GitHub</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/jonny-wei" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub地址
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/blog/" class="nav-link">
  主页
</a></div><div class="nav-item"><a href="/blog/vue/" class="nav-link router-link-active">
  Vue
</a></div><div class="nav-item"><a href="/blog/css/" class="nav-link">
  CSS
</a></div><div class="nav-item"><a href="/blog/javascript/" class="nav-link">
  JS
</a></div><div class="nav-item"><a href="/blog/typescript/" class="nav-link">
  TS
</a></div><div class="nav-item"><a href="/blog/node/" class="nav-link">
  Node
</a></div><div class="nav-item"><a href="/blog/optimization/" class="nav-link">
  优化
</a></div><div class="nav-item"><a href="/blog/mobile/" class="nav-link">
  移动端
</a></div><div class="nav-item"><a href="/blog/talk/" class="nav-link">
  项目
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="GitHub" class="dropdown-title"><span class="title">GitHub</span> <span class="arrow down"></span></button> <button type="button" aria-label="GitHub" class="mobile-dropdown-title"><span class="title">GitHub</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/jonny-wei" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub地址
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Vue秘籍</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/vue/" aria-current="page" class="sidebar-link">Vue 的秘籍</a></li><li><a href="/blog/vue/interview/vue-communication.html" class="sidebar-link">Vue 组件通信</a></li><li><a href="/blog/vue/interview/vue-symbols.html" class="sidebar-link">Vue 修饰符</a></li><li><a href="/blog/vue/interview/vue-test.html" class="sidebar-link">Vue 单元测试</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Vue源码解析</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/vue/vue/github.html" class="sidebar-link">源码学习</a></li><li><a href="/blog/vue/vue/vue-render.html" class="sidebar-link">渲染器</a></li><li><a href="/blog/vue/vue/vue-init.html" class="sidebar-link">构建与初始化</a></li><li><a href="/blog/vue/vue/vue-observer.html" class="sidebar-link">响应式原理</a></li><li><a href="/blog/vue/vue/vue-template.html" class="sidebar-link">模板编译与渲染</a></li><li><a href="/blog/vue/vue/vue-diff.html" aria-current="page" class="active sidebar-link">虚拟 DOM 与 Diff 算法</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/vue/vue/vue-diff.html#虚拟-dom" class="sidebar-link">虚拟 DOM</a></li><li class="sidebar-sub-header"><a href="/blog/vue/vue/vue-diff.html#vnode-类" class="sidebar-link">VNode 类</a></li><li class="sidebar-sub-header"><a href="/blog/vue/vue/vue-diff.html#patch-打补丁过程" class="sidebar-link">Patch 打补丁过程</a></li><li class="sidebar-sub-header"><a href="/blog/vue/vue/vue-diff.html#核心-diff-算法" class="sidebar-link">核心 Diff 算法</a></li><li class="sidebar-sub-header"><a href="/blog/vue/vue/vue-diff.html#总结" class="sidebar-link">总结</a></li><li class="sidebar-sub-header"><a href="/blog/vue/vue/vue-diff.html#问题" class="sidebar-link">问题</a></li></ul></li><li><a href="/blog/vue/vue/vue-router.html" class="sidebar-link">Vue 路由原理</a></li><li><a href="/blog/vue/vue/vue-vuex.html" class="sidebar-link">Vuex 实现原理</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>VueRouter源码解析</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/vue/vue-router/abstract.html" class="sidebar-link">摘要</a></li><li><a href="/blog/vue/vue-router/warmUp.html" class="sidebar-link">准备工作</a></li><li><a href="/blog/vue/vue-router/plugin.html" class="sidebar-link">插件机制</a></li><li><a href="/blog/vue/vue-router/initialization.html" class="sidebar-link">初始化与降级处理</a></li><li><a href="/blog/vue/vue-router/transitions.html" class="sidebar-link">路由过渡与视图渲染</a></li><li><a href="/blog/vue/vue-router/match.html" class="sidebar-link">路由匹配</a></li><li><a href="/blog/vue/vue-router/scroll.html" class="sidebar-link">滚动行为处理</a></li><li><a href="/blog/vue/vue-router/summary.html" class="sidebar-link">总结</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Vuex源码解析</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/vue/vuex/abstract.html" class="sidebar-link">摘要</a></li><li><a href="/blog/vue/vuex/warmUp.html" class="sidebar-link">准备工作</a></li><li><a href="/blog/vue/vuex/initialization.html" class="sidebar-link">初始化与模块安装</a></li><li><a href="/blog/vue/vuex/state.html" class="sidebar-link">State 相关</a></li><li><a href="/blog/vue/vuex/getters.html" class="sidebar-link">Getters 相关</a></li><li><a href="/blog/vue/vuex/mutations.html" class="sidebar-link">Mutations 相关</a></li><li><a href="/blog/vue/vuex/actions.html" class="sidebar-link">Actions 相关</a></li><li><a href="/blog/vue/vuex/modules.html" class="sidebar-link">Modules 相关</a></li><li><a href="/blog/vue/vuex/others.html" class="sidebar-link">其他</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Vue3新特性</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/vue/vue3.x/abstract.html" class="sidebar-link">摘要</a></li><li><a href="/blog/vue/vue3.x/reactivity.html" class="sidebar-link">响应式系统</a></li><li><a href="/blog/vue/vue3.x/features.html" class="sidebar-link">功能方面</a></li><li><a href="/blog/vue/vue3.x/performance.html" class="sidebar-link">性能方面</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="虚拟-dom-与-diff-算法"><a href="#虚拟-dom-与-diff-算法" class="header-anchor">#</a> 虚拟 DOM 与 Diff 算法</h1> <h2 id="虚拟-dom"><a href="#虚拟-dom" class="header-anchor">#</a> 虚拟 DOM</h2> <h3 id="什么是虚拟-dom"><a href="#什么是虚拟-dom" class="header-anchor">#</a> 什么是虚拟 DOM</h3> <p>Virtual DOM 本质上是 JavaScript 对象，是真实 DOM 的描述，用一个 JS 对象来描述一个 DOM 节点。</p> <p>Virtual DOM 可以看做一棵模拟 DOM 树的 JavaScript 树，其主要是通过 VNode 实现一个无状态的组件，当组件状态发生更新时，然后触发 Virtual DOM 数据的变化，然后通过 Virtual DOM 和真实 DOM 的比对，再对真实 DOM 更新。可以简单认为 Virtual DOM 是真实 DOM 的缓存。</p> <h3 id="虚拟-dom-的优缺点"><a href="#虚拟-dom-的优缺点" class="header-anchor">#</a> 虚拟 DOM 的优缺点</h3> <h4 id="优点"><a href="#优点" class="header-anchor">#</a> 优点：</h4> <ul><li>保证性能下限(次要原因)：框架的虚拟 DOM 需要适配任何上层 API 可能产生的操作(分层设计)，它的一些 DOM 操作的实现必须是普适的，所以它的性能并不是最优的；但是比起粗暴的 DOM 操作性能要好很多，因此框架的虚拟 DOM 至少可以保证在你不需要手动优化的情况下，依然可以提供还不错的性能，即保证性能的下限；</li> <li>无需手动操作 DOM：操作 DOM 慢，js运行效率高。我们可以将DOM对比操作放在JS层，提高效率。我们不再需要手动去操作 DOM，只需要写好 View-Model 的代码逻辑，框架会根据虚拟 DOM 和 数据双向绑定，帮我们以可预期的方式更新视图，极大提高我们的开发效率；</li> <li>跨平台与分层设计(主要原因)：虚拟 DOM 本质上是 JavaScript 对象，而真实 DOM 与平台强相关，相比之下虚拟 DOM 带来了分层设计、跨平台以及 SSR 等特性。至于 Virtual DOM 比 原生 DOM 谁的性能好，需要 “控制变量法” 才能比较。这是为什么要设计虚拟 DOM 的主要原因。虚拟 DOM 抽象了原本的渲染过程，实现了跨平台的能力，而不仅仅局限于浏览器的 DOM，可以是安卓和 iOS 的原生组件，也可以是小程序，也可以是各种 GUI</li> <li>组件的高度抽象化：Vue.2x 引入 VirtualDOM 把渲染过程抽象化，从而使得组件的抽象能力也得到提升，并且可以适配 DOM 以外的渲染目标。不再依赖 HTML 解析器进行模版解析，可以进行更多的 AOT 工作提高运行时效率：通过模版 AOT 编译，Vue 的运行时体积可以进一步压缩，运行时效率可以进一步提升。Virtual DOM 的优势不在于单次的操作，而是在大量、频繁的数据更新下，能够对视图进行合理、高效的更新。了实现高效的 DOM 操作，一套高效的虚拟 DOM diff 算法显得很有必要.</li></ul> <h4 id="缺点"><a href="#缺点" class="header-anchor">#</a> 缺点:</h4> <ul><li>无法进行极致优化： 虽然虚拟 DOM + 合理的优化，足以应对绝大部分应用的性能需求，但在一些性能要求极高的应用中虚拟 DOM 无法进行针对性的极致优化。</li></ul> <h3 id="虚拟-dom-实现原理"><a href="#虚拟-dom-实现原理" class="header-anchor">#</a> 虚拟 DOM 实现原理</h3> <p>虚拟 DOM 的实现原理主要包括以下 3 部分：</p> <ul><li>用 JavaScript 对象模拟真实 DOM 树，对真实 DOM 进行抽象；</li> <li>diff 算法 — 比较两棵虚拟 DOM 树的差异；</li> <li>pach 算法(打补丁) — 将两个虚拟 DOM 对象的差异应用到真正的 DOM 树。</li></ul> <h2 id="vnode-类"><a href="#vnode-类" class="header-anchor">#</a> VNode 类</h2> <p>JavaScript 对象模拟真实 DOM 树，对真实 DOM 进行抽象。vue 是通过 createElement 生成 VNode。</p> <p>虚拟 DOM 就是用 JS 来描述一个真实的 DOM 节点。而在 Vue中就存在了一个 VNode 类，通过这个类，我们就可以实例化出不同类型的虚拟 DOM 节点。Vue 中 VNode的类型：</p> <ul><li>注释节点</li> <li>文本节点</li> <li>元素节点</li> <li>组件节点</li> <li>函数式组件节点</li> <li>克隆节点</li></ul> <p>其实 VNode 的作用是相当大的。我们在视图渲染之前，把写好的 template 模板先编译成 VNode 并缓存下来，等到数据发生变化页面需要重新渲染的时候，我们把数据发生变化后生成的 VNode 与前一次缓存下来的 VNode 进行对比，找出差异，然后有差异的 VNode 对应的真实 DOM 节点就是需要重新渲染的节点，最后根据有差异的 VNode 创建出真实的 DOM 节点再插入到视图中，最终完成一次视图更新。</p> <h3 id="createelement"><a href="#createelement" class="header-anchor">#</a> createElement</h3> <p>creatElement()</p> <ul><li>context 表示 VNode 的上下文环境，是 Component 类型</li> <li>tag 表示标签，它可以是一个字符串，也可以是一个 Component 类型</li> <li>data 表示 VNode 的数据，它是一个 VNodeData 类型</li> <li>children 表示当前 VNode 的子节点，它是任意类型的</li> <li>normalizationType 表示子节点规范的类型，类型不同规范的方法也就不一样，主要是参考 render 函数是编译生成的还是用户手写的</li></ul> <p>normalizeChildren 方法调用场景分为下面两种：</p> <ul><li>render 函数是用户手写的</li> <li>编译 slot、v-for 的时候会产生嵌套数组</li></ul> <h3 id="createcomponent"><a href="#createcomponent" class="header-anchor">#</a> createComponent</h3> <p>createComponent 生成 VNode 的三个关键流程：</p> <ul><li>构造子类构造函数Ctor</li> <li>installComponentHooks 安装组件钩子函数</li> <li>实例化 vnode</li></ul> <h2 id="patch-打补丁过程"><a href="#patch-打补丁过程" class="header-anchor">#</a> Patch 打补丁过程</h2> <p>_update 会将新旧两个 VNode 进行 patch 过程，得出两个 VNode 最小差异，然后将这些差异渲染到视图上。</p> <p>整个 patch 无非就是干三件事：</p> <ul><li>创建节点：新的 VNode 中有而旧的 oldVNode 中没有，就在旧的 oldVNode 中创建。</li> <li>删除节点：新的 VNode 中没有而旧的 oldVNode 中有，就从旧的 oldVNode 中删除。</li> <li>更新节点：新的 VNode 和旧的 oldVNode 中都有，就以新的 VNode 为准，更新旧的 oldVNode。</li></ul> <h3 id="创建节点-createelm"><a href="#创建节点-createelm" class="header-anchor">#</a> 创建节点 createElm</h3> <p>VNode 类可以描述 6 种类型的节点，而实际上只有 3 种类型的节点能够被创建并插入到 DOM 中，它们分别是：元素节点、文本节点、注释节点。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 源码位置: /src/core/vdom/patch.js</span>
<span class="token keyword">function</span> <span class="token function">createElm</span> <span class="token punctuation">(</span><span class="token parameter">vnode<span class="token punctuation">,</span> parentElm<span class="token punctuation">,</span> refElm</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> data <span class="token operator">=</span> vnode<span class="token punctuation">.</span>data
    <span class="token keyword">const</span> children <span class="token operator">=</span> vnode<span class="token punctuation">.</span>children
    <span class="token keyword">const</span> tag <span class="token operator">=</span> vnode<span class="token punctuation">.</span>tag
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>tag<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      	vnode<span class="token punctuation">.</span>elm <span class="token operator">=</span> nodeOps<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span>tag<span class="token punctuation">,</span> vnode<span class="token punctuation">)</span>   <span class="token comment">// 创建元素节点</span>
        <span class="token function">createChildren</span><span class="token punctuation">(</span>vnode<span class="token punctuation">,</span> children<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">)</span> <span class="token comment">// 创建元素节点的子节点</span>
        <span class="token function">insert</span><span class="token punctuation">(</span>parentElm<span class="token punctuation">,</span> vnode<span class="token punctuation">.</span>elm<span class="token punctuation">,</span> refElm<span class="token punctuation">)</span>       <span class="token comment">// 插入到DOM中</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isTrue</span><span class="token punctuation">(</span>vnode<span class="token punctuation">.</span>isComment<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      vnode<span class="token punctuation">.</span>elm <span class="token operator">=</span> nodeOps<span class="token punctuation">.</span><span class="token function">createComment</span><span class="token punctuation">(</span>vnode<span class="token punctuation">.</span>text<span class="token punctuation">)</span>  <span class="token comment">// 创建注释节点</span>
      <span class="token function">insert</span><span class="token punctuation">(</span>parentElm<span class="token punctuation">,</span> vnode<span class="token punctuation">.</span>elm<span class="token punctuation">,</span> refElm<span class="token punctuation">)</span>           <span class="token comment">// 插入到DOM中</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      vnode<span class="token punctuation">.</span>elm <span class="token operator">=</span> nodeOps<span class="token punctuation">.</span><span class="token function">createTextNode</span><span class="token punctuation">(</span>vnode<span class="token punctuation">.</span>text<span class="token punctuation">)</span>  <span class="token comment">// 创建文本节点</span>
      <span class="token function">insert</span><span class="token punctuation">(</span>parentElm<span class="token punctuation">,</span> vnode<span class="token punctuation">.</span>elm<span class="token punctuation">,</span> refElm<span class="token punctuation">)</span>           <span class="token comment">// 插入到DOM中</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><h3 id="删除节点-removenode"><a href="#删除节点-removenode" class="header-anchor">#</a> 删除节点 removeNode</h3> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">removeNode</span> <span class="token punctuation">(</span><span class="token parameter">el</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> parent <span class="token operator">=</span> nodeOps<span class="token punctuation">.</span><span class="token function">parentNode</span><span class="token punctuation">(</span>el<span class="token punctuation">)</span>  <span class="token comment">// 获取父节点</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>parent<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      nodeOps<span class="token punctuation">.</span><span class="token function">removeChild</span><span class="token punctuation">(</span>parent<span class="token punctuation">,</span> el<span class="token punctuation">)</span>  <span class="token comment">// 调用父节点的removeChild方法</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h3 id="更新节点-patchvnode"><a href="#更新节点-patchvnode" class="header-anchor">#</a> 更新节点 patchVnode</h3> <ul><li><p>如果新旧 VNode 都是静态（isStatic）的，同时它们的 key 相同（代表同一节点），并且新的 VNode 是 clone 或者是标记了 once（标记 v-once 属性，只渲染一次），那么只需要替换 elm 以及 componentInstance 即可</p></li> <li><p>如果 oldeVnode 和 Vnode 都有文本节点且不相等，那么会将 oldVnode 的文本节点更新为 Vnode 的文本节点</p></li> <li><p>如果 oldVnode 和 Vnode 均有子节点，则执行 updateChildren 对子节点进行 diff 操作，这也是 diff 的核心部分</p></li> <li><p>如果 oldVnode 有文本节点而 Vnode 有子节点，则将 oldVnode 的文本节点清空，然后插入 Vnode 的子节点</p></li> <li><p>如果 oldVnode 有子节点而 Vnode 没有子节点，则删除 el 的所有子节点</p></li> <li><p>如果 oldVnode 有文本节点但和 Vnode 一样没有子节点，则清空 oldVnode 的文本节点即可</p></li></ul> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 更新节点</span>
<span class="token keyword">function</span> <span class="token function">patchVnode</span> <span class="token punctuation">(</span><span class="token parameter">oldVnode<span class="token punctuation">,</span> vnode<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">,</span> removeOnly</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// vnode与oldVnode是否完全一样？若是，退出程序</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>oldVnode <span class="token operator">===</span> vnode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">const</span> elm <span class="token operator">=</span> vnode<span class="token punctuation">.</span>elm <span class="token operator">=</span> oldVnode<span class="token punctuation">.</span>elm

  <span class="token comment">// vnode与oldVnode是否都是静态节点？若是，退出程序</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isTrue</span><span class="token punctuation">(</span>vnode<span class="token punctuation">.</span>isStatic<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
    <span class="token function">isTrue</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">.</span>isStatic<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
    vnode<span class="token punctuation">.</span>key <span class="token operator">===</span> oldVnode<span class="token punctuation">.</span>key <span class="token operator">&amp;&amp;</span>
    <span class="token punctuation">(</span><span class="token function">isTrue</span><span class="token punctuation">(</span>vnode<span class="token punctuation">.</span>isCloned<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token function">isTrue</span><span class="token punctuation">(</span>vnode<span class="token punctuation">.</span>isOnce<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">const</span> oldCh <span class="token operator">=</span> oldVnode<span class="token punctuation">.</span>children
  <span class="token keyword">const</span> ch <span class="token operator">=</span> vnode<span class="token punctuation">.</span>children
  <span class="token comment">// vnode有text属性？若没有：</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isUndef</span><span class="token punctuation">(</span>vnode<span class="token punctuation">.</span>text<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// vnode的子节点与oldVnode的子节点是否都存在？</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>oldCh<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isDef</span><span class="token punctuation">(</span>ch<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 若都存在，判断子节点是否相同，不同则更新子节点</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>oldCh <span class="token operator">!==</span> ch<span class="token punctuation">)</span> <span class="token function">updateChildren</span><span class="token punctuation">(</span>elm<span class="token punctuation">,</span> oldCh<span class="token punctuation">,</span> ch<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">,</span> removeOnly<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 若只有vnode的子节点存在</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>ch<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">/**
       * 判断oldVnode是否有文本？
       * 若没有，则把vnode的子节点添加到真实DOM中
       * 若有，则清空Dom中的文本，再把vnode的子节点添加到真实DOM中
       */</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">.</span>text<span class="token punctuation">)</span><span class="token punctuation">)</span> nodeOps<span class="token punctuation">.</span><span class="token function">setTextContent</span><span class="token punctuation">(</span>elm<span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span>
      <span class="token function">addVnodes</span><span class="token punctuation">(</span>elm<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> ch<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> ch<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 若只有oldnode的子节点存在</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>oldCh<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 清空DOM中的子节点</span>
      <span class="token function">removeVnodes</span><span class="token punctuation">(</span>elm<span class="token punctuation">,</span> oldCh<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> oldCh<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 若vnode和oldnode都没有子节点，但是oldnode中有文本</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">.</span>text<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 清空oldnode文本</span>
      nodeOps<span class="token punctuation">.</span><span class="token function">setTextContent</span><span class="token punctuation">(</span>elm<span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 上面两个判断一句话概括就是，如果vnode中既没有text，也没有子节点，那么对应的oldnode中有什么就清空什么</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 若有，vnode的text属性与oldVnode的text属性是否相同？</span>
  <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>oldVnode<span class="token punctuation">.</span>text <span class="token operator">!==</span> vnode<span class="token punctuation">.</span>text<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 若不相同：则用vnode的text替换真实DOM的文本</span>
    nodeOps<span class="token punctuation">.</span><span class="token function">setTextContent</span><span class="token punctuation">(</span>elm<span class="token punctuation">,</span> vnode<span class="token punctuation">.</span>text<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br></div></div><p><img src="/blog/images/vue/%E6%9B%B4%E6%96%B0%E8%8A%82%E7%82%B9.png" alt="更新节点"></p> <p>值得注意的是如果新旧 VNode 里都包含了子节点，那么对于子节点的更新在代码里调用了 updateChildren 方法。对于子节点的对比更新会有额外的一些逻辑，即核心的 diff 算法。patch 的核心 diff 算法，只在同层级的 VNode 之间进行比较得到变化，然后修改变化的视图。patch 过程中，如果两个 VNode 被认为是同个 VNode，则会进行深度比较，得出最小差异，否则直接删除旧有 DOM 节点，创建新的 DOM 节点。判断两个 VNode 是否相同是通过 isSameVnode 判断两个虚拟 DOM 节点是否相同，判断依据是两个节点的 key 属性是否一致。</p> <h2 id="核心-diff-算法"><a href="#核心-diff-算法" class="header-anchor">#</a> 核心 Diff 算法</h2> <p>diff 算法是一种通过同层的树节点进行比较的高效算法。diff整体策略为：深度优先，同层比较</p> <p>其有两个特点：</p> <ul><li>比较只会在同层级进行, 不会跨层级比较</li> <li>在 diff 比较的过程中，循环从两边向中间比较(vue的双端比较法)</li></ul> <p>新旧两个 VNode 节点的左右头尾两侧均有一个变量标识，在遍历过程中这几个变量都会向中间靠拢。当 oldStartIdx &lt;= oldEndIndex 或者 newStartIdx &lt;= newEndIdx 时结束循环。在遍历中，如果存在 key，并且满足 sameVnode，会将该 DOM 节点进行复用，否则则会创建一个新的 DOM 节点。</p> <p>oldStartVnode、oldEndVnode 与 newStartVnode、newEndVnode 两两比较共有四种比较方法：</p> <ol><li><p>当新旧子树的两个开始节点或新旧子树的两个结束节点相同时</p> <p>当新旧 VNode 节点的 start 或者 end 满足 sameVnode 时，也就是 sameVnode(oldStartVnode, newStartVnode) 或者 sameVnode(oldEndVnode, newEndVnode) 表示为 true，直接将该 VNode 节点进行 patchVnode 即可（保留）。</p></li> <li><p>当旧子树的开始节点与新子树的结束节点相同时</p> <p>当 oldStartVnode 与 newEndVnode 满足 sameVnode，即 sameVnode(oldStartVnode, newEndVnode)。这时候说明 oldStartVnode 已经跑到了 oldEndVnode 后面去了，进行 patchVnode 的同时还需要将真实 DOM 节点移动到 oldEndVnode 的后面。</p></li> <li><p>当旧子树的结束节点与新子树的开始节点相同时</p> <p>如果 oldEndVnode 与 newStartVnode 满足 sameVnode，即 sameVnode(oldEndVnode, newStartVnode)。这说明 oldEndVnode 跑到了 oldStartVnode 的前面，进行 patchVnode 的同时真实的 DOM 节点移动到了 oldStartVnode 的前面。</p></li> <li><p>当旧子树中没有新子树中的节点，会将新节点插入到 oldStartVnode 前</p></li></ol> <p>如果以上情况均不符合，则通过 createKeyToOldIdx 会得到一个 oldKeyToIdx，里面存放了一个 key 为旧的 VNode，value 为对应 index 序列的哈希表。从这个哈希表中可以找到是否有与 newStartVnode 一致 key 的旧的 VNode 节点，如果同时满足 sameVnode，patchVnode 的同时会将这个真实 DOM（elmToMove）移动到 oldStartVnode 对应的真实 DOM 的前面。</p> <p>当然也有可能 newStartVnode 在旧的 VNode 节点找不到一致的 key，或者是即便 key 相同却不是 sameVnode，这个时候会调用 createElm 创建一个新的 DOM 节点。</p> <p>新旧节点分别有两个指针，分别指向各自的头部节点和尾部节点。</p> <ul><li>当新旧节点的头部值得对比，进入 patchNode 方法，同时各自的头部指针+1；</li> <li>当新旧节点的尾部值得对比，进入patchNode方法，同时各自的尾部指针-1</li> <li>当oldStartVnode，newEndVnode值得对比，说明oldStartVnode已经跑到了后面，那么就将oldStartVnode.el移到oldEndVnode.el的后边。oldStartIdx+1，newEndIdx-1</li> <li>当oldEndVnode，newStartVnode值得对比，说明oldEndVnode已经跑到了前面，那么就将oldEndVnode.el移到oldStartVnode.el的前边。oldEndIdx-1，newStartIdx+1</li></ul> <p>当以上 4 种对比都不成立时，通过 newStartVnode.key 看是否能在 oldVnode中 找到，如果没有则新建节点，如果有则对比新旧节点中相同 key 的 Node，newStartIdx+1。</p> <p>当循环结束时，这时候会有两种情况：</p> <ul><li>oldStartIdx &gt; oldEndIdx，可以认为 oldVnode 对比完毕，当然也有可能 newVnode 也刚好对比完，一样归为此类。此时 newStartIdx 和 newEndIdx 之间的 vnode 是新增的，调用 addVnodes ，把他们全部插进 before 的后边。</li> <li>newStartIdx &gt; newEndIdx，可以认为 newVnode 先遍历完，oldVnode 还有节点。此时 oldStartIdx 和 oldEndIdx 之间的 vnode 在新的子节点里已经不存在了，调用 removeVnodes 将它们从 DOM 里删除。</li></ul> <h2 id="总结"><a href="#总结" class="header-anchor">#</a> 总结</h2> <ul><li>当数据发生改变时，订阅者 watcher 就会调用 patch 给真实的 DOM 打补丁</li> <li>通过 isSameVnode 进行判断，相同则调用 patchVnode 方法</li> <li>patchVnode做了以下操作：
<ul><li>找到对应的真实 dom，称为 el</li> <li>如果都有文本节点且不相等，将 el 文本节点设置为 Vnode 的文本节点</li> <li>如果 oldVnode 有子节点而 VNode 没有，则删除 el 子节点</li> <li>如果 oldVnode 没有子节点而 VNode 有，则将 VNode 的子节点真实化后添加到 el</li> <li>如果两者都有子节点，则执行 updateChildren 函数比较子节点</li></ul></li> <li>updateChildren 主要做了以下操作：
<ul><li>设置新旧 VNode 的头尾指针</li> <li>新旧头尾指针进行比较，循环向中间靠拢，根据情况调用 patchVnode 进行 patch 重复流程、调用 createElem 创建一个新节点，从哈希表寻找 key 一致的VNode 节点再分情况操作。</li></ul></li></ul> <h2 id="问题"><a href="#问题" class="header-anchor">#</a> 问题</h2> <h3 id="q1-vue-中的-key-有什么作用"><a href="#q1-vue-中的-key-有什么作用" class="header-anchor">#</a> Q1. Vue 中的 key 有什么作用</h3> <p>key 是为 Vue 中 vnode 的唯一标记，通过这个 key，我们的 diff 操作可以更准确、更快速。diff 算法中双端两两比较一共有4种比较方式，如果以上 4 种比较都没匹配，如果设置了key，就会用 key 再进行比较，在比较的过程中，遍历会往中间靠，一旦 StartIdx &gt; EndIdx 表明 oldCh 和 newCh 至少有一个已经遍历完了，就会结束比较。</p> <p>通过移动元素的位置来达到更新的目的。能够移动元素的关键在于：我们需要在新旧 children 的节点中保存映射关系，以便我们能够在旧 children 的节点中找到可复用的节点。这时候我们就需要给 children 中的节点添加唯一标识，也就是我们常说的 key，在没有 key 的情况下，我们是没办法知道新 children 中的节点是否可以在旧 children 中找到可复用的节点的。知道了映射关系，我们就很容易判断新 children 中的节点是否可被复用：只需要遍历新 children 中的每一个节点，并去旧 children 中寻找是否存在具有相同 key 值的节点。</p> <p>所以 Vue 中 key 的作用是：</p> <p>key 是为 Vue 中 vnode 的唯一标记，通过这个 key，我们的 diff 操作可以更准确、更快速：</p> <ul><li>更准确：因为带 key 就不是就地复用了，在 sameNode 函数 a.key === b.key 对比中可以避免就地复用的情况。所以会更加准确。</li> <li>更快速：利用 key 的唯一性生成 map 对象来获取对应节点，比遍历方式更快</li></ul> <p>key 主要用在 Vue 的虚拟 DOM 算法，在新旧 nodes 对比时辨识 VNodes。如果不使用 key，Vue 会使用一种最大限度减少动态元素并且尽可能的尝试就地修改/复用相同类型元素的算法。而使用 key 时，它会基于 key 的变化重新排列元素顺序，并且会移除 key 不存在的元素。</p> <p>有相同父元素的子元素必须有独特的 key。重复的 key 会造成渲染错误。</p> <p>它也可以用于强制替换元素/组件而不是重复使用它。当你遇到如下场景时它可能会很有用：</p> <ul><li>完整地触发组件的生命周期钩子</li> <li>触发过渡</li></ul> <div class="language-html line-numbers-mode"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ul</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">v-for</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>item in items<span class="token punctuation">&quot;</span></span> <span class="token attr-name">:key</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>item.id<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>...<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ul</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>transition</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name">:key</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>text<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>{{ text }}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>transition</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><div class="custom-block warning"><p class="custom-block-title">参考文献</p> <p><a href="https://github.com/answershuto/learnVue/blob/master/docs/VNode%E8%8A%82%E7%82%B9.MarkDown" target="_blank" rel="noopener noreferrer">VNode节点<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><a href="https://tsejx.github.io/vue-guidebook/reactivity/virtual-dom" target="_blank" rel="noopener noreferrer">Vue Guidebook<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><a href="https://mp.weixin.qq.com/s/oZKowf4YLsVi67z777VKmA" target="_blank" rel="noopener noreferrer">了解过vue中的diff算法吗？说说看<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><a href="https://github.com/answershuto/learnVue/blob/master/docs/VirtualDOM%E4%B8%8Ediff(Vue%E5%AE%9E%E7%8E%B0).MarkDown" target="_blank" rel="noopener noreferrer">Virtual DOM 与 diff (Vue实现)<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><a href="https://juejin.cn/post/6844903895467032589#heading-14" target="_blank" rel="noopener noreferrer">深入剖析：Vue核心之虚拟DOM<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></div></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/blog/vue/vue/vue-template.html" class="prev">
        模板编译与渲染
      </a></span> <span class="next"><a href="/blog/vue/vue/vue-router.html">
        Vue 路由原理
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----><!----><!----><!----></div></div>
    <script src="/blog/assets/js/app.00a80163.js" defer></script><script src="/blog/assets/js/2.55125c9d.js" defer></script><script src="/blog/assets/js/93.6744b020.js" defer></script><script src="/blog/assets/js/4.f8e09ced.js" defer></script>
  </body>
</html>
