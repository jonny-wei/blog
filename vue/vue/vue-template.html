<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>模板编译与渲染 | 花帽子的博客</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="icon" href="/blog/logo.png">
    <link rel="manifest" href="/blog/manifest.json">
    <link rel="apple-touch-icon" href="/blog/images/icons/apple-icon-152x152.png">
    <meta name="description" content="我命由我不由天，学习吧少年">
    <meta name="theme-color" content="#3eaf7c">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="msapplication-TileImage" content="/icons/ms-icon-144x144.png">
    <meta name="msapplication-TileColor" content="#000000">
    
    <link rel="preload" href="/blog/assets/css/0.styles.1c8ccece.css" as="style"><link rel="preload" href="/blog/assets/js/app.dc60fa76.js" as="script"><link rel="preload" href="/blog/assets/js/2.8bf77cff.js" as="script"><link rel="preload" href="/blog/assets/js/152.3d8d52cf.js" as="script"><link rel="preload" href="/blog/assets/js/4.ff6074e9.js" as="script"><link rel="prefetch" href="/blog/assets/js/10.9746f0d4.js"><link rel="prefetch" href="/blog/assets/js/100.7afac925.js"><link rel="prefetch" href="/blog/assets/js/101.5f686463.js"><link rel="prefetch" href="/blog/assets/js/102.f5513446.js"><link rel="prefetch" href="/blog/assets/js/103.986a21a2.js"><link rel="prefetch" href="/blog/assets/js/104.b92eb2e5.js"><link rel="prefetch" href="/blog/assets/js/105.c8985cc0.js"><link rel="prefetch" href="/blog/assets/js/106.d846383d.js"><link rel="prefetch" href="/blog/assets/js/107.8499c996.js"><link rel="prefetch" href="/blog/assets/js/108.821ff706.js"><link rel="prefetch" href="/blog/assets/js/109.7ca45081.js"><link rel="prefetch" href="/blog/assets/js/11.1af81e2b.js"><link rel="prefetch" href="/blog/assets/js/110.d71320d4.js"><link rel="prefetch" href="/blog/assets/js/111.d608027c.js"><link rel="prefetch" href="/blog/assets/js/112.441f3936.js"><link rel="prefetch" href="/blog/assets/js/113.92501e43.js"><link rel="prefetch" href="/blog/assets/js/114.ca35bcc7.js"><link rel="prefetch" href="/blog/assets/js/115.3fd40dd1.js"><link rel="prefetch" href="/blog/assets/js/116.fa7d9815.js"><link rel="prefetch" href="/blog/assets/js/117.1130a4d9.js"><link rel="prefetch" href="/blog/assets/js/118.224d8b58.js"><link rel="prefetch" href="/blog/assets/js/119.21bbac77.js"><link rel="prefetch" href="/blog/assets/js/12.084d40c3.js"><link rel="prefetch" href="/blog/assets/js/120.58603fb2.js"><link rel="prefetch" href="/blog/assets/js/121.7612ed62.js"><link rel="prefetch" href="/blog/assets/js/122.d2d022c3.js"><link rel="prefetch" href="/blog/assets/js/123.656e69d2.js"><link rel="prefetch" href="/blog/assets/js/124.f72c96ac.js"><link rel="prefetch" href="/blog/assets/js/125.176ee084.js"><link rel="prefetch" href="/blog/assets/js/126.7b830092.js"><link rel="prefetch" href="/blog/assets/js/127.5f44c9a4.js"><link rel="prefetch" href="/blog/assets/js/128.d82bb99e.js"><link rel="prefetch" href="/blog/assets/js/129.d5ac9cef.js"><link rel="prefetch" href="/blog/assets/js/13.979405a7.js"><link rel="prefetch" href="/blog/assets/js/130.03525a68.js"><link rel="prefetch" href="/blog/assets/js/131.43aea247.js"><link rel="prefetch" href="/blog/assets/js/132.824c314b.js"><link rel="prefetch" href="/blog/assets/js/133.2562e8a8.js"><link rel="prefetch" href="/blog/assets/js/134.22a9fc5c.js"><link rel="prefetch" href="/blog/assets/js/135.b8c6d2a5.js"><link rel="prefetch" href="/blog/assets/js/136.ee505d8e.js"><link rel="prefetch" href="/blog/assets/js/137.1fdd68b9.js"><link rel="prefetch" href="/blog/assets/js/138.190d0510.js"><link rel="prefetch" href="/blog/assets/js/139.c7a2aca9.js"><link rel="prefetch" href="/blog/assets/js/14.988f2400.js"><link rel="prefetch" href="/blog/assets/js/140.2bb02cbd.js"><link rel="prefetch" href="/blog/assets/js/141.c2bf91d8.js"><link rel="prefetch" href="/blog/assets/js/142.56ab7e5f.js"><link rel="prefetch" href="/blog/assets/js/143.a2c6ccb0.js"><link rel="prefetch" href="/blog/assets/js/144.4608226b.js"><link rel="prefetch" href="/blog/assets/js/145.327049e7.js"><link rel="prefetch" href="/blog/assets/js/146.37f7106b.js"><link rel="prefetch" href="/blog/assets/js/147.0dcb0460.js"><link rel="prefetch" href="/blog/assets/js/148.2eca4f03.js"><link rel="prefetch" href="/blog/assets/js/149.80c3e293.js"><link rel="prefetch" href="/blog/assets/js/15.a6ef1d9e.js"><link rel="prefetch" href="/blog/assets/js/150.67bdcd91.js"><link rel="prefetch" href="/blog/assets/js/151.450b686c.js"><link rel="prefetch" href="/blog/assets/js/153.c431d7ee.js"><link rel="prefetch" href="/blog/assets/js/154.f657978f.js"><link rel="prefetch" href="/blog/assets/js/155.63d8bfa2.js"><link rel="prefetch" href="/blog/assets/js/156.09c23eab.js"><link rel="prefetch" href="/blog/assets/js/157.caf9ecd6.js"><link rel="prefetch" href="/blog/assets/js/158.7698fd04.js"><link rel="prefetch" href="/blog/assets/js/159.a63251df.js"><link rel="prefetch" href="/blog/assets/js/16.d0cca31c.js"><link rel="prefetch" href="/blog/assets/js/160.863424c5.js"><link rel="prefetch" href="/blog/assets/js/161.692413ca.js"><link rel="prefetch" href="/blog/assets/js/162.1a5ae7b3.js"><link rel="prefetch" href="/blog/assets/js/17.37089c83.js"><link rel="prefetch" href="/blog/assets/js/18.fd396b23.js"><link rel="prefetch" href="/blog/assets/js/19.faf2c77b.js"><link rel="prefetch" href="/blog/assets/js/20.61304a72.js"><link rel="prefetch" href="/blog/assets/js/21.7d63b327.js"><link rel="prefetch" href="/blog/assets/js/22.6904c560.js"><link rel="prefetch" href="/blog/assets/js/23.b23738eb.js"><link rel="prefetch" href="/blog/assets/js/24.ea38a23e.js"><link rel="prefetch" href="/blog/assets/js/25.abb0e6cf.js"><link rel="prefetch" href="/blog/assets/js/26.f1b49cd5.js"><link rel="prefetch" href="/blog/assets/js/27.795d8e56.js"><link rel="prefetch" href="/blog/assets/js/28.7579c5e5.js"><link rel="prefetch" href="/blog/assets/js/29.33a1b76f.js"><link rel="prefetch" href="/blog/assets/js/3.6c93b5c9.js"><link rel="prefetch" href="/blog/assets/js/30.3163153d.js"><link rel="prefetch" href="/blog/assets/js/31.54144d78.js"><link rel="prefetch" href="/blog/assets/js/32.65a368a2.js"><link rel="prefetch" href="/blog/assets/js/33.d190977d.js"><link rel="prefetch" href="/blog/assets/js/34.99eff638.js"><link rel="prefetch" href="/blog/assets/js/35.06434d1e.js"><link rel="prefetch" href="/blog/assets/js/36.d613d0a0.js"><link rel="prefetch" href="/blog/assets/js/37.b4babf39.js"><link rel="prefetch" href="/blog/assets/js/38.3e85480a.js"><link rel="prefetch" href="/blog/assets/js/39.f7e83a34.js"><link rel="prefetch" href="/blog/assets/js/40.56df273e.js"><link rel="prefetch" href="/blog/assets/js/41.abdb267e.js"><link rel="prefetch" href="/blog/assets/js/42.20e47d96.js"><link rel="prefetch" href="/blog/assets/js/43.534a5f5f.js"><link rel="prefetch" href="/blog/assets/js/44.1d28b912.js"><link rel="prefetch" href="/blog/assets/js/45.71c6491c.js"><link rel="prefetch" href="/blog/assets/js/46.ede4b7d4.js"><link rel="prefetch" href="/blog/assets/js/47.e0938a2e.js"><link rel="prefetch" href="/blog/assets/js/48.7a9e4ae0.js"><link rel="prefetch" href="/blog/assets/js/49.31a45026.js"><link rel="prefetch" href="/blog/assets/js/5.d4d4f9f0.js"><link rel="prefetch" href="/blog/assets/js/50.352862ae.js"><link rel="prefetch" href="/blog/assets/js/51.6ed0c5e6.js"><link rel="prefetch" href="/blog/assets/js/52.b620763a.js"><link rel="prefetch" href="/blog/assets/js/53.fff85c78.js"><link rel="prefetch" href="/blog/assets/js/54.48ebc5f7.js"><link rel="prefetch" href="/blog/assets/js/55.755fa751.js"><link rel="prefetch" href="/blog/assets/js/56.10412343.js"><link rel="prefetch" href="/blog/assets/js/57.7c47eb10.js"><link rel="prefetch" href="/blog/assets/js/58.381a8fb3.js"><link rel="prefetch" href="/blog/assets/js/59.26ecd49e.js"><link rel="prefetch" href="/blog/assets/js/6.539ab69c.js"><link rel="prefetch" href="/blog/assets/js/60.3d8d4a9a.js"><link rel="prefetch" href="/blog/assets/js/61.ab03297e.js"><link rel="prefetch" href="/blog/assets/js/62.c01680c7.js"><link rel="prefetch" href="/blog/assets/js/63.056b9ccf.js"><link rel="prefetch" href="/blog/assets/js/64.c4b48533.js"><link rel="prefetch" href="/blog/assets/js/65.a5b14004.js"><link rel="prefetch" href="/blog/assets/js/66.1c4997f6.js"><link rel="prefetch" href="/blog/assets/js/67.443d274e.js"><link rel="prefetch" href="/blog/assets/js/68.8e7a3772.js"><link rel="prefetch" href="/blog/assets/js/69.e0f7e762.js"><link rel="prefetch" href="/blog/assets/js/7.c55f6e83.js"><link rel="prefetch" href="/blog/assets/js/70.8b51a2b5.js"><link rel="prefetch" href="/blog/assets/js/71.a711c3b4.js"><link rel="prefetch" href="/blog/assets/js/72.5636f667.js"><link rel="prefetch" href="/blog/assets/js/73.b17d8a63.js"><link rel="prefetch" href="/blog/assets/js/74.2747e377.js"><link rel="prefetch" href="/blog/assets/js/75.6661a9ad.js"><link rel="prefetch" href="/blog/assets/js/76.0bad3782.js"><link rel="prefetch" href="/blog/assets/js/77.487d7c4b.js"><link rel="prefetch" href="/blog/assets/js/78.b7651ea7.js"><link rel="prefetch" href="/blog/assets/js/79.4716871e.js"><link rel="prefetch" href="/blog/assets/js/8.60aa9c8a.js"><link rel="prefetch" href="/blog/assets/js/80.23d74518.js"><link rel="prefetch" href="/blog/assets/js/81.2011f04b.js"><link rel="prefetch" href="/blog/assets/js/82.60d364bf.js"><link rel="prefetch" href="/blog/assets/js/83.29b0e5f2.js"><link rel="prefetch" href="/blog/assets/js/84.bd6661ea.js"><link rel="prefetch" href="/blog/assets/js/85.44aed813.js"><link rel="prefetch" href="/blog/assets/js/86.da3ca6f2.js"><link rel="prefetch" href="/blog/assets/js/87.e0dedd0a.js"><link rel="prefetch" href="/blog/assets/js/88.29a235e5.js"><link rel="prefetch" href="/blog/assets/js/89.74d2bf2a.js"><link rel="prefetch" href="/blog/assets/js/9.9ae7697d.js"><link rel="prefetch" href="/blog/assets/js/90.de770e98.js"><link rel="prefetch" href="/blog/assets/js/91.1b785ec0.js"><link rel="prefetch" href="/blog/assets/js/92.8fac416c.js"><link rel="prefetch" href="/blog/assets/js/93.f50cf32a.js"><link rel="prefetch" href="/blog/assets/js/94.5c05ee02.js"><link rel="prefetch" href="/blog/assets/js/95.d377fb9b.js"><link rel="prefetch" href="/blog/assets/js/96.3a65a13b.js"><link rel="prefetch" href="/blog/assets/js/97.3323f6cf.js"><link rel="prefetch" href="/blog/assets/js/98.8d0a1ab3.js"><link rel="prefetch" href="/blog/assets/js/99.f6e8fb8b.js">
    <link rel="stylesheet" href="/blog/assets/css/0.styles.1c8ccece.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/blog/" class="home-link router-link-active"><img src="/blog/logo.png" alt="花帽子的博客" class="logo"> <span class="site-name can-hide">花帽子的博客</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/blog/" class="nav-link">
  主页
</a></div><div class="nav-item"><a href="/blog/vue/" class="nav-link router-link-active">
  Vue
</a></div><div class="nav-item"><a href="/blog/react/" class="nav-link">
  React
</a></div><div class="nav-item"><a href="/blog/css/" class="nav-link">
  CSS
</a></div><div class="nav-item"><a href="/blog/javascript/" class="nav-link">
  JS&amp;TS
</a></div><div class="nav-item"><a href="/blog/node/" class="nav-link">
  Node
</a></div><div class="nav-item"><a href="/blog/devops/" class="nav-link">
  前端工程化
</a></div><div class="nav-item"><a href="/blog/mobile/" class="nav-link">
  泛客户端
</a></div><div class="nav-item"><a href="/blog/framework/" class="nav-link">
  架构&amp;方案
</a></div><div class="nav-item"><a href="/blog/code/" class="nav-link">
  算法&amp;编程
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="GitHub" class="dropdown-title"><span class="title">GitHub</span> <span class="arrow down"></span></button> <button type="button" aria-label="GitHub" class="mobile-dropdown-title"><span class="title">GitHub</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/jonny-wei" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub地址
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/blog/" class="nav-link">
  主页
</a></div><div class="nav-item"><a href="/blog/vue/" class="nav-link router-link-active">
  Vue
</a></div><div class="nav-item"><a href="/blog/react/" class="nav-link">
  React
</a></div><div class="nav-item"><a href="/blog/css/" class="nav-link">
  CSS
</a></div><div class="nav-item"><a href="/blog/javascript/" class="nav-link">
  JS&amp;TS
</a></div><div class="nav-item"><a href="/blog/node/" class="nav-link">
  Node
</a></div><div class="nav-item"><a href="/blog/devops/" class="nav-link">
  前端工程化
</a></div><div class="nav-item"><a href="/blog/mobile/" class="nav-link">
  泛客户端
</a></div><div class="nav-item"><a href="/blog/framework/" class="nav-link">
  架构&amp;方案
</a></div><div class="nav-item"><a href="/blog/code/" class="nav-link">
  算法&amp;编程
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="GitHub" class="dropdown-title"><span class="title">GitHub</span> <span class="arrow down"></span></button> <button type="button" aria-label="GitHub" class="mobile-dropdown-title"><span class="title">GitHub</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/jonny-wei" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub地址
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Vue</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/vue/" aria-current="page" class="sidebar-link">Vue 组件通信</a></li><li><a href="/blog/vue/interview/vue-symbols.html" class="sidebar-link">Vue 修饰符</a></li><li><a href="/blog/vue/interview/vue-test.html" class="sidebar-link">Vue 单元测试</a></li><li><a href="/blog/vue/interview/vue-router.html" class="sidebar-link">Vue 路由原理</a></li><li><a href="/blog/vue/interview/vue-vuex.html" class="sidebar-link">Vuex 实现原理</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Vue源码解析</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/vue/vue/github.html" class="sidebar-link">源码学习</a></li><li><a href="/blog/vue/vue/vue-render.html" class="sidebar-link">渲染器</a></li><li><a href="/blog/vue/vue/vue-init.html" class="sidebar-link">构建与初始化</a></li><li><a href="/blog/vue/vue/vue-component.html" class="sidebar-link">组件化过程</a></li><li><a href="/blog/vue/vue/vue-observer.html" class="sidebar-link">响应式原理</a></li><li><a href="/blog/vue/vue/vue-template.html" aria-current="page" class="active sidebar-link">模板编译与渲染</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/vue/vue/vue-template.html#什么是模板编译" class="sidebar-link">什么是模板编译</a></li><li class="sidebar-sub-header"><a href="/blog/vue/vue/vue-template.html#模板转换成视图的过程" class="sidebar-link">模板转换成视图的过程</a></li><li class="sidebar-sub-header"><a href="/blog/vue/vue/vue-template.html#模板编译原理" class="sidebar-link">模板编译原理</a></li><li class="sidebar-sub-header"><a href="/blog/vue/vue/vue-template.html#模板编译整体流程" class="sidebar-link">模板编译整体流程</a></li></ul></li><li><a href="/blog/vue/vue/vue-diff.html" class="sidebar-link">虚拟 DOM 与 Diff 算法</a></li><li><a href="/blog/vue/vue/vue-nextTick.html" class="sidebar-link">异步更新队列</a></li><li><a href="/blog/vue/vue/vue-lifecycle.html" class="sidebar-link">生命周期</a></li><li><a href="/blog/vue/vue/vue-computed.html" class="sidebar-link">计算属性与侦听器</a></li><li><a href="/blog/vue/vue/vue-slot.html" class="sidebar-link">插槽</a></li><li><a href="/blog/vue/vue/vue-directive.html" class="sidebar-link">Vue 指令</a></li><li><a href="/blog/vue/vue/vue-event.html" class="sidebar-link">事件绑定原理</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>VueRouter源码解析</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/vue/vue-router/abstract.html" class="sidebar-link">摘要</a></li><li><a href="/blog/vue/vue-router/warmUp.html" class="sidebar-link">准备工作</a></li><li><a href="/blog/vue/vue-router/plugin.html" class="sidebar-link">插件机制</a></li><li><a href="/blog/vue/vue-router/initialization.html" class="sidebar-link">初始化与降级处理</a></li><li><a href="/blog/vue/vue-router/transitions.html" class="sidebar-link">路由过渡与视图渲染</a></li><li><a href="/blog/vue/vue-router/match.html" class="sidebar-link">路由匹配</a></li><li><a href="/blog/vue/vue-router/scroll.html" class="sidebar-link">滚动行为处理</a></li><li><a href="/blog/vue/vue-router/summary.html" class="sidebar-link">总结</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Vuex源码解析</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/vue/vuex/abstract.html" class="sidebar-link">摘要</a></li><li><a href="/blog/vue/vuex/warmUp.html" class="sidebar-link">准备工作</a></li><li><a href="/blog/vue/vuex/initialization.html" class="sidebar-link">初始化与模块安装</a></li><li><a href="/blog/vue/vuex/state.html" class="sidebar-link">State 相关</a></li><li><a href="/blog/vue/vuex/getters.html" class="sidebar-link">Getters 相关</a></li><li><a href="/blog/vue/vuex/mutations.html" class="sidebar-link">Mutations 相关</a></li><li><a href="/blog/vue/vuex/actions.html" class="sidebar-link">Actions 相关</a></li><li><a href="/blog/vue/vuex/modules.html" class="sidebar-link">Modules 相关</a></li><li><a href="/blog/vue/vuex/others.html" class="sidebar-link">其他</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Vue3新特性</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/vue/vue3.x/abstract.html" class="sidebar-link">摘要</a></li><li><a href="/blog/vue/vue3.x/reactivity.html" class="sidebar-link">响应式系统</a></li><li><a href="/blog/vue/vue3.x/features.html" class="sidebar-link">功能方面</a></li><li><a href="/blog/vue/vue3.x/performance.html" class="sidebar-link">性能方面</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="模板编译与渲染"><a href="#模板编译与渲染" class="header-anchor">#</a> 模板编译与渲染</h1> <h2 id="什么是模板编译"><a href="#什么是模板编译" class="header-anchor">#</a> 什么是模板编译</h2> <p>Vue会把在 <code>&lt;template&gt;&lt;/template&gt;</code> 标签中写的类似于 <code>原生HTML</code> 的内容进行编译，把 <code>原生HTML</code> 的内容找出来，再把 <code>非原生HTML</code> 找出来，经过一系列的逻辑处理生成渲染函数，也就是 <code>render函数</code>，而 <code>render函数</code> 会将模板内容生成对应的<code>VNode</code>，而 <code>VNode</code> 再经过前几篇文章介绍的 <code>patch</code> 过程从而得到将要渲染的视图中的 <code>VNode</code>，最后根据 <code>VNode</code> 创建 <code>真实的DOM节点</code> 并插入到视图中， 最终完成视图的渲染更新。</p> <p>而把在 <code>&lt;template&gt;&lt;/template&gt;</code> 标签中写的类似于<code>原生HTML</code>的内容进行编译，把<code>原生HTML</code>的内容找出来，再把<code>非原生HTML</code>找出来，经过一系列的逻辑处理生成渲染函数，也就是<code>render函数</code>的这一段过程称之为<strong>模板编译</strong>过程。</p> <h2 id="模板转换成视图的过程"><a href="#模板转换成视图的过程" class="header-anchor">#</a> 模板转换成视图的过程</h2> <ul><li>Vue.js 通过编译将 template 模板转换成渲染函数 render，执行渲染函数就可以得到一个虚拟节点树。</li> <li>在对 Model 进行操作的时候，会触发对应 Dep 中的 Watcher 对象。Watcher 对象会调用对应的 update 来修改视图。这个过程主要是将新旧虚拟节点进行差异对比，然后根据对比结果进行 DOM 操作来更新视图。</li></ul> <p>简单点讲，在 Vue 的底层实现上，Vue 将模板编译成虚拟 DOM 渲染函数。结合 Vue 自带的响应系统，在状态改变时，Vue 能够智能地计算出重新渲染组件的最小代价并应到 DOM 操作上。</p> <p><img src="/blog/images/vue/%E6%A8%A1%E6%9D%BF%E7%BC%96%E8%AF%91%E4%B8%8E%E6%B8%B2%E6%9F%931.png" alt="模板编译与渲染1"></p> <ul><li>渲染函数：渲染函数是用来生成 Virtual DOM 的。Vue 推荐使用模板来构建我们的应用界面，在底层实现中 Vue 会将模板编译成渲染函数，当然我们也可以不写模板，直接写渲染函数，以获得更好的控制。</li> <li>VNode 虚拟节点：它可以代表一个真实的 dom 节点。通过 createElement 方法能将 VNode 渲染成 dom 节点。简单地说，vnode可以理解成节点描述对象，它描述了应该怎样去创建真实的DOM节点。</li> <li>patch：虚拟DOM最核心的部分，它可以将 vnode 渲染成真实的 DOM，这个过程是对比新旧虚拟节点之间有哪些不同，然后根据对比结果找出需要更新的的节点进行更新。这点我们从单词含义就可以看出， patch 本身就有补丁、修补的意思，其实际作用是在现有 DOM 上进行修改来实现更新视图的目的。Vue 的 Virtual DOM Patching 算法是基于 Snabbdom 的实现，并在些基础上作了很多的调整和改进。</li></ul> <p><img src="/blog/images/vue/%E6%A8%A1%E6%9D%BF%E7%BC%96%E8%AF%91%E4%B8%8E%E6%B8%B2%E6%9F%932.png" alt="模板编译与渲染2"></p> <h2 id="模板编译原理"><a href="#模板编译原理" class="header-anchor">#</a> 模板编译原理</h2> <p>之前我们分析过模板到真实 DOM 渲染的过程，中间有一个环节是把模板编译成 render 函数，这个过程我们把它称作<strong>编译</strong>。虽然我们可以直接为组件编写 <code>render</code> 函数，但是编写 <code>template</code> 模板更加直观，也更符合我们的开发习惯。<code>Vue.js</code> 提供了 2 个版本，一个是 <code>Runtime + Compiler</code> 的，一个是 <code>Runtime only</code> 的，前者是包含编译代码的，可以把编译过程放在运行时做，后者是不包含编译代码的，需要借助 webpack 的 <code>vue-loader</code> 事先把模板编译成 <code>render函数</code>。</p> <h3 id="编译入口"><a href="#编译入口" class="header-anchor">#</a> 编译入口</h3> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// src\platforms\web\entry-runtime-with-compiler.js</span>
<span class="token keyword">const</span> mount <span class="token operator">=</span> <span class="token class-name">Vue</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>$mount
<span class="token class-name">Vue</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">$mount</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>
  <span class="token parameter">el<span class="token operator">?</span><span class="token operator">:</span> string <span class="token operator">|</span> Element<span class="token punctuation">,</span>
  hydrating<span class="token operator">?</span><span class="token operator">:</span> boolean</span>
<span class="token punctuation">)</span><span class="token operator">:</span> Component <span class="token punctuation">{</span>
  el <span class="token operator">=</span> el <span class="token operator">&amp;&amp;</span> <span class="token function">query</span><span class="token punctuation">(</span>el<span class="token punctuation">)</span>

  <span class="token comment">/* istanbul ignore if */</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>el <span class="token operator">===</span> document<span class="token punctuation">.</span>body <span class="token operator">||</span> el <span class="token operator">===</span> document<span class="token punctuation">.</span>documentElement<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">'production'</span> <span class="token operator">&amp;&amp;</span> <span class="token function">warn</span><span class="token punctuation">(</span>
      <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Do not mount Vue to &lt;html&gt; or &lt;body&gt; - mount to normal elements instead.</span><span class="token template-punctuation string">`</span></span>
    <span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">const</span> options <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>$options
  <span class="token comment">// resolve template/el and convert to render function</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>options<span class="token punctuation">.</span>render<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> template <span class="token operator">=</span> options<span class="token punctuation">.</span>template
    <span class="token keyword">if</span> <span class="token punctuation">(</span>template<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> template <span class="token operator">===</span> <span class="token string">'string'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>template<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">'#'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          template <span class="token operator">=</span> <span class="token function">idToTemplate</span><span class="token punctuation">(</span>template<span class="token punctuation">)</span>
          <span class="token comment">/* istanbul ignore if */</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">'production'</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>template<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">warn</span><span class="token punctuation">(</span>
              <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Template element not found or is empty: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>options<span class="token punctuation">.</span>template<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
              <span class="token keyword">this</span>
            <span class="token punctuation">)</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>template<span class="token punctuation">.</span>nodeType<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        template <span class="token operator">=</span> template<span class="token punctuation">.</span>innerHTML
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">'production'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">'invalid template option:'</span> <span class="token operator">+</span> template<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>el<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      template <span class="token operator">=</span> <span class="token function">getOuterHTML</span><span class="token punctuation">(</span>el<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>template<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">/* istanbul ignore if */</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">'production'</span> <span class="token operator">&amp;&amp;</span> config<span class="token punctuation">.</span>performance <span class="token operator">&amp;&amp;</span> mark<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">mark</span><span class="token punctuation">(</span><span class="token string">'compile'</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">const</span> <span class="token punctuation">{</span> render<span class="token punctuation">,</span> staticRenderFns <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">compileToFunctions</span><span class="token punctuation">(</span>template<span class="token punctuation">,</span> <span class="token punctuation">{</span>
        outputSourceRange<span class="token operator">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">'production'</span><span class="token punctuation">,</span>
        shouldDecodeNewlines<span class="token punctuation">,</span>
        shouldDecodeNewlinesForHref<span class="token punctuation">,</span>
        delimiters<span class="token operator">:</span> options<span class="token punctuation">.</span>delimiters<span class="token punctuation">,</span>
        comments<span class="token operator">:</span> options<span class="token punctuation">.</span>comments
      <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span>
      options<span class="token punctuation">.</span>render <span class="token operator">=</span> render
      options<span class="token punctuation">.</span>staticRenderFns <span class="token operator">=</span> staticRenderFns

      <span class="token comment">/* istanbul ignore if */</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">'production'</span> <span class="token operator">&amp;&amp;</span> config<span class="token punctuation">.</span>performance <span class="token operator">&amp;&amp;</span> mark<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">mark</span><span class="token punctuation">(</span><span class="token string">'compile end'</span><span class="token punctuation">)</span>
        <span class="token function">measure</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">vue </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">this</span><span class="token punctuation">.</span>_name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> compile</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token string">'compile'</span><span class="token punctuation">,</span> <span class="token string">'compile end'</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token function">mount</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> el<span class="token punctuation">,</span> hydrating<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br></div></div><p>这段函数逻辑之前分析过，关于编译的入口就是在这里：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token punctuation">{</span> render<span class="token punctuation">,</span> staticRenderFns <span class="token punctuation">}</span> <span class="token operator">=</span>  <span class="token function">compileToFunctions</span><span class="token punctuation">(</span>template<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    shouldDecodeNewlines<span class="token punctuation">,</span>
    shouldDecodeNewlinesForHref<span class="token punctuation">,</span>
    delimiters<span class="token operator">:</span> options<span class="token punctuation">.</span>delimiters<span class="token punctuation">,</span>
    comments<span class="token operator">:</span> options<span class="token punctuation">.</span>comments
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span>
options<span class="token punctuation">.</span>render <span class="token operator">=</span> render
options<span class="token punctuation">.</span>staticRenderFns <span class="token operator">=</span> staticRenderFns
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p><code>compileToFunctions</code> 方法就是把模板 <code>template</code> 编译生成 <code>render</code> 以及 <code>staticRenderFns</code>。可以看到 compileToFunctions 方法实际上是 createCompiler 方法的返回值，该方法接收一个编译配置参数：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">const</span> createCompiler <span class="token operator">=</span> <span class="token function">createCompilerCreator</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token function">baseCompile</span> <span class="token punctuation">(</span>
  <span class="token parameter">template<span class="token operator">:</span> string<span class="token punctuation">,</span>
  options<span class="token operator">:</span> CompilerOptions</span>
<span class="token punctuation">)</span><span class="token operator">:</span> CompiledResult <span class="token punctuation">{</span>
  <span class="token keyword">const</span> ast <span class="token operator">=</span> <span class="token function">parse</span><span class="token punctuation">(</span>template<span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> options<span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>optimize <span class="token operator">!==</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">optimize</span><span class="token punctuation">(</span>ast<span class="token punctuation">,</span> options<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">const</span> code <span class="token operator">=</span> <span class="token function">generate</span><span class="token punctuation">(</span>ast<span class="token punctuation">,</span> options<span class="token punctuation">)</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    ast<span class="token punctuation">,</span>
    render<span class="token operator">:</span> code<span class="token punctuation">.</span>render<span class="token punctuation">,</span>
    staticRenderFns<span class="token operator">:</span> code<span class="token punctuation">.</span>staticRenderFns
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p><code>createCompiler</code> 方法实际上是通过调用 <code>createCompilerCreator</code> 方法返回的，该方法传入的参数是一个函数，真正的编译过程都在这个 <code>baseCompile</code> 函数里执行。<code>baseCompile</code> 才是真正的模板编译流程及原理所在。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">createCompilerCreator</span> <span class="token punctuation">(</span><span class="token parameter">baseCompile<span class="token operator">:</span> Function</span><span class="token punctuation">)</span><span class="token operator">:</span> Function <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token function">createCompiler</span> <span class="token punctuation">(</span><span class="token parameter">baseOptions<span class="token operator">:</span> CompilerOptions</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">function</span> <span class="token function">compile</span> <span class="token punctuation">(</span>
      <span class="token parameter">template<span class="token operator">:</span> string<span class="token punctuation">,</span>
      options<span class="token operator">?</span><span class="token operator">:</span> CompilerOptions</span>
    <span class="token punctuation">)</span><span class="token operator">:</span> CompiledResult <span class="token punctuation">{</span>
      <span class="token keyword">const</span> finalOptions <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>baseOptions<span class="token punctuation">)</span>
      <span class="token keyword">const</span> errors <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
      <span class="token keyword">const</span> tips <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
      finalOptions<span class="token punctuation">.</span><span class="token function-variable function">warn</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">msg<span class="token punctuation">,</span> tip</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token punctuation">(</span>tip <span class="token operator">?</span> tips <span class="token operator">:</span> errors<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// merge custom modules</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>modules<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          finalOptions<span class="token punctuation">.</span>modules <span class="token operator">=</span>
            <span class="token punctuation">(</span>baseOptions<span class="token punctuation">.</span>modules <span class="token operator">||</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span>modules<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// merge custom directives</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>directives<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          finalOptions<span class="token punctuation">.</span>directives <span class="token operator">=</span> <span class="token function">extend</span><span class="token punctuation">(</span>
            Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>baseOptions<span class="token punctuation">.</span>directives <span class="token operator">||</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            options<span class="token punctuation">.</span>directives
          <span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// copy other options</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> key <span class="token keyword">in</span> options<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>key <span class="token operator">!==</span> <span class="token string">'modules'</span> <span class="token operator">&amp;&amp;</span> key <span class="token operator">!==</span> <span class="token string">'directives'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            finalOptions<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> options<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">const</span> compiled <span class="token operator">=</span> <span class="token function">baseCompile</span><span class="token punctuation">(</span>template<span class="token punctuation">,</span> finalOptions<span class="token punctuation">)</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">'production'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        errors<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>errors<span class="token punctuation">,</span> <span class="token function">detectErrors</span><span class="token punctuation">(</span>compiled<span class="token punctuation">.</span>ast<span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      compiled<span class="token punctuation">.</span>errors <span class="token operator">=</span> errors
      compiled<span class="token punctuation">.</span>tips <span class="token operator">=</span> tips
      <span class="token keyword">return</span> compiled
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token punctuation">{</span>
      compile<span class="token punctuation">,</span>
      compileToFunctions<span class="token operator">:</span> <span class="token function">createCompileToFunctionFn</span><span class="token punctuation">(</span>compile<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br></div></div><p>该方法返回了一个 createCompiler 的函数，它接收一个 baseOptions 的参数，返回的是一个对象，包括 compile 方法属性和 compileToFunctions 属性，这个 compileToFunctions 对应的就是 $mount 函数调用的 compileToFunctions 方法，它是调用 createCompileToFunctionFn 方法的返回值，我们接下来看一下 createCompileToFunctionFn 方法:</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">createCompileToFunctionFn</span> <span class="token punctuation">(</span><span class="token parameter">compile<span class="token operator">:</span> Function</span><span class="token punctuation">)</span><span class="token operator">:</span> Function <span class="token punctuation">{</span>
  <span class="token keyword">const</span> cache <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span>

  <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token function">compileToFunctions</span> <span class="token punctuation">(</span>
    <span class="token parameter">template<span class="token operator">:</span> string<span class="token punctuation">,</span>
    options<span class="token operator">?</span><span class="token operator">:</span> CompilerOptions<span class="token punctuation">,</span>
    vm<span class="token operator">?</span><span class="token operator">:</span> Component</span>
  <span class="token punctuation">)</span><span class="token operator">:</span> CompiledFunctionResult <span class="token punctuation">{</span>
    options <span class="token operator">=</span> <span class="token function">extend</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> options<span class="token punctuation">)</span>
    <span class="token keyword">const</span> warn <span class="token operator">=</span> options<span class="token punctuation">.</span>warn <span class="token operator">||</span> baseWarn
    <span class="token keyword">delete</span> options<span class="token punctuation">.</span>warn

    <span class="token comment">/* istanbul ignore if */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">'production'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// detect possible CSP restriction</span>
      <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token keyword">new</span> <span class="token class-name">Function</span><span class="token punctuation">(</span><span class="token string">'return 1'</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">unsafe-eval|CSP</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">warn</span><span class="token punctuation">(</span>
            <span class="token string">'It seems you are using the standalone build of Vue.js in an '</span> <span class="token operator">+</span>
            <span class="token string">'environment with Content Security Policy that prohibits unsafe-eval. '</span> <span class="token operator">+</span>
            <span class="token string">'The template compiler cannot work in this environment. Consider '</span> <span class="token operator">+</span>
            <span class="token string">'relaxing the policy to allow unsafe-eval or pre-compiling your '</span> <span class="token operator">+</span>
            <span class="token string">'templates into render functions.'</span>
          <span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// check cache</span>
    <span class="token keyword">const</span> key <span class="token operator">=</span> options<span class="token punctuation">.</span>delimiters
      <span class="token operator">?</span> <span class="token function">String</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span>delimiters<span class="token punctuation">)</span> <span class="token operator">+</span> template
      <span class="token operator">:</span> template
    <span class="token keyword">if</span> <span class="token punctuation">(</span>cache<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> cache<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// compile</span>
    <span class="token keyword">const</span> compiled <span class="token operator">=</span> <span class="token function">compile</span><span class="token punctuation">(</span>template<span class="token punctuation">,</span> options<span class="token punctuation">)</span>

    <span class="token comment">// check compilation errors/tips</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">'production'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>compiled<span class="token punctuation">.</span>errors <span class="token operator">&amp;&amp;</span> compiled<span class="token punctuation">.</span>errors<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">warn</span><span class="token punctuation">(</span>
          <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Error compiling template:\n\n</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>template<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">\n\n</span><span class="token template-punctuation string">`</span></span> <span class="token operator">+</span>
          compiled<span class="token punctuation">.</span>errors<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">e</span> <span class="token operator">=&gt;</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">- </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>e<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">'\n'</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'\n'</span><span class="token punctuation">,</span>
          vm
        <span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>compiled<span class="token punctuation">.</span>tips <span class="token operator">&amp;&amp;</span> compiled<span class="token punctuation">.</span>tips<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        compiled<span class="token punctuation">.</span>tips<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">msg</span> <span class="token operator">=&gt;</span> <span class="token function">tip</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> vm<span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// turn code into functions</span>
    <span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token keyword">const</span> fnGenErrors <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    res<span class="token punctuation">.</span>render <span class="token operator">=</span> <span class="token function">createFunction</span><span class="token punctuation">(</span>compiled<span class="token punctuation">.</span>render<span class="token punctuation">,</span> fnGenErrors<span class="token punctuation">)</span>
    res<span class="token punctuation">.</span>staticRenderFns <span class="token operator">=</span> compiled<span class="token punctuation">.</span>staticRenderFns<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">code</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token function">createFunction</span><span class="token punctuation">(</span>code<span class="token punctuation">,</span> fnGenErrors<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

    <span class="token comment">// check function generation errors.</span>
    <span class="token comment">// this should only happen if there is a bug in the compiler itself.</span>
    <span class="token comment">// mostly for codegen development use</span>
    <span class="token comment">/* istanbul ignore if */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">'production'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">!</span>compiled<span class="token punctuation">.</span>errors <span class="token operator">||</span> <span class="token operator">!</span>compiled<span class="token punctuation">.</span>errors<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> fnGenErrors<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">warn</span><span class="token punctuation">(</span>
          <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Failed to generate render function:\n\n</span><span class="token template-punctuation string">`</span></span> <span class="token operator">+</span>
          fnGenErrors<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> err<span class="token punctuation">,</span> code <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>err<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> in\n\n</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>code<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">\n</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">'\n'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
          vm
        <span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token punctuation">(</span>cache<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> res<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br></div></div><p><code>compileToFunctions</code> 接收 3 个参数、<code>编译模板 template</code>，<code>编译配置 options</code> 和 <code>Vue 实例 vm</code>。</p> <p><strong>模板编译的过程</strong>：<code>template ---z&gt; compiler(parse,optimize,generate) ---&gt; render 函数(VNode)</code></p> <p>模板编译通过 Compiler 完成，compiler 可以分成 <code>parse</code>、<code>optimize</code> 与 <code>generate</code> 三个阶段，最终得到 <code>render function</code>。compile 函数在执行 <code>createCompileToFunctionFn</code> 的时候作为参数传入，它是 <code>createCompiler</code> 函数中定义的 compile 函数。Vue.js 利用了函数柯里化的技巧很好的实现了 baseOptions 的参数保留。同样，Vue.js 也是利用函数柯里化技巧把基础的编译过程函数抽出来，通过 <code>createCompilerCreator(baseCompile)</code> 的方式把真正编译的过程和其它逻辑如对编译配置处理、缓存处理等剥离开，这样的设计还是非常巧妙的。</p> <p>编译的入口最终终于找到了，主要就是执行了如下几个逻辑：</p> <ol><li><p>Parse 解析：解析模板字符串生成 AST</p> <p>Parse 会用正则等方式解析 template 模版中的指令、class、style 等数据，形成 AST。</p></li> <li><p>Optimize 优化：优化语法树</p> <p>Optimize 的主要作用是标记 static 静态节点，这时 Vue 在编译过程中的优化，后面当 update 更新界面时，会有一个 patch 的过程，diff 算法会直接跳过静态节点，从而减少了比较的过程，优化了 patch 的性能。</p></li> <li><p>Generate 生成：生成代码</p> <p>Generate 是将 AST 转化成 render function 字符串的过程，得到结果是 render 的字符串以及 staticRenderFns 字符串。</p></li></ol> <p>最终 baseCompile 的返回值:</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token punctuation">{</span>
  ast<span class="token operator">:</span> ast<span class="token punctuation">,</span>
  render<span class="token operator">:</span> code<span class="token punctuation">.</span>render<span class="token punctuation">,</span>
  staticRenderFns<span class="token operator">:</span> code<span class="token punctuation">.</span>staticRenderFns
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>最终返回了<code>抽象语法树( ast )</code>，<code>渲染函数( render )</code>，<code>静态渲染函数( staticRenderFns )</code>，且 render 的值为 <code>code.render</code>，staticRenderFns 的值为 <code>code.staticRenderFns</code>，也就是说通过 generate 处理 ast 之后得到的返回值 code 是一个对象。</p> <p>在经历过 Parse、Optimize 与 Generate 这三个阶段之后，组件中就会得到用于渲染 VNode 所需的 render 函数了。</p> <h3 id="parse-解析"><a href="#parse-解析" class="header-anchor">#</a> Parse 解析</h3> <p>解析整个模板的时候它的流程应该是这样子的：HTML解析器是主线，先用HTML解析器进行解析整个模板，在解析过程中如果碰到文本内容，那就调用文本解析器来解析文本，如果碰到文本中包含过滤器那就调用过滤器解析器来解析。</p> <p><img src="/blog/images/vue/%E6%A8%A1%E6%9D%BF%E8%A7%A3%E6%9E%901.png" alt="模板解析1"></p> <p>模板解析其实就是根据被解析内容的特点使用正则等方式将有效信息解析提取出来，根据解析内容的不同分为 HTML 解析器，文本解析器和过滤器解析器。而文本信息与过滤器信息又存在于 HTML 标签中，所以在解析器主线函数 parse 中先调用 HTML 解析器parseHTML 函数对模板字符串进行解析，如果在解析过程中遇到文本或过滤器信息则再调用相应的解析器进行解析，最终完成对整个模板字符串的解析。解析器内维护了一个栈，用来保证构建的AST节点层级与真正DOM层级一致。文本解析器的作用就是将HTML解析器解析得到的文本内容进行二次解析，解析文本内容中是否包含变量，如果包含变量，则将变量提取出来进行加工，为后续生产render函数做准备。</p> <h3 id="optimize-优化"><a href="#optimize-优化" class="header-anchor">#</a> Optimize 优化</h3> <p>有一种节点一旦首次渲染上了之后不管状态再怎么变化它都不会变了，这种节点叫做静态节点。模板编译的最终目的是用模板生成一个 render 函数，而用 render 函数就可以生成与模板对应的 VNode，之后再进行 patch 算法，最后完成视图渲染。这中间的 patch 算法又是用来对比新旧 VNode 之间存在的差异。在上面我们还说了，静态节点不管状态怎么变化它是不会变的，基于此，我们可以在模板编译的时候就先找出模板中所有的静态节点和静态根节点，然后给它们打上标记，告诉后面 patch 过程打了标记的这些节点是不需要对比的，只需克隆一份，在 patch 过程中不用去对比这些静态节点了，这就是优化阶段存在的意义。</p> <p>优化阶段其实就干了两件事：</p> <ol><li>在 AST 中找出所有<strong>静态节点</strong>并打上标记；</li> <li>在 AST 中找出所有<strong>静态根节点</strong>并打上标记；</li></ol> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">optimize</span> <span class="token punctuation">(</span><span class="token parameter">root<span class="token operator">:</span> <span class="token operator">?</span>ASTElement<span class="token punctuation">,</span> options<span class="token operator">:</span> CompilerOptions</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>root<span class="token punctuation">)</span> <span class="token keyword">return</span>
  isStaticKey <span class="token operator">=</span> <span class="token function">genStaticKeysCached</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span>staticKeys <span class="token operator">||</span> <span class="token string">''</span><span class="token punctuation">)</span>
  isPlatformReservedTag <span class="token operator">=</span> options<span class="token punctuation">.</span>isReservedTag <span class="token operator">||</span> no
  <span class="token comment">// 标记静态节点</span>
  <span class="token function">markStatic</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span>
  <span class="token comment">// 标记静态根节点</span>
  <span class="token function">markStaticRoots</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h4 id="标记静态节点"><a href="#标记静态节点" class="header-anchor">#</a> 标记静态节点</h4> <p>从 AST 中找出所有静态节点并标记其实不难，我们只需从根节点开始，先标记根节点是否为静态节点，然后看根节点如果是元素节点，那么就去向下递归它的子节点，子节点如果还有子节点那就继续向下递归，直到标记完所有节点。</p> <p>如果元素节点是静态节点，那就必须满足以下几点要求：</p> <ul><li>如果节点使用了 <code>v-pre</code> 指令，那就断定它是静态节点；</li> <li>如果节点没有使用 <code>v-pre</code> 指令，那它要成为静态节点必须满足：
<ul><li>不能使用动态绑定语法，即标签上不能有 <code>v-</code>、<code>@</code>、<code>:</code>开头的属性</li> <li>不能使用 <code>v-if</code>、<code>v-else</code>、<code>v-for</code>指令</li> <li>不能是内置组件，即标签名不能是 <code>slot</code> 和 <code>component</code></li> <li>标签名必须是平台保留标签，即不能是组件</li> <li>当前节点的父节点不能是带有 <code>v-for</code> 的 <code>template</code> 标签</li> <li>节点的所有属性的 key 都必须是静态节点才有的 key，注：静态节点的 key 是有限的，它只能是 type, tag, attrsList,attrsMap, plain, parent, children, attrs 之一</li></ul></li></ul> <h4 id="标记静态根节点"><a href="#标记静态根节点" class="header-anchor">#</a> 标记静态根节点</h4> <p>寻找静态根节点根寻找静态节点的逻辑类似，都是从AST根节点递归向下遍历寻找。一个节点要想成为静态根节点，它必须满足以下要求，否则的话，对它的优化成本将大于优化后带来的收益。</p> <ul><li>节点本身必须是静态节点</li> <li>必须拥有子节点 children</li> <li>子节点不能只是只有一个文本节点</li></ul> <h3 id="generate-生成"><a href="#generate-生成" class="header-anchor">#</a> Generate 生成</h3> <p>Vue 实例在挂载的时候会调用其自身的 render 函数来生成实例上的 template 选项所对应的 VNode，简单的来说就是 Vue 只要调用了render 函数，就可以把模板转换成对应的虚拟 DOM。那么 Vue 要想调用 render 函数，那必须要先有这个 render 函数，那这个render函数又是从哪来的呢？是用户手写的还是 Vue 自己生成的？答案是都有可能。我们知道，我们在日常开发中是可以在 Vue 组件选项中手写一个 render 选项，其值对应一个函数，那这个函数就是 render 函数，当用户手写了 render 函数时，那么 Vue 在挂载该组件的时候就会调用用户手写的这个 render 函数。那如果用户没有写呢？那这个时候 Vue 就要自己根据模板内容生成一个 render 函数供组件挂载的时候调用。而 Vue 自己根据模板内容生成 render 函数的过程就是本篇文章所要介绍的代码生成阶段。</p> <p>生成代码就是要生成 render 函数字符串。所谓代码生成其实就是根据模板对应的抽象语法树 AST 生成一个函数供组件挂载时调用，通过调用这个函数就可以得到模板对应的虚拟DOM。</p> <h2 id="模板编译整体流程"><a href="#模板编译整体流程" class="header-anchor">#</a> 模板编译整体流程</h2> <p><img src="/blog/images/vue/%E6%A8%A1%E6%9D%BF%E7%BC%96%E8%AF%912.png" alt="模板编译2"></p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/blog/vue/vue/vue-observer.html" class="prev">
        响应式原理
      </a></span> <span class="next"><a href="/blog/vue/vue/vue-diff.html">
        虚拟 DOM 与 Diff 算法
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----><!----><!----><!----></div></div>
    <script src="/blog/assets/js/app.dc60fa76.js" defer></script><script src="/blog/assets/js/2.8bf77cff.js" defer></script><script src="/blog/assets/js/152.3d8d52cf.js" defer></script><script src="/blog/assets/js/4.ff6074e9.js" defer></script>
  </body>
</html>
