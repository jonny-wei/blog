<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>初始化与降级处理 | 花帽子的博客</title>
    <meta name="generator" content="VuePress 1.7.1">
    <link rel="icon" href="/blog/logo.png">
    <link rel="manifest" href="/blog/manifest.json">
    <link rel="apple-touch-icon" href="/blog/images/icons/apple-icon-152x152.png">
    <meta name="description" content="我命由我不由天，学习吧少年">
    <meta name="theme-color" content="#3eaf7c">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="msapplication-TileImage" content="/icons/ms-icon-144x144.png">
    <meta name="msapplication-TileColor" content="#000000">
    
    <link rel="preload" href="/blog/assets/css/0.styles.4a49bc7c.css" as="style"><link rel="preload" href="/blog/assets/js/app.8c0e21f4.js" as="script"><link rel="preload" href="/blog/assets/js/2.2a4e8c54.js" as="script"><link rel="preload" href="/blog/assets/js/23.23588340.js" as="script"><link rel="preload" href="/blog/assets/js/3.07d27621.js" as="script"><link rel="prefetch" href="/blog/assets/js/10.a1529350.js"><link rel="prefetch" href="/blog/assets/js/11.c1a0135c.js"><link rel="prefetch" href="/blog/assets/js/12.99ded477.js"><link rel="prefetch" href="/blog/assets/js/13.2521a16e.js"><link rel="prefetch" href="/blog/assets/js/14.133aa108.js"><link rel="prefetch" href="/blog/assets/js/15.6d4bda15.js"><link rel="prefetch" href="/blog/assets/js/16.ba074823.js"><link rel="prefetch" href="/blog/assets/js/17.301089ac.js"><link rel="prefetch" href="/blog/assets/js/18.322991d6.js"><link rel="prefetch" href="/blog/assets/js/19.ec1e3725.js"><link rel="prefetch" href="/blog/assets/js/20.1783200a.js"><link rel="prefetch" href="/blog/assets/js/21.0c26b5a2.js"><link rel="prefetch" href="/blog/assets/js/22.52e001de.js"><link rel="prefetch" href="/blog/assets/js/24.db64810d.js"><link rel="prefetch" href="/blog/assets/js/25.66cef743.js"><link rel="prefetch" href="/blog/assets/js/26.5e4dba4d.js"><link rel="prefetch" href="/blog/assets/js/27.784c53fa.js"><link rel="prefetch" href="/blog/assets/js/28.7fa06bfa.js"><link rel="prefetch" href="/blog/assets/js/29.8555f961.js"><link rel="prefetch" href="/blog/assets/js/30.8f0c5b22.js"><link rel="prefetch" href="/blog/assets/js/31.491bf9df.js"><link rel="prefetch" href="/blog/assets/js/32.ed67849a.js"><link rel="prefetch" href="/blog/assets/js/33.85317e03.js"><link rel="prefetch" href="/blog/assets/js/34.03e230e0.js"><link rel="prefetch" href="/blog/assets/js/35.7918ce2c.js"><link rel="prefetch" href="/blog/assets/js/36.a6ec54e2.js"><link rel="prefetch" href="/blog/assets/js/37.1efa4804.js"><link rel="prefetch" href="/blog/assets/js/38.fedd23b0.js"><link rel="prefetch" href="/blog/assets/js/39.13426ff2.js"><link rel="prefetch" href="/blog/assets/js/4.2bef4353.js"><link rel="prefetch" href="/blog/assets/js/40.5681cfae.js"><link rel="prefetch" href="/blog/assets/js/41.77314b0c.js"><link rel="prefetch" href="/blog/assets/js/42.04df6381.js"><link rel="prefetch" href="/blog/assets/js/43.6c0cc2ec.js"><link rel="prefetch" href="/blog/assets/js/44.e2d4ba71.js"><link rel="prefetch" href="/blog/assets/js/45.d4830d14.js"><link rel="prefetch" href="/blog/assets/js/5.5d40c251.js"><link rel="prefetch" href="/blog/assets/js/6.08d6e999.js"><link rel="prefetch" href="/blog/assets/js/7.96560134.js"><link rel="prefetch" href="/blog/assets/js/8.f4a7eed1.js"><link rel="prefetch" href="/blog/assets/js/9.72652230.js">
    <link rel="stylesheet" href="/blog/assets/css/0.styles.4a49bc7c.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/blog/" class="home-link router-link-active"><img src="/blog/logo.png" alt="花帽子的博客" class="logo"> <span class="site-name can-hide">花帽子的博客</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/blog/" class="nav-link">
  主页
</a></div><div class="nav-item"><a href="/blog/vue/vue/vue-render.html" class="nav-link">
  Vue
</a></div><div class="nav-item"><a href="/blog/css/basis/abstract.html" class="nav-link">
  CSS
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="JS系列菜单" class="dropdown-title"><span class="title">JS</span> <span class="arrow down"></span></button> <button type="button" aria-label="JS系列菜单" class="mobile-dropdown-title"><span class="title">JS</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/javascript/book/chapter1.html" class="nav-link">
  JavaScript红宝书
</a></li></ul></div></div><div class="nav-item"><a href="/blog/typescript/" class="nav-link">
  TS
</a></div><div class="nav-item"><a href="/blog/optimization/" class="nav-link">
  优化
</a></div><div class="nav-item"><a href="/blog/mobile/" class="nav-link">
  移动端
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="GitHub" class="dropdown-title"><span class="title">GitHub</span> <span class="arrow down"></span></button> <button type="button" aria-label="GitHub" class="mobile-dropdown-title"><span class="title">GitHub</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/jonny-wei" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub地址
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/blog/" class="nav-link">
  主页
</a></div><div class="nav-item"><a href="/blog/vue/vue/vue-render.html" class="nav-link">
  Vue
</a></div><div class="nav-item"><a href="/blog/css/basis/abstract.html" class="nav-link">
  CSS
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="JS系列菜单" class="dropdown-title"><span class="title">JS</span> <span class="arrow down"></span></button> <button type="button" aria-label="JS系列菜单" class="mobile-dropdown-title"><span class="title">JS</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/javascript/book/chapter1.html" class="nav-link">
  JavaScript红宝书
</a></li></ul></div></div><div class="nav-item"><a href="/blog/typescript/" class="nav-link">
  TS
</a></div><div class="nav-item"><a href="/blog/optimization/" class="nav-link">
  优化
</a></div><div class="nav-item"><a href="/blog/mobile/" class="nav-link">
  移动端
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="GitHub" class="dropdown-title"><span class="title">GitHub</span> <span class="arrow down"></span></button> <button type="button" aria-label="GitHub" class="mobile-dropdown-title"><span class="title">GitHub</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/jonny-wei" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub地址
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Vue秘籍</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/vue/vue/guide.html" class="sidebar-link">js 高级技巧</a></li><li><a href="/blog/vue/vue/vue-render.html" class="sidebar-link">vue渲染原理</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Vue源码解析</span> <!----></p> <!----></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>VueRouter源码解析</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/vue/vue-router/abstract.html" class="sidebar-link">摘要</a></li><li><a href="/blog/vue/vue-router/warmUp.html" class="sidebar-link">准备工作</a></li><li><a href="/blog/vue/vue-router/plugin.html" class="sidebar-link">插件机制</a></li><li><a href="/blog/vue/vue-router/initialization.html" aria-current="page" class="active sidebar-link">初始化与降级处理</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/vue/vue-router/initialization.html#vuerouter-类" class="sidebar-link">VueRouter 类</a></li><li class="sidebar-sub-header"><a href="/blog/vue/vue-router/initialization.html#构造方法及降级处理" class="sidebar-link">构造方法及降级处理</a></li><li class="sidebar-sub-header"><a href="/blog/vue/vue-router/initialization.html#实例化不同的-history" class="sidebar-link">实例化不同的 history</a></li><li class="sidebar-sub-header"><a href="/blog/vue/vue-router/initialization.html#初始化-router-实例" class="sidebar-link">初始化 router 实例</a></li></ul></li><li><a href="/blog/vue/vue-router/transitions.html" class="sidebar-link">路由过渡与视图渲染</a></li><li><a href="/blog/vue/vue-router/match.html" class="sidebar-link">路由匹配</a></li><li><a href="/blog/vue/vue-router/scroll.html" class="sidebar-link">滚动行为处理</a></li><li><a href="/blog/vue/vue-router/summary.html" class="sidebar-link">总结</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Vuex源码解析</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/vue/vuex/abstract.html" class="sidebar-link">摘要</a></li><li><a href="/blog/vue/vuex/warmUp.html" class="sidebar-link">准备工作</a></li><li><a href="/blog/vue/vuex/initialization.html" class="sidebar-link">初始化与模块安装</a></li><li><a href="/blog/vue/vuex/state.html" class="sidebar-link">State 相关</a></li><li><a href="/blog/vue/vuex/getters.html" class="sidebar-link">Getters 相关</a></li><li><a href="/blog/vue/vuex/mutations.html" class="sidebar-link">Mutations 相关</a></li><li><a href="/blog/vue/vuex/actions.html" class="sidebar-link">Actions 相关</a></li><li><a href="/blog/vue/vuex/modules.html" class="sidebar-link">Modules 相关</a></li><li><a href="/blog/vue/vuex/others.html" class="sidebar-link">其他</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Vue3新特性</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/vue/vue3.x/abstract.html" class="sidebar-link">摘要</a></li><li><a href="/blog/vue/vue3.x/reactivity.html" class="sidebar-link">响应式系统</a></li><li><a href="/blog/vue/vue3.x/features.html" class="sidebar-link">功能方面</a></li><li><a href="/blog/vue/vue3.x/performance.html" class="sidebar-link">性能方面</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="初始化与降级处理"><a href="#初始化与降级处理" class="header-anchor">#</a> 初始化与降级处理</h1> <p>在这一节，我们会分析 VueRouter 类及其构造方法、路由初始化工作和路由模式降级处理原理，有关代码在 index.js 入口文件中。
在阅读这部分源码时，参考 <a href="https://router.vuejs.org/zh/api/" target="_blank" rel="noopener noreferrer">官方 vue-router 的 API 参考文档<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 会理解的更好。</p> <h2 id="vuerouter-类"><a href="#vuerouter-类" class="header-anchor">#</a> VueRouter 类</h2> <p>首先还是先看看代码骨架，从整体认识：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">/* 导出的VueRouter对象，用来包装store */</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">VueRouter</span> <span class="token punctuation">{</span>
    <span class="token function">constructor</span> <span class="token punctuation">(</span><span class="token parameter">options<span class="token operator">:</span> RouterOptions <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">/*...*/</span><span class="token punctuation">}</span>
    
    <span class="token function">match</span> <span class="token punctuation">(</span>
        raw<span class="token operator">:</span> RawLocation<span class="token punctuation">,</span>
        current<span class="token operator">?</span><span class="token operator">:</span> Route<span class="token punctuation">,</span>
        redirectedFrom<span class="token operator">?</span><span class="token operator">:</span> Location
     <span class="token punctuation">)</span><span class="token operator">:</span> Route <span class="token punctuation">{</span><span class="token comment">/*...*/</span><span class="token punctuation">}</span>
     
     <span class="token comment">/* 当前路由对应的路由信息对象 */</span>
     <span class="token keyword">get</span> <span class="token function">currentRoute</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token operator">?</span>Route <span class="token punctuation">{</span><span class="token comment">/*...*/</span><span class="token punctuation">}</span>
     
     <span class="token function">init</span> <span class="token punctuation">(</span>app<span class="token operator">:</span> any <span class="token comment">/* Vue component instance */</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">/*...*/</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>在 VueRouter 类中定义了一些属性和方法，我们关注的重点有 <strong><code>constructor (options: RouterOptions = {})</code></strong> 构造方法，
<strong><code>match</code></strong> 匹配方法以及 <strong><code>init()</code></strong> 初始化操作。</p> <p>接下来具体分析</p> <h2 id="构造方法及降级处理"><a href="#构造方法及降级处理" class="header-anchor">#</a> 构造方法及降级处理</h2> <p>当我们执行  new VueRouter() 时，会执行构造方法，那么我们看看构造方法中做了哪些事情：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">/* scr/index.js */</span>

<span class="token function">constructor</span> <span class="token punctuation">(</span><span class="token parameter">options<span class="token operator">:</span> RouterOptions <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>app <span class="token operator">=</span> <span class="token keyword">null</span> <span class="token comment">// vue根实例</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>apps <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token comment">// 保存有$options.router 属性的 Vue 实例</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>options <span class="token operator">=</span> options <span class="token comment">// 传入的路由配置</span>
    <span class="token comment">/* 一些钩子函数 */</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>beforeHooks <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>resolveHooks <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>afterHooks <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token comment">/*  this.matcher 创建核心的matcher对象 路由匹配器*/</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>matcher <span class="token operator">=</span> <span class="token function">createMatcher</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span>routes <span class="token operator">||</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span>
    <span class="token comment">/* 默认hash模式 */</span>
    <span class="token keyword">let</span> mode <span class="token operator">=</span> options<span class="token punctuation">.</span>mode <span class="token operator">||</span> <span class="token string">'hash'</span>
    <span class="token comment">/* 是否降级处理
       this.fallback 选择了history模式但是浏览器不支持 则回退到hash路由 降级处理*/</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>fallback <span class="token operator">=</span> mode <span class="token operator">===</span> <span class="token string">'history'</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>supportsPushState <span class="token operator">&amp;&amp;</span> options<span class="token punctuation">.</span>fallback <span class="token operator">!==</span> <span class="token boolean">false</span>
    <span class="token comment">/* 降级为hash模式（显示声明为hash模式 | 不支持history模式 | 要求降级fallback:true）*/</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>fallback<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      mode <span class="token operator">=</span> <span class="token string">'hash'</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>inBrowser<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      mode <span class="token operator">=</span> <span class="token string">'abstract'</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>mode <span class="token operator">=</span> mode <span class="token comment">// this.mode路由模式</span>
    <span class="token comment">/**
    * 根据mode来新建不同的实例（HTML5History | HashHistory | AbstractHistory）给history属性
    * 根据 history 的类型，采取不同的方式切换路由
    */</span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span>mode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">/*  this.history 路由历史的具体的实现实例  */</span>
      <span class="token keyword">case</span> <span class="token string">'history'</span><span class="token operator">:</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>history <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HTML5History</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> options<span class="token punctuation">.</span>base<span class="token punctuation">)</span>
        <span class="token keyword">break</span>
      <span class="token keyword">case</span> <span class="token string">'hash'</span><span class="token operator">:</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>history <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashHistory</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> options<span class="token punctuation">.</span>base<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>fallback<span class="token punctuation">)</span>
        <span class="token keyword">break</span>
      <span class="token keyword">case</span> <span class="token string">'abstract'</span><span class="token operator">:</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>history <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AbstractHistory</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> options<span class="token punctuation">.</span>base<span class="token punctuation">)</span>
        <span class="token keyword">break</span>
      <span class="token keyword">default</span><span class="token operator">:</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">'production'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">assert</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">invalid mode: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>mode<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre></div><p>构造函数定义了一些属性，其中 <code>this.app</code>表示<strong>根 Vue 实例</strong>，<code>this.apps</code> 保存<code>持有 $options.router 属性的 Vue 实例</code>，
<code>this.options</code> 保存传入的<strong>路由配置</strong>，<code>this.beforeHooks</code>、<code>this.resolveHooks</code>、<code>this.afterHooks</code> 表示一些<strong>钩子函数</strong>，
我们之后会介绍，<code>this.matcher</code> 表示<strong>路由匹配器</strong>，我们之后会介绍，<code>this.fallback</code> 表示在浏览器不支持 history.pushState 的情况下，
根据传入的 fallback 配置参数，<strong>决定是否回退到 hash 模式</strong>，
<code>this.mode</code> 表示<strong>路由</strong>创建的<strong>模式</strong>，<code>this.history</code> 表示<strong>路由历史的具体的实现实例</strong>，
它是根据 this.mode 的不同实现不同，它有 <code>History 基类</code>，然后不同的 history 实现都是继承 History。</p> <div class="custom-block tip"><p class="custom-block-title">路由模式</p> <ul><li>hash: 使用 URL hash 值来作路由。支持所有浏览器，包括不支持 HTML5 History Api 的浏览器。</li> <li>history: 依赖 HTML5 History API 和服务器配置。可查看 HTML5 History 模式。</li> <li>abstract: 支持所有 JavaScript 运行环境，如 Node.js 服务器端。如果发现没有浏览器的 API，路由会自动强制进入这个模式。</li></ul></div> <p>vue-router 默认是 hash 模式 ， 即使用 URL 的 hash 来模拟一个完整的 URL ，于是当 URL 改变时，页面不会重新加载。</p> <p>vue-router 还支持 history 模式，这种模式充分利用了 history.pushState 来完成 URL 跳转,在不支持 history.pushState 的浏览器，
会自动会退到 hash 模式。</p> <p>判断是否支持 history ， 然后根据 fallback 来确定是否要降级。接着根据不同的 mode，
分别实例化不同的 history ：HTML5History、HashHistory、AbstractHistory。</p> <p>那么，接下来我们就剖析一下 VueRouter 构造方法中根据 mode 路由模式是如何实例化不同的 history 的。</p> <h2 id="实例化不同的-history"><a href="#实例化不同的-history" class="header-anchor">#</a> 实例化不同的 history</h2> <p>三种不同的 history 实例 <code>HTML5History</code>、<code>HashHistory</code>、<code>AbstractHistory</code> 分别在 history 文件夹中的
<code>html5.js</code> 、<code>hash.js</code> 以及 <code>abstract.js</code>。除此之外，还有个<code>base.js</code>，这个文件中主要定义了一个<code>History 基类</code>，而
<code>HTML5History</code>、<code>HashHistory</code>、<code>AbstractHistory</code>  这仨实例均<strong>继承自</strong> <code>History 基类</code>。</p> <div class="language-text extra-class"><pre class="language-text"><code>├── history  // 操作浏览器记录的一系列内容
│   ├── abstract.js  // 非浏览器的history
│   ├── base.js    // 基本的history
│   ├── hash.js    // hash模式的history
│   └── html5.js   // html5模式的history
</code></pre></div><p><code>HTML5History</code>、<code>HashHistory</code>、<code>AbstractHistory</code>  分别继承了 <code>History 基类</code> 中的方法，并实现了自己特有的逻辑。
从外部调用的时候，会直接调用到 this.history , 然后，由于初始化对象的不同，而进行不同的操作。</p> <p>上述，先对 history 初步了解一下，我们在后续介绍完一些核心逻辑（比如，路由切换transitionTo，路由匹配等）后，再后头做
进一步的分析。</p> <div class="custom-block tip"><p class="custom-block-title">总结</p> <p>到此，我们知道了 VueRouter 的构造方法主要做了以下事情：</p> <ul><li>定义了一些实例属性，钩子函数对象</li> <li>根据路由模式 <code>mode</code> 降级处理</li> <li>根据 <code>mode</code> 实例化不同的 history (后续会深入)。</li></ul></div> <p>我们知道实例化 VueRouter（new VueRouter()） 后会返回它的实例 router，我们在 new Vue 的时候会把 router 作为配置的属性传入，
回顾一下上一节我们讲 beforeCreate 混入的时候有这么一段代码：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token function">beforeCreate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>$options<span class="token punctuation">.</span>router<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_router <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>$options<span class="token punctuation">.</span>router
    <span class="token keyword">this</span><span class="token punctuation">.</span>_router<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
    <span class="token comment">// ...</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>  
</code></pre></div><p>组件在执行 beforeCreate 钩子函数的时候，如果传入了 router 实例，都会执行 router.init 方法,
下面我们就分析一下 VueRouter 的初始化操作：</p> <h2 id="初始化-router-实例"><a href="#初始化-router-实例" class="header-anchor">#</a> 初始化 router 实例</h2> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">/* src/index.js */</span>

<span class="token function">init</span> <span class="token punctuation">(</span>app<span class="token operator">:</span> any <span class="token comment">/* Vue component instance 参数：app 为vue根实例 构造函数中定义的 */</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">'production'</span> <span class="token operator">&amp;&amp;</span> <span class="token function">assert</span><span class="token punctuation">(</span>
      install<span class="token punctuation">.</span>installed<span class="token punctuation">,</span>
      <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">not installed. Make sure to call \`Vue.use(VueRouter)\` </span><span class="token template-punctuation string">`</span></span> <span class="token operator">+</span>
      <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">before creating root instance.</span><span class="token template-punctuation string">`</span></span>
    <span class="token punctuation">)</span>
    <span class="token comment">/**
    * this.apps 保存有$options.router 属性的 Vue 实例 将当前vm实例保存在app中
    * app为在router对象初始化时执行init方法的参数（根实例）
    * 将根实例添加到apps数组中（用于多次执行 VueRouter 创建多个实例，比较少用）
    */</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>apps<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span>

    <span class="token comment">// main app already initialized.</span>
    <span class="token comment">/* 判断是否初始化过，保证app实例只有一个 */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>app<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span>app <span class="token operator">=</span> app <span class="token comment">// this.app保存当前vm实例</span>

    <span class="token keyword">const</span> history <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>history <span class="token comment">// this.history路由历史实例</span>

    <span class="token comment">/* 根据不同的路由历史实例 做相应的操作 进行路由切换 后面详细分析*/</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>history <span class="token keyword">instanceof</span> <span class="token class-name">HTML5History</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      history<span class="token punctuation">.</span><span class="token function">transitionTo</span><span class="token punctuation">(</span>history<span class="token punctuation">.</span><span class="token function">getCurrentLocation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>history <span class="token keyword">instanceof</span> <span class="token class-name">HashHistory</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> <span class="token function-variable function">setupHashListener</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        history<span class="token punctuation">.</span><span class="token function">setupListeners</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      history<span class="token punctuation">.</span><span class="token function">transitionTo</span><span class="token punctuation">(</span>
        history<span class="token punctuation">.</span><span class="token function">getCurrentLocation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        setupHashListener<span class="token punctuation">,</span> <span class="token comment">// 成功回调(给哈希路由的模式监听浏览器的popState和hashchange)</span>
        setupHashListener <span class="token comment">// 取消回调</span>
      <span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment">/**
    * 注册回调，当history发生改变后会执行回调（src/history/base.js:221）
    * 即修改_route属性，因为_route属性是一个视图依赖的响应式变量，
    * 所以会触发视图的重新渲染至于触发 _route 的 setter 为什么会更新视图，
    * 请参考 router-view 组件 
    */</span>
    history<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token parameter">route</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>apps<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">app</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        app<span class="token punctuation">.</span>_route <span class="token operator">=</span> route
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
</code></pre></div><p>初始化时传入 Vue 实例（参数app），然后存储到 this.apps 中；只有根 Vue 实例会保存到 this.app 中，接着拿到当前的路由历史实例 this.history，
判断实例类型执行不同逻辑。如果是 history 模式，则直接执行 history.transitionTo 方法；如果是 hash 模式，则先定义一个 setupHashListener 函数，
接着执行 history.transitionTo 方法，它是定义在 History 基类中：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">/* src/history/base.js */</span>

 <span class="token function">transitionTo</span> <span class="token punctuation">(</span><span class="token parameter">location<span class="token operator">:</span> RawLocation<span class="token punctuation">,</span> onComplete<span class="token operator">?</span><span class="token operator">:</span> Function<span class="token punctuation">,</span> onAbort<span class="token operator">?</span><span class="token operator">:</span> Function</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token keyword">const</span> route <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>router<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>location<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>current<span class="token punctuation">)</span>
   <span class="token comment">// more 具体逻辑后续分析</span>
 <span class="token punctuation">}</span>
</code></pre></div><p>两种模式执行 history.transitionTo 方法时，都先执行了 history.getCurrentLocation() 它在 history 中是这样定义的：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">/* src/history/html5.js */</span>

<span class="token function">getCurrentLocation</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> string <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">getLocation</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>base<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
</code></pre></div><p>在 hash 中是这样定义的：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">/* src/history/hash.js */</span>

<span class="token function">getCurrentLocation</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">getHash</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
</code></pre></div><p>我们先不去看 transitionTo 的具体逻辑(后续会分析)，先看第一行代码，它调用了 this.router.match 方法,
match方法定义在 VueRouter 类中：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">/* src/index.js */</span>

 <span class="token function">match</span> <span class="token punctuation">(</span>
    raw<span class="token operator">:</span> RawLocation<span class="token punctuation">,</span>
    current<span class="token operator">?</span><span class="token operator">:</span> Route<span class="token punctuation">,</span>
    redirectedFrom<span class="token operator">?</span><span class="token operator">:</span> Location
  <span class="token punctuation">)</span><span class="token operator">:</span> Route <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>matcher<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>raw<span class="token punctuation">,</span> current<span class="token punctuation">,</span> redirectedFrom<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
</code></pre></div><p>如你所见，实际调用了 this.matcher.match() 去做路由匹配。</p> <div class="custom-block tip"><p class="custom-block-title">总结</p> <p>初始化 VueRouter 时传入 Vue 实例（参数app），然后存储到 this.apps 中；只有根 Vue 实例会保存到 this.app 中，接着拿到当前的路由历史实例 this.history，
判断实例类型执行不同逻辑。如果是 history 模式，则直接执行 history.transitionTo 方法；如果是 hash 模式，则先定义一个 setupHashListener 函数，
再执行 history.transitionTo 方法，完成初始化。执行 transitionTo 路由切换方法时，执行 match 路由匹配方法，接着执行 confirmTransition 导航确认方法。
然后 updateRoute更新路由，触发DOM更新。</p></div> <p>下面，我们就深入 transitionTo （路由过渡或叫路由切换）和 match （路由匹配）的相关实现</p></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">最近更新:</span> <span class="time">11/11/2020, 9:37:26 AM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/blog/vue/vue-router/plugin.html" class="prev">
        插件机制
      </a></span> <span class="next"><a href="/blog/vue/vue-router/transitions.html">
        路由过渡与视图渲染
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----><!----><!----><!----></div></div>
    <script src="/blog/assets/js/app.8c0e21f4.js" defer></script><script src="/blog/assets/js/2.2a4e8c54.js" defer></script><script src="/blog/assets/js/23.23588340.js" defer></script><script src="/blog/assets/js/3.07d27621.js" defer></script>
  </body>
</html>
