(window.webpackJsonp=window.webpackJsonp||[]).push([[70],{519:function(t,n,e){"use strict";e.r(n);var a=e(14),s=Object(a.a)({},(function(){var t=this,n=t.$createElement,e=t._self._c||n;return e("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[e("h1",{attrs:{id:"微前端"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#微前端"}},[t._v("#")]),t._v(" 微前端")]),t._v(" "),e("p",[e("a",{attrs:{href:"https://alili.tech/archive/ea599f7c/",target:"_blank",rel:"noopener noreferrer"}},[t._v("前端微服务化解决方案"),e("OutboundLink")],1)]),t._v(" "),e("p",[e("a",{attrs:{href:"https://juejin.cn/post/6844903943873675271#heading-0",target:"_blank",rel:"noopener noreferrer"}},[t._v("每日优鲜供应链前端团队微前端改造"),e("OutboundLink")],1)]),t._v(" "),e("p",[e("a",{attrs:{href:"https://juejin.cn/post/6911873800669757447",target:"_blank",rel:"noopener noreferrer"}},[t._v("闲庭信步聊前端 - 见微知著微前端"),e("OutboundLink")],1)]),t._v(" "),e("p",[e("a",{attrs:{href:"https://github.com/xitu/gold-miner/blob/master/TODO1/micro-frontends-1.md",target:"_blank",rel:"noopener noreferrer"}},[t._v("微前端：未来前端开发的新趋势"),e("OutboundLink")],1)]),t._v(" "),e("p",[t._v("微前端架构具备以下几个核心价值：")]),t._v(" "),e("ul",[e("li",[e("p",[t._v("技术栈无关。主框架不限制接入应用的技术栈，微应用具备完全自主权")])]),t._v(" "),e("li",[e("p",[t._v("独立开发、独立部署。微应用仓库独立，前后端可独立开发，部署完成后主框架自动完成同步更新")])]),t._v(" "),e("li",[e("p",[t._v("增量升级。在面对各种复杂场景时，我们通常很难对一个已经存在的系统做全量的技术栈升级或重构，而微前端是一种非常好的实施渐进式重构的手段和策略")])]),t._v(" "),e("li",[e("p",[t._v("独立运行时。每个微应用之间状态隔离，运行时状态不共享")])])]),t._v(" "),e("p",[t._v("qiankun 特点")]),t._v(" "),e("ul",[e("li",[t._v("基于 single-spa 封装，提供了更加开箱即用的 API。")]),t._v(" "),e("li",[t._v("技术栈无关，任意技术栈的应用均可 使用/接入，不论是 React/Vue/Angular/JQuery 还是其他等框架。")]),t._v(" "),e("li",[t._v("HTML Entry 接入方式，让你接入微应用像使用 iframe 一样简单。")]),t._v(" "),e("li",[t._v("样式隔离，确保微应用之间样式互相不干扰。")]),t._v(" "),e("li",[t._v("JS 沙箱，确保微应用之间 全局变量/事件 不冲突。")]),t._v(" "),e("li",[t._v("资源预加载，在浏览器空闲时间预加载未打开的微应用资源，加速微应用打开速度。")]),t._v(" "),e("li",[t._v("umi 插件，提供了 @umijs/plugin-qiankun 供 umi 应用一键切换成微前端架构系统。")])]),t._v(" "),e("p",[t._v("qiankun@2.0 新功能")]),t._v(" "),e("ul",[e("li",[t._v("支持多应用并行及多实例沙箱")]),t._v(" "),e("li",[t._v("支持手动 加载/卸载 微应用")]),t._v(" "),e("li",[t._v("支持 IE11 沙箱兼容")]),t._v(" "),e("li",[t._v("官方的极简微应用通信方案")]),t._v(" "),e("li",[t._v("支持基于 Shadow DOM 的样式隔离")])]),t._v(" "),e("h2",{attrs:{id:"踩坑"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#踩坑"}},[t._v("#")]),t._v(" 踩坑")]),t._v(" "),e("h3",{attrs:{id:"样式与事件监听污染"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#样式与事件监听污染"}},[t._v("#")]),t._v(" 样式与事件监听污染")]),t._v(" "),e("p",[t._v("样式隔离也是微前端面临的一个重要问题，在 qiankun@1.x  中，支持了微应用之间的样式隔离（仅沙箱开启时生效），但尚存一些问题：")]),t._v(" "),e("ul",[e("li",[t._v("主子应用之间的样式隔离依赖手动配置插件处理")]),t._v(" "),e("li",[t._v("多应用场景下微应用之间的样式隔离亟待处理")])]),t._v(" "),e("p",[t._v("为此，引入了一个新的选项，"),e("code",[t._v("sandbox: { strictStyleIsolation?: boolean }")]),t._v(" 。在该选项开启的情况下，会以 "),e("code",[t._v("Shadow DOM")]),t._v(" 的形式嵌入微应用，以此来做到应用样式的真正隔离。")]),t._v(" "),e("p",[t._v("在开启 strictStyleIsolation 时，我们会将微应用插入到 qiankun 创建好的 Shadow Tree 中，微应用的样式（包括动态插入的样式）都会被挂载到这个 Shadow Host 节点下，因此微应用的样式只会作用在 Shadow Tree 内部，这样就做到了样式隔离。")]),t._v(" "),e("p",[t._v("但是开启 Shadow DOM 也会引发一些别的问题：")]),t._v(" "),e("p",[t._v("一个典型的问题是，一些组件可能会越过 Shadow Boundary 到外部 Document Tree 插入节点，而这部分节点的样式就会丢失；比如 antd 的 Modal 就会渲染节点至 ducument.body ，引发样式丢失；针对刚才的 antd 场景你可以通过他们提供的 ConfigProvider.getPopupContainer API 来指定在 Shadow Tree 内部的节点为挂载节点，但另外一些其他的组件库，或者你的一些代码也会遇到同样的问题，需要你额外留心。")]),t._v(" "),e("p",[t._v("此外 Shadow DOM 场景下还会有一些额外的事件处理、边界处理等问题。")]),t._v(" "),e("p",[t._v("在 qiankun@2.2.2版本之前，qiankun 只能解决子应用之间的样式相互污染，不能解决子应用与主应用的样式相互污染。子应用切换到主应用时，会出现样式丢失问题和事件监听不生效问题。在具有路由懒加载的 Vue 子应用之间互相切换，懒加载组件的样式不会重建。路由懒加载的子应用(异步加载的组件)，多次切换时也同样会出现样式丢失问题。")]),t._v(" "),e("p",[t._v("原因：子应用跳转时，子应用的卸载需要一点点时间，在这段时间内主项目加载了，插入了 css，但是被子项目的 css 沙箱记录了，连同子项目一同卸载移除了。换句话说，主应用样式丢失的问题跟子应用卸载的时机有关系：当切换子应用时，当前子应用沙箱环境还未被卸载，但主应用 css 已被插入，当卸载时会连带主应用 css 一起被清除。在 "),e("code",[t._v("<head></head>")]),t._v(" 能看到。主项目事件监听也是一样的，所以需要在子项目卸载完成后再跳转。")]),t._v(" "),e("p",[t._v("css 样式隔离常用的方式：")]),t._v(" "),e("ul",[e("li",[t._v("css 前缀")]),t._v(" "),e("li",[t._v("css Module")]),t._v(" "),e("li",[t._v("动态加载/卸载样式表")])]),t._v(" "),e("p",[t._v("qiankun 中的 css 沙箱机制采用 "),e("strong",[t._v("动态加载/卸载样式表")]),t._v("。重写 HTMLHeadElement.prototype.appendChild 和 window.addEventListener 事件，当子应用加载时，在 head 插入 "),e("code",[t._v("style/link")]),t._v(" ; 当卸载时，直接移除。")]),t._v(" "),e("p",[t._v("但是，无法解决多个子项目同时运行时的 css 污染，以及子项目对主项目的 css 污染。")]),t._v(" "),e("p",[t._v("js 沙箱只劫持了 window.addEventListener，使用 document.body.addEventListener 或者 document.body.onClick 添加的事件并不会被沙箱移除，会对其他的页面产生影响，请在 unmount 周期清除。")]),t._v(" "),e("p",[t._v("解决办法：我原本想在路由钩子函数里面判断下，子项目是否卸载完成，卸载完成再跳转路由，然而路由不跳转，子项目根本不会卸载。临时解决办法是先复制一下 HTMLHeadElement.prototype.appendChild 和 window.addEventListener ，路由钩子函数 beforeEach 中判断一下，如果当前路由是子项目，并且去的路由是父项目的，则还原这两个对象。")]),t._v(" "),e("div",{staticClass:"language-js line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-js"}},[e("code",[e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token function-variable function"}},[t._v("isChildRoute")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("path")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" childRoute"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("some")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("item")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" path"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("startsWith")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("item"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" rawAppendChild "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("HTMLHeadElement")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("prototype"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("appendChild"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" rawAddEventListener "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" window"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("addEventListener"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\nrouter"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("beforeEach")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("to"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" next")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 从子项目跳转到主项目")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("isChildRoute")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("path"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&&")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("isChildRoute")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("to"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("path"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("HTMLHeadElement")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("prototype"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("appendChild "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" rawAppendChild"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    window"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("addEventListener "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" rawAddEventListener"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("next")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),t._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[t._v("1")]),e("br"),e("span",{staticClass:"line-number"},[t._v("2")]),e("br"),e("span",{staticClass:"line-number"},[t._v("3")]),e("br"),e("span",{staticClass:"line-number"},[t._v("4")]),e("br"),e("span",{staticClass:"line-number"},[t._v("5")]),e("br"),e("span",{staticClass:"line-number"},[t._v("6")]),e("br"),e("span",{staticClass:"line-number"},[t._v("7")]),e("br"),e("span",{staticClass:"line-number"},[t._v("8")]),e("br"),e("span",{staticClass:"line-number"},[t._v("9")]),e("br"),e("span",{staticClass:"line-number"},[t._v("10")]),e("br"),e("span",{staticClass:"line-number"},[t._v("11")]),e("br"),e("span",{staticClass:"line-number"},[t._v("12")]),e("br")])]),e("p",[t._v("针对项目搭建上的一些思考与优化，可借鉴"),e("a",{attrs:{href:"https://mp.weixin.qq.com/s/-A3Yg2TX4fCkkx9vXgREFA",target:"_blank",rel:"noopener noreferrer"}},[t._v("使用mono-repo实现跨项目组件共享"),e("OutboundLink")],1)]),t._v(" "),e("div",{staticClass:"custom-block warning"},[e("p",{staticClass:"custom-block-title"},[t._v("参考文献")]),t._v(" "),e("p",[e("a",{attrs:{href:"https://micro-frontends.org/",target:"_blank",rel:"noopener noreferrer"}},[t._v("Micro Frontends"),e("OutboundLink")],1)]),t._v(" "),e("p",[e("a",{attrs:{href:"https://www.yuque.com/kuitos/gky7yw",target:"_blank",rel:"noopener noreferrer"}},[t._v("qiankun 技术圆桌"),e("OutboundLink")],1)]),t._v(" "),e("p",[e("a",{attrs:{href:"https://juejin.cn/post/6844903954074058760",target:"_blank",rel:"noopener noreferrer"}},[t._v("说说JS中的沙箱"),e("OutboundLink")],1)]),t._v(" "),e("p",[e("a",{attrs:{href:"https://juejin.cn/post/6896643767353212935",target:"_blank",rel:"noopener noreferrer"}},[t._v("解密微前端：从qiankun看沙箱隔离"),e("OutboundLink")],1)]),t._v(" "),e("p",[e("a",{attrs:{href:"https://juejin.cn/post/6891888458919641096",target:"_blank",rel:"noopener noreferrer"}},[t._v("解密微前端：从qiankun看子应用加载"),e("OutboundLink")],1)]),t._v(" "),e("p",[e("a",{attrs:{href:"https://juejin.cn/post/6885214342552223757",target:"_blank",rel:"noopener noreferrer"}},[t._v("qiankun 2.x 运行时沙箱 源码分析"),e("OutboundLink")],1)]),t._v(" "),e("p",[e("a",{attrs:{href:"https://juejin.cn/post/6885211340999229454#heading-32",target:"_blank",rel:"noopener noreferrer"}},[t._v("微前端框架 之 qiankun 从入门到源码分析"),e("OutboundLink")],1)]),t._v(" "),e("p",[e("a",{attrs:{href:"https://juejin.cn/post/6902212398841593869",target:"_blank",rel:"noopener noreferrer"}},[t._v("qiankun 微前端原理与实践"),e("OutboundLink")],1)]),t._v(" "),e("p",[e("a",{attrs:{href:"https://juejin.cn/post/6844904115999342600",target:"_blank",rel:"noopener noreferrer"}},[t._v("基于 qiankun 的微前端最佳实践"),e("OutboundLink")],1)]),t._v(" "),e("p",[e("a",{attrs:{href:"https://juejin.cn/post/6846687602439897101#heading-28",target:"_blank",rel:"noopener noreferrer"}},[t._v("微前端连载"),e("OutboundLink")],1)]),t._v(" "),e("p",[e("a",{attrs:{href:"https://github.com/iuap-design/blog/issues/382",target:"_blank",rel:"noopener noreferrer"}},[t._v("微前端架构推进参考资料汇总"),e("OutboundLink")],1)]),t._v(" "),e("p",[e("a",{attrs:{href:"https://juejin.cn/post/6844904185910018062#heading-0",target:"_blank",rel:"noopener noreferrer"}},[t._v("qiankun 微前端方案实践及总结"),e("OutboundLink")],1)]),t._v(" "),e("p",[e("a",{attrs:{href:"https://mp.weixin.qq.com/s/-A3Yg2TX4fCkkx9vXgREFA",target:"_blank",rel:"noopener noreferrer"}},[t._v("使用mono-repo实现跨项目组件共享"),e("OutboundLink")],1)]),t._v(" "),e("p",[e("a",{attrs:{href:"https://juejin.cn/post/6924854598268108807#heading-2",target:"_blank",rel:"noopener noreferrer"}},[t._v("项目级 monorepo 策略最佳实践"),e("OutboundLink")],1)]),t._v(" "),e("p",[e("a",{attrs:{href:"https://qiankun.umijs.org/zh/faq",target:"_blank",rel:"noopener noreferrer"}},[t._v("qiankun 官网常见问题"),e("OutboundLink")],1)]),t._v(" "),e("p",[e("a",{attrs:{href:"https://juejin.cn/post/6844904073972432903#heading-5",target:"_blank",rel:"noopener noreferrer"}},[t._v("微前端在美团外卖的实践"),e("OutboundLink")],1)])])])}),[],!1,null,null,null);n.default=s.exports}}]);