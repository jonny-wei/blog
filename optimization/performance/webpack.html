<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>构建层面优化 | 花帽子的博客</title>
    <meta name="generator" content="VuePress 1.7.1">
    <link rel="icon" href="/blog/logo.png">
    <link rel="manifest" href="/blog/manifest.json">
    <link rel="apple-touch-icon" href="/blog/images/icons/apple-icon-152x152.png">
    <meta name="description" content="我命由我不由天，学习吧少年">
    <meta name="theme-color" content="#3eaf7c">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="msapplication-TileImage" content="/icons/ms-icon-144x144.png">
    <meta name="msapplication-TileColor" content="#000000">
    
    <link rel="preload" href="/blog/assets/css/0.styles.e2df15d6.css" as="style"><link rel="preload" href="/blog/assets/js/app.45ab665b.js" as="script"><link rel="preload" href="/blog/assets/js/2.55125c9d.js" as="script"><link rel="preload" href="/blog/assets/js/75.01358c7a.js" as="script"><link rel="preload" href="/blog/assets/js/4.f8e09ced.js" as="script"><link rel="prefetch" href="/blog/assets/js/10.4ccbee1e.js"><link rel="prefetch" href="/blog/assets/js/100.141bdc06.js"><link rel="prefetch" href="/blog/assets/js/101.226faea4.js"><link rel="prefetch" href="/blog/assets/js/102.a75e2a88.js"><link rel="prefetch" href="/blog/assets/js/103.92be59a8.js"><link rel="prefetch" href="/blog/assets/js/104.1e2fdfae.js"><link rel="prefetch" href="/blog/assets/js/105.83af5a66.js"><link rel="prefetch" href="/blog/assets/js/106.62a99d44.js"><link rel="prefetch" href="/blog/assets/js/107.88a2e6b8.js"><link rel="prefetch" href="/blog/assets/js/108.574dca90.js"><link rel="prefetch" href="/blog/assets/js/109.eb69e52e.js"><link rel="prefetch" href="/blog/assets/js/11.31b622e3.js"><link rel="prefetch" href="/blog/assets/js/110.8eca337a.js"><link rel="prefetch" href="/blog/assets/js/111.d63e13ec.js"><link rel="prefetch" href="/blog/assets/js/112.618f2267.js"><link rel="prefetch" href="/blog/assets/js/113.c70447f9.js"><link rel="prefetch" href="/blog/assets/js/114.46aa365e.js"><link rel="prefetch" href="/blog/assets/js/115.c1003d59.js"><link rel="prefetch" href="/blog/assets/js/116.1fbc521e.js"><link rel="prefetch" href="/blog/assets/js/117.828b48da.js"><link rel="prefetch" href="/blog/assets/js/118.50b44d6b.js"><link rel="prefetch" href="/blog/assets/js/119.311dacd2.js"><link rel="prefetch" href="/blog/assets/js/12.7238bd94.js"><link rel="prefetch" href="/blog/assets/js/120.2545ff1d.js"><link rel="prefetch" href="/blog/assets/js/121.bd605cc8.js"><link rel="prefetch" href="/blog/assets/js/122.c9bd6b1b.js"><link rel="prefetch" href="/blog/assets/js/123.b9f60565.js"><link rel="prefetch" href="/blog/assets/js/124.2c7eca86.js"><link rel="prefetch" href="/blog/assets/js/125.86d31675.js"><link rel="prefetch" href="/blog/assets/js/126.fa74b6cb.js"><link rel="prefetch" href="/blog/assets/js/127.be5d864f.js"><link rel="prefetch" href="/blog/assets/js/13.976b0bb1.js"><link rel="prefetch" href="/blog/assets/js/14.9db91edf.js"><link rel="prefetch" href="/blog/assets/js/15.15366754.js"><link rel="prefetch" href="/blog/assets/js/16.24f0a13a.js"><link rel="prefetch" href="/blog/assets/js/17.218fdaaf.js"><link rel="prefetch" href="/blog/assets/js/18.b1a8b56d.js"><link rel="prefetch" href="/blog/assets/js/19.c61341a8.js"><link rel="prefetch" href="/blog/assets/js/20.8dfe8d38.js"><link rel="prefetch" href="/blog/assets/js/21.ce174f70.js"><link rel="prefetch" href="/blog/assets/js/22.be2d4c4b.js"><link rel="prefetch" href="/blog/assets/js/23.2fe1d854.js"><link rel="prefetch" href="/blog/assets/js/24.ff123178.js"><link rel="prefetch" href="/blog/assets/js/25.1aaf3cbb.js"><link rel="prefetch" href="/blog/assets/js/26.cc2f502b.js"><link rel="prefetch" href="/blog/assets/js/27.00760ff3.js"><link rel="prefetch" href="/blog/assets/js/28.505f1535.js"><link rel="prefetch" href="/blog/assets/js/29.8a02c4d1.js"><link rel="prefetch" href="/blog/assets/js/3.6b7316b6.js"><link rel="prefetch" href="/blog/assets/js/30.9acfcc21.js"><link rel="prefetch" href="/blog/assets/js/31.77d03be7.js"><link rel="prefetch" href="/blog/assets/js/32.6ff6a540.js"><link rel="prefetch" href="/blog/assets/js/33.cb84ae18.js"><link rel="prefetch" href="/blog/assets/js/34.adadd33d.js"><link rel="prefetch" href="/blog/assets/js/35.f3798aea.js"><link rel="prefetch" href="/blog/assets/js/36.1edbeea1.js"><link rel="prefetch" href="/blog/assets/js/37.b7b36fb2.js"><link rel="prefetch" href="/blog/assets/js/38.04cfd630.js"><link rel="prefetch" href="/blog/assets/js/39.0bf1a886.js"><link rel="prefetch" href="/blog/assets/js/40.135d54b0.js"><link rel="prefetch" href="/blog/assets/js/41.ce19c14b.js"><link rel="prefetch" href="/blog/assets/js/42.19fbad1c.js"><link rel="prefetch" href="/blog/assets/js/43.cfe7c426.js"><link rel="prefetch" href="/blog/assets/js/44.1666ee06.js"><link rel="prefetch" href="/blog/assets/js/45.03625a96.js"><link rel="prefetch" href="/blog/assets/js/46.0600c24c.js"><link rel="prefetch" href="/blog/assets/js/47.d3526d63.js"><link rel="prefetch" href="/blog/assets/js/48.148d2a9a.js"><link rel="prefetch" href="/blog/assets/js/49.015e8dca.js"><link rel="prefetch" href="/blog/assets/js/5.1e7d2af8.js"><link rel="prefetch" href="/blog/assets/js/50.412ec8e7.js"><link rel="prefetch" href="/blog/assets/js/51.532b77a9.js"><link rel="prefetch" href="/blog/assets/js/52.6d6edb7e.js"><link rel="prefetch" href="/blog/assets/js/53.34d118ec.js"><link rel="prefetch" href="/blog/assets/js/54.63cf7c9b.js"><link rel="prefetch" href="/blog/assets/js/55.939b53f3.js"><link rel="prefetch" href="/blog/assets/js/56.1218d53f.js"><link rel="prefetch" href="/blog/assets/js/57.25a5cbf9.js"><link rel="prefetch" href="/blog/assets/js/58.3def3bd5.js"><link rel="prefetch" href="/blog/assets/js/59.a6c3afec.js"><link rel="prefetch" href="/blog/assets/js/6.a1331773.js"><link rel="prefetch" href="/blog/assets/js/60.cf3403d2.js"><link rel="prefetch" href="/blog/assets/js/61.0085c2ea.js"><link rel="prefetch" href="/blog/assets/js/62.7fecd1a4.js"><link rel="prefetch" href="/blog/assets/js/63.02d7d0cd.js"><link rel="prefetch" href="/blog/assets/js/64.2c8d2390.js"><link rel="prefetch" href="/blog/assets/js/65.5e5206bd.js"><link rel="prefetch" href="/blog/assets/js/66.ed58472c.js"><link rel="prefetch" href="/blog/assets/js/67.6af20064.js"><link rel="prefetch" href="/blog/assets/js/68.02af0aa0.js"><link rel="prefetch" href="/blog/assets/js/69.0ccb7321.js"><link rel="prefetch" href="/blog/assets/js/7.c9d98944.js"><link rel="prefetch" href="/blog/assets/js/70.36841e44.js"><link rel="prefetch" href="/blog/assets/js/71.1ea41da4.js"><link rel="prefetch" href="/blog/assets/js/72.c07e6f84.js"><link rel="prefetch" href="/blog/assets/js/73.c3c45515.js"><link rel="prefetch" href="/blog/assets/js/74.db8ec4e7.js"><link rel="prefetch" href="/blog/assets/js/76.6692d1a9.js"><link rel="prefetch" href="/blog/assets/js/77.94a8b378.js"><link rel="prefetch" href="/blog/assets/js/78.cbd591b9.js"><link rel="prefetch" href="/blog/assets/js/79.79ef9e7c.js"><link rel="prefetch" href="/blog/assets/js/8.441834aa.js"><link rel="prefetch" href="/blog/assets/js/80.28f29240.js"><link rel="prefetch" href="/blog/assets/js/81.2ef1850f.js"><link rel="prefetch" href="/blog/assets/js/82.b337f5ba.js"><link rel="prefetch" href="/blog/assets/js/83.222f7a03.js"><link rel="prefetch" href="/blog/assets/js/84.470ce170.js"><link rel="prefetch" href="/blog/assets/js/85.b99be668.js"><link rel="prefetch" href="/blog/assets/js/86.68131039.js"><link rel="prefetch" href="/blog/assets/js/87.727abda2.js"><link rel="prefetch" href="/blog/assets/js/88.97bbd7ae.js"><link rel="prefetch" href="/blog/assets/js/89.6aa987ec.js"><link rel="prefetch" href="/blog/assets/js/9.a921bf18.js"><link rel="prefetch" href="/blog/assets/js/90.33aa2c10.js"><link rel="prefetch" href="/blog/assets/js/91.2d54f386.js"><link rel="prefetch" href="/blog/assets/js/92.fcdf6fc6.js"><link rel="prefetch" href="/blog/assets/js/93.395605e7.js"><link rel="prefetch" href="/blog/assets/js/94.50d3c822.js"><link rel="prefetch" href="/blog/assets/js/95.05004a59.js"><link rel="prefetch" href="/blog/assets/js/96.c5828618.js"><link rel="prefetch" href="/blog/assets/js/97.1a09e443.js"><link rel="prefetch" href="/blog/assets/js/98.54f05799.js"><link rel="prefetch" href="/blog/assets/js/99.1326efc7.js">
    <link rel="stylesheet" href="/blog/assets/css/0.styles.e2df15d6.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/blog/" class="home-link router-link-active"><img src="/blog/logo.png" alt="花帽子的博客" class="logo"> <span class="site-name can-hide">花帽子的博客</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/blog/" class="nav-link">
  主页
</a></div><div class="nav-item"><a href="/blog/vue/" class="nav-link">
  Vue
</a></div><div class="nav-item"><a href="/blog/css/" class="nav-link">
  CSS
</a></div><div class="nav-item"><a href="/blog/javascript/" class="nav-link">
  JS
</a></div><div class="nav-item"><a href="/blog/typescript/" class="nav-link">
  TS
</a></div><div class="nav-item"><a href="/blog/node/" class="nav-link">
  Node
</a></div><div class="nav-item"><a href="/blog/optimization/" class="nav-link router-link-active">
  优化
</a></div><div class="nav-item"><a href="/blog/mobile/" class="nav-link">
  移动端
</a></div><div class="nav-item"><a href="/blog/talk/" class="nav-link">
  其他
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="GitHub" class="dropdown-title"><span class="title">GitHub</span> <span class="arrow down"></span></button> <button type="button" aria-label="GitHub" class="mobile-dropdown-title"><span class="title">GitHub</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/jonny-wei" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub地址
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/blog/" class="nav-link">
  主页
</a></div><div class="nav-item"><a href="/blog/vue/" class="nav-link">
  Vue
</a></div><div class="nav-item"><a href="/blog/css/" class="nav-link">
  CSS
</a></div><div class="nav-item"><a href="/blog/javascript/" class="nav-link">
  JS
</a></div><div class="nav-item"><a href="/blog/typescript/" class="nav-link">
  TS
</a></div><div class="nav-item"><a href="/blog/node/" class="nav-link">
  Node
</a></div><div class="nav-item"><a href="/blog/optimization/" class="nav-link router-link-active">
  优化
</a></div><div class="nav-item"><a href="/blog/mobile/" class="nav-link">
  移动端
</a></div><div class="nav-item"><a href="/blog/talk/" class="nav-link">
  其他
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="GitHub" class="dropdown-title"><span class="title">GitHub</span> <span class="arrow down"></span></button> <button type="button" aria-label="GitHub" class="mobile-dropdown-title"><span class="title">GitHub</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/jonny-wei" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub地址
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Webpack</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/optimization/" aria-current="page" class="sidebar-link">前端优化之路</a></li><li><a href="/blog/optimization/webpack/abstract.html" class="sidebar-link">webpack</a></li><li><a href="/blog/optimization/webpack/configuration.html" class="sidebar-link">常用配置</a></li><li><a href="/blog/optimization/webpack/application.html" class="sidebar-link">项目应用</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>性能优化</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/optimization/performance/network.html" class="sidebar-link">网络层面优化</a></li><li><a href="/blog/optimization/performance/webpack.html" aria-current="page" class="active sidebar-link">构建层面优化</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/optimization/performance/webpack.html#分离样式" class="sidebar-link">分离样式</a></li><li class="sidebar-sub-header"><a href="/blog/optimization/performance/webpack.html#静态资源内联" class="sidebar-link">静态资源内联</a></li><li class="sidebar-sub-header"><a href="/blog/optimization/performance/webpack.html#图片内联与压缩" class="sidebar-link">图片内联与压缩</a></li><li class="sidebar-sub-header"><a href="/blog/optimization/performance/webpack.html#压缩混淆净化-html-js-css" class="sidebar-link">压缩混淆净化 HTML/JS/CSS</a></li><li class="sidebar-sub-header"><a href="/blog/optimization/performance/webpack.html#代码分割" class="sidebar-link">代码分割</a></li><li class="sidebar-sub-header"><a href="/blog/optimization/performance/webpack.html#代码拆分" class="sidebar-link">代码拆分</a></li><li class="sidebar-sub-header"><a href="/blog/optimization/performance/webpack.html#动态-polyfill" class="sidebar-link">动态 polyfill</a></li><li class="sidebar-sub-header"><a href="/blog/optimization/performance/webpack.html#激进合并" class="sidebar-link">激进合并</a></li><li class="sidebar-sub-header"><a href="/blog/optimization/performance/webpack.html#pwa-优化策略" class="sidebar-link">PWA 优化策略</a></li><li class="sidebar-sub-header"><a href="/blog/optimization/performance/webpack.html#缩小文件搜索范围" class="sidebar-link">缩小文件搜索范围</a></li><li class="sidebar-sub-header"><a href="/blog/optimization/performance/webpack.html#构建缓存策略" class="sidebar-link">构建缓存策略</a></li><li class="sidebar-sub-header"><a href="/blog/optimization/performance/webpack.html#多进程-多线程构建与压缩" class="sidebar-link">多进程/多线程构建与压缩</a></li><li class="sidebar-sub-header"><a href="/blog/optimization/performance/webpack.html#减少基础模块编译次数" class="sidebar-link">减少基础模块编译次数</a></li><li class="sidebar-sub-header"><a href="/blog/optimization/performance/webpack.html#优化-sourcemap" class="sidebar-link">优化 SourceMap</a></li><li class="sidebar-sub-header"><a href="/blog/optimization/performance/webpack.html#使用-prepack-提前求值" class="sidebar-link">使用 Prepack 提前求值</a></li><li class="sidebar-sub-header"><a href="/blog/optimization/performance/webpack.html#使用-scope-hoisting" class="sidebar-link">使用 Scope Hoisting</a></li><li class="sidebar-sub-header"><a href="/blog/optimization/performance/webpack.html#语言包优化" class="sidebar-link">语言包优化</a></li><li class="sidebar-sub-header"><a href="/blog/optimization/performance/webpack.html#多页面打包优化" class="sidebar-link">多页面打包优化</a></li></ul></li><li><a href="/blog/optimization/performance/render.html" class="sidebar-link">渲染层面优化</a></li><li><a href="/blog/optimization/performance/code.html" class="sidebar-link">代码层面优化</a></li><li><a href="/blog/optimization/performance/analysis.html" class="sidebar-link">性能分析</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>错误定位</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/optimization/error/capture.html" class="sidebar-link">前端异常捕获与处理</a></li><li><a href="/blog/optimization/error/monitor.html" class="sidebar-link">前端异常监控系统</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>文件处理</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/optimization/files/reference.html" class="sidebar-link">知识清单</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>图片处理</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/optimization/images/reference.html" class="sidebar-link">知识清单</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>换肤</span> <!----></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="构建层面优化"><a href="#构建层面优化" class="header-anchor">#</a> 构建层面优化</h1> <h2 id="分离样式"><a href="#分离样式" class="header-anchor">#</a> 分离样式</h2> <p>通过 css-loader，style-loader，postcss-loader，less-loader/sass-loader(node-sass/fast-sass-loader)等一系列 loader 打包好了 css，但是它们都内联到了 js 中，这样会存在以下几个问题：</p> <ul><li>使得 css 无法缓存</li> <li>增加了 js 文件体积</li> <li>未样式化元素闪动（FOUC）问题</li></ul> <p>发生 FOUC 是因为浏览器需要一段时间才能加载 JavaScript，并且到那时才会应用样式。将 CSS 分离到自己的文件可以让浏览器单独管理它，并将 css 的加载放在 js 加载前(即通常将 js 的引入放在 <code>&lt;body&gt;</code> 尾部)，从而避免了这个问题。</p> <p><strong>mini-css-extract-plugin</strong> 分离样式，生成单独的 css 样式文件。它可以将多个 CSS 文件聚合为一个。出于这个原因，它配备了一个 loader(MiniCssExtractPlugin.loader) 来专门处理这个过程。然后，插件会获取 loader 抽取的结果并发出单独的文件。由于这个过程会产生比较大的开销，所以，MiniCssExtractPlugin 只会作用于编译阶段，它不适用于热模块更换（HMR）。鉴于这个插件只是在生产环境中使用，所以也不是什么大的问题。</p> <div class="custom-block tip"><p class="custom-block-title">注意</p> <ul><li><p>style-loader 用于将 css 通过 <code>&lt;style&gt;</code> 标签插入到 <code>&lt;head&gt;</code> 中，违背了 <strong>mini-css-extract-plugin</strong> 分离样式，所以 style-loader 不能与 MiniCssExtractPlugin 同时使用。需要使用 MiniCssExtractPlugin.loader 替代 style-loader 。</p></li> <li><p>css-loader 用于加载 <code>.css</code> 文件，并且转换成 commonjs 对象。</p></li></ul></div> <div class="custom-block tip"><p class="custom-block-title">文件指纹策略补充</p> <ul><li>js 文件使用 <code>[name]_[chunkhash:8].js</code></li> <li>css 文件使用 <code>[name]_[contenthash:8].css</code></li> <li>图片 文件使用 <code>[name]_[hash:8].[ext]</code></li></ul></div> <h2 id="静态资源内联"><a href="#静态资源内联" class="header-anchor">#</a> 静态资源内联</h2> <div class="language-html line-numbers-mode"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span>
    ${ require('raw-loader!./meta.html')}
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">&gt;</span></span>Document<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">$<span class="token punctuation">{</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'raw-loader!babel-loader!../../node_modules/lib-flexible/flexible.js'</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h2 id="图片内联与压缩"><a href="#图片内联与压缩" class="header-anchor">#</a> 图片内联与压缩</h2> <p>加载大量小的资源会使基于 HTTP/1 的应用变慢，因为每个请求都会产生开销。HTTP/2 在这方面有所改善，并且在某种程度上改变了这种情况。除了使用 HTTP/2 外，webpack 也有一些优化办法：</p> <ul><li>使用 <code>url-loader</code> 内联资源，将小图像转为 base64 形式的字符串，从而减少 HTTP 请求，但是它会增加打包结果的尺寸，生产环境可能不太适合。</li> <li>使用 <code>file-loader</code> 对其延迟加载同时为较大的文件生成单独的请求地址。file-loader 能够将导入的图片存放到特定的目录，并返回图片的路径地址。此技术适用于其他类型的资源，例如字体。</li> <li>svg 图片使用 <code>svg-sprite-loader</code>、<code>svg-url-loader</code> 等处理。前者将小的 SVG 文件合并为一个 sprite 文件，从而可以更有效地加载，因为您可以避免请求开销。后者将 SVG 加载为 UTF-8 编码的数据 URL。结果比 Base64 更小，解析更快。</li> <li>使用 <code>image-webpack-loader</code>、<code>svgo-loader</code>（专用于 SVG）或 <code>imagemin-webpack-plugin</code> 压缩图片，减少图片下载所需带宽量。</li> <li>使用图片占位符。<code>image-trace-loader</code> 加载图像并将结果编码为 image/svg+xml 格式的 URL 数据。它可以于 file-loader 和 url-loader 一起使用，以便在加载实际图像时显示占位符。</li> <li>利用 srcset。<code>resize-image-loader</code> 和 <code>responsevie-loader</code> 允许您为现代浏览器生成 srcset 属性所需要的图像集合。srcset 属性可以让浏览器决定加载哪些图像以及何时提高性能。</li> <li>加载 Sprite(雪碧图)。Spriting 技术允许您将多个较小的图像组合成单个图像。它已经被用于游戏中的动画，但对于 Web 开发也很有价值，因为它节省了很多请求开销。<code>webpack-spritesmith</code> 生成雪碧图。</li> <li>使用字体图标（iconfont）。不论是压缩后的图片，还是雪碧图，终归还是图片，只要是图片，就还是会占用大量网络传输资源。字体图标是往HTML里插入字符和CSS样式而已，和图片请求比起来资源占用完全不在一个数量级。icomoon这个网站也为我们提供了将 SVG 图片自动转化成 CSS 样式的功能。</li> <li>使用 WebP 格式的图片。谷歌公司开发的一种旨在加快图片加载速度的图片格式。图片压缩体积大约只有JPEG的2/3，并能节省大量的服务器带宽资源和数据空间。Facebook、Ebay等知名网站已经开始测试并使用WebP格式。</li></ul> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token punctuation">{</span>
    test<span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">.(png|jpg|gif|jpeg)$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span>
    use<span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
            loader<span class="token operator">:</span> <span class="token string">'file-loader'</span><span class="token punctuation">,</span>
            options<span class="token operator">:</span> <span class="token punctuation">{</span>
                name<span class="token operator">:</span> <span class="token string">'[name]_[hash:8].[ext]'</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
            loader<span class="token operator">:</span> <span class="token string">'image-webpack-loader'</span><span class="token punctuation">,</span>
            options<span class="token operator">:</span> <span class="token punctuation">{</span>
                mozjpeg<span class="token operator">:</span> <span class="token punctuation">{</span>
                    progressive<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
                    quality<span class="token operator">:</span> <span class="token number">65</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token comment">// optipng.enabled: false will disable optipng</span>
                optipng<span class="token operator">:</span> <span class="token punctuation">{</span>
                    enabled<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
                pngquant<span class="token operator">:</span> <span class="token punctuation">{</span>
                    quality<span class="token operator">:</span> <span class="token string">'65-90'</span><span class="token punctuation">,</span>
                    speed<span class="token operator">:</span> <span class="token number">4</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
                gifsicle<span class="token operator">:</span> <span class="token punctuation">{</span>
                    interlaced<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token comment">// the webp option will enable WEBP</span>
                webp<span class="token operator">:</span> <span class="token punctuation">{</span>
                    quality<span class="token operator">:</span> <span class="token number">75</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br></div></div><h2 id="压缩混淆净化-html-js-css"><a href="#压缩混淆净化-html-js-css" class="header-anchor">#</a> 压缩混淆净化 HTML/JS/CSS</h2> <h3 id="压缩-html"><a href="#压缩-html" class="header-anchor">#</a> 压缩 HTML</h3> <p>使用 HtmlWebpackPlugin 插入引用，根据模版生成 HTML，压缩 HTML。</p> <ul><li>filename：表示输出的文件名</li> <li>template：模版文件</li> <li>removeComments：移除 HTML 中的注释</li> <li>collapseWhitespace：删除空白符与换行符</li> <li>inlineSource：插入到 HTML 的 CSS、JS 文件要内联，即不是以 link、script 形式引入</li> <li>inject：是否能注入内容到输出的页面</li> <li>chunks：指定插入某些模块</li> <li>hash：每次会在插入的文件后面加上 hash，用于处理缓存</li> <li>其他：favicon、meta、title 页面内使用 <code>&lt;%= htmlWebpackPlugin.options.title %&gt;</code> 即可</li></ul> <h3 id="压缩净化-css"><a href="#压缩净化-css" class="header-anchor">#</a> 压缩净化 CSS</h3> <ul><li>css-loader?minimize。css-loader 内置了 cssnano，只需要使用 css-loader?minimize 就可以开启 cssnano 压缩。</li> <li>PurifyCSSPlugin。需要配置 extract-text-webpack-plugin 使用，它主要的作用是可以去除没有用到的 CSS 代码，类似 JS 的 TreeShaking。PurifyCSSPlugin 已停止维护，使用 PurgecssPlugin 替代，配合 MiniCssExtractPlugin 使用。</li> <li>MiniCssExtractPlugin 用于提取 CSS。</li> <li>OptimizeCssAssetsWebpackPlugin 用于压缩 CSS。</li></ul> <h3 id="压缩净化-javascript"><a href="#压缩净化-javascript" class="header-anchor">#</a> 压缩净化 JavaScript</h3> <p>webpack4 只要在生产模式下，JS 代码就会自动压缩。</p> <ul><li>Webpack 内置 UglifyJS(UglifyjsWebpackPlugin) 插件</li> <li>ParallelUglifyPlugin</li> <li>TerserWebpackPlugin(webpack4 替代推荐)</li></ul> <p>在 Webpack 4 中，通过两个配置字段控制压缩过程：optimization.minimize 字段切换压缩处理器，而 optimization.minimizer 数组用来配置压缩处理器。</p> <p>会分析 JavaScript 代码语法树，理解代码的含义，从而做到去除无效代码、去掉日志输出代码、缩短变量名等优化。产环境必备:</p> <ul><li>压缩混淆代码</li> <li>降低浏览加载资源体积</li> <li>降低页面渲染时间</li> <li>防止反向编译工程的可能性</li></ul> <h3 id="使用-treeshaking"><a href="#使用-treeshaking" class="header-anchor">#</a> 使用 TreeShaking</h3> <p>webpack4 生产环境默认开启。</p> <p>TreeShaking 可以去除无用代码，它依赖于 ES6 的 import、export 的模块化语法，最先在 Rollup 中出现，Webpack2.0 开始引入使用。适合用于 lodash、utils.js 等工具类较分散的文件。</p> <h4 id="dce-elimination"><a href="#dce-elimination" class="header-anchor">#</a> DCE (Elimination)</h4> <ul><li>代码不会被执行到，不可达</li> <li>代码执行的结果不会被用到</li> <li>代码只会影响死变量(只写不读)</li></ul> <h4 id="treeshaking-原理"><a href="#treeshaking-原理" class="header-anchor">#</a> TreeShaking 原理</h4> <ul><li>利用 ES6 模块化语法
<ul><li>只能作为模块顶层的语句出现</li> <li>import 的模块只能时字符串常量(不能动态)</li> <li>import binding 时 immutable 的(不能修改)</li></ul></li> <li>压缩阶段删除无用的代码</li></ul> <p>它正常工作的前提是代码必须采用 ES6 的模块化语法，因为 ES6 模块化语法是静态的（在导入、导出语句中的路径必须是静态字符串，且不能放入其他代码块中）。</p> <p>在项目中使用大量第三方库时，我们会发现 TreeShaking 似乎不生效了，原因是大部分 NPM 中的代码都采用了 CommonJS 语法，这导致 TreeShaking 无法正常工作而降级处理。但幸运的是，有些库考虑到了这一点，这些库在发布到 NPM 上时会同时提供两份代码，一份采用 CommonJS 模块化语法，一份采用 ES6 模块化语法。</p> <p>以下是压缩 HTML/CSS/JS，分离CSS，文件指纹策略，移动端 rem + lib-flexible 适配方案 简单示例：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token constant">PATHS</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    src<span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'src'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
    entry<span class="token operator">:</span> <span class="token punctuation">{</span>
        index<span class="token operator">:</span> <span class="token string">'./src/index.js'</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    output<span class="token operator">:</span> <span class="token punctuation">{</span>
        path<span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'dist'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        filename<span class="token operator">:</span> <span class="token string">'[name]_[chunkhash:8].js'</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    mode<span class="token operator">:</span> <span class="token string">'production'</span><span class="token punctuation">,</span>
    module<span class="token operator">:</span> <span class="token punctuation">{</span>
        rules<span class="token operator">:</span> <span class="token punctuation">[</span>
            <span class="token punctuation">{</span>
                test<span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">.js$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span>
                use<span class="token operator">:</span> <span class="token string">'babel-loader'</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token punctuation">{</span>
                test<span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">.css$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span>
                use<span class="token operator">:</span> <span class="token punctuation">[</span>
                    MiniCssExtractPlugin<span class="token punctuation">.</span>loader<span class="token punctuation">,</span>
                    <span class="token string">'css-loader'</span>
                <span class="token punctuation">]</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token punctuation">{</span>
                test<span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">.less$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span>
                use<span class="token operator">:</span> <span class="token punctuation">[</span>
                    MiniCssExtractPlugin<span class="token punctuation">.</span>loader<span class="token punctuation">,</span>
                    <span class="token string">'css-loader'</span><span class="token punctuation">,</span>
                    <span class="token string">'less-loader'</span><span class="token punctuation">,</span>
                    <span class="token punctuation">{</span>
                        loader<span class="token operator">:</span> <span class="token string">'postcss-loader'</span><span class="token punctuation">,</span>
                        options<span class="token operator">:</span> <span class="token punctuation">{</span>
                            <span class="token function-variable function">plugins</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">[</span>
                                <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'autoprefixer'</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
                                    browsers<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'last 2 version'</span><span class="token punctuation">,</span> <span class="token string">'&gt;1%'</span><span class="token punctuation">,</span> <span class="token string">'ios 7'</span><span class="token punctuation">]</span>
                                <span class="token punctuation">}</span><span class="token punctuation">)</span>
                            <span class="token punctuation">]</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span><span class="token punctuation">,</span>
                     <span class="token punctuation">{</span>
                        loader<span class="token operator">:</span> <span class="token string">'px2rem-loader'</span><span class="token punctuation">,</span>
                        options<span class="token operator">:</span> <span class="token punctuation">{</span>
                            remUnit<span class="token operator">:</span> <span class="token number">75</span><span class="token punctuation">,</span>
                            remPrecision<span class="token operator">:</span> <span class="token number">8</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">]</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token punctuation">{</span>
                test<span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">.(png|jpg|gif|jpeg)$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span>
                use<span class="token operator">:</span> <span class="token punctuation">[</span>
                    <span class="token punctuation">{</span>
                        loader<span class="token operator">:</span> <span class="token string">'file-loader'</span><span class="token punctuation">,</span>
                        options<span class="token operator">:</span> <span class="token punctuation">{</span>
                            name<span class="token operator">:</span> <span class="token string">'images/[name]_[hash:8].[ext]'</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">]</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token punctuation">{</span>
                test<span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">.(woff|woff2|eot|ttf|otf)$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span>
                use<span class="token operator">:</span> <span class="token punctuation">[</span>
                    <span class="token punctuation">{</span>
                        loader<span class="token operator">:</span> <span class="token string">'file-loader'</span><span class="token punctuation">,</span>
                        options<span class="token operator">:</span> <span class="token punctuation">{</span>
                            name<span class="token operator">:</span> <span class="token string">'[name]_[hash:8][ext]'</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">]</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">]</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    plugins<span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token keyword">new</span> <span class="token class-name">MiniCssExtractPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            filename<span class="token operator">:</span> <span class="token string">'[name]_[contenthash:8].css'</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token keyword">new</span> <span class="token class-name">PurgecssPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            paths<span class="token operator">:</span> glob<span class="token punctuation">.</span><span class="token function">sync</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">PATHS</span><span class="token punctuation">.</span>src<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/**/*</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>  <span class="token punctuation">{</span> nodir<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// 需要绝对路径</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token keyword">new</span> <span class="token class-name">OptimizeCSSAssetsPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            assetNameRegExp<span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\.css$</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span>
            <span class="token comment">/**
             * cssnano 是一个 PostCSS 插件，可以添加到你的构建流程中，
             * 用于确保最终生成的 用于生产环境的 CSS 样式表文件尽可能的小。
             * 
             * cssnano 基于 PostCSS 来处理 CSS 代码。因为很多 现代化的 CSS 工具都是基于 PostCSS 开发的，
             * 因此你可以把这些工具组合起来 并生成一棵单一的抽象语法树（AST）。
             * 这就意味着总的处理时间 减少了，因为 CSS 不再需要进行多次解析了
             */</span>
            cssProcessor<span class="token operator">:</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'cssnano'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            cssProcessorPluginOptions<span class="token operator">:</span> <span class="token punctuation">{</span>
              <span class="token comment">// 预设</span>
              preset<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'default'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
                  discardComments<span class="token operator">:</span> <span class="token punctuation">{</span>
                    removeAll<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
                  <span class="token punctuation">}</span><span class="token punctuation">,</span>
                  normalizeUnicode<span class="token operator">:</span> <span class="token boolean">false</span>
                <span class="token punctuation">}</span><span class="token punctuation">]</span>
              <span class="token punctuation">}</span><span class="token punctuation">,</span>
              canPrint<span class="token operator">:</span> <span class="token boolean">true</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token keyword">new</span> <span class="token class-name">HtmlWebpackPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            template<span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'src/index.html'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            filename<span class="token operator">:</span> <span class="token string">'index.html'</span><span class="token punctuation">,</span>
            chunks<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'index'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            inject<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
            minify<span class="token operator">:</span> <span class="token punctuation">{</span>
                html5<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
                collapseWhitespace<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
                preserveLineBreaks<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
                minifyCSS<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
                minifyJS<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
                removeComments<span class="token operator">:</span> <span class="token boolean">false</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token keyword">new</span> <span class="token class-name">CleanWebpackPlugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token keyword">new</span> <span class="token class-name">HardSourceWebpackPlugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br></div></div><h2 id="代码分割"><a href="#代码分割" class="header-anchor">#</a> 代码分割</h2> <p>代码分割以按需加载、分离基础库，提取公共代码。</p> <p>单页应用的一个问题在于使用一个页面承载复杂的功能，要加载的文件体积很大，不进行优化的话会导致首屏加载时间过长，影响用户体验。做按需加载可以解决这个问题。具体方法如下：</p> <p>将网站功能按照相关程度划分成几类。每一类合并成一个 Chunk，按需加载对应的 Chunk 例如，只把首屏相关的功能放入执行入口所在的 Chunk，这样首次加载少量的代码，其他代码要用到的时候再去加载。最好提前预估用户接下来的操作，提前加载对应代码，让用户感知不到网络加载</p> <p>目前，生产环境下的打包结果是单个 JavaScript 文件。如果更改了代码，则客户端也必须重新下载整个包，包括一些外部依赖包。最好的结果是只下载更改的部分。如果外部依赖包发生更改，则客户端应仅获取依赖包。对于应用本身的代码也是如此。在 Webpack4 我们可以使用 optimization.splitChunks.cacheGroups 来进行 <strong>分割打包</strong>。通过分割打包，您可以将外包依赖项单独打包，并从客户端级别缓存中受益。执行了该过程，应用程序的整个大小依然保持不变。尽管需要执行的请求越多，会产生轻微的开销，但缓存的好处弥补了这一成本。</p> <p>Webpack 提供了提取公共代码的分包插件，根据版本不同使用不同的插件：</p> <ul><li>Webpack 4+：SplitChunksPlugin</li> <li>Webpack 3：CommonsChunkPlugin</li></ul> <div class="custom-block tip"><p class="custom-block-title">注意</p> <p>要正确使打包结果无效，必须将哈希附加到生成的 bundle 中(使用文件指纹策略向输出文件名添加占位符)。</p></div> <p>提取策略：</p> <ul><li>根据网站所使用的技术栈，找出网站的所有页面都需要用到的基础库，以采用 React 技术栈的网站为例，所有页面都会依赖 react、react-dom 等库，将它们提取到一个单独的文件 base.js 中，该文件包含了所有网页的基础运行环境。（为了长期缓存 base.js 文件）</li> <li>在剔除了个页面中被 base.js 包含的部分代码后，再找出所有页面都依赖的公共部分代码，将它们提取出来并放到 common.js 中。</li> <li>再为每个页面都生成一个单独的文件，而只包含各个页面单独需要的部分代码。</li></ul> <p>生成算法：</p> <ul><li>Webpack 先将 entry 中对应的 module 都生成一个新的 Chunk</li> <li>遍历 module 的依赖列表，将依赖的 module 也加入到 Chunk 中</li> <li>如果一个依赖 module 是动态引入的模块，那么就会根据这个 module 创建一个新的 Chunk，继续遍历依赖</li> <li>重复上面的过程，直至得到所有的 Chunks</li></ul> <div class="custom-block tip"><p class="custom-block-title">Chunk 和 Bundle 的关系</p> <ul><li><strong>Chunk（块）</strong>：指若干个 JS Module 的集合</li> <li><strong>Bundle</strong>：形式上是块的集合，意义是代表一个可以运行的整体</li></ul></div> <ul><li><p>使用 html-webpack-externals-plugin 基础库分离，通过 CDN 引入，不打入 bundle 中。</p></li> <li><p>使用 SplitChunksPlugin 不仅可以分离基础包，还可以提取公共带代码(推荐)。</p></li> <li><p>使用 DLLPlugin 预编译资源模块分离基础包(内置插件，更好的分包)</p></li> <li><p>使用 hard-source-webpack-plugin 是 DLL 的更好替代者</p></li> <li><p>async 异步引入的库进行分离(默认)</p></li> <li><p>inital 同步引入的库进行分离</p></li> <li><p>all 所用引入的库进行分离(推荐)</p></li></ul> <div class="language-js line-numbers-mode"><pre class="language-js"><code>plugins<span class="token operator">:</span> <span class="token punctuation">[</span>
  <span class="token keyword">new</span> <span class="token class-name">HtmlWebpackPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      inlineSource<span class="token operator">:</span> <span class="token string">'.css$'</span><span class="token punctuation">,</span>
      template<span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">src/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>pageName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/index.html</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      filename<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>pageName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.html</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
      chunks<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'vendors'</span><span class="token punctuation">,</span> pageName<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// 'vendors' 分离的基础包 chunks</span>
      inject<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        minify<span class="token operator">:</span> <span class="token punctuation">{</span>
          html5<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
          collapseWhitespace<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
          preserveLineBreaks<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
          minifyCSS<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
          minifyJS<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
          removeComments<span class="token operator">:</span> <span class="token boolean">false</span>
      <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token keyword">new</span> <span class="token class-name">HtmlWebpackExternalsPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    externals<span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">{</span>
        module<span class="token operator">:</span> <span class="token string">'react'</span><span class="token punctuation">,</span>
        entry<span class="token operator">:</span> <span class="token string">'https://11.url.cn/now/lib/16.2.0/react.min.js'</span><span class="token punctuation">,</span>
        global<span class="token operator">:</span> <span class="token string">'React'</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">{</span>
        module<span class="token operator">:</span> <span class="token string">'react-dom'</span><span class="token punctuation">,</span>
        entry<span class="token operator">:</span> <span class="token string">'https://11.url.cn/now/lib/16.2.0/react-dom.min.js'</span><span class="token punctuation">,</span>
        global<span class="token operator">:</span> <span class="token string">'ReactDOM'</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  optimization<span class="token operator">:</span> <span class="token punctuation">{</span>
    splitChunks<span class="token operator">:</span> <span class="token punctuation">{</span>
      minSize<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
      cacheGroups<span class="token operator">:</span> <span class="token punctuation">{</span>
        vendors<span class="token operator">:</span> <span class="token punctuation">{</span>
          test<span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">(react|react-dom)</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span>
          name<span class="token operator">:</span> <span class="token string">'vendors'</span><span class="token punctuation">,</span> <span class="token comment">// 需要在 HtmlWebpackPlugin 的 chunks 中加入</span>
          chunks<span class="token operator">:</span> <span class="token string">'all'</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        commons<span class="token operator">:</span> <span class="token punctuation">{</span>
          name<span class="token operator">:</span> <span class="token string">'chunk-commons'</span><span class="token punctuation">,</span>
          minChunks<span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
          chunks<span class="token operator">:</span> <span class="token string">'all'</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br></div></div><p>引入基础包脚本：</p> <div class="language-html line-numbers-mode"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>root<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token comment">&lt;!--HTML_PLACEHOLDER--&gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>text/javascript<span class="token punctuation">&quot;</span></span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>https://11.url.cn/now/lib/16.2.0/react.min.js<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>text/javascript<span class="token punctuation">&quot;</span></span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>https://11.url.cn/now/lib/16.2.0/react-dom.min.js<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
    <span class="token comment">&lt;!--INITIAL_DATA_PLACEHOLDER--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><ul><li>使用 html-webpack-externals-plugin 基础库分离，通过 CDN 引入，不打入 bundle 中。</li> <li>使用 SplitChunksPlugin 不仅可以分离基础包，还可以提取公共带代码(推荐)。</li> <li>使用 DLLPlugin 预编译资源模块分离基础包(内置插件，更好的分包)</li> <li>使用 hard-source-webpack-plugin 是 DLL 的更好替代者</li></ul> <p>使用 HtmlWebpackExternalsPlugin 的方式分离基础包的缺点是一个基础库必须指定一个 CDN，当分离的基础包或业务包多时，会产生很多 <code>&lt;script&gt;</code> 插入 html 中；使用 SplitChunksPlugin 分离基础包的缺点是每次会对基础包进行分析。</p> <h2 id="代码拆分"><a href="#代码拆分" class="header-anchor">#</a> 代码拆分</h2> <p>对于大的 Web 应用来讲，将所有的代码都放在一个文件中显然是不够有效的，特别是当你的某些代码块是在某些特殊的时候才会被使用到。Webpack 有一个功能就是将你的代码库分割成 Chunks（语块），当代码运行到需要它们的时候再进行加载。</p> <p>适用的场景：</p> <ul><li>抽离相同代码到单个共享块</li> <li>脚本懒加载，使得初始加载的文件更小</li></ul> <p>Webpack 中以两种主要方式完成代码拆分：</p> <ul><li>CommonJS：require.ensure</li> <li>ES6：动态 import（目前还没有原生支持，需要 Babel 转换）</li></ul> <p>最终目标是得到一个按需加载的分割点。分割内部也可以再次分割，您可以根据分割构建整个应用程序。这样做的好处是，应用程序的初始有效负载会更小。</p> <p>Babel 本身不支持动态 import 语法，它需要 @babel/plugin-syntax-dynamic-import 配合才能工作。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// .babelrc</span>
<span class="token punctuation">{</span>
    <span class="token string">&quot;presets&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">[</span>
            <span class="token string">&quot;@babel/preset-env&quot;</span>
        <span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token string">&quot;@babel/preset-react&quot;</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token string">&quot;plugins&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token string">&quot;@babel/plugin-syntax-dynamic-import&quot;</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">}</span>

<span class="token comment">// 使用如点击按钮懒加载test，通过 webpackJsonp 方法发起一个 jsonp 请求懒加载脚本</span>

<span class="token function">loadComponent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">import</span><span class="token punctuation">(</span><span class="token string">'./test.js'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><h2 id="动态-polyfill"><a href="#动态-polyfill" class="header-anchor">#</a> 动态 polyfill</h2> <p>babel-ployfill 打包体积 88.49K，如果每个页面都要做兼容，都要 ployfill，体积就会变大。所以动态按需加载 polyfill。</p> <p>使用 Ployfill Service 。动态 Polyfill 是根据不同浏览器的特性，载入需要的特性补丁。Polyfill.io 通过尝试使用 polyfill 重新创建缺少的功能，可以轻松地支持不同的浏览器，并且可以大幅度地减少构建体积。Polyfill.io 通过分析请求头信息中的 UserAgent 实现自动加载浏览器所需的 polyfill。</p> <p>使用方法，直接引入代码即可使用默认配置的 Polyfill：</p> <div class="language-html line-numbers-mode"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">crossOrigin</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>anonymous<span class="token punctuation">&quot;</span></span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>https://polyfill.io/v3/polyfill.min.js<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>

阿里提供的动态 Polyfill 服务：

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>https://polyfill.alicdn.com/polyfill.min.js?features=Promise%2CArray.prototype.includes<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h2 id="激进合并"><a href="#激进合并" class="header-anchor">#</a> 激进合并</h2> <p>Webpack 通过两个插件提供对生成的块的更多控制：AggressiveSplittingPlugin 和 AggressiveMergingPlugin。</p> <ul><li>AggressiveSplittingPlugin： 产生更多的小块 bundles，但同时会增加客户端的请求数量（HTTP2 采取多路复用，可以很好适应）</li> <li>AggressiveMergingPlugin： 产生更少的 bundles</li></ul> <p>如果你分成多个小的块，对于客户端缓存来说是比较有利的；但是，在 HTTP/1 环境中还会有额外的请求开销。目前，由于 HtmlWebpackPlugin 中的 BUG，如果启用该插件，这个方法不会起作用。</p> <h2 id="pwa-优化策略"><a href="#pwa-优化策略" class="header-anchor">#</a> PWA 优化策略</h2> <p>在你第一次访问一个网站的时候，如果成功，做一个缓存，当服务器挂了之后，你依然能够访问这个网页 ，这就是 PWA。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code> cnpm i workbox<span class="token operator">-</span>webpack<span class="token operator">-</span>plugin <span class="token operator">-</span><span class="token constant">D</span>

<span class="token keyword">const</span> WorkboxPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'workbox-webpack-plugin'</span><span class="token punctuation">)</span> <span class="token comment">// 引入 PWA 插件</span>
<span class="token keyword">const</span> prodConfig <span class="token operator">=</span> <span class="token punctuation">{</span>
  plugins<span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token comment">// 配置 PWA</span>
    <span class="token keyword">new</span> <span class="token class-name">WorkboxPlugin<span class="token punctuation">.</span>GenerateSW</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      clientsClaim<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      skipWaiting<span class="token operator">:</span> <span class="token boolean">true</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>

在入口文件加上
<span class="token comment">// 判断该浏览器支不支持 serviceWorker</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">'serviceWorker'</span> <span class="token keyword">in</span> navigator<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'load'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    navigator<span class="token punctuation">.</span>serviceWorker
      <span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span><span class="token string">'/service-worker.js'</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">registration</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'service-worker registed'</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token parameter">error</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'service-worker registed error'</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br></div></div><h2 id="缩小文件搜索范围"><a href="#缩小文件搜索范围" class="header-anchor">#</a> 缩小文件搜索范围</h2> <ul><li><strong>优化 resolve.modules 配置</strong>。指定第三方模块存放的绝对路径，避免层层查找，减少搜索步骤，减少模块搜索层级。</li> <li><strong>优化 resolve.mainFields 配置</strong>。尽量少的值可以减少入口文件的搜索步骤。</li> <li><strong>优化 resolve.extensions 配置</strong>。指定定需要 Webpack 解析的文件类型，指定文件扩展名能加快寻找速度</li> <li><strong>合理使用 alias</strong>：当我们代码出现 import 时，Webpack 会采用向上递归搜索的方式去 node_modules 目录下找。为了减少搜索范围我们可以直接告诉 Webpack 去哪个路径下查找。让 Webpack 直接使用第三方模块的压缩版本，不再对库进行解析。缺点是会无法使用 Tree-Shaking 优化输出的打包文件，所以一般对 React 这种整体性比较强的使用比较好，而像 lodash 这样的工具库还是建议使用 Tree-Shaking 去除多余代码，还可以使用别名方便引用文件。</li> <li><strong>noParse</strong>：该属性告诉 Webpack 不用解析某些包。让 Webpack 排除对非模块化库文件的解析。如 jQuery、ChartJS 一些没有采用模块化标准的库，另外如果是用 resovle.alias 配置了 react.min.js，则也应该排除解析，因为 react.min.js 已是经过构建，并且可直接运行在浏览器的、非模块化的文件。被忽略掉的文件里不应该包含 import、 require、 define 等模块化语句，不 然会导致在构建出的代码中包含无法在浏览器环境下执行的模块化语句。</li> <li><strong>使用 IgnorePlugin 的 Webpack 的内置插件</strong>，忽略第三方包指定目录。</li> <li><strong>充分利用 loader 的 include 和 exclude</strong>。使用 include 配置项指明要转换的文件目录，使用 exclude 排除不必解析的文件目录</li></ul> <h2 id="构建缓存策略"><a href="#构建缓存策略" class="header-anchor">#</a> 构建缓存策略</h2> <p>提升二次构建速度。node-module 中 .cache 文件下有缓存记录。缓存思路：</p> <ul><li>babel-loader 开启缓存</li> <li>terser-webpack-plugin 开启缓存</li> <li>使用 cache-loader 或者 hard-source-webpack-plugin</li></ul> <h2 id="多进程-多线程构建与压缩"><a href="#多进程-多线程构建与压缩" class="header-anchor">#</a> 多进程/多线程构建与压缩</h2> <p>影响前端发布速度的有两个方面，一个是构建，一个就是压缩，把这两个东西优化起来，可以减少很多发布的时间。</p> <p>运行在 Node.js 之上的 webpack 是单线程模式的，也就是说，webpack 打包只能逐个文件处理，当 webpack 需要打包大量文件时，打包时间就会比较漫长。</p> <p>多进程/多实例构建的方案比较知名的有以下三种：</p> <ul><li>parallel-webpack</li> <li>HappyPack(webpack3使用较多，不怎么维护了)</li> <li>thread-loader(webpack4 用于替换 HappyPack)</li></ul> <h3 id="使用-happypack-多进程-多实例构建"><a href="#使用-happypack-多进程-多实例构建" class="header-anchor">#</a> 使用 HappyPack 多进程/多实例构建</h3> <p>在 Webpack 构建过程中，实际上耗费时间大多数用在 loader 解析转换以及代码的压缩中，HappyPack 可利用多线程对文件进行打包（默认 CPU 核数 - 1），对多核 CPU 利用率更高。</p> <p>HappyPack 可以通过 HappyPackPool 线程池将任务分解给多个子进程，最后将结果发给主进程。JS 是单线程模型，只能通过这种多进程的方式提高性能。</p> <p>HappyPack  就能让 Webpack 做到这点，它把任务分解给 多个子进程 去并发的执行，子进程处理完后再把结果发送给主进程。</p> <p>HappyPack 的处理思路是开启多进程 Loader 转换，将原有的 Webpack 对 loader 的执行过程从单一进程的形式扩展多进程模式，原本的流程保持不变。使用 HappyPack 也有一些限制，它只兼容部分主流的 loader，具体可以查看官方给出的 兼容性列表。</p> <div class="custom-block tip"><p class="custom-block-title">注意</p> <p>由于 HappyPack 对 file-loader、url-loader 支持的不友好，所以不建议对这些 loader 使用。</p></div> <h3 id="使用-thread-loader-多进程-多实例构建"><a href="#使用-thread-loader-多进程-多实例构建" class="header-anchor">#</a> 使用 thread-loader 多进程/多实例构建</h3> <p>原理：每次 webpack 解析一个模块，thread-loader 会将它及它的依赖分配给 worker 线程中</p> <p>使用 thread-loader 或 HappyPack 多进程/多实例构建简单 DEMO：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
    entry<span class="token operator">:</span> entry<span class="token punctuation">,</span>
    output<span class="token operator">:</span> <span class="token punctuation">{</span>
        path<span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'dist'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        filename<span class="token operator">:</span> <span class="token string">'[name]_[chunkhash:8].js'</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    mode<span class="token operator">:</span> <span class="token string">'production'</span><span class="token punctuation">,</span>
    module<span class="token operator">:</span> <span class="token punctuation">{</span>
        rules<span class="token operator">:</span> <span class="token punctuation">[</span>
            <span class="token punctuation">{</span>
                test<span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">.js$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span>
                include<span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'src'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                use<span class="token operator">:</span> <span class="token punctuation">[</span>
                    <span class="token punctuation">{</span>
                         loader<span class="token operator">:</span> <span class="token string">'thread-loader'</span><span class="token punctuation">,</span>
                         options<span class="token operator">:</span> <span class="token punctuation">{</span>
                             workers<span class="token operator">:</span> <span class="token number">3</span>
                         <span class="token punctuation">}</span>
                     <span class="token punctuation">}</span><span class="token punctuation">,</span>
                    <span class="token string">'cache-loader'</span><span class="token punctuation">,</span>
                    <span class="token string">'babel-loader'</span><span class="token punctuation">,</span>
                    <span class="token string">'happypack/loader'</span>
                    <span class="token string">'eslint-loader'</span>
                <span class="token punctuation">]</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">]</span><span class="token punctuation">,</span>
        plugins<span class="token operator">:</span> <span class="token punctuation">[</span>
          <span class="token keyword">new</span> <span class="token class-name">HappyPack</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            <span class="token comment">// 3) re-add the loaders you replaced above in #1:</span>
            loaders<span class="token operator">:</span> <span class="token punctuation">[</span> <span class="token string">'babel-loader?cacheDirectory=true'</span> <span class="token punctuation">]</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br></div></div><h3 id="使用-terserwebpackplugin-多进程-多线程并行压缩"><a href="#使用-terserwebpackplugin-多进程-多线程并行压缩" class="header-anchor">#</a> 使用 TerserWebpackPlugin 多进程/多线程并行压缩</h3> <p><code>terser-webpack-plugin</code> 是一个使用 terser 压缩 JS 的 Webpack 插件。开启 parallel 参数，使用多进程并行运行来提高构建速度。默认并发运行数：<code>os.cpus().length - 1</code>。并行化可以显著提高构建速度，因此强烈建议使用。TerserWebpackPlugin 支持 ES6 语法的压缩，UglifyjsWebpackPlugin 不支持。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>optimization<span class="token operator">:</span> <span class="token punctuation">{</span>
    minimizer<span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token keyword">new</span> <span class="token class-name">TerserPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            parallel<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
            cache<span class="token operator">:</span> <span class="token boolean">true</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h2 id="减少基础模块编译次数"><a href="#减少基础模块编译次数" class="header-anchor">#</a> 减少基础模块编译次数</h2> <p>使用 DllPlugin 预编译资源模块分离基础包(内置插件，更好的分离)，将 react，react-dom，redux，react-redux 基础包和业务包打包成一个文件。使用 DllPlugin 进行分包，使用 DllReferencePlugin 对 mainifest.json 引用。</p> <p>DllPlugin 动态链接库插件，其原理是把网页依赖的基础模块抽离出来打包到 dll 文件中，当需要导入的模块存在于某个 dll 中时，这个模块不再被打包，而是去 dll 中获取。</p> <p>由于 dll 中大多包含的是常用的第三方模块，如 react、react-dom，所以只要这些模块版本不升级，就只需被编译一次，在之后的构建过程中被动态链接库包含的模块将不会重新编译，而是直接使用动态链接库中的代码。</p> <p>我认为这样做和配置 resolve.alias 和 module.noParse 的效果有异曲同工的效果。</p> <p>使用方法:</p> <ul><li>DllPlugin - 用于打包出一个个单独的动态链接库文件</li> <li>DllReferencePlugin - 用于在主要的配置文件中引入 DllPlugin 插件打包好的动态链接库文件</li></ul> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// webpack.dll.js</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
    entry<span class="token operator">:</span> <span class="token punctuation">{</span>
        library<span class="token operator">:</span> <span class="token punctuation">[</span>
            <span class="token string">'react'</span><span class="token punctuation">,</span>
            <span class="token string">'react-dom'</span>
        <span class="token punctuation">]</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    output<span class="token operator">:</span> <span class="token punctuation">{</span>
        filename<span class="token operator">:</span> <span class="token string">'[name]_[chunkhash].dll.js'</span><span class="token punctuation">,</span>
        path<span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'build/library'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        library<span class="token operator">:</span> <span class="token string">'[name]'</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    plugins<span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token keyword">new</span> <span class="token class-name">webpack<span class="token punctuation">.</span>DllPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            name<span class="token operator">:</span> <span class="token string">'[name]_[hash]'</span><span class="token punctuation">,</span>
            path<span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'build/library/[name].json'</span><span class="token punctuation">)</span> <span class="token comment">// mainfest.json 的位置</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// webpack.prod.js</span>
<span class="token keyword">new</span> <span class="token class-name">webpack<span class="token punctuation">.</span>DllReferencePlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    manifest<span class="token operator">:</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./build/library/library.json'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><p>在 Webpack4 中，<code>hard-source-webpack-plugin</code> 是 DLL 的更好替代者。hard-source-webpack-plugin 是 Webpack 的插件，为模块提供中间缓存步骤。为了查看结果，您需要使用此插件运行 Webpack 两次：第一次构建将花费正常的时间。第二次构建将显着加快（大概提升 90%的构建速度）。</p> <h2 id="优化-sourcemap"><a href="#优化-sourcemap" class="header-anchor">#</a> 优化 SourceMap</h2> <p>开发环境推荐： cheap-module-eval-source-map</p> <p>生产环境推荐： cheap-module-source-map</p> <p>一般开发环境开启，线上环境关闭，线上排查问题时可将 sourcemap 上传错误监控系统。</p> <ul><li>eval：使用 eval 包裹模块代码，包裹最后有 sourcemap 信息</li> <li>source map：产生 <code>.map</code> 文件，包括行列信息，loader 也有对应的 sourcemap</li> <li>cheap：不包含列信息，只有行信息，没有列信息，loader 也没有对应的 sourcemap，对应的都是 loader 转换后的代码，不是纯正的源代码</li> <li>inline：将 <code>.map</code> 作为 DataURL 嵌入，不单独生成 <code>.map</code> 文件，不推荐使用，因为这样会造成源代码体积巨大</li> <li>module：包含 loader 的 sourcemap</li></ul> <p>(inline-)(cheap-)(module-)(eval-)source-map 按序组合</p> <h2 id="使用-prepack-提前求值"><a href="#使用-prepack-提前求值" class="header-anchor">#</a> 使用 Prepack 提前求值</h2> <p>Prepack 是一个部分求值器，编译代码时提前将计算结果放到编译后的代码中，而不是在代码运行时才去求值。升代码运行时效率。通过在便一阶段预先执行源码来得到执行结果，再直接将运行结果输出以提升性能。但是现在 Prepack 还不够成熟，<strong>用于线上环境还为时过早</strong>。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> PrepackWebpackPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'prepack-webpack-plugin'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>default<span class="token punctuation">;</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  plugins<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token keyword">new</span> <span class="token class-name">PrepackWebpackPlugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h2 id="使用-scope-hoisting"><a href="#使用-scope-hoisting" class="header-anchor">#</a> 使用 Scope Hoisting</h2> <p>webpack4 生产环境默认开启 ModuleConcatenationPlugin。</p> <p>现象：</p> <ul><li>构建后代码存在大量的函数闭包包裹代码，导致体积增大，模块越多越明显。</li> <li>运行代码时创建的函数作用域变多，内存开销大</li></ul> <p>译作“作用域提升”，是在 Webpack3 中推出的功能，它分析模块间的依赖关系，尽可能将被打散的模块合并到一个函数中，但不能造成代码冗余，所以只有被引用一次的模块才能被合并。由于需要分析模块间的依赖关系，所以源码 <strong>必须是采用了ES6 模块化的</strong>，否则 Webpack 会降级处理不采用 Scope Hoisting。将所有模块的代码按照引用顺序放在一个函数作用域里，然后适当的重命名一些变量以防止变量名冲突。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> ModuleConcatenationPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'webpack/lib/optimize/ModuleConcatenationPlugin'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token comment">//...</span>
    plugins<span class="token operator">:</span><span class="token punctuation">[</span>
        <span class="token keyword">new</span> <span class="token class-name">ModuleConcatenationPlugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    resolve<span class="token operator">:</span><span class="token punctuation">{</span>
        mainFields<span class="token operator">:</span><span class="token punctuation">[</span><span class="token string">'jsnext:main'</span><span class="token punctuation">,</span><span class="token string">'browser'</span><span class="token punctuation">,</span><span class="token string">'main'</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><h2 id="语言包优化"><a href="#语言包优化" class="header-anchor">#</a> 语言包优化</h2> <p>如果最开始选择日期库，那直接推荐使用 dayjs 了，如果你选择了 moment ，一定要注意把不使用的语言包过滤掉，推荐使用 ContextReplacementPlugin，它会告诉 webpack 我们会使用到哪个本地文件：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>plugins<span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token keyword">new</span> <span class="token class-name">webpack<span class="token punctuation">.</span>ContextReplacementPlugin</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">moment[/\\]locale$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">zh-cn</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>或使用内置插件 webpack.IgnorePlugin:</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>plugins<span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token comment">//忽略 moment 下的 ./locale 目录</span>
    <span class="token keyword">new</span> <span class="token class-name">webpack<span class="token punctuation">.</span>IgnorePlugin</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^\.\/locale$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">moment$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>在使用的时候，如果我们需要指定语言，那么需要我们手动的去引入语言包，例如，引入中文语言包:</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">import</span> moment <span class="token keyword">from</span> <span class="token string">'moment'</span><span class="token punctuation">;</span>
<span class="token comment">// 手动引入</span>
<span class="token keyword">import</span> <span class="token string">'moment/locale/zh-cn'</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h2 id="多页面打包优化"><a href="#多页面打包优化" class="header-anchor">#</a> 多页面打包优化</h2> <ul><li>页面间解耦</li> <li>更友好 SEO</li></ul> <p>利用 glob 动态获取 entry 和设置 html-webpack-plugin 数量</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 设置多页应用</span>
<span class="token keyword">const</span> <span class="token function-variable function">setMPA</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> entry <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> htmlWebpackPlugins <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> entryFiles <span class="token operator">=</span> glob<span class="token punctuation">.</span><span class="token function">sync</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'./src/*/index.js'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>entryFiles<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">index</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">const</span> entryFile <span class="token operator">=</span> entryFiles<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">;</span>

            <span class="token keyword">const</span> match <span class="token operator">=</span> entryFile<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">src\/(.*)\/index\.js</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">const</span> pageName <span class="token operator">=</span> match <span class="token operator">&amp;&amp;</span> match<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

            entry<span class="token punctuation">[</span>pageName<span class="token punctuation">]</span> <span class="token operator">=</span> entryFile<span class="token punctuation">;</span>
            htmlWebpackPlugins<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>
                <span class="token keyword">new</span> <span class="token class-name">HtmlWebpackPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
                    inlineSource<span class="token operator">:</span> <span class="token string">'.css$'</span><span class="token punctuation">,</span>
                    template<span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">src/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>pageName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/index.html</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    filename<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>pageName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.html</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
                    chunks<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'vendors'</span><span class="token punctuation">,</span> pageName<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// 'vendors' 分离的基础包 chunks</span>
                    inject<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
                    minify<span class="token operator">:</span> <span class="token punctuation">{</span>
                        html5<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
                        collapseWhitespace<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
                        preserveLineBreaks<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
                        minifyCSS<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
                        minifyJS<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
                        removeComments<span class="token operator">:</span> <span class="token boolean">false</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token punctuation">{</span>
        entry<span class="token punctuation">,</span>
        htmlWebpackPlugins
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> <span class="token punctuation">{</span> entry<span class="token punctuation">,</span> htmlWebpackPlugins <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">setMPA</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
    entry<span class="token operator">:</span> entry<span class="token punctuation">,</span>
    output<span class="token operator">:</span> <span class="token punctuation">{</span>
        path<span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'dist'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        filename<span class="token operator">:</span> <span class="token string">'[name]_[chunkhash:8].js'</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    mode<span class="token operator">:</span> <span class="token string">'production'</span><span class="token punctuation">,</span>
    plugins<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>htmlWebpackPlugins<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br></div></div><div class="custom-block warning"><p class="custom-block-title">参考文献</p> <p><a href="https://tsejx.github.io/webpack-guidebook/" target="_blank" rel="noopener noreferrer">Webpack Guidebook<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><a href="https://juejin.cn/post/6922641008106668045#heading-0" target="_blank" rel="noopener noreferrer">Vue 项目性能优化 — 实践指南<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><a href="https://juejin.cn/post/6844904101134729229" target="_blank" rel="noopener noreferrer">项目不知道如何做性能优化？不妨试一下代码分割(代码分割原理)<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><a href="https://juejin.cn/post/6844903655330562062#heading-3" target="_blank" rel="noopener noreferrer">网站性能优化实战——从12.67s到1.06s的故事<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><a href="https://jelly.jd.com/article/5ee390707c53070156dd4078" target="_blank" rel="noopener noreferrer">在京东，我们这样配置webpack<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></div></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/blog/optimization/performance/network.html" class="prev">
        网络层面优化
      </a></span> <span class="next"><a href="/blog/optimization/performance/render.html">
        渲染层面优化
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----><!----><!----><!----></div></div>
    <script src="/blog/assets/js/app.45ab665b.js" defer></script><script src="/blog/assets/js/2.55125c9d.js" defer></script><script src="/blog/assets/js/75.01358c7a.js" defer></script><script src="/blog/assets/js/4.f8e09ced.js" defer></script>
  </body>
</html>
