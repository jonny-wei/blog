<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>图片分类与主题色提取 | 前端那些事儿</title>
    <meta name="generator" content="VuePress 1.9.10">
    <link rel="icon" href="/blog/logo.png">
    <link rel="manifest" href="/blog/manifest.json">
    <link rel="apple-touch-icon" href="/blog/images/icons/apple-icon-152x152.png">
    <meta name="description" content="我命由我不由天，学习吧少年">
    <meta name="theme-color" content="#3eaf7c">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="msapplication-TileImage" content="/icons/ms-icon-144x144.png">
    <meta name="msapplication-TileColor" content="#000000">
    
    <link rel="preload" href="/blog/assets/css/0.styles.f0017422.css" as="style"><link rel="preload" href="/blog/assets/js/app.e167c4d9.js" as="script"><link rel="preload" href="/blog/assets/js/2.dec2e75d.js" as="script"><link rel="preload" href="/blog/assets/js/1.5b9e135c.js" as="script"><link rel="preload" href="/blog/assets/js/39.47282d18.js" as="script"><link rel="preload" href="/blog/assets/js/20.badbb211.js" as="script"><link rel="prefetch" href="/blog/assets/js/10.cc7e09f3.js"><link rel="prefetch" href="/blog/assets/js/100.c9eb98b2.js"><link rel="prefetch" href="/blog/assets/js/101.18ea58c9.js"><link rel="prefetch" href="/blog/assets/js/102.50d95968.js"><link rel="prefetch" href="/blog/assets/js/103.4cfa5054.js"><link rel="prefetch" href="/blog/assets/js/104.47c724ef.js"><link rel="prefetch" href="/blog/assets/js/105.ea080f51.js"><link rel="prefetch" href="/blog/assets/js/106.e242c957.js"><link rel="prefetch" href="/blog/assets/js/107.9f6cb36f.js"><link rel="prefetch" href="/blog/assets/js/108.c78f12f4.js"><link rel="prefetch" href="/blog/assets/js/109.912a4854.js"><link rel="prefetch" href="/blog/assets/js/11.b60c9933.js"><link rel="prefetch" href="/blog/assets/js/110.ba7dd32b.js"><link rel="prefetch" href="/blog/assets/js/111.280463a4.js"><link rel="prefetch" href="/blog/assets/js/112.c368d781.js"><link rel="prefetch" href="/blog/assets/js/113.11a11646.js"><link rel="prefetch" href="/blog/assets/js/114.0132f7b3.js"><link rel="prefetch" href="/blog/assets/js/115.c32f6423.js"><link rel="prefetch" href="/blog/assets/js/116.02860d44.js"><link rel="prefetch" href="/blog/assets/js/117.d5223f7d.js"><link rel="prefetch" href="/blog/assets/js/118.44e5a2bb.js"><link rel="prefetch" href="/blog/assets/js/119.71ea1c3f.js"><link rel="prefetch" href="/blog/assets/js/12.c53283e7.js"><link rel="prefetch" href="/blog/assets/js/120.f884a2a5.js"><link rel="prefetch" href="/blog/assets/js/121.12fbb0dc.js"><link rel="prefetch" href="/blog/assets/js/122.f94a3684.js"><link rel="prefetch" href="/blog/assets/js/123.bf3bb00a.js"><link rel="prefetch" href="/blog/assets/js/124.6e8b1dba.js"><link rel="prefetch" href="/blog/assets/js/125.b2a6953a.js"><link rel="prefetch" href="/blog/assets/js/126.e4e1f652.js"><link rel="prefetch" href="/blog/assets/js/127.b942a4b3.js"><link rel="prefetch" href="/blog/assets/js/128.c4cd2392.js"><link rel="prefetch" href="/blog/assets/js/129.d7743ad2.js"><link rel="prefetch" href="/blog/assets/js/13.6bdc6b5d.js"><link rel="prefetch" href="/blog/assets/js/130.89fe7501.js"><link rel="prefetch" href="/blog/assets/js/131.cb0ea907.js"><link rel="prefetch" href="/blog/assets/js/132.ae454055.js"><link rel="prefetch" href="/blog/assets/js/133.1fb65c29.js"><link rel="prefetch" href="/blog/assets/js/134.b7e49e42.js"><link rel="prefetch" href="/blog/assets/js/135.cd331791.js"><link rel="prefetch" href="/blog/assets/js/136.99022c5f.js"><link rel="prefetch" href="/blog/assets/js/137.c204c801.js"><link rel="prefetch" href="/blog/assets/js/138.11072dc9.js"><link rel="prefetch" href="/blog/assets/js/139.a7b9ee5f.js"><link rel="prefetch" href="/blog/assets/js/14.c3201a23.js"><link rel="prefetch" href="/blog/assets/js/140.42dbe4f0.js"><link rel="prefetch" href="/blog/assets/js/141.94fa9b5f.js"><link rel="prefetch" href="/blog/assets/js/142.10038048.js"><link rel="prefetch" href="/blog/assets/js/143.ae2794ca.js"><link rel="prefetch" href="/blog/assets/js/144.bfc24aa4.js"><link rel="prefetch" href="/blog/assets/js/145.3329d695.js"><link rel="prefetch" href="/blog/assets/js/146.80d1f7a4.js"><link rel="prefetch" href="/blog/assets/js/147.6bc76b56.js"><link rel="prefetch" href="/blog/assets/js/148.f1775c4b.js"><link rel="prefetch" href="/blog/assets/js/149.41d55e48.js"><link rel="prefetch" href="/blog/assets/js/15.a0b9e44e.js"><link rel="prefetch" href="/blog/assets/js/150.c5affd73.js"><link rel="prefetch" href="/blog/assets/js/151.731c2390.js"><link rel="prefetch" href="/blog/assets/js/152.fb05e213.js"><link rel="prefetch" href="/blog/assets/js/153.aaf891fc.js"><link rel="prefetch" href="/blog/assets/js/154.28ed43f9.js"><link rel="prefetch" href="/blog/assets/js/155.c7bd2f0a.js"><link rel="prefetch" href="/blog/assets/js/156.28bf984c.js"><link rel="prefetch" href="/blog/assets/js/157.9195b8a7.js"><link rel="prefetch" href="/blog/assets/js/158.7292d515.js"><link rel="prefetch" href="/blog/assets/js/159.bfac6e97.js"><link rel="prefetch" href="/blog/assets/js/16.491191e4.js"><link rel="prefetch" href="/blog/assets/js/160.68f60393.js"><link rel="prefetch" href="/blog/assets/js/161.4387caa5.js"><link rel="prefetch" href="/blog/assets/js/162.51c89735.js"><link rel="prefetch" href="/blog/assets/js/163.ec3b78ac.js"><link rel="prefetch" href="/blog/assets/js/164.b1f592cf.js"><link rel="prefetch" href="/blog/assets/js/165.349529bc.js"><link rel="prefetch" href="/blog/assets/js/166.e508130a.js"><link rel="prefetch" href="/blog/assets/js/167.bf7a46c5.js"><link rel="prefetch" href="/blog/assets/js/168.53dfe261.js"><link rel="prefetch" href="/blog/assets/js/169.e68d8cc7.js"><link rel="prefetch" href="/blog/assets/js/17.89ec8c57.js"><link rel="prefetch" href="/blog/assets/js/170.4b889667.js"><link rel="prefetch" href="/blog/assets/js/171.e37cef45.js"><link rel="prefetch" href="/blog/assets/js/172.c15140f1.js"><link rel="prefetch" href="/blog/assets/js/173.f5983df6.js"><link rel="prefetch" href="/blog/assets/js/174.56d53660.js"><link rel="prefetch" href="/blog/assets/js/175.63cc189a.js"><link rel="prefetch" href="/blog/assets/js/176.7f94419f.js"><link rel="prefetch" href="/blog/assets/js/177.2e778f00.js"><link rel="prefetch" href="/blog/assets/js/178.4b3c78c6.js"><link rel="prefetch" href="/blog/assets/js/179.0b106c7e.js"><link rel="prefetch" href="/blog/assets/js/18.b91f1411.js"><link rel="prefetch" href="/blog/assets/js/180.9a9db9c1.js"><link rel="prefetch" href="/blog/assets/js/181.d2a8c606.js"><link rel="prefetch" href="/blog/assets/js/182.ac73cf8f.js"><link rel="prefetch" href="/blog/assets/js/183.bbaeab4f.js"><link rel="prefetch" href="/blog/assets/js/184.0c197702.js"><link rel="prefetch" href="/blog/assets/js/185.a08d3259.js"><link rel="prefetch" href="/blog/assets/js/186.b1fa10b8.js"><link rel="prefetch" href="/blog/assets/js/187.75ee6b77.js"><link rel="prefetch" href="/blog/assets/js/188.03d3e3c4.js"><link rel="prefetch" href="/blog/assets/js/189.45be268f.js"><link rel="prefetch" href="/blog/assets/js/19.cb1f17c8.js"><link rel="prefetch" href="/blog/assets/js/190.4c70b520.js"><link rel="prefetch" href="/blog/assets/js/191.79056e6b.js"><link rel="prefetch" href="/blog/assets/js/192.935b3c6a.js"><link rel="prefetch" href="/blog/assets/js/193.afe5f5e6.js"><link rel="prefetch" href="/blog/assets/js/194.d17a7216.js"><link rel="prefetch" href="/blog/assets/js/195.a6a53082.js"><link rel="prefetch" href="/blog/assets/js/196.a655cba5.js"><link rel="prefetch" href="/blog/assets/js/197.77bb24de.js"><link rel="prefetch" href="/blog/assets/js/198.3ad3a1c9.js"><link rel="prefetch" href="/blog/assets/js/199.3f782727.js"><link rel="prefetch" href="/blog/assets/js/200.a8995c8e.js"><link rel="prefetch" href="/blog/assets/js/201.6c1d8f8c.js"><link rel="prefetch" href="/blog/assets/js/202.9443f613.js"><link rel="prefetch" href="/blog/assets/js/203.ea95b9b0.js"><link rel="prefetch" href="/blog/assets/js/204.613d1840.js"><link rel="prefetch" href="/blog/assets/js/205.dc3e11a2.js"><link rel="prefetch" href="/blog/assets/js/206.7cc9735f.js"><link rel="prefetch" href="/blog/assets/js/207.410386ae.js"><link rel="prefetch" href="/blog/assets/js/208.e744d24a.js"><link rel="prefetch" href="/blog/assets/js/209.099f2e3e.js"><link rel="prefetch" href="/blog/assets/js/21.bf0041b7.js"><link rel="prefetch" href="/blog/assets/js/210.167eebc6.js"><link rel="prefetch" href="/blog/assets/js/211.36d5a497.js"><link rel="prefetch" href="/blog/assets/js/212.617970bc.js"><link rel="prefetch" href="/blog/assets/js/213.a296a4b4.js"><link rel="prefetch" href="/blog/assets/js/214.ad499e16.js"><link rel="prefetch" href="/blog/assets/js/215.cf9f860a.js"><link rel="prefetch" href="/blog/assets/js/216.4ce6df55.js"><link rel="prefetch" href="/blog/assets/js/217.55493374.js"><link rel="prefetch" href="/blog/assets/js/218.65ca376c.js"><link rel="prefetch" href="/blog/assets/js/219.30c2da81.js"><link rel="prefetch" href="/blog/assets/js/22.48390d4f.js"><link rel="prefetch" href="/blog/assets/js/220.1d5709e0.js"><link rel="prefetch" href="/blog/assets/js/221.6a2478b4.js"><link rel="prefetch" href="/blog/assets/js/222.a7c9dce8.js"><link rel="prefetch" href="/blog/assets/js/223.5afa3b79.js"><link rel="prefetch" href="/blog/assets/js/224.51e80330.js"><link rel="prefetch" href="/blog/assets/js/225.09d0c412.js"><link rel="prefetch" href="/blog/assets/js/226.f71c0ce0.js"><link rel="prefetch" href="/blog/assets/js/227.4e115357.js"><link rel="prefetch" href="/blog/assets/js/23.35c4ba93.js"><link rel="prefetch" href="/blog/assets/js/24.cc3b12df.js"><link rel="prefetch" href="/blog/assets/js/25.632a83cc.js"><link rel="prefetch" href="/blog/assets/js/26.dc0735bf.js"><link rel="prefetch" href="/blog/assets/js/27.01692d0f.js"><link rel="prefetch" href="/blog/assets/js/28.3cdce864.js"><link rel="prefetch" href="/blog/assets/js/29.6c1aebe8.js"><link rel="prefetch" href="/blog/assets/js/3.cb0627fa.js"><link rel="prefetch" href="/blog/assets/js/30.b0873f63.js"><link rel="prefetch" href="/blog/assets/js/31.6ae5d6bc.js"><link rel="prefetch" href="/blog/assets/js/32.ac6cb854.js"><link rel="prefetch" href="/blog/assets/js/33.0a98d657.js"><link rel="prefetch" href="/blog/assets/js/34.40c5ff1d.js"><link rel="prefetch" href="/blog/assets/js/35.efc8ebcf.js"><link rel="prefetch" href="/blog/assets/js/36.20b76716.js"><link rel="prefetch" href="/blog/assets/js/37.f189ff30.js"><link rel="prefetch" href="/blog/assets/js/38.4892f77f.js"><link rel="prefetch" href="/blog/assets/js/4.cbb57fa7.js"><link rel="prefetch" href="/blog/assets/js/40.05545ac8.js"><link rel="prefetch" href="/blog/assets/js/41.7437f6d7.js"><link rel="prefetch" href="/blog/assets/js/42.714adee0.js"><link rel="prefetch" href="/blog/assets/js/43.c75777f5.js"><link rel="prefetch" href="/blog/assets/js/44.9cbfb2c5.js"><link rel="prefetch" href="/blog/assets/js/45.833d201a.js"><link rel="prefetch" href="/blog/assets/js/46.8191686d.js"><link rel="prefetch" href="/blog/assets/js/47.010cbb50.js"><link rel="prefetch" href="/blog/assets/js/48.5c4055e8.js"><link rel="prefetch" href="/blog/assets/js/49.8b1f8a28.js"><link rel="prefetch" href="/blog/assets/js/5.fe065607.js"><link rel="prefetch" href="/blog/assets/js/50.d987119c.js"><link rel="prefetch" href="/blog/assets/js/51.a17bc372.js"><link rel="prefetch" href="/blog/assets/js/52.bf4dfd27.js"><link rel="prefetch" href="/blog/assets/js/53.ed4350d1.js"><link rel="prefetch" href="/blog/assets/js/54.f066d9b0.js"><link rel="prefetch" href="/blog/assets/js/55.24fd50e0.js"><link rel="prefetch" href="/blog/assets/js/56.98c941b0.js"><link rel="prefetch" href="/blog/assets/js/57.b9773f20.js"><link rel="prefetch" href="/blog/assets/js/58.ee58e68a.js"><link rel="prefetch" href="/blog/assets/js/59.78411e0c.js"><link rel="prefetch" href="/blog/assets/js/6.68cda050.js"><link rel="prefetch" href="/blog/assets/js/60.0d75dd19.js"><link rel="prefetch" href="/blog/assets/js/61.cedaac73.js"><link rel="prefetch" href="/blog/assets/js/62.21462869.js"><link rel="prefetch" href="/blog/assets/js/63.9c8cbf57.js"><link rel="prefetch" href="/blog/assets/js/64.cdfa1458.js"><link rel="prefetch" href="/blog/assets/js/65.a85f73c0.js"><link rel="prefetch" href="/blog/assets/js/66.45510560.js"><link rel="prefetch" href="/blog/assets/js/67.64c61bf6.js"><link rel="prefetch" href="/blog/assets/js/68.30aef03e.js"><link rel="prefetch" href="/blog/assets/js/69.0c4a34cb.js"><link rel="prefetch" href="/blog/assets/js/7.3b8d63a0.js"><link rel="prefetch" href="/blog/assets/js/70.06a1bc4e.js"><link rel="prefetch" href="/blog/assets/js/71.8d806629.js"><link rel="prefetch" href="/blog/assets/js/72.ce2004b4.js"><link rel="prefetch" href="/blog/assets/js/73.e21f9c47.js"><link rel="prefetch" href="/blog/assets/js/74.bf6edcd7.js"><link rel="prefetch" href="/blog/assets/js/75.106e497f.js"><link rel="prefetch" href="/blog/assets/js/76.58cd0968.js"><link rel="prefetch" href="/blog/assets/js/77.8c04b31c.js"><link rel="prefetch" href="/blog/assets/js/78.ff200e44.js"><link rel="prefetch" href="/blog/assets/js/79.375a9aff.js"><link rel="prefetch" href="/blog/assets/js/80.7d56e86a.js"><link rel="prefetch" href="/blog/assets/js/81.f52b1074.js"><link rel="prefetch" href="/blog/assets/js/82.a69af57e.js"><link rel="prefetch" href="/blog/assets/js/83.990e39c8.js"><link rel="prefetch" href="/blog/assets/js/84.ccbf9553.js"><link rel="prefetch" href="/blog/assets/js/85.bdba086c.js"><link rel="prefetch" href="/blog/assets/js/86.4a301d2e.js"><link rel="prefetch" href="/blog/assets/js/87.f0d23d4b.js"><link rel="prefetch" href="/blog/assets/js/88.46df456a.js"><link rel="prefetch" href="/blog/assets/js/89.c56c8284.js"><link rel="prefetch" href="/blog/assets/js/90.35400392.js"><link rel="prefetch" href="/blog/assets/js/91.7ae8f9a1.js"><link rel="prefetch" href="/blog/assets/js/92.0eeaad4f.js"><link rel="prefetch" href="/blog/assets/js/93.d3afbce3.js"><link rel="prefetch" href="/blog/assets/js/94.d46f3ea7.js"><link rel="prefetch" href="/blog/assets/js/95.8258a561.js"><link rel="prefetch" href="/blog/assets/js/96.b9df442b.js"><link rel="prefetch" href="/blog/assets/js/97.34b79282.js"><link rel="prefetch" href="/blog/assets/js/98.fd1effee.js"><link rel="prefetch" href="/blog/assets/js/99.09292853.js"><link rel="prefetch" href="/blog/assets/js/vendors~docsearch.bd3cdb54.js">
    <link rel="stylesheet" href="/blog/assets/css/0.styles.f0017422.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/blog/" class="home-link router-link-active"><img src="/blog/logo.png" alt="前端那些事儿" class="logo"> <span class="site-name can-hide">前端那些事儿</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/blog/" class="nav-link">
  主页
</a></div><div class="nav-item"><a href="/blog/base/" class="nav-link">
  前端基础
</a></div><div class="nav-item"><a href="/blog/vue/" class="nav-link">
  Vue
</a></div><div class="nav-item"><a href="/blog/react/" class="nav-link">
  React
</a></div><div class="nav-item"><a href="/blog/devops/" class="nav-link">
  前端工程化
</a></div><div class="nav-item"><a href="/blog/mobile/" class="nav-link">
  泛客户端
</a></div><div class="nav-item"><a href="/blog/architecture/" class="nav-link router-link-active">
  架构与方案
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="GitHub" class="dropdown-title"><span class="title">GitHub</span> <span class="arrow down"></span></button> <button type="button" aria-label="GitHub" class="mobile-dropdown-title"><span class="title">GitHub</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/jonny-wei" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://github.com/jonny-wei/sushi-js" target="_blank" rel="noopener noreferrer" class="nav-link external">
  JS 寿司
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/blog/" class="nav-link">
  主页
</a></div><div class="nav-item"><a href="/blog/base/" class="nav-link">
  前端基础
</a></div><div class="nav-item"><a href="/blog/vue/" class="nav-link">
  Vue
</a></div><div class="nav-item"><a href="/blog/react/" class="nav-link">
  React
</a></div><div class="nav-item"><a href="/blog/devops/" class="nav-link">
  前端工程化
</a></div><div class="nav-item"><a href="/blog/mobile/" class="nav-link">
  泛客户端
</a></div><div class="nav-item"><a href="/blog/architecture/" class="nav-link router-link-active">
  架构与方案
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="GitHub" class="dropdown-title"><span class="title">GitHub</span> <span class="arrow down"></span></button> <button type="button" aria-label="GitHub" class="mobile-dropdown-title"><span class="title">GitHub</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/jonny-wei" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://github.com/jonny-wei/sushi-js" target="_blank" rel="noopener noreferrer" class="nav-link external">
  JS 寿司
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>前端架构</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/architecture/" aria-current="page" class="sidebar-link">渲染模式通识</a></li><li><a href="/blog/architecture/framework/Islands.html" class="sidebar-link">了解 Islands 架构</a></li><li><a href="/blog/architecture/framework/micro-frontend.html" class="sidebar-link">微前端架构</a></li><li><a href="/blog/architecture/framework/shadowbox.html" class="sidebar-link">微前端的沙箱设计</a></li><li><a href="/blog/architecture/framework/icestark.html" class="sidebar-link">iceStack 架构设计</a></li><li><a href="/blog/architecture/framework/wujie.html" class="sidebar-link">iframe 微前端方案</a></li><li><a href="/blog/architecture/framework/lowcode-components.html" class="sidebar-link">低代码组件设计与实现</a></li><li><a href="/blog/architecture/framework/lowcode-engine.html" class="sidebar-link">低代码引擎设计与实现</a></li><li><a href="/blog/architecture/framework/ali-lowcode-engine.html" class="sidebar-link">Ali-lowcode-engine</a></li><li><a href="/blog/architecture/framework/materialin-engine.html" class="sidebar-link">入料引擎</a></li><li><a href="/blog/architecture/framework/choreography-engine.html" class="sidebar-link">编排引擎</a></li><li><a href="/blog/architecture/framework/lowcode-extend.html" class="sidebar-link">低代码扩展点</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>前端方案</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/architecture/plan/color-thief.html" aria-current="page" class="active sidebar-link">图片分类与主题色提取</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/architecture/plan/color-thief.html#图片智能分类" class="sidebar-link">图片智能分类</a></li><li class="sidebar-sub-header"><a href="/blog/architecture/plan/color-thief.html#主题色智能提取" class="sidebar-link">主题色智能提取</a></li><li class="sidebar-sub-header"><a href="/blog/architecture/plan/color-thief.html#提取算法" class="sidebar-link">提取算法</a></li></ul></li><li><a href="/blog/architecture/plan/i18n.html" class="sidebar-link">国际化探索实践</a></li><li><a href="/blog/architecture/plan/sdk.html" class="sidebar-link">SDK 设计</a></li><li><a href="/blog/architecture/plan/pay.html" class="sidebar-link">三方支付与收银台</a></li><li><a href="/blog/architecture/plan/tracker.html" class="sidebar-link">积分任务与埋点</a></li><li><a href="/blog/architecture/plan/virtual-list.html" class="sidebar-link">虚拟滚动与懒加载</a></li><li><a href="/blog/architecture/plan/masonry.html" class="sidebar-link">瀑布流虚拟列表实践</a></li><li><a href="/blog/architecture/plan/file-transfer.html" class="sidebar-link">大文件上传</a></li><li><a href="/blog/architecture/plan/auth.html" class="sidebar-link">登录鉴权</a></li><li><a href="/blog/architecture/plan/webTransport.html" class="sidebar-link">WebTransport</a></li><li><a href="/blog/architecture/plan/webCodecs.html" class="sidebar-link">WebCodecs</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="图片分类与主题色提取"><a href="#图片分类与主题色提取" class="header-anchor">#</a> 图片分类与主题色提取</h1> <h2 id="图片智能分类"><a href="#图片智能分类" class="header-anchor">#</a> 图片智能分类</h2> <p>图片智能分类是计算机视觉领域的一个常见任务，通常涉及到从图片中提取特征并基于这些特征将图片分配到不同的类别。实现图片智能分类的步骤包括数据预处理、特征提取、训练分类模型、部署等。TensorFlow.js 提供了许多预训练模型，适合直接用于图像分类任务，无需进行训练。你可以使用这些模型来进行图片分类。</p> <p>常见的预训练模型包括：</p> <ul><li>MobileNet：是 Google 提出的一种轻量级神经网络架构，专为移动设备和嵌入式设备设计。其主要特点是使用深度可分离卷积（Depthwise Separable Convolutions），可以大幅度减少计算量和模型大小。。</li> <li>ResNet：适用于大规模图像分类任务，性能较强。是微软研究院提出的网络，它引入了“残差块”概念，通过跳跃连接来解决深度网络训练中的梯度消失问题，使得网络可以非常深，通常有几十层到几百层。</li> <li>Inception：也是一个高效的图像分类模型，通常用于更复杂的任务。是Google提出的模型，它引入了Inception模块，该模块通过不同尺寸的卷积核并行计算来提取不同尺度的特征。InceptionV3是目前使用最广泛的版本。</li></ul> <h3 id="任务流程概述"><a href="#任务流程概述" class="header-anchor">#</a> 任务流程概述</h3> <ul><li><strong>数据收集与标注</strong>：收集分类所需的图片数据，并为每个图片标注类别标签。常见的图片分类数据集有 ImageNet、COCO、CIFAR 等。</li> <li><strong>数据预处理</strong>：包括调整图片大小、数据增强（如旋转、翻转、裁剪）等，以提高模型的泛化能力。</li> <li><strong>模型选择与训练</strong>：使用卷积神经网络（CNN）等深度学习模型训练分类器，常用的框架包括 TensorFlow、Keras、PyTorch 等。</li> <li><strong>部署与集成</strong>：将训练好的模型导出并部署到服务器，通过 Node.js 提供 API 接口供 React 前端调用。</li> <li><strong>前端展示与交互</strong>：React 前端接收图片并通过 API 发送到后端进行分类，接收分类结果并显示给用户。</li></ul> <h3 id="简单实现"><a href="#简单实现" class="header-anchor">#</a> 简单实现</h3> <p>TensorFlow.js 提供了许多预训练模型，适合直接用于图像分类任务，无需进行训练。你可以使用这些模型来进行图片分类。</p> <p>常见的预训练模型包括：</p> <ul><li>MobileNet：一个轻量级的卷积神经网络模型，适用于边缘设备。</li> <li>ResNet：适用于大规模图像分类任务，性能较强。</li> <li>Inception：也是一个高效的图像分类模型，通常用于更复杂的任务。</li></ul> <p>总体流程：</p> <ul><li>前端上传图片：用户上传图片后，前端会将图片发送到后端（Node.js），并且进行压缩或优化。</li> <li>后端分类和打标：后端接收到图片后，通过已训练的模型（如 TensorFlow.js 或第三方 API）进行分类和打标，并- 将分类结果返回给前端。</li> <li>优化性能：在上传过程中，使用图片压缩技术和异步处理方法，优化性能，避免阻塞主线程。</li> <li>前端查询接口：前端可以定期查询接口获取已分类和标注过的图片，以显示不同类别的图片。</li></ul> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> multer <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'multer'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> sharp <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'sharp'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> tf <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'@tensorflow/tfjs-node'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> mobilenet <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'@tensorflow-models/mobilenet'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> mongoose <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'mongoose'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> redis <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'redis'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> createCanvas<span class="token punctuation">,</span> loadImage <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'canvas'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> imageModel <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./models/Image'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 图片数据库模型</span>

<span class="token comment">// 创建 Redis 客户端</span>
<span class="token keyword">const</span> redisClient <span class="token operator">=</span> redis<span class="token punctuation">.</span><span class="token function">createClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
redisClient<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'error'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">'Redis error:'</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 连接 MongoDB</span>
mongoose<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token string">'mongodb://localhost:27017/imageClassification'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">useNewUrlParser</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token literal-property property">useUnifiedTopology</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Connected to MongoDB'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">'MongoDB connection error:'</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> port <span class="token operator">=</span> <span class="token number">3000</span><span class="token punctuation">;</span>

<span class="token comment">// 设置 Multer 存储选项</span>
<span class="token keyword">const</span> storage <span class="token operator">=</span> multer<span class="token punctuation">.</span><span class="token function">diskStorage</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token function-variable function">destination</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> file<span class="token punctuation">,</span> cb</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> uploadDir <span class="token operator">=</span> <span class="token string">'./uploads'</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>fs<span class="token punctuation">.</span><span class="token function">existsSync</span><span class="token punctuation">(</span>uploadDir<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      fs<span class="token punctuation">.</span><span class="token function">mkdirSync</span><span class="token punctuation">(</span>uploadDir<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">cb</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> uploadDir<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function-variable function">filename</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> file<span class="token punctuation">,</span> cb</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">cb</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> path<span class="token punctuation">.</span><span class="token function">extname</span><span class="token punctuation">(</span>file<span class="token punctuation">.</span>originalname<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> upload <span class="token operator">=</span> <span class="token function">multer</span><span class="token punctuation">(</span><span class="token punctuation">{</span> storage <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 加载预训练 MobileNet 模型</span>
<span class="token keyword">let</span> model<span class="token punctuation">;</span>
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">loadModel</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  model <span class="token operator">=</span> <span class="token keyword">await</span> mobilenet<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'MobileNet model loaded successfully'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token function">loadModel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 图片上传接口</span>
app<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/upload'</span><span class="token punctuation">,</span> upload<span class="token punctuation">.</span><span class="token function">single</span><span class="token punctuation">(</span><span class="token string">'image'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>req<span class="token punctuation">.</span>file<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">400</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'No file uploaded.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 图片存储路径</span>
    <span class="token keyword">const</span> filePath <span class="token operator">=</span> req<span class="token punctuation">.</span>file<span class="token punctuation">.</span>path<span class="token punctuation">;</span>

    <span class="token comment">// 使用 sharp 处理图片（例如调整大小）</span>
    <span class="token keyword">const</span> processedFilePath <span class="token operator">=</span> filePath<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">extname</span><span class="token punctuation">(</span>filePath<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'-processed'</span> <span class="token operator">+</span> path<span class="token punctuation">.</span><span class="token function">extname</span><span class="token punctuation">(</span>filePath<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">await</span> <span class="token function">sharp</span><span class="token punctuation">(</span>filePath<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">resize</span><span class="token punctuation">(</span><span class="token number">224</span><span class="token punctuation">,</span> <span class="token number">224</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toFile</span><span class="token punctuation">(</span>processedFilePath<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// MobileNet 输入尺寸是 224x224</span>

    <span class="token comment">// 智能分类</span>
    <span class="token keyword">const</span> classificationResult <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">classifyImage</span><span class="token punctuation">(</span>processedFilePath<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 存储图片和分类信息到数据库</span>
    <span class="token keyword">const</span> imageData <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">imageModel</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token literal-property property">filePath</span><span class="token operator">:</span> processedFilePath<span class="token punctuation">,</span>
      <span class="token literal-property property">category</span><span class="token operator">:</span> classificationResult<span class="token punctuation">.</span>className<span class="token punctuation">,</span>
      <span class="token literal-property property">probability</span><span class="token operator">:</span> classificationResult<span class="token punctuation">.</span>probability<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">await</span> imageData<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 清理 Redis 缓存</span>
    redisClient<span class="token punctuation">.</span><span class="token function">del</span><span class="token punctuation">(</span><span class="token string">'image_list'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 清理图片查询缓存</span>

    res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token literal-property property">message</span><span class="token operator">:</span> <span class="token string">'File uploaded, processed, and classified successfully!'</span><span class="token punctuation">,</span>
      <span class="token literal-property property">filePath</span><span class="token operator">:</span> processedFilePath<span class="token punctuation">,</span>
      <span class="token literal-property property">classification</span><span class="token operator">:</span> classificationResult<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
    res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'Error processing the file.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 使用 MobileNet 进行智能分类</span>
<span class="token keyword">const</span> <span class="token function-variable function">classifyImage</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">imagePath</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token comment">// 加载图片并转换为张量</span>
    <span class="token keyword">const</span> image <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">loadImage</span><span class="token punctuation">(</span>imagePath<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> tensor <span class="token operator">=</span> tf<span class="token punctuation">.</span>browser<span class="token punctuation">.</span><span class="token function">fromPixels</span><span class="token punctuation">(</span>image<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toFloat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 预处理图片（例如标准化）</span>
    <span class="token keyword">const</span> processedTensor <span class="token operator">=</span> tensor<span class="token punctuation">.</span><span class="token function">div</span><span class="token punctuation">(</span>tf<span class="token punctuation">.</span><span class="token function">scalar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">expandDims</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 缩放到0-1之间并增加批次维度</span>

    <span class="token comment">// 进行预测</span>
    <span class="token keyword">const</span> predictions <span class="token operator">=</span> <span class="token keyword">await</span> model<span class="token punctuation">.</span><span class="token function">classify</span><span class="token punctuation">(</span>processedTensor<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 返回详细的预测结果，包括类别和概率</span>
    <span class="token keyword">const</span> category <span class="token operator">=</span> predictions<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>className<span class="token punctuation">;</span>  <span class="token comment">// 获取类别名称</span>
    <span class="token keyword">const</span> probability <span class="token operator">=</span> predictions<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>probability<span class="token punctuation">;</span>  <span class="token comment">// 获取该类别的预测概率</span>

    <span class="token keyword">return</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">className</span><span class="token operator">:</span> category<span class="token punctuation">,</span>  <span class="token comment">// 类别名称</span>
      <span class="token literal-property property">probability</span><span class="token operator">:</span> probability<span class="token punctuation">.</span><span class="token function">toFixed</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment">// 分类的置信度，保留4位小数</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">'Error in classification:'</span><span class="token punctuation">,</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span> <span class="token literal-property property">className</span><span class="token operator">:</span> <span class="token string">'Error'</span><span class="token punctuation">,</span> <span class="token literal-property property">probability</span><span class="token operator">:</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// 查询图片接口（支持分页和按分类标签查询）</span>
app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/images'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> page <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> limit <span class="token operator">=</span> <span class="token number">20</span><span class="token punctuation">,</span> category <span class="token operator">=</span> <span class="token string">''</span> <span class="token punctuation">}</span> <span class="token operator">=</span> req<span class="token punctuation">.</span>query<span class="token punctuation">;</span>
  <span class="token keyword">const</span> skip <span class="token operator">=</span> <span class="token punctuation">(</span>page <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> limit<span class="token punctuation">;</span>
  <span class="token keyword">const</span> cacheKey <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">image_list_</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>category<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">_</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>page<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>

  <span class="token comment">// 尝试从 Redis 获取缓存的结果</span>
  redisClient<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>cacheKey<span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> cachedData</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>cachedData<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>cachedData<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token comment">// 查询数据库</span>
      <span class="token keyword">const</span> query <span class="token operator">=</span> category <span class="token operator">?</span> <span class="token punctuation">{</span> category <span class="token punctuation">}</span> <span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> images <span class="token operator">=</span> <span class="token keyword">await</span> imageModel<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span>query<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">skip</span><span class="token punctuation">(</span>skip<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">limit</span><span class="token punctuation">(</span><span class="token function">Number</span><span class="token punctuation">(</span>limit<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">page</span><span class="token operator">:</span> <span class="token function">Number</span><span class="token punctuation">(</span>page<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token literal-property property">limit</span><span class="token operator">:</span> <span class="token function">Number</span><span class="token punctuation">(</span>limit<span class="token punctuation">)</span><span class="token punctuation">,</span>
        images<span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">;</span>

      <span class="token comment">// 缓存查询结果</span>
      redisClient<span class="token punctuation">.</span><span class="token function">setex</span><span class="token punctuation">(</span>cacheKey<span class="token punctuation">,</span> <span class="token number">3600</span><span class="token punctuation">,</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 缓存1小时</span>

      res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">'Error fetching images:'</span><span class="token punctuation">,</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span>
      res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'Error fetching images.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 监听服务器</span>
app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span>port<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Server is running on http://localhost:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>port<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br></div></div><p>查询图片分类接口的数据返回值示例：</p> <div class="language-json line-numbers-mode"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;page&quot;</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
  <span class="token property">&quot;limit&quot;</span><span class="token operator">:</span> <span class="token number">20</span><span class="token punctuation">,</span>
  <span class="token property">&quot;images&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      <span class="token property">&quot;_id&quot;</span><span class="token operator">:</span> <span class="token string">&quot;60c72b2f9b1d8e3f9c8e87b6&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;filePath&quot;</span><span class="token operator">:</span> <span class="token string">&quot;./uploads/1632820581000.jpg&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;category&quot;</span><span class="token operator">:</span> <span class="token string">&quot;cat&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;probability&quot;</span><span class="token operator">:</span> <span class="token number">0.8765</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      <span class="token property">&quot;_id&quot;</span><span class="token operator">:</span> <span class="token string">&quot;60c72b2f9b1d8e3f9c8e87b7&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;filePath&quot;</span><span class="token operator">:</span> <span class="token string">&quot;./uploads/1632820582000.jpg&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;category&quot;</span><span class="token operator">:</span> <span class="token string">&quot;dog&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;probability&quot;</span><span class="token operator">:</span> <span class="token number">0.9123</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p>一张图片可以有多个分类标签，这种情况通常被称为<strong>多标签分类</strong>（Multi-label Classification）。在传统的图像分类任务中，每张图片通常只有一个标签，而在多标签分类任务中，图片可能属于多个类别。例如，一张图片既可能被标记为“猫”，也可能被标记为“宠物”或者“室内”，这些标签是并列的，图片可以同时属于多个类别。</p> <p>对于每个类别，MobileNet 会返回一个分类概率，可以设置一个概率阈值（例如 0.5），如果该类别的概率超过阈值，就认为这张图片属于这个类别。这样就可以为每张图片分配多个标签：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 使用 MobileNet 进行智能分类（多标签）</span>
<span class="token keyword">const</span> <span class="token function-variable function">classifyImage</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">imagePath</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token comment">// 加载图片并转换为张量</span>
    <span class="token keyword">const</span> image <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">loadImage</span><span class="token punctuation">(</span>imagePath<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> tensor <span class="token operator">=</span> tf<span class="token punctuation">.</span>browser<span class="token punctuation">.</span><span class="token function">fromPixels</span><span class="token punctuation">(</span>image<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toFloat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 预处理图片（例如标准化）</span>
    <span class="token keyword">const</span> processedTensor <span class="token operator">=</span> tensor<span class="token punctuation">.</span><span class="token function">div</span><span class="token punctuation">(</span>tf<span class="token punctuation">.</span><span class="token function">scalar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">expandDims</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 缩放到0-1之间并增加批次维度</span>

    <span class="token comment">// 进行预测</span>
    <span class="token keyword">const</span> predictions <span class="token operator">=</span> <span class="token keyword">await</span> model<span class="token punctuation">.</span><span class="token function">classify</span><span class="token punctuation">(</span>processedTensor<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 设定一个阈值，选择概率大于该阈值的标签</span>
    <span class="token keyword">const</span> threshold <span class="token operator">=</span> <span class="token number">0.5</span><span class="token punctuation">;</span> <span class="token comment">// 你可以根据需求调整这个值</span>
    <span class="token keyword">const</span> multiLabels <span class="token operator">=</span> predictions<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token parameter">prediction</span> <span class="token operator">=&gt;</span> prediction<span class="token punctuation">.</span>probability <span class="token operator">&gt;</span> threshold<span class="token punctuation">)</span>
                                   <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">prediction</span> <span class="token operator">=&gt;</span> prediction<span class="token punctuation">.</span>className<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">labels</span><span class="token operator">:</span> multiLabels<span class="token punctuation">,</span>  <span class="token comment">// 返回所有预测出的标签</span>
      <span class="token literal-property property">probabilities</span><span class="token operator">:</span> multiLabels<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">label</span> <span class="token operator">=&gt;</span> predictions<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token parameter">pred</span> <span class="token operator">=&gt;</span> pred<span class="token punctuation">.</span>className <span class="token operator">===</span> label<span class="token punctuation">)</span><span class="token punctuation">.</span>probability<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">'Error in classification:'</span><span class="token punctuation">,</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span> <span class="token literal-property property">labels</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'Error'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token literal-property property">probabilities</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br></div></div><p>当查询图片时，可以返回所有与该图片相关的标签及其对应的概率：</p> <div class="language-json line-numbers-mode"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;page&quot;</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
  <span class="token property">&quot;limit&quot;</span><span class="token operator">:</span> <span class="token number">20</span><span class="token punctuation">,</span>
  <span class="token property">&quot;images&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      <span class="token property">&quot;_id&quot;</span><span class="token operator">:</span> <span class="token string">&quot;60c72b2f9b1d8e3f9c8e87b6&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;filePath&quot;</span><span class="token operator">:</span> <span class="token string">&quot;./uploads/1632820581000.jpg&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;labels&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;cat&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;pet&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;indoor&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token property">&quot;probabilities&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">0.8765</span><span class="token punctuation">,</span> <span class="token number">0.9123</span><span class="token punctuation">,</span> <span class="token number">0.8231</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      <span class="token property">&quot;_id&quot;</span><span class="token operator">:</span> <span class="token string">&quot;60c72b2f9b1d8e3f9c8e87b7&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;filePath&quot;</span><span class="token operator">:</span> <span class="token string">&quot;./uploads/1632820582000.jpg&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;labels&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;dog&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;pet&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;outdoor&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token property">&quot;probabilities&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">0.9123</span><span class="token punctuation">,</span> <span class="token number">0.8999</span><span class="token punctuation">,</span> <span class="token number">0.8044</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><h3 id="性能优化"><a href="#性能优化" class="header-anchor">#</a> 性能优化</h3> <p>图片分类是计算密集型任务，实时性要求高时，可能会面临延迟问题，尤其是在网络较差或图片较大的情况下。</p> <ul><li>选择合适的模型：采用轻量级模型（如MobileNet或EfficientNet）进行多标签分类，确保推理速度和准确度的平衡。</li> <li>推理优化：通过量化、剪枝、推理引擎优化（如TensorFlow Lite）来加速推理过程。</li> <li>上传与传输优化：通过图片压缩、分片上传和CDN加速优化上传过程，减少网络延迟。</li> <li>数据库优化：使用对象存储存储图片，标签信息通过倒排索引和缓存机制提高查询效率。</li> <li>前端与后端优化：使用分页、懒加载和任务队列等方法提升整体性能和用户体验。</li></ul> <h2 id="主题色智能提取"><a href="#主题色智能提取" class="header-anchor">#</a> 主题色智能提取</h2> <p>图片主题色的提取是图像处理中的一个常见需求，例如音频播放器根据封面图动态显示背景色，配合封面图起到很好视觉效果，沉浸式的用户体验。图片主题色提取也在图像分类，搜索识别等方面有利用。</p> <p>下面以音频播放器场景为例，提取封面图主题色，动态显示播放器的背景色。</p> <h3 id="实现方案"><a href="#实现方案" class="header-anchor">#</a> 实现方案</h3> <p>在实际应用中可直接使用类似 <code>ColorThief</code> 这样的库。这里主要介绍图片主题色提取的实现方案和原理。</p> <p>一般的技术方案主要为以下几个步骤：</p> <ul><li><p><strong>获取图片数据</strong>：使用 canvas 元素来获取图片的像素数据。首先，需要通过 <code>drawImage()</code> 方法将图片绘制到 canvas 上，然后通过 <code>getImageData()</code> 方法获取图片的像素数据。这个过程需要确保图片已经加载完成，否则可能会获取到错误的数据。如果图片较多，为了不影响主线程性能，可以使用 OffscreenCanvas 在 Web Worker 中进行 Canvas 离屏渲染，这样可以避免主线程被密集的计算任务阻塞。</p></li> <li><p><strong>空间转换与预处理</strong>：将图片从 RGB 颜色空间转换到更适合处理的颜色空间，如 HSV 或 LAB。为了减少计算量并提高提取算法的准确性，可通过降噪、缩放、去皮等对数据进行预处理。例如，通过高斯滤波、均值滤波、中值滤波等方式对图像降噪处理去除图像中的干扰。</p></li> <li><p><strong>提取主题色</strong>：采用颜色量化算法进行颜色提取。常用的颜色量化算法有最小差值法、中位切分法、八叉树算法、聚类、色彩建模法等。其中聚类和色彩建模法需要对提取函数和样本、特征变量等进行调参和回归计算不太适用于 JS 实践。</p></li> <li><p><strong>设置背景色主题色</strong>：将提取出的主题色设置到对应元素上。</p></li> <li><p><strong>优化调整</strong>：可根据实际效果进行调整，比如通过间隔采样、优化切割点查找等方式来优化性能和准确性。</p></li></ul> <h2 id="提取算法"><a href="#提取算法" class="header-anchor">#</a> 提取算法</h2> <p>颜色量化（Color Quantization）是一种减少图像中颜色数量的技术，它将图像从高颜色深度转换为低颜色深度，同时尽量保持图像的视觉质量。颜色量化通常用于：图像压缩与传输、索引颜色图像的创建（调色板）等。常见的颜色量化算法有：</p> <ol><li><strong>中位切分法（Median Cut）</strong>：中位切分法是一种颜色量化算法，它将颜色空间划分为多个区域，并计算每个区域的中位色作为该区域的主题色。算法从整个图像作为一个长方体开始，选择 RGB 中最长的一边从颜色统计的中位数一切为二，使得到的两个长方体所包含的像素数量相同，重复上述步骤，直到最终切分得到长方体的数量等于主题颜色数量为止。</li></ol> <ul><li>优点：可以很好地保持图像中颜色的分布，适用于快速获取主题色，并且对图像细节不太关心的场景。</li> <li>缺点：在某些条件下，可能会存在体积大但只包含少量像素的长方体，导致颜色表示不准确。此外，算法的运行时间可能会较长。</li></ul> <ol start="2"><li><strong>八叉树算法（Octree）</strong>：八叉树算法将颜色空间划分为一个八叉树结构，每个节点代表一个颜色区域。通过递归地将颜色空间划分为更小的区域来提取主题色。颜色成分转换成二进制后，较低位的数值被压缩进较高位，从而实现颜色的量化。</li></ol> <ul><li>优点：可以保留更多的细节信息，适用于需要精细颜色量化的场景。</li> <li>缺点：计算量较大，对于大规模图像数据，可能会有性能瓶颈。</li></ul> <ol start="3"><li><strong>K-Means聚类算法</strong>：一种无监督学习算法，用于将数据点分成 K 个簇。在图像主题色提取中，每个像素点被视为一个数据点，通过迭代计算，将像素点分配到最近的簇中心，从而形成主题色。算法开始时随机选择 K 个像素作为初始簇中心，然后通过迭代过程，不断更新簇中心，直到满足停止条件（如达到最大迭代次数或簇中心变化小于某个阈值）。</li></ol> <ul><li>优点：简单易懂，实现容易，对于大规模数据集相对高效。</li> <li>缺点：对初始簇中心的选择敏感，可能导致不同的结果。对于颜色空间的分布不均匀的问题，可能无法得到最佳的聚类效果。此外，K 值的选择也对结果有较大影响，但并没有一个统一的标准来确定最优的 K 值。</li></ul> <ol start="4"><li><strong>最小差值法</strong>：最小差值法是在给定调色板的情况下，找到与色差最小的颜色。对于每个像素，算法会计算它与调色板中每种颜色的差距，选择差距最小的颜色作为代表色。</li></ol> <ul><li>优点：实现简单，对于有固定调色板的应用场景非常适用。</li> <li>缺点：对于没有固定调色板的场景，需要预先定义调色板，这可能限制了算法的适用性。此外，对于色彩分布不均匀的图像，可能无法得到最佳的颜色表示。</li></ul> <ol start="5"><li><strong>流行色算法</strong>：流行色算法选择图像中出现频率最高的 K 个颜色作为图像的颜色映射表，然后计算选择映射表中距离图像各像素颜色值最近的颜色作为该像素的映射颜色。</li></ol> <ul><li>优点：能够保留图像中的主要颜色，对于颜色分布集中的图像效果较好。</li> <li>缺点：在计算过程中寻找最高频 K 颜色时将十分消耗内存，同时，做颜色映射的距离度量方式虽然可以有多种选择，但是最终得到的效果也相对较差。</li></ul> <h3 id="中位切分法"><a href="#中位切分法" class="header-anchor">#</a> 中位切分法</h3> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">/**
 * 对给定的颜色数组执行中位数切割算法。
 * @param {Array} colors - 颜色数组，每个元素是一个包含r, g, b属性的对象。
 * @param {number} maxColors - 最终想要得到的颜色数量。
 * @returns {Array} - 返回一个包含最终颜色的数组。
 */</span>
<span class="token keyword">function</span> <span class="token function">medianCut</span><span class="token punctuation">(</span><span class="token parameter">colors<span class="token punctuation">,</span> maxColors</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>colors<span class="token punctuation">.</span>length <span class="token operator">&lt;=</span> maxColors<span class="token punctuation">)</span> <span class="token keyword">return</span> colors<span class="token punctuation">;</span>

    <span class="token keyword">let</span> boxes <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token keyword">new</span> <span class="token class-name">Box</span><span class="token punctuation">(</span>colors<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword">while</span> <span class="token punctuation">(</span>boxes<span class="token punctuation">.</span>length <span class="token operator">&lt;</span> maxColors<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> boxToSplit <span class="token operator">=</span> boxes<span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">maxBox<span class="token punctuation">,</span> box</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> box<span class="token punctuation">.</span>range <span class="token operator">&gt;</span> maxBox<span class="token punctuation">.</span>range <span class="token operator">?</span> box <span class="token operator">:</span> maxBox<span class="token punctuation">,</span> boxes<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">const</span> newBoxes <span class="token operator">=</span> boxToSplit<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        boxes<span class="token punctuation">.</span><span class="token function">splice</span><span class="token punctuation">(</span>boxes<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>boxToSplit<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">...</span>newBoxes<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> boxes<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">box</span> <span class="token operator">=&gt;</span> box<span class="token punctuation">.</span><span class="token function">getAverageColor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">Box</span> <span class="token punctuation">{</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">colors</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>colors <span class="token operator">=</span> colors<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">calculateRange</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">calculateRange</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> minR <span class="token operator">=</span> <span class="token number">255</span><span class="token punctuation">,</span> maxR <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>
            minG <span class="token operator">=</span> <span class="token number">255</span><span class="token punctuation">,</span> maxG <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>
            minB <span class="token operator">=</span> <span class="token number">255</span><span class="token punctuation">,</span> maxB <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

        <span class="token keyword">this</span><span class="token punctuation">.</span>colors<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">color</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>color<span class="token punctuation">.</span>r <span class="token operator">&lt;</span> minR<span class="token punctuation">)</span> minR <span class="token operator">=</span> color<span class="token punctuation">.</span>r<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>color<span class="token punctuation">.</span>r <span class="token operator">&gt;</span> maxR<span class="token punctuation">)</span> maxR <span class="token operator">=</span> color<span class="token punctuation">.</span>r<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>color<span class="token punctuation">.</span>g <span class="token operator">&lt;</span> minG<span class="token punctuation">)</span> minG <span class="token operator">=</span> color<span class="token punctuation">.</span>g<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>color<span class="token punctuation">.</span>g <span class="token operator">&gt;</span> maxG<span class="token punctuation">)</span> maxG <span class="token operator">=</span> color<span class="token punctuation">.</span>g<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>color<span class="token punctuation">.</span>b <span class="token operator">&lt;</span> minB<span class="token punctuation">)</span> minB <span class="token operator">=</span> color<span class="token punctuation">.</span>b<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>color<span class="token punctuation">.</span>b <span class="token operator">&gt;</span> maxB<span class="token punctuation">)</span> maxB <span class="token operator">=</span> color<span class="token punctuation">.</span>b<span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">this</span><span class="token punctuation">.</span>range <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span>maxR <span class="token operator">-</span> minR<span class="token punctuation">,</span> maxG <span class="token operator">-</span> minG<span class="token punctuation">,</span> maxB <span class="token operator">-</span> minB<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">split</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> channel <span class="token operator">=</span> <span class="token string">'r'</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> maxRange <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>range<span class="token punctuation">;</span>

        <span class="token comment">// 确定哪个通道的范围最大</span>
        <span class="token punctuation">[</span><span class="token string">'r'</span><span class="token punctuation">,</span> <span class="token string">'g'</span><span class="token punctuation">,</span> <span class="token string">'b'</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">c</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">const</span> range <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token operator">...</span><span class="token keyword">this</span><span class="token punctuation">.</span>colors<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">color</span> <span class="token operator">=&gt;</span> color<span class="token punctuation">[</span>c<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">-</span> Math<span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span><span class="token operator">...</span><span class="token keyword">this</span><span class="token punctuation">.</span>colors<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">color</span> <span class="token operator">=&gt;</span> color<span class="token punctuation">[</span>c<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>range <span class="token operator">&gt;</span> maxRange<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                maxRange <span class="token operator">=</span> range<span class="token punctuation">;</span>
                channel <span class="token operator">=</span> c<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 根据最大范围的通道排序并切割</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>colors<span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span> b</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> a<span class="token punctuation">[</span>channel<span class="token punctuation">]</span> <span class="token operator">-</span> b<span class="token punctuation">[</span>channel<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">const</span> midIndex <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>colors<span class="token punctuation">.</span>length <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token keyword">new</span> <span class="token class-name">Box</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>colors<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> midIndex<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Box</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>colors<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>midIndex<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">getAverageColor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> totalR <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> totalG <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> totalB <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

        <span class="token keyword">this</span><span class="token punctuation">.</span>colors<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">color</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            totalR <span class="token operator">+=</span> color<span class="token punctuation">.</span>r<span class="token punctuation">;</span>
            totalG <span class="token operator">+=</span> color<span class="token punctuation">.</span>g<span class="token punctuation">;</span>
            totalB <span class="token operator">+=</span> color<span class="token punctuation">.</span>b<span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">const</span> count <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>colors<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token punctuation">{</span>
            <span class="token literal-property property">r</span><span class="token operator">:</span> Math<span class="token punctuation">.</span><span class="token function">round</span><span class="token punctuation">(</span>totalR <span class="token operator">/</span> count<span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token literal-property property">g</span><span class="token operator">:</span> Math<span class="token punctuation">.</span><span class="token function">round</span><span class="token punctuation">(</span>totalG <span class="token operator">/</span> count<span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token literal-property property">b</span><span class="token operator">:</span> Math<span class="token punctuation">.</span><span class="token function">round</span><span class="token punctuation">(</span>totalB <span class="token operator">/</span> count<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 测试用例：</span>
document<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'DOMContentLoaded'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> canvas <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'myCanvas'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> ctx <span class="token operator">=</span> canvas<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token string">'2d'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 假设这里已经有一张图片绘制在canvas上</span>
    <span class="token comment">// 例如：ctx.drawImage(image, 0, 0);</span>

    <span class="token comment">// 获取图像数据</span>
    <span class="token keyword">const</span> imageData <span class="token operator">=</span> ctx<span class="token punctuation">.</span><span class="token function">getImageData</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> canvas<span class="token punctuation">.</span>width<span class="token punctuation">,</span> canvas<span class="token punctuation">.</span>height<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> data <span class="token operator">=</span> imageData<span class="token punctuation">.</span>data<span class="token punctuation">;</span>

    <span class="token comment">// 提取颜色数据</span>
    <span class="token keyword">const</span> colors <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> data<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i <span class="token operator">+=</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> r <span class="token operator">=</span> data<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">const</span> g <span class="token operator">=</span> data<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">const</span> b <span class="token operator">=</span> data<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token comment">// 可以选择忽略透明度为0的像素</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>data<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">!==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            colors<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span> r<span class="token punctuation">,</span> g<span class="token punctuation">,</span> b <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 应用中位数切割算法</span>
    <span class="token keyword">const</span> resultColors <span class="token operator">=</span> <span class="token function">medianCut</span><span class="token punctuation">(</span>colors<span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 假设我们希望得到5种主要颜色</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>resultColors<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br></div></div><h3 id="八叉树算法"><a href="#八叉树算法" class="header-anchor">#</a> 八叉树算法</h3> <div class="language-js line-numbers-mode"><pre class="language-js"><code>

<span class="token comment">/**
 * 八叉树类
 */</span>
<span class="token keyword">class</span> <span class="token class-name">Octree</span> <span class="token punctuation">{</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>root <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>maxDepth <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span> <span class="token comment">// 八叉树的最大深度</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>colorMap <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span> <span class="token comment">// 存储最终的颜色映射</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 添加颜色到八叉树
     * @param {Object} color - 包含r, g, b属性的颜色对象
     */</span>
    <span class="token function">addColor</span><span class="token punctuation">(</span><span class="token parameter">color</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>root<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>root <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OctreeNode</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>root<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>color<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 减少颜色数量
     * @param {number} maxColors - 最终想要得到的颜色数量
     * @returns {Array} - 返回一个包含最终颜色的数组
     */</span>
    <span class="token function">reduceColors</span><span class="token punctuation">(</span><span class="token parameter">maxColors</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> nodes <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getLeafNodes</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>root<span class="token punctuation">)</span><span class="token punctuation">;</span>
        nodes<span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span> b</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> b<span class="token punctuation">.</span>volume <span class="token operator">-</span> a<span class="token punctuation">.</span>volume<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">while</span> <span class="token punctuation">(</span>nodes<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> maxColors<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">const</span> node <span class="token operator">=</span> nodes<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            node<span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">updateParentVolumes</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>parent<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">buildColorMap</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>root<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> Object<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>colorMap<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 获取所有叶子节点
     * @param {OctreeNode} node - 当前节点
     * @returns {Array} - 返回所有叶子节点的数组
     */</span>
    <span class="token function">getLeafNodes</span><span class="token punctuation">(</span><span class="token parameter">node</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>node<span class="token punctuation">.</span>children<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token punctuation">[</span>node<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">let</span> leafNodes <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> child <span class="token keyword">of</span> node<span class="token punctuation">.</span>children<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            leafNodes <span class="token operator">=</span> leafNodes<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getLeafNodes</span><span class="token punctuation">(</span>child<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> leafNodes<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 更新父节点的体积
     * @param {OctreeNode} node - 当前节点
     */</span>
    <span class="token function">updateParentVolumes</span><span class="token punctuation">(</span><span class="token parameter">node</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            node<span class="token punctuation">.</span><span class="token function">calculateVolume</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">updateParentVolumes</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>parent<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 构建颜色映射
     * @param {OctreeNode} node - 当前节点
     */</span>
    <span class="token function">buildColorMap</span><span class="token punctuation">(</span><span class="token parameter">node</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>node<span class="token punctuation">.</span>children<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>colorMap<span class="token punctuation">[</span>node<span class="token punctuation">.</span>averageColor<span class="token punctuation">]</span> <span class="token operator">=</span> node<span class="token punctuation">.</span>averageColor<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> child <span class="token keyword">of</span> node<span class="token punctuation">.</span>children<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">buildColorMap</span><span class="token punctuation">(</span>child<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
 * 八叉树节点类
 */</span>
<span class="token keyword">class</span> <span class="token class-name">OctreeNode</span> <span class="token punctuation">{</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">depth</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>depth <span class="token operator">=</span> depth<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>children <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>volume <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>totalR <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>totalG <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>totalB <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>pixelCount <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 插入颜色到节点
     * @param {Object} color - 包含r, g, b属性的颜色对象
     * @param {number} level - 当前深度
     */</span>
    <span class="token function">insert</span><span class="token punctuation">(</span><span class="token parameter">color<span class="token punctuation">,</span> level</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>level <span class="token operator">===</span> <span class="token keyword">this</span><span class="token punctuation">.</span>depth <span class="token operator">||</span> <span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>children<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>totalR <span class="token operator">+=</span> color<span class="token punctuation">.</span>r<span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>totalG <span class="token operator">+=</span> color<span class="token punctuation">.</span>g<span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>totalB <span class="token operator">+=</span> color<span class="token punctuation">.</span>b<span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>pixelCount<span class="token operator">++</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">calculateVolume</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>children<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>children <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">8</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>children<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">OctreeNode</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>depth <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">const</span> index <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getIndex</span><span class="token punctuation">(</span>color<span class="token punctuation">,</span> level<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>children<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>color<span class="token punctuation">,</span> level <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 计算节点的体积
     */</span>
    <span class="token function">calculateVolume</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>volume <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>pixelCount<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 获取颜色在当前深度的索引
     * @param {Object} color - 包含r, g, b属性的颜色对象
     * @param {number} level - 当前深度
     * @returns {number} - 返回索引
     */</span>
    <span class="token function">getIndex</span><span class="token punctuation">(</span><span class="token parameter">color<span class="token punctuation">,</span> level</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> mask <span class="token operator">=</span> <span class="token number">0x80</span> <span class="token operator">&gt;&gt;</span> level<span class="token punctuation">;</span>
        <span class="token keyword">const</span> r <span class="token operator">=</span> <span class="token function">Boolean</span><span class="token punctuation">(</span>color<span class="token punctuation">.</span>r <span class="token operator">&amp;</span> mask<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">const</span> g <span class="token operator">=</span> <span class="token function">Boolean</span><span class="token punctuation">(</span>color<span class="token punctuation">.</span>g <span class="token operator">&amp;</span> mask<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">const</span> b <span class="token operator">=</span> <span class="token function">Boolean</span><span class="token punctuation">(</span>color<span class="token punctuation">.</span>b <span class="token operator">&amp;</span> mask<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span>r <span class="token operator">&lt;&lt;</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token punctuation">(</span>g <span class="token operator">&lt;&lt;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">|</span> b<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 减少节点
     */</span>
    <span class="token function">reduce</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>children <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">calculateVolume</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 获取节点的平均颜色
     * @returns {Object} - 包含r, g, b属性的颜色对象
     */</span>
    <span class="token keyword">get</span> <span class="token function">averageColor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token punctuation">{</span>
            <span class="token literal-property property">r</span><span class="token operator">:</span> Math<span class="token punctuation">.</span><span class="token function">round</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>totalR <span class="token operator">/</span> <span class="token keyword">this</span><span class="token punctuation">.</span>pixelCount<span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token literal-property property">g</span><span class="token operator">:</span> Math<span class="token punctuation">.</span><span class="token function">round</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>totalG <span class="token operator">/</span> <span class="token keyword">this</span><span class="token punctuation">.</span>pixelCount<span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token literal-property property">b</span><span class="token operator">:</span> Math<span class="token punctuation">.</span><span class="token function">round</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>totalB <span class="token operator">/</span> <span class="token keyword">this</span><span class="token punctuation">.</span>pixelCount<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>


document<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'DOMContentLoaded'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> canvas <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'myCanvas'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> ctx <span class="token operator">=</span> canvas<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token string">'2d'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 假设这里已经有一张图片绘制在canvas上</span>
    <span class="token comment">// 例如：ctx.drawImage(image, 0, 0);</span>

    <span class="token comment">// 获取图像数据</span>
    <span class="token keyword">const</span> imageData <span class="token operator">=</span> ctx<span class="token punctuation">.</span><span class="token function">getImageData</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> canvas<span class="token punctuation">.</span>width<span class="token punctuation">,</span> canvas<span class="token punctuation">.</span>height<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> data <span class="token operator">=</span> imageData<span class="token punctuation">.</span>data<span class="token punctuation">;</span>

    <span class="token comment">// 提取颜色数据</span>
    <span class="token keyword">const</span> colors <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> data<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i <span class="token operator">+=</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> r <span class="token operator">=</span> data<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">const</span> g <span class="token operator">=</span> data<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">const</span> b <span class="token operator">=</span> data<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token comment">// 可以选择忽略透明度为0的像素</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>data<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">!==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            colors<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span> r<span class="token punctuation">,</span> g<span class="token punctuation">,</span> b <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">const</span> octree <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Octree</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    colors<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">color</span> <span class="token operator">=&gt;</span> octree<span class="token punctuation">.</span><span class="token function">addColor</span><span class="token punctuation">(</span>color<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> resultColors <span class="token operator">=</span> octree<span class="token punctuation">.</span><span class="token function">reduceColors</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 假设我们希望得到5种主要颜色</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>resultColors<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br><span class="line-number">156</span><br><span class="line-number">157</span><br><span class="line-number">158</span><br><span class="line-number">159</span><br><span class="line-number">160</span><br><span class="line-number">161</span><br><span class="line-number">162</span><br><span class="line-number">163</span><br><span class="line-number">164</span><br><span class="line-number">165</span><br><span class="line-number">166</span><br><span class="line-number">167</span><br><span class="line-number">168</span><br><span class="line-number">169</span><br><span class="line-number">170</span><br><span class="line-number">171</span><br><span class="line-number">172</span><br><span class="line-number">173</span><br><span class="line-number">174</span><br><span class="line-number">175</span><br><span class="line-number">176</span><br><span class="line-number">177</span><br><span class="line-number">178</span><br><span class="line-number">179</span><br><span class="line-number">180</span><br><span class="line-number">181</span><br><span class="line-number">182</span><br><span class="line-number">183</span><br><span class="line-number">184</span><br><span class="line-number">185</span><br><span class="line-number">186</span><br><span class="line-number">187</span><br><span class="line-number">188</span><br><span class="line-number">189</span><br><span class="line-number">190</span><br><span class="line-number">191</span><br><span class="line-number">192</span><br><span class="line-number">193</span><br><span class="line-number">194</span><br><span class="line-number">195</span><br><span class="line-number">196</span><br></div></div><p>中位切分法适用于资源有限且需要快速提取图像主题色的场景，尤其适合实时或大规模处理需求。它的简单性和计算效率使其在这些场景下成为很好的选择，尤其是当主要目标是从图像中快速捕捉主题颜色而不需要过多考虑细节和渐变色时。而八叉树在动态适应性和处理颜色渐变方面具有优势，适用于需要保持细节不和平滑度的图像颜色提取任务，但其算法复杂度较高，内存消耗较大。</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/blog/architecture/framework/lowcode-extend.html" class="prev">
        低代码扩展点
      </a></span> <span class="next"><a href="/blog/architecture/plan/i18n.html">
        国际化探索实践
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----><!----><!----><!----></div></div>
    <script src="/blog/assets/js/app.e167c4d9.js" defer></script><script src="/blog/assets/js/2.dec2e75d.js" defer></script><script src="/blog/assets/js/1.5b9e135c.js" defer></script><script src="/blog/assets/js/39.47282d18.js" defer></script><script src="/blog/assets/js/20.badbb211.js" defer></script>
  </body>
</html>
