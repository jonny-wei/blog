<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>入料引擎 | 前端那些事儿</title>
    <meta name="generator" content="VuePress 1.9.10">
    <link rel="icon" href="/blog/logo.png">
    <link rel="manifest" href="/blog/manifest.json">
    <link rel="apple-touch-icon" href="/blog/images/icons/apple-icon-152x152.png">
    <meta name="description" content="我命由我不由天，学习吧少年">
    <meta name="theme-color" content="#3eaf7c">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="msapplication-TileImage" content="/icons/ms-icon-144x144.png">
    <meta name="msapplication-TileColor" content="#000000">
    
    <link rel="preload" href="/blog/assets/css/0.styles.f0017422.css" as="style"><link rel="preload" href="/blog/assets/js/app.59e6d68a.js" as="script"><link rel="preload" href="/blog/assets/js/2.dec2e75d.js" as="script"><link rel="preload" href="/blog/assets/js/1.5b9e135c.js" as="script"><link rel="preload" href="/blog/assets/js/31.46150093.js" as="script"><link rel="preload" href="/blog/assets/js/20.badbb211.js" as="script"><link rel="prefetch" href="/blog/assets/js/10.cc7e09f3.js"><link rel="prefetch" href="/blog/assets/js/100.b63af24f.js"><link rel="prefetch" href="/blog/assets/js/101.26398b0c.js"><link rel="prefetch" href="/blog/assets/js/102.12f95af1.js"><link rel="prefetch" href="/blog/assets/js/103.74ccb38f.js"><link rel="prefetch" href="/blog/assets/js/104.f84b4594.js"><link rel="prefetch" href="/blog/assets/js/105.3ada386b.js"><link rel="prefetch" href="/blog/assets/js/106.a0d0f2b2.js"><link rel="prefetch" href="/blog/assets/js/107.d6d3cd73.js"><link rel="prefetch" href="/blog/assets/js/108.cb6fac0d.js"><link rel="prefetch" href="/blog/assets/js/109.c50862b2.js"><link rel="prefetch" href="/blog/assets/js/11.b60c9933.js"><link rel="prefetch" href="/blog/assets/js/110.81f0314b.js"><link rel="prefetch" href="/blog/assets/js/111.8376ee58.js"><link rel="prefetch" href="/blog/assets/js/112.c0d12038.js"><link rel="prefetch" href="/blog/assets/js/113.c21e05b1.js"><link rel="prefetch" href="/blog/assets/js/114.88b4ccf2.js"><link rel="prefetch" href="/blog/assets/js/115.33fe24ec.js"><link rel="prefetch" href="/blog/assets/js/116.9cb72e38.js"><link rel="prefetch" href="/blog/assets/js/117.b9430f57.js"><link rel="prefetch" href="/blog/assets/js/118.7bc5c3d8.js"><link rel="prefetch" href="/blog/assets/js/119.c3a595db.js"><link rel="prefetch" href="/blog/assets/js/12.c53283e7.js"><link rel="prefetch" href="/blog/assets/js/120.162d18a5.js"><link rel="prefetch" href="/blog/assets/js/121.38fd3c8d.js"><link rel="prefetch" href="/blog/assets/js/122.5daeabf9.js"><link rel="prefetch" href="/blog/assets/js/123.53be21a6.js"><link rel="prefetch" href="/blog/assets/js/124.abadd615.js"><link rel="prefetch" href="/blog/assets/js/125.692beb96.js"><link rel="prefetch" href="/blog/assets/js/126.4c5b391f.js"><link rel="prefetch" href="/blog/assets/js/127.070347f6.js"><link rel="prefetch" href="/blog/assets/js/128.acdbcf7c.js"><link rel="prefetch" href="/blog/assets/js/129.ecec9539.js"><link rel="prefetch" href="/blog/assets/js/13.6bdc6b5d.js"><link rel="prefetch" href="/blog/assets/js/130.678ca2e8.js"><link rel="prefetch" href="/blog/assets/js/131.2e7f6aec.js"><link rel="prefetch" href="/blog/assets/js/132.fc32efa3.js"><link rel="prefetch" href="/blog/assets/js/133.7d82b717.js"><link rel="prefetch" href="/blog/assets/js/134.1850dd5c.js"><link rel="prefetch" href="/blog/assets/js/135.0d9b9a23.js"><link rel="prefetch" href="/blog/assets/js/136.691de1f8.js"><link rel="prefetch" href="/blog/assets/js/137.310d57a5.js"><link rel="prefetch" href="/blog/assets/js/138.19f72c84.js"><link rel="prefetch" href="/blog/assets/js/139.491a74e1.js"><link rel="prefetch" href="/blog/assets/js/14.c3201a23.js"><link rel="prefetch" href="/blog/assets/js/140.d8a4d673.js"><link rel="prefetch" href="/blog/assets/js/141.aeec2aed.js"><link rel="prefetch" href="/blog/assets/js/142.3d2315bf.js"><link rel="prefetch" href="/blog/assets/js/143.cd8ac794.js"><link rel="prefetch" href="/blog/assets/js/144.d4dc20a5.js"><link rel="prefetch" href="/blog/assets/js/145.e680c035.js"><link rel="prefetch" href="/blog/assets/js/146.843cbd89.js"><link rel="prefetch" href="/blog/assets/js/147.17003cf1.js"><link rel="prefetch" href="/blog/assets/js/148.e74a6d07.js"><link rel="prefetch" href="/blog/assets/js/149.d81b780c.js"><link rel="prefetch" href="/blog/assets/js/15.a0b9e44e.js"><link rel="prefetch" href="/blog/assets/js/150.cf1bb55f.js"><link rel="prefetch" href="/blog/assets/js/151.88cc7c0c.js"><link rel="prefetch" href="/blog/assets/js/152.815e6190.js"><link rel="prefetch" href="/blog/assets/js/153.b015a4c4.js"><link rel="prefetch" href="/blog/assets/js/154.c0618ec5.js"><link rel="prefetch" href="/blog/assets/js/155.7d7d51ae.js"><link rel="prefetch" href="/blog/assets/js/156.8733e684.js"><link rel="prefetch" href="/blog/assets/js/157.1bcaa452.js"><link rel="prefetch" href="/blog/assets/js/158.6a27d59b.js"><link rel="prefetch" href="/blog/assets/js/159.658d1e7b.js"><link rel="prefetch" href="/blog/assets/js/16.491191e4.js"><link rel="prefetch" href="/blog/assets/js/160.ad3bc230.js"><link rel="prefetch" href="/blog/assets/js/161.3f371219.js"><link rel="prefetch" href="/blog/assets/js/162.6aa0796d.js"><link rel="prefetch" href="/blog/assets/js/163.4293de4b.js"><link rel="prefetch" href="/blog/assets/js/164.2c4d15ea.js"><link rel="prefetch" href="/blog/assets/js/165.9f8004d8.js"><link rel="prefetch" href="/blog/assets/js/166.273c2c00.js"><link rel="prefetch" href="/blog/assets/js/167.a990ce0f.js"><link rel="prefetch" href="/blog/assets/js/168.92e32817.js"><link rel="prefetch" href="/blog/assets/js/169.1cbc230d.js"><link rel="prefetch" href="/blog/assets/js/17.89ec8c57.js"><link rel="prefetch" href="/blog/assets/js/170.bf2a8d53.js"><link rel="prefetch" href="/blog/assets/js/171.c2b6a965.js"><link rel="prefetch" href="/blog/assets/js/172.6c9ee7bf.js"><link rel="prefetch" href="/blog/assets/js/173.11e5764e.js"><link rel="prefetch" href="/blog/assets/js/174.202d7c26.js"><link rel="prefetch" href="/blog/assets/js/175.c268a285.js"><link rel="prefetch" href="/blog/assets/js/176.4e85758b.js"><link rel="prefetch" href="/blog/assets/js/177.3608e43d.js"><link rel="prefetch" href="/blog/assets/js/178.d90b8fcd.js"><link rel="prefetch" href="/blog/assets/js/179.ee8fce39.js"><link rel="prefetch" href="/blog/assets/js/18.b91f1411.js"><link rel="prefetch" href="/blog/assets/js/180.94295080.js"><link rel="prefetch" href="/blog/assets/js/181.b65499ea.js"><link rel="prefetch" href="/blog/assets/js/182.b9cae6df.js"><link rel="prefetch" href="/blog/assets/js/183.5334c8a3.js"><link rel="prefetch" href="/blog/assets/js/184.83e9e65a.js"><link rel="prefetch" href="/blog/assets/js/185.47e2a72b.js"><link rel="prefetch" href="/blog/assets/js/186.789c2b50.js"><link rel="prefetch" href="/blog/assets/js/187.ef716075.js"><link rel="prefetch" href="/blog/assets/js/188.fb14d94e.js"><link rel="prefetch" href="/blog/assets/js/189.af7be37c.js"><link rel="prefetch" href="/blog/assets/js/19.cb1f17c8.js"><link rel="prefetch" href="/blog/assets/js/190.dadd2059.js"><link rel="prefetch" href="/blog/assets/js/191.b8b27ab6.js"><link rel="prefetch" href="/blog/assets/js/192.7ff53284.js"><link rel="prefetch" href="/blog/assets/js/193.0e72f1c7.js"><link rel="prefetch" href="/blog/assets/js/194.c741247f.js"><link rel="prefetch" href="/blog/assets/js/195.06b6a4c1.js"><link rel="prefetch" href="/blog/assets/js/196.cb44416c.js"><link rel="prefetch" href="/blog/assets/js/197.aca0e0ae.js"><link rel="prefetch" href="/blog/assets/js/198.40fddab3.js"><link rel="prefetch" href="/blog/assets/js/199.31ddcecb.js"><link rel="prefetch" href="/blog/assets/js/200.37c27a7e.js"><link rel="prefetch" href="/blog/assets/js/201.38df7733.js"><link rel="prefetch" href="/blog/assets/js/202.bbf6735d.js"><link rel="prefetch" href="/blog/assets/js/203.e33d8a55.js"><link rel="prefetch" href="/blog/assets/js/204.b4ee9e03.js"><link rel="prefetch" href="/blog/assets/js/205.16f979d5.js"><link rel="prefetch" href="/blog/assets/js/206.d7c864f1.js"><link rel="prefetch" href="/blog/assets/js/207.150d8c5d.js"><link rel="prefetch" href="/blog/assets/js/208.69712489.js"><link rel="prefetch" href="/blog/assets/js/209.a8393cdc.js"><link rel="prefetch" href="/blog/assets/js/21.bf0041b7.js"><link rel="prefetch" href="/blog/assets/js/210.2bf50412.js"><link rel="prefetch" href="/blog/assets/js/211.587f0909.js"><link rel="prefetch" href="/blog/assets/js/212.a031f8a0.js"><link rel="prefetch" href="/blog/assets/js/213.9f686e69.js"><link rel="prefetch" href="/blog/assets/js/214.85f0ef23.js"><link rel="prefetch" href="/blog/assets/js/215.df6b88a4.js"><link rel="prefetch" href="/blog/assets/js/216.e247c8d4.js"><link rel="prefetch" href="/blog/assets/js/217.f29af104.js"><link rel="prefetch" href="/blog/assets/js/218.1dd8802c.js"><link rel="prefetch" href="/blog/assets/js/22.48390d4f.js"><link rel="prefetch" href="/blog/assets/js/23.35c4ba93.js"><link rel="prefetch" href="/blog/assets/js/24.36b663f1.js"><link rel="prefetch" href="/blog/assets/js/25.8a4f7dd6.js"><link rel="prefetch" href="/blog/assets/js/26.3a3f8d13.js"><link rel="prefetch" href="/blog/assets/js/27.067ef541.js"><link rel="prefetch" href="/blog/assets/js/28.ab227016.js"><link rel="prefetch" href="/blog/assets/js/29.50e2c405.js"><link rel="prefetch" href="/blog/assets/js/3.cb0627fa.js"><link rel="prefetch" href="/blog/assets/js/30.470a659f.js"><link rel="prefetch" href="/blog/assets/js/32.bf429371.js"><link rel="prefetch" href="/blog/assets/js/33.31cfb662.js"><link rel="prefetch" href="/blog/assets/js/34.1d4b19f5.js"><link rel="prefetch" href="/blog/assets/js/35.e732926b.js"><link rel="prefetch" href="/blog/assets/js/36.37c07a11.js"><link rel="prefetch" href="/blog/assets/js/37.8c24ade8.js"><link rel="prefetch" href="/blog/assets/js/38.adac6090.js"><link rel="prefetch" href="/blog/assets/js/39.29b696d0.js"><link rel="prefetch" href="/blog/assets/js/4.cbb57fa7.js"><link rel="prefetch" href="/blog/assets/js/40.25ac0cfe.js"><link rel="prefetch" href="/blog/assets/js/41.6d52a7c7.js"><link rel="prefetch" href="/blog/assets/js/42.900e233a.js"><link rel="prefetch" href="/blog/assets/js/43.8edaefcf.js"><link rel="prefetch" href="/blog/assets/js/44.7064b832.js"><link rel="prefetch" href="/blog/assets/js/45.4162f35e.js"><link rel="prefetch" href="/blog/assets/js/46.853ffd2d.js"><link rel="prefetch" href="/blog/assets/js/47.be6cf846.js"><link rel="prefetch" href="/blog/assets/js/48.0e03fcff.js"><link rel="prefetch" href="/blog/assets/js/49.351df526.js"><link rel="prefetch" href="/blog/assets/js/5.fe065607.js"><link rel="prefetch" href="/blog/assets/js/50.dbf30f84.js"><link rel="prefetch" href="/blog/assets/js/51.aa1502f1.js"><link rel="prefetch" href="/blog/assets/js/52.051274ec.js"><link rel="prefetch" href="/blog/assets/js/53.f2e699e0.js"><link rel="prefetch" href="/blog/assets/js/54.28a6163c.js"><link rel="prefetch" href="/blog/assets/js/55.bd439c79.js"><link rel="prefetch" href="/blog/assets/js/56.895d9536.js"><link rel="prefetch" href="/blog/assets/js/57.0e8f4e7f.js"><link rel="prefetch" href="/blog/assets/js/58.592a495a.js"><link rel="prefetch" href="/blog/assets/js/59.807d909e.js"><link rel="prefetch" href="/blog/assets/js/6.68cda050.js"><link rel="prefetch" href="/blog/assets/js/60.ce08768a.js"><link rel="prefetch" href="/blog/assets/js/61.2c33a76a.js"><link rel="prefetch" href="/blog/assets/js/62.ad4d32f6.js"><link rel="prefetch" href="/blog/assets/js/63.ef7a1c14.js"><link rel="prefetch" href="/blog/assets/js/64.74a6341a.js"><link rel="prefetch" href="/blog/assets/js/65.29b44d0e.js"><link rel="prefetch" href="/blog/assets/js/66.02ce144f.js"><link rel="prefetch" href="/blog/assets/js/67.6020d42f.js"><link rel="prefetch" href="/blog/assets/js/68.249d1600.js"><link rel="prefetch" href="/blog/assets/js/69.e1d857c7.js"><link rel="prefetch" href="/blog/assets/js/7.3b8d63a0.js"><link rel="prefetch" href="/blog/assets/js/70.ef2df8e0.js"><link rel="prefetch" href="/blog/assets/js/71.070fff66.js"><link rel="prefetch" href="/blog/assets/js/72.2dc92d35.js"><link rel="prefetch" href="/blog/assets/js/73.07008de9.js"><link rel="prefetch" href="/blog/assets/js/74.5061c878.js"><link rel="prefetch" href="/blog/assets/js/75.8cc6fda1.js"><link rel="prefetch" href="/blog/assets/js/76.8b3739b7.js"><link rel="prefetch" href="/blog/assets/js/77.a37537ca.js"><link rel="prefetch" href="/blog/assets/js/78.45288a2b.js"><link rel="prefetch" href="/blog/assets/js/79.fa24985a.js"><link rel="prefetch" href="/blog/assets/js/80.a8e14c69.js"><link rel="prefetch" href="/blog/assets/js/81.bf1b2ea9.js"><link rel="prefetch" href="/blog/assets/js/82.d4807a66.js"><link rel="prefetch" href="/blog/assets/js/83.7ffb6487.js"><link rel="prefetch" href="/blog/assets/js/84.150cff7e.js"><link rel="prefetch" href="/blog/assets/js/85.31f56ab1.js"><link rel="prefetch" href="/blog/assets/js/86.e3d004f2.js"><link rel="prefetch" href="/blog/assets/js/87.7ad2b4a6.js"><link rel="prefetch" href="/blog/assets/js/88.962e38e9.js"><link rel="prefetch" href="/blog/assets/js/89.6652b576.js"><link rel="prefetch" href="/blog/assets/js/90.f2a0d2ed.js"><link rel="prefetch" href="/blog/assets/js/91.1896f07b.js"><link rel="prefetch" href="/blog/assets/js/92.5b0606ae.js"><link rel="prefetch" href="/blog/assets/js/93.de577040.js"><link rel="prefetch" href="/blog/assets/js/94.97f1188b.js"><link rel="prefetch" href="/blog/assets/js/95.c4580227.js"><link rel="prefetch" href="/blog/assets/js/96.61c82c05.js"><link rel="prefetch" href="/blog/assets/js/97.cb7da797.js"><link rel="prefetch" href="/blog/assets/js/98.bab7d49d.js"><link rel="prefetch" href="/blog/assets/js/99.a46ccd97.js"><link rel="prefetch" href="/blog/assets/js/vendors~docsearch.bd3cdb54.js">
    <link rel="stylesheet" href="/blog/assets/css/0.styles.f0017422.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/blog/" class="home-link router-link-active"><img src="/blog/logo.png" alt="前端那些事儿" class="logo"> <span class="site-name can-hide">前端那些事儿</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/blog/" class="nav-link">
  主页
</a></div><div class="nav-item"><a href="/blog/base/" class="nav-link">
  前端基础
</a></div><div class="nav-item"><a href="/blog/vue/" class="nav-link">
  Vue
</a></div><div class="nav-item"><a href="/blog/react/" class="nav-link">
  React
</a></div><div class="nav-item"><a href="/blog/devops/" class="nav-link">
  前端工程化
</a></div><div class="nav-item"><a href="/blog/mobile/" class="nav-link">
  泛客户端
</a></div><div class="nav-item"><a href="/blog/architecture/" class="nav-link router-link-active">
  架构与方案
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="GitHub" class="dropdown-title"><span class="title">GitHub</span> <span class="arrow down"></span></button> <button type="button" aria-label="GitHub" class="mobile-dropdown-title"><span class="title">GitHub</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/jonny-wei" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://github.com/jonny-wei/sushi-js" target="_blank" rel="noopener noreferrer" class="nav-link external">
  JS 寿司
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/blog/" class="nav-link">
  主页
</a></div><div class="nav-item"><a href="/blog/base/" class="nav-link">
  前端基础
</a></div><div class="nav-item"><a href="/blog/vue/" class="nav-link">
  Vue
</a></div><div class="nav-item"><a href="/blog/react/" class="nav-link">
  React
</a></div><div class="nav-item"><a href="/blog/devops/" class="nav-link">
  前端工程化
</a></div><div class="nav-item"><a href="/blog/mobile/" class="nav-link">
  泛客户端
</a></div><div class="nav-item"><a href="/blog/architecture/" class="nav-link router-link-active">
  架构与方案
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="GitHub" class="dropdown-title"><span class="title">GitHub</span> <span class="arrow down"></span></button> <button type="button" aria-label="GitHub" class="mobile-dropdown-title"><span class="title">GitHub</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/jonny-wei" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://github.com/jonny-wei/sushi-js" target="_blank" rel="noopener noreferrer" class="nav-link external">
  JS 寿司
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>前端架构</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/architecture/" aria-current="page" class="sidebar-link">渲染模式通识</a></li><li><a href="/blog/architecture/framework/Islands.html" class="sidebar-link">了解 Islands 架构</a></li><li><a href="/blog/architecture/framework/micro-frontend.html" class="sidebar-link">微前端架构</a></li><li><a href="/blog/architecture/framework/shadowbox.html" class="sidebar-link">微前端的沙箱设计</a></li><li><a href="/blog/architecture/framework/icestark.html" class="sidebar-link">iceStack 架构设计</a></li><li><a href="/blog/architecture/framework/wujie.html" class="sidebar-link">iframe 微前端方案</a></li><li><a href="/blog/architecture/framework/ali-lowcode-engine.html" class="sidebar-link">Ali-lowcode-engine</a></li><li><a href="/blog/architecture/framework/materialin-engine.html" aria-current="page" class="active sidebar-link">入料引擎</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/architecture/framework/materialin-engine.html#简介" class="sidebar-link">简介</a></li><li class="sidebar-sub-header"><a href="/blog/architecture/framework/materialin-engine.html#入料方式" class="sidebar-link">入料方式</a></li><li class="sidebar-sub-header"><a href="/blog/architecture/framework/materialin-engine.html#原理" class="sidebar-link">原理</a></li><li class="sidebar-sub-header"><a href="/blog/architecture/framework/materialin-engine.html#入料解析整体流程" class="sidebar-link">入料解析整体流程</a></li></ul></li><li><a href="/blog/architecture/framework/choreography-engine.html" class="sidebar-link">编排引擎</a></li><li><a href="/blog/architecture/framework/lowcode-extend.html" class="sidebar-link">低代码扩展点</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>前端方案</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/architecture/plan/i18n.html" class="sidebar-link">国际化探索实践</a></li><li><a href="/blog/architecture/plan/color-thief.html" class="sidebar-link">图片主题色智能提取</a></li><li><a href="/blog/architecture/plan/pay.html" class="sidebar-link">三方支付与收银台</a></li><li><a href="/blog/architecture/plan/tracker.html" class="sidebar-link">积分任务与埋点</a></li><li><a href="/blog/architecture/plan/virtual-list.html" class="sidebar-link">无限滚动虚拟列表</a></li><li><a href="/blog/architecture/plan/masonry.html" class="sidebar-link">瀑布流虚拟列表实践</a></li><li><a href="/blog/architecture/plan/file-transfer.html" class="sidebar-link">大文件上传</a></li><li><a href="/blog/architecture/plan/webTransport.html" class="sidebar-link">WebTransport</a></li><li><a href="/blog/architecture/plan/webCodecs.html" class="sidebar-link">WebCodecs</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="入料引擎"><a href="#入料引擎" class="header-anchor">#</a> 入料引擎</h1> <h2 id="简介"><a href="#简介" class="header-anchor">#</a> 简介</h2> <p>入料模块负责物料接入，能自动扫描、解析源码组件，并产出一份符合<a href="https://yuque.antfin-inc.com/mo/spec/spec-materials#cmYER" target="_blank" rel="noopener noreferrer"><strong>《中后台低代码组件描述协议》</strong><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>的 <strong>JSON Schema(其实就是物料解析输出复符合搭建协议的schema的模块)</strong>。这份Schema包含基础信息和属性描述信息部分，低代码引擎会基于它们在运行时自动生成一份configure字段，用作设置面板展示。如果有需要补充的属性描述信息，或者需要定制体验增强部分(如修改Setter、调整展示顺序等)，可以手动修改生成的Schema。</p> <p><strong>源码物料 ---&gt; 协议 ---&gt; 入料模块(接入器、扫描器、解析器、转换器、生成器、校验器) ---&gt; JSON Schema描述文件(低代码物料) ---&gt; 设计器</strong></p> <h2 id="入料方式"><a href="#入料方式" class="header-anchor">#</a> 入料方式</h2> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">import</span> parse <span class="token keyword">from</span> <span class="token string">'@ali/lowcode-material-parser'</span><span class="token punctuation">;</span>

<span class="token comment">// 本地入料</span>
<span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> options <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">entry</span><span class="token operator">:</span> <span class="token string">'/path/to/component'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">accesser</span><span class="token operator">:</span> <span class="token string">'local'</span> <span class="token comment">// 本地代码入料，默认值为'local'，可省略</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">parse</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>result<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 输出符合协议的schema</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 在线入料</span>
<span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> options <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">entry</span><span class="token operator">:</span> <span class="token string">'mc-hello@1.0.7'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">accesser</span><span class="token operator">:</span> <span class="token string">'online'</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">parse</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>result<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 组件接入 WebIDE</span>
本地开发时，如果使用build<span class="token operator">-</span>scripts脚手架，
可以直接使用相应插件：@alife<span class="token operator">/</span>build<span class="token operator">-</span>plugin<span class="token operator">-</span>lowcode。
如果使用其他脚手架，可以参照上面本地入料的代码，自行开发脚本；
在物料中心，可以在界面上直接点击“解析生成”，后端服务会自动调用入料模块，生成schema，
可以进一步手动修改。
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br></div></div><h2 id="原理"><a href="#原理" class="header-anchor">#</a> 原理</h2> <p>入料模块使用动静态分析结合的方案，动态胜在真实，静态胜在细致，不过全都依赖源码中定义的属性，若未定义，或者定义错误，则无法正确入料。</p> <div class="custom-block tip"><p class="custom-block-title">lowcode-engine/modules/material-parser  重点使用以下包和API：</p> <ul><li><a href="https://github.com/reactjs/react-docgen" target="_blank" rel="noopener noreferrer">react-docgen<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://github.com/styleguidist/react-docgen-typescript" target="_blank" rel="noopener noreferrer">react-docgen-typescript<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://github.com/Microsoft/TypeScript/wiki/Using-the-Compiler-API" target="_blank" rel="noopener noreferrer">TypeScript Compiler API<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div> <div class="language-json line-numbers-mode"><pre class="language-json"><code><span class="token comment">// modules/material-parser/package.json</span>
<span class="token property">&quot;dependencies&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;ajv&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^6.12.0&quot;</span><span class="token punctuation">,</span> <span class="token comment">// 非常快的 JSON Schema 校验器。Ajv 生成代码以将 JSON 模式转换为对 v8 优化有效的超快速验证函数。旨在通过将 JSON 模式即时编译为代码来实现最佳的验证性能。</span>
    <span class="token property">&quot;ast-types&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^0.13.3&quot;</span><span class="token punctuation">,</span> <span class="token comment">// 一种高效、模块化的 AST 类型系统的解析器，该库能够提供出色的节点迭代和遍历机制。</span>
    <span class="token property">&quot;cross-spawn-promise&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^0.10.2&quot;</span><span class="token punctuation">,</span> <span class="token comment">// promise 跨平台写法，不用开发者处理跨平台的逻辑。</span>
    <span class="token property">&quot;debug&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^4.1.1&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;find-config&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^1.0.0&quot;</span><span class="token punctuation">,</span> <span class="token comment">// 目录及文件查找</span>
    <span class="token property">&quot;fs-extra&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^8.1.0&quot;</span><span class="token punctuation">,</span> <span class="token comment">// 在 node 内置的 fs(文件系统交互) 的基础上，社区提供的 fs-extra 工具包增强文件系统交互，并且提供了 Promise 的调用方式。</span>
    <span class="token property">&quot;lodash&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^4.17.15&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;parse-prop-types&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^0.3.0&quot;</span><span class="token punctuation">,</span> <span class="token comment">// 在运行时将React 解析prop-types为可读对象。</span>
    <span class="token property">&quot;prop-types&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^15.7.2&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;react-docgen&quot;</span><span class="token operator">:</span> <span class="token string">&quot;5.3.0&quot;</span><span class="token punctuation">,</span> <span class="token comment">// 从React组件中提取信息，并从中生成文档。它使用 ast-types 和 @babel/parser 将源码解析为 AST，并提供处理此 AST 以提取所需信息的方法。输出/返回值是一个 JSON blob / JavaScript 对象。</span>
    <span class="token property">&quot;react-docgen-typescript&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^1.16.5&quot;</span><span class="token punctuation">,</span> <span class="token comment">// TypeScript 中定义的 React 属性的简单解析器，而不是 propTypes。</span>
    <span class="token property">&quot;safe-eval&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^0.4.1&quot;</span><span class="token punctuation">,</span> <span class="token comment">// 更安全的 eval() 版本.</span>
    <span class="token property">&quot;short-uuid&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^3.1.1&quot;</span><span class="token punctuation">,</span> <span class="token comment">// 创建和翻译具有较短格式的标准 UUID 唯一值</span>
    <span class="token property">&quot;ts-polyfill&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^3.8.1-rc&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;typescript&quot;</span><span class="token operator">:</span> <span class="token string">&quot;3.9.4&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;vm2&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^3.9.2&quot;</span> <span class="token comment">// vm2 是一个沙箱，可以使用列入白名单的 Node 内置模块运行不受信任的代码。安全！</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><h3 id="整体架构"><a href="#整体架构" class="header-anchor">#</a> 整体架构</h3> <p><img src="/blog/images/architecture/lowcode8.png" alt="lowcode8"></p> <p><strong>架构说明与解析（重点）：</strong></p> <p>入料引擎核先要完成的工作是接收 MATERIAL 通过多种不同的接入渠道 ① 发起接入请求，经扫描器 ② 扫描分析出 MATERIAL 的入口文件和层次结构(中间态schema)后，再由解析器 ③ 解析 MATERIAL 源码生成一棵 AST并从中提取出一些关键信息，并交由生成器 ④ 生成 ⑤ 引擎产物的整个过程。</p> <p>整个过程可以分为扫描、解析、生成产物三个阶段，每个阶段都有对应的处理器来进行处理，分别对应扫描器 ②、解析器 ③、生成器 ④。</p> <p>在流程开始阶段，MATERIAL 会先向引擎核心发起接入请求，引擎核心会将这个请求分发给扫描器 ②，扫描器 ② 再根据 MATERIAL 接入渠道的不同来调度不同的扫描器，如：Local 渠道会映射到 LocalScanner、Web 渠道会映射到  WebScanner。因为每种不同的渠道都有其特殊场景特点，Local 渠道适用于拥有一套完整的本地开发环境的开发者，更关注于 MATERIAL 功能实现； Web 渠道适用于使用者，更关注于功能使用。</p> <p>进入扫描阶段后，扫描器 ② 将请求映射到对应的扫描器后，扫描器就会立即开始对 MATERIAL 源码进行扫描分析，得出 MATERIAL <strong>入口文件</strong>和<strong>层次结构</strong>，然后会将这些信息传递下一阶段的解析器，此时会进入到解析阶段。</p> <p>进入解析阶段后，解析器 ③ 会分析并识别出 MATERIAL 所处的生态（DSLType），如：React、Vue、Rax。每种生态会分别对应一个解析器，如：React 会对应 ReactParser、Vue 会对应 VueParser。解析器 ③ 会解析 MATERIAL 源码并生成一棵语法树 AST，然后分析语法树 AST 从中抽取出下一阶段需要的关键信息，如：exportName、props、defaultProps 等。</p> <p>进入生成阶段后，生成器 ④ 会先判断 MATERIAL 的接入渠道是哪一种，如果是 Local，则调度 LocalGenerator；如果是 Web，则调度 WebGenerator；然后再根据解析器 ③ 传递过来的信息生成引擎产物，主要包括：MANIFEST 配置文件、CONTAINER 装饰文件和最终会被使用到的 MATERIAL 物料。这一阶段存在的业务扩展点是一键上传和可视化配置 MANIFEST，一键上传功能可以根据实际的需求场景将 MATEIRAL 上传到对应的平台，可视化配置则可以根据实际的需求来定制需要让用户可视化地进行配置。</p> <h3 id="整体流程"><a href="#整体流程" class="header-anchor">#</a> 整体流程</h3> <p>大体分为本地化(接入器)、扫描、解析、转换、生产、校验 6 部分。（DSL）</p> <p><img src="/blog/images/architecture/lowcode10.png" alt="lowcode10"></p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// modules/material-parser/src/index.ts</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">options</span><span class="token operator">:</span> IMaterializeOptions</span><span class="token punctuation">)</span><span class="token operator">:</span> Promise<span class="token operator">&lt;</span>ComponentMeta<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> accesser <span class="token operator">=</span> <span class="token string">'local'</span><span class="token punctuation">,</span> dslType <span class="token punctuation">}</span> <span class="token operator">=</span> options<span class="token punctuation">;</span>

  <span class="token comment">// 接入器：物料接入渠道及配置</span>
  <span class="token keyword">let</span> <span class="token punctuation">{</span> entry <span class="token operator">=</span> <span class="token string">''</span> <span class="token punctuation">}</span> <span class="token operator">=</span> options<span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token literal-property property">internalOptions</span><span class="token operator">:</span> IInternalMaterializeOptions <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token operator">...</span>options<span class="token punctuation">,</span>
    accesser<span class="token punctuation">,</span>
    <span class="token literal-property property">entry</span><span class="token operator">:</span> options<span class="token punctuation">.</span>entry <span class="token operator">||</span> <span class="token string">''</span><span class="token punctuation">,</span>
    <span class="token literal-property property">root</span><span class="token operator">:</span> <span class="token punctuation">(</span>options <span class="token keyword">as</span> IMaterializeLocalOptions<span class="token punctuation">)</span><span class="token operator">?.</span>root <span class="token operator">||</span> <span class="token string">''</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span> <span class="token keyword">as</span> IInternalMaterializeOptions<span class="token punctuation">;</span>

  <span class="token comment">// 本地接入</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>accesser <span class="token operator">===</span> <span class="token string">'local'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> root <span class="token punctuation">}</span> <span class="token operator">=</span> options <span class="token keyword">as</span> IMaterializeLocalOptions<span class="token punctuation">;</span>
    internalOptions<span class="token punctuation">.</span>root <span class="token operator">=</span> root<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>root<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> stats <span class="token operator">=</span> <span class="token function">lstatSync</span><span class="token punctuation">(</span>entry<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>stats<span class="token punctuation">.</span><span class="token function">isDirectory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        internalOptions<span class="token punctuation">.</span>root <span class="token operator">=</span> entry<span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        internalOptions<span class="token punctuation">.</span>root <span class="token operator">=</span> process<span class="token punctuation">.</span><span class="token function">cwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isAbsolute</span><span class="token punctuation">(</span>entry<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      internalOptions<span class="token punctuation">.</span>entry <span class="token operator">=</span> <span class="token function">join</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> entry<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">let</span> workDir <span class="token operator">=</span> internalOptions<span class="token punctuation">.</span>root <span class="token operator">||</span> <span class="token string">''</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> moduleDir <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span>
  <span class="token comment">// 线上接入</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>accesser <span class="token operator">===</span> <span class="token string">'online'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 本地化：创建临时文件，创建组件包</span>
    <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">localize</span><span class="token punctuation">(</span>internalOptions <span class="token keyword">as</span> IMaterializeOnlineOptions<span class="token punctuation">)</span><span class="token punctuation">;</span>
    workDir <span class="token operator">=</span> result<span class="token punctuation">.</span>workDir<span class="token punctuation">;</span>
    moduleDir <span class="token operator">=</span> result<span class="token punctuation">.</span>moduleDir<span class="token punctuation">;</span>
    internalOptions<span class="token punctuation">.</span>entry <span class="token operator">=</span> result<span class="token punctuation">.</span>entry <span class="token operator">?</span> <span class="token function">join</span><span class="token punctuation">(</span>moduleDir<span class="token punctuation">,</span> result<span class="token punctuation">.</span>entry<span class="token punctuation">)</span> <span class="token operator">:</span> moduleDir<span class="token punctuation">;</span>
    internalOptions<span class="token punctuation">.</span>root <span class="token operator">=</span> moduleDir<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 扫描器：根据接入渠道的不同来调度不同的扫描器，得出物料入口文件和层次结构给到解析器</span>
  <span class="token keyword">const</span> scanedModel <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">scan</span><span class="token punctuation">(</span>internalOptions<span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token comment">// 解析器：每种生态（dslType）会分别对应一个解析器，解析 MATERIAL 源码并生成一棵语法树 AST, AST 收取关键信息</span>
  <span class="token keyword">const</span> parsedModel <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">parse</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token operator">...</span>scanedModel<span class="token punctuation">,</span>
    dslType<span class="token punctuation">,</span>
    accesser<span class="token punctuation">,</span>
    <span class="token literal-property property">npmClient</span><span class="token operator">:</span> internalOptions<span class="token punctuation">.</span>npmClient<span class="token punctuation">,</span>
    workDir<span class="token punctuation">,</span>
    moduleDir<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 生成器：不同的渠道不同的生成器，生成引擎产物</span>
  <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">generate</span><span class="token punctuation">(</span>scanedModel<span class="token punctuation">,</span> parsedModel<span class="token punctuation">,</span> internalOptions<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>workDir <span class="token operator">&amp;&amp;</span> accesser <span class="token operator">===</span> <span class="token string">'online'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">await</span> <span class="token function">remove</span><span class="token punctuation">(</span>workDir<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 移除临时文件</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> result<span class="token punctuation">;</span>  <span class="token comment">// json schema</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br></div></div><h3 id="接入器"><a href="#接入器" class="header-anchor">#</a> 接入器</h3> <p>用于定义物料化组件的接入渠道(接入配置项)，接入方式见上文(入料方式)，线上接入渠道需要本地化(localize)。</p> <h3 id="扫描器"><a href="#扫描器" class="header-anchor">#</a> 扫描器</h3> <p>根据接入渠道的不同来调度不同的扫描器，得出物料入口文件和层次结构（文件、目录层次路径）给到解析器</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">scan</span><span class="token punctuation">(</span>
  <span class="token parameter"><span class="token literal-property property">options</span><span class="token operator">:</span> IInternalMaterializeOptions<span class="token punctuation">,</span></span>
<span class="token punctuation">)</span><span class="token operator">:</span> Promise<span class="token operator">&lt;</span>IMaterialScanModel<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// 扫描生成阶段产物</span>
  <span class="token keyword">const</span> <span class="token literal-property property">model</span><span class="token operator">:</span> IMaterialScanModel <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">pkgName</span><span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">,</span>
    <span class="token literal-property property">pkgVersion</span><span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">,</span>
    <span class="token literal-property property">mainFileAbsolutePath</span><span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">,</span>
    <span class="token literal-property property">mainFilePath</span><span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token comment">// ... 省略 model 阶段产物赋值逻辑</span>
  <span class="token keyword">return</span> model<span class="token punctuation">;</span> <span class="token comment">// 得出物料入口文件和层次结构（文件、目录层次路径）给到解析器</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
 * 对应扫描阶段的产物
 */</span>
<span class="token keyword">export</span> <span class="token keyword">interface</span> <span class="token class-name">IMaterialScanModel</span> <span class="token punctuation">{</span>Ï
  <span class="token comment">/** 当前包名 */</span>
  <span class="token literal-property property">pkgName</span><span class="token operator">:</span> string<span class="token punctuation">;</span>
  <span class="token comment">/** 当前包版本 */</span>
  <span class="token literal-property property">pkgVersion</span><span class="token operator">:</span> string<span class="token punctuation">;</span>
  <span class="token comment">/** 在ts场景下，使用entry */</span>
  useEntry<span class="token operator">?</span><span class="token operator">:</span> boolean<span class="token punctuation">;</span>
  <span class="token comment">/** main文件相对路径 */</span>
  <span class="token literal-property property">mainFilePath</span><span class="token operator">:</span> string<span class="token punctuation">;</span>
  <span class="token comment">/** module文件相对路径 */</span>
  moduleFilePath<span class="token operator">?</span><span class="token operator">:</span> string<span class="token punctuation">;</span>
  <span class="token comment">/** typings文件相对路径 */</span>
  typingsFilePath<span class="token operator">?</span><span class="token operator">:</span> string<span class="token punctuation">;</span>
  <span class="token comment">/** main文件绝对路径 */</span>
  <span class="token literal-property property">mainFileAbsolutePath</span><span class="token operator">:</span> string<span class="token punctuation">;</span>
  <span class="token comment">/** module文件绝对路径 */</span>
  moduleFileAbsolutePath<span class="token operator">?</span><span class="token operator">:</span> string<span class="token punctuation">;</span>
  <span class="token comment">/** typings文件绝对路径 */</span>
  typingsFileAbsolutePath<span class="token operator">?</span><span class="token operator">:</span> string<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br></div></div><h3 id="解析器"><a href="#解析器" class="header-anchor">#</a> 解析器</h3> <ul><li>静态解析（parseTS &amp; parseJS ）</li> <li>动态解析（parseDynamic）</li></ul> <h4 id="静态解析-js"><a href="#静态解析-js" class="header-anchor">#</a> 静态解析 - JS</h4> <p>在 JS 情况下，基于 react-docgen 进行扩展，自定义了 resolver 及 handler，前者用于寻找组件定义，后者用于解析 propTypes、defaultProps 等信息，在静态分析时，分为 JS和 TS 两种情况。parseTS 和  parseJS 两种解析器。整体流程图如下：</p> <p><img src="/blog/images/architecture/lowcode11.png" alt="lowcode11"></p> <p>react-docgen 使用 babel 生成语法树，再使用 ast-types 进行遍历去寻找组件节点及其属性类型定义。原本的 react-docgen 只能解析单文件，且不能解析 IIFE、逗号表达式等语法结构 (一般出现在转码后的代码中)。笔者对其进行改造，使之可以递归解析多文件去查找组件定义，且能够解开 IIFE，以及对逗号表达式进行转换，以方便后续的组件解析。另外，还增加了子组件解析的功能，即类似 <code>Button.Group = Group</code> 这种定义。</p> <p>react-docgen 是一个 CLI 和工具箱，可帮助从 React 组件中提取信息并从中生成文档。它使用 ast 类型和 @ babel / parser 将源解析为 AST，并提供处理此 AST 的方法以提取所需的信息。输出/返回值是一个 JSON blob / JavaScript 对象。简单来说就是：它能提取组件的相关信息。</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> reactDocs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'react-docgen'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">parse</span><span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">filePath</span><span class="token operator">:</span> string</span><span class="token punctuation">)</span><span class="token operator">:</span> IMaterialParsedModel<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>filePath<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token comment">// 根据文件路径加载文件 stream Buffer</span>
  <span class="token keyword">const</span> fileContent <span class="token operator">=</span> <span class="token function">loadFile</span><span class="token punctuation">(</span>filePath<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// react-docgen 使用 babel 生成语法树，再使用 ast-types 进行遍历去寻找组件节点及其属性类型定义</span>
  <span class="token comment">// 递归解析多文件去查找组件定义，且能够解开 IIFE，以及对逗号表达式进行转换，以方便后续的组件解析</span>
  <span class="token keyword">const</span> result <span class="token operator">=</span> reactDocs<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>
    fileContent<span class="token punctuation">,</span> <span class="token comment">// source 物料源文件</span>
    <span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">ast</span><span class="token operator">:</span> any</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> <span class="token comment">// resolver 解析器 给定一个 AST 和对解析器的引用，它返回一个（数组）NodePath，它表示组件定义。</span>
      ast<span class="token punctuation">.</span>__path <span class="token operator">=</span> filePath<span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token function">resolver</span><span class="token punctuation">(</span>ast<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// resolver 寻找组件定义</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    handlers<span class="token punctuation">,</span> <span class="token comment">// 提取 ast 部分信息，propTypes、defaultProps 等</span>
    <span class="token punctuation">{</span>
      <span class="token literal-property property">filename</span><span class="token operator">:</span> filePath<span class="token punctuation">,</span> <span class="token comment">// 与当前正在解析的代码关联的文件的绝对路径（如果有的话）。这用于搜索正确的 babel 配置。</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 组件描述信息</span>
  <span class="token keyword">const</span> coms <span class="token operator">=</span> result<span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">res</span><span class="token operator">:</span> any<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token literal-property property">info</span><span class="token operator">:</span> any</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>info <span class="token operator">||</span> <span class="token operator">!</span>info<span class="token punctuation">.</span>props<span class="token punctuation">)</span> <span class="token keyword">return</span> res<span class="token punctuation">;</span>
    <span class="token keyword">const</span> props <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>info<span class="token punctuation">.</span>props<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">acc</span><span class="token operator">:</span> any<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> name</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> <span class="token literal-property property">item</span><span class="token operator">:</span> any <span class="token operator">=</span> <span class="token function">transformItem</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> info<span class="token punctuation">.</span>props<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        acc<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// TODO</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">return</span> acc<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    res<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token literal-property property">componentName</span><span class="token operator">:</span> info<span class="token punctuation">.</span>displayName<span class="token punctuation">,</span>
      props<span class="token punctuation">,</span>
      <span class="token literal-property property">meta</span><span class="token operator">:</span> info<span class="token punctuation">.</span>meta <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> res<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  
  <span class="token keyword">return</span> coms<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 返回以下内容</span>
<span class="token keyword">export</span> <span class="token keyword">interface</span> <span class="token class-name">IMaterialParsedModel</span> <span class="token punctuation">{</span>
  <span class="token comment">// filePath: string;</span>
  <span class="token literal-property property">componentName</span><span class="token operator">:</span> string<span class="token punctuation">;</span>
  props<span class="token operator">?</span><span class="token operator">:</span> PropsSection<span class="token punctuation">[</span><span class="token string">'props'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  meta<span class="token operator">?</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    exportName<span class="token operator">?</span><span class="token operator">:</span> string<span class="token punctuation">;</span>
    subName<span class="token operator">?</span><span class="token operator">:</span> string<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br></div></div><h5 id="静态解析-ts"><a href="#静态解析-ts" class="header-anchor">#</a> 静态解析 - TS</h5> <p>在 TS 情况下，还要再细分为 <strong>TS 源码</strong>和 <strong>TS 编译后的代码</strong>。 TS 源码中，React 组件具有类型签名; TS 编译后的代码中，dts 文件(如有)包含全部的 class /interface/type 类型信息。可以从这些类型信息中获取组件属性描述。</p> <p><img src="/blog/images/architecture/lowcode12.png" alt="lowcode12"></p> <p>react-docgen 内置了 TypeScript 的 babel 插件，所以也<strong>具备解析 interface 的能力，可惜能力有限</strong>，babel 只能解析 TS 代码，但没法做类型检查，类型处理是由 react-docgen 实现的，它对于 extends/implements/utility 的情况处理不好，并且没有类型推断，虽然可以对其功能进行完 善，不过这种情况下，应该借助 TypeScript Compiler 的能力，而非自己造轮子。通过调研，发现市面上有 <strong>typescript-react-docgen</strong> 这个项目。它在底层依赖了 TypeScript，且产出的数据格式 与 react-docgen 一致，所以我们选择基于它进行解析。</p> <p>TypeScript Compiler 会递归解析某个文件中出现及引用的全部类型，当然，前提是已经定义或安装了相应的类型声明。<strong>typescript-react-docgen 会调用 TypeScript Compiler 的 API，获取每个文件输出的类型，判断其是否为 React 组件</strong>。满足下列条件之一的，会被判定为 React 组件:</p> <ul><li><p>获取其函数签名，如果只有一个入参，或者第一个入参名称为 props ，会被判定为函数式组件;</p></li> <li><p>获取其 constructor 方法，如果其返回值包含 props 属性，会被判定为有状态组件。</p></li></ul> <p>然后，<strong>遍历组件的 props 类型，获取每个属性的类型签名字符串</strong>，比如 <code>(a: string) =&gt; void</code>。 typescript-react-docgen 可以克服 react-docgen 解析 TypeScirpt 类型的问题，但是每个类型都以字符串的形式来呈现，不利于后续的解析。所以，笔者对其进行了扩展，<strong>递归解析每一层的属性值。此外，在函数式组件的判定上，笔者做了完善，会看函数的返回值是否为 ReactElement ，若是，才为函数式组件。</strong></p> <p><a href="https://www.yuque.com/xiwen-bxuha/pr/ts-trick" target="_blank" rel="noopener noreferrer">TS抽取组件描述<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h4 id="动态解析"><a href="#动态解析" class="header-anchor">#</a> 动态解析</h4> <p>当一个组件，使用静态解析无法入料时，会使用动态解析。</p> <p><img src="/blog/images/architecture/lowcode13.png" alt="lowcode13"></p> <p>基本思想很简单，require 组件进来，然后读取其组件类上定义的 propTypes 和 defaultProps 属性。这里使用了<strong>parse-prop-types</strong>库，使用它的时候必须在组件之前引用，因为它会先对 prop- types 库进行修改，在每个 PropTypes 透出的函数上挂上类型，比如 string, number 等等，然后再去遍历。<strong>动态解析可以解析出全部的类型信息，因为 PropTypes 有可能引入依赖组件的一些类型定义，这在静态解析中很难做到，或者成本较高，而对于动态解析来说，都由运行时完成了。</strong></p> <p><strong>技术细节</strong>：值得注意的是，<strong>有些 js 文件里还会引入 css 文件</strong>，而且从笔者了解的情况来看，这种情况在集团内部不在少数。这种组件不配合 webpack 使用，肯定会报错，但是<strong>使用 webpack 会明显拖慢速度</strong>，所以笔者采用了 <strong>sandbox</strong> <strong>的方式</strong>，<strong>对 require 进来的类 css 文件进行 mock</strong>。这里，笔者使用了 <strong>vm2</strong>  这个库，它对 node 自带的 vm 进行了封装，可以<strong>劫持文件中的 require 方法</strong>。因为 parse-prop-types 的修改在沙箱中会失效，所以笔者也 mock 了组件中的 prop-types 库。</p> <h3 id="生成器"><a href="#生成器" class="header-anchor">#</a> 生成器</h3> <p>生成引擎产物，主要包括：MANIFEST 配置文件、CONTAINER 装饰文件和最终会被使用到的 MATERIAL 物料。这一阶段存在的业务扩展点是一键上传和可视化配置 MANIFEST，一键上传功能可以根据实际的需求场景将 MATEIRAL 上传到对应的平台，可视化配置则可以根据实际的需求来定制需要让用户可视化地进行配置。</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>
  <span class="token literal-property property">matScanModel</span><span class="token operator">:</span> IMaterialScanModel<span class="token punctuation">,</span> <span class="token comment">// 扫描阶段的产物 包名、入口文件、文件目录与路径</span>
  <span class="token literal-property property">matParsedModels</span><span class="token operator">:</span> IMaterialParsedModel<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// 解析器分析出的一些关键信息 组件名、props、meta</span>
  <span class="token literal-property property">options</span><span class="token operator">:</span> IInternalMaterializeOptions<span class="token punctuation">,</span> <span class="token comment">// 接入器渠道配置</span>
<span class="token punctuation">)</span><span class="token operator">:</span> Promise<span class="token operator">&lt;</span>ComponentMeta<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span> <span class="token comment">// 返回 低代码组件协议的 json schema</span>
  
  <span class="token keyword">const</span> containerList <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> matParsedModel <span class="token keyword">of</span> matParsedModels<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 默认排除掉 defaultExportName 为空的组件</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>matParsedModel<span class="token punctuation">.</span>componentName<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">continue</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 组装 manifest</span>
    <span class="token keyword">const</span> <span class="token literal-property property">manifest</span><span class="token operator">:</span> any <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">genManifest</span><span class="token punctuation">(</span>matScanModel<span class="token punctuation">,</span> matParsedModel<span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>

    containerList<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>manifest<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> containerList<span class="token punctuation">;</span> <span class="token comment">// 低代码组件协议的 json schema  低代码组件开发就是根据协议配置这份 schema 进行物料的流通和编辑器中使用</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><h3 id="转换器"><a href="#转换器" class="header-anchor">#</a> 转换器</h3> <p>计算、适配与转换</p> <h3 id="校验器"><a href="#校验器" class="header-anchor">#</a> 校验器</h3> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">import</span> Ajv <span class="token keyword">from</span> <span class="token string">'ajv'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Json <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'../types/Basic'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> schema <span class="token keyword">from</span> <span class="token string">'./schema.json'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> ajv <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Ajv</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">jsonPointers</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> validate <span class="token operator">=</span> ajv<span class="token punctuation">.</span><span class="token function">compile</span><span class="token punctuation">(</span>schema<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">validateSchema</span><span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">json</span><span class="token operator">:</span> Json</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">validate</span><span class="token punctuation">(</span>json<span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>validate<span class="token punctuation">.</span>errors<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><h2 id="入料解析整体流程"><a href="#入料解析整体流程" class="header-anchor">#</a> 入料解析整体流程</h2> <p><img src="/blog/images/architecture/lowcode14.png" alt="lowcode14"></p> <ul><li>目前的静态分析和动态分析是分离的，当静态分析失败后，才会尝试动态分析，而且动态时拿不到静态的信息，比如注释等。未来应该结合动态和静态分析，出于速度考虑，优先尝试静态分析，失败后，先静态插桩，再动态分析；</li> <li>目前，用户需正确且完整地定义propTypes或者TypeScript类型，否则入料会错误或者不全。未来，应该结合AI技术，根据组件代码，自动推断出组件的属性（当然，这一步应该前置到写代码的阶段）；</li> <li>组件描述，其实不只可以用在低代码搭建，还可以用来生成组件文档、mock数据等，之后需要结合其他上下游插件，发挥更大作用。</li></ul> <p><a href="https://lowcode-engine.cn/site/docs/guide/design/materialParser" target="_blank" rel="noopener noreferrer">入料模块设计<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/blog/architecture/framework/ali-lowcode-engine.html" class="prev">
        Ali-lowcode-engine
      </a></span> <span class="next"><a href="/blog/architecture/framework/choreography-engine.html">
        编排引擎
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----><!----><!----><!----></div></div>
    <script src="/blog/assets/js/app.59e6d68a.js" defer></script><script src="/blog/assets/js/2.dec2e75d.js" defer></script><script src="/blog/assets/js/1.5b9e135c.js" defer></script><script src="/blog/assets/js/31.46150093.js" defer></script><script src="/blog/assets/js/20.badbb211.js" defer></script>
  </body>
</html>
