<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>React 生命周期 | 前端那些事儿</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="icon" href="/blog/logo.png">
    <link rel="manifest" href="/blog/manifest.json">
    <link rel="apple-touch-icon" href="/blog/images/icons/apple-icon-152x152.png">
    <meta name="description" content="我命由我不由天，学习吧少年">
    <meta name="theme-color" content="#3eaf7c">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="msapplication-TileImage" content="/icons/ms-icon-144x144.png">
    <meta name="msapplication-TileColor" content="#000000">
    
    <link rel="preload" href="/blog/assets/css/0.styles.1c8ccece.css" as="style"><link rel="preload" href="/blog/assets/js/app.b881e293.js" as="script"><link rel="preload" href="/blog/assets/js/2.8bf77cff.js" as="script"><link rel="preload" href="/blog/assets/js/128.c2b25c29.js" as="script"><link rel="preload" href="/blog/assets/js/4.ff6074e9.js" as="script"><link rel="prefetch" href="/blog/assets/js/10.60eb60f6.js"><link rel="prefetch" href="/blog/assets/js/100.8b1b4dd3.js"><link rel="prefetch" href="/blog/assets/js/101.942e6cdf.js"><link rel="prefetch" href="/blog/assets/js/102.57f6611a.js"><link rel="prefetch" href="/blog/assets/js/103.2b9933f3.js"><link rel="prefetch" href="/blog/assets/js/104.6a79e745.js"><link rel="prefetch" href="/blog/assets/js/105.e3e45cfb.js"><link rel="prefetch" href="/blog/assets/js/106.1a8038a4.js"><link rel="prefetch" href="/blog/assets/js/107.ed830272.js"><link rel="prefetch" href="/blog/assets/js/108.ef846023.js"><link rel="prefetch" href="/blog/assets/js/109.3179f988.js"><link rel="prefetch" href="/blog/assets/js/11.d834db87.js"><link rel="prefetch" href="/blog/assets/js/110.97a4433d.js"><link rel="prefetch" href="/blog/assets/js/111.2d641269.js"><link rel="prefetch" href="/blog/assets/js/112.d6582988.js"><link rel="prefetch" href="/blog/assets/js/113.c41a6e3d.js"><link rel="prefetch" href="/blog/assets/js/114.208955d1.js"><link rel="prefetch" href="/blog/assets/js/115.a6472cfe.js"><link rel="prefetch" href="/blog/assets/js/116.879225da.js"><link rel="prefetch" href="/blog/assets/js/117.5d889f8a.js"><link rel="prefetch" href="/blog/assets/js/118.ce3e4471.js"><link rel="prefetch" href="/blog/assets/js/119.0b3859a2.js"><link rel="prefetch" href="/blog/assets/js/12.7ab99bd6.js"><link rel="prefetch" href="/blog/assets/js/120.910f53b3.js"><link rel="prefetch" href="/blog/assets/js/121.749407f4.js"><link rel="prefetch" href="/blog/assets/js/122.f23c2e1b.js"><link rel="prefetch" href="/blog/assets/js/123.d33815f6.js"><link rel="prefetch" href="/blog/assets/js/124.1653d219.js"><link rel="prefetch" href="/blog/assets/js/125.4891fdeb.js"><link rel="prefetch" href="/blog/assets/js/126.4ed25c33.js"><link rel="prefetch" href="/blog/assets/js/127.eba05af9.js"><link rel="prefetch" href="/blog/assets/js/129.6589ef9d.js"><link rel="prefetch" href="/blog/assets/js/13.6208da0c.js"><link rel="prefetch" href="/blog/assets/js/130.41333186.js"><link rel="prefetch" href="/blog/assets/js/131.61bfd624.js"><link rel="prefetch" href="/blog/assets/js/132.064cfb25.js"><link rel="prefetch" href="/blog/assets/js/133.5144396e.js"><link rel="prefetch" href="/blog/assets/js/134.9c6d3809.js"><link rel="prefetch" href="/blog/assets/js/135.cfaed57e.js"><link rel="prefetch" href="/blog/assets/js/136.2a9fc774.js"><link rel="prefetch" href="/blog/assets/js/137.e382a85b.js"><link rel="prefetch" href="/blog/assets/js/138.b75230fe.js"><link rel="prefetch" href="/blog/assets/js/139.6b2160f4.js"><link rel="prefetch" href="/blog/assets/js/14.356643b6.js"><link rel="prefetch" href="/blog/assets/js/140.dcd2c8a6.js"><link rel="prefetch" href="/blog/assets/js/141.fde9a423.js"><link rel="prefetch" href="/blog/assets/js/142.a96a6975.js"><link rel="prefetch" href="/blog/assets/js/143.b5fd6ec3.js"><link rel="prefetch" href="/blog/assets/js/144.dfc1b03d.js"><link rel="prefetch" href="/blog/assets/js/145.859c8a33.js"><link rel="prefetch" href="/blog/assets/js/146.24f554dc.js"><link rel="prefetch" href="/blog/assets/js/147.a5e66d4a.js"><link rel="prefetch" href="/blog/assets/js/148.7d2cf987.js"><link rel="prefetch" href="/blog/assets/js/149.d568b65d.js"><link rel="prefetch" href="/blog/assets/js/15.c24dd32b.js"><link rel="prefetch" href="/blog/assets/js/150.01370587.js"><link rel="prefetch" href="/blog/assets/js/151.886fe7d8.js"><link rel="prefetch" href="/blog/assets/js/152.6d575a79.js"><link rel="prefetch" href="/blog/assets/js/153.5719bbf9.js"><link rel="prefetch" href="/blog/assets/js/154.361c6a3a.js"><link rel="prefetch" href="/blog/assets/js/155.0e6c6537.js"><link rel="prefetch" href="/blog/assets/js/156.a76b4c01.js"><link rel="prefetch" href="/blog/assets/js/157.9aa76c2d.js"><link rel="prefetch" href="/blog/assets/js/158.039d5736.js"><link rel="prefetch" href="/blog/assets/js/159.38496fbb.js"><link rel="prefetch" href="/blog/assets/js/16.886e7545.js"><link rel="prefetch" href="/blog/assets/js/160.89115072.js"><link rel="prefetch" href="/blog/assets/js/161.56181429.js"><link rel="prefetch" href="/blog/assets/js/162.95432614.js"><link rel="prefetch" href="/blog/assets/js/163.ceff5990.js"><link rel="prefetch" href="/blog/assets/js/164.c62aaddf.js"><link rel="prefetch" href="/blog/assets/js/165.f0136d78.js"><link rel="prefetch" href="/blog/assets/js/166.34e842a4.js"><link rel="prefetch" href="/blog/assets/js/167.5d5f9059.js"><link rel="prefetch" href="/blog/assets/js/168.cb5b5a80.js"><link rel="prefetch" href="/blog/assets/js/169.c34e0642.js"><link rel="prefetch" href="/blog/assets/js/17.b58638c3.js"><link rel="prefetch" href="/blog/assets/js/170.de22bace.js"><link rel="prefetch" href="/blog/assets/js/171.a65ad400.js"><link rel="prefetch" href="/blog/assets/js/172.9cbd06e1.js"><link rel="prefetch" href="/blog/assets/js/173.6e5b4009.js"><link rel="prefetch" href="/blog/assets/js/174.f6431eee.js"><link rel="prefetch" href="/blog/assets/js/175.22e818d5.js"><link rel="prefetch" href="/blog/assets/js/176.fe1bc764.js"><link rel="prefetch" href="/blog/assets/js/177.3f05664b.js"><link rel="prefetch" href="/blog/assets/js/178.6f0a9742.js"><link rel="prefetch" href="/blog/assets/js/179.a1f0679d.js"><link rel="prefetch" href="/blog/assets/js/18.83455a09.js"><link rel="prefetch" href="/blog/assets/js/19.93e919c1.js"><link rel="prefetch" href="/blog/assets/js/20.3cdc6de7.js"><link rel="prefetch" href="/blog/assets/js/21.fc481414.js"><link rel="prefetch" href="/blog/assets/js/22.88038cd9.js"><link rel="prefetch" href="/blog/assets/js/23.9db2c1db.js"><link rel="prefetch" href="/blog/assets/js/24.37e5929a.js"><link rel="prefetch" href="/blog/assets/js/25.432db672.js"><link rel="prefetch" href="/blog/assets/js/26.bd178ba6.js"><link rel="prefetch" href="/blog/assets/js/27.5860a3dc.js"><link rel="prefetch" href="/blog/assets/js/28.73c1c31f.js"><link rel="prefetch" href="/blog/assets/js/29.5abf7038.js"><link rel="prefetch" href="/blog/assets/js/3.6c93b5c9.js"><link rel="prefetch" href="/blog/assets/js/30.a63ee9e8.js"><link rel="prefetch" href="/blog/assets/js/31.df7baf73.js"><link rel="prefetch" href="/blog/assets/js/32.a5a67cd4.js"><link rel="prefetch" href="/blog/assets/js/33.2990f685.js"><link rel="prefetch" href="/blog/assets/js/34.4fb604c4.js"><link rel="prefetch" href="/blog/assets/js/35.9d87d28b.js"><link rel="prefetch" href="/blog/assets/js/36.df29a522.js"><link rel="prefetch" href="/blog/assets/js/37.7f8fd9d4.js"><link rel="prefetch" href="/blog/assets/js/38.6ee67b16.js"><link rel="prefetch" href="/blog/assets/js/39.b0f32ed4.js"><link rel="prefetch" href="/blog/assets/js/40.ef983ba0.js"><link rel="prefetch" href="/blog/assets/js/41.1e2aaebe.js"><link rel="prefetch" href="/blog/assets/js/42.b28ba172.js"><link rel="prefetch" href="/blog/assets/js/43.c28284f8.js"><link rel="prefetch" href="/blog/assets/js/44.2845e31a.js"><link rel="prefetch" href="/blog/assets/js/45.e2f7ca41.js"><link rel="prefetch" href="/blog/assets/js/46.49cd27ec.js"><link rel="prefetch" href="/blog/assets/js/47.1dabdd28.js"><link rel="prefetch" href="/blog/assets/js/48.929f7e86.js"><link rel="prefetch" href="/blog/assets/js/49.a708357d.js"><link rel="prefetch" href="/blog/assets/js/5.896ce93b.js"><link rel="prefetch" href="/blog/assets/js/50.e98a806d.js"><link rel="prefetch" href="/blog/assets/js/51.437fa024.js"><link rel="prefetch" href="/blog/assets/js/52.2dbc6a92.js"><link rel="prefetch" href="/blog/assets/js/53.07d74c7e.js"><link rel="prefetch" href="/blog/assets/js/54.f3df940c.js"><link rel="prefetch" href="/blog/assets/js/55.0fe44714.js"><link rel="prefetch" href="/blog/assets/js/56.45a7a0cb.js"><link rel="prefetch" href="/blog/assets/js/57.5f5725c4.js"><link rel="prefetch" href="/blog/assets/js/58.21521fdd.js"><link rel="prefetch" href="/blog/assets/js/59.e8edcb36.js"><link rel="prefetch" href="/blog/assets/js/6.539ab69c.js"><link rel="prefetch" href="/blog/assets/js/60.216ec879.js"><link rel="prefetch" href="/blog/assets/js/61.223fcd47.js"><link rel="prefetch" href="/blog/assets/js/62.b48c5779.js"><link rel="prefetch" href="/blog/assets/js/63.b64e6644.js"><link rel="prefetch" href="/blog/assets/js/64.e8495baa.js"><link rel="prefetch" href="/blog/assets/js/65.06576cfe.js"><link rel="prefetch" href="/blog/assets/js/66.75a3e9b0.js"><link rel="prefetch" href="/blog/assets/js/67.3d65460b.js"><link rel="prefetch" href="/blog/assets/js/68.3f9767c6.js"><link rel="prefetch" href="/blog/assets/js/69.8c9df64f.js"><link rel="prefetch" href="/blog/assets/js/7.c55f6e83.js"><link rel="prefetch" href="/blog/assets/js/70.430bb215.js"><link rel="prefetch" href="/blog/assets/js/71.07091f8b.js"><link rel="prefetch" href="/blog/assets/js/72.89a3fa7b.js"><link rel="prefetch" href="/blog/assets/js/73.515089ee.js"><link rel="prefetch" href="/blog/assets/js/74.27f2cde2.js"><link rel="prefetch" href="/blog/assets/js/75.8249acab.js"><link rel="prefetch" href="/blog/assets/js/76.b054bec0.js"><link rel="prefetch" href="/blog/assets/js/77.88757624.js"><link rel="prefetch" href="/blog/assets/js/78.2327cb59.js"><link rel="prefetch" href="/blog/assets/js/79.84c748a1.js"><link rel="prefetch" href="/blog/assets/js/8.60aa9c8a.js"><link rel="prefetch" href="/blog/assets/js/80.a47469a7.js"><link rel="prefetch" href="/blog/assets/js/81.7682badc.js"><link rel="prefetch" href="/blog/assets/js/82.0c01b114.js"><link rel="prefetch" href="/blog/assets/js/83.8811d758.js"><link rel="prefetch" href="/blog/assets/js/84.d1a190ad.js"><link rel="prefetch" href="/blog/assets/js/85.7f2fc13c.js"><link rel="prefetch" href="/blog/assets/js/86.a40d4f54.js"><link rel="prefetch" href="/blog/assets/js/87.fee2dc28.js"><link rel="prefetch" href="/blog/assets/js/88.4c219488.js"><link rel="prefetch" href="/blog/assets/js/89.c6345070.js"><link rel="prefetch" href="/blog/assets/js/9.46c022d3.js"><link rel="prefetch" href="/blog/assets/js/90.f958d74c.js"><link rel="prefetch" href="/blog/assets/js/91.48cc512a.js"><link rel="prefetch" href="/blog/assets/js/92.1fabb1ae.js"><link rel="prefetch" href="/blog/assets/js/93.d9398247.js"><link rel="prefetch" href="/blog/assets/js/94.0e795f9c.js"><link rel="prefetch" href="/blog/assets/js/95.d8ab7a55.js"><link rel="prefetch" href="/blog/assets/js/96.f3ff110e.js"><link rel="prefetch" href="/blog/assets/js/97.9ac9201a.js"><link rel="prefetch" href="/blog/assets/js/98.e3d8888f.js"><link rel="prefetch" href="/blog/assets/js/99.6c1d1660.js">
    <link rel="stylesheet" href="/blog/assets/css/0.styles.1c8ccece.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/blog/" class="home-link router-link-active"><img src="/blog/logo.png" alt="前端那些事儿" class="logo"> <span class="site-name can-hide">前端那些事儿</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/blog/" class="nav-link">
  主页
</a></div><div class="nav-item"><a href="/blog/base/" class="nav-link">
  前端基础
</a></div><div class="nav-item"><a href="/blog/vue/" class="nav-link">
  Vue
</a></div><div class="nav-item"><a href="/blog/react/" class="nav-link router-link-active">
  React
</a></div><div class="nav-item"><a href="/blog/node/" class="nav-link">
  Node
</a></div><div class="nav-item"><a href="/blog/devops/" class="nav-link">
  前端工程化
</a></div><div class="nav-item"><a href="/blog/mobile/" class="nav-link">
  泛客户端
</a></div><div class="nav-item"><a href="/blog/framework/" class="nav-link">
  架构&amp;方案
</a></div><div class="nav-item"><a href="/blog/code/" class="nav-link">
  算法&amp;编程
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="GitHub" class="dropdown-title"><span class="title">GitHub</span> <span class="arrow down"></span></button> <button type="button" aria-label="GitHub" class="mobile-dropdown-title"><span class="title">GitHub</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/jonny-wei" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub地址
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/blog/" class="nav-link">
  主页
</a></div><div class="nav-item"><a href="/blog/base/" class="nav-link">
  前端基础
</a></div><div class="nav-item"><a href="/blog/vue/" class="nav-link">
  Vue
</a></div><div class="nav-item"><a href="/blog/react/" class="nav-link router-link-active">
  React
</a></div><div class="nav-item"><a href="/blog/node/" class="nav-link">
  Node
</a></div><div class="nav-item"><a href="/blog/devops/" class="nav-link">
  前端工程化
</a></div><div class="nav-item"><a href="/blog/mobile/" class="nav-link">
  泛客户端
</a></div><div class="nav-item"><a href="/blog/framework/" class="nav-link">
  架构&amp;方案
</a></div><div class="nav-item"><a href="/blog/code/" class="nav-link">
  算法&amp;编程
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="GitHub" class="dropdown-title"><span class="title">GitHub</span> <span class="arrow down"></span></button> <button type="button" aria-label="GitHub" class="mobile-dropdown-title"><span class="title">GitHub</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/jonny-wei" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub地址
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>React</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/react/" aria-current="page" class="sidebar-link">React JSX</a></li><li><a href="/blog/react/warmup/react-component.html" class="sidebar-link">React 组件及通信</a></li><li><a href="/blog/react/warmup/react-state.html" class="sidebar-link">React State</a></li><li><a href="/blog/react/warmup/react-props.html" class="sidebar-link">React Props</a></li><li><a href="/blog/react/warmup/react-lifecycle.html" aria-current="page" class="active sidebar-link">React 生命周期</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/react/warmup/react-lifecycle.html#类组件生命周期" class="sidebar-link">类组件生命周期</a></li><li class="sidebar-sub-header"><a href="/blog/react/warmup/react-lifecycle.html#react-类组件生命周期执行过程" class="sidebar-link">React 类组件生命周期执行过程</a></li><li class="sidebar-sub-header"><a href="/blog/react/warmup/react-lifecycle.html#各阶段生命周期的功能" class="sidebar-link">各阶段生命周期的功能</a></li><li class="sidebar-sub-header"><a href="/blog/react/warmup/react-lifecycle.html#函数组件生命周期" class="sidebar-link">函数组件生命周期</a></li><li class="sidebar-sub-header"><a href="/blog/react/warmup/react-lifecycle.html#生命周期在函数组件中的替代方案" class="sidebar-link">生命周期在函数组件中的替代方案</a></li><li class="sidebar-sub-header"><a href="/blog/react/warmup/react-lifecycle.html#实现一个-scrollview-组件" class="sidebar-link">实现一个 ScrollView 组件</a></li></ul></li><li><a href="/blog/react/warmup/react-ref.html" class="sidebar-link">React Ref</a></li><li><a href="/blog/react/warmup/react-context.html" class="sidebar-link">React Context</a></li><li><a href="/blog/react/warmup/react-css.html" class="sidebar-link">React 中 CSS 的模块化</a></li><li><a href="/blog/react/warmup/react-hoc.html" class="sidebar-link">React HOC</a></li><li><a href="/blog/react/warmup/react-render.html" class="sidebar-link">React 渲染优化</a></li><li><a href="/blog/react/warmup/react-router.html" class="sidebar-link">React Router</a></li><li><a href="/blog/react/warmup/react-redux.html" class="sidebar-link">React Rudex</a></li><li><a href="/blog/react/warmup/react-mobx.html" class="sidebar-link">React Mobx</a></li><li><a href="/blog/react/warmup/react-keepalive.html" class="sidebar-link">实现 KeepAlive</a></li><li><a href="/blog/react/warmup/react-transition.html" class="sidebar-link">V18 - Transition</a></li><li><a href="/blog/react/warmup/react-suspense.html" class="sidebar-link">V18 - Suspense</a></li><li><a href="/blog/react/warmup/react-useMutableSource.html" class="sidebar-link">V18 - useMutableSource</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>React源码解析</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/react/react/react-version.html" class="sidebar-link">React 不同版本间的区别</a></li><li><a href="/blog/react/react/react-scheduler.html" class="sidebar-link">Scheduler 调度器</a></li><li><a href="/blog/react/react/react-reconciler.html" class="sidebar-link">Reconciler 协调器</a></li><li><a href="/blog/react/react/react-render.html" class="sidebar-link">Render 阶段</a></li><li><a href="/blog/react/react/react-commit.html" class="sidebar-link">Commit 阶段</a></li><li><a href="/blog/react/react/react-priority.html" class="sidebar-link">React 优先级模型</a></li><li><a href="/blog/react/react/react-fiber.html" class="sidebar-link">React Fiber</a></li><li><a href="/blog/react/react/react-diff.html" class="sidebar-link">React Diff 算法</a></li><li><a href="/blog/react/react/react-hooks.html" class="sidebar-link">React Hooks 理解</a></li><li><a href="/blog/react/react/react-lifecycle.html" class="sidebar-link">React 生命周期</a></li><li><a href="/blog/react/react/react-context.html" class="sidebar-link">React Context 原理</a></li><li><a href="/blog/react/react/react-event.html" class="sidebar-link">React 事件系统</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="react-生命周期"><a href="#react-生命周期" class="header-anchor">#</a> React 生命周期</h1> <p>React 类组件为开发者提供了一些生命周期钩子函数，能让开发者在 React 执行的重要阶段，在钩子函数里做一些该做的事。自从 React Hooks 问世以来，函数组件也能优雅地使用 Hooks ，弥补函数组件没有生命周期的缺陷。</p> <h2 id="类组件生命周期"><a href="#类组件生命周期" class="header-anchor">#</a> 类组件生命周期</h2> <p>React 两个重要阶段，render 阶段和 commit 阶段，React 在调和( render )阶段会深度遍历 React fiber 树，目的就是发现不同( diff )，不同的地方就是接下来需要更新的地方，对于变化的组件，就会执行 render 函数。在一次调和过程完毕之后，就到了commit 阶段，commit 阶段会创建修改真实的 DOM 节点。</p> <p>如果在一次调和的过程中，发现了一个 fiber tag = 1 类组件的情况，就会按照类组件的逻辑来处理。对于类组件的处理逻辑，首先判断类组件是否已经被创建过</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// react-reconciler/src/ReactFiberBeginWork.js</span>
<span class="token comment">/* workloop React 处理类组件的主要功能方法 */</span>
<span class="token keyword">function</span> <span class="token function">updateClassComponent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">let</span> shouldUpdate
    <span class="token keyword">const</span> instance <span class="token operator">=</span> workInProgress<span class="token punctuation">.</span>stateNode <span class="token comment">// stateNode 是 fiber 指向 类组件实例的指针。</span>
     <span class="token keyword">if</span> <span class="token punctuation">(</span>instance <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// instance 为组件实例,如果组件实例不存在，证明该类组件没有被挂载过，那么会走初始化流程</span>
        <span class="token function">constructClassInstance</span><span class="token punctuation">(</span>workInProgress<span class="token punctuation">,</span> Component<span class="token punctuation">,</span> nextProps<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 组件实例将在这个方法中被new。</span>
        <span class="token function">mountClassInstance</span><span class="token punctuation">(</span>  workInProgress<span class="token punctuation">,</span>Component<span class="token punctuation">,</span> nextProps<span class="token punctuation">,</span>renderExpirationTime <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//初始化挂载组件流程</span>
        shouldUpdate <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span> <span class="token comment">// shouldUpdate 标识用来证明 组件是否需要更新。</span>
     <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>  
        shouldUpdate <span class="token operator">=</span> <span class="token function">updateClassInstance</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> workInProgress<span class="token punctuation">,</span> Component<span class="token punctuation">,</span> nextProps<span class="token punctuation">,</span> renderExpirationTime<span class="token punctuation">)</span> <span class="token comment">// 更新组件流程</span>
     <span class="token punctuation">}</span>
     <span class="token keyword">if</span><span class="token punctuation">(</span>shouldUpdate<span class="token punctuation">)</span><span class="token punctuation">{</span>
         nextChildren <span class="token operator">=</span> instance<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">/* 执行render函数 ，得到子节点 */</span>
        <span class="token function">reconcileChildren</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span>workInProgress<span class="token punctuation">,</span>nextChildren<span class="token punctuation">,</span>renderExpirationTime<span class="token punctuation">)</span> <span class="token comment">/* 继续调和子节点 */</span>
     <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p>几个重要概念：</p> <ol><li>instance 类组件对应实例。</li> <li>workInProgress 树，当前正在调和的 fiber 树 ，一次更新中，React 会自上而下深度遍历子代 fiber ，如果遍历到一个 fiber ，会把当前 fiber 指向 workInProgress。</li> <li>current 树，在初始化更新中，current = null ，在第一次 fiber 调和之后，会将 workInProgress 树赋值给 current 树。React 来用 workInProgress 和 current 来确保一次更新中，快速构建，并且状态不丢失。</li> <li>Component 就是项目中的 class 组件。</li> <li>nextProps 作为组件在一次更新中新的 props 。</li> <li>renderExpirationTime 作为下一次渲染的过期时间。</li></ol> <p>在组件实例上可以通过 _reactInternals 属性来访问组件对应的 fiber 对象。在 fiber 对象上，可以通过 stateNode 来访问当前 fiber 对应的组件实例。</p> <h2 id="react-类组件生命周期执行过程"><a href="#react-类组件生命周期执行过程" class="header-anchor">#</a> React 类组件生命周期执行过程</h2> <p>React 的大部分生命周期的执行，都在 mountClassInstance 和updateClassInstance 这两个方法中执行，把流程简化成 mount (初始化渲染) 和 update (更新)两个方向。从组件初始化，组件更新 ， 组件销毁 ，三大阶段分析。</p> <h3 id="初始化阶段"><a href="#初始化阶段" class="header-anchor">#</a> 初始化阶段</h3> <h4 id="constructor-执行"><a href="#constructor-执行" class="header-anchor">#</a> constructor 执行</h4> <p>在 mount 阶段，首先执行的 constructClassInstance 函数，用来实例化 React 组件，组件中 constructor 就是在这里执行的。在实例化组件之后，会调用 mountClassInstance 组件初始化。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">mountClassInstance</span><span class="token punctuation">(</span><span class="token parameter">workInProgress<span class="token punctuation">,</span>ctor<span class="token punctuation">,</span>newProps<span class="token punctuation">,</span>renderExpirationTime</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">const</span> instance <span class="token operator">=</span> workInProgress<span class="token punctuation">.</span>stateNode<span class="token punctuation">;</span>
     <span class="token keyword">const</span> getDerivedStateFromProps <span class="token operator">=</span> ctor<span class="token punctuation">.</span>getDerivedStateFromProps<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> getDerivedStateFromProps <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">/* ctor 就是我们写的类组件，获取类组件的静态方法 */</span>
     <span class="token keyword">const</span> partialState <span class="token operator">=</span> <span class="token function">getDerivedStateFromProps</span><span class="token punctuation">(</span>nextProps<span class="token punctuation">,</span> prevState<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">/* 这个时候执行 getDerivedStateFromProps 生命周期 ，得到将合并的state */</span>
     <span class="token keyword">const</span> memoizedState <span class="token operator">=</span> partialState <span class="token operator">===</span> <span class="token keyword">null</span> <span class="token operator">||</span> partialState <span class="token operator">===</span> <span class="token keyword">undefined</span> <span class="token operator">?</span> prevState <span class="token operator">:</span> Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> prevState<span class="token punctuation">,</span> partialState<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 合并state</span>
     workInProgress<span class="token punctuation">.</span>memoizedState <span class="token operator">=</span> memoizedState<span class="token punctuation">;</span>
     instance<span class="token punctuation">.</span>state <span class="token operator">=</span> workInProgress<span class="token punctuation">.</span>memoizedState<span class="token punctuation">;</span> <span class="token comment">/* 将state 赋值给我们实例上，instance.state  就是我们在组件中 this.state获取的state*/</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">typeof</span> ctor<span class="token punctuation">.</span>getDerivedStateFromProps <span class="token operator">!==</span> <span class="token string">'function'</span> <span class="token operator">&amp;&amp;</span>   <span class="token keyword">typeof</span> instance<span class="token punctuation">.</span>getSnapshotBeforeUpdate <span class="token operator">!==</span> <span class="token string">'function'</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> instance<span class="token punctuation">.</span>componentWillMount <span class="token operator">===</span> <span class="token string">'function'</span> <span class="token punctuation">)</span><span class="token punctuation">{</span>
      instance<span class="token punctuation">.</span><span class="token function">componentWillMount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">/* 当 getDerivedStateFromProps 和 getSnapshotBeforeUpdate 不存在的时候 ，执行 componentWillMount*/</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><h4 id="getderivedstatefromprops-执行"><a href="#getderivedstatefromprops-执行" class="header-anchor">#</a> getDerivedStateFromProps 执行</h4> <p>在初始化阶段，getDerivedStateFromProps 是第二个执行的生命周期，值得注意的是它是从 ctor 类上直接绑定的静态方法，传入 props ，state 。 返回值将和之前的 state 合并，作为新的 state ，传递给组件实例使用。</p> <h4 id="componentwillmount-执行"><a href="#componentwillmount-执行" class="header-anchor">#</a> componentWillMount 执行</h4> <p>如果存在 getDerivedStateFromProps 和 getSnapshotBeforeUpdate 就不会执行生命周期componentWillMount。</p> <h4 id="render-函数执行"><a href="#render-函数执行" class="header-anchor">#</a> render 函数执行</h4> <p>到此为止 mountClassInstancec 函数完成，但是上面 updateClassComponent 函数， 在执行完 mountClassInstancec 后，执行了 render 渲染函数，形成了 children ， 接下来 React 调用 reconcileChildren 方法深度调和 children 。</p> <h4 id="componentdidmount执行"><a href="#componentdidmount执行" class="header-anchor">#</a> componentDidMount执行</h4> <p>细心的同学可能发现，生命周期 componentDidMount 还没有出现，那么 componentDidMount 是如何执行的呢？上文中简单介绍了 render 和 commit 两个阶段，上述提及的几生命周期都是在 render 阶段执行的。一旦 React 调和完所有的 fiber 节点，就会到 commit 阶段，在组件初始化 commit 阶段，会调用 componentDidMount 生命周期。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// react-reconciler/src/ReactFiberCommitWork.js</span>
<span class="token keyword">function</span> <span class="token function">commitLifeCycles</span><span class="token punctuation">(</span><span class="token parameter">finishedRoot<span class="token punctuation">,</span>current<span class="token punctuation">,</span>finishedWork</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
     <span class="token keyword">switch</span> <span class="token punctuation">(</span>finishedWork<span class="token punctuation">.</span>tag<span class="token punctuation">)</span><span class="token punctuation">{</span>                             <span class="token comment">/* fiber tag 在第一节讲了不同fiber类型 */</span>
        <span class="token keyword">case</span> ClassComponent<span class="token operator">:</span> <span class="token punctuation">{</span>                              <span class="token comment">/* 如果是 类组件 类型 */</span>
             <span class="token keyword">const</span> instance <span class="token operator">=</span> finishedWork<span class="token punctuation">.</span>stateNode        <span class="token comment">/* 类实例 */</span>
             <span class="token keyword">if</span><span class="token punctuation">(</span>current <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>                          <span class="token comment">/* 类组件第一次调和渲染 */</span>
                instance<span class="token punctuation">.</span><span class="token function">componentDidMount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
             <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>                                         <span class="token comment">/* 类组件更新 */</span>
                instance<span class="token punctuation">.</span><span class="token function">componentDidUpdate</span><span class="token punctuation">(</span>prevProps<span class="token punctuation">,</span>prevState，instance<span class="token punctuation">.</span>__reactInternalSnapshotBeforeUpdate<span class="token punctuation">)</span><span class="token punctuation">;</span> 
             <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
     <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>从上面可以直观看到 componentDidMount 执行时机 和 componentDidUpdate 执行时机是相同的 ，只不过一个是针对初始化，一个是针对组件再更新。到此初始化阶段，生命周期执行完毕。</p> <p>执行顺序：<code>constructor -&gt; getDerivedStateFromProps / componentWillMount -&gt; render -&gt; componentDidMount</code></p> <p><img src="/blog/images/react/%E7%B1%BB%E7%BB%84%E4%BB%B6%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E8%BF%87%E7%A8%8B.png" alt="类组件生命周期过程"></p> <h3 id="更新阶段"><a href="#更新阶段" class="header-anchor">#</a> 更新阶段</h3> <p>类组件的更新阶段，到底会执行那些生命周期函数呢，回到了最开始 updateClassComponent 函数了，当发现 current 不为 null 的情况时，说明该类组件被挂载过，那么直接按照更新逻辑来处理。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// react-reconciler/src/ReactFiberClassComponent.js</span>
<span class="token keyword">function</span> <span class="token function">updateClassInstance</span><span class="token punctuation">(</span><span class="token parameter">current<span class="token punctuation">,</span>workInProgress<span class="token punctuation">,</span>ctor<span class="token punctuation">,</span>newProps<span class="token punctuation">,</span>renderExpirationTime</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">const</span> instance <span class="token operator">=</span> workInProgress<span class="token punctuation">.</span>stateNode<span class="token punctuation">;</span> <span class="token comment">// 类组件实例</span>
    <span class="token keyword">const</span> hasNewLifecycles <span class="token operator">=</span>  <span class="token keyword">typeof</span> ctor<span class="token punctuation">.</span>getDerivedStateFromProps <span class="token operator">===</span> <span class="token string">'function'</span>  <span class="token comment">// 判断是否具有 getDerivedStateFromProps 生命周期</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>hasNewLifecycles <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> instance<span class="token punctuation">.</span>componentWillReceiveProps <span class="token operator">===</span> <span class="token string">'function'</span> <span class="token punctuation">)</span><span class="token punctuation">{</span>
         <span class="token keyword">if</span> <span class="token punctuation">(</span>oldProps <span class="token operator">!==</span> newProps <span class="token operator">||</span> oldContext <span class="token operator">!==</span> nextContext<span class="token punctuation">)</span> <span class="token punctuation">{</span>     <span class="token comment">// 浅比较 props 不相等</span>
            instance<span class="token punctuation">.</span><span class="token function">componentWillReceiveProps</span><span class="token punctuation">(</span>newProps<span class="token punctuation">,</span> nextContext<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 执行生命周期 componentWillReceiveProps </span>
         <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">let</span> newState <span class="token operator">=</span> <span class="token punctuation">(</span>instance<span class="token punctuation">.</span>state <span class="token operator">=</span> oldState<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> getDerivedStateFromProps <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        ctor<span class="token punctuation">.</span><span class="token function">getDerivedStateFromProps</span><span class="token punctuation">(</span>nextProps<span class="token punctuation">,</span>prevState<span class="token punctuation">)</span>  <span class="token comment">/* 执行生命周期getDerivedStateFromProps  ，逻辑和mounted类似 ，合并state  */</span>
        newState <span class="token operator">=</span> workInProgress<span class="token punctuation">.</span>memoizedState<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>   
    <span class="token keyword">let</span> shouldUpdate <span class="token operator">=</span> <span class="token boolean">true</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">typeof</span> instance<span class="token punctuation">.</span>shouldComponentUpdate <span class="token operator">===</span> <span class="token string">'function'</span> <span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token comment">/* 执行生命周期 shouldComponentUpdate 返回值决定是否执行render ，调和子节点 */</span>
        shouldUpdate <span class="token operator">=</span> instance<span class="token punctuation">.</span><span class="token function">shouldComponentUpdate</span><span class="token punctuation">(</span>newProps<span class="token punctuation">,</span>newState<span class="token punctuation">,</span>nextContext<span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>shouldUpdate<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> instance<span class="token punctuation">.</span>componentWillUpdate <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            instance<span class="token punctuation">.</span><span class="token function">componentWillUpdate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">/* 执行生命周期 componentWillUpdate  */</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> shouldUpdate
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><h4 id="执行生命周期-componentwillreceiveprops"><a href="#执行生命周期-componentwillreceiveprops" class="header-anchor">#</a> 执行生命周期 componentWillReceiveProps</h4> <p>首先判断 getDerivedStateFromProps 生命周期是否存在，如果不存在就执行componentWillReceiveProps生命周期。传入该生命周期两个参数，分别是 newProps 和 nextContext 。</p> <h4 id="执行生命周期-getderivedstatefromprops"><a href="#执行生命周期-getderivedstatefromprops" class="header-anchor">#</a> 执行生命周期 getDerivedStateFromProps</h4> <p>接下来执行生命周期getDerivedStateFromProps， 返回的值用于合并state，生成新的state。</p> <h4 id="执行生命周期-shouldcomponentupdate"><a href="#执行生命周期-shouldcomponentupdate" class="header-anchor">#</a> 执行生命周期 shouldComponentUpdate</h4> <p>接下来执行生命周期shouldComponentUpdate，传入新的 props ，新的 state ，和新的 context ，返回值决定是否继续执行 render 函数，调和子节点。这里应该注意一个问题，getDerivedStateFromProps 的返回值可以作为新的 state ，传递给 shouldComponentUpdate 。</p> <h4 id="执行生命周期-componentwillupdate"><a href="#执行生命周期-componentwillupdate" class="header-anchor">#</a> 执行生命周期 componentWillUpdate</h4> <p>接下来执行生命周期 componentWillUpdate。updateClassInstance 方法到此执行完毕了。</p> <h4 id="执行-render-函数"><a href="#执行-render-函数" class="header-anchor">#</a> 执行 render 函数</h4> <p>接下来会执行 render 函数，得到最新的 React element 元素。然后继续调和子节点。</p> <h4 id="执行-getsnapshotbeforeupdate"><a href="#执行-getsnapshotbeforeupdate" class="header-anchor">#</a> 执行 getSnapshotBeforeUpdate</h4> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">commitBeforeMutationLifeCycles</span><span class="token punctuation">(</span><span class="token parameter">current<span class="token punctuation">,</span>finishedWork</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
     <span class="token keyword">switch</span> <span class="token punctuation">(</span>finishedWork<span class="token punctuation">.</span>tag<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">case</span> ClassComponent<span class="token operator">:</span><span class="token punctuation">{</span>
               <span class="token keyword">const</span> snapshot <span class="token operator">=</span> instance<span class="token punctuation">.</span><span class="token function">getSnapshotBeforeUpdate</span><span class="token punctuation">(</span>prevProps<span class="token punctuation">,</span>prevState<span class="token punctuation">)</span> <span class="token comment">/* 执行生命周期 getSnapshotBeforeUpdate   */</span>
                instance<span class="token punctuation">.</span>__reactInternalSnapshotBeforeUpdate <span class="token operator">=</span> snapshot<span class="token punctuation">;</span> <span class="token comment">/* 返回值将作为 __reactInternalSnapshotBeforeUpdate 传递给 componentDidUpdate 生命周期  */</span>
          <span class="token punctuation">}</span>
     <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p><code>getSnapshotBeforeUpdate</code> 的执行也是在 commit 阶段，commit 阶段细分为 <code>before Mutation</code>( DOM 修改前)，Mutation ( DOM 修改)，Layout( DOM 修改后) 三个阶段，<code>getSnapshotBeforeUpdate</code>发生在 <code>before Mutation</code> 阶段，生命周期的返回值，将作为第三个参数 <code>__reactInternalSnapshotBeforeUpdate</code> 传递给 <code>componentDidUpdate</code> 。</p> <h4 id="执行-componentdidupdate"><a href="#执行-componentdidupdate" class="header-anchor">#</a> 执行 componentDidUpdate</h4> <p>接下来执行生命周期 componentDidUpdate ，此时 DOM 已经修改完成。可以操作修改之后的 DOM 。到此为止更新阶段的生命周期执行完毕。</p> <p><img src="/blog/images/react/%E7%B1%BB%E7%BB%84%E4%BB%B6%E6%9B%B4%E6%96%B0%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F.png" alt="类组件更新生命周期"></p> <p>更新阶段对应的生命周期的执行顺序：</p> <p><code>componentWillReceiveProps( props 改变) / getDerivedStateFromProp -&gt; shouldComponentUpdate -&gt; componentWillUpdate -&gt; render -&gt; getSnapshotBeforeUpdate -&gt; componentDidUpdate</code></p> <h3 id="销毁阶段"><a href="#销毁阶段" class="header-anchor">#</a> 销毁阶段</h3> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">callComponentWillUnmountWithTimer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    instance<span class="token punctuation">.</span><span class="token function">componentWillUnmount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h4 id="执行生命周期-componentwillunmount"><a href="#执行生命周期-componentwillunmount" class="header-anchor">#</a> 执行生命周期 componentWillUnmount</h4> <p>销毁阶段就比较简单了，在一次调和更新中，如果发现元素被移除，就会打对应的 Deletion 标签 ，然后在 commit 阶段就会调用 componentWillUnmount 生命周期，接下来统一卸载组件以及 DOM 元素。</p> <h3 id="类组件生命周期总览"><a href="#类组件生命周期总览" class="header-anchor">#</a> 类组件生命周期总览</h3> <p><img src="/blog/images/react/%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E6%80%BB%E8%A7%88.png" alt="生命周期总览"></p> <h2 id="各阶段生命周期的功能"><a href="#各阶段生命周期的功能" class="header-anchor">#</a> 各阶段生命周期的功能</h2> <p>上面介绍了 React 各生命周期的执行时机和执行顺序。下面介绍一下各个 lifecycle 能做些什么？</p> <h3 id="constructor"><a href="#constructor" class="header-anchor">#</a> constructor</h3> <p>React 在不同时期抛出不同的生命周期钩子，也就意味这这些生命周期钩子的使命。上面讲过 constructor 在类组件创建实例时调用，而且初始化的时候执行一次，所以可以在 constructor 做一些初始化的工作。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span>        <span class="token comment">// 执行 super ，别忘了传递props,才能在接下来的上下文中，获取到props。</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token operator">=</span><span class="token punctuation">{</span>       <span class="token comment">//① 可以用来初始化state，比如可以用来获取路由中的</span>
        name<span class="token operator">:</span><span class="token string">'alien'</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>handleClick <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">handleClick</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token comment">/* ② 绑定 this */</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>handleInputChange <span class="token operator">=</span> <span class="token function">debounce</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>handleInputChange <span class="token punctuation">,</span> <span class="token number">500</span><span class="token punctuation">)</span> <span class="token comment">/* ③ 绑定防抖函数，防抖 500 毫秒 */</span>
    <span class="token keyword">const</span> _render <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>render
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function-variable function">render</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">_render</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>  <span class="token comment">/* ④ 劫持修改类组件上的一些生命周期 */</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">/* 点击事件 */</span>
<span class="token function">handleClick</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token comment">/* ... */</span> <span class="token punctuation">}</span>
<span class="token comment">/* 表单输入 */</span>
<span class="token function">handleInputChange</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token comment">/* ... */</span> <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>constructor 作用：</p> <ul><li>初始化 state ，比如可以用来截取路由中的参数，赋值给 state 。</li> <li>对类组件的事件做一些处理，比如绑定 this ， 节流，防抖等。</li> <li>对类组件进行一些必要生命周期的劫持，渲染劫持，这个功能更适合反向继承的HOC ，在 HOC 环节，会详细讲解反向继承这种模式。</li></ul> <h3 id="getderivedstatefromprops"><a href="#getderivedstatefromprops" class="header-anchor">#</a> getDerivedStateFromProps</h3> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token function">getDerivedStateFromProps</span><span class="token punctuation">(</span>nextProps<span class="token punctuation">,</span>prevState<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>两个参数：</p> <ul><li>nextProps 父组件新传递的 props ;</li> <li>prevState 传入 getDerivedStateFromProps 待合并的 state 。</li></ul> <p>getDerivedStateFromProps 方法作为类的静态属性方法执行，内部是访问不到 this 的，它更趋向于纯函数，从源码中就能够体会到 React 对该生命周期定义为取缔 componentWillMount 和 componentWillReceiveProps 。</p> <p>这个生命周期用于，在初始化和更新阶段，接受父组件的 props 数据， 可以对 props 进行格式化，过滤等操作，返回值将作为新的 state 合并到 state 中，供给视图渲染层消费。</p> <p>从源码中可以看到，只要组件更新，就会执行 getDerivedStateFromProps，不管是 props 改变，还是 setState ，或是 forceUpdate 。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">static</span> <span class="token function">getDerivedStateFromProps</span><span class="token punctuation">(</span><span class="token parameter">newProps</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> type <span class="token punctuation">}</span> <span class="token operator">=</span> newProps
    <span class="token keyword">switch</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">case</span> <span class="token string">'fruit'</span> <span class="token operator">:</span> 
        <span class="token keyword">return</span> <span class="token punctuation">{</span> list<span class="token operator">:</span><span class="token punctuation">[</span><span class="token string">'苹果'</span><span class="token punctuation">,</span><span class="token string">'香蕉'</span><span class="token punctuation">,</span><span class="token string">'葡萄'</span> <span class="token punctuation">]</span> <span class="token punctuation">}</span> <span class="token comment">/* ① 接受 props 变化 ， 返回值将作为新的 state ，用于 渲染 或 传递给s houldComponentUpdate */</span>
        <span class="token keyword">case</span> <span class="token string">'vegetables'</span><span class="token operator">:</span>
        <span class="token keyword">return</span> <span class="token punctuation">{</span> list<span class="token operator">:</span><span class="token punctuation">[</span><span class="token string">'菠菜'</span><span class="token punctuation">,</span><span class="token string">'西红柿'</span><span class="token punctuation">,</span><span class="token string">'土豆'</span><span class="token punctuation">]</span><span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token operator">&lt;</span>div<span class="token operator">&gt;</span><span class="token punctuation">{</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>list<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token operator">&lt;</span>li key<span class="token operator">=</span><span class="token punctuation">{</span>item<span class="token punctuation">}</span> <span class="token operator">&gt;</span><span class="token punctuation">{</span> item  <span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>li<span class="token operator">&gt;</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>getDerivedStateFromProps 作用：</p> <ul><li>代替 componentWillMount 和 componentWillReceiveProps</li> <li>组件初始化或者更新时，将 props 映射到 state。</li> <li>返回值与 state 合并完，可以作为 shouldComponentUpdate 第二个参数 newState ，可以判断是否渲染组件。(请不要把 getDerivedStateFromProps 和 shouldComponentUpdate 强行关联到一起，两者没有必然联系)</li></ul> <h3 id="componentwillmount-和-unsafe-componentwillmount"><a href="#componentwillmount-和-unsafe-componentwillmount" class="header-anchor">#</a> componentWillMount 和 UNSAFE_componentWillMount</h3> <p>在 React V16.3 componentWillMount ，componentWillReceiveProps ， componentWillUpdate 三个生命周期加上了不安全的标识符 UNSAFE，变成了如下形式，在目前最新的版本React V17.0.2 也没有废弃这三个生命周期。可能不久之后更高级的版本会被废除吧，首先先来看一下为什么要加UNSAFE，首先根据源码，大家有没有发现一个问题，就是这三个生命周期，都是在 render 之前执行的，React 对于执行 render 函数有着像 shouldUpdate 等条件制约，但是对于执行在 render 之前生命周期没有限制，存在一定隐匿风险，如果 updateClassInstance 执行多次，React 开发者滥用这几个生命周期，可能导致生命周期内的上下文多次被执行。</p> <ul><li>UNSAFE_componentWillMount</li> <li>UNSAFE_componentWillReceiveProps</li> <li>UNSAFE_componentWillUpdate</li></ul> <p>UNSAFE_componentWillMount 的作用还是做一些初始化操作，但是不建议在这个生命周期写，毕竟未来 React 可能完全取缔它。</p> <h3 id="omponentwillreceiveprops-和-unsafe-componentwillreceiveprops"><a href="#omponentwillreceiveprops-和-unsafe-componentwillreceiveprops" class="header-anchor">#</a> omponentWillReceiveProps 和 UNSAFE_componentWillReceiveProps</h3> <p>UNSAFE_componentWillReceiveProps 函数的执行是在更新组件阶段，该生命周期执行驱动是因为父组件更新带来的 props 修改，但是只要父组件触发 render 函数，调用 React.createElement 方法，那么 props 就会被重新创建，生命周期 componentWillReceiveProps 就会执行了。这就解释了即使 props 没变，该生命周期也会执行。</p> <p>componentWillReceiveProps 可以用来干什么</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token function">UNSAFE_componentWillReceiveProps</span><span class="token punctuation">(</span><span class="token parameter">newProps</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">const</span> <span class="token punctuation">{</span> type <span class="token punctuation">}</span> <span class="token operator">=</span> newProps
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'父组件render执行'</span><span class="token punctuation">)</span> <span class="token comment">/*  ① 监听父组件执行render  */</span>
        <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>  <span class="token comment">/* ② 异步控制props改变，派生出来的 state 的修改  */</span>
            <span class="token keyword">switch</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token keyword">case</span> <span class="token string">'fruit'</span> <span class="token operator">:</span> 
                <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span>list<span class="token operator">:</span><span class="token punctuation">[</span><span class="token string">'苹果'</span><span class="token punctuation">,</span><span class="token string">'香蕉'</span><span class="token punctuation">,</span><span class="token string">'葡萄'</span> <span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">)</span> 
                <span class="token keyword">break</span>
                <span class="token keyword">case</span> <span class="token string">'vegetables'</span><span class="token operator">:</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span>list<span class="token operator">:</span><span class="token punctuation">[</span><span class="token string">'苹果'</span><span class="token punctuation">,</span><span class="token string">'香蕉'</span><span class="token punctuation">,</span><span class="token string">'葡萄'</span> <span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">)</span> 
                <span class="token keyword">break</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><ul><li>componentWillReceiveProps 可以用来监听父组件是否执行 render 。</li> <li>componentWillReceiveProps 可以用来接受 props 改变，组件可以根据 props 改变，来决定是否更新 state ，因为可以访问到 this ， 所以可以在异步成功回调(接口请求数据)改变 state 。这个是 getDerivedStateFromProps 不能实现的。</li></ul> <p>不建议用这种方式，props 改变，再触发 componentWillReceiveProps 异步请求数据渲染，这样首先在没做优化前提下会带来两次子组件的更新，第一次 props 改变，第二次 props 改变，异步改变state 。其次该生命周期的不安全性。再者需要在该生命周期内部，设置大量的条件判断语句，通过 this.props ， nextProps 判断 props 到底改变与否。所以完全可以换一种思路，那就是状态提升，把数据层完全托管父组件，子组件没有副作用，只负责渲染父组件传递的 props 即可。</p> <p>当 props 不变的前提下， PureComponent 组件能否阻止 componentWillReceiveProps 执行？</p> <p>答案是否定的，componentWillReceiveProps 生命周期的执行，和纯组件没有关系，纯组件是在 componentWillReceiveProps 执行之后浅比较 props 是否发生变化。所以 PureComponent 下不会阻止该生命周期的执行。</p> <h3 id="componentwillupdate-和-unsafe-componentwillupdate"><a href="#componentwillupdate-和-unsafe-componentwillupdate" class="header-anchor">#</a> componentWillUpdate 和 UNSAFE_componentWillUpdate</h3> <p>UNSAFE_componentWillUpdate 可以意味着在更新之前，此时的 DOM 还没有更新。在这里可以做一些获取 DOM 的操作。就比如说在一次更新中，保存 DOM 之前的信息(记录上一次位置)。但是 React 已经出了新的生命周期 getSnapshotBeforeUpdate 来代替 UNSAFE_componentWillUpdate。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token function">UNSAFE_componentWillUpdate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">const</span> position <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getPostion</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>node<span class="token punctuation">)</span> <span class="token comment">/* 获取元素节点 node 位置 */</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>作用：获取组件更新之前的状态。比如 DOM 元素位置等。</p> <h3 id="render"><a href="#render" class="header-anchor">#</a> render</h3> <p>所谓 render 函数，就是 jsx 的各个元素被 React.createElement 创建成 React element 对象的形式。一次 render 的过程，就是创建 React.element 元素的过程。那么可以在 render 里面做一些,createElement创建元素 , cloneElement 克隆元素 ，React.children 遍历 children 的操作。</p> <h3 id="getsnapshotbeforeupdate"><a href="#getsnapshotbeforeupdate" class="header-anchor">#</a> getSnapshotBeforeUpdate</h3> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token function">getSnapshotBeforeUpdate</span><span class="token punctuation">(</span><span class="token parameter">prevProps<span class="token punctuation">,</span>preState</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><ul><li>prevProps更新前的props</li> <li>prevState更新前的state</li> <li></li></ul> <p>获取更新前 DOM 的状态。该生命周期是在 commit 阶段的before Mutation ( DOM 修改前)，此时 DOM 还没有更新，但是在接下来的 Mutation 阶段会被替换成真实 DOM 。此时是获取 DOM 信息的最佳时期，getSnapshotBeforeUpdate 将返回一个值作为一个snapShot(快照)，传递给 componentDidUpdate作为第三个参数。</p> <p>getSnapshotBeforeUpdate 这个生命周期意义就是配合componentDidUpdate 一起使用，计算形成一个 snapShot 传递给 componentDidUpdate 。保存一次更新前的信息。</p> <h3 id="componentdidupdate"><a href="#componentdidupdate" class="header-anchor">#</a> componentDidUpdate</h3> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token function">componentDidUpdate</span><span class="token punctuation">(</span><span class="token parameter">prevProps<span class="token punctuation">,</span> prevState<span class="token punctuation">,</span> snapshot</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">const</span> style <span class="token operator">=</span> <span class="token function">getComputedStyle</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>node<span class="token punctuation">)</span>
    <span class="token keyword">const</span> newPosition <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token comment">/* 获取元素最新位置信息 */</span>
        cx<span class="token operator">:</span>style<span class="token punctuation">.</span>cx<span class="token punctuation">,</span>
        cy<span class="token operator">:</span>style<span class="token punctuation">.</span>cy
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><ul><li>prevProps 更新之前的 props ；</li> <li>prevState 更新之前的 state ；</li> <li>snapshot 为 getSnapshotBeforeUpdate 返回的快照，可以是更新前的 DOM 信息。</li></ul> <p>作用</p> <ul><li>componentDidUpdate 生命周期执行，此时 DOM 已经更新，可以直接获取 DOM 最新状态。这个函数里面如果想要使用 setState ，一定要加以限制，否则会引起无限循环。</li> <li>接受 getSnapshotBeforeUpdate 保存的快照信息。</li></ul> <h3 id="componentdidmount"><a href="#componentdidmount" class="header-anchor">#</a> componentDidMount</h3> <p>componentDidMount 生命周期执行时机和 componentDidUpdate 一样，一个是在初始化，一个是组件更新。此时 DOM 已经创建完，既然 DOM 已经创建挂载，就可以做一些基于 DOM 操作，DOM 事件监听器。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">async</span> <span class="token function">componentDidMount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>node<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
        <span class="token comment">/* 事件监听 */</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span> 
    <span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">/* 数据请求 */</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>作用：</p> <ul><li>可以做一些关于 DOM 操作，比如基于 DOM 的事件监听器。</li> <li>对于初始化向服务器请求数据，渲染视图，这个生命周期也是蛮合适的。</li></ul> <h3 id="shouldcomponentupdate"><a href="#shouldcomponentupdate" class="header-anchor">#</a> shouldComponentUpdate</h3> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token function">shouldComponentUpdate</span><span class="token punctuation">(</span><span class="token parameter">newProps<span class="token punctuation">,</span>newState<span class="token punctuation">,</span>nextContext</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>shouldComponentUpdate 三个参数，第一个参数新的 props ，第二个参数新的 state ，第三个参数新的 context 。</p> <p>这个生命周期，一般用于性能优化，shouldComponentUpdate 返回值决定是否重新渲染的类组件。需要重点关注的是第二个参数 newState ，如果有 getDerivedStateFromProps 生命周期 ，它的返回值将合并到 newState ，供 shouldComponentUpdate 使用。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token function">shouldComponentUpdate</span><span class="token punctuation">(</span><span class="token parameter">newProps<span class="token punctuation">,</span>newState</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>newProps<span class="token punctuation">.</span>a <span class="token operator">!==</span> <span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>a <span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token comment">/* props中a属性发生变化 渲染组件 */</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>newState<span class="token punctuation">.</span>b <span class="token operator">!==</span> <span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>b <span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token comment">/* state 中b属性发生变化 渲染组件 */</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span> <span class="token comment">/* 否则组件不渲染 */</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h3 id="componentwillunmount"><a href="#componentwillunmount" class="header-anchor">#</a> componentWillUnmount</h3> <p>componentWillUnmount 是组件销毁阶段唯一执行的生命周期，主要做一些收尾工作，比如清除一些可能造成内存泄漏的定时器，延时器，或者是一些事件监听器。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token function">componentWillUnmount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token function">clearTimeout</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>timer<span class="token punctuation">)</span>  <span class="token comment">/* 清除延时器 */</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>node<span class="token punctuation">.</span><span class="token function">removeEventListener</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">,</span><span class="token keyword">this</span><span class="token punctuation">.</span>handerClick<span class="token punctuation">)</span> <span class="token comment">/* 卸载事件监听器 */</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>作用</p> <p>清除延时器，定时器。
一些基于 DOM 的操作，比如事件监听器。</p> <h2 id="函数组件生命周期"><a href="#函数组件生命周期" class="header-anchor">#</a> 函数组件生命周期</h2> <p>React hooks也提供了 api ，用于弥补函数组件没有生命周期的缺陷。其原理主要是运用了 hooks 里面的 useEffect 和 useLayoutEffect。</p> <h3 id="useeffect"><a href="#useeffect" class="header-anchor">#</a> useEffect</h3> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> destory
<span class="token punctuation">}</span><span class="token punctuation">,</span>dep<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><ul><li>useEffect 第一个参数 callback, 返回的 destory ， destory 作为下一次callback执行之前调用，用于清除上一次 callback 产生的副作用。</li> <li>第二个参数作为依赖项，是一个数组，可以有多个依赖项，依赖项改变，执行上一次callback 返回的 destory ，和执行新的 effect 第一个参数 callback 。</li></ul> <p>对于 useEffect 执行， React 处理逻辑是采用异步调用 ，对于每一个 effect 的 callback， React 会向 setTimeout回调函数一样，放入任务队列，等到主线程任务完成，DOM 更新，js 执行完成，视图绘制完毕，才执行。所以 effect 回调函数不会阻塞浏览器绘制视图。</p> <h3 id="uselayouteffect"><a href="#uselayouteffect" class="header-anchor">#</a> useLayoutEffect</h3> <p>useLayoutEffect 和 useEffect 不同的地方是采用了同步执行，那么和useEffect有什么区别呢？</p> <p>首先 useLayoutEffect 是在 DOM 更新之后，浏览器绘制之前，这样可以方便修改 DOM，获取 DOM 信息，这样浏览器只会绘制一次，如果修改 DOM 布局放在 useEffect ，那 useEffect 执行是在浏览器绘制视图之后，接下来又改 DOM ，就可能会导致浏览器再次回流和重绘。而且由于两次绘制，视图上可能会造成闪现突兀的效果。</p> <p>useLayoutEffect callback 中代码执行会阻塞浏览器绘制。</p> <h3 id="useeffect-与-uselayouteffect-区别"><a href="#useeffect-与-uselayouteffect-区别" class="header-anchor">#</a> useEffect 与 useLayoutEffect 区别</h3> <p>一句话概括如何选择 useEffect 和 useLayoutEffect ：修改 DOM ，改变布局就用 useLayoutEffect ，其他情况就用 useEffect 。</p> <p>React.useEffect 回调函数 和 componentDidMount / componentDidUpdate 执行时机有什么区别 ？</p> <p>useEffect 对 React 执行栈来看是异步执行的，而 componentDidMount / componentDidUpdate 是同步执行的，useEffect代码不会阻塞浏览器绘制。在时机上 ，componentDidMount / componentDidUpdate 和 useLayoutEffect 更类似。</p> <h3 id="useinsertioneffect"><a href="#useinsertioneffect" class="header-anchor">#</a> useInsertionEffect</h3> <p>useInsertionEffect 是在 React v18 新添加的 hooks ，它的用法和 useEffect 和 useLayoutEffect 一样。那么这个 hooks 用于什么呢?</p> <p>在介绍 useInsertionEffect 用途之前，先看一下 useInsertionEffect 的执行时机。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>React<span class="token punctuation">.</span><span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'useEffect 执行'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

React<span class="token punctuation">.</span><span class="token function">useLayoutEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'useLayoutEffect 执行'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

React<span class="token punctuation">.</span><span class="token function">useInsertionEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'useInsertionEffect 执行'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token comment">//  useInsertionEffect 执行 useLayoutEffect 执行 useEffect 执行</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>可以看到 useInsertionEffect 的执行时机要比 useLayoutEffect 提前，useLayoutEffect 执行的时候 DOM 已经更新了，但是在 useInsertionEffect 的执行的时候，DOM 还没有更新。</p> <p>本质上 useInsertionEffect 主要是解决 CSS-in-JS 在渲染中注入样式的性能问题。这个 hooks 主要是应用于这个场景，在其他场景下 React 不期望用这个 hooks</p> <div class="custom-block tip"><p class="custom-block-title">css-in-js 问题</p> <p>CSS-in-JS 的注入会引发哪些问题呢？ 首先看部分 CSS-in-JS 的实现原理，拿 Styled-components 为例子，通过styled-components，你可以使用ES6的标签模板字符串语法（Tagged Templates）为需要 styled 的 Component 定义一系列CSS属性，当该组件的JS代码被解析执行的时候，styled-components 会动态生成一个 CSS 选择器，并把对应的 CSS 样式通过 style 标签的形式插入到 head 标签里面。动态生成的 CSS 选择器会有一小段哈希值来保证全局唯一性来避免样式发生冲突。这种模式下本质上是动态生成 style 标签。</p></div> <p>在 useLayoutEffect 使用 CSS-in-JS 会造成哪里问题呢？</p> <ul><li>首先 useLayoutEffect 执行的时机 DOM 已经更新完成，布局也已经确定了，剩下的就是交给浏览器绘制就行了。</li> <li>如果在 useLayoutEffect 动态生成 style 标签，那么会再次影响布局，导致浏览器再次重回和重排。</li></ul> <p>这个是时候 useInsertionEffect 的作用就出现了，useInsertionEffect 的执行在 DOM 更新前，所以此时使用 CSS-in-JS 避免了浏览器出现再次重回和重排的可能，解决了性能上的问题。</p> <p>在 useInsertionEffect 使用 CSS-in-JS 流程</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">Index</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>

  React<span class="token punctuation">.</span><span class="token function">useInsertionEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
     <span class="token comment">/* 动态创建 style 标签插入到 head 中 */</span>
     <span class="token keyword">const</span> style <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'style'</span><span class="token punctuation">)</span>
     style<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
       .css-in-js{
         color: red;
         font-size: 20px;
       }
     </span><span class="token template-punctuation string">`</span></span>
     document<span class="token punctuation">.</span>head<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>style<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

  <span class="token keyword">return</span> <span class="token operator">&lt;</span>div className<span class="token operator">=</span><span class="token string">&quot;css-in-js&quot;</span> <span class="token operator">&gt;</span> hello <span class="token punctuation">,</span> useInsertionEffect <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><h2 id="生命周期在函数组件中的替代方案"><a href="#生命周期在函数组件中的替代方案" class="header-anchor">#</a> 生命周期在函数组件中的替代方案</h2> <h3 id="componentdidmount-替代方案"><a href="#componentdidmount-替代方案" class="header-anchor">#</a> componentDidMount 替代方案</h3> <div class="language-js line-numbers-mode"><pre class="language-js"><code>React<span class="token punctuation">.</span><span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    <span class="token comment">/* 请求数据 ， 事件监听 ， 操纵dom */</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>  <span class="token comment">/* 切记 dep = [] */</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>这里要记住 dep = [] ，这样当前 effect 没有任何依赖项，也就只有初始化执行一次。</p> <h3 id="componentwillunmount-替代方案"><a href="#componentwillunmount-替代方案" class="header-anchor">#</a> componentWillUnmount 替代方案</h3> <div class="language-js line-numbers-mode"><pre class="language-js"><code> React<span class="token punctuation">.</span><span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
        <span class="token comment">/* 请求数据 ， 事件监听 ， 操纵dom ， 增加定时器，延时器 */</span>
        <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token function">componentWillUnmount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token comment">/* 解除事件监听器 ，清除定时器，延时器 */</span>
        <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token comment">/* 切记 dep = [] */</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>在 componentDidMount 的前提下，useEffect 第一个函数的返回函数，可以作为 componentWillUnmount 使用。</p> <h3 id="componentwillreceiveprops-代替方案"><a href="#componentwillreceiveprops-代替方案" class="header-anchor">#</a> componentWillReceiveProps 代替方案</h3> <p>说 useEffect 代替 componentWillReceiveProps 着实有点牵强。</p> <ul><li>首先因为二者的执行阶段根本不同，一个是在render阶段，一个是在commit阶段。</li> <li>其次 useEffect 会初始化执行一次，但是 componentWillReceiveProps 只有组件更新 props 变化的时候才会执行。</li></ul> <div class="language-js line-numbers-mode"><pre class="language-js"><code>React<span class="token punctuation">.</span><span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'props变化：componentWillReceiveProps'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">[</span> props <span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>此时依赖项就是 props，props 变化，执行此时的 useEffect 钩子。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>React<span class="token punctuation">.</span><span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'props中number变化：componentWillReceiveProps'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">[</span> props<span class="token punctuation">.</span>number <span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token comment">/* 当前仅当 props中number变化，执行当前effect钩子 */</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>useEffect 还可以针对 props 的某一个属性进行追踪。此时的依赖项为 props 的追踪属性。如上述代码，只有 props 中 number 变化，执行 effect 。</p> <h3 id="componentdidupdate-替代方案"><a href="#componentdidupdate-替代方案" class="header-anchor">#</a> componentDidUpdate 替代方案</h3> <p>useEffect 和 componentDidUpdate 在执行时期虽然有点差别，useEffect 是异步执行，componentDidUpdate 是同步执行 ，但都是在 commit 阶段 。但是向上面所说 useEffect 会默认执行一次，而 componentDidUpdate 只有在组件更新完成后执行。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>React<span class="token punctuation">.</span><span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'组件更新完成：componentDidUpdate '</span><span class="token punctuation">)</span>     
<span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token comment">/* 没有 dep 依赖项 */</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>没有第二个参数，那么每一次执行函数组件，都会执行该 effect。</p> <h2 id="实现一个-scrollview-组件"><a href="#实现一个-scrollview-组件" class="header-anchor">#</a> 实现一个 ScrollView 组件</h2> <p>主要用于长列表渲染，滑动底部请求渲染列表</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">ScrollView</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span><span class="token punctuation">{</span>
    <span class="token comment">/* -----自定义事件---- */</span>
    <span class="token comment">/* 控制滚动条滚动 */</span>
      <span class="token function-variable function">handerScroll</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
        <span class="token keyword">const</span> <span class="token punctuation">{</span> scroll <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>props
        scroll <span class="token operator">&amp;&amp;</span> <span class="token function">scroll</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">handerScrolltolower</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment">/* 判断滚动条是否到底部 */</span>
    <span class="token function">handerScrolltolower</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
       <span class="token keyword">const</span> <span class="token punctuation">{</span> scrolltolower <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>props
       <span class="token keyword">const</span> <span class="token punctuation">{</span> scrollHeight <span class="token punctuation">,</span> scrollTop <span class="token punctuation">,</span>  offsetHeight <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>node 
       <span class="token keyword">if</span><span class="token punctuation">(</span>scrollHeight <span class="token operator">===</span> scrollTop <span class="token operator">+</span> offsetHeight<span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token comment">/* 到达容器底部位置 */</span>
           scrolltolower <span class="token operator">&amp;&amp;</span> <span class="token function">scrolltolower</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
       <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    node <span class="token operator">=</span> <span class="token keyword">null</span>

    <span class="token comment">/* ---——---生命周期------- */</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token operator">=</span><span class="token punctuation">{</span> <span class="token comment">/* 初始化 Data */</span>
            list<span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">]</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>handerScrolltolower <span class="token operator">=</span> <span class="token function">debounce</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>handerScrolltolower<span class="token punctuation">,</span><span class="token number">200</span><span class="token punctuation">)</span> <span class="token comment">/* 防抖处理 */</span>               
    <span class="token punctuation">}</span>
    <span class="token comment">/* 接收props, 合并到state */</span>
    <span class="token keyword">static</span> <span class="token function">getDerivedStateFromProps</span><span class="token punctuation">(</span><span class="token parameter">newProps</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">const</span> <span class="token punctuation">{</span> data <span class="token punctuation">}</span> <span class="token operator">=</span> newProps
        <span class="token keyword">return</span> <span class="token punctuation">{</span> 
            list <span class="token operator">:</span> data<span class="token punctuation">.</span>list <span class="token operator">||</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">/* 性能优化，只有列表数据变化，渲染列表 */</span>
    <span class="token function">shouldComponentUpdate</span><span class="token punctuation">(</span><span class="token parameter">newProps<span class="token punctuation">,</span>newState</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
       <span class="token keyword">return</span> newState<span class="token punctuation">.</span>list <span class="token operator">!==</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>list
    <span class="token punctuation">}</span>
    <span class="token comment">/* 获取更新前容器高度 */</span>
    <span class="token function">getSnapshotBeforeUpdate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>node<span class="token punctuation">.</span>scrollHeight
    <span class="token punctuation">}</span>
    <span class="token comment">/* 获取更新后容器高度 */</span>
    <span class="token function">componentDidUpdate</span><span class="token punctuation">(</span><span class="token parameter">prevProps<span class="token punctuation">,</span> prevState<span class="token punctuation">,</span> snapshot</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'scrollView容器高度变化:'</span> <span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>node<span class="token punctuation">.</span>scrollHeight <span class="token operator">-</span> snapshot  <span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment">/* 绑定事件监听器 - 监听scorll事件 */</span>
    <span class="token function">componentDidMount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>node<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'scroll'</span><span class="token punctuation">,</span><span class="token keyword">this</span><span class="token punctuation">.</span>handerScroll<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment">/* 解绑事件监听器 */</span>
    <span class="token function">componentWillUnmount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>node<span class="token punctuation">.</span><span class="token function">removeEventListener</span><span class="token punctuation">(</span><span class="token string">'scroll'</span><span class="token punctuation">,</span><span class="token keyword">this</span><span class="token punctuation">.</span>handerScroll<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> <span class="token punctuation">{</span> list <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state
        <span class="token keyword">const</span> <span class="token punctuation">{</span> component <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>props
        <span class="token keyword">return</span> <span class="token operator">&lt;</span>div className<span class="token operator">=</span><span class="token string">&quot;list_box&quot;</span>  ref<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token parameter">node</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>node <span class="token operator">=</span> node <span class="token punctuation">}</span>  <span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>div <span class="token operator">&gt;</span>     
                <span class="token punctuation">{</span>
                    list<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span>
                        React<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span>component<span class="token punctuation">,</span><span class="token punctuation">{</span> item <span class="token punctuation">,</span> key<span class="token operator">:</span> item<span class="token punctuation">.</span>id  <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token comment">//渲染 Item 列表内容。</span>
                    <span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">}</span>
            <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br></div></div><p>scrollview组件各个生命周期功能：</p> <ul><li>constructor： 做数据初始化，将滑动处理函数，做防抖处理。</li> <li>getDerivedStateFromProps: 将 props 中的 list ，合并到 state 。</li> <li>componentDidMount: 绑定监听 scroll 事件。</li> <li>shouldComponentUpdate：性能优化，只有 list 改变，渲染视图。</li> <li>render: 渲染视图，渲染 Item 。</li> <li>getSnapshotBeforeUpdate：保存组件更新前的 scrollview 容器高度。</li> <li>componentDidUpdate：根据渲染前后容器高度，计算一次高度变化量。</li> <li>componentWillUnmount：解除 scroll 事件监听器。</li></ul> <p>使用：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">/* item 完全是单元项的渲染ui */</span>
<span class="token keyword">function</span> <span class="token function">Item</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span>item<span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span>  <span class="token operator">&lt;</span>div className<span class="token operator">=</span><span class="token string">&quot;goods_item&quot;</span> <span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>img src<span class="token operator">=</span><span class="token punctuation">{</span>item<span class="token punctuation">.</span>giftImage<span class="token punctuation">}</span> className<span class="token operator">=</span><span class="token string">&quot;item_image&quot;</span> <span class="token operator">/</span><span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>div className<span class="token operator">=</span><span class="token string">&quot;item_content&quot;</span> <span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>div className<span class="token operator">=</span><span class="token string">&quot;goods_name&quot;</span> <span class="token operator">&gt;</span>
                <span class="token punctuation">{</span>item<span class="token punctuation">.</span>giftName<span class="token punctuation">}</span>
            <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>div className<span class="token operator">=</span><span class="token string">&quot;hold_price&quot;</span> <span class="token operator">/</span><span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>div className<span class="token operator">=</span><span class="token string">&quot;new_price&quot;</span> <span class="token operator">&gt;</span>
                <span class="token operator">&lt;</span>div className<span class="token operator">=</span><span class="token string">&quot;new_price&quot;</span> <span class="token operator">&gt;</span>
                    <span class="token operator">&lt;</span>div className<span class="token operator">=</span><span class="token string">&quot;one view&quot;</span><span class="token operator">&gt;</span>
                        ¥ <span class="token punctuation">{</span>item<span class="token punctuation">.</span>price<span class="token punctuation">}</span>
                    <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
                <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>img className<span class="token operator">=</span><span class="token string">'go_share  go_text'</span> <span class="token operator">/</span><span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
    <span class="token keyword">const</span> <span class="token punctuation">[</span> data <span class="token punctuation">,</span> setData <span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token punctuation">{</span> list<span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>page<span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span>pageCount<span class="token operator">:</span><span class="token number">1</span>  <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token comment">/* 记录列表数据 */</span>
    <span class="token comment">/* 请求数据 */</span>
    <span class="token keyword">const</span> <span class="token function-variable function">getData</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>page <span class="token operator">===</span> data<span class="token punctuation">.</span>pageCount<span class="token punctuation">)</span> <span class="token keyword">return</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'没有数据了～'</span><span class="token punctuation">)</span>
        <span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fetchData</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>page <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>code <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token function">setData</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            <span class="token operator">...</span>res<span class="token punctuation">,</span>
            list<span class="token operator">:</span>res<span class="token punctuation">.</span>page <span class="token operator">===</span> <span class="token number">1</span> <span class="token operator">?</span>  res<span class="token punctuation">.</span>list <span class="token operator">:</span> data<span class="token punctuation">.</span>list<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>list<span class="token punctuation">)</span> 
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> 
    <span class="token comment">/* 滚动到底部触发 */</span>
    <span class="token keyword">const</span> <span class="token function-variable function">handerScrolltolower</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'scroll已经到底部'</span><span class="token punctuation">)</span>
        <span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment">/* 初始化请求数据 */</span>
    <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
        <span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token operator">&lt;</span>ScrollView 
            data<span class="token operator">=</span><span class="token punctuation">{</span> data <span class="token punctuation">}</span>       <span class="token comment">/*  */</span>
            component<span class="token operator">=</span><span class="token punctuation">{</span> Item <span class="token punctuation">}</span>  <span class="token comment">/* Item 渲染的单元组件 */</span>
            scrolltolower<span class="token operator">=</span><span class="token punctuation">{</span> handerScrolltolower <span class="token punctuation">}</span> 
            scroll<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">}</span> 
        <span class="token operator">/</span><span class="token operator">&gt;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br></div></div></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/blog/react/warmup/react-props.html" class="prev">
        React Props
      </a></span> <span class="next"><a href="/blog/react/warmup/react-ref.html">
        React Ref
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----><!----><!----><!----></div></div>
    <script src="/blog/assets/js/app.b881e293.js" defer></script><script src="/blog/assets/js/2.8bf77cff.js" defer></script><script src="/blog/assets/js/128.c2b25c29.js" defer></script><script src="/blog/assets/js/4.ff6074e9.js" defer></script>
  </body>
</html>
