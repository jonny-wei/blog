<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>React Mobx | 前端那些事儿</title>
    <meta name="generator" content="VuePress 1.9.10">
    <link rel="icon" href="/blog/logo.png">
    <link rel="manifest" href="/blog/manifest.json">
    <link rel="apple-touch-icon" href="/blog/images/icons/apple-icon-152x152.png">
    <meta name="description" content="我命由我不由天，学习吧少年">
    <meta name="theme-color" content="#3eaf7c">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="msapplication-TileImage" content="/icons/ms-icon-144x144.png">
    <meta name="msapplication-TileColor" content="#000000">
    
    <link rel="preload" href="/blog/assets/css/0.styles.f0017422.css" as="style"><link rel="preload" href="/blog/assets/js/app.5c0d645f.js" as="script"><link rel="preload" href="/blog/assets/js/2.dec2e75d.js" as="script"><link rel="preload" href="/blog/assets/js/1.5b9e135c.js" as="script"><link rel="preload" href="/blog/assets/js/168.196a44b6.js" as="script"><link rel="preload" href="/blog/assets/js/20.badbb211.js" as="script"><link rel="prefetch" href="/blog/assets/js/10.cc7e09f3.js"><link rel="prefetch" href="/blog/assets/js/100.dabe221b.js"><link rel="prefetch" href="/blog/assets/js/101.1d5ba7da.js"><link rel="prefetch" href="/blog/assets/js/102.5b35a802.js"><link rel="prefetch" href="/blog/assets/js/103.f2e1cfb2.js"><link rel="prefetch" href="/blog/assets/js/104.717a1120.js"><link rel="prefetch" href="/blog/assets/js/105.ef8ecd83.js"><link rel="prefetch" href="/blog/assets/js/106.50c36972.js"><link rel="prefetch" href="/blog/assets/js/107.2497012e.js"><link rel="prefetch" href="/blog/assets/js/108.483bd993.js"><link rel="prefetch" href="/blog/assets/js/109.faf3aefa.js"><link rel="prefetch" href="/blog/assets/js/11.b60c9933.js"><link rel="prefetch" href="/blog/assets/js/110.afdc922e.js"><link rel="prefetch" href="/blog/assets/js/111.b3b30630.js"><link rel="prefetch" href="/blog/assets/js/112.177f2e74.js"><link rel="prefetch" href="/blog/assets/js/113.b934908a.js"><link rel="prefetch" href="/blog/assets/js/114.6cff1ef3.js"><link rel="prefetch" href="/blog/assets/js/115.615df4ef.js"><link rel="prefetch" href="/blog/assets/js/116.acc1996c.js"><link rel="prefetch" href="/blog/assets/js/117.cbe35c59.js"><link rel="prefetch" href="/blog/assets/js/118.2e646bd5.js"><link rel="prefetch" href="/blog/assets/js/119.79ff9ce3.js"><link rel="prefetch" href="/blog/assets/js/12.c53283e7.js"><link rel="prefetch" href="/blog/assets/js/120.97f3f4e6.js"><link rel="prefetch" href="/blog/assets/js/121.d1c9cee4.js"><link rel="prefetch" href="/blog/assets/js/122.813f1055.js"><link rel="prefetch" href="/blog/assets/js/123.83cce4d2.js"><link rel="prefetch" href="/blog/assets/js/124.d2e31263.js"><link rel="prefetch" href="/blog/assets/js/125.e4d752ad.js"><link rel="prefetch" href="/blog/assets/js/126.4e317378.js"><link rel="prefetch" href="/blog/assets/js/127.7aa5abcb.js"><link rel="prefetch" href="/blog/assets/js/128.0d0449cb.js"><link rel="prefetch" href="/blog/assets/js/129.541876d1.js"><link rel="prefetch" href="/blog/assets/js/13.6bdc6b5d.js"><link rel="prefetch" href="/blog/assets/js/130.b50c1756.js"><link rel="prefetch" href="/blog/assets/js/131.14890a2b.js"><link rel="prefetch" href="/blog/assets/js/132.dd38cfb4.js"><link rel="prefetch" href="/blog/assets/js/133.c236699b.js"><link rel="prefetch" href="/blog/assets/js/134.ab2058c9.js"><link rel="prefetch" href="/blog/assets/js/135.20626c27.js"><link rel="prefetch" href="/blog/assets/js/136.66c83721.js"><link rel="prefetch" href="/blog/assets/js/137.7dd15ccf.js"><link rel="prefetch" href="/blog/assets/js/138.6464ecf9.js"><link rel="prefetch" href="/blog/assets/js/139.7fa8e1f4.js"><link rel="prefetch" href="/blog/assets/js/14.c3201a23.js"><link rel="prefetch" href="/blog/assets/js/140.149ebe7f.js"><link rel="prefetch" href="/blog/assets/js/141.b9067bc8.js"><link rel="prefetch" href="/blog/assets/js/142.34e129c4.js"><link rel="prefetch" href="/blog/assets/js/143.9dbd485f.js"><link rel="prefetch" href="/blog/assets/js/144.7f90ff6d.js"><link rel="prefetch" href="/blog/assets/js/145.4b761da4.js"><link rel="prefetch" href="/blog/assets/js/146.213c5d0e.js"><link rel="prefetch" href="/blog/assets/js/147.be23ddb3.js"><link rel="prefetch" href="/blog/assets/js/148.c161cdfc.js"><link rel="prefetch" href="/blog/assets/js/149.ce1a47f4.js"><link rel="prefetch" href="/blog/assets/js/15.a0b9e44e.js"><link rel="prefetch" href="/blog/assets/js/150.c8304db0.js"><link rel="prefetch" href="/blog/assets/js/151.4694bde0.js"><link rel="prefetch" href="/blog/assets/js/152.fb05e213.js"><link rel="prefetch" href="/blog/assets/js/153.70a6fd63.js"><link rel="prefetch" href="/blog/assets/js/154.6a1f9d84.js"><link rel="prefetch" href="/blog/assets/js/155.779fbb83.js"><link rel="prefetch" href="/blog/assets/js/156.eb193c60.js"><link rel="prefetch" href="/blog/assets/js/157.e052eb9d.js"><link rel="prefetch" href="/blog/assets/js/158.87c66efe.js"><link rel="prefetch" href="/blog/assets/js/159.bfac6e97.js"><link rel="prefetch" href="/blog/assets/js/16.491191e4.js"><link rel="prefetch" href="/blog/assets/js/160.1c265a50.js"><link rel="prefetch" href="/blog/assets/js/161.9c8db632.js"><link rel="prefetch" href="/blog/assets/js/162.08656fce.js"><link rel="prefetch" href="/blog/assets/js/163.7ba9ed88.js"><link rel="prefetch" href="/blog/assets/js/164.dc9436f9.js"><link rel="prefetch" href="/blog/assets/js/165.5a379c90.js"><link rel="prefetch" href="/blog/assets/js/166.e508130a.js"><link rel="prefetch" href="/blog/assets/js/167.3463c2ed.js"><link rel="prefetch" href="/blog/assets/js/169.bf573f56.js"><link rel="prefetch" href="/blog/assets/js/17.89ec8c57.js"><link rel="prefetch" href="/blog/assets/js/170.8825cf2f.js"><link rel="prefetch" href="/blog/assets/js/171.e37cef45.js"><link rel="prefetch" href="/blog/assets/js/172.101ab258.js"><link rel="prefetch" href="/blog/assets/js/173.52f54b75.js"><link rel="prefetch" href="/blog/assets/js/174.d9e8f9f7.js"><link rel="prefetch" href="/blog/assets/js/175.58bd1d44.js"><link rel="prefetch" href="/blog/assets/js/176.01658475.js"><link rel="prefetch" href="/blog/assets/js/177.d84d06e6.js"><link rel="prefetch" href="/blog/assets/js/178.c187efc7.js"><link rel="prefetch" href="/blog/assets/js/179.0e617fe3.js"><link rel="prefetch" href="/blog/assets/js/18.b91f1411.js"><link rel="prefetch" href="/blog/assets/js/180.461b359e.js"><link rel="prefetch" href="/blog/assets/js/181.f6a32104.js"><link rel="prefetch" href="/blog/assets/js/182.16dc1844.js"><link rel="prefetch" href="/blog/assets/js/183.f336285a.js"><link rel="prefetch" href="/blog/assets/js/184.0c197702.js"><link rel="prefetch" href="/blog/assets/js/185.a08d3259.js"><link rel="prefetch" href="/blog/assets/js/186.9256478c.js"><link rel="prefetch" href="/blog/assets/js/187.8e78996f.js"><link rel="prefetch" href="/blog/assets/js/188.86d55068.js"><link rel="prefetch" href="/blog/assets/js/189.243f4482.js"><link rel="prefetch" href="/blog/assets/js/19.cb1f17c8.js"><link rel="prefetch" href="/blog/assets/js/190.0515855c.js"><link rel="prefetch" href="/blog/assets/js/191.5a45d0dd.js"><link rel="prefetch" href="/blog/assets/js/192.b73519d3.js"><link rel="prefetch" href="/blog/assets/js/193.ab975c7d.js"><link rel="prefetch" href="/blog/assets/js/194.d17a7216.js"><link rel="prefetch" href="/blog/assets/js/195.4ef22e15.js"><link rel="prefetch" href="/blog/assets/js/196.d02c94c7.js"><link rel="prefetch" href="/blog/assets/js/197.1c8c2216.js"><link rel="prefetch" href="/blog/assets/js/198.3ad3a1c9.js"><link rel="prefetch" href="/blog/assets/js/199.7078abc5.js"><link rel="prefetch" href="/blog/assets/js/200.5c86734c.js"><link rel="prefetch" href="/blog/assets/js/201.cc24eacb.js"><link rel="prefetch" href="/blog/assets/js/202.95ea7e05.js"><link rel="prefetch" href="/blog/assets/js/203.dc92157f.js"><link rel="prefetch" href="/blog/assets/js/204.8d2381f4.js"><link rel="prefetch" href="/blog/assets/js/205.062fc0fa.js"><link rel="prefetch" href="/blog/assets/js/206.f08174cd.js"><link rel="prefetch" href="/blog/assets/js/207.500b316a.js"><link rel="prefetch" href="/blog/assets/js/208.8a3a45ed.js"><link rel="prefetch" href="/blog/assets/js/209.099f2e3e.js"><link rel="prefetch" href="/blog/assets/js/21.bf0041b7.js"><link rel="prefetch" href="/blog/assets/js/210.f1c95bdf.js"><link rel="prefetch" href="/blog/assets/js/211.0ce80fe5.js"><link rel="prefetch" href="/blog/assets/js/212.9bf0e4e5.js"><link rel="prefetch" href="/blog/assets/js/213.a296a4b4.js"><link rel="prefetch" href="/blog/assets/js/214.47d7b502.js"><link rel="prefetch" href="/blog/assets/js/215.2d17a758.js"><link rel="prefetch" href="/blog/assets/js/216.28a77bde.js"><link rel="prefetch" href="/blog/assets/js/217.bce2a65f.js"><link rel="prefetch" href="/blog/assets/js/218.09fcb7a5.js"><link rel="prefetch" href="/blog/assets/js/219.afad10dd.js"><link rel="prefetch" href="/blog/assets/js/22.48390d4f.js"><link rel="prefetch" href="/blog/assets/js/220.ebc569c6.js"><link rel="prefetch" href="/blog/assets/js/221.6a2478b4.js"><link rel="prefetch" href="/blog/assets/js/222.0c7fe13e.js"><link rel="prefetch" href="/blog/assets/js/223.5afa3b79.js"><link rel="prefetch" href="/blog/assets/js/224.51e80330.js"><link rel="prefetch" href="/blog/assets/js/225.09d0c412.js"><link rel="prefetch" href="/blog/assets/js/226.3043cac7.js"><link rel="prefetch" href="/blog/assets/js/227.4e115357.js"><link rel="prefetch" href="/blog/assets/js/23.35c4ba93.js"><link rel="prefetch" href="/blog/assets/js/24.cc3b12df.js"><link rel="prefetch" href="/blog/assets/js/25.94c095ac.js"><link rel="prefetch" href="/blog/assets/js/26.dc0735bf.js"><link rel="prefetch" href="/blog/assets/js/27.bf58c149.js"><link rel="prefetch" href="/blog/assets/js/28.3cdce864.js"><link rel="prefetch" href="/blog/assets/js/29.6c1aebe8.js"><link rel="prefetch" href="/blog/assets/js/3.cb0627fa.js"><link rel="prefetch" href="/blog/assets/js/30.c5bb1b3d.js"><link rel="prefetch" href="/blog/assets/js/31.d9754d97.js"><link rel="prefetch" href="/blog/assets/js/32.bbc6bc42.js"><link rel="prefetch" href="/blog/assets/js/33.d4bb78a0.js"><link rel="prefetch" href="/blog/assets/js/34.66a4b69e.js"><link rel="prefetch" href="/blog/assets/js/35.c25c83f1.js"><link rel="prefetch" href="/blog/assets/js/36.9eaca2ee.js"><link rel="prefetch" href="/blog/assets/js/37.ff149f3c.js"><link rel="prefetch" href="/blog/assets/js/38.a3fb5426.js"><link rel="prefetch" href="/blog/assets/js/39.d5748ea8.js"><link rel="prefetch" href="/blog/assets/js/4.cbb57fa7.js"><link rel="prefetch" href="/blog/assets/js/40.c821fa3c.js"><link rel="prefetch" href="/blog/assets/js/41.72d168e7.js"><link rel="prefetch" href="/blog/assets/js/42.2c94b2fa.js"><link rel="prefetch" href="/blog/assets/js/43.8cfa3228.js"><link rel="prefetch" href="/blog/assets/js/44.f09abcfc.js"><link rel="prefetch" href="/blog/assets/js/45.f87383bf.js"><link rel="prefetch" href="/blog/assets/js/46.3522c1e1.js"><link rel="prefetch" href="/blog/assets/js/47.a2a63e22.js"><link rel="prefetch" href="/blog/assets/js/48.1a27d0ca.js"><link rel="prefetch" href="/blog/assets/js/49.da2e1be3.js"><link rel="prefetch" href="/blog/assets/js/5.fe065607.js"><link rel="prefetch" href="/blog/assets/js/50.64b6e6f6.js"><link rel="prefetch" href="/blog/assets/js/51.44d3299d.js"><link rel="prefetch" href="/blog/assets/js/52.f44c992f.js"><link rel="prefetch" href="/blog/assets/js/53.50675a1d.js"><link rel="prefetch" href="/blog/assets/js/54.f719facc.js"><link rel="prefetch" href="/blog/assets/js/55.b2101926.js"><link rel="prefetch" href="/blog/assets/js/56.e7ca6c14.js"><link rel="prefetch" href="/blog/assets/js/57.5a322bd3.js"><link rel="prefetch" href="/blog/assets/js/58.4492060e.js"><link rel="prefetch" href="/blog/assets/js/59.9239674f.js"><link rel="prefetch" href="/blog/assets/js/6.68cda050.js"><link rel="prefetch" href="/blog/assets/js/60.508d6f1d.js"><link rel="prefetch" href="/blog/assets/js/61.30eca23b.js"><link rel="prefetch" href="/blog/assets/js/62.c8cd84fa.js"><link rel="prefetch" href="/blog/assets/js/63.fc63838e.js"><link rel="prefetch" href="/blog/assets/js/64.77da6ad5.js"><link rel="prefetch" href="/blog/assets/js/65.8e353ed2.js"><link rel="prefetch" href="/blog/assets/js/66.281a5ac4.js"><link rel="prefetch" href="/blog/assets/js/67.6eeb5ab6.js"><link rel="prefetch" href="/blog/assets/js/68.34d9ae87.js"><link rel="prefetch" href="/blog/assets/js/69.aa119714.js"><link rel="prefetch" href="/blog/assets/js/7.3b8d63a0.js"><link rel="prefetch" href="/blog/assets/js/70.550cd861.js"><link rel="prefetch" href="/blog/assets/js/71.6dbd81eb.js"><link rel="prefetch" href="/blog/assets/js/72.6396e72f.js"><link rel="prefetch" href="/blog/assets/js/73.49e2280e.js"><link rel="prefetch" href="/blog/assets/js/74.2aeff695.js"><link rel="prefetch" href="/blog/assets/js/75.f6cf2df8.js"><link rel="prefetch" href="/blog/assets/js/76.4e2a8355.js"><link rel="prefetch" href="/blog/assets/js/77.daaae178.js"><link rel="prefetch" href="/blog/assets/js/78.cfe556c5.js"><link rel="prefetch" href="/blog/assets/js/79.ddf7c94e.js"><link rel="prefetch" href="/blog/assets/js/80.09f7a474.js"><link rel="prefetch" href="/blog/assets/js/81.712bd61b.js"><link rel="prefetch" href="/blog/assets/js/82.7abf5bc4.js"><link rel="prefetch" href="/blog/assets/js/83.81e8cf55.js"><link rel="prefetch" href="/blog/assets/js/84.2577ee3b.js"><link rel="prefetch" href="/blog/assets/js/85.669410bb.js"><link rel="prefetch" href="/blog/assets/js/86.1194b077.js"><link rel="prefetch" href="/blog/assets/js/87.3b6e5595.js"><link rel="prefetch" href="/blog/assets/js/88.8b840ce1.js"><link rel="prefetch" href="/blog/assets/js/89.fb1f77e4.js"><link rel="prefetch" href="/blog/assets/js/90.e0feae73.js"><link rel="prefetch" href="/blog/assets/js/91.1aa48754.js"><link rel="prefetch" href="/blog/assets/js/92.fede14d8.js"><link rel="prefetch" href="/blog/assets/js/93.3f378b31.js"><link rel="prefetch" href="/blog/assets/js/94.d9208461.js"><link rel="prefetch" href="/blog/assets/js/95.0f530084.js"><link rel="prefetch" href="/blog/assets/js/96.2a1bbb0f.js"><link rel="prefetch" href="/blog/assets/js/97.2301b9cf.js"><link rel="prefetch" href="/blog/assets/js/98.9d5643ce.js"><link rel="prefetch" href="/blog/assets/js/99.4445c278.js"><link rel="prefetch" href="/blog/assets/js/vendors~docsearch.bd3cdb54.js">
    <link rel="stylesheet" href="/blog/assets/css/0.styles.f0017422.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/blog/" class="home-link router-link-active"><img src="/blog/logo.png" alt="前端那些事儿" class="logo"> <span class="site-name can-hide">前端那些事儿</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/blog/" class="nav-link">
  主页
</a></div><div class="nav-item"><a href="/blog/base/" class="nav-link">
  前端基础
</a></div><div class="nav-item"><a href="/blog/vue/" class="nav-link">
  Vue
</a></div><div class="nav-item"><a href="/blog/react/" class="nav-link router-link-active">
  React
</a></div><div class="nav-item"><a href="/blog/devops/" class="nav-link">
  前端工程化
</a></div><div class="nav-item"><a href="/blog/mobile/" class="nav-link">
  泛客户端
</a></div><div class="nav-item"><a href="/blog/architecture/" class="nav-link">
  架构与方案
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="GitHub" class="dropdown-title"><span class="title">GitHub</span> <span class="arrow down"></span></button> <button type="button" aria-label="GitHub" class="mobile-dropdown-title"><span class="title">GitHub</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/jonny-wei" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://github.com/jonny-wei/sushi-js" target="_blank" rel="noopener noreferrer" class="nav-link external">
  JS 寿司
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/blog/" class="nav-link">
  主页
</a></div><div class="nav-item"><a href="/blog/base/" class="nav-link">
  前端基础
</a></div><div class="nav-item"><a href="/blog/vue/" class="nav-link">
  Vue
</a></div><div class="nav-item"><a href="/blog/react/" class="nav-link router-link-active">
  React
</a></div><div class="nav-item"><a href="/blog/devops/" class="nav-link">
  前端工程化
</a></div><div class="nav-item"><a href="/blog/mobile/" class="nav-link">
  泛客户端
</a></div><div class="nav-item"><a href="/blog/architecture/" class="nav-link">
  架构与方案
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="GitHub" class="dropdown-title"><span class="title">GitHub</span> <span class="arrow down"></span></button> <button type="button" aria-label="GitHub" class="mobile-dropdown-title"><span class="title">GitHub</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/jonny-wei" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://github.com/jonny-wei/sushi-js" target="_blank" rel="noopener noreferrer" class="nav-link external">
  JS 寿司
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>React</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/react/" aria-current="page" class="sidebar-link">React JSX</a></li><li><a href="/blog/react/warmup/react-component.html" class="sidebar-link">React 组件及通信</a></li><li><a href="/blog/react/warmup/react-state.html" class="sidebar-link">React State</a></li><li><a href="/blog/react/warmup/react-props.html" class="sidebar-link">React Props</a></li><li><a href="/blog/react/warmup/react-lifecycle.html" class="sidebar-link">React 生命周期</a></li><li><a href="/blog/react/warmup/react-ref.html" class="sidebar-link">React Ref</a></li><li><a href="/blog/react/warmup/react-context.html" class="sidebar-link">React Context</a></li><li><a href="/blog/react/warmup/react-css.html" class="sidebar-link">React 中 CSS 的模块化</a></li><li><a href="/blog/react/warmup/react-hoc.html" class="sidebar-link">React HOC</a></li><li><a href="/blog/react/warmup/react-render.html" class="sidebar-link">React 渲染优化</a></li><li><a href="/blog/react/warmup/react-router.html" class="sidebar-link">React Router</a></li><li><a href="/blog/react/warmup/react-redux.html" class="sidebar-link">React Rudex</a></li><li><a href="/blog/react/warmup/react-mobx.html" aria-current="page" class="active sidebar-link">React Mobx</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/react/warmup/react-mobx.html#mobx-特性" class="sidebar-link">Mobx 特性</a></li><li class="sidebar-sub-header"><a href="/blog/react/warmup/react-mobx.html#基本用法" class="sidebar-link">基本用法</a></li><li class="sidebar-sub-header"><a href="/blog/react/warmup/react-mobx.html#mobx-实现原理" class="sidebar-link">Mobx 实现原理</a></li></ul></li><li><a href="/blog/react/warmup/react-keepalive.html" class="sidebar-link">实现 KeepAlive</a></li><li><a href="/blog/react/warmup/react-state-v18.html" class="sidebar-link">V18 - Automatic Batching</a></li><li><a href="/blog/react/warmup/react-transition.html" class="sidebar-link">V18 - Transition</a></li><li><a href="/blog/react/warmup/react-suspense.html" class="sidebar-link">V18 - Suspense</a></li><li><a href="/blog/react/warmup/react-useSyncExternalStore.html" class="sidebar-link">V18 - useSyncExternalStore</a></li><li><a href="/blog/react/warmup/react-ssr.html" class="sidebar-link">V18 - Streaming SSR</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>React源码解析</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/react/react/react-reconciler.html" class="sidebar-link">Reconciler 调和器</a></li><li><a href="/blog/react/react/react-priority.html" class="sidebar-link">React 优先级管理</a></li><li><a href="/blog/react/react/react-scheduler.html" class="sidebar-link">Scheduler 调度器</a></li><li><a href="/blog/react/react/react-render.html" class="sidebar-link">Render 阶段</a></li><li><a href="/blog/react/react/react-commit.html" class="sidebar-link">Commit 阶段</a></li><li><a href="/blog/react/react/react-diff.html" class="sidebar-link">React Diff 算法</a></li><li><a href="/blog/react/react/react-hooks.html" class="sidebar-link">React Hooks 理解</a></li><li><a href="/blog/react/react/react-context.html" class="sidebar-link">React Context 原理</a></li><li><a href="/blog/react/react/react-event.html" class="sidebar-link">React 事件系统</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="react-mobx"><a href="#react-mobx" class="header-anchor">#</a> React Mobx</h1> <h2 id="mobx-特性"><a href="#mobx-特性" class="header-anchor">#</a> Mobx 特性</h2> <h3 id="观察者模式"><a href="#观察者模式" class="header-anchor">#</a> 观察者模式</h3> <p>Mobx 采用了一种'观察者模式'——Observer，整个设计架构都是围绕 Observer 展开：</p> <ul><li>在 mobx 的状态层，每一个需要观察的属性都会添加一个观察者，可以称之为 ObserverValue 。</li> <li>有了观察者，那么就需要向观察者中收集 listener ，mobx 中有一个 Reaction 模块，可以对一些行为做依赖收集，在 React 中，是通过劫持 render 函数执行行为，进行的依赖收集。</li> <li>如何监听改变，用自定义存取器属性中的 get 和 set ，来进行的依赖收集和更新派发，当状态改变，观察者会直接精确通知每个 listener 。</li></ul> <h3 id="状态提升"><a href="#状态提升" class="header-anchor">#</a> 状态提升</h3> <p>在正常情况下，在 React 应用中使用 Mobx ，本质上 mobx 里面的状态，并不是存在 React 组件里面的，是在外部由一个个 mobx 的模块 model 构成，每一个 model 可以理解成一个对象，状态实质存在 model 中，model 状态通过 props 添加到组件中，可以用 mobx-react 中的 Provder 和 inject 便捷获取它们，虽然 mobx 中响应式处理这些状态，但是不要试图直接修改 props 来促使更新，这样违背了 React Prop 单向数据流的原则。正确的处理方法，还是通过 model 下面的 action 方法，来改变状态，React 实质上调用的是 action 方法。</p> <h3 id="装饰器模式"><a href="#装饰器模式" class="header-anchor">#</a> 装饰器模式</h3> <p>为了建立观察者模式，便捷地获取状态/监听状态，mobx 很多接口都支持装饰器模式的写法</p> <h3 id="精确颗粒化收集"><a href="#精确颗粒化收集" class="header-anchor">#</a> 精确颗粒化收集</h3> <p>mobx 还有一个重要特点，就是对于属性的依赖收集是精确的，颗粒化的</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">Root</span> <span class="token punctuation">{</span>
    @observable object <span class="token operator">=</span> <span class="token punctuation">{</span>                  <span class="token comment">//C组件使用</span>
         <span class="token literal-property property">name</span><span class="token operator">:</span><span class="token string">'alien'</span><span class="token punctuation">,</span>                     <span class="token comment">// A组件使用</span>
         <span class="token literal-property property">mes</span><span class="token operator">:</span><span class="token string">'let us learn React!'</span>         <span class="token comment">// B组件使用</span>
    <span class="token punctuation">}</span>
    @action <span class="token function">setName</span><span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token keyword">this</span><span class="token punctuation">.</span>object<span class="token punctuation">.</span>name <span class="token operator">=</span> name  <span class="token punctuation">}</span>
    @action <span class="token function">setMes</span><span class="token punctuation">(</span><span class="token parameter">mes</span><span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token keyword">this</span><span class="token punctuation">.</span>object<span class="token punctuation">.</span>mes <span class="token operator">=</span> mes <span class="token punctuation">}</span>
    @action <span class="token function">setObject</span><span class="token punctuation">(</span><span class="token parameter">object</span><span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token keyword">this</span><span class="token punctuation">.</span>object <span class="token operator">=</span> object  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><ul><li>对于 observable 处理过的属性，每一个属性都会有 ObserverValue ，比如上面的结构会产生三个 ObserverValue ，分别对应 object ，name ，mes 。</li> <li>当上面通过 setName 改变 name 属性的时候，只有组件 A 会更新。也就是 name ObserverValue 只收集了用到 name 的依赖项 A 组件。</li> <li>调用 setMes 同理，只有组件 B 更新。 mes ObserverValue 只收集了 B 组件的依赖。</li> <li>当上面通过 setObject 改变 object 的时候，即使 object 里面name ，mes 的值没有变化，也会让组件 A ，组件 B ，组件 C ，全部渲染。object 的 Observer 同样收集了name的 ObserverValue 和 mes 的 ObserverValue 。</li></ul> <p><img src="/blog/images/react/mobx1.png" alt="mobx1"></p> <p>引用类型处理</p> <p>observable 对于引用数据类型，比如 Object ，Array ，Set ，Map等，除了新建一个 observable 之外，还会做如下两点操作。</p> <ul><li>Proxy：会把原始对象用 Proxy 代理，Proxy 会精确响应原始对象的变化，比如增加属性——给属性绑定 ObserverValue ，删除属性——给属性解绑 ObserverValue 等。</li> <li>ObservableAdministration： 对于子代属性，会创建一个 ObservableAdministration，用于管理子代属性的ObserverValue。</li></ul> <p>对于外层 Root ，在 constructor 使用 makeObservable ，mobx 会默认给最外层的 Root 添加 ObservableAdministration 。</p> <h2 id="基本用法"><a href="#基本用法" class="header-anchor">#</a> 基本用法</h2> <h3 id="mobx-常用-api"><a href="#mobx-常用-api" class="header-anchor">#</a> mobx 常用 api</h3> <p>mobx的 api 基本用于构建每一个响应式模块。</p> <h4 id="makeobservable"><a href="#makeobservable" class="header-anchor">#</a> makeObservable</h4> <p>在新版本 mobx 中，想要让整个模块变成可响应式的，那么需要在 constructor 调用 makeObservable。老版本的 mobx 不需要这么做。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token function">makeObservable</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h4 id="observable"><a href="#observable" class="header-anchor">#</a> observable</h4> <p>会给属性值加一个观察者对象，使其能变成可观察的，当属性值改变的时候，观察者会通知每一个依赖项。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>@observable name <span class="token operator">=</span> <span class="token string">'《React进阶实践指南》'</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h4 id="action"><a href="#action" class="header-anchor">#</a> action</h4> <p>通过 action 包裹的函数，可以用来修改 mobx 中的状态。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>@action <span class="token function">setName</span><span class="token punctuation">(</span><span class="token parameter">newName</span><span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> newName  <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h4 id="computed"><a href="#computed" class="header-anchor">#</a> computed</h4> <p>根据现有的状态或其它计算值衍生出的值。如下 total 是通过 price 和 count 衍生出来的新值。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>@observable price <span class="token operator">=</span> <span class="token number">666</span>  <span class="token comment">// 可观察属性——价格</span>
@observable count <span class="token operator">=</span> <span class="token number">1</span>    <span class="token comment">// 可观察属性——数量</span>
@computed <span class="token keyword">get</span> <span class="token function">total</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>price <span class="token operator">*</span> <span class="token keyword">this</span><span class="token punctuation">.</span>count
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h3 id="mobx-react-常用-api"><a href="#mobx-react-常用-api" class="header-anchor">#</a> mobx-react 常用 api</h3> <p>mobx-react 中的 api ，用于把 mobx 中的状态，提供给组件，并把组件也变成可观察的 —— mobx 状态改变，组件触发更新。</p> <h4 id="provider"><a href="#provider" class="header-anchor">#</a> Provider</h4> <p>用于把 mobx 的各个模块，用 Context 上下文形式，保存起来，供给组件使用。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token operator">&lt;</span>Provider Root<span class="token operator">=</span><span class="token punctuation">{</span>Root<span class="token punctuation">}</span> <span class="token operator">&gt;</span> <span class="token punctuation">{</span> <span class="token comment">/* ... */</span> <span class="token punctuation">}</span> <span class="token operator">&lt;</span><span class="token operator">/</span>Provider<span class="token operator">&gt;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h4 id="inject"><a href="#inject" class="header-anchor">#</a> inject</h4> <p>inject 高阶组件可以把 Provider 中的 mobx 模块，混入到组件的 props 中，所以就可以在组件中消费状态，或者调用改变状态的方法。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>@<span class="token function">inject</span><span class="token punctuation">(</span><span class="token string">'Root'</span><span class="token punctuation">)</span>
<span class="token keyword">class</span> <span class="token class-name">Index</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h4 id="observer"><a href="#observer" class="header-anchor">#</a> observer</h4> <p>被 observer 高阶组件包装的组件，如果组件内部引入了 mobx 可观察属性值，当值改变的时候，会追溯到当前组件，促使当前组件更新。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>@observer
<span class="token keyword">class</span> <span class="token class-name">Index</span> <span class="token keyword">extends</span>  <span class="token class-name">React<span class="token punctuation">.</span>Component</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h3 id="实现状态共享"><a href="#实现状态共享" class="header-anchor">#</a> 实现状态共享</h3> <p>首先创建 Root 模块，用于保存全局的一些数据。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> observable <span class="token punctuation">,</span>action <span class="token punctuation">,</span>makeObservable <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'mobx'</span>
<span class="token keyword">class</span> <span class="token class-name">Root</span><span class="token punctuation">{</span>
   <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token function">makeObservable</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
   <span class="token punctuation">}</span>
   @observable info<span class="token operator">=</span><span class="token punctuation">{</span> <span class="token literal-property property">name</span><span class="token operator">:</span><span class="token string">'xxx'</span><span class="token punctuation">,</span> <span class="token literal-property property">mes</span><span class="token operator">:</span><span class="token string">'xxx'</span> <span class="token punctuation">}</span>
   <span class="token comment">// @observable number = 1</span>
   @action <span class="token function">setInfo</span><span class="token punctuation">(</span><span class="token parameter">info</span><span class="token punctuation">)</span><span class="token punctuation">{</span>  <span class="token keyword">this</span><span class="token punctuation">.</span>info <span class="token operator">=</span> info <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">new</span> <span class="token class-name">Root</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>根本组件注入状态：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">import</span> Root <span class="token keyword">from</span> <span class="token string">'./mobx'</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">Index</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token operator">&lt;</span>Provider Root<span class="token operator">=</span><span class="token punctuation">{</span>Root<span class="token punctuation">}</span> <span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>Child <span class="token operator">/</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>Provider<span class="token operator">&gt;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>全局通过 mobx-react 中的 Provider 传递内容。inject 引入 Root，observer 做数据响应，模拟数据交互，调用 setInfo 改变 Root 中 info 内容。 info 内容改变，重新渲染视图。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token function-variable function">getUserInfo</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
   <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
            <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">name</span><span class="token operator">:</span><span class="token string">'alien'</span><span class="token punctuation">,</span> <span class="token literal-property property">mes</span><span class="token operator">:</span><span class="token string">'let us learn React!'</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
       <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token number">1000</span><span class="token punctuation">)</span>
   <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
@<span class="token function">inject</span><span class="token punctuation">(</span><span class="token string">'Root'</span><span class="token punctuation">)</span>
@observer
<span class="token keyword">class</span> <span class="token class-name">Child</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span><span class="token punctuation">{</span>
    <span class="token keyword">async</span> <span class="token function">componentDidMount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
       <span class="token comment">/*  模拟数据交互 */</span>
       <span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">getUserInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
       <span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>Root<span class="token punctuation">.</span><span class="token function">setInfo</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">const</span> <span class="token punctuation">{</span> info <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>Root
        <span class="token keyword">return</span> <span class="token operator">&lt;</span>div className<span class="token operator">=</span><span class="token string">&quot;box&quot;</span> <span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>p<span class="token operator">&gt;</span> 姓名：<span class="token punctuation">{</span>info<span class="token punctuation">.</span>name<span class="token punctuation">}</span> <span class="token operator">&lt;</span><span class="token operator">/</span>p<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>p<span class="token operator">&gt;</span> 想对大家说：<span class="token punctuation">{</span>info<span class="token punctuation">.</span>mes<span class="token punctuation">}</span> <span class="token operator">&lt;</span><span class="token operator">/</span>p<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><h3 id="实现组件通信"><a href="#实现组件通信" class="header-anchor">#</a> 实现组件通信</h3> <p>先注册模块用于组件通信</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">Communi</span> <span class="token punctuation">{</span>
   <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
       <span class="token function">makeObservable</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
   <span class="token punctuation">}</span>
   @observable mesA <span class="token operator">=</span> <span class="token string">''</span>
   @observable mesB <span class="token operator">=</span> <span class="token string">''</span>
   @action <span class="token function">setMesA</span><span class="token punctuation">(</span><span class="token parameter">mes</span><span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token keyword">this</span><span class="token punctuation">.</span>mesA <span class="token operator">=</span> mes <span class="token punctuation">}</span>
   @action <span class="token function">setMesB</span><span class="token punctuation">(</span><span class="token parameter">mes</span><span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token keyword">this</span><span class="token punctuation">.</span>mesB <span class="token operator">=</span> mes <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">new</span> <span class="token class-name">Communi</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>组件通信：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>@<span class="token function">inject</span><span class="token punctuation">(</span><span class="token string">'Communi'</span><span class="token punctuation">)</span>
@observer
<span class="token keyword">class</span> <span class="token class-name">ComponentA</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span><span class="token punctuation">{</span> <span class="token comment">/* 组件A */</span>
    state<span class="token operator">=</span><span class="token punctuation">{</span> <span class="token literal-property property">CompAsay</span><span class="token operator">:</span><span class="token string">''</span><span class="token punctuation">}</span>
    <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">const</span> <span class="token punctuation">{</span> CompAsay <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state
        <span class="token keyword">const</span> <span class="token punctuation">{</span> mesB  <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>Communi
        <span class="token keyword">return</span> <span class="token operator">&lt;</span>div className<span class="token operator">=</span><span class="token string">&quot;box&quot;</span> <span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>p<span class="token operator">&gt;</span>我是组件<span class="token constant">A</span><span class="token operator">&lt;</span><span class="token operator">/</span>p<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>div<span class="token operator">&gt;</span> <span class="token constant">B</span>组件对我说：<span class="token punctuation">{</span>mesB<span class="token punctuation">}</span> <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
        我对<span class="token constant">B</span>组件说： <span class="token operator">&lt;</span>input onChange<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">CompAsay</span> <span class="token operator">:</span>e<span class="token punctuation">.</span>target<span class="token punctuation">.</span>value <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">}</span> placeholder<span class="token operator">=</span><span class="token string">&quot;CompAsay&quot;</span> <span class="token operator">/</span><span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>Communi<span class="token punctuation">.</span><span class="token function">setMesA</span><span class="token punctuation">(</span>CompAsay<span class="token punctuation">)</span><span class="token punctuation">}</span> <span class="token operator">&gt;</span>确定<span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
@<span class="token function">inject</span><span class="token punctuation">(</span><span class="token string">'Communi'</span><span class="token punctuation">)</span>
@observer
<span class="token keyword">class</span> <span class="token class-name">ComponentB</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span><span class="token punctuation">{</span> <span class="token comment">/* 组件B */</span>
   state<span class="token operator">=</span><span class="token punctuation">{</span> <span class="token literal-property property">compBsay</span><span class="token operator">:</span><span class="token string">''</span><span class="token punctuation">}</span>
   <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
       <span class="token keyword">const</span> <span class="token punctuation">{</span> compBsay <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state
       <span class="token keyword">const</span> <span class="token punctuation">{</span>  mesA  <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>Communi
       <span class="token keyword">return</span> <span class="token operator">&lt;</span>div className<span class="token operator">=</span><span class="token string">&quot;box pt50&quot;</span> <span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>p<span class="token operator">&gt;</span>我是组件<span class="token constant">B</span><span class="token operator">&lt;</span><span class="token operator">/</span>p<span class="token operator">&gt;</span>
           <span class="token operator">&lt;</span>div<span class="token operator">&gt;</span> <span class="token constant">A</span>组件对我说：<span class="token punctuation">{</span>mesA<span class="token punctuation">}</span> <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
           我对<span class="token constant">A</span>组件说：<span class="token operator">&lt;</span>input onChange<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">compBsay</span> <span class="token operator">:</span>e<span class="token punctuation">.</span>target<span class="token punctuation">.</span>value <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">}</span>  placeholder<span class="token operator">=</span><span class="token string">&quot;CompAsay&quot;</span> <span class="token operator">/</span><span class="token operator">&gt;</span>
           <span class="token operator">&lt;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>Communi<span class="token punctuation">.</span><span class="token function">setMesB</span><span class="token punctuation">(</span>compBsay<span class="token punctuation">)</span><span class="token punctuation">}</span> <span class="token operator">&gt;</span>确定<span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">&gt;</span>
       <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br></div></div><h2 id="mobx-实现原理"><a href="#mobx-实现原理" class="header-anchor">#</a> Mobx 实现原理</h2> <p>可以从三个角度分析 mobx 和 mobx-react 整个流程：</p> <ul><li>初始化：首先就是 mobx 在初始化的时候，是如何处理 observable 可观察属性的。</li> <li>依赖收集：第二点就是通过 mobx-react 中的 observer ，如何收集依赖项，与 observable 建立起关系的。</li> <li>派发更新：最后就是当改变可观察属性的值的时候，如何更新对应组件的。</li></ul> <h3 id="模块初始化"><a href="#模块初始化" class="header-anchor">#</a> 模块初始化</h3> <p>首先被 observable 装饰器包裹的属性到底做了些什么呢？</p> <h4 id="绑定状态-observable"><a href="#绑定状态-observable" class="header-anchor">#</a> 绑定状态 —— observable</h4> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// mobx/src/api/observable.ts</span>
<span class="token keyword">function</span> <span class="token function">createObservable</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span>name<span class="token punctuation">,</span>descriptor</span><span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token comment">// 对于如上DEMO1，target——Root类，name——属性名称 authorInfo 或者 name ，descriptor——属性描述，枚举性，可读性等</span>
     <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">isStringish</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token comment">/* 装饰器模式下 */</span>
         target<span class="token punctuation">[</span><span class="token function">Symbol</span><span class="token punctuation">(</span><span class="token string">&quot;mobx-stored-annotations&quot;</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token comment">/* 向类的mobx-stored-annotations属性的name属性上，绑定 annotationType_ ， extend_ 等方法。 */</span>
            <span class="token literal-property property">annotationType_</span><span class="token operator">:</span> <span class="token string">'observable'</span><span class="token punctuation">,</span>  <span class="token comment">//这个标签证明是 observable，除了observable，还有 action， computed 等。</span>
            <span class="token literal-property property">options_</span><span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
            make_<span class="token punctuation">,</span>  <span class="token comment">// 这个方法在类组件 makeObservable 会被激活</span>
            extend_ <span class="token comment">// 这个方法在类组件 makeObservable 会被激活</span>
        <span class="token punctuation">}</span>
     <span class="token punctuation">}</span>       
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">make_</span><span class="token punctuation">(</span><span class="token parameter">adm<span class="token punctuation">,</span>key<span class="token punctuation">,</span>descriptor</span><span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token comment">/*  */</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">extend_</span><span class="token punctuation">(</span>adm<span class="token punctuation">,</span>key<span class="token punctuation">,</span>descriptor<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">extend_</span><span class="token punctuation">(</span><span class="token parameter">adm<span class="token punctuation">,</span>key<span class="token punctuation">,</span>descriptor</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> adm<span class="token punctuation">.</span><span class="token function">defineObservableProperty_</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span>descriptor<span class="token punctuation">,</span>options<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><ul><li>被 observable 装饰器包装的属性，本质上就是调用createObservable 方法。</li> <li>通过 createObservable 将类上绑定当前 observable 对应的配置项，说白了，就是给 observable 绑定的属性添加一些额外的状态，这些状态将在类实例化的时候 makeObservable 中被激活。</li></ul> <p>当调用 observable 配置项的 make_，本质上调用 <code>adm.defineObservableProperty_</code></p> <h4 id="激活状态-makeobservable"><a href="#激活状态-makeobservable" class="header-anchor">#</a> 激活状态 —— makeObservable</h4> <p>在新版本 mobx 中，必须在类的 constructor 中调用 <code>makeObservable(this)</code> 才能建立响应式</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">makeObservable</span> <span class="token punctuation">(</span><span class="token parameter">target</span><span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token comment">// target 模块实例——this</span>
    <span class="token keyword">const</span> adm <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObservableObjectAdministration</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span> <span class="token comment">/* 创建一个管理者——这个管理者是最上层的管理者，管理模块下的observable属性 */</span>
    target<span class="token punctuation">[</span><span class="token function">Symbol</span><span class="token punctuation">(</span><span class="token string">&quot;mobx administration&quot;</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> adm  <span class="token comment">/* 将管理者 adm 和 class 实例建立起关联 */</span>
    <span class="token function">startBatch</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">try</span><span class="token punctuation">{</span>
        <span class="token keyword">let</span> annotations <span class="token operator">=</span> target<span class="token punctuation">[</span><span class="token function">Symbol</span><span class="token punctuation">(</span><span class="token string">&quot;mobx-stored-annotations&quot;</span><span class="token punctuation">]</span> <span class="token comment">/* 上面第一步说到，获取状态 */</span>
        Reflect<span class="token punctuation">.</span><span class="token function">ownKeys</span><span class="token punctuation">(</span>annotations<span class="token punctuation">)</span>  <span class="token comment">/* 得到每个状态名称 */</span>
        <span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">key</span> <span class="token operator">=&gt;</span> adm<span class="token punctuation">.</span><span class="token function">make_</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> annotations<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">/* 对每个属性调用 */</span>
    <span class="token punctuation">}</span><span class="token keyword">finally</span><span class="token punctuation">{</span>
        <span class="token function">endBatch</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>makeObservable 主要做的事有以下两点：</p> <ul><li>创建一个管理者 ObservableAdministration ，上面讲到过，管理者就是为了管理子代属性的 ObservableValue 。并和模块实例建立起关系。</li> <li>然后会遍历观察者状态下的每一个属性，将每个属性通过adm.make_处理，值得注意的是，这个make_是管理者的，并不是属性状态的make_，这一点不要弄混淆了。</li></ul> <p>接下来一起看一下，管理者 ObservableAdministration 里面是如何管理状态的。</p> <h4 id="观察者属性管理者-observableadministration"><a href="#观察者属性管理者-observableadministration" class="header-anchor">#</a> 观察者属性管理者 —— ObservableAdministration</h4> <p>上述初始化创建的管理者，调用的是 <code>ObservableObjectAdministration</code> ，实际在 mobx 内部会存在多个种类的管理者，比如数组，对象数据类型。因为不同的类型，里面的方法和状态都是不同的。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">ObservableObjectAdministration</span><span class="token punctuation">{</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">target_<span class="token punctuation">,</span>values_</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>target_ <span class="token operator">=</span> target_
        <span class="token keyword">this</span><span class="token punctuation">.</span>values_ <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">//存放每一个属性的ObserverValue。</span>
    <span class="token punctuation">}</span>
    <span class="token comment">/* 调用 ObserverValue的 get —— 收集依赖  */</span>
    <span class="token function">getObservablePropValue_</span><span class="token punctuation">(</span><span class="token parameter">key</span><span class="token punctuation">)</span><span class="token punctuation">{</span> 
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>values_<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token operator">!</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment">/* 调用 ObserverValue的 setNewValue_   */</span>
    <span class="token function">setObservablePropValue_</span><span class="token punctuation">(</span><span class="token parameter">key<span class="token punctuation">,</span>newValue</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">const</span> observable <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>values_<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>
        observable<span class="token punctuation">.</span><span class="token function">setNewValue_</span><span class="token punctuation">(</span>newValue<span class="token punctuation">)</span> <span class="token comment">/* 设置新值 */</span>
    <span class="token punctuation">}</span>
    <span class="token function">make_</span><span class="token punctuation">(</span><span class="token parameter">key<span class="token punctuation">,</span>annotation</span><span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token comment">// annotation 为每个observable对应的配置项的内容，{ make_,extends }</span>
        <span class="token keyword">const</span> outcome <span class="token operator">=</span> annotation<span class="token punctuation">.</span><span class="token function">make_</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> key<span class="token punctuation">,</span> descriptor<span class="token punctuation">,</span> source<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment">/* 这个函数很重要，用于劫持对象上的get,set */</span>
    <span class="token function">defineObservableProperty_</span><span class="token punctuation">(</span><span class="token parameter">key<span class="token punctuation">,</span>value</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">try</span><span class="token punctuation">{</span>
            <span class="token function">startBatch</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">const</span> descriptor <span class="token operator">=</span> <span class="token punctuation">{</span>
                <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>      <span class="token comment">// 当我们引用对象下的属性，实际上触发的是 getObservablePropValue_</span>
                   <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getObservablePropValue_</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token function">set</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token comment">// 当我们改变对象下的属性，实际上触发的是 setObservablePropValue_</span>
                   <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setObservablePropValue_</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span>value<span class="token punctuation">)</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>target_<span class="token punctuation">,</span> key <span class="token punctuation">,</span> descriptor<span class="token punctuation">)</span>
            <span class="token keyword">const</span> observable <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObservableValue</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token comment">// 创建一个 ObservableValue</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>values_<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> observable<span class="token punctuation">)</span>             <span class="token comment">// 设置observable到value中</span>
        <span class="token punctuation">}</span><span class="token keyword">finally</span><span class="token punctuation">{</span>
            <span class="token function">endBatch</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br></div></div><p>当 mobx 底层遍历观察者属性，然后调用 <code>make_</code> 方法的时候，本质上调用的是如上 <code>make_</code> 方法，会激活当前的 observable 属性，触发 observable 配置项上的 <code>make_</code> 方法，然后就会进入真正的添加观察者属性环节 <code>defineObservableProperty_</code> 。</p> <ul><li>首先会通过 <code>Object.defineProperty</code> ，拦截对象的属性，添加get，set ，比如组件中引用对象上的属性，调用 get ——本质上调用 <code>getObservablePropValue_</code>，在 observableValues 调用的是 get 方法；当修改对象上的属性，调用 set ——本质上调用 <code>setObservablePropValue_</code>，<code>setObservablePropValue_</code> 调用的是 ObservableValues 上的 <code>setNewValue_</code> 方法。</li> <li>对于每一个属性会增加一个观察者 ObservableValue ，然后把当前 ObservableValue 放入管理者 ObservableAdministration 的 <code>values_</code> 属性上。</li></ul> <p><img src="/blog/images/react/mobx2.png" alt="mobx2"></p> <h3 id="依赖收集"><a href="#依赖收集" class="header-anchor">#</a> 依赖收集</h3> <h4 id="观察者-observablevalue"><a href="#观察者-observablevalue" class="header-anchor">#</a> 观察者 —— ObservableValue</h4> <p>只要通过 <code>@observable</code> 包裹，就会创建一个 <code>ObservableValue</code> 。</p> <p>在 Mobx 有一个核心的思想就是 Atom 主要是收集依赖，通知依赖。先来看一下 Atom 的重点方法:</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// mobx/src/core/atom.ts</span>
<span class="token keyword">class</span> <span class="token class-name">Atom</span><span class="token punctuation">{</span>
    observers_ <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">/* 存放每个组件的 */</span>
    <span class="token comment">/* value改变，通知更新 */</span>
    <span class="token function">reportChanged</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">startBatch</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token function">propagateChanged</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
        <span class="token function">endBatch</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment">/* 收集依赖 */</span>
    <span class="token function">reportObserved</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">reportObserved</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>ObservableValue 继承了 Atom。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// mobx/src/types/observablevalue.ts</span>
<span class="token keyword">class</span> <span class="token class-name">ObservableValue</span> <span class="token keyword">extends</span> <span class="token class-name">Atom</span><span class="token punctuation">{</span>
    <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token comment">//adm.getObservablePropValue_ 被调用</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">reportObserved</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 调用Atom中 reportObserved</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">dehanceValue</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>value_<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token function">setNewValue_</span><span class="token punctuation">(</span><span class="token parameter">newValue</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// adm.setObservablePropValue_</span>
        <span class="token keyword">const</span> oldValue <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>value_
        <span class="token keyword">this</span><span class="token punctuation">.</span>value_ <span class="token operator">=</span> newValue
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">reportChanged</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment">// 调用Atom中reportChanged</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>重点看一下在观察者属性管理者最终调用的两个方法 —— <code>get</code> 和 <code>setNewValue_</code></p> <h4 id="注入模块-provider-和-inject-mobx-react"><a href="#注入模块-provider-和-inject-mobx-react" class="header-anchor">#</a> 注入模块 —— Provider 和 inject（mobx-react）</h4> <p>Provider：mobx-react 中的 Provider 非常简单，就是创建一个上下文 context ，并通过 context.Provider 传递上下文。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// mobx-react/src/Provider.tsx</span>
<span class="token keyword">const</span> MobXProviderContext <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">createContext</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">Provider</span><span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">/* ... */</span>
    <span class="token keyword">return</span> <span class="token operator">&lt;</span>MobXProviderContext<span class="token punctuation">.</span>Provider value<span class="token operator">=</span><span class="token punctuation">{</span>value<span class="token punctuation">}</span><span class="token operator">&gt;</span><span class="token punctuation">{</span>children<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>MobXProviderContext<span class="token punctuation">.</span>Provider<span class="token operator">&gt;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>inject：inject 作用很简单，就是将 mobx 的状态，从 context 中混入 props 中。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// mobx-react/src/inject.ts</span>
<span class="token keyword">function</span> <span class="token function">inject</span><span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>storeNames</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
   <span class="token keyword">const</span> Injector <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">forwardRef</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">props<span class="token punctuation">,</span> ref</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
        <span class="token keyword">let</span> newProps <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token operator">...</span>props <span class="token punctuation">}</span>
        <span class="token keyword">const</span> context <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">useContext</span><span class="token punctuation">(</span>MobXProviderContext<span class="token punctuation">)</span>
        storeNames<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">storeName</span><span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token comment">//storeNames - [ 'Root' ]</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>storeName <span class="token keyword">in</span> newProps<span class="token punctuation">)</span> <span class="token keyword">return</span> 
            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>storeName <span class="token keyword">in</span> context<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token comment">/* 将mobx状态从context中混入到props中。 */</span>
                newProps<span class="token punctuation">[</span>storeName<span class="token punctuation">]</span> <span class="token operator">=</span> context<span class="token punctuation">[</span>storeName<span class="token punctuation">]</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> React<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span>component<span class="token punctuation">,</span> newProps<span class="token punctuation">)</span>
   <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
   <span class="token keyword">return</span> Injector 
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><h4 id="可观察组件-observer-mobx-react"><a href="#可观察组件-observer-mobx-react" class="header-anchor">#</a> 可观察组件 —— observer（ mobx-react ）</h4> <p>被 observe 的组件，被赋予一项功能，就是可观察的，当里面引用了 mobx 中的 ObservableValue ，当 ObservableValue 改变，组件会更新。 接下来就是核心了，需要看一下被 observe 包裹的组件会有哪些新特征，以及如何收集的依赖，又是如何更新的。被 observe 的组件分为函数组件和类组件两种情况。这里只讲了类组件的情况。</p> <p>observer：到这里基本可以弄清楚 mobx-react 中 observer HOC 的作用了——渲染 render 的劫持。通过劫持 render 函数执行，收集里面的依赖。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// mobx-react/src/observer.tsx</span>
<span class="token keyword">function</span> <span class="token function">observer</span><span class="token punctuation">(</span><span class="token parameter">componentClass</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">/* componentClass 是类组件的情况 (函数组件我们暂且忽略) */</span>
    <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token function">makeClassComponentObserver</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">const</span> target <span class="token operator">=</span> componentClass<span class="token punctuation">.</span>prototype
        <span class="token keyword">const</span> baseRender <span class="token operator">=</span> target<span class="token punctuation">.</span>render <span class="token comment">/* 这个是原来组件的render */</span>
        <span class="token comment">/* 劫持render函数 */</span>
        target<span class="token punctuation">.</span><span class="token function-variable function">render</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token function">makeComponentReactive</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> baseRender<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>makeComponentReactive：通过改造 render 函数，来实现依赖的收集，里面包含了很多核心流程。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// mobx-react/src/observerClass.ts</span>
<span class="token keyword">function</span> <span class="token function">makeComponentReactive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">const</span> baseRender <span class="token operator">=</span> <span class="token function">render</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token comment">// baseRender为真正的render方法</span>
     <span class="token comment">/* 创建一个反应器，绑定类组件的更新函数 —— forceUpdate  */</span>
     <span class="token keyword">const</span> reaction <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Reaction</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>initialName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.render()</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
          <span class="token class-name">Component</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function">forceUpdate</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token comment">/* forceUpdate 为类组件更新函数 */</span>
     <span class="token punctuation">}</span><span class="token punctuation">)</span>
    reaction<span class="token punctuation">[</span><span class="token string">&quot;reactComponent&quot;</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">this</span>    <span class="token comment">/* Reaction 和 组件实例建立起关联 */</span>
    reactiveRender<span class="token punctuation">[</span><span class="token string">&quot;$mobx&quot;</span><span class="token punctuation">]</span> <span class="token operator">=</span> reaction
    <span class="token keyword">this</span><span class="token punctuation">.</span>render <span class="token operator">=</span> reactiveRender 
    <span class="token keyword">function</span> <span class="token function">reactiveRender</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">/* 改造的响应式render方法 */</span>
        reaction<span class="token punctuation">.</span><span class="token function">track</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>  <span class="token comment">// track中进行真正的依赖收集</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                rendering <span class="token operator">=</span> <span class="token function">baseRender</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">/* 执行更新函数 */</span>
            <span class="token punctuation">}</span> 
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> rendering
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token function">reactiveRender</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><ul><li>每一个组件会创建一个 Reaction，Reaction 的第二个参数内部封装了更新组件的方法。那么如果触发可观察属性的 set ，那么最后触发更新的就是这个方法，对于类组件本质上就是的 forceUpdate 方法。</li> <li>对 render 函数进行改造，改造成 reactiveRender ，在 reactiveRender 中，reaction.track 是真正的进行依赖的收集，track 回调函数中，执行真正的 render 方法，得到 element 对象 rendering 。</li></ul> <h4 id="反应器-reaction"><a href="#反应器-reaction" class="header-anchor">#</a> 反应器 —— Reaction</h4> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">Reaction</span><span class="token punctuation">{</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">name_<span class="token punctuation">,</span>onInvalidate_</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
       <span class="token keyword">this</span><span class="token punctuation">.</span>name_ <span class="token operator">=</span> name_
       <span class="token keyword">this</span><span class="token punctuation">.</span>onInvalidate_ <span class="token operator">=</span> onInvalidate_ <span class="token comment">/* onInvalidate_ 里面有组件的forceUpdate函数，用于更新组件 */</span>
    <span class="token punctuation">}</span>
    <span class="token function">onBecomeStale_</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">schedule_</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">/* 触发调度更新 */</span>
    <span class="token punctuation">}</span>
    <span class="token comment">/* 开启调度更新 */</span>
    <span class="token function">schedule_</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
       <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>isScheduled_<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>isScheduled_ <span class="token operator">=</span> <span class="token boolean">true</span>
            globalState<span class="token punctuation">.</span>pendingReactions<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
            <span class="token function">runReactions</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">/* 更新 */</span>
    <span class="token function">runReaction_</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">startBatch</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>isScheduled_ <span class="token operator">=</span> <span class="token boolean">false</span>
        <span class="token keyword">const</span> prev <span class="token operator">=</span> globalState<span class="token punctuation">.</span>trackingContext
        globalState<span class="token punctuation">.</span>trackingContext <span class="token operator">=</span> <span class="token keyword">this</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">onInvalidate_</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">/* 更新组件  */</span>
        globalState<span class="token punctuation">.</span>trackingContext <span class="token operator">=</span> prev
        <span class="token function">endBatch</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment">/* 收集依赖 */</span>
    <span class="token function">track</span><span class="token punctuation">(</span><span class="token parameter">fn</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">startBatch</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment">/* 第一阶段 */</span>
        <span class="token keyword">const</span> prevTracking <span class="token operator">=</span> globalState<span class="token punctuation">.</span>trackingDerivation
        globalState<span class="token punctuation">.</span>trackingDerivation <span class="token operator">=</span> <span class="token keyword">this</span>
        <span class="token comment">/* 第二阶段 */</span>
        <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token function">fn</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span>
        globalState<span class="token punctuation">.</span>trackingDerivation <span class="token operator">=</span> prevTracking
        <span class="token comment">/* 第三阶段 */</span>
        <span class="token function">bindDependencies</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> 
    <span class="token punctuation">}</span>
 <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br></div></div><ul><li><p>第一阶段： 首先在执行 track 的时候，会把全局变量的 trackingDerivation，指向当前的 trackingDerivation 。这样在收集依赖的过程中，可以直接收集当前的 trackingDerivation ，也就是为什么 ObservableValue 能精确收集每一个 Reaction 。</p></li> <li><p>第二阶段：首先当被 observer 包装的组件，只要执行 render 函数，就会执行 track 方法，fn.call(context)，真正的r ender 函数会在里面执行，如果在 render 的过程中，引用了 mobx 可观察模块，比如：</p></li></ul> <div class="language-js line-numbers-mode"><pre class="language-js"><code>@<span class="token function">inject</span><span class="token punctuation">(</span><span class="token string">'Root'</span><span class="token punctuation">)</span>
<span class="token keyword">class</span> <span class="token class-name">Index</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span><span class="token punctuation">{</span>
    <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token operator">&lt;</span>div<span class="token operator">&gt;</span> 
           <span class="token operator">&lt;</span>p<span class="token operator">&gt;</span><span class="token punctuation">{</span> <span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>Root<span class="token punctuation">.</span>name <span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>p<span class="token operator">&gt;</span> 
           <span class="token operator">&lt;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>Root<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token string">'《React进阶实践指南》666'</span><span class="token punctuation">)</span><span class="token punctuation">}</span> <span class="token operator">&gt;</span>改变Mobx中name<span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>当如上 render 执行的时候，首先会触发 track ，将当前Reaction 赋值给 trackingDerivation ，然后访问了 Root 下面的name 属性，那么首先会触发观察状态管理者的 adm 的 getObservablePropValue_ ，接下来会触发 name 属性的观察者 ObservableValue 下面的 get 方法，最后执行的是 reportObserved(this):</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">reportObserved</span><span class="token punctuation">(</span><span class="token parameter">observable</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">/* 此时获取到当前函数对应的 Reaction。 */</span>
    <span class="token keyword">const</span> derivation <span class="token operator">=</span> globalState<span class="token punctuation">.</span>trackingDerivation 
    <span class="token comment">/* 将当前的 observable 存放到 Reaction 的 newObserving_ 中。 */</span>
    derivation<span class="token punctuation">.</span>newObserving_<span class="token operator">!</span><span class="token punctuation">[</span>derivation<span class="token punctuation">.</span>unboundDepsCount_<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> observable 
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>reportObserved 做的事情非常直接，就是将当前的 observable 放入 Reaction 的 newObserving_ 中，这样就把观察者属性（如上例子中的name）和组件对应的 Reaction 建立起关联。</p> <ul><li>第三阶段：当组件中 render 函数执行完毕，也就是 jsx 中的依赖全部收集完成，就会到第三阶段，上述只是 ObservableValue 到 Reaction 收集，但是没有 Reaction 到 ObservableValue ，也就是说 ObservableValue 里面还没有组件的 Reaction：</li></ul> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">bindDependencies</span><span class="token punctuation">(</span><span class="token parameter">Reaction</span><span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token comment">/* 当前组件的 Reaction */</span>
    <span class="token keyword">const</span> prevObserving <span class="token operator">=</span> derivation<span class="token punctuation">.</span>observing_ <span class="token comment">/* 之前的observing_ */</span>
    <span class="token keyword">const</span> observing <span class="token operator">=</span> <span class="token punctuation">(</span>derivation<span class="token punctuation">.</span>observing_ <span class="token operator">=</span> derivation<span class="token punctuation">.</span>newObserving_<span class="token operator">!</span><span class="token punctuation">)</span> <span class="token comment">/* 新的observing_  */</span>
    <span class="token keyword">let</span> l <span class="token operator">=</span> prevObserving<span class="token punctuation">.</span>length
    <span class="token keyword">while</span> <span class="token punctuation">(</span>l<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">/* observableValue 删除之前的 Reaction  */</span>
        <span class="token keyword">const</span> observableValue <span class="token operator">=</span> prevObserving<span class="token punctuation">[</span>l<span class="token punctuation">]</span>
        observable<span class="token punctuation">.</span>observers_<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>Reaction<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">let</span> i0 <span class="token operator">=</span> observing<span class="token punctuation">.</span>length 
    <span class="token keyword">while</span> <span class="token punctuation">(</span>i0<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">/* 给renderhanobservableValue重新添加 Reaction  */</span>
        <span class="token keyword">const</span> observableValue <span class="token operator">=</span> observing<span class="token punctuation">[</span>i0<span class="token punctuation">]</span>
         observable<span class="token punctuation">.</span>observers_<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>Reaction<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>bindDependencies 主要做的事情如下：</p> <ol><li>对于有当前 Reaction的 observableValue，observableValue会统一删除掉里面的 Reaction。</li> <li>会给这一次 render 中用到的新的依赖 observableValue ，统一添加当前的 Reaction 。</li> <li>还会有一些细节，比如说在 render 中，引入两次相同的值（如上的 demo 中的 name ），会统一收集一次依赖。</li></ol> <p><img src="/blog/images/react/mobx3.png" alt="mobx3"></p> <h3 id="派发更新"><a href="#派发更新" class="header-anchor">#</a> 派发更新</h3> <p>接下来就是一次更新中，比如在 demo 中点击按钮，通过 action ，改变 mobx 中的 name 属性。那么会发生什么呢?</p> <ul><li><p>第一步： 首先对于观察者属性管理者 ObservableAdministration 会触发 setObservablePropValue_，然后找到对应的 ObservableValue 触发 setNewValue_ 方法。</p></li> <li><p>第二步： setNewValue_ 本质上会触发Atom中的reportChanged ，然后调用 propagateChanged。首先来看一下propagateChanged</p></li></ul> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// mobx/src/core/observable.ts</span>
<span class="token keyword">function</span> <span class="token function">propagateChanged</span><span class="token punctuation">(</span><span class="token parameter">observable</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    observable<span class="token punctuation">.</span>observers_<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">Reaction</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
        Reaction<span class="token punctuation">.</span><span class="token function">onBecomeStale_</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>调用 propagateChanged 触发，依赖于当前组件的所有 Reaction 会触发 onBecomeStale_ 方法。</p> <ul><li>第三步： Reaction 的 onBecomeStale_触发，会让Reaction 的 schedule_ 执行，注意一下这里 schedule_会开启更新调度。什么叫更新调度呢。就是 schedule_ 并不会马上执行组件更新，而是把当前的 Reaction 放入 globalState.pendingReactions（待更新 Reaction 队列）中，然后会执行 runReactions 外部方法。</li></ul> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// mobx/src/core/reaction.ts</span>
<span class="token keyword">function</span> <span class="token function">runReactions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>globalState<span class="token punctuation">.</span>inBatch <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">||</span> globalState<span class="token punctuation">.</span>isRunningReactions<span class="token punctuation">)</span> <span class="token keyword">return</span>
    globalState<span class="token punctuation">.</span>isRunningReactions <span class="token operator">=</span> <span class="token boolean">true</span>
    <span class="token keyword">const</span> allReactions <span class="token operator">=</span> globalState<span class="token punctuation">.</span>pendingReactions
    <span class="token comment">/* 这里的代码是经过修改过后的，源码中要比 */</span>
    allReactions<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">Reaction</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
         <span class="token comment">/* 执行每一个组件的更新函数 */</span>
         Reaction<span class="token punctuation">.</span><span class="token function">runReaction_</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    globalState<span class="token punctuation">.</span>pendingReactions <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    globalState<span class="token punctuation">.</span>isRunningReactions <span class="token operator">=</span> <span class="token boolean">false</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><ul><li>第四步： 执行每一个 Reaction ，当一个 <code>ObservableValue</code> 的属性值改变，可以收集了多个组件的依赖，所以 mobx 用这个调度机制，先把每一个 Reaction 放入 <code>pendingReactions</code> 中，然后集中处理这些 Reaction ， Reaction 会触发 <code>runReaction_()</code> 方法，会触发 <code>onInvalidate_</code> —— 类组件的 forceupdate 方法完成组件更新。</li></ul> <p><img src="/blog/images/react/mobx4.png" alt="mobx4"></p> <h3 id="mobx-与-redux-区别"><a href="#mobx-与-redux-区别" class="header-anchor">#</a> Mobx 与 Redux 区别</h3> <ul><li>首先在 Mobx 在上手程度上，要优于 Redux ，比如 Redux 想使用异步，需要配合中间价，流程比较复杂。</li> <li>Redux 对于数据流向更规范化，Mobx 中数据更加多样化，允许数据冗余。</li> <li>Redux 整体数据流向简单，Mobx 依赖于 Proxy， Object.defineProperty 等，劫持属性 get ，set ，数据变化多样性。</li> <li>Redux 可拓展性比较强，可以通过中间件自定义增强 dispatch 。
在 Redux 中，基本有一个 store ，统一管理 store 下的状态，在 mobx 中可以有多个模块，可以理解每一个模块都是一个 store ，相互之间是独立的。</li></ul></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/blog/react/warmup/react-redux.html" class="prev">
        React Rudex
      </a></span> <span class="next"><a href="/blog/react/warmup/react-keepalive.html">
        实现 KeepAlive
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----><!----><!----><!----></div></div>
    <script src="/blog/assets/js/app.5c0d645f.js" defer></script><script src="/blog/assets/js/2.dec2e75d.js" defer></script><script src="/blog/assets/js/1.5b9e135c.js" defer></script><script src="/blog/assets/js/168.196a44b6.js" defer></script><script src="/blog/assets/js/20.badbb211.js" defer></script>
  </body>
</html>
