<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>React HOC | 前端那些事儿</title>
    <meta name="generator" content="VuePress 1.9.10">
    <link rel="icon" href="/blog/logo.png">
    <link rel="manifest" href="/blog/manifest.json">
    <link rel="apple-touch-icon" href="/blog/images/icons/apple-icon-152x152.png">
    <meta name="description" content="我命由我不由天，学习吧少年">
    <meta name="theme-color" content="#3eaf7c">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="msapplication-TileImage" content="/icons/ms-icon-144x144.png">
    <meta name="msapplication-TileColor" content="#000000">
    
    <link rel="preload" href="/blog/assets/css/0.styles.f0017422.css" as="style"><link rel="preload" href="/blog/assets/js/app.41ab4ac0.js" as="script"><link rel="preload" href="/blog/assets/js/2.dec2e75d.js" as="script"><link rel="preload" href="/blog/assets/js/1.5b9e135c.js" as="script"><link rel="preload" href="/blog/assets/js/162.621bdaed.js" as="script"><link rel="preload" href="/blog/assets/js/20.badbb211.js" as="script"><link rel="prefetch" href="/blog/assets/js/10.cc7e09f3.js"><link rel="prefetch" href="/blog/assets/js/100.59df3461.js"><link rel="prefetch" href="/blog/assets/js/101.cd12a926.js"><link rel="prefetch" href="/blog/assets/js/102.ac04f52a.js"><link rel="prefetch" href="/blog/assets/js/103.3af098c4.js"><link rel="prefetch" href="/blog/assets/js/104.95f08932.js"><link rel="prefetch" href="/blog/assets/js/105.51d5c599.js"><link rel="prefetch" href="/blog/assets/js/106.c36d37bb.js"><link rel="prefetch" href="/blog/assets/js/107.65ac35b9.js"><link rel="prefetch" href="/blog/assets/js/108.6280764a.js"><link rel="prefetch" href="/blog/assets/js/109.170a9b02.js"><link rel="prefetch" href="/blog/assets/js/11.b60c9933.js"><link rel="prefetch" href="/blog/assets/js/110.489315f4.js"><link rel="prefetch" href="/blog/assets/js/111.7001a037.js"><link rel="prefetch" href="/blog/assets/js/112.c5825e87.js"><link rel="prefetch" href="/blog/assets/js/113.b2e95945.js"><link rel="prefetch" href="/blog/assets/js/114.32860076.js"><link rel="prefetch" href="/blog/assets/js/115.84165f18.js"><link rel="prefetch" href="/blog/assets/js/116.f8ba423b.js"><link rel="prefetch" href="/blog/assets/js/117.77f6ca17.js"><link rel="prefetch" href="/blog/assets/js/118.51424c74.js"><link rel="prefetch" href="/blog/assets/js/119.769451af.js"><link rel="prefetch" href="/blog/assets/js/12.c53283e7.js"><link rel="prefetch" href="/blog/assets/js/120.133672bc.js"><link rel="prefetch" href="/blog/assets/js/121.75fdfed1.js"><link rel="prefetch" href="/blog/assets/js/122.777a3a3e.js"><link rel="prefetch" href="/blog/assets/js/123.e9084f07.js"><link rel="prefetch" href="/blog/assets/js/124.e1ea02a6.js"><link rel="prefetch" href="/blog/assets/js/125.1e9d4cf9.js"><link rel="prefetch" href="/blog/assets/js/126.b901aabd.js"><link rel="prefetch" href="/blog/assets/js/127.df3fbc12.js"><link rel="prefetch" href="/blog/assets/js/128.56fa0da4.js"><link rel="prefetch" href="/blog/assets/js/129.967a6118.js"><link rel="prefetch" href="/blog/assets/js/13.6bdc6b5d.js"><link rel="prefetch" href="/blog/assets/js/130.a8ee1510.js"><link rel="prefetch" href="/blog/assets/js/131.a4636541.js"><link rel="prefetch" href="/blog/assets/js/132.8edf7dff.js"><link rel="prefetch" href="/blog/assets/js/133.88f7b1f4.js"><link rel="prefetch" href="/blog/assets/js/134.b3a2005a.js"><link rel="prefetch" href="/blog/assets/js/135.9b590269.js"><link rel="prefetch" href="/blog/assets/js/136.81b09335.js"><link rel="prefetch" href="/blog/assets/js/137.7592d9f8.js"><link rel="prefetch" href="/blog/assets/js/138.9165d13e.js"><link rel="prefetch" href="/blog/assets/js/139.b6f78c29.js"><link rel="prefetch" href="/blog/assets/js/14.c3201a23.js"><link rel="prefetch" href="/blog/assets/js/140.92e6e554.js"><link rel="prefetch" href="/blog/assets/js/141.1ba7e022.js"><link rel="prefetch" href="/blog/assets/js/142.01b4cd1a.js"><link rel="prefetch" href="/blog/assets/js/143.22a5c2e5.js"><link rel="prefetch" href="/blog/assets/js/144.b3350428.js"><link rel="prefetch" href="/blog/assets/js/145.97cbdcb8.js"><link rel="prefetch" href="/blog/assets/js/146.3864cb47.js"><link rel="prefetch" href="/blog/assets/js/147.bc3fd878.js"><link rel="prefetch" href="/blog/assets/js/148.74b01566.js"><link rel="prefetch" href="/blog/assets/js/149.7e01e7a9.js"><link rel="prefetch" href="/blog/assets/js/15.a0b9e44e.js"><link rel="prefetch" href="/blog/assets/js/150.0d9290ef.js"><link rel="prefetch" href="/blog/assets/js/151.9364550c.js"><link rel="prefetch" href="/blog/assets/js/152.705da1b4.js"><link rel="prefetch" href="/blog/assets/js/153.20a0e01c.js"><link rel="prefetch" href="/blog/assets/js/154.314a51db.js"><link rel="prefetch" href="/blog/assets/js/155.7188da21.js"><link rel="prefetch" href="/blog/assets/js/156.f3568a61.js"><link rel="prefetch" href="/blog/assets/js/157.1b67520b.js"><link rel="prefetch" href="/blog/assets/js/158.dcfdaf89.js"><link rel="prefetch" href="/blog/assets/js/159.777613f3.js"><link rel="prefetch" href="/blog/assets/js/16.491191e4.js"><link rel="prefetch" href="/blog/assets/js/160.3e1dc20c.js"><link rel="prefetch" href="/blog/assets/js/161.8f675fb2.js"><link rel="prefetch" href="/blog/assets/js/163.5e134e2e.js"><link rel="prefetch" href="/blog/assets/js/164.e0958eb9.js"><link rel="prefetch" href="/blog/assets/js/165.dbce16c1.js"><link rel="prefetch" href="/blog/assets/js/166.5adac212.js"><link rel="prefetch" href="/blog/assets/js/167.abb1e76a.js"><link rel="prefetch" href="/blog/assets/js/168.8fcf9af4.js"><link rel="prefetch" href="/blog/assets/js/169.44097da4.js"><link rel="prefetch" href="/blog/assets/js/17.89ec8c57.js"><link rel="prefetch" href="/blog/assets/js/170.351a1780.js"><link rel="prefetch" href="/blog/assets/js/171.52aec2d3.js"><link rel="prefetch" href="/blog/assets/js/172.30dab0a4.js"><link rel="prefetch" href="/blog/assets/js/173.aa81e120.js"><link rel="prefetch" href="/blog/assets/js/174.e58ef7f0.js"><link rel="prefetch" href="/blog/assets/js/175.47059761.js"><link rel="prefetch" href="/blog/assets/js/176.0afd5c25.js"><link rel="prefetch" href="/blog/assets/js/177.cb0a46b0.js"><link rel="prefetch" href="/blog/assets/js/178.b4dd86da.js"><link rel="prefetch" href="/blog/assets/js/179.94ffa8b2.js"><link rel="prefetch" href="/blog/assets/js/18.b91f1411.js"><link rel="prefetch" href="/blog/assets/js/180.23b616e3.js"><link rel="prefetch" href="/blog/assets/js/181.8e64c67d.js"><link rel="prefetch" href="/blog/assets/js/182.335f6f83.js"><link rel="prefetch" href="/blog/assets/js/183.c3a0fec5.js"><link rel="prefetch" href="/blog/assets/js/184.3f7a1d73.js"><link rel="prefetch" href="/blog/assets/js/185.892b6ea9.js"><link rel="prefetch" href="/blog/assets/js/186.77e0b7ff.js"><link rel="prefetch" href="/blog/assets/js/187.02d69278.js"><link rel="prefetch" href="/blog/assets/js/188.883dd8b7.js"><link rel="prefetch" href="/blog/assets/js/189.5633083c.js"><link rel="prefetch" href="/blog/assets/js/19.cb1f17c8.js"><link rel="prefetch" href="/blog/assets/js/190.d3bb609f.js"><link rel="prefetch" href="/blog/assets/js/191.5a9fb197.js"><link rel="prefetch" href="/blog/assets/js/192.5e5bee70.js"><link rel="prefetch" href="/blog/assets/js/193.fa9740bb.js"><link rel="prefetch" href="/blog/assets/js/194.1d1dadab.js"><link rel="prefetch" href="/blog/assets/js/195.b4d73a36.js"><link rel="prefetch" href="/blog/assets/js/196.582f6b94.js"><link rel="prefetch" href="/blog/assets/js/197.7d9a9096.js"><link rel="prefetch" href="/blog/assets/js/198.d078f860.js"><link rel="prefetch" href="/blog/assets/js/199.568ecfbf.js"><link rel="prefetch" href="/blog/assets/js/200.3ff24e17.js"><link rel="prefetch" href="/blog/assets/js/201.4b0b5a95.js"><link rel="prefetch" href="/blog/assets/js/202.aa0eca9d.js"><link rel="prefetch" href="/blog/assets/js/203.035984a9.js"><link rel="prefetch" href="/blog/assets/js/204.196be674.js"><link rel="prefetch" href="/blog/assets/js/205.0f81699b.js"><link rel="prefetch" href="/blog/assets/js/206.cb8e1f5b.js"><link rel="prefetch" href="/blog/assets/js/207.e022396a.js"><link rel="prefetch" href="/blog/assets/js/208.f3230c62.js"><link rel="prefetch" href="/blog/assets/js/209.92015cd4.js"><link rel="prefetch" href="/blog/assets/js/21.bf0041b7.js"><link rel="prefetch" href="/blog/assets/js/210.64a6d8b7.js"><link rel="prefetch" href="/blog/assets/js/211.74ce075e.js"><link rel="prefetch" href="/blog/assets/js/212.3595b5ac.js"><link rel="prefetch" href="/blog/assets/js/213.9f9afdac.js"><link rel="prefetch" href="/blog/assets/js/214.14875542.js"><link rel="prefetch" href="/blog/assets/js/215.76cf1e09.js"><link rel="prefetch" href="/blog/assets/js/216.c3283539.js"><link rel="prefetch" href="/blog/assets/js/217.71a089eb.js"><link rel="prefetch" href="/blog/assets/js/218.e5b96a8e.js"><link rel="prefetch" href="/blog/assets/js/219.d606121f.js"><link rel="prefetch" href="/blog/assets/js/22.48390d4f.js"><link rel="prefetch" href="/blog/assets/js/220.6bbbef56.js"><link rel="prefetch" href="/blog/assets/js/221.15df4558.js"><link rel="prefetch" href="/blog/assets/js/222.2c51cfe0.js"><link rel="prefetch" href="/blog/assets/js/223.5b2848c8.js"><link rel="prefetch" href="/blog/assets/js/224.80566daa.js"><link rel="prefetch" href="/blog/assets/js/23.35c4ba93.js"><link rel="prefetch" href="/blog/assets/js/24.cc3b12df.js"><link rel="prefetch" href="/blog/assets/js/25.632a83cc.js"><link rel="prefetch" href="/blog/assets/js/26.8ee6fdf8.js"><link rel="prefetch" href="/blog/assets/js/27.067ef541.js"><link rel="prefetch" href="/blog/assets/js/28.9d3cf283.js"><link rel="prefetch" href="/blog/assets/js/29.1585b3e4.js"><link rel="prefetch" href="/blog/assets/js/3.cb0627fa.js"><link rel="prefetch" href="/blog/assets/js/30.478b21d2.js"><link rel="prefetch" href="/blog/assets/js/31.6ae5d6bc.js"><link rel="prefetch" href="/blog/assets/js/32.e0a6568c.js"><link rel="prefetch" href="/blog/assets/js/33.32a5bc4c.js"><link rel="prefetch" href="/blog/assets/js/34.8505495a.js"><link rel="prefetch" href="/blog/assets/js/35.9587506d.js"><link rel="prefetch" href="/blog/assets/js/36.1142671d.js"><link rel="prefetch" href="/blog/assets/js/37.fe0b4168.js"><link rel="prefetch" href="/blog/assets/js/38.35e98df7.js"><link rel="prefetch" href="/blog/assets/js/39.01fc841b.js"><link rel="prefetch" href="/blog/assets/js/4.cbb57fa7.js"><link rel="prefetch" href="/blog/assets/js/40.5d83aef7.js"><link rel="prefetch" href="/blog/assets/js/41.42bcfcb2.js"><link rel="prefetch" href="/blog/assets/js/42.22b2ea87.js"><link rel="prefetch" href="/blog/assets/js/43.07d0541b.js"><link rel="prefetch" href="/blog/assets/js/44.0c17513c.js"><link rel="prefetch" href="/blog/assets/js/45.b795f41c.js"><link rel="prefetch" href="/blog/assets/js/46.c885282c.js"><link rel="prefetch" href="/blog/assets/js/47.0453ff86.js"><link rel="prefetch" href="/blog/assets/js/48.15365f7f.js"><link rel="prefetch" href="/blog/assets/js/49.bc2afccd.js"><link rel="prefetch" href="/blog/assets/js/5.fe065607.js"><link rel="prefetch" href="/blog/assets/js/50.d0df511a.js"><link rel="prefetch" href="/blog/assets/js/51.b335c9bb.js"><link rel="prefetch" href="/blog/assets/js/52.22d13c9a.js"><link rel="prefetch" href="/blog/assets/js/53.bea77bac.js"><link rel="prefetch" href="/blog/assets/js/54.1e1ac697.js"><link rel="prefetch" href="/blog/assets/js/55.b8be440d.js"><link rel="prefetch" href="/blog/assets/js/56.43a66ebd.js"><link rel="prefetch" href="/blog/assets/js/57.c654e3f6.js"><link rel="prefetch" href="/blog/assets/js/58.a0879de6.js"><link rel="prefetch" href="/blog/assets/js/59.aa4f40f1.js"><link rel="prefetch" href="/blog/assets/js/6.68cda050.js"><link rel="prefetch" href="/blog/assets/js/60.fd3d88ca.js"><link rel="prefetch" href="/blog/assets/js/61.ea01bbda.js"><link rel="prefetch" href="/blog/assets/js/62.7b0619c0.js"><link rel="prefetch" href="/blog/assets/js/63.e8d268a6.js"><link rel="prefetch" href="/blog/assets/js/64.10f55bc1.js"><link rel="prefetch" href="/blog/assets/js/65.d830848d.js"><link rel="prefetch" href="/blog/assets/js/66.2d4e24b5.js"><link rel="prefetch" href="/blog/assets/js/67.365908b4.js"><link rel="prefetch" href="/blog/assets/js/68.0427eb67.js"><link rel="prefetch" href="/blog/assets/js/69.1d45db14.js"><link rel="prefetch" href="/blog/assets/js/7.3b8d63a0.js"><link rel="prefetch" href="/blog/assets/js/70.29b522ad.js"><link rel="prefetch" href="/blog/assets/js/71.ef1fef96.js"><link rel="prefetch" href="/blog/assets/js/72.3e6b54aa.js"><link rel="prefetch" href="/blog/assets/js/73.ed15ce54.js"><link rel="prefetch" href="/blog/assets/js/74.218d3182.js"><link rel="prefetch" href="/blog/assets/js/75.90e06085.js"><link rel="prefetch" href="/blog/assets/js/76.566bdd84.js"><link rel="prefetch" href="/blog/assets/js/77.4de2aa95.js"><link rel="prefetch" href="/blog/assets/js/78.34148706.js"><link rel="prefetch" href="/blog/assets/js/79.69934743.js"><link rel="prefetch" href="/blog/assets/js/80.9a834463.js"><link rel="prefetch" href="/blog/assets/js/81.7267fc04.js"><link rel="prefetch" href="/blog/assets/js/82.b2fd3d9e.js"><link rel="prefetch" href="/blog/assets/js/83.8affaec3.js"><link rel="prefetch" href="/blog/assets/js/84.8d0b241f.js"><link rel="prefetch" href="/blog/assets/js/85.16b15a0e.js"><link rel="prefetch" href="/blog/assets/js/86.ef5f7196.js"><link rel="prefetch" href="/blog/assets/js/87.d8d28b3d.js"><link rel="prefetch" href="/blog/assets/js/88.d70140a1.js"><link rel="prefetch" href="/blog/assets/js/89.4b9169f0.js"><link rel="prefetch" href="/blog/assets/js/90.bc378f70.js"><link rel="prefetch" href="/blog/assets/js/91.cf3aa87b.js"><link rel="prefetch" href="/blog/assets/js/92.689c049c.js"><link rel="prefetch" href="/blog/assets/js/93.7250eb45.js"><link rel="prefetch" href="/blog/assets/js/94.a4913a58.js"><link rel="prefetch" href="/blog/assets/js/95.c3b04445.js"><link rel="prefetch" href="/blog/assets/js/96.7bfe1936.js"><link rel="prefetch" href="/blog/assets/js/97.57cf5aa1.js"><link rel="prefetch" href="/blog/assets/js/98.6c66f747.js"><link rel="prefetch" href="/blog/assets/js/99.fa0cc9e5.js"><link rel="prefetch" href="/blog/assets/js/vendors~docsearch.bd3cdb54.js">
    <link rel="stylesheet" href="/blog/assets/css/0.styles.f0017422.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/blog/" class="home-link router-link-active"><img src="/blog/logo.png" alt="前端那些事儿" class="logo"> <span class="site-name can-hide">前端那些事儿</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/blog/" class="nav-link">
  主页
</a></div><div class="nav-item"><a href="/blog/base/" class="nav-link">
  前端基础
</a></div><div class="nav-item"><a href="/blog/vue/" class="nav-link">
  Vue
</a></div><div class="nav-item"><a href="/blog/react/" class="nav-link router-link-active">
  React
</a></div><div class="nav-item"><a href="/blog/devops/" class="nav-link">
  前端工程化
</a></div><div class="nav-item"><a href="/blog/mobile/" class="nav-link">
  泛客户端
</a></div><div class="nav-item"><a href="/blog/architecture/" class="nav-link">
  架构与方案
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="GitHub" class="dropdown-title"><span class="title">GitHub</span> <span class="arrow down"></span></button> <button type="button" aria-label="GitHub" class="mobile-dropdown-title"><span class="title">GitHub</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/jonny-wei" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://github.com/jonny-wei/sushi-js" target="_blank" rel="noopener noreferrer" class="nav-link external">
  JS 寿司
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/blog/" class="nav-link">
  主页
</a></div><div class="nav-item"><a href="/blog/base/" class="nav-link">
  前端基础
</a></div><div class="nav-item"><a href="/blog/vue/" class="nav-link">
  Vue
</a></div><div class="nav-item"><a href="/blog/react/" class="nav-link router-link-active">
  React
</a></div><div class="nav-item"><a href="/blog/devops/" class="nav-link">
  前端工程化
</a></div><div class="nav-item"><a href="/blog/mobile/" class="nav-link">
  泛客户端
</a></div><div class="nav-item"><a href="/blog/architecture/" class="nav-link">
  架构与方案
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="GitHub" class="dropdown-title"><span class="title">GitHub</span> <span class="arrow down"></span></button> <button type="button" aria-label="GitHub" class="mobile-dropdown-title"><span class="title">GitHub</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/jonny-wei" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://github.com/jonny-wei/sushi-js" target="_blank" rel="noopener noreferrer" class="nav-link external">
  JS 寿司
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>React</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/react/" aria-current="page" class="sidebar-link">React JSX</a></li><li><a href="/blog/react/warmup/react-component.html" class="sidebar-link">React 组件及通信</a></li><li><a href="/blog/react/warmup/react-state.html" class="sidebar-link">React State</a></li><li><a href="/blog/react/warmup/react-props.html" class="sidebar-link">React Props</a></li><li><a href="/blog/react/warmup/react-lifecycle.html" class="sidebar-link">React 生命周期</a></li><li><a href="/blog/react/warmup/react-ref.html" class="sidebar-link">React Ref</a></li><li><a href="/blog/react/warmup/react-context.html" class="sidebar-link">React Context</a></li><li><a href="/blog/react/warmup/react-css.html" class="sidebar-link">React 中 CSS 的模块化</a></li><li><a href="/blog/react/warmup/react-hoc.html" aria-current="page" class="active sidebar-link">React HOC</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/react/warmup/react-hoc.html#高阶组件能解决什么问题" class="sidebar-link">高阶组件能解决什么问题</a></li><li class="sidebar-sub-header"><a href="/blog/react/warmup/react-hoc.html#两种不同的高阶组件" class="sidebar-link">两种不同的高阶组件</a></li><li class="sidebar-sub-header"><a href="/blog/react/warmup/react-hoc.html#高阶组件的功能" class="sidebar-link">高阶组件的功能</a></li><li class="sidebar-sub-header"><a href="/blog/react/warmup/react-hoc.html#高价组件注意事项" class="sidebar-link">高价组件注意事项</a></li><li class="sidebar-sub-header"><a href="/blog/react/warmup/react-hoc.html#hoc-实现权限拦截" class="sidebar-link">HOC 实现权限拦截</a></li><li class="sidebar-sub-header"><a href="/blog/react/warmup/react-hoc.html#从-mixin-到-hoc-再到-hook" class="sidebar-link">从 Mixin 到 HOC 再到 Hook</a></li></ul></li><li><a href="/blog/react/warmup/react-render.html" class="sidebar-link">React 渲染优化</a></li><li><a href="/blog/react/warmup/react-router.html" class="sidebar-link">React Router</a></li><li><a href="/blog/react/warmup/react-redux.html" class="sidebar-link">React Rudex</a></li><li><a href="/blog/react/warmup/react-mobx.html" class="sidebar-link">React Mobx</a></li><li><a href="/blog/react/warmup/react-keepalive.html" class="sidebar-link">实现 KeepAlive</a></li><li><a href="/blog/react/warmup/react-state-v18.html" class="sidebar-link">V18 - Automatic Batching</a></li><li><a href="/blog/react/warmup/react-transition.html" class="sidebar-link">V18 - Transition</a></li><li><a href="/blog/react/warmup/react-suspense.html" class="sidebar-link">V18 - Suspense</a></li><li><a href="/blog/react/warmup/react-useSyncExternalStore.html" class="sidebar-link">V18 - useSyncExternalStore</a></li><li><a href="/blog/react/warmup/react-ssr.html" class="sidebar-link">V18 - Streaming SSR</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>React源码解析</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/react/react/react-reconciler.html" class="sidebar-link">Reconciler 调和器</a></li><li><a href="/blog/react/react/react-priority.html" class="sidebar-link">React 优先级管理</a></li><li><a href="/blog/react/react/react-scheduler.html" class="sidebar-link">Scheduler 调度器</a></li><li><a href="/blog/react/react/react-render.html" class="sidebar-link">Render 阶段</a></li><li><a href="/blog/react/react/react-commit.html" class="sidebar-link">Commit 阶段</a></li><li><a href="/blog/react/react/react-diff.html" class="sidebar-link">React Diff 算法</a></li><li><a href="/blog/react/react/react-hooks.html" class="sidebar-link">React Hooks 理解</a></li><li><a href="/blog/react/react/react-context.html" class="sidebar-link">React Context 原理</a></li><li><a href="/blog/react/react/react-event.html" class="sidebar-link">React 事件系统</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="react-hoc"><a href="#react-hoc" class="header-anchor">#</a> React HOC</h1> <p>高阶组件可以看作 React 对装饰模式的一种实现，高阶组件就是一个函数，且该函数接受一个组件作为参数，并返回一个新的组件，他会返回一个增强的 React 组件，高阶组件可以让我们的代码更具有<strong>复用性，逻辑性与抽象性</strong>，可以对 render 方法进行劫持，也可以控制 props 与 state 等。<strong>高阶组件就是一个没有副作用的纯函数</strong>。</p> <h2 id="高阶组件能解决什么问题"><a href="#高阶组件能解决什么问题" class="header-anchor">#</a> 高阶组件能解决什么问题</h2> <p>HOC 的产生根本作用就是解决大量的<strong>代码复用，逻辑复用</strong>问题。既然说到了逻辑复用，那么具体复用了哪些逻辑呢？</p> <ul><li><p>首先第一种就是<strong>拦截问题</strong>，本质上是<strong>对渲染的控制</strong>，对渲染的控制可不仅仅指<strong>是否渲染组件</strong>，还可以像 dva 中 dynamic 那样<strong>懒加载/动态加载组件</strong>。</p></li> <li><p>还有一种场景，比如项目中想让一个非 Route 组件，也能通过 props 获取路由实现跳转，但是<strong>不想通过父级路由组件层层绑定 props</strong> ，这个时候就需要一个 HOC 把改变路由的 history 对象混入 props 中，于是 withRoute 诞生了。所以 HOC 还有一个重要的作用就是<strong>让 props 中混入一些你需要的东西</strong>。</p></li> <li><p>还有一种情况，如果不想改变组件，只是<strong>监控组件的内部状态，对组件做一些赋能</strong>，HOC 也是一个不错的选择，比如对组件内的点击事件做一些监控，或者加一次额外的生命周期，开源项目 react-keepalive-router，可以缓存页面，项目中的 keepaliveLifeCycle 就是通过 HOC 方式，给业务组件增加了额外的生命周期。</p></li></ul> <p>高阶函数就是一个将函数作为参数并且返回值也是函数的函数。高阶组件是以组件作为参数，返回组件的函数。返回的组件把传进去的组件进行功能强化。</p> <h2 id="两种不同的高阶组件"><a href="#两种不同的高阶组件" class="header-anchor">#</a> 两种不同的高阶组件</h2> <p>常用的高阶组件有<strong>属性代理</strong>和<strong>反向继承</strong>两种，两者之间有一些共性和区别</p> <h3 id="属性代理"><a href="#属性代理" class="header-anchor">#</a> 属性代理</h3> <p>属性代理，就是用组件包裹一层代理组件，在代理组件上，可以做一些，对源组件的强化操作。这里注意<strong>属性代理返回的是一个新组件，被包裹的原始组件，将在新的组件里被挂载</strong>。传入原始组件，返回新组建。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token constant">HOC</span><span class="token punctuation">(</span><span class="token parameter">WrapComponent</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">class</span> <span class="token class-name">Advance</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span><span class="token punctuation">{</span>
       state<span class="token operator">=</span><span class="token punctuation">{</span>
           <span class="token literal-property property">name</span><span class="token operator">:</span><span class="token string">'alien'</span>
       <span class="token punctuation">}</span>
       <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
           <span class="token keyword">return</span> <span class="token operator">&lt;</span>WrapComponent  <span class="token punctuation">{</span> <span class="token operator">...</span><span class="token keyword">this</span><span class="token punctuation">.</span>props <span class="token punctuation">}</span> <span class="token punctuation">{</span> <span class="token operator">...</span><span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token punctuation">}</span>  <span class="token operator">/</span><span class="token operator">&gt;</span>
       <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>优点：</p> <ul><li>属性代理可以和业务组件低耦合，零耦合，对于条件渲染和 props 属性增强，只负责控制子组件渲染和传递额外的 props 就可以了，所以无须知道，业务组件做了些什么。所以正向属性代理，更适合做一些开源项目的 HOC ，目前开源的 HOC 基本都是通过这个模式实现的。</li> <li>同样适用于类组件和函数组件。</li> <li>可以完全隔离业务组件的渲染，因为属性代理说白了是一个新的组件，相比反向继承，可以完全控制业务组件是否渲染。</li> <li>可以嵌套使用，多个 HOC 是可以嵌套使用的，而且一般不会限制包装 HOC 的先后顺序。</li></ul> <p>缺点：</p> <ul><li>一般无法直接获取原始组件的状态，如果想要获取，需要 ref 获取组件实例。</li> <li>无法直接继承静态属性。如果需要继承需要手动处理，或者引入第三方库。</li> <li>因为本质上是产生了一个新组件，所以需要配合 forwardRef 来转发 ref。</li></ul> <h3 id="反向继承"><a href="#反向继承" class="header-anchor">#</a> 反向继承</h3> <p>反向继承和属性代理有一定的区别，在于<strong>包装后的组件继承了原始组件本身</strong>，所以此时无须再去挂载业务组件。直接继承需要包装的组件（原组件）</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">Index</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span><span class="token punctuation">{</span>
  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token operator">&lt;</span>div<span class="token operator">&gt;</span> hello<span class="token punctuation">,</span>world  <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token constant">HOC</span><span class="token punctuation">(</span><span class="token parameter">Component</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">class</span> <span class="token class-name">wrapComponent</span> <span class="token keyword">extends</span> <span class="token class-name">Component</span><span class="token punctuation">{</span> <span class="token comment">/* 直接继承需要包装的组件 */</span>
        
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token constant">HOC</span><span class="token punctuation">(</span>Index<span class="token punctuation">)</span> 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>优点：</p> <ul><li>方便获取组件内部状态，比如 state ，props ，生命周期，绑定的事件函数等。</li> <li>es6继承可以良好继承静态属性。所以无须对静态属性和方法进行额外的处理。</li></ul> <p>缺点：</p> <ul><li>函数组件无法使用。</li> <li>和被包装的组件耦合度高，需要知道被包装的原始组件的内部状态，具体做了些什么？</li> <li>如果多个反向继承 HOC 嵌套在一起，当前状态会覆盖上一个状态。这样带来的隐患是非常大的，比如说有多个 componentDidMount ，当前 componentDidMount 会覆盖上一个 componentDidMount 。这样副作用串联起来，影响很大。</li></ul> <h2 id="高阶组件的功能"><a href="#高阶组件的功能" class="header-anchor">#</a> 高阶组件的功能</h2> <h3 id="强化-props"><a href="#强化-props" class="header-anchor">#</a> 强化 props</h3> <p>强化 props 就是<strong>在原始组件的 props 基础上，加入一些其他的 props ，强化原始组件功能</strong>。举个例子，为了让组件也可以获取到路由对象，进行路由跳转等操作，所以 React Router 提供了类似 withRouter 的 HOC 。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">withRouter</span><span class="token punctuation">(</span><span class="token parameter">Component</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> displayName <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">withRouter(</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>Component<span class="token punctuation">.</span>displayName <span class="token operator">||</span> Component<span class="token punctuation">.</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">)</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token function-variable function">C</span> <span class="token operator">=</span> <span class="token parameter">props</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token comment">/*  获取 */</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> wrappedComponentRef<span class="token punctuation">,</span> <span class="token operator">...</span>remainingProps <span class="token punctuation">}</span> <span class="token operator">=</span> props<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>
      <span class="token operator">&lt;</span>RouterContext<span class="token punctuation">.</span>Consumer<span class="token operator">&gt;</span>
        <span class="token punctuation">{</span><span class="token parameter">context</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token keyword">return</span> <span class="token punctuation">(</span>
            <span class="token operator">&lt;</span>Component
              <span class="token punctuation">{</span><span class="token operator">...</span>remainingProps<span class="token punctuation">}</span> <span class="token comment">// 组件原始的props </span>
              <span class="token punctuation">{</span><span class="token operator">...</span>context<span class="token punctuation">}</span>        <span class="token comment">// 存在路由对象的上下文，history  location 等 </span>
              ref<span class="token operator">=</span><span class="token punctuation">{</span>wrappedComponentRef<span class="token punctuation">}</span>
            <span class="token operator">/</span><span class="token operator">&gt;</span>
          <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">}</span>
      <span class="token operator">&lt;</span><span class="token operator">/</span>RouterContext<span class="token punctuation">.</span>Consumer<span class="token operator">&gt;</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token constant">C</span><span class="token punctuation">.</span>displayName <span class="token operator">=</span> displayName<span class="token punctuation">;</span>
  <span class="token constant">C</span><span class="token punctuation">.</span>WrappedComponent <span class="token operator">=</span> Component<span class="token punctuation">;</span>
  <span class="token comment">/* 继承静态属性 */</span>
  <span class="token keyword">return</span> <span class="token function">hoistStatics</span><span class="token punctuation">(</span><span class="token constant">C</span><span class="token punctuation">,</span> Component<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> withRouter
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><p>流程分析：</p> <ul><li>分离出 props 中 wrappedComponentRef 和 remainingProps ， remainingProps 是原始组件真正的 props， wrappedComponentRef 用于转发 ref。</li> <li>用 Context.Consumer 上下文模式获取保存的路由信息。（ React Router 中路由状态是通过 context 上下文保存传递的）</li> <li>将路由对象和原始 props 传递给原始组件，所以可以在原始组件中获取 history ，location 等信息。</li></ul> <h3 id="控制渲染"><a href="#控制渲染" class="header-anchor">#</a> 控制渲染</h3> <h4 id="渲染劫持"><a href="#渲染劫持" class="header-anchor">#</a> 渲染劫持</h4> <p>HOC 反向继承模式，可以通过 <code>super.render()</code> 得到 render 之后的内容，利用这一点，可以做渲染劫持 ，更有甚者可以修改 render 之后的 React element 对象。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token function-variable function">HOC</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">WrapComponent</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
  <span class="token keyword">class</span> <span class="token class-name">Index</span>  <span class="token keyword">extends</span> <span class="token class-name">WrapComponent</span> <span class="token punctuation">{</span>
    <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>visible<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token operator">&lt;</span>div<span class="token operator">&gt;</span>暂无数据<span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h4 id="修改渲染树"><a href="#修改渲染树" class="header-anchor">#</a> 修改渲染树</h4> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">Index</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span><span class="token punctuation">{</span>
  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token operator">&lt;</span>div<span class="token operator">&gt;</span>
       <span class="token operator">&lt;</span>ul<span class="token operator">&gt;</span>
         <span class="token operator">&lt;</span>li<span class="token operator">&gt;</span>react<span class="token operator">&lt;</span><span class="token operator">/</span>li<span class="token operator">&gt;</span>
         <span class="token operator">&lt;</span>li<span class="token operator">&gt;</span>vue<span class="token operator">&lt;</span><span class="token operator">/</span>li<span class="token operator">&gt;</span>
         <span class="token operator">&lt;</span>li<span class="token operator">&gt;</span>Angular<span class="token operator">&lt;</span><span class="token operator">/</span>li<span class="token operator">&gt;</span>
       <span class="token operator">&lt;</span><span class="token operator">/</span>ul<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token constant">HOC</span> <span class="token punctuation">(</span><span class="token parameter">Component</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">class</span> <span class="token class-name">Advance</span> <span class="token keyword">extends</span> <span class="token class-name">Component</span> <span class="token punctuation">{</span>
    <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> element <span class="token operator">=</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token keyword">const</span> otherProps <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">name</span><span class="token operator">:</span><span class="token string">'alien'</span>
      <span class="token punctuation">}</span>
      <span class="token comment">/* 替换 Angular 元素节点 */</span>
      <span class="token keyword">const</span> appendElement <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'li'</span> <span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">hello ,world , my name  is </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span> otherProps<span class="token punctuation">.</span>name <span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span> <span class="token punctuation">)</span>
      <span class="token keyword">const</span> newchild <span class="token operator">=</span>  React<span class="token punctuation">.</span>Children<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>element<span class="token punctuation">.</span>props<span class="token punctuation">.</span>children<span class="token punctuation">.</span>props<span class="token punctuation">.</span>children<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token parameter">child<span class="token punctuation">,</span>index</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
           <span class="token keyword">if</span><span class="token punctuation">(</span>index <span class="token operator">===</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">return</span> appendElement
           <span class="token keyword">return</span>  child
      <span class="token punctuation">}</span><span class="token punctuation">)</span> 
      <span class="token keyword">return</span>  React<span class="token punctuation">.</span><span class="token function">cloneElement</span><span class="token punctuation">(</span>element<span class="token punctuation">,</span> element<span class="token punctuation">.</span>props<span class="token punctuation">,</span> newchild<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">export</span>  <span class="token keyword">default</span> <span class="token constant">HOC</span><span class="token punctuation">(</span>Index<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br></div></div><h4 id="动态加载"><a href="#动态加载" class="header-anchor">#</a> 动态加载</h4> <p>dva 中 dynamic 就是配合 import ，实现组件的动态加载的，而且每次切换路由，都会有 Loading 效果，接下来看看大致的实现思路。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">dynamicHoc</span><span class="token punctuation">(</span><span class="token parameter">loadRouter</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">class</span> <span class="token class-name">Content</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>
    state <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token literal-property property">Component</span><span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">}</span>
    <span class="token function">componentDidMount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>Component<span class="token punctuation">)</span> <span class="token keyword">return</span>
      <span class="token function">loadRouter</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">module</span> <span class="token operator">=&gt;</span> module<span class="token punctuation">.</span>default<span class="token punctuation">)</span> <span class="token comment">// 动态加载 component 组件</span>
        <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">Component</span> <span class="token operator">=&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span>Component<span class="token punctuation">}</span><span class="token punctuation">,</span>
         <span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> <span class="token punctuation">{</span>Component<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state
      <span class="token keyword">return</span> Component <span class="token operator">?</span> <span class="token operator">&lt;</span>Component <span class="token punctuation">{</span>
      <span class="token operator">...</span><span class="token keyword">this</span><span class="token punctuation">.</span>props
      <span class="token punctuation">}</span>
      <span class="token operator">/</span><span class="token operator">&gt;</span> <span class="token operator">:</span> <span class="token operator">&lt;</span>Loading <span class="token operator">/</span><span class="token operator">&gt;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> Index <span class="token operator">=</span> <span class="token function">AsyncRouter</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token keyword">import</span><span class="token punctuation">(</span><span class="token string">'../pages/index'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>Index 组件中，在 componentDidMount 生命周期动态加载上述的路由组件 Component，如果在切换路由或者没有加载完毕时，显示的是 Loading 效果。</p> <h3 id="组件赋能"><a href="#组件赋能" class="header-anchor">#</a> 组件赋能</h3> <h4 id="ref-获取实例"><a href="#ref-获取实例" class="header-anchor">#</a> ref 获取实例</h4> <p>对于属性代理虽然不能直接获取组件内的状态，但是可以<strong>通过 ref 获取组件实例，获取到组件实例，就可以获取组件的一些状态，或是手动触发一些事件，进一步强化组件</strong>，但是注意的是：<strong>类组件才存在实例，函数组件不存在实例</strong>。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">Hoc</span><span class="token punctuation">(</span><span class="token parameter">Component</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">class</span> <span class="token class-name">WrapComponent</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span><span class="token punctuation">{</span>
      <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>node <span class="token operator">=</span> <span class="token keyword">null</span> <span class="token comment">/* 获取实例，可以做一些其他的操作。 */</span>
      <span class="token punctuation">}</span>
      <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token operator">&lt;</span>Component <span class="token punctuation">{</span><span class="token operator">...</span><span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">}</span>  ref<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token parameter">node</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>node <span class="token operator">=</span> node <span class="token punctuation">}</span>  <span class="token operator">/</span><span class="token operator">&gt;</span>
      <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h4 id="事件监控"><a href="#事件监控" class="header-anchor">#</a> 事件监控</h4> <p>HOC 不一定非要对组件本身做些什么？也可以单纯增加一些事件监听，错误监控。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">ClickHoc</span> <span class="token punctuation">(</span><span class="token parameter">Component</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">return</span>  <span class="token keyword">function</span> <span class="token function">Wrap</span><span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">const</span> dom <span class="token operator">=</span> <span class="token function">useRef</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span>
    <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
       <span class="token keyword">const</span> <span class="token function-variable function">handerClick</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'发生点击事件'</span><span class="token punctuation">)</span> 
       dom<span class="token punctuation">.</span>current<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">,</span>handerClick<span class="token punctuation">)</span>
     <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> dom<span class="token punctuation">.</span>current<span class="token punctuation">.</span><span class="token function">removeEventListener</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">,</span>handerClick<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span>  <span class="token operator">&lt;</span>div ref<span class="token operator">=</span><span class="token punctuation">{</span>dom<span class="token punctuation">}</span>  <span class="token operator">&gt;</span><span class="token operator">&lt;</span>Component  <span class="token punctuation">{</span><span class="token operator">...</span>props<span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

@ClickHoc
<span class="token keyword">class</span> <span class="token class-name">Index</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span><span class="token punctuation">{</span>
   <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
     <span class="token keyword">return</span> <span class="token operator">&lt;</span>div className<span class="token operator">=</span><span class="token string">'index'</span>  <span class="token operator">&gt;</span>
       <span class="token operator">&lt;</span>p<span class="token operator">&gt;</span>hello，world<span class="token operator">&lt;</span><span class="token operator">/</span>p<span class="token operator">&gt;</span>
       <span class="token operator">&lt;</span>button<span class="token operator">&gt;</span>组件内部点击<span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token operator">&lt;</span>div className<span class="token operator">=</span><span class="token string">'box'</span>  <span class="token operator">&gt;</span>
     <span class="token operator">&lt;</span>Index <span class="token operator">/</span><span class="token operator">&gt;</span>
     <span class="token operator">&lt;</span>button<span class="token operator">&gt;</span>组件外部点击<span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br></div></div><h3 id="小结"><a href="#小结" class="header-anchor">#</a> 小结</h3> <p>HOC 具体能实现以下几个功能：</p> <ol><li>强化 props ，可以通过 HOC ，向原始组件混入一些状态。</li> <li>渲染劫持，可以利用 HOC ，动态挂载原始组件，还可以先获取原始组件的渲染树，进行可控性修改。</li> <li>可以配合 import 等 api ，实现动态加载组件，实现代码分割，加入 loading 效果。</li> <li>可以通过 ref 来获取原始组件实例，操作实例下的属性和方法。</li> <li>可以对原始组件做一些事件监听，错误监控等。</li></ol> <h2 id="高价组件注意事项"><a href="#高价组件注意事项" class="header-anchor">#</a> 高价组件注意事项</h2> <h3 id="谨慎修改原型链"><a href="#谨慎修改原型链" class="header-anchor">#</a> 谨慎修改原型链</h3> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token constant">HOC</span> <span class="token punctuation">(</span><span class="token parameter">Component</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">const</span> proDidMount <span class="token operator">=</span> <span class="token class-name">Component</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>componentDidMount 
  <span class="token class-name">Component</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">componentDidMount</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
     console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'劫持生命周期：componentDidMount'</span><span class="token punctuation">)</span>
     <span class="token function">proDidMount</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span>  Component
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>如上 HOC 作用仅仅是修改了原来组件原型链上的 componentDidMount 生命周期。但是这样有一个弊端就是如果再用另外一个 HOC 修改原型链上的 componentDidMount ，那么这个 HOC 的功能即将失效。</p> <h3 id="不要在函数组件内部或类组件-render-函数中使用-hoc"><a href="#不要在函数组件内部或类组件-render-函数中使用-hoc" class="header-anchor">#</a> 不要在函数组件内部或类组件 render 函数中使用 HOC</h3> <p>错误写法</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">Index</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span><span class="token punctuation">{</span>
  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
     <span class="token keyword">const</span> WrapHome <span class="token operator">=</span> <span class="token constant">HOC</span><span class="token punctuation">(</span>Home<span class="token punctuation">)</span>
     <span class="token keyword">return</span> <span class="token operator">&lt;</span>WrapHome <span class="token operator">/</span><span class="token operator">&gt;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">Index</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
     <span class="token keyword">const</span> WrapHome <span class="token operator">=</span> <span class="token constant">HOC</span><span class="token punctuation">(</span>Home<span class="token punctuation">)</span>
     <span class="token keyword">return</span>  <span class="token operator">&lt;</span>WrapHome <span class="token operator">/</span><span class="token operator">&gt;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>这么写的话每一次类组件触发 render 或者函数组件执行都会产生一个新的WrapHome，react diff 会判定两次不是同一个组件，那么就会卸载老组件，重新挂载新组件，老组件内部的真实 DOM 节点，都不会合理的复用，从而造成了性能的浪费，而且原始组件会被初始化多次。</p> <h3 id="ref-的处理"><a href="#ref-的处理" class="header-anchor">#</a> ref 的处理</h3> <p>高阶组件的约定是将所有 props 传递给被包装组件，但这对于 ref 并不适用。那是因为 ref 实际上并不是一个 prop ， 就像 key 一样，对于 ref 属性它是由 React 专门处理的。那么如何通过 ref 正常获取到原始组件的实例呢？在 ref 章节已经讲到，可以用 forwardRef做 ref 的转发处理。</p> <h3 id="注意多个-hoc-嵌套顺序问题"><a href="#注意多个-hoc-嵌套顺序问题" class="header-anchor">#</a> 注意多个 HOC 嵌套顺序问题</h3> <p>多个 HOC 嵌套，应该留意一下 HOC 的顺序，还要分析出要各个 HOC 之间是否有依赖关系。</p> <p>对于 class 声明的类组件，可以用装饰器模式，对类组件进行包装：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>@<span class="token constant">HOC1</span><span class="token punctuation">(</span>styles<span class="token punctuation">)</span>
@<span class="token constant">HOC2</span>
@<span class="token constant">HOC3</span>
<span class="token keyword">class</span> <span class="token class-name">Index</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Componen</span><span class="token punctuation">{</span>
    <span class="token comment">/* ... */</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>函数组件：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">Index</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">/* .... */</span>
<span class="token punctuation">}</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token constant">HOC1</span><span class="token punctuation">(</span>styles<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token constant">HOC2</span><span class="token punctuation">(</span> <span class="token constant">HOC3</span><span class="token punctuation">(</span>Index<span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">)</span> 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>HOC1 -&gt; HOC2 -&gt; HOC3 -&gt; Index。要注意一下包装顺序，越靠近 Index 组件的，就是越内层的 HOC ,离组件 Index 也就越近。</p> <p>还有一些其他的小细节：</p> <ol><li><p>如果2个 HOC 相互之间有依赖。比如 HOC1 依赖 HOC2 ，那么 HOC1 应该在 HOC2 内部。</p></li> <li><p>如果想通过 HOC 方式给原始组件添加一些额外生命周期，因为涉及到获取原始组件的实例 instance ，那么当前的 HOC 要离原始组件最近。</p></li></ol> <h3 id="继承静态属性"><a href="#继承静态属性" class="header-anchor">#</a> 继承静态属性</h3> <p>上述讲到在属性代理 HOC 本质上返回了一个新的 component ，那么如果给原来的 component 绑定一些静态属性方法，如果不处理，新的 component 上就会丢失这些静态属性方法。那么如何解决这个问题呢。</p> <h4 id="手动继承"><a href="#手动继承" class="header-anchor">#</a> 手动继承</h4> <p>当然可以手动将原始组件的静态方法 copy 到 HOC 组件上来，但前提是必须准确知道应该拷贝哪些方法。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token constant">HOC</span><span class="token punctuation">(</span><span class="token parameter">Component</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">class</span> <span class="token class-name">WrappedComponent</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>
      <span class="token comment">/*...*/</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 必须准确知道应该拷贝哪些方法 </span>
  WrappedComponent<span class="token punctuation">.</span>staticMethod <span class="token operator">=</span> Component<span class="token punctuation">.</span>staticMethod
  <span class="token keyword">return</span> WrappedComponent
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h4 id="引入第三方库"><a href="#引入第三方库" class="header-anchor">#</a> 引入第三方库</h4> <p>每个静态属性方法都手动绑定会很累，尤其对于开源的 HOC ，对原生组件的静态方法是未知 ，为了解决这个问题可以使用 hoist-non-react-statics 自动拷贝所有的静态方法:</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">import</span> hoistNonReactStatic <span class="token keyword">from</span> <span class="token string">'hoist-non-react-statics'</span>
<span class="token keyword">function</span> <span class="token constant">HOC</span><span class="token punctuation">(</span><span class="token parameter">Component</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">class</span> <span class="token class-name">WrappedComponent</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>
      <span class="token comment">/*...*/</span>
  <span class="token punctuation">}</span>
  <span class="token function">hoistNonReactStatic</span><span class="token punctuation">(</span>WrappedComponent<span class="token punctuation">,</span>Component<span class="token punctuation">)</span>
  <span class="token keyword">return</span> WrappedComponent
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h2 id="hoc-实现权限拦截"><a href="#hoc-实现权限拦截" class="header-anchor">#</a> HOC 实现权限拦截</h2> <p>思路：</p> <ol><li>需要权限的页面或者组件，用 HOC 包裹，并输入唯一的权限签名。</li> <li>用 Context 上下文保存全局的权限菜单列表，用 Provider 注入异步获取到的权限菜单。</li> <li>HOC 中用 Consumer 获取权限列表，并且和签名做匹配，如果有权限，就展示，如果没有权限，展示默认没有权限组件。</li></ol> <h3 id="在根部注入权限"><a href="#在根部注入权限" class="header-anchor">#</a> 在根部注入权限</h3> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">const</span> Permission <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">createContext</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> 

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">Index</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">[</span> rootPermission <span class="token punctuation">,</span> setRootPermission <span class="token punctuation">]</span> <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">useState</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    React<span class="token punctuation">.</span><span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
        <span class="token comment">/* 获取权限列表 */</span>
        <span class="token function">getRootPermission</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
            <span class="token keyword">const</span> <span class="token punctuation">{</span> code <span class="token punctuation">,</span> data <span class="token punctuation">}</span> <span class="token operator">=</span> res <span class="token keyword">as</span> any
            code <span class="token operator">===</span> <span class="token number">200</span> <span class="token operator">&amp;&amp;</span> <span class="token function">setRootPermission</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token comment">//  [ 'docList'  , 'tagList' ]</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span> 
    <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token operator">&lt;</span>Permission<span class="token punctuation">.</span>Provider value<span class="token operator">=</span><span class="token punctuation">{</span>rootPermission<span class="token punctuation">}</span> <span class="token operator">&gt;</span>
         <span class="token operator">&lt;</span>RootRouter<span class="token operator">/</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>Permission<span class="token punctuation">.</span>Provider<span class="token operator">&gt;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><ul><li>useState 用于动态注入获取的权限列表。</li> <li>根组件通过 Context.Provider 包裹。权限列表改变，所有消费权限列表的组件重新更新。 （假设一下数据交互返回的权限列表<code>[ 'docList' , 'tagList' ]）</code></li></ul> <h3 id="重点编写-hoc"><a href="#重点编写-hoc" class="header-anchor">#</a> 重点编写 HOC</h3> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">/* 没有权限 */</span>
<span class="token keyword">function</span> <span class="token function">NoPermission</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token operator">&lt;</span>div<span class="token operator">&gt;</span>您暂时没有权限，请联系管理员开通权限！<span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
<span class="token punctuation">}</span>
<span class="token comment">/* 编写HOC */</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">PermissionHoc</span><span class="token punctuation">(</span><span class="token parameter">authorization</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">Component</span><span class="token punctuation">)</span><span class="token punctuation">{</span> 
        <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token function">Home</span> <span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">const</span> <span class="token function-variable function">matchPermission</span> <span class="token operator">=</span><span class="token punctuation">(</span><span class="token parameter">value<span class="token punctuation">,</span>list</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span> list<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token comment">/* 匹配权限 */</span>
            <span class="token keyword">return</span> <span class="token operator">&lt;</span>Permission<span class="token punctuation">.</span>Consumer<span class="token operator">&gt;</span>
                <span class="token punctuation">{</span>
                    <span class="token punctuation">(</span><span class="token parameter">permissionList</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">matchPermission</span><span class="token punctuation">(</span>authorization<span class="token punctuation">,</span>permissionList<span class="token punctuation">)</span> <span class="token operator">&gt;=</span> <span class="token number">0</span> <span class="token operator">?</span> <span class="token operator">&lt;</span>Component  <span class="token punctuation">{</span><span class="token operator">...</span>props<span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">&gt;</span> <span class="token operator">:</span> <span class="token operator">&lt;</span>NoPermission <span class="token operator">/</span><span class="token operator">&gt;</span>
                <span class="token punctuation">}</span>
            <span class="token operator">&lt;</span><span class="token operator">/</span>Permission<span class="token punctuation">.</span>Consumer<span class="token operator">&gt;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><ol><li>用两层包装函数的 HOC，第一层用于获取 HOC 绑定的当前组件的权限签名，因为要用这个权限签名和权限列表做匹配。第二层接受的原始组件。</li> <li>在 HOC 中用 Context.Consumer 接收权限列表，做权限匹配。组件有权限展示，没有权限展示无权限组件。</li></ol> <h3 id="绑定权限"><a href="#绑定权限" class="header-anchor">#</a> 绑定权限</h3> <div class="language-js line-numbers-mode"><pre class="language-js"><code>@<span class="token function">PermissionHoc</span><span class="token punctuation">(</span><span class="token string">'writeDoc'</span><span class="token punctuation">)</span>  <span class="token comment">// 绑定文档录入页面</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">Index</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span><span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token function">PermissionHoc</span><span class="token punctuation">(</span><span class="token string">'writeTag'</span><span class="token punctuation">)</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span> <span class="token comment">//绑定标签录入页面</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token function">PermissionHoc</span><span class="token punctuation">(</span><span class="token string">'tagList'</span><span class="token punctuation">)</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span> <span class="token comment">//绑定标签列表页面</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token function">PermissionHoc</span><span class="token punctuation">(</span><span class="token string">'docList'</span><span class="token punctuation">)</span><span class="token punctuation">(</span>Index<span class="token punctuation">)</span> <span class="token comment">// 绑定文档列表页面</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>对于业务组件进行权限 HOC 的包裹。因为上述模拟数据返回的是 <code>[ 'docList' , 'tagList' ]</code>，所以最终只能看到 标签列表 和 文档列表 页面。</p> <h2 id="从-mixin-到-hoc-再到-hook"><a href="#从-mixin-到-hoc-再到-hook" class="header-anchor">#</a> 从 Mixin 到 HOC 再到 Hook</h2> <p>代码及状态逻辑复用 - 从 Mixin 到 HOC/Render Props 再到 Hook</p> <p><img src="/blog/images/react/hoc1.png" alt="hoc1"></p> <p>组件复用的 4 种方式</p> <ul><li>Mixin</li> <li>HOC</li> <li>Render Props</li> <li>Hooks</li></ul> <h3 id="minix"><a href="#minix" class="header-anchor">#</a> Minix</h3> <p><code>Mixin</code>（混入）是一种通过扩展收集功能的方式，它本质上是将一个对象的属性拷贝到另一个对象上面去，不过你可以拷贝<code>任意多</code>个对象的<code>任意个</code>方法到一个新对象上去，这是<code>继承</code>所不能实现的。它的出现主要就是为了解决代码复用问题。</p> <p>例如下面的例子，很多组件或页面都需要记录用户行为，性能指标等。如果我们在每个组件都引入写日志的逻辑，会产生大量重复代码，通过<code>Mixin</code>我们可以解决这一问题：</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">var</span> LogMixin <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token function-variable function">log</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'log'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function-variable function">componentDidMount</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'in'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function-variable function">componentWillUnmount</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'out'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> User <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">createClass</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token literal-property property">mixins</span><span class="token operator">:</span> <span class="token punctuation">[</span>LogMixin<span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token function-variable function">render</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token operator">&lt;</span>div<span class="token operator">&gt;</span><span class="token operator">...</span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> Goods <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">createClass</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token literal-property property">mixins</span><span class="token operator">:</span> <span class="token punctuation">[</span>LogMixin<span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token function-variable function">render</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token operator">&lt;</span>div<span class="token operator">&gt;</span><span class="token operator">...</span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><p>React 官方文档在<a href="https://link.juejin.cn?target=https%3A%2F%2Freact.docschina.org%2Fblog%2F2016%2F07%2F13%2Fmixins-considered-harmful.html" target="_blank" rel="noopener noreferrer">Mixins Considered Harmful<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>一文中提到了Mixin带来了危害：</p> <ul><li>Mixin 可能会相互依赖，相互耦合，不利于代码维护</li> <li>不同的 Mixin 中的方法可能会相互冲突</li> <li>Mixin 非常多时，组件是可以感知到的，甚至还要为其做相关处理，这样会给代码造成滚雪球式的复杂性</li></ul> <p>而<code>HOC</code>的出现可以解决这些问题：</p> <ul><li>高阶组件就是一个没有副作用的纯函数，各个高阶组件不会互相依赖耦合</li> <li>高阶组件也有可能造成冲突，但我们可以在遵守约定的情况下避免这些行为</li> <li>高阶组件并不关心数据使用的方式和原因，而被包裹的组件也不关心数据来自何处。高阶组件的增加不会为原组件增加负担</li></ul> <p>React 现在已经不再推荐使用 Mixin 来解决代码复用问题，因为 Mixin 带来的危害比他产生的价值还要巨大，并且 React 全面推荐使用高阶组件（HOC）来替代它。</p> <h3 id="hoc-总览"><a href="#hoc-总览" class="header-anchor">#</a> HOC 总览</h3> <p><img src="/blog/images/react/hoc2.png" alt="hoc2"></p> <h3 id="hoc-的实现"><a href="#hoc-的实现" class="header-anchor">#</a> HOC 的实现</h3> <p>不要试图以任何方式在 HOC 中修改组件原型，而应该使用组合的方式，通过将组件包装在容器组件中实现功能。通常情况下，实现高阶组件的方式有以下两种:</p> <ul><li>属性代理 Props Proxy。</li> <li>反向继承 Inheritance Inversion。</li></ul> <h4 id="属性代理-2"><a href="#属性代理-2" class="header-anchor">#</a> 属性代理</h4> <p>函数返回一个我们自己定义的组件，然后在 render 中返回要包裹的组件，这样我们就可以代理所有传入的 props，并且决定如何渲染，实际上 ，这种方式生成的高阶组件就是原组件的父组件。</p> <ul><li>可操作所有传入的 props</li> <li>可操作组件的生命周期</li> <li>可操作组件的 static 方法</li> <li>获取 refs</li></ul> <div class="language-typescript line-numbers-mode"><pre class="language-typescript"><code><span class="token keyword">function</span> <span class="token function">proxyHOC</span><span class="token punctuation">(</span>WrappedComponent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token keyword">extends</span></span> Component <span class="token punctuation">{</span>
    <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token operator">&lt;</span>WrappedComponent <span class="token punctuation">{</span><span class="token operator">...</span><span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h4 id="反向继承-2"><a href="#反向继承-2" class="header-anchor">#</a> 反向继承</h4> <p>返回一个组件，继承原组件，在 render 中调用原组件的 render。由于继承了原组件，能通过 this 访问到原组件的生命周期、props、state、render 等，相比属性代理它能操作更多的属性。</p> <ul><li>可操作所有传入的 props</li> <li>可操作组件的生命周期</li> <li>可操作组件的 static 方法</li> <li>获取 refs</li> <li>可操作 state</li> <li>可以渲染劫持</li></ul> <div class="language-typescript line-numbers-mode"><pre class="language-typescript"><code><span class="token keyword">function</span> <span class="token function">inheritHOC</span><span class="token punctuation">(</span>WrappedComponent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token keyword">extends</span></span> WrappedComponent <span class="token punctuation">{</span>
    <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h3 id="hoc-可以解决什么问题"><a href="#hoc-可以解决什么问题" class="header-anchor">#</a> HOC 可以解决什么问题</h3> <p>HOC 具体能实现以下几个功能：</p> <ol><li>强化 props ，可以通过 HOC ，向原始组件混入一些状态。</li> <li>渲染劫持，可以利用 HOC ，动态挂载原始组件，还可以先获取原始组件的渲染树，进行可控性修改。</li> <li>可以配合 import 等 api ，实现动态加载组件，实现代码分割，加入 loading 效果。</li> <li>可以通过 ref 来获取原始组件实例，操作实例下的属性和方法。</li> <li>可以对原始组件做一些事件监听，错误监控等。</li></ol> <h4 id="强化-props-2"><a href="#强化-props-2" class="header-anchor">#</a> 强化 props</h4> <p>可以对传入组件的 props 进行增加、修改、删除或者根据特定的 props 进行特殊的操作。</p> <div class="language-typescript line-numbers-mode"><pre class="language-typescript"><code><span class="token comment">// 属性代理</span>
<span class="token keyword">function</span> <span class="token function">proxyHOC</span><span class="token punctuation">(</span>WrappedComponent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token keyword">extends</span></span> Component <span class="token punctuation">{</span>
    <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> newProps <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token operator">...</span><span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">,</span>
        user<span class="token operator">:</span> <span class="token string">'ConardLi'</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">return</span> <span class="token operator">&lt;</span>WrappedComponent <span class="token punctuation">{</span><span class="token operator">...</span>newProps<span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><h4 id="渲染劫持-组合渲染"><a href="#渲染劫持-组合渲染" class="header-anchor">#</a> 渲染劫持 - 组合渲染</h4> <p>可使用任何其他组件和原组件进行组合渲染，达到样式、布局复用等效果。</p> <div class="language-typescript line-numbers-mode"><pre class="language-typescript"><code><span class="token comment">// 属性代理</span>
<span class="token keyword">function</span> <span class="token function">stylHOC</span><span class="token punctuation">(</span>WrappedComponent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token keyword">extends</span></span> Component <span class="token punctuation">{</span>
    <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token operator">&lt;</span>div<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>div className<span class="token operator">=</span><span class="token string">&quot;title&quot;</span><span class="token operator">&gt;</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>title<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>WrappedComponent <span class="token punctuation">{</span><span class="token operator">...</span><span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 反向代理</span>
<span class="token keyword">function</span> <span class="token function">styleHOC</span><span class="token punctuation">(</span>WrappedComponent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token keyword">extends</span></span> WrappedComponent <span class="token punctuation">{</span>
    <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token operator">&lt;</span>div<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>div className<span class="token operator">=</span><span class="token string">&quot;title&quot;</span><span class="token operator">&gt;</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>title<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
        <span class="token punctuation">{</span><span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
      <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><h4 id="渲染劫持-条件渲染"><a href="#渲染劫持-条件渲染" class="header-anchor">#</a> 渲染劫持 - 条件渲染</h4> <p>根据特定的属性决定原组件是否渲染</p> <div class="language-typescript line-numbers-mode"><pre class="language-typescript"><code><span class="token comment">// 属性代理</span>
<span class="token keyword">function</span> <span class="token function">visibleHOC</span><span class="token punctuation">(</span>WrappedComponent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token keyword">extends</span></span> Component <span class="token punctuation">{</span>
    <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>visible <span class="token operator">===</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token operator">&lt;</span>WrappedComponent <span class="token punctuation">{</span><span class="token operator">...</span>props<span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 反向代理</span>
<span class="token keyword">function</span> <span class="token function">visibleHOC</span><span class="token punctuation">(</span>WrappedComponent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token keyword">extends</span></span> WrappedComponent <span class="token punctuation">{</span>
    <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>visible <span class="token operator">===</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><h4 id="渲染劫持-2"><a href="#渲染劫持-2" class="header-anchor">#</a> 渲染劫持</h4> <p>高阶组件可以在 render 函数中做非常多的操作，从而控制原组件的渲染输出。只要改变了原组件的渲染，我们都将它称之为一种渲染劫持。</p> <p>实际上，上面的组合渲染和条件渲染都是渲染劫持的一种，通过反向继承，不仅可以实现以上两点，还可直接增强由原组件render函数产生的React元素。</p> <div class="language-typescript line-numbers-mode"><pre class="language-typescript"><code><span class="token keyword">function</span> <span class="token function">hijackHOC</span><span class="token punctuation">(</span>WrappedComponent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token keyword">extends</span></span> WrappedComponent <span class="token punctuation">{</span>
    <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> tree <span class="token operator">=</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> newProps <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>tree <span class="token operator">&amp;&amp;</span> tree<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">'input'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        newProps <span class="token operator">=</span> <span class="token punctuation">{</span> value<span class="token operator">:</span> <span class="token string">'渲染被劫持了'</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">const</span> props <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> tree<span class="token punctuation">.</span>props<span class="token punctuation">,</span> newProps<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> newTree <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">cloneElement</span><span class="token punctuation">(</span>tree<span class="token punctuation">,</span> props<span class="token punctuation">,</span> tree<span class="token punctuation">.</span>props<span class="token punctuation">.</span>children<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> newTree<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

注意上面的说明我用的是增强而不是更改。
render函数内实际上是调用 React<span class="token punctuation">.</span>creatElement 产生的React元素，
所有属性是不可变的，不能直接修改，
我们可以借助 cloneElement 方法来在原组件的基础上增强一个新组件
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><h4 id="获取-refs"><a href="#获取-refs" class="header-anchor">#</a> 获取 refs</h4> <p>高阶组件中可获取原组件的 ref，通过 ref 获取组件实例：</p> <p>调用高阶组件的时候并不能获取到原组件的真实 ref，需要手动进行传递</p> <div class="language-typescript line-numbers-mode"><pre class="language-typescript"><code><span class="token keyword">function</span> <span class="token function">refHOC</span><span class="token punctuation">(</span>WrappedComponent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token keyword">extends</span></span> Component <span class="token punctuation">{</span>
    <span class="token function">componentDidMount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>wapperRef<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token operator">&lt;</span>WrappedComponent <span class="token punctuation">{</span><span class="token operator">...</span><span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">}</span> ref<span class="token operator">=</span><span class="token punctuation">{</span>ref <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> <span class="token keyword">this</span><span class="token punctuation">.</span>wapperRef <span class="token operator">=</span> ref <span class="token punctuation">}</span><span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">logProps</span><span class="token punctuation">(</span>Component<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">class</span> <span class="token class-name">LogProps</span> <span class="token keyword">extends</span> <span class="token class-name">React</span><span class="token punctuation">.</span>Component <span class="token punctuation">{</span> 
    <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> <span class="token punctuation">{</span>forwardedRef<span class="token punctuation">,</span> <span class="token operator">...</span>rest<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">;</span>
      <span class="token comment">// 将自定义的 prop 属性 “forwardedRef” 定义为 ref</span>
      <span class="token keyword">return</span> <span class="token operator">&lt;</span>Component ref<span class="token operator">=</span><span class="token punctuation">{</span>forwardedRef<span class="token punctuation">}</span> <span class="token punctuation">{</span><span class="token operator">...</span>rest<span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 注意 React.forwardRef 回调的第二个参数 “ref”。</span>
  <span class="token comment">// 我们可以将其作为常规 prop 属性传递给 LogProps，例如 “forwardedRef”</span>
  <span class="token comment">// 然后它就可以被挂载到被 LogProps 包裹的子组件上。</span>
  <span class="token keyword">return</span> React<span class="token punctuation">.</span><span class="token function">forwardRef</span><span class="token punctuation">(</span><span class="token punctuation">(</span>props<span class="token punctuation">,</span> ref<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token operator">&lt;</span>LogProps <span class="token punctuation">{</span><span class="token operator">...</span>props<span class="token punctuation">}</span> forwardedRef<span class="token operator">=</span><span class="token punctuation">{</span>ref<span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br></div></div><h4 id="状态管理"><a href="#状态管理" class="header-anchor">#</a> 状态管理</h4> <p>将原组件的状态提取到 HOC 中进行管理，如下面的代码，我们将 Input 的 value 提取到 HOC 中进行管理，使它变成受控组件，同时不影响它使用 onChange 方法进行一些其他操作。基于这种方式，我们可以实现一个简单的双向绑定。利用高阶组件将新组件的状态装入到被包装组件中，例如我们可以使用高阶组件将非受控组件转化为受控组件。</p> <div class="language-typescript line-numbers-mode"><pre class="language-typescript"><code><span class="token keyword">function</span> <span class="token function">proxyHoc</span><span class="token punctuation">(</span>WrappedComponent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token keyword">extends</span></span> Component <span class="token punctuation">{</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">super</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token punctuation">{</span> value<span class="token operator">:</span> <span class="token string">''</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function-variable function">onChange</span> <span class="token operator">=</span> <span class="token punctuation">(</span>event<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> <span class="token punctuation">{</span> onChange <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        value<span class="token operator">:</span> event<span class="token punctuation">.</span>target<span class="token punctuation">.</span>value<span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">typeof</span> onChange <span class="token operator">===</span><span class="token string">'function'</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
          <span class="token function">onChange</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> newProps <span class="token operator">=</span> <span class="token punctuation">{</span>
        value<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>value<span class="token punctuation">,</span>
        onChange<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>onChange<span class="token punctuation">,</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">return</span> <span class="token operator">&lt;</span>WrappedComponent <span class="token punctuation">{</span><span class="token operator">...</span><span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">}</span> <span class="token punctuation">{</span><span class="token operator">...</span>newProps<span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name"><span class="token constant">HOC</span></span> <span class="token keyword">extends</span> <span class="token class-name">Component</span> <span class="token punctuation">{</span>
  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token operator">&lt;</span>input <span class="token punctuation">{</span><span class="token operator">...</span><span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">}</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>input<span class="token operator">&gt;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token function">proxyHoc</span><span class="token punctuation">(</span><span class="token constant">HOC</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br></div></div><h4 id="操作-state"><a href="#操作-state" class="header-anchor">#</a> 操作 state</h4> <p>面的例子通过属性代理利用 HOC 的 state 对原组件进行了一定的增强，但并不能直接控制原组件的 state，而通过反向继承，我们可以直接操作原组件的 state。但是并不推荐直接修改或添加原组件的 state，因为这样有可能和组件内部的操作构成冲突。</p> <div class="language-typescript line-numbers-mode"><pre class="language-typescript"><code><span class="token keyword">function</span> <span class="token function">debugHOC</span><span class="token punctuation">(</span>WrappedComponent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token keyword">extends</span></span> WrappedComponent <span class="token punctuation">{</span>
    <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'props'</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'state'</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token punctuation">(</span>
        <span class="token operator">&lt;</span>div className<span class="token operator">=</span><span class="token string">&quot;debuging&quot;</span><span class="token operator">&gt;</span>
          <span class="token punctuation">{</span><span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
        <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
      <span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
上面的 <span class="token constant">HOC</span> 在 render 中将 props 和 state 打印出来，可以用作调试阶段，
当然你可以在里面写更多的调试代码。

想象一下，只需要在我们想要调试的组件上加上<span class="token decorator"><span class="token at operator">@</span><span class="token function">debug就可以对该组件进行调试，</span></span>
而不需要在每次调试的时候写很多冗余代码。
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><h3 id="如何使用-hoc"><a href="#如何使用-hoc" class="header-anchor">#</a> 如何使用 HOC</h3> <p>在实际应用中，一个组件可能被多个HOC增强，我们使用的是被所有的HOC增强后的组件。</p> <h4 id="compose"><a href="#compose" class="header-anchor">#</a> compose</h4> <p>很多第三方库都提供了类似 compose 的函数，例如 lodash.flowRight，Redux 提供的 combineReducers 函数等。</p> <div class="language-typescript line-numbers-mode"><pre class="language-typescript"><code><span class="token function">logger</span><span class="token punctuation">(</span><span class="token function">visible</span><span class="token punctuation">(</span><span class="token function">style</span><span class="token punctuation">(</span>Input<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment">// 转换</span>
<span class="token keyword">const</span> <span class="token function-variable function">compose</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">...</span>fns<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> fns<span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token punctuation">(</span>f<span class="token punctuation">,</span> g<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">g</span><span class="token punctuation">(</span><span class="token function">f</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">compose</span><span class="token punctuation">(</span>logger<span class="token punctuation">,</span>visible<span class="token punctuation">,</span>style<span class="token punctuation">)</span><span class="token punctuation">(</span>Input<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h4 id="decorators"><a href="#decorators" class="header-anchor">#</a> decorators</h4> <p>借助 ES7 为我们提供的 Decorators 来让我们的写法变的更加优雅</p> <div class="language-typescript line-numbers-mode"><pre class="language-typescript"><code><span class="token comment">// babel 配置:  &quot;plugins&quot;: [&quot;transform-decorators-legacy&quot;]</span>
<span class="token decorator"><span class="token at operator">@</span><span class="token function">logger</span></span>
<span class="token decorator"><span class="token at operator">@</span><span class="token function">visible</span></span>
<span class="token decorator"><span class="token at operator">@</span><span class="token function">style</span></span>
<span class="token keyword">class</span> <span class="token class-name">Input</span> <span class="token keyword">extends</span> <span class="token class-name">Component</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span>

<span class="token comment">// 结合 compose 使用</span>
<span class="token keyword">const</span> hoc <span class="token operator">=</span> <span class="token function">compose</span><span class="token punctuation">(</span>logger<span class="token punctuation">,</span> visible<span class="token punctuation">,</span> style<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token decorator"><span class="token at operator">@</span><span class="token function">hoc</span></span>
<span class="token keyword">class</span> <span class="token class-name">Input</span> <span class="token keyword">extends</span> <span class="token class-name">Component</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><h3 id="hoc-常见使用场景"><a href="#hoc-常见使用场景" class="header-anchor">#</a> HOC 常见使用场景</h3> <h4 id="日志打点"><a href="#日志打点" class="header-anchor">#</a> 日志打点</h4> <p>某些页面需要记录用户行为，性能指标等等，通过高阶组件做这些事情可以省去很多重复代码。这属于一类最常见的应用，多个组件拥有类似的逻辑，我们要对重复的逻辑进行复用。</p> <div class="language-typescript line-numbers-mode"><pre class="language-typescript"><code><span class="token keyword">function</span> <span class="token function">logHoc</span><span class="token punctuation">(</span>WrappedComponent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token keyword">extends</span></span> Component <span class="token punctuation">{</span>
    <span class="token function">componentWillMount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>start <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">componentDidMount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>end <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>WrappedComponent<span class="token punctuation">.</span>dispalyName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> 渲染时间：</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">this</span><span class="token punctuation">.</span>end <span class="token operator">-</span> <span class="token keyword">this</span><span class="token punctuation">.</span>start<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> ms</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>user<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">进入</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>WrappedComponent<span class="token punctuation">.</span>dispalyName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">componentWillUnmount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>user<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">退出</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>WrappedComponent<span class="token punctuation">.</span>dispalyName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token operator">&lt;</span>WrappedComponent <span class="token punctuation">{</span><span class="token operator">...</span><span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">&gt;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><h4 id="可用、权限控制"><a href="#可用、权限控制" class="header-anchor">#</a> 可用、权限控制</h4> <div class="language-typescript line-numbers-mode"><pre class="language-typescript"><code><span class="token keyword">function</span> <span class="token function">auth</span><span class="token punctuation">(</span>WrappedComponent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token keyword">extends</span></span> Component <span class="token punctuation">{</span>
    <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> <span class="token punctuation">{</span> visible<span class="token punctuation">,</span> auth<span class="token punctuation">,</span> display <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token operator">...</span>props <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>visible <span class="token operator">===</span> <span class="token boolean">false</span> <span class="token operator">||</span> <span class="token punctuation">(</span>auth <span class="token operator">&amp;&amp;</span> authList<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>auth<span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> display
      <span class="token punctuation">}</span>
      <span class="token keyword">return</span> <span class="token operator">&lt;</span>WrappedComponent <span class="token punctuation">{</span><span class="token operator">...</span>props<span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

authList 是我们在进入程序时向后端请求的所有权限列表，当组件所需要的权限不列表中，
或者设置的 visible 是 <span class="token boolean">false</span>，我们将其显示为传入的组件样式，或者 <span class="token keyword">null</span>。
我们可以将任何需要进行权限校验的组件应用 <span class="token constant">HOC</span>：

<span class="token decorator"><span class="token at operator">@</span><span class="token function">auth</span></span>
<span class="token keyword">class</span> <span class="token class-name">Input</span> <span class="token keyword">extends</span> <span class="token class-name">Component</span> <span class="token punctuation">{</span>  <span class="token operator">...</span>  <span class="token punctuation">}</span>
<span class="token decorator"><span class="token at operator">@</span><span class="token function">auth</span></span>
<span class="token keyword">class</span> <span class="token class-name">Button</span> <span class="token keyword">extends</span> <span class="token class-name">Component</span> <span class="token punctuation">{</span>  <span class="token operator">...</span>  <span class="token punctuation">}</span>

<span class="token operator">&lt;</span>Button auth<span class="token operator">=</span><span class="token string">&quot;user/addUser&quot;</span><span class="token operator">&gt;</span>添加用户<span class="token operator">&lt;</span><span class="token operator">/</span>Button<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>Input auth<span class="token operator">=</span><span class="token string">&quot;user/search&quot;</span> visible<span class="token operator">=</span><span class="token punctuation">{</span><span class="token boolean">false</span><span class="token punctuation">}</span> <span class="token operator">&gt;</span>添加用户<span class="token operator">&lt;</span><span class="token operator">/</span>Input<span class="token operator">&gt;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><h4 id="双向绑定"><a href="#双向绑定" class="header-anchor">#</a> 双向绑定</h4> <p>在 vue 中，绑定一个变量后可实现双向数据绑定，即表单中的值改变后绑定的变量也会自动改变。而 React 中没有做这样的处理，在默认情况下，表单元素都是非受控组件。给表单元素绑定一个状态后，往往需要手动书写onChange 方法来将其改写为受控组件，在表单元素非常多的情况下这些重复操作是非常痛苦的。</p> <p>我们可以借助高阶组件来实现一个简单的双向绑定：</p> <p><img src="/blog/images/react/hoc3.png" alt="hoc3"></p> <h4 id="表单校验"><a href="#表单校验" class="header-anchor">#</a> 表单校验</h4> <p>基于上面的双向绑定的例子，我们再来一个表单验证器，表单验证器可以包含验证函数以及提示信息，当验证不通过时，展示错误信息：</p> <div class="language-typescript line-numbers-mode"><pre class="language-typescript"><code><span class="token keyword">function</span> <span class="token function">validateHoc</span><span class="token punctuation">(</span>WrappedComponent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token keyword">extends</span></span> Component <span class="token punctuation">{</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">super</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token punctuation">{</span> error<span class="token operator">:</span> <span class="token string">''</span> <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token function-variable function">onChange</span> <span class="token operator">=</span> <span class="token punctuation">(</span>event<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> <span class="token punctuation">{</span> validator <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>validator <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> validator<span class="token punctuation">.</span>func <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>validator<span class="token punctuation">.</span><span class="token function">func</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>target<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span> error<span class="token operator">:</span> validator<span class="token punctuation">.</span>msg <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span> error<span class="token operator">:</span> <span class="token string">''</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token operator">&lt;</span>div<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>WrappedComponent onChange<span class="token operator">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>onChange<span class="token punctuation">}</span>  <span class="token punctuation">{</span><span class="token operator">...</span><span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>div<span class="token operator">&gt;</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>error <span class="token operator">||</span> <span class="token string">''</span><span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>


<span class="token keyword">const</span> validatorName <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token function-variable function">func</span><span class="token operator">:</span> <span class="token punctuation">(</span>val<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> val <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">isNaN</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">,</span>
  msg<span class="token operator">:</span> <span class="token string">'请输入数字'</span>
<span class="token punctuation">}</span>
<span class="token keyword">const</span> validatorPwd <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token function-variable function">func</span><span class="token operator">:</span> <span class="token punctuation">(</span>val<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> val <span class="token operator">&amp;&amp;</span> val<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">6</span><span class="token punctuation">,</span>
  msg<span class="token operator">:</span> <span class="token string">'密码必须大于6位'</span>
<span class="token punctuation">}</span>
<span class="token operator">&lt;</span>HOCInput validator<span class="token operator">=</span><span class="token punctuation">{</span>validatorName<span class="token punctuation">}</span> v_model<span class="token operator">=</span><span class="token string">&quot;name&quot;</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>HOCInput<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>HOCInput validator<span class="token operator">=</span><span class="token punctuation">{</span>validatorPwd<span class="token punctuation">}</span> v_model<span class="token operator">=</span><span class="token string">&quot;pwd&quot;</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>HOCInput<span class="token operator">&gt;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br></div></div><h4 id="redux-的-connect"><a href="#redux-的-connect" class="header-anchor">#</a> Redux 的 connect</h4> <p>redux 中的 connect，其实就是一个 HOC，下面就是一个简化版的 connect 实现：</p> <div class="language-typescript line-numbers-mode"><pre class="language-typescript"><code><span class="token comment">// connect函数其实就做了一件事，将 mapStateToProps 和 mapDispatchToProps </span>
<span class="token comment">// 分别解构后传给原组件，</span>
<span class="token comment">// 这样我们在原组件内就可以直接用 props 获取 state 以及 dispatch 函数了</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">connect</span> <span class="token operator">=</span> <span class="token punctuation">(</span>mapStateToProps<span class="token punctuation">,</span> mapDispatchToProps<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span>WrappedComponent<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">class</span> <span class="token class-name">Connect</span> <span class="token keyword">extends</span> <span class="token class-name">Component</span> <span class="token punctuation">{</span>
    <span class="token keyword">static</span> contextTypes <span class="token operator">=</span> <span class="token punctuation">{</span>
      store<span class="token operator">:</span> PropTypes<span class="token punctuation">.</span>object
    <span class="token punctuation">}</span>

    <span class="token function">constructor</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token punctuation">{</span>
        allProps<span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token function">componentWillMount</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> <span class="token punctuation">{</span> store <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>context
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_updateProps</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      store<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_updateProps</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token function">_updateProps</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> <span class="token punctuation">{</span> store <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>context
      <span class="token keyword">let</span> stateProps <span class="token operator">=</span> mapStateToProps <span class="token operator">?</span> <span class="token function">mapStateToProps</span><span class="token punctuation">(</span>store<span class="token punctuation">.</span><span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span> 
      <span class="token keyword">let</span> dispatchProps <span class="token operator">=</span> mapDispatchToProps<span class="token operator">?</span> <span class="token function">mapDispatchToProps</span><span class="token punctuation">(</span>store<span class="token punctuation">.</span>dispatch<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span> 
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        allProps<span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token operator">...</span>stateProps<span class="token punctuation">,</span>
          <span class="token operator">...</span>dispatchProps<span class="token punctuation">,</span>
          <span class="token operator">...</span><span class="token keyword">this</span><span class="token punctuation">.</span>props
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token function">render</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token operator">&lt;</span>WrappedComponent <span class="token punctuation">{</span><span class="token operator">...</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>allProps<span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">&gt;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> Connect
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br></div></div><h3 id="hoc-使用注意事项"><a href="#hoc-使用注意事项" class="header-anchor">#</a> HOC 使用注意事项</h3> <h4 id="告诫-静态属性拷贝"><a href="#告诫-静态属性拷贝" class="header-anchor">#</a> 告诫 — 静态属性拷贝</h4> <p>当我们应用HOC去增强另一个组件时，我们实际使用的组件已经不是原组件了，所以我们拿不到原组件的任何静态属性，我们可以在HOC的结尾手动拷贝他们：</p> <div class="language-typescript line-numbers-mode"><pre class="language-typescript"><code><span class="token keyword">function</span> <span class="token function">proxyHOC</span><span class="token punctuation">(</span>WrappedComponent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">class</span> <span class="token class-name">HOCComponent</span> <span class="token keyword">extends</span> <span class="token class-name">Component</span> <span class="token punctuation">{</span>
    <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token operator">&lt;</span>WrappedComponent <span class="token punctuation">{</span><span class="token operator">...</span><span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  HOCComponent<span class="token punctuation">.</span>staticMethod <span class="token operator">=</span> WrappedComponent<span class="token punctuation">.</span>staticMethod<span class="token punctuation">;</span>
  <span class="token comment">// ... </span>
  <span class="token keyword">return</span> HOCComponent<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>如果原组件有非常多的静态属性，这个过程是非常痛苦的，而且你需要去了解需要增强的所有组件的静态属性是什么，我们可以使用<a href="https://link.juejin.cn/?target=https%3A%2F%2Fgithub.com%2Fmridgway%2Fhoist-non-react-statics" target="_blank" rel="noopener noreferrer">hoist-non-react-statics<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>来帮助我们解决这个问题，它可以自动帮我们拷贝所有非React的静态方法，使用方式如下：</p> <div class="language-typescript line-numbers-mode"><pre class="language-typescript"><code><span class="token keyword">import</span> hoistNonReactStatic <span class="token keyword">from</span> <span class="token string">'hoist-non-react-statics'</span><span class="token punctuation">;</span>
<span class="token keyword">function</span> <span class="token function">proxyHOC</span><span class="token punctuation">(</span>WrappedComponent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">class</span> <span class="token class-name">HOCComponent</span> <span class="token keyword">extends</span> <span class="token class-name">Component</span> <span class="token punctuation">{</span>
    <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token operator">&lt;</span>WrappedComponent <span class="token punctuation">{</span><span class="token operator">...</span><span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token function">hoistNonReactStatic</span><span class="token punctuation">(</span>HOCComponent<span class="token punctuation">,</span>WrappedComponent<span class="token punctuation">)</span><span class="token punctuation">;</span>
  
  <span class="token keyword">return</span> HOCComponent<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h4 id="告诫-传递-refs"><a href="#告诫-传递-refs" class="header-anchor">#</a> 告诫 — 传递 refs</h4> <p>使用高阶组件后，获取到的 ref 实际上是最外层的容器组件，而非原组件，但是很多情况下我们需要用到原组件的ref。高阶组件并不能像透传 props 那样将 refs 透传，我们可以用一个回调函数来完成 ref 的传递：</p> <div class="language-typescript line-numbers-mode"><pre class="language-typescript"><code><span class="token keyword">function</span> <span class="token function">hoc</span><span class="token punctuation">(</span>WrappedComponent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token keyword">extends</span></span> Component <span class="token punctuation">{</span>
    <span class="token function-variable function">getWrappedRef</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>wrappedRef<span class="token punctuation">;</span>
    <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token operator">&lt;</span>WrappedComponent ref<span class="token operator">=</span><span class="token punctuation">{</span>ref <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> <span class="token keyword">this</span><span class="token punctuation">.</span>wrappedRef <span class="token operator">=</span> ref <span class="token punctuation">}</span><span class="token punctuation">}</span> <span class="token punctuation">{</span><span class="token operator">...</span><span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">hoc</span></span>
<span class="token keyword">class</span> <span class="token class-name">Input</span> <span class="token keyword">extends</span> <span class="token class-name">Component</span> <span class="token punctuation">{</span>
  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token operator">&lt;</span>input<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>input<span class="token operator">&gt;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">class</span> <span class="token class-name">App</span> <span class="token keyword">extends</span> <span class="token class-name">Component</span> <span class="token punctuation">{</span>
  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>
      <span class="token operator">&lt;</span>Input ref<span class="token operator">=</span><span class="token punctuation">{</span>ref <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> <span class="token keyword">this</span><span class="token punctuation">.</span>inpitRef <span class="token operator">=</span> ref<span class="token punctuation">.</span><span class="token function">getWrappedRef</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">}</span> <span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>Input<span class="token operator">&gt;</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><p>React 16.3 版本提供了一个 forwardRef API 来帮助我们进行refs传递，这样我们在高阶组件上获取的 ref 就是原组件的 ref 了，而不需要再手动传递，如果你的 React 版本大于 16.3，可以使用下面的方式:</p> <div class="language-typescript line-numbers-mode"><pre class="language-typescript"><code><span class="token keyword">function</span> <span class="token function">hoc</span><span class="token punctuation">(</span>WrappedComponent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">class</span> <span class="token class-name"><span class="token constant">HOC</span></span> <span class="token keyword">extends</span> <span class="token class-name">Component</span> <span class="token punctuation">{</span>
    <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> <span class="token punctuation">{</span> forwardedRef<span class="token punctuation">,</span> <span class="token operator">...</span>props <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token operator">&lt;</span>WrappedComponent ref<span class="token operator">=</span><span class="token punctuation">{</span>forwardedRef<span class="token punctuation">}</span> <span class="token punctuation">{</span><span class="token operator">...</span>props<span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> React<span class="token punctuation">.</span><span class="token function">forwardRef</span><span class="token punctuation">(</span><span class="token punctuation">(</span>props<span class="token punctuation">,</span> ref<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token operator">&lt;</span><span class="token constant">HOC</span> forwardedRef<span class="token operator">=</span><span class="token punctuation">{</span>ref<span class="token punctuation">}</span> <span class="token punctuation">{</span><span class="token operator">...</span>props<span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h4 id="告诫-不要在-render-方法内创建高阶组件"><a href="#告诫-不要在-render-方法内创建高阶组件" class="header-anchor">#</a> 告诫 — 不要在 render 方法内创建高阶组件</h4> <p>React Diff 算法的原则是：</p> <ul><li>使用组件标识确定是卸载还是更新组件</li> <li>如果组件的和前一次渲染时标识是相同的，递归更新子组件</li> <li>如果标识不同卸载组件重新挂载新组件</li></ul> <p>每次调用高阶组件生成的都是一个全新的组件，组件的唯一标识响应的也会改变，如果在 render 方法调用了高阶组件，这会导致组件每次都会被卸载后重新挂载。</p> <h4 id="约定-不要改变原始组件"><a href="#约定-不要改变原始组件" class="header-anchor">#</a> 约定 — 不要改变原始组件</h4> <p>高阶组件就是一个没有副作用的纯函数。如果我们在高阶组件对原组件进行了修改，例如下面的代码：</p> <div class="language-typescript line-numbers-mode"><pre class="language-typescript"><code>InputComponent<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">componentWillReceiveProps</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span>nextProps<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>这样就破坏了我们对高阶组件的约定，同时也改变了使用高阶组件的初衷：我们使用高阶组件是为了增强而非改变原组件。</p> <h4 id="约定-透传不相关的props"><a href="#约定-透传不相关的props" class="header-anchor">#</a> 约定 — 透传不相关的props</h4> <p>使用高阶组件，我们可以代理所有的 props，但往往特定的 HOC 只会用到其中的一个或几个 props。我们需要把其他不相关的 props 透传给原组件，如下面的代码：</p> <div class="language-typescript line-numbers-mode"><pre class="language-typescript"><code><span class="token comment">// 我们只使用visible属性来控制组件的显示可隐藏，把其他props透传下去。</span>
<span class="token keyword">function</span> <span class="token function">visible</span><span class="token punctuation">(</span>WrappedComponent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token keyword">extends</span></span> Component <span class="token punctuation">{</span>
    <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> <span class="token punctuation">{</span> visible<span class="token punctuation">,</span> <span class="token operator">...</span>props <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>visible <span class="token operator">===</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token operator">&lt;</span>WrappedComponent <span class="token punctuation">{</span><span class="token operator">...</span>props<span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><h4 id="约定-displayname"><a href="#约定-displayname" class="header-anchor">#</a> 约定 — displayName</h4> <p>在使用React Developer Tools进行调试时，如果我们使用了HOC，调试界面可能变得非常难以阅读。</p> <p>为了方便调试，我们可以手动为HOC指定一个displayName，官方推荐使用HOCName(WrappedComponentName)：</p> <div class="language-typescript line-numbers-mode"><pre class="language-typescript"><code><span class="token keyword">static</span> displayName <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Visible(</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>WrappedComponent<span class="token punctuation">.</span>displayName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">)</span><span class="token template-punctuation string">`</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h4 id="hoc-的缺陷"><a href="#hoc-的缺陷" class="header-anchor">#</a> HOC 的缺陷</h4> <ul><li><strong>扩展性限制</strong>: HOC 并不能完全替代 Mixin，一些场景下，Mixin 可以而 HOC 做不到，比如 PureRenderMixin，因为 HOC 无法从外部访问子组件的 state，同时通过 shouldComponentUpdate 滤掉不必要的更新，因此，React 在支持 ES6 Class 之后提供了  React.PureComponent  来解决这个问题。</li> <li><strong>Ref 传递问题</strong>: Ref 被隔断，Ref 的传递问题在层层包装下相当恼人，函数 Ref 能够缓解一部分(让 HOC 得以获知节点创建与销毁)，以致于后来有了 React.forwardRef API。</li> <li><strong>WrapperHell:</strong> HOC 泛滥，出现 WrapperHell (没有包一层解决不了的问题，如果有，那就包两层)，多层抽象同样增加了复杂度和理解成本，这是最关键的缺陷，而 HOC 模式下没有很好的解决办法。</li> <li><strong>props 冲突</strong>：HOC 可以劫持 props，在不遵守约定的情况下也可能造成冲突。</li></ul> <h3 id="render-props"><a href="#render-props" class="header-anchor">#</a> Render Props</h3> <p><code>render props</code> 指在一种 React 组件之间使用一个值为函数的 props 共享代码的简单技术，具有 <code>render props</code> 的组件接收一个函数，该函数返回一个 React 元素并调用它而不是实现一个自己的渲染逻辑，render props 是一个用于告知组件需要渲染什么内容的函数 props，也是组件逻辑复用的一种实现方式，简单来说就是在被复用的组件中，通过一个名为 render(属性名也可以不是render，只要值是一个函数即可)的 prop 属性，该属性是一个函数，这个函数接受一个对象并返回一个子组件，会将这个函数参数中的对象作为 props 传入给新生成的组件，而在使用调用者组件这里，只需要决定这个组件在哪里渲染以及该以何种逻辑渲染并传入相关对象即可。</p> <p>对比 HOC 与 Render Props，技术上，二者都基于组件组合机制，Render Props 拥有与 HOC 一样的扩展能力。称之为 <code>Render Props</code>，并不是说只能用来复用渲染逻辑，而是表示在这种模式下，组件是通过 render() 组合起来的，类似于 HOC 模式下通过 Wrapper 的 render() 建立组合关系形式上，二者非常相像，同样都会产生一层Wrapper，而实际上 Render Props 与 HOC 甚至能够相互转换。</p> <p>同样，<code>Render Props</code> 也会存在一些问题:</p> <ul><li>数据流向更直观了，子孙组件可以很明确地看到数据来源，但本质上Render Props是基于闭包实现的，大量地用于组件的复用将不可避免地引入了 callback hell 问题。</li> <li>丢失了组件的上下文，因此没有 <code>this.props</code> 属性，不能像 HOC 那样访问 <code>this.props.children</code>。</li></ul> <h3 id="使用-hooks-的动机"><a href="#使用-hooks-的动机" class="header-anchor">#</a> 使用 Hooks 的动机</h3> <p>为什么要引入Hooks ？Hooks解决了什么问题？</p> <p>在 hooks 之前组件状态复用有以下几个痛点：</p> <p><strong>1. 组件复用逻辑难 - 减少状态逻辑复用的风险和地狱式嵌套</strong></p> <p>没有 hooks 之前使用 render props（渲染属性） 、 HOC （高阶组件）以及 状态管理框架。render props 是接受一个组件作为props， HOC 是一个函数，接受一个组件作为参数，返回另一个组件。但无论是渲染属性，还是高阶组件，都会在原先的组件外包裹一层父容器（一般都是 div 元素），导致层级冗余，形成“嵌套地狱”，调试困难。类组件有着耦合性高的缺点，数据之间和功能部分的重复较高，数据问题 Redux 和 flux 解决了问题。hooks的出现就是为了解决功能复用的问题。</p> <ul><li>Hook 和 Mixin 在用法上有一定的相似之处，但是 Mixin 引入的逻辑和状态是可以相互覆盖的，而多个Hook之间互不影响，这让我们不需要在把一部分精力放在防止避免逻辑复用的冲突上。</li> <li>HOC 的使用在不遵守约定的情况下使用也有可能带来一定冲突，比如 props 覆盖等等，使用 Hook 则可以避免这些问题。</li></ul> <p><strong>2. 复杂组件状态逻辑多 - 让组件更易理解</strong></p> <p>很多组件在最开始写的时候都是很简单的，基本上就是只做一件事，当你的业务逻辑变得复杂之后，组件也会变得复杂起来。大多数情况下，我们不大可能把组件拆分的更小，因为可能有很多共用的状态逻辑，拆分后，组件之间的通信也会很复杂，甚至需要引用 Redux 来管理组件之间的状态。类组件中到处都是对状态的访问和处理，导致组件难以拆分成更小的组件。使用Hook，可以让你更大限度的将公用逻辑抽离，将一个组件分割成更小的函数，而不是强制基于生命周期方法进行分割。</p> <p><strong>3. class学习成本高 - 函数替代 class</strong></p> <p>相比函数，编写一个 class 可能需要掌握更多的知识，需要注意的点也越多，比如 this 指向、绑定事件等等。另外，计算机理解一个函数比理解一个 class 更快。Hooks 让你可以在 class 之外使用更多 React 的新特性。</p> <p>Redux 的作者 Dan Abramov 总结了类组件的几个缺点：</p> <ul><li>大型组件很难拆分和重构，也很难测试。</li> <li>业务逻辑分散在组件的各个方法之中，导致重复逻辑或关联逻辑。</li> <li>组件类引入了复杂的编程模式，比如 render props 和高阶组件。</li></ul> <p><strong>React Hooks 的意思是，组件尽量写成纯函数，如果需要外部功能和副作用，就用钩子把外部代码&quot;钩&quot;进来。</strong> React Hooks 就是那些钩子。你需要什么功能，就使用什么钩子。React 默认提供了一些常用钩子，你也可以封装自己的钩子。</p> <p><strong>hook 有以下几个作用和好处，以此解决上述痛点：</strong></p> <ul><li>让函数式组件拥有自身的状态和生命周期，在没有使用Class的情况下使用React特性。</li> <li>让组件的通用逻辑复用更简单（跨组件复用，只共享数据处理逻辑，不会共享数据本身），避免使用HOC来复用组件的通用逻辑带来嵌套地狱的问题。</li> <li>状态与 UI 隔离。正是由于 Hooks 的特性，状态逻辑会变成更小的粒度(<strong>相互关联的部分拆分成更小的函数方便复用</strong>)，并且极容易被抽象成一个自定义 Hooks，组件中的状态和 UI 变得更为清晰和隔离。</li></ul> <p><strong>hook 也有以下几个缺点：</strong></p> <ul><li>额外的学习成本，主要在于 Functional Component 与 Class Component 之间的比较上。</li> <li>写法上有限制(不能出现在条件、循环中)，并且写法限制增加了重构成本。</li> <li>破坏了 PureComponent、React.memo 浅比较的性能优化效果，为了取最新的 props 和 state，每次 render() 都要重新创建事件处函数。</li> <li>在闭包场景可能会引用到旧的state、props值。</li> <li>内部实现上不直观，依赖一份可变的全局状态，不再那么pure。</li> <li>React.memo 并不能完全替代 shouldComponentUpdate (因为拿不到 state change，只针对 props change)。</li> <li>useState API 设计上不太完美。</li></ul> <h3 id="hooks-注意事项"><a href="#hooks-注意事项" class="header-anchor">#</a> hooks 注意事项</h3> <h4 id="不是所有的依赖都必须放到依赖数组中"><a href="#不是所有的依赖都必须放到依赖数组中" class="header-anchor">#</a> 不是所有的依赖都必须放到依赖数组中</h4> <p>useEffect 使用规范：“useEffect 中使用到外部变量，都应该放到第二个数组参数中”，同时我们会安装 <a href="https://www.npmjs.com/package/eslint-plugin-react-hooks#installation" target="_blank" rel="noopener noreferrer">eslint-plugin-react-hooks<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 插件，来提醒自己是不是忘了某些变量。但是当满足 useEffect 使用规范时，业务需求就不能满足了。当满足业务需求时，useEffect 就不规范了。我的建议为：</p> <ul><li>不要使用 eslint-plugin-react-hooks 插件，或者可以选择性忽略该插件的警告。</li> <li>只有一种情况，需要把变量放到 deps 数组中，那就是当该变量变化时，需要触发 useEffect 函数执行。而不是因为 useEffect 中用到了这个变量！</li></ul> <h4 id="deps-参数不能缓解闭包问题"><a href="#deps-参数不能缓解闭包问题" class="header-anchor">#</a> deps 参数不能缓解闭包问题</h4> <p>假如完全按第二个建议来写代码，很多人又担心，会不会造成一些不必要的闭包问题？我的结论是：闭包问题和 useEffect 的 deps 参数没有太大关系。</p> <h4 id="延迟调用会存在闭包问题"><a href="#延迟调用会存在闭包问题" class="header-anchor">#</a> 延迟调用会存在闭包问题</h4> <p>在延迟调用的场景下，一定会存在闭包问题。 什么是延迟调用？使用 setTimeout、setInterval、Promise.then 等</p> <h4 id="useeffect-的卸载函数"><a href="#useeffect-的卸载函数" class="header-anchor">#</a> useEffect 的卸载函数</h4> <p>通过 useRef 来保证任何时候访问的 countRef.current 都是最新的，以解决闭包问题。到这里，我重申下我对 useEffect 的建议：</p> <ul><li>只有变化时，需要重新执行 useEffect 的变量，才要放到 deps 中。而不是 useEffect 用到的变量都放到 deps 中。</li> <li>在有延迟调用场景时，可以通过 ref 来解决闭包问题。</li></ul> <h4 id="usecallback-建议不使用"><a href="#usecallback-建议不使用" class="header-anchor">#</a> useCallback 建议不使用</h4> <p>useCallback 可以记住函数，避免函数重复生成，这样函数在传递给子组件时，可以避免子组件重复渲染，提高性能。但是使用前提是，子组件必须使用了 shouldComponentUpdate 或者 React.memo 来忽略同样的参数重复渲染。否则 useCallback 不仅没有提升性能，反而让代码可读性变的很差。建议一般项目中不用考虑性能优化的问题，也就是不要使用 useCallback 了，除非有个别非常复杂的组件，单独使用即可。期望不要用 useCallback，直接裸写函数就好。</p> <h4 id="usememo-建议适当使用"><a href="#usememo-建议适当使用" class="header-anchor">#</a> useMemo 建议适当使用</h4> <p>useMemo 建议适当使用</p> <h4 id="usestate-要正确使用"><a href="#usestate-要正确使用" class="header-anchor">#</a> useState 要正确使用</h4> <ul><li>能用其他状态计算出来就不用单独声明状态：一个 state 必须不能通过其它 state/props 直接计算出来，否则就不用定义 state。</li> <li>保证数据源唯一。在项目中同一个数据，保证只存储在一个地方。不要既存在 redux 中，又在组件中定义了一个 state 存储。不要既存在父级组件中，又在当前组件中定义了一个 state 存储。不要既存在 url query 中，又在组件中定义了一个 state 存储。</li> <li>useState 适当合并。大量使用了 useSetState 来代替 useState，来管理复杂类型的 state</li></ul> <p><a href="https://juejin.cn/post/6844903815762673671" target="_blank" rel="noopener noreferrer">从Mixin到HOC再到Hook<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><a href="https://juejin.cn/post/6844904162472247304" target="_blank" rel="noopener noreferrer">React组件逻辑复用的那些事儿<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><a href="https://mp.weixin.qq.com/s/968ukIjEhhEOeLD5SQoKaw" target="_blank" rel="noopener noreferrer">源码解析React Hook构建过程：没有设计就是最好的设计<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><a href="https://juejin.cn/post/6940422320427106335" target="_blank" rel="noopener noreferrer">一文吃透React高阶组件(HOC)<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><a href="https://juejin.cn/post/6844903985338400782#heading-0" target="_blank" rel="noopener noreferrer">React Hooks 详解<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><a href="https://juejin.cn/post/6944863057000529933#heading-1" target="_blank" rel="noopener noreferrer">一文吃透react-hooks原理<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/blog/react/warmup/react-css.html" class="prev">
        React 中 CSS 的模块化
      </a></span> <span class="next"><a href="/blog/react/warmup/react-render.html">
        React 渲染优化
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----><!----><!----><!----></div></div>
    <script src="/blog/assets/js/app.41ab4ac0.js" defer></script><script src="/blog/assets/js/2.dec2e75d.js" defer></script><script src="/blog/assets/js/1.5b9e135c.js" defer></script><script src="/blog/assets/js/162.621bdaed.js" defer></script><script src="/blog/assets/js/20.badbb211.js" defer></script>
  </body>
</html>
