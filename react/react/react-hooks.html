<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>React Hooks 理解 | 前端那些事儿</title>
    <meta name="generator" content="VuePress 1.9.10">
    <link rel="icon" href="/blog/logo.png">
    <link rel="manifest" href="/blog/manifest.json">
    <link rel="apple-touch-icon" href="/blog/images/icons/apple-icon-152x152.png">
    <meta name="description" content="我命由我不由天，学习吧少年">
    <meta name="theme-color" content="#3eaf7c">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="msapplication-TileImage" content="/icons/ms-icon-144x144.png">
    <meta name="msapplication-TileColor" content="#000000">
    
    <link rel="preload" href="/blog/assets/css/0.styles.f0017422.css" as="style"><link rel="preload" href="/blog/assets/js/app.f064466e.js" as="script"><link rel="preload" href="/blog/assets/js/2.dec2e75d.js" as="script"><link rel="preload" href="/blog/assets/js/1.5b9e135c.js" as="script"><link rel="preload" href="/blog/assets/js/147.2c1841e6.js" as="script"><link rel="preload" href="/blog/assets/js/20.badbb211.js" as="script"><link rel="prefetch" href="/blog/assets/js/10.cc7e09f3.js"><link rel="prefetch" href="/blog/assets/js/100.092e3032.js"><link rel="prefetch" href="/blog/assets/js/101.a01f5a9d.js"><link rel="prefetch" href="/blog/assets/js/102.354eb4d9.js"><link rel="prefetch" href="/blog/assets/js/103.551b01d6.js"><link rel="prefetch" href="/blog/assets/js/104.4195509f.js"><link rel="prefetch" href="/blog/assets/js/105.5bcfb334.js"><link rel="prefetch" href="/blog/assets/js/106.4d5cd4f9.js"><link rel="prefetch" href="/blog/assets/js/107.56728416.js"><link rel="prefetch" href="/blog/assets/js/108.238ec3f7.js"><link rel="prefetch" href="/blog/assets/js/109.f692a551.js"><link rel="prefetch" href="/blog/assets/js/11.b60c9933.js"><link rel="prefetch" href="/blog/assets/js/110.d9eafe6c.js"><link rel="prefetch" href="/blog/assets/js/111.9786ad77.js"><link rel="prefetch" href="/blog/assets/js/112.c095d75c.js"><link rel="prefetch" href="/blog/assets/js/113.d7cac620.js"><link rel="prefetch" href="/blog/assets/js/114.b45e47bc.js"><link rel="prefetch" href="/blog/assets/js/115.6231612c.js"><link rel="prefetch" href="/blog/assets/js/116.7a3e466d.js"><link rel="prefetch" href="/blog/assets/js/117.b0193462.js"><link rel="prefetch" href="/blog/assets/js/118.ca6cc5f7.js"><link rel="prefetch" href="/blog/assets/js/119.a272e5e9.js"><link rel="prefetch" href="/blog/assets/js/12.c53283e7.js"><link rel="prefetch" href="/blog/assets/js/120.e411196d.js"><link rel="prefetch" href="/blog/assets/js/121.25dc3fe6.js"><link rel="prefetch" href="/blog/assets/js/122.7298b7a6.js"><link rel="prefetch" href="/blog/assets/js/123.f2992c18.js"><link rel="prefetch" href="/blog/assets/js/124.e82e9f6c.js"><link rel="prefetch" href="/blog/assets/js/125.dc111900.js"><link rel="prefetch" href="/blog/assets/js/126.6169b7ee.js"><link rel="prefetch" href="/blog/assets/js/127.ac83a046.js"><link rel="prefetch" href="/blog/assets/js/128.7da5e812.js"><link rel="prefetch" href="/blog/assets/js/129.b7120c7a.js"><link rel="prefetch" href="/blog/assets/js/13.6bdc6b5d.js"><link rel="prefetch" href="/blog/assets/js/130.4b4024eb.js"><link rel="prefetch" href="/blog/assets/js/131.915eca3b.js"><link rel="prefetch" href="/blog/assets/js/132.a72163a9.js"><link rel="prefetch" href="/blog/assets/js/133.80240bab.js"><link rel="prefetch" href="/blog/assets/js/134.59a9c10e.js"><link rel="prefetch" href="/blog/assets/js/135.55b14adc.js"><link rel="prefetch" href="/blog/assets/js/136.7f5d49d2.js"><link rel="prefetch" href="/blog/assets/js/137.d874e123.js"><link rel="prefetch" href="/blog/assets/js/138.ecaa45d9.js"><link rel="prefetch" href="/blog/assets/js/139.ca36818f.js"><link rel="prefetch" href="/blog/assets/js/14.c3201a23.js"><link rel="prefetch" href="/blog/assets/js/140.313b4b35.js"><link rel="prefetch" href="/blog/assets/js/141.fabdffe8.js"><link rel="prefetch" href="/blog/assets/js/142.a43fa987.js"><link rel="prefetch" href="/blog/assets/js/143.163b1e09.js"><link rel="prefetch" href="/blog/assets/js/144.fc4e0adb.js"><link rel="prefetch" href="/blog/assets/js/145.daf7f222.js"><link rel="prefetch" href="/blog/assets/js/146.615ab8bc.js"><link rel="prefetch" href="/blog/assets/js/148.b91d11d4.js"><link rel="prefetch" href="/blog/assets/js/149.14e85f73.js"><link rel="prefetch" href="/blog/assets/js/15.a0b9e44e.js"><link rel="prefetch" href="/blog/assets/js/150.cfc330ab.js"><link rel="prefetch" href="/blog/assets/js/151.ebf83a39.js"><link rel="prefetch" href="/blog/assets/js/152.0a73be52.js"><link rel="prefetch" href="/blog/assets/js/153.8343bfc8.js"><link rel="prefetch" href="/blog/assets/js/154.a1a2eb79.js"><link rel="prefetch" href="/blog/assets/js/155.f698eea1.js"><link rel="prefetch" href="/blog/assets/js/156.a811446e.js"><link rel="prefetch" href="/blog/assets/js/157.0dbe96cb.js"><link rel="prefetch" href="/blog/assets/js/158.6a9a1c38.js"><link rel="prefetch" href="/blog/assets/js/159.9286efb1.js"><link rel="prefetch" href="/blog/assets/js/16.491191e4.js"><link rel="prefetch" href="/blog/assets/js/160.baa0ba8a.js"><link rel="prefetch" href="/blog/assets/js/161.e33c0e8b.js"><link rel="prefetch" href="/blog/assets/js/162.54cf777a.js"><link rel="prefetch" href="/blog/assets/js/163.7ee5e5cb.js"><link rel="prefetch" href="/blog/assets/js/164.cfb88055.js"><link rel="prefetch" href="/blog/assets/js/165.15a2bb66.js"><link rel="prefetch" href="/blog/assets/js/166.6e3d209a.js"><link rel="prefetch" href="/blog/assets/js/167.4c0d455c.js"><link rel="prefetch" href="/blog/assets/js/168.5120246b.js"><link rel="prefetch" href="/blog/assets/js/169.8736d1ee.js"><link rel="prefetch" href="/blog/assets/js/17.89ec8c57.js"><link rel="prefetch" href="/blog/assets/js/170.21af58b6.js"><link rel="prefetch" href="/blog/assets/js/171.0e3f28f1.js"><link rel="prefetch" href="/blog/assets/js/172.7cfd3207.js"><link rel="prefetch" href="/blog/assets/js/173.a2dac462.js"><link rel="prefetch" href="/blog/assets/js/174.d176a202.js"><link rel="prefetch" href="/blog/assets/js/175.a3bde410.js"><link rel="prefetch" href="/blog/assets/js/176.f1f211e6.js"><link rel="prefetch" href="/blog/assets/js/177.ea36edee.js"><link rel="prefetch" href="/blog/assets/js/178.3315e121.js"><link rel="prefetch" href="/blog/assets/js/179.dcab2bcc.js"><link rel="prefetch" href="/blog/assets/js/18.b91f1411.js"><link rel="prefetch" href="/blog/assets/js/180.9317de32.js"><link rel="prefetch" href="/blog/assets/js/181.1f7dc615.js"><link rel="prefetch" href="/blog/assets/js/182.3f627730.js"><link rel="prefetch" href="/blog/assets/js/183.0aae9e4d.js"><link rel="prefetch" href="/blog/assets/js/184.02e612bc.js"><link rel="prefetch" href="/blog/assets/js/185.69086931.js"><link rel="prefetch" href="/blog/assets/js/186.bd208371.js"><link rel="prefetch" href="/blog/assets/js/187.36617b89.js"><link rel="prefetch" href="/blog/assets/js/188.1218d015.js"><link rel="prefetch" href="/blog/assets/js/189.eb1628e7.js"><link rel="prefetch" href="/blog/assets/js/19.cb1f17c8.js"><link rel="prefetch" href="/blog/assets/js/190.c2837a50.js"><link rel="prefetch" href="/blog/assets/js/191.de4c52a2.js"><link rel="prefetch" href="/blog/assets/js/192.fe63255b.js"><link rel="prefetch" href="/blog/assets/js/193.0cd0acb5.js"><link rel="prefetch" href="/blog/assets/js/194.c768d736.js"><link rel="prefetch" href="/blog/assets/js/195.96aee012.js"><link rel="prefetch" href="/blog/assets/js/196.e710792c.js"><link rel="prefetch" href="/blog/assets/js/197.76ca820f.js"><link rel="prefetch" href="/blog/assets/js/198.5a39c6b2.js"><link rel="prefetch" href="/blog/assets/js/199.5a40ce24.js"><link rel="prefetch" href="/blog/assets/js/200.caed4672.js"><link rel="prefetch" href="/blog/assets/js/201.9548a796.js"><link rel="prefetch" href="/blog/assets/js/202.01cd4db0.js"><link rel="prefetch" href="/blog/assets/js/203.2c0f5719.js"><link rel="prefetch" href="/blog/assets/js/204.1fd518d5.js"><link rel="prefetch" href="/blog/assets/js/205.8e640cc0.js"><link rel="prefetch" href="/blog/assets/js/206.8e05dadc.js"><link rel="prefetch" href="/blog/assets/js/207.9d91e0f0.js"><link rel="prefetch" href="/blog/assets/js/208.871c410a.js"><link rel="prefetch" href="/blog/assets/js/209.c989e52c.js"><link rel="prefetch" href="/blog/assets/js/21.bf0041b7.js"><link rel="prefetch" href="/blog/assets/js/210.ec861054.js"><link rel="prefetch" href="/blog/assets/js/211.d97e0d8f.js"><link rel="prefetch" href="/blog/assets/js/212.41aa6b33.js"><link rel="prefetch" href="/blog/assets/js/213.6beb6476.js"><link rel="prefetch" href="/blog/assets/js/214.ecb9407f.js"><link rel="prefetch" href="/blog/assets/js/215.dc28f7ea.js"><link rel="prefetch" href="/blog/assets/js/216.ef219cb8.js"><link rel="prefetch" href="/blog/assets/js/217.b1bc396a.js"><link rel="prefetch" href="/blog/assets/js/22.48390d4f.js"><link rel="prefetch" href="/blog/assets/js/23.35c4ba93.js"><link rel="prefetch" href="/blog/assets/js/24.cc3b12df.js"><link rel="prefetch" href="/blog/assets/js/25.632a83cc.js"><link rel="prefetch" href="/blog/assets/js/26.dc0735bf.js"><link rel="prefetch" href="/blog/assets/js/27.cc85ad1c.js"><link rel="prefetch" href="/blog/assets/js/28.8db05f53.js"><link rel="prefetch" href="/blog/assets/js/29.fb4096e5.js"><link rel="prefetch" href="/blog/assets/js/3.cb0627fa.js"><link rel="prefetch" href="/blog/assets/js/30.17850991.js"><link rel="prefetch" href="/blog/assets/js/31.242683bb.js"><link rel="prefetch" href="/blog/assets/js/32.bf429371.js"><link rel="prefetch" href="/blog/assets/js/33.6ba2a392.js"><link rel="prefetch" href="/blog/assets/js/34.97963f66.js"><link rel="prefetch" href="/blog/assets/js/35.e732926b.js"><link rel="prefetch" href="/blog/assets/js/36.f59db662.js"><link rel="prefetch" href="/blog/assets/js/37.2adb7b7a.js"><link rel="prefetch" href="/blog/assets/js/38.0e4f5d2b.js"><link rel="prefetch" href="/blog/assets/js/39.bc8bdb2d.js"><link rel="prefetch" href="/blog/assets/js/4.cbb57fa7.js"><link rel="prefetch" href="/blog/assets/js/40.fd3db312.js"><link rel="prefetch" href="/blog/assets/js/41.3df10542.js"><link rel="prefetch" href="/blog/assets/js/42.24c30e2f.js"><link rel="prefetch" href="/blog/assets/js/43.b77505bf.js"><link rel="prefetch" href="/blog/assets/js/44.2fe040db.js"><link rel="prefetch" href="/blog/assets/js/45.d1ff2718.js"><link rel="prefetch" href="/blog/assets/js/46.ac4c50a9.js"><link rel="prefetch" href="/blog/assets/js/47.be6cf846.js"><link rel="prefetch" href="/blog/assets/js/48.49c3bebf.js"><link rel="prefetch" href="/blog/assets/js/49.66813cef.js"><link rel="prefetch" href="/blog/assets/js/5.fe065607.js"><link rel="prefetch" href="/blog/assets/js/50.a59a1e39.js"><link rel="prefetch" href="/blog/assets/js/51.a7690724.js"><link rel="prefetch" href="/blog/assets/js/52.cec8f88e.js"><link rel="prefetch" href="/blog/assets/js/53.5a7e2462.js"><link rel="prefetch" href="/blog/assets/js/54.28a6163c.js"><link rel="prefetch" href="/blog/assets/js/55.ab7cb738.js"><link rel="prefetch" href="/blog/assets/js/56.43a18261.js"><link rel="prefetch" href="/blog/assets/js/57.9e6af602.js"><link rel="prefetch" href="/blog/assets/js/58.592a495a.js"><link rel="prefetch" href="/blog/assets/js/59.0077967c.js"><link rel="prefetch" href="/blog/assets/js/6.68cda050.js"><link rel="prefetch" href="/blog/assets/js/60.61e93e53.js"><link rel="prefetch" href="/blog/assets/js/61.70b9139c.js"><link rel="prefetch" href="/blog/assets/js/62.b9e107be.js"><link rel="prefetch" href="/blog/assets/js/63.27a4a598.js"><link rel="prefetch" href="/blog/assets/js/64.89c0e1b1.js"><link rel="prefetch" href="/blog/assets/js/65.29b44d0e.js"><link rel="prefetch" href="/blog/assets/js/66.503fbcc3.js"><link rel="prefetch" href="/blog/assets/js/67.9060f240.js"><link rel="prefetch" href="/blog/assets/js/68.3616a779.js"><link rel="prefetch" href="/blog/assets/js/69.ddb99194.js"><link rel="prefetch" href="/blog/assets/js/7.3b8d63a0.js"><link rel="prefetch" href="/blog/assets/js/70.ef2df8e0.js"><link rel="prefetch" href="/blog/assets/js/71.92541e1d.js"><link rel="prefetch" href="/blog/assets/js/72.187dd3c8.js"><link rel="prefetch" href="/blog/assets/js/73.5af024ef.js"><link rel="prefetch" href="/blog/assets/js/74.28b44d4b.js"><link rel="prefetch" href="/blog/assets/js/75.d9f3b129.js"><link rel="prefetch" href="/blog/assets/js/76.e710d0f9.js"><link rel="prefetch" href="/blog/assets/js/77.59bee4e8.js"><link rel="prefetch" href="/blog/assets/js/78.3e5da7b2.js"><link rel="prefetch" href="/blog/assets/js/79.b588307d.js"><link rel="prefetch" href="/blog/assets/js/80.944e9246.js"><link rel="prefetch" href="/blog/assets/js/81.1abf4136.js"><link rel="prefetch" href="/blog/assets/js/82.8a6dc316.js"><link rel="prefetch" href="/blog/assets/js/83.49fe7db4.js"><link rel="prefetch" href="/blog/assets/js/84.99eb528d.js"><link rel="prefetch" href="/blog/assets/js/85.31f56ab1.js"><link rel="prefetch" href="/blog/assets/js/86.01130ae0.js"><link rel="prefetch" href="/blog/assets/js/87.0c38021a.js"><link rel="prefetch" href="/blog/assets/js/88.95dd3549.js"><link rel="prefetch" href="/blog/assets/js/89.c1fa1707.js"><link rel="prefetch" href="/blog/assets/js/90.790bbd0b.js"><link rel="prefetch" href="/blog/assets/js/91.8bd2e080.js"><link rel="prefetch" href="/blog/assets/js/92.7c81c7c2.js"><link rel="prefetch" href="/blog/assets/js/93.9f5209e3.js"><link rel="prefetch" href="/blog/assets/js/94.70ee66b4.js"><link rel="prefetch" href="/blog/assets/js/95.235343c1.js"><link rel="prefetch" href="/blog/assets/js/96.eb5c2704.js"><link rel="prefetch" href="/blog/assets/js/97.b1e3b815.js"><link rel="prefetch" href="/blog/assets/js/98.9b37860e.js"><link rel="prefetch" href="/blog/assets/js/99.746f24e0.js"><link rel="prefetch" href="/blog/assets/js/vendors~docsearch.bd3cdb54.js">
    <link rel="stylesheet" href="/blog/assets/css/0.styles.f0017422.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/blog/" class="home-link router-link-active"><img src="/blog/logo.png" alt="前端那些事儿" class="logo"> <span class="site-name can-hide">前端那些事儿</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/blog/" class="nav-link">
  主页
</a></div><div class="nav-item"><a href="/blog/base/" class="nav-link">
  前端基础
</a></div><div class="nav-item"><a href="/blog/vue/" class="nav-link">
  Vue
</a></div><div class="nav-item"><a href="/blog/react/" class="nav-link router-link-active">
  React
</a></div><div class="nav-item"><a href="/blog/devops/" class="nav-link">
  前端工程化
</a></div><div class="nav-item"><a href="/blog/mobile/" class="nav-link">
  泛客户端
</a></div><div class="nav-item"><a href="/blog/architecture/" class="nav-link">
  架构与方案
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="GitHub" class="dropdown-title"><span class="title">GitHub</span> <span class="arrow down"></span></button> <button type="button" aria-label="GitHub" class="mobile-dropdown-title"><span class="title">GitHub</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/jonny-wei" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://github.com/jonny-wei/sushi-js" target="_blank" rel="noopener noreferrer" class="nav-link external">
  JS 寿司
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/blog/" class="nav-link">
  主页
</a></div><div class="nav-item"><a href="/blog/base/" class="nav-link">
  前端基础
</a></div><div class="nav-item"><a href="/blog/vue/" class="nav-link">
  Vue
</a></div><div class="nav-item"><a href="/blog/react/" class="nav-link router-link-active">
  React
</a></div><div class="nav-item"><a href="/blog/devops/" class="nav-link">
  前端工程化
</a></div><div class="nav-item"><a href="/blog/mobile/" class="nav-link">
  泛客户端
</a></div><div class="nav-item"><a href="/blog/architecture/" class="nav-link">
  架构与方案
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="GitHub" class="dropdown-title"><span class="title">GitHub</span> <span class="arrow down"></span></button> <button type="button" aria-label="GitHub" class="mobile-dropdown-title"><span class="title">GitHub</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/jonny-wei" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://github.com/jonny-wei/sushi-js" target="_blank" rel="noopener noreferrer" class="nav-link external">
  JS 寿司
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>React</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/react/" aria-current="page" class="sidebar-link">React JSX</a></li><li><a href="/blog/react/warmup/react-component.html" class="sidebar-link">React 组件及通信</a></li><li><a href="/blog/react/warmup/react-state.html" class="sidebar-link">React State</a></li><li><a href="/blog/react/warmup/react-props.html" class="sidebar-link">React Props</a></li><li><a href="/blog/react/warmup/react-lifecycle.html" class="sidebar-link">React 生命周期</a></li><li><a href="/blog/react/warmup/react-ref.html" class="sidebar-link">React Ref</a></li><li><a href="/blog/react/warmup/react-context.html" class="sidebar-link">React Context</a></li><li><a href="/blog/react/warmup/react-css.html" class="sidebar-link">React 中 CSS 的模块化</a></li><li><a href="/blog/react/warmup/react-hoc.html" class="sidebar-link">React HOC</a></li><li><a href="/blog/react/warmup/react-render.html" class="sidebar-link">React 渲染优化</a></li><li><a href="/blog/react/warmup/react-router.html" class="sidebar-link">React Router</a></li><li><a href="/blog/react/warmup/react-redux.html" class="sidebar-link">React Rudex</a></li><li><a href="/blog/react/warmup/react-mobx.html" class="sidebar-link">React Mobx</a></li><li><a href="/blog/react/warmup/react-keepalive.html" class="sidebar-link">实现 KeepAlive</a></li><li><a href="/blog/react/warmup/react-state-v18.html" class="sidebar-link">V18 - Automatic Batching</a></li><li><a href="/blog/react/warmup/react-transition.html" class="sidebar-link">V18 - Transition</a></li><li><a href="/blog/react/warmup/react-suspense.html" class="sidebar-link">V18 - Suspense</a></li><li><a href="/blog/react/warmup/react-useSyncExternalStore.html" class="sidebar-link">V18 - useSyncExternalStore</a></li><li><a href="/blog/react/warmup/react-ssr.html" class="sidebar-link">V18 - Streaming SSR</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>React源码解析</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/react/react/react-reconciler.html" class="sidebar-link">Reconciler 调和器</a></li><li><a href="/blog/react/react/react-priority.html" class="sidebar-link">React 优先级管理</a></li><li><a href="/blog/react/react/react-scheduler.html" class="sidebar-link">Scheduler 调度器</a></li><li><a href="/blog/react/react/react-render.html" class="sidebar-link">Render 阶段</a></li><li><a href="/blog/react/react/react-commit.html" class="sidebar-link">Commit 阶段</a></li><li><a href="/blog/react/react/react-diff.html" class="sidebar-link">React Diff 算法</a></li><li><a href="/blog/react/react/react-hooks.html" aria-current="page" class="active sidebar-link">React Hooks 理解</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/react/react/react-hooks.html#hooks-与-fiber-workinprogress" class="sidebar-link">hooks 与 fiber（workInProgress）</a></li><li class="sidebar-sub-header"><a href="/blog/react/react/react-hooks.html#状态派发" class="sidebar-link">状态派发</a></li><li class="sidebar-sub-header"><a href="/blog/react/react/react-hooks.html#处理副作用" class="sidebar-link">处理副作用</a></li><li class="sidebar-sub-header"><a href="/blog/react/react/react-hooks.html#状态获取与状态缓存" class="sidebar-link">状态获取与状态缓存</a></li><li class="sidebar-sub-header"><a href="/blog/react/react/react-hooks.html#自定义-hooks" class="sidebar-link">自定义 hooks</a></li><li class="sidebar-sub-header"><a href="/blog/react/react/react-hooks.html#自定义-hooks-设计" class="sidebar-link">自定义 hooks 设计</a></li><li class="sidebar-sub-header"><a href="/blog/react/react/react-hooks.html#自定义-hooks-实践" class="sidebar-link">自定义 hooks 实践</a></li><li class="sidebar-sub-header"><a href="/blog/react/react/react-hooks.html#usequerytable" class="sidebar-link">useQueryTable</a></li><li class="sidebar-sub-header"><a href="/blog/react/react/react-hooks.html#usecreatestore-useconnect" class="sidebar-link">useCreateStore | useConnect</a></li></ul></li><li><a href="/blog/react/react/react-context.html" class="sidebar-link">React Context 原理</a></li><li><a href="/blog/react/react/react-event.html" class="sidebar-link">React 事件系统</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="react-hooks-理解"><a href="#react-hooks-理解" class="header-anchor">#</a> React Hooks 理解</h1> <ul><li>React Hooks 为什么必须在函数组件内部执行？React 如何能够监听 React Hooks 在外部执行并抛出异常。</li> <li>React Hooks 如何把状态保存起来？保存的信息存在了哪里？</li> <li>React Hooks 为什么不能写在条件语句中？</li> <li>useMemo 内部引用 useRef 为什么不需要添加依赖项，而 useState 就要添加依赖项。</li> <li>useEffect 添加依赖项 props.a ，为什么 props.a 改变，useEffect 回调函数 create 重新执行。</li> <li>React 内部如何区别 useEffect 和 useLayoutEffect ，执行时机有什么不同？</li></ul> <p>先设想一下，如果没有 Hooks，函数组件能够做的只是接受 Props、渲染 UI ，以及触发父组件传过来的事件。所有的处理逻辑都要在类组件中写，这样会使 class 类组件内部错综复杂，每一个类组件都有一套独特的状态，相互之间不能复用，即便是 React 之前出现过 mixin 等复用方式，但是伴随出 mixin 模式下隐式依赖，代码冲突覆盖等问题，也不能成为 React 的中流砥柱的逻辑复用方案。所以 React 放弃 mixin 这种方式。</p> <p>类组件是一种面向对象思想的体现，类组件之间的状态会随着功能增强而变得越来越臃肿，代码维护成本也比较高，而且不利于后期 tree shaking。所以有必要做出一套函数组件代替类组件的方案，于是 Hooks 也就理所当然的诞生了。</p> <p>所以 Hooks 出现本质上原因是：</p> <ul><li>让函数组件也能做类组件的事，有自己的状态，可以处理一些副作用，能获取 ref ，也能做数据缓存。</li> <li>解决逻辑复用难的问题。</li> <li>放弃面向对象编程，拥抱函数式编程。</li></ul> <h2 id="hooks-与-fiber-workinprogress"><a href="#hooks-与-fiber-workinprogress" class="header-anchor">#</a> hooks 与 fiber（workInProgress）</h2> <p>类组件的状态比如 state ，context ，props 本质上是存在类组件对应的 fiber 上，包括生命周期比如 componentDidMount ，也是以副作用 effect 形式存在的。那么 Hooks 既然赋予了函数组件如上功能，所以 hooks 本质是离不开函数组件对应的 fiber 的。 hooks 可以作为函数组件本身和函数组件对应的 fiber 之间的沟通桥梁。</p> <p>hooks 对象本质上是主要以三种处理策略存在 React 中：</p> <ul><li><code>ContextOnlyDispatcher</code>： 第一种形态是防止开发者在函数组件外部调用 hooks ，所以第一种就是报错形态，只要开发者调用了这个形态下的 hooks ，就会抛出异常。</li> <li><code>HooksDispatcherOnMount</code>： 第二种形态是函数组件初始化 mount ，因为之前讲过 hooks 是函数组件和对应 fiber 桥梁，这个时候的 hooks 作用就是建立这个桥梁，初次建立其 hooks 与 fiber 之间的关系。</li> <li><code>HooksDispatcherOnUpdate</code>：第三种形态是函数组件的更新，既然与 fiber 之间的桥已经建好了，那么组件再更新，就需要 hooks 去获取或者更新维护状态。</li></ul> <p>一个 hooks 对象应该长成这样：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> HooksDispatcherOnMount <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token comment">/* 函数组件初始化用的 hooks */</span>
    <span class="token literal-property property">useState</span><span class="token operator">:</span> mountState<span class="token punctuation">,</span>
    <span class="token literal-property property">useEffect</span><span class="token operator">:</span> mountEffect<span class="token punctuation">,</span>
    <span class="token operator">...</span>
<span class="token punctuation">}</span>
<span class="token keyword">const</span>  HooksDispatcherOnUpdate <span class="token operator">=</span><span class="token punctuation">{</span><span class="token comment">/* 函数组件更新用的 hooks */</span>
   <span class="token literal-property property">useState</span><span class="token operator">:</span>updateState<span class="token punctuation">,</span>
   <span class="token literal-property property">useEffect</span><span class="token operator">:</span> updateEffect<span class="token punctuation">,</span>
   <span class="token operator">...</span>
<span class="token punctuation">}</span>
<span class="token keyword">const</span> ContextOnlyDispatcher <span class="token operator">=</span> <span class="token punctuation">{</span>  <span class="token comment">/* 当hooks不是函数内部调用的时候，调用这个hooks对象下的hooks，所以报错。 */</span>
   <span class="token literal-property property">useEffect</span><span class="token operator">:</span> throwInvalidHookError<span class="token punctuation">,</span>
   <span class="token literal-property property">useState</span><span class="token operator">:</span> throwInvalidHookError<span class="token punctuation">,</span>
   <span class="token operator">...</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><h3 id="函数组件触发"><a href="#函数组件触发" class="header-anchor">#</a> 函数组件触发</h3> <p>所有函数组件的触发是在 renderWithHooks 方法中，在 fiber 调和过程中，遇到 FunctionComponent 类型的 fiber（函数组件），就会用 updateFunctionComponent 更新 fiber ，在 updateFunctionComponent 内部就会调用 renderWithHooks 。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// react-reconciler/src/ReactFiberHooks.js</span>
<span class="token keyword">let</span> currentlyRenderingFiber
<span class="token keyword">function</span> <span class="token function">renderWithHooks</span><span class="token punctuation">(</span><span class="token parameter">current<span class="token punctuation">,</span>workInProgress<span class="token punctuation">,</span>Component<span class="token punctuation">,</span>props</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    currentlyRenderingFiber <span class="token operator">=</span> workInProgress<span class="token punctuation">;</span>
    workInProgress<span class="token punctuation">.</span>memoizedState <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span> <span class="token comment">/* 每一次执行函数组件之前，先清空状态 （用于存放hooks列表）*/</span>
    workInProgress<span class="token punctuation">.</span>updateQueue <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>    <span class="token comment">/* 清空状态（用于存放effect list） */</span>
    ReactCurrentDispatcher<span class="token punctuation">.</span>current <span class="token operator">=</span>  current <span class="token operator">===</span> <span class="token keyword">null</span> <span class="token operator">||</span> current<span class="token punctuation">.</span>memoizedState <span class="token operator">===</span> <span class="token keyword">null</span> <span class="token operator">?</span> HooksDispatcherOnMount <span class="token operator">:</span> HooksDispatcherOnUpdate <span class="token comment">/* 判断是初始化组件还是更新组件 */</span>
    <span class="token keyword">let</span> children <span class="token operator">=</span> <span class="token function">Component</span><span class="token punctuation">(</span>props<span class="token punctuation">,</span> secondArg<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">/* 执行我们真正函数组件，所有的hooks将依次执行。 */</span>
    ReactCurrentDispatcher<span class="token punctuation">.</span>current <span class="token operator">=</span> ContextOnlyDispatcher<span class="token punctuation">;</span> <span class="token comment">/* 将hooks变成第一种，防止hooks在函数组件外部调用，调用直接报错。 */</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>workInProgress 正在调和更新函数组件对应的 fiber 树。</p> <ul><li>对于类组件 fiber ，用 memoizedState 保存 state 信息，<strong>对于函数组件 fiber ，用 memoizedState 保存 hooks 信息</strong>。</li> <li>对于函数组件 fiber ，updateQueue 存放每个 useEffect/useLayoutEffect 产生的副作用组成的链表。在 commit 阶段更新这些副作用。</li> <li>然后判断组件是初始化流程还是更新流程，如果初始化用 HooksDispatcherOnMount 对象，如果更新用 HooksDispatcherOnUpdate 对象。函数组件执行完毕，将 hooks 赋值给 ContextOnlyDispatcher 对象。<strong>引用的 React hooks都是从 ReactCurrentDispatcher.current 中的， React 就是通过赋予 current 不同的 hooks 对象达到监控 hooks 是否在函数组件内部调用。</strong></li> <li>Component ( props ， secondArg ) 这个时候函数组件被真正的执行，里面每一个 hooks 也将依次执行。</li> <li>每个 hooks 内部为什么能够读取当前 fiber 信息，因为 currentlyRenderingFiber ，函数组件初始化已经把当前 fiber 赋值给 currentlyRenderingFiber ，每个 hooks 内部读取的就是 currentlyRenderingFiber 的内容。</li></ul> <h3 id="hooks-初始化"><a href="#hooks-初始化" class="header-anchor">#</a> hooks 初始化</h3> <p>hooks 如何和 fiber 建立起关系？hooks 初始化流程使用的是 mountState，mountEffect 等初始化节点的hooks，将 hooks 和 fiber 建立起联系，那么是如何建立起关系呢，每一个hooks 初始化都会执行 mountWorkInProgressHook</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// react-reconciler/src/ReactFiberHooks.js</span>
<span class="token keyword">function</span> <span class="token function">mountWorkInProgressHook</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> hook <span class="token operator">=</span> <span class="token punctuation">{</span>  <span class="token literal-property property">memoizedState</span><span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token literal-property property">baseState</span><span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token literal-property property">baseQueue</span><span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span><span class="token literal-property property">queue</span><span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token literal-property property">next</span><span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>workInProgressHook <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment">// 只有一个 hooks</span>
    currentlyRenderingFiber<span class="token punctuation">.</span>memoizedState <span class="token operator">=</span> workInProgressHook <span class="token operator">=</span> hook<span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>  <span class="token comment">// 有多个 hooks</span>
    workInProgressHook <span class="token operator">=</span> workInProgressHook<span class="token punctuation">.</span>next <span class="token operator">=</span> hook<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> workInProgressHook<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>首先函数组件对应 fiber 用 memoizedState 保存 hooks 信息，每一个 hooks 执行都会产生一个 hooks 对象，hooks 对象中，保存着当前 hooks 的信息，不同 hooks 保存的形式不同。每一个 hooks 通过 next 链表建立起关系。</p> <p>假设在一个组件中这么写</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">Index</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">[</span> number<span class="token punctuation">,</span>setNumber <span class="token punctuation">]</span> <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment">// 第一个hooks</span>
    <span class="token keyword">const</span> <span class="token punctuation">[</span> num<span class="token punctuation">,</span> setNum <span class="token punctuation">]</span> <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>      <span class="token comment">// 第二个hooks</span>
    <span class="token keyword">const</span> dom <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">useRef</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span>                 <span class="token comment">// 第三个hooks</span>
    React<span class="token punctuation">.</span><span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>                          <span class="token comment">// 第四个hooks</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>dom<span class="token punctuation">.</span>current<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token operator">&lt;</span>div ref<span class="token operator">=</span><span class="token punctuation">{</span>dom<span class="token punctuation">}</span> <span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>div onClick<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span> <span class="token function">setNumber</span><span class="token punctuation">(</span>number <span class="token operator">+</span> <span class="token number">1</span> <span class="token punctuation">)</span> <span class="token punctuation">}</span> <span class="token operator">&gt;</span> <span class="token punctuation">{</span> number <span class="token punctuation">}</span> <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>div onClick<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span> <span class="token function">setNum</span><span class="token punctuation">(</span>num <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">}</span> <span class="token operator">&gt;</span> <span class="token punctuation">{</span> num <span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>那么如上四个 hooks ，初始化，每个 hooks 内部执行 mountWorkInProgressHook ，然后每一个 hook 通过 next 和下一个 hook 建立起关联，最后在 fiber 上的结构会变成这样:</p> <p><img src="/blog/images/react/hooks1.png" alt="hooks1"></p> <h3 id="hooks-更新"><a href="#hooks-更新" class="header-anchor">#</a> hooks 更新</h3> <p>更新 hooks 逻辑和之前 fiber 章节中讲的双缓冲树更新差不多，会首先取出 workInProgres.alternate 里面对应的 hook ，然后根据之前的 hooks 复制一份，形成新的 hooks 链表关系。这个过程中解释了一个问题，就是<strong>hooks 规则，hooks 为什么要通常放在顶部，hooks 不能写在 if 条件语句中</strong>，因为在更新过程中，如果通过 if 条件语句，增加或者删除 hooks，在复用 hooks 过程中，会产生复用 hooks 状态和当前 hooks 不一致的问题。举一个例子，还是将如上的 demo 进行修改。</p> <p>将第一个 hooks 变成条件判断形式，具体如下：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">Index</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> showNumber <span class="token punctuation">}</span></span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">let</span> number<span class="token punctuation">,</span> setNumber
    showNumber <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token punctuation">[</span> number<span class="token punctuation">,</span>setNumber <span class="token punctuation">]</span> <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 第一个hooks</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>第一次渲染时候 <code>showNumber = true</code> 那么第一个 hooks 会渲染，第二次渲染时候，父组件将 showNumber 设置为 false ，那么第一个 hooks 将不执行，那么更新逻辑会变成这样:</p> <p><img src="/blog/images/react/hooks2.png" alt="hooks2"></p> <p>第二次复用时候已经发现 hooks 类型不同 <code>useState !== useRef</code> ，那么已经直接报错了。所以开发的时候一定注意 hooks 顺序一致性。</p> <h2 id="状态派发"><a href="#状态派发" class="header-anchor">#</a> 状态派发</h2> <p>useState 解决了函数组件没有 state 的问题，让无状态组件有了自己的状态，useState 在 state 章节已经说了基本使用，接下来重点介绍原理使用， useState 和 useReducer 原理大同小异，本质上都是触发更新的函数都是 dispatchAction。</p> <p>比如一段代码中这么写：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token punctuation">[</span> number<span class="token punctuation">,</span>setNumber <span class="token punctuation">]</span> <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>  
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>setNumber 本质就是 dispatchAction 。首先需要看一下执行 <code>useState(0)</code> 本质上做了些什么？</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// react-reconciler/src/ReactFiberHooks.js</span>
<span class="token keyword">function</span> <span class="token function">mountState</span><span class="token punctuation">(</span><span class="token parameter">initialState</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
     <span class="token keyword">const</span> hook <span class="token operator">=</span> <span class="token function">mountWorkInProgressHook</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> initialState <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>initialState <span class="token operator">=</span> <span class="token function">initialState</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span> <span class="token comment">// 如果 useState 第一个参数为函数，执行函数得到初始化state</span>
     hook<span class="token punctuation">.</span>memoizedState <span class="token operator">=</span> hook<span class="token punctuation">.</span>baseState <span class="token operator">=</span> initialState<span class="token punctuation">;</span>
    <span class="token keyword">const</span> queue <span class="token operator">=</span> <span class="token punctuation">(</span>hook<span class="token punctuation">.</span>queue <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 负责记录更新的各种状态。</span>
    <span class="token keyword">const</span> dispatch <span class="token operator">=</span> <span class="token punctuation">(</span>queue<span class="token punctuation">.</span>dispatch <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token function">dispatchAction</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>  <span class="token keyword">null</span><span class="token punctuation">,</span>currentlyRenderingFiber<span class="token punctuation">,</span>queue<span class="token punctuation">,</span> <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// dispatchAction 为更新调度的主要函数 </span>
    <span class="token keyword">return</span> <span class="token punctuation">[</span>hook<span class="token punctuation">.</span>memoizedState<span class="token punctuation">,</span> dispatch<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><ul><li>上面的 state 会被当前 hooks 的 <code>memoizedState</code> 保存下来，每一个 useState 都会创建一个 <code>queue</code> 里面保存了更新的信息。</li> <li>每一个 useState 都会创建一个更新函数，比如如上的 setNumber 本质上就是 dispatchAction，那么值得注意一点是，当前的 fiber 被 bind 绑定了固定的参数传入 dispatchAction 和 queue ，所以当用户触发 setNumber 的时候，能够直观反映出来自哪个 fiber 的更新。</li> <li>最后把 memoizedState dispatch 返回给开发者使用。</li></ul> <p>接下来重点研究一下 <code>dispatchAction</code> ，底层是怎么处理更新逻辑的。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">dispatchAction</span><span class="token punctuation">(</span><span class="token parameter">fiber<span class="token punctuation">,</span> queue<span class="token punctuation">,</span> action</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">/* 第一步：创建一个 update */</span>
    <span class="token keyword">const</span> update <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span>
    <span class="token keyword">const</span> pending <span class="token operator">=</span> queue<span class="token punctuation">.</span>pending<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>pending <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment">/* 第一个待更新任务 */</span>
        update<span class="token punctuation">.</span>next <span class="token operator">=</span> update<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>  <span class="token comment">/* 已经有带更新任务 */</span>
       update<span class="token punctuation">.</span>next <span class="token operator">=</span> pending<span class="token punctuation">.</span>next<span class="token punctuation">;</span>
       pending<span class="token punctuation">.</span>next <span class="token operator">=</span> update<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span> fiber <span class="token operator">===</span> currentlyRenderingFiber <span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">/* 说明当前fiber正在发生调和渲染更新，那么不需要更新 */</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
       <span class="token keyword">if</span><span class="token punctuation">(</span>fiber<span class="token punctuation">.</span>expirationTime <span class="token operator">===</span> NoWork <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>alternate <span class="token operator">===</span> <span class="token keyword">null</span> <span class="token operator">||</span> alternate<span class="token punctuation">.</span>expirationTime <span class="token operator">===</span> NoWork<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">const</span> lastRenderedReducer <span class="token operator">=</span> queue<span class="token punctuation">.</span>lastRenderedReducer<span class="token punctuation">;</span>
            <span class="token keyword">const</span> currentState <span class="token operator">=</span> queue<span class="token punctuation">.</span>lastRenderedState<span class="token punctuation">;</span>                 <span class="token comment">/* 上一次的state */</span>
            <span class="token keyword">const</span> eagerState <span class="token operator">=</span> <span class="token function">lastRenderedReducer</span><span class="token punctuation">(</span>currentState<span class="token punctuation">,</span> action<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">/* 这一次新的state */</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">is</span><span class="token punctuation">(</span>eagerState<span class="token punctuation">,</span> currentState<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                           <span class="token comment">/* 如果每一个都改变相同的state，那么组件不更新 */</span>
               <span class="token keyword">return</span> 
            <span class="token punctuation">}</span>
       <span class="token punctuation">}</span>
       <span class="token function">scheduleUpdateOnFiber</span><span class="token punctuation">(</span>fiber<span class="token punctuation">,</span> expirationTime<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">/* 发起调度更新 */</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><p>原来当每一次改变 state ，底层会做这些事。</p> <ul><li>首先用户每一次调用 dispatchAction（比如如上触发 setNumber ）都会先创建一个 update ，然后把它放入待更新 pending 队列中。</li> <li>然后判断如果当前的 fiber 正在更新，那么也就不需要再更新了。</li> <li>反之，说明当前 fiber 没有更新任务，那么会拿出上一次 state 和 这一次 state 进行对比，如果相同，那么直接退出更新。如果不相同，那么发起更新调度任务。<strong>这就解释了，为什么函数组件 useState 改变相同的值，组件不更新了。</strong></li></ul> <p>接下来就是更新的环节，下面模拟一个更新场景。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">default</span>  <span class="token keyword">function</span> <span class="token function">Index</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">[</span> number <span class="token punctuation">,</span> setNumber <span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> <span class="token function-variable function">handleClick</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
        <span class="token function">setNumber</span><span class="token punctuation">(</span><span class="token parameter">num</span><span class="token operator">=&gt;</span> num <span class="token operator">+</span> <span class="token number">1</span> <span class="token punctuation">)</span> <span class="token comment">// num = 1</span>
        <span class="token function">setNumber</span><span class="token punctuation">(</span><span class="token parameter">num</span><span class="token operator">=&gt;</span> num <span class="token operator">+</span> <span class="token number">2</span> <span class="token punctuation">)</span> <span class="token comment">// num = 3 </span>
        <span class="token function">setNumber</span><span class="token punctuation">(</span><span class="token parameter">num</span><span class="token operator">=&gt;</span> num <span class="token operator">+</span> <span class="token number">3</span> <span class="token punctuation">)</span> <span class="token comment">// num = 6</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token operator">&lt;</span>div<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">handleClick</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span> <span class="token operator">&gt;</span>点击 <span class="token punctuation">{</span> number <span class="token punctuation">}</span> <span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><ul><li>如上当点击一次按钮，触发了三次 setNumber，等于触发了三次 dispatchAction ，那么这三次 update 会在当前 hooks 的 pending 队列中，然后事件批量更新的概念，会统一合成一次更新。接下来就是组件渲染，那么就到了再一次执行 useState，此时走的是更新流程。那么试想一下点击 handleClick 最后 state 被更新成 6 ，那么在更新逻辑中 useState 内部要做的事，就是<strong>得到最新的 state 。</strong></li></ul> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">updateReducer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">// 第一步把待更新的pending队列取出来。合并到 baseQueue</span>
    <span class="token keyword">const</span> first <span class="token operator">=</span> baseQueue<span class="token punctuation">.</span>next<span class="token punctuation">;</span>
    <span class="token keyword">let</span> update <span class="token operator">=</span> first<span class="token punctuation">;</span>
   <span class="token keyword">do</span> <span class="token punctuation">{</span>
        <span class="token comment">/* 得到新的 state */</span>
        newState <span class="token operator">=</span> <span class="token function">reducer</span><span class="token punctuation">(</span>newState<span class="token punctuation">,</span> action<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>update <span class="token operator">!==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> update <span class="token operator">!==</span> first<span class="token punctuation">)</span><span class="token punctuation">;</span>
     hook<span class="token punctuation">.</span>memoizedState <span class="token operator">=</span> newState<span class="token punctuation">;</span>
     <span class="token keyword">return</span> <span class="token punctuation">[</span>hook<span class="token punctuation">.</span>memoizedState<span class="token punctuation">,</span> dispatch<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><ul><li>当再次执行useState的时候，会触发更新hooks逻辑，本质上调用的就是 updateReducer，如上会把待更新的队列 pendingQueue 拿出来，合并到 <code>baseQueue</code>，循环进行更新。</li> <li>循环更新的流程，说白了就是执行每一个 <code>num =&gt; num + 1</code> ，得到最新的 state 。接下来就可以从 useState 中得到最新的值。</li></ul> <p>用一幅图来描述整个流程：</p> <p><img src="/blog/images/react/hooks3.png" alt="hooks3"></p> <h2 id="处理副作用"><a href="#处理副作用" class="header-anchor">#</a> 处理副作用</h2> <h3 id="初始化"><a href="#初始化" class="header-anchor">#</a> 初始化</h3> <p>在 render 阶段，实际没有进行真正的 DOM 元素的增加，删除，React 把想要做的不同操作打成不同的 effectTag ，等到 <code>commit</code> 阶段，统一处理这些副作用，包括 DOM 元素增删改，执行一些生命周期等。hooks 中的 <code>useEffect</code> 和 <code>useLayoutEffect</code> 也是副作用，接下来以 effect 为例子，看一下 React 是如何处理 useEffect 副作用的。</p> <p>下面还是以初始化和更新两个角度来分析。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">mountEffect</span><span class="token punctuation">(</span><span class="token parameter">create<span class="token punctuation">,</span>deps</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">const</span> hook <span class="token operator">=</span> <span class="token function">mountWorkInProgressHook</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> nextDeps <span class="token operator">=</span> deps <span class="token operator">===</span> <span class="token keyword">undefined</span> <span class="token operator">?</span> <span class="token keyword">null</span> <span class="token operator">:</span> deps<span class="token punctuation">;</span>
    currentlyRenderingFiber<span class="token punctuation">.</span>effectTag <span class="token operator">|=</span> UpdateEffect <span class="token operator">|</span> PassiveEffect<span class="token punctuation">;</span>
    hook<span class="token punctuation">.</span>memoizedState <span class="token operator">=</span> <span class="token function">pushEffect</span><span class="token punctuation">(</span> 
      HookHasEffect <span class="token operator">|</span> hookEffectTag<span class="token punctuation">,</span> 
      create<span class="token punctuation">,</span> <span class="token comment">// useEffect 第一次参数，就是副作用函数</span>
      <span class="token keyword">undefined</span><span class="token punctuation">,</span> 
      nextDeps<span class="token punctuation">,</span> <span class="token comment">// useEffect 第二次参数，deps    </span>
    <span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><ul><li><code>mountWorkInProgressHook</code> 产生一个 hooks ，并和 fiber 建立起关系。</li> <li>通过 <code>pushEffect</code> 创建一个 effect，并保存到当前 hooks 的 <code>memoizedState</code> 属性下。</li> <li><code>pushEffect</code> 除了创建一个 effect ， 还有一个重要作用，就是如果存在多个 <code>effect</code> 或者<code>layoutEffect</code> 会形成一个副作用链表，绑定在函数组件 fiber 的 <code>updateQueue</code> 上。</li></ul> <p>为什么 React 会这么设计呢，首先对于类组件有 <code>componentDidMount/componentDidUpdate</code>  固定的生命周期钩子，用于执行初始化/更新的副作用逻辑，但是对于函数组件，可能存在多个 <code>useEffect/useLayoutEffec</code>t ，hooks 把这些 effect，独立形成链表结构，在 commit 阶段统一处理和执行。</p> <p>如果在一个函数组件中这么写：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>React<span class="token punctuation">.</span><span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'第一个effect'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">[</span> props<span class="token punctuation">.</span>a <span class="token punctuation">]</span><span class="token punctuation">)</span>
React<span class="token punctuation">.</span><span class="token function">useLayoutEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'第二个effect'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
React<span class="token punctuation">.</span><span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'第三个effect'</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>那么在 <code>updateQueue</code> 中，副作用链表会变成如下样子：</p> <p><img src="/blog/images/react/hooks4.png" alt="hooks4"></p> <h3 id="更新"><a href="#更新" class="header-anchor">#</a> 更新</h3> <p>更新流程对于 effect 来说也很简单，首先设想一下 useEffect 更新流程，无非判断是否执行下一次的 effect 副作用函数。还有一些细枝末节。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">updateEffect</span><span class="token punctuation">(</span><span class="token parameter">create<span class="token punctuation">,</span>deps</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">const</span> hook <span class="token operator">=</span> <span class="token function">updateWorkInProgressHook</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">areHookInputsEqual</span><span class="token punctuation">(</span>nextDeps<span class="token punctuation">,</span> prevDeps<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">/* 如果deps项没有发生变化，那么更新effect list就可以了，无须设置 HookHasEffect */</span>
        <span class="token function">pushEffect</span><span class="token punctuation">(</span>hookEffectTag<span class="token punctuation">,</span> create<span class="token punctuation">,</span> destroy<span class="token punctuation">,</span> nextDeps<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> 
    <span class="token comment">/* 如果deps依赖项发生改变，赋予 effectTag ，在commit节点，就会再次执行我们的effect  */</span>
    currentlyRenderingFiber<span class="token punctuation">.</span>effectTag <span class="token operator">|=</span> fiberEffectTag
    hook<span class="token punctuation">.</span>memoizedState <span class="token operator">=</span> <span class="token function">pushEffect</span><span class="token punctuation">(</span>HookHasEffect <span class="token operator">|</span> hookEffectTag<span class="token punctuation">,</span>create<span class="token punctuation">,</span>destroy<span class="token punctuation">,</span>nextDeps<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>更新 effect 的过程非常简单，就是判断 deps 项有没有发生变化，如果没有发生变化，更新副作用链表就可以了；如果发生变化，更新链表同时，打执行副作用的标签：<code>fiber =&gt; fiberEffectTag，hook =&gt; HookHasEffect</code>。在 commit 阶段就会根据这些标签，重新执行副作用。</p> <h3 id="不同的-effect"><a href="#不同的-effect" class="header-anchor">#</a> 不同的 effect</h3> <p>关于 <code>EffectTag</code> 的思考：</p> <ul><li>React 会用不同的 <code>EffectTag</code> 来标记不同的 effect，对于<code>useEffect</code> 会标记 <code>UpdateEffect | PassiveEffect</code>， <code>UpdateEffect</code> 是证明此次更新需要更新 effect ，<code>HookPassive</code> 是 <code>useEffect</code> 的标识符，对于 <code>useLayoutEffect</code> 第一次更新会打上 <code>HookLayout</code> 的标识符。<strong>React 就是在 commit 阶段，通过标识符，证明是 <code>useEffect</code> 还是 <code>useLayoutEffect</code> ，接下来 React 会同步处理 <code>useLayoutEffect</code> ，异步处理 <code>useEffect</code></strong> 。</li> <li>如果函数组件需要更新副作用，会标记 <code>UpdateEffect</code>，至于哪个effect 需要更新，那就看 hooks 上有没有 <code>HookHasEffect</code> 标记，所以初始化或者 deps 不想等，就会给当前 hooks 标记上 <code>HookHasEffect</code> ，所以会执行组件的副作用钩子。</li></ul> <h2 id="状态获取与状态缓存"><a href="#状态获取与状态缓存" class="header-anchor">#</a> 状态获取与状态缓存</h2> <h3 id="对于-ref-处理"><a href="#对于-ref-处理" class="header-anchor">#</a> 对于 ref 处理</h3> <p>在 ref 章节详细介绍过，useRef 就是创建并维护一个 ref 原始对象。用于获取原生 DOM 或者组件实例，或者保存一些状态等。</p> <p>创建：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">mountRef</span><span class="token punctuation">(</span><span class="token parameter">initialValue</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> hook <span class="token operator">=</span> <span class="token function">mountWorkInProgressHook</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> ref <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token literal-property property">current</span><span class="token operator">:</span> initialValue<span class="token punctuation">}</span><span class="token punctuation">;</span>
  hook<span class="token punctuation">.</span>memoizedState <span class="token operator">=</span> ref<span class="token punctuation">;</span> <span class="token comment">// 创建ref对象。</span>
  <span class="token keyword">return</span> ref<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>更新：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">updateRef</span><span class="token punctuation">(</span><span class="token parameter">initialValue</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">const</span> hook <span class="token operator">=</span> <span class="token function">updateWorkInProgressHook</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">return</span> hook<span class="token punctuation">.</span>memoizedState <span class="token comment">// 取出复用ref对象。</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>如上 ref 创建和更新过程，就是 ref 对象的创建和复用过程。</p> <h3 id="对于-usememo-的处理"><a href="#对于-usememo-的处理" class="header-anchor">#</a> 对于 useMemo 的处理</h3> <p>对于 useMemo ，逻辑比 useRef 复杂点，但是相对于 useState 和 useEffect 简单的多。</p> <p>创建：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">mountMemo</span><span class="token punctuation">(</span><span class="token parameter">nextCreate<span class="token punctuation">,</span>deps</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">const</span> hook <span class="token operator">=</span> <span class="token function">mountWorkInProgressHook</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> nextDeps <span class="token operator">=</span> deps <span class="token operator">===</span> <span class="token keyword">undefined</span> <span class="token operator">?</span> <span class="token keyword">null</span> <span class="token operator">:</span> deps<span class="token punctuation">;</span>
  <span class="token keyword">const</span> nextValue <span class="token operator">=</span> <span class="token function">nextCreate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  hook<span class="token punctuation">.</span>memoizedState <span class="token operator">=</span> <span class="token punctuation">[</span>nextValue<span class="token punctuation">,</span> nextDeps<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> nextValue<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><ul><li>useMemo 初始化会执行第一个函数得到想要缓存的值，将值缓存到 hook 的 memoizedState 上。</li></ul> <p>更新：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">updateMemo</span><span class="token punctuation">(</span><span class="token parameter">nextCreate<span class="token punctuation">,</span>nextDeps</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">const</span> hook <span class="token operator">=</span> <span class="token function">updateWorkInProgressHook</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> prevState <span class="token operator">=</span> hook<span class="token punctuation">.</span>memoizedState<span class="token punctuation">;</span> 
    <span class="token keyword">const</span> prevDeps <span class="token operator">=</span> prevState<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// 之前保存的 deps 值</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">areHookInputsEqual</span><span class="token punctuation">(</span>nextDeps<span class="token punctuation">,</span> prevDeps<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">//判断两次 deps 值</span>
        <span class="token keyword">return</span> prevState<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">const</span> nextValue <span class="token operator">=</span> <span class="token function">nextCreate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 如果deps，发生改变，重新执行</span>
    hook<span class="token punctuation">.</span>memoizedState <span class="token operator">=</span> <span class="token punctuation">[</span>nextValue<span class="token punctuation">,</span> nextDeps<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> nextValue<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><ul><li>useMemo 更新流程就是对比两次的 dep 是否发生变化，如果没有发生变化，直接返回缓存值，如果发生变化，执行第一个参数函数，重新生成缓存值，缓存下来，供开发者使用。</li></ul> <h2 id="自定义-hooks"><a href="#自定义-hooks" class="header-anchor">#</a> 自定义 hooks</h2> <h3 id="基本概念"><a href="#基本概念" class="header-anchor">#</a> 基本概念</h3> <p>自定义 hooks 是在 React Hooks 基础上的一个拓展，可以根据业务需求制定满足业务需要的组合 hooks ，更注重的是逻辑单元。通过业务场景不同，到底需要React Hooks 做什么，怎么样把一段逻辑封装起来，做到复用，这是自定义 hooks 产生的初衷。</p> <p>自定义 hooks 参数可能是以下内容：</p> <ul><li>hooks 初始化值。</li> <li>一些副作用或事件的回调函数。</li> <li>可以是 useRef 获取的 DOM 元素或者组件实例。</li> <li>不需要参数</li></ul> <p>自定义 hooks 返回值可能是以下内容：</p> <ul><li>负责渲染视图获取的状态。</li> <li>更新函数组件方法，本质上是 useState 或者 useReducer。</li> <li>一些传递给子孙组件的状态。</li> <li>没有返回值。</li></ul> <h3 id="特性"><a href="#特性" class="header-anchor">#</a> 特性</h3> <p>上述讲到了自定义 hooks 基本概念，接下来分析一下它的特性。</p> <h4 id="驱动条件"><a href="#驱动条件" class="header-anchor">#</a> 驱动条件</h4> <p><strong>自定义 hooks 驱动本质上就是函数组件的执行</strong>。</p> <p>自定义 hooks 驱动条件：</p> <ul><li>props 改变带来的函数组件执行。</li> <li>useState | useReducer 改变 state 引起函数组件的更新。</li></ul> <h4 id="顺序原则"><a href="#顺序原则" class="header-anchor">#</a> 顺序原则</h4> <p>自定义 hooks 内部至少有一个 React Hooks ，那么自定义 hooks 也要遵循 hooks 的规则，<strong>不能放在条件语句中，而且要保持执行顺序的一致性。</strong></p> <h4 id="条件限定"><a href="#条件限定" class="header-anchor">#</a> 条件限定</h4> <p>在自定义 hooks 中，条件限定<strong>特别重要</strong>。因为考虑 hooks 的限定条件，是一个出色的自定义 hooks 重要因素。</p> <p>比如在一个自定义这里写：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">useXXX</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">const</span> value <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">useContext</span><span class="token punctuation">(</span>defaultContext<span class="token punctuation">)</span>
    <span class="token comment">/* .....用上下文中 value 一段初始化逻辑  */</span>
    <span class="token keyword">const</span> newValue <span class="token operator">=</span> <span class="token function">initValueFunction</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token comment">/* 初始化 value 得到新的 newValue  */</span>
    <span class="token comment">/* ...... */</span>
    <span class="token keyword">return</span> newValue
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>比如上述一个非常简单自定义 hooks ，从 <code>context</code> 取出状态 value ，通过 <code>initValueFunction</code> 加工 value ，得到并返回最新的 newValue 。如果直接按照上述这么写，会导致什么发生呢？</p> <p>首先每一次函数组件更新，就会执行此自定义 hooks ，那么就会重复执行初始化逻辑，重复执行<code>initValueFunction</code> ，每一次都会得到一个最新的 newValue 。 如果 newValue 作为 <code>useMemo</code> 和 <code>useEffect</code> 的 deps ，或者作为子组件的 props ，那么子组件的浅比较 props 将失去作用，那么会带来一串麻烦。</p> <p>那么如何解决这个问题呢？答案很简单，可以通过 useRef 对 newValue 缓存，然后每次执行自定义 hooks 判断有无缓存值。如下：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">useXXX</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">const</span> newValue <span class="token operator">=</span>  React<span class="token punctuation">.</span><span class="token function">useRef</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span>  <span class="token comment">/* 创建一个 value 保存状态。  */</span>
    <span class="token keyword">const</span> value <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">useContext</span><span class="token punctuation">(</span>defaultContext<span class="token punctuation">)</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>newValue<span class="token punctuation">.</span>current<span class="token punctuation">)</span><span class="token punctuation">{</span>  <span class="token comment">/* 如果 newValue 不存在 */</span>
          newValue<span class="token punctuation">.</span>current <span class="token operator">=</span> <span class="token function">initValueFunction</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> newValue<span class="token punctuation">.</span>current
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><ul><li>用一个 useRef 保存初始化过程中产生的 value 值 。</li> <li>判断如果 value 不存在，那么通过 initValueFunction 创建，如果存在直接返回 newValue.current 。</li></ul> <p>如上加了条件判断之后，会让自定义 hooks 内部按照期望的方向发展。条件限定是编写出色的 hooks 重要的因素。</p> <h4 id="考虑可变性"><a href="#考虑可变性" class="header-anchor">#</a> 考虑可变性</h4> <p>在编写自定义 hooks 的时候，可变性也是一个非常重要的 hooks 特性。什么叫做可变性，<strong>就是考虑一些状态值发生变化，是否有依赖于当前值变化的执行逻辑或执行副作用。</strong></p> <p>比如上面的例子中，如果 defaultContext 中的 value 是可变的，那么如果还像上述用 useRef 这么写，就会造成 context 变化，得不到最新的 value 值的情况发生。</p> <p>所以为了解决上述可变性的问题：</p> <ul><li>对于依赖于可变性状态的执行逻辑，可以用 <code>useMemo</code> 来处理。</li> <li>对于可变性状态的执行副作用，可以用 <code>useEffect</code> 来处理。</li> <li>对于依赖可变性状态的函数或者属性，可以用<code>useCallback</code>来处理。 于是需要把上述自定义 hooks 改版。</li></ul> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">useXXX</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">const</span> value <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">useContext</span><span class="token punctuation">(</span>defaultContext<span class="token punctuation">)</span>
    <span class="token keyword">const</span> newValue <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">useMemo</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span> <span class="token function">initValueFunction</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token punctuation">,</span><span class="token punctuation">[</span>  value  <span class="token punctuation">]</span> <span class="token punctuation">)</span>  
    <span class="token keyword">return</span>  newValue
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><ul><li>用 React.useMemo 来对 initValueFunction 初始化逻辑做缓存，当上下文 value 改变的时候，重新生成新的 newValue 。</li></ul> <h4 id="闭包效应"><a href="#闭包效应" class="header-anchor">#</a> 闭包效应</h4> <p>闭包也是自定义 hooks 应该注意的问题。这个问题和 [考虑可变性] 本质一样。首先函数组件更新就是函数本身执行，一次更新所有含有状态的 hooks （ <code>useState</code> 和 <code>useReducer</code> ）产生的状态 state 是重新声明的。但是如果像 <code>useEffect</code> ， <code>useMemo</code> ，<code>useCallback</code> 等，它们内部如果引用了 state 或 props 的值，而且这些状态最后保存在了函数组件对应的 fiber 上，那么此次函数组件执行完毕后，这些状态就不会被垃圾回收机制回收释放。这样造成的影响是，上述 hooks 如果没有把内部使用的 state 或 props 作为依赖项，那么内部就一直无法使用最新的 props 或者 state 。</p> <p>比如我举个简单的例子。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">useTest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">[</span> number <span class="token punctuation">]</span> <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> value <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">useMemo</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
         <span class="token comment">// 内部引用了 number 进行计算</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><ul><li>如上 useMemo 内部使用了 state 中的 number 进行计算，当 number 改变但是无法得到最新的 value 。这就是上面我说到的闭包问题。解决方法就是 useMemo 的 deps 中加入 number。</li></ul> <p>但是有的时候这种依赖关系往往是更复杂的。我将如上 demo 修改。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">useTest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">[</span> number <span class="token punctuation">]</span> <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> value <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">useMemo</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
         <span class="token comment">// 内部引用了 number 进行计算</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">[</span> number <span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> callback <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">useCallback</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
         <span class="token comment">// 内部引用了 useEffect</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">[</span> value <span class="token punctuation">]</span><span class="token punctuation">)</span>
    
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><ul><li>如上，在之前的基础上，又加了 useCallback 而且内部引用了 useMemo 生成的 value。 这个时候如果 useCallback 执行，内部想要获取新的状态值 value，那么就需要把 value 放在 useCallback 的 deps 中。</li></ul> <p><strong>如何分清楚依赖关系呢？</strong></p> <ul><li><strong>第一步</strong>：找到 hooks 内部可能发生变化的状态 ， 这个状态可以是 state 或者 props。</li> <li><strong>第二步</strong>：分析 useMemo 或者 useCallback 内部是否使用上述状态，或者是否<strong>关联使用</strong> useMemo 或者 useCallback 派生出来的状态（ 比如上述的 value ，就是 useMemo 派生的状态 ） ，如果有使用，那么加入到 deps 。</li> <li><strong>第三步</strong>：分析 useEffect ，useLayoutEffect ，useImperativeHandle 内部是否使用上述两个步骤产生的值，而且还要这些值做一些副作用，如果有，那么加入到 deps 。</li></ul> <h2 id="自定义-hooks-设计"><a href="#自定义-hooks-设计" class="header-anchor">#</a> 自定义 hooks 设计</h2> <p>上述介绍了自定义 hooks 的概念和特性，接下来重点分析一下，如何去设计一个自定义 hooks 。首先明确的一点是，自定义 hooks 解决逻辑复用的问题，那么在正常的业务开发过程中，要明白哪些逻辑是重复性强的逻辑，这段逻辑主要功能是什么。下面我把自定义 hooks 能实现的功能化整为零，在实际开发中，可能是下面一种或者几种的结合。</p> <h3 id="接收状态"><a href="#接收状态" class="header-anchor">#</a> 接收状态</h3> <p>自定义 hooks ，可以通过函数参数来直接接收组件传递过来的状态，也可以通过 useContext ，来隐式获取上下文中的状态。比如 React Router 中最简单的一个自定义 hooks —— useHistory ，用于获取 history 对象。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">useHistory</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">useContext</span><span class="token punctuation">(</span>RouterContext<span class="token punctuation">)</span><span class="token punctuation">.</span>history
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>注意：<strong>如果使用了内部含有 useContext 的自定义 hooks ，那么当 context 上下文改变，会让使用自定义 hooks 的组件自动渲染。</strong></p> <h3 id="存储-管理状态"><a href="#存储-管理状态" class="header-anchor">#</a> 存储｜管理状态</h3> <p><strong>储存状态</strong></p> <p>自定义 hooks 也可以用来储存和管理状态。本质上应用 useRef 保存原始对象的特性。</p> <p>比如 <code>rc-form</code> 中的 <code>useForm</code> 里面就是用 useRef 来保存表单状态管理 Store 的。简化流程如下</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">useForm</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">const</span> formCurrent <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">useRef</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>formCurrent<span class="token punctuation">.</span>current<span class="token punctuation">)</span><span class="token punctuation">{</span>
        formCurrent<span class="token punctuation">.</span>current <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FormStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> formCurrent<span class="token punctuation">.</span>current
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p><strong>记录状态</strong></p> <p>当然 useRef 和 useEffect 可以配合记录函数组件的内部的状态。举个例子，我编写一个自定义 hooks 用于记录函数组件执行次数，和是否第一次渲染。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">useRenderCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">const</span> isFirstRender <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">useRef</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token comment">/* 记录是否是第一次渲染 */</span>
    <span class="token keyword">const</span> renderCount <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">useRef</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>      <span class="token comment">/* 记录渲染次数 */</span>
    <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
        isFirstRender<span class="token punctuation">.</span>current <span class="token operator">=</span> <span class="token boolean">false</span>        <span class="token comment">/* 第一次渲染完成，改变状态 */</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>isFirstRender<span class="token punctuation">.</span>current<span class="token punctuation">)</span> renderCount<span class="token punctuation">.</span>current<span class="token operator">++</span> <span class="token comment">/* 如果不是第一次渲染，那么添加渲染次数  */</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>  
    <span class="token keyword">return</span> <span class="token punctuation">[</span> renderCount<span class="token punctuation">.</span>current <span class="token punctuation">,</span> isFirstRender<span class="token punctuation">.</span>current <span class="token punctuation">]</span>
<span class="token punctuation">}</span> 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><ul><li>如上用 isFirstRender 记录是否是第一次渲染 ，用 renderCount 记录渲染次数，第一个 useEffect 依赖项为空，只执行一次，第二个 useEffect 没有依赖项，每一次函数组件执行，都会执行，统计渲染次数。</li></ul> <h3 id="更新状态"><a href="#更新状态" class="header-anchor">#</a> 更新状态</h3> <p><strong>改变状态</strong></p> <p>自定义 hooks 内部可以保存状态，可以把更新状态的方法暴露出去，来改变 hooks 内部状态。而更新状态的方法可以是组合多态的。</p> <p>比如实现一个防抖节流的自定义 hooks ：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">debounce</span><span class="token punctuation">(</span><span class="token parameter">fn<span class="token punctuation">,</span> time</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> timer <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>arg</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>timer<span class="token punctuation">)</span> <span class="token function">clearTimeout</span><span class="token punctuation">(</span>timer<span class="token punctuation">)</span><span class="token punctuation">;</span>
      timer <span class="token operator">=</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token function">fn</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> arg<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span> time<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">useDebounceState</span><span class="token punctuation">(</span><span class="token parameter">defauleValue<span class="token punctuation">,</span>time</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">[</span> value <span class="token punctuation">,</span> changeValue <span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span>defauleValue<span class="token punctuation">)</span>
    <span class="token comment">/* 对 changeValue 做防抖处理   */</span>
    <span class="token keyword">const</span> newChange <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">useMemo</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span> <span class="token function">debounce</span><span class="token punctuation">(</span>changeValue<span class="token punctuation">,</span>time<span class="token punctuation">)</span> <span class="token punctuation">,</span><span class="token punctuation">[</span> time <span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token punctuation">[</span> value <span class="token punctuation">,</span> newChange <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>使用：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">Index</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">[</span> value <span class="token punctuation">,</span> setValue <span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useDebounceState</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token number">300</span><span class="token punctuation">)</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token operator">&lt;</span>div style<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">{</span> <span class="token literal-property property">marginTop</span><span class="token operator">:</span><span class="token string">'50px'</span> <span class="token punctuation">}</span><span class="token punctuation">}</span> <span class="token operator">&gt;</span>
        《React 进阶实践指南》
        <span class="token operator">&lt;</span>input placeholder<span class="token operator">=</span><span class="token string">&quot;&quot;</span> onChange<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token function">setValue</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>target<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">}</span>  <span class="token operator">/</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p><strong>组合state</strong></p> <p>自定义 hooks 可以维护多个 state ，然后可以组合更新函数。我这么说可能很多同学不理解，下面我来举一个例子，比如控制数据加载和loading效果，</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">useControlData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">[</span> isLoading <span class="token punctuation">,</span> setLoading <span class="token punctuation">]</span> <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">useState</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> <span class="token punctuation">[</span> data<span class="token punctuation">,</span>  setData <span class="token punctuation">]</span> <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">useState</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> <span class="token function-variable function">getData</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span> <span class="token punctuation">{</span> <span class="token comment">/* 获取到数据，清空 loading 效果  */</span>
        <span class="token function">setLoading</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span>
        <span class="token function">setData</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>  
    <span class="token comment">// ... 其他逻辑</span>
    <span class="token keyword">const</span> <span class="token function-variable function">resetData</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span><span class="token punctuation">{</span>  <span class="token comment">/* 请求数据之前，添加 loading 效果 */</span>
        <span class="token function">setLoading</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
        <span class="token function">setData</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token punctuation">[</span> getData <span class="token punctuation">,</span> resetData <span class="token punctuation">,</span> <span class="token operator">...</span>  <span class="token punctuation">]</span> 
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p><strong>合理state</strong></p> <p>useState 和 useRef 都可以保存状态：</p> <ul><li>useRef 只要组件不销毁，一直存在，而且可以随时访问最新状态值。</li> <li>useState 可以让组件更新，但是 state 需要在下一次函数组件执行的时候才更新，而且如果想让 useEffect 或者 useMemo 访问最新的 state 值，需要将 state 添加到 deps 依赖项中。</li></ul> <p>自定义 hooks 可以通过 useState + useRef 的特性，取其精华，更合理的管理 state。比如如下实现一个<strong>同步的state</strong></p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">useSyncState</span><span class="token punctuation">(</span><span class="token parameter">defaultValue</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
   <span class="token keyword">const</span> value <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">useRef</span><span class="token punctuation">(</span>defaultValue<span class="token punctuation">)</span>        <span class="token comment">/* useRef 用于保存状态 */</span>
   <span class="token keyword">const</span> <span class="token punctuation">[</span> <span class="token punctuation">,</span>forceUpdate <span class="token punctuation">]</span> <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">useState</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span>   <span class="token comment">/* useState 用于更新组件 */</span>
   <span class="token keyword">const</span> <span class="token function-variable function">dispatch</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">fn</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>                      <span class="token comment">/* 模拟一个更新函数 */</span>
       <span class="token keyword">let</span> newValue
       <span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token keyword">typeof</span> fn <span class="token operator">===</span> <span class="token string">'function'</span> <span class="token punctuation">)</span><span class="token punctuation">{</span>
            newValue <span class="token operator">=</span> <span class="token function">fn</span><span class="token punctuation">(</span>value<span class="token punctuation">.</span>current<span class="token punctuation">)</span>           <span class="token comment">/* 当参数为函数的情况 */</span>
       <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
           newValue <span class="token operator">=</span> fn                           <span class="token comment">/* 当参数为其他的情况 */</span>
       <span class="token punctuation">}</span>
       value<span class="token punctuation">.</span>current <span class="token operator">=</span> newValue
       <span class="token function">forceUpdate</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>                             <span class="token comment">/* 强制更新 */</span>
   <span class="token punctuation">}</span> 
   <span class="token keyword">return</span> <span class="token punctuation">[</span>  value <span class="token punctuation">,</span> dispatch  <span class="token punctuation">]</span>                   <span class="token comment">/* 返回和 useState 一样的格式 */</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><ul><li>useRef 用于保存状态 ，useState 用于更新组件。</li> <li>做一个 <code>dispatch</code> 处理参数为函数的情况。在 dispatch 内部用 forceUpdate 触发真正的更新。</li> <li>返回的结构和 useState 结构相同。不过注意的是使用的时候要用 value.current 。</li></ul> <p>使用：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">Index</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">[</span> data <span class="token punctuation">,</span> setData  <span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useSyncState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token operator">&lt;</span>div style<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">{</span> <span class="token literal-property property">marginTop</span><span class="token operator">:</span><span class="token string">'50px'</span> <span class="token punctuation">}</span><span class="token punctuation">}</span> <span class="token operator">&gt;</span>
        《React 进阶实践指南》 点赞 👍 <span class="token punctuation">{</span> data<span class="token punctuation">.</span>current <span class="token punctuation">}</span>
       <span class="token operator">&lt;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
           <span class="token function">setData</span><span class="token punctuation">(</span><span class="token parameter">num</span> <span class="token operator">=&gt;</span> num <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span>
           console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>current<span class="token punctuation">)</span> <span class="token comment">//打印到最新的值</span>
       <span class="token punctuation">}</span> <span class="token punctuation">}</span> <span class="token operator">&gt;</span>点击<span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><h3 id="操纵-dom-组件实例"><a href="#操纵-dom-组件实例" class="header-anchor">#</a> 操纵 DOM / 组件实例</h3> <p>自定义 hooks 也可以设计成对原生 DOM 的操纵控制。究其原理用 useRef 获取元素， 在 useEffect 中做元素的监听。</p> <p>比如如下场景，用一个自定义 hooks 做一些基于 DOM 的操作 。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">/* TODO: 操纵原生dom  */</span>
<span class="token keyword">function</span> <span class="token function">useGetDOM</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">const</span> dom <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">useRef</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    React<span class="token punctuation">.</span><span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
       <span class="token comment">/* 做一些基于 dom 的操作 */</span>
       console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>dom<span class="token punctuation">.</span>current<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> dom
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><ul><li>自定义 useGetDOM ，用 useRef 获取 DOM 元素，在 useEffect 中做一些基于 DOM 的操作。</li></ul> <p>使用：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">Index</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">const</span> dom <span class="token operator">=</span> <span class="token function">useGetDOM</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token operator">&lt;</span>div ref<span class="token operator">=</span><span class="token punctuation">{</span> dom <span class="token punctuation">}</span> <span class="token operator">&gt;</span>
        《React进阶实践指南》
        <span class="token operator">&lt;</span>button <span class="token operator">&gt;</span>点赞<span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h3 id="执行副作用"><a href="#执行副作用" class="header-anchor">#</a> 执行副作用</h3> <p>自定义 hooks 也可以执行一些副作用，比如说监听一些 props 或 state 变化而带来的副作用。比如如下监听，当 <code>value</code> 改变的时候，执行 <code>cb</code>。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">useEffectProps</span><span class="token punctuation">(</span><span class="token parameter">value<span class="token punctuation">,</span>cb</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">const</span> isMounted <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">useRef</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span>
    React<span class="token punctuation">.</span><span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
         <span class="token comment">/* 防止第一次执行 */</span>
        isMounted<span class="token punctuation">.</span>current <span class="token operator">&amp;&amp;</span> cb <span class="token operator">&amp;&amp;</span> <span class="token function">cb</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">[</span> value <span class="token punctuation">]</span><span class="token punctuation">)</span>
    React<span class="token punctuation">.</span><span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
          <span class="token comment">/* 第一次挂载 */</span>
         isMounted<span class="token punctuation">.</span>current <span class="token operator">=</span> <span class="token boolean">true</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><ul><li>用 useRef 保存是否第一次的状态。然后在一个 useEffect 改变加载完成状态。</li> <li>只有当不是第一次加载且 value 改变的时候，执行回调函数 cb 。</li> <li>当使用这个自定义 hooks 就可以监听，props 或者 state 变化。接下来尝试一下。</li></ul> <p>使用组件和父组件：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">Index</span><span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token function">useEffectProps</span><span class="token punctuation">(</span> props<span class="token punctuation">.</span>a <span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span><span class="token comment">/* 监听 a 变化 */</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'props a 变化:'</span><span class="token punctuation">,</span> props<span class="token punctuation">.</span>a  <span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token operator">&lt;</span>div<span class="token operator">&gt;</span>子组件<span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
<span class="token punctuation">}</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">Home</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">[</span> a <span class="token punctuation">,</span> setA <span class="token punctuation">]</span> <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> <span class="token punctuation">[</span> b <span class="token punctuation">,</span> setB <span class="token punctuation">]</span> <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token operator">&lt;</span>div<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>Index a<span class="token operator">=</span><span class="token punctuation">{</span>a<span class="token punctuation">}</span>  b<span class="token operator">=</span><span class="token punctuation">{</span>b<span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span> <span class="token function">setA</span><span class="token punctuation">(</span>a<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">}</span> <span class="token operator">&gt;</span>改变 props a  <span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span> <span class="token function">setB</span><span class="token punctuation">(</span>b<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">}</span> <span class="token operator">&gt;</span>改变 props b  <span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><h2 id="自定义-hooks-实践"><a href="#自定义-hooks-实践" class="header-anchor">#</a> 自定义 hooks 实践</h2> <h3 id="uselog"><a href="#uselog" class="header-anchor">#</a> useLog</h3> <p>自动上报 pv/click 的埋点 hooks</p> <p>实现一个能够自动上报 点击事件 | pv 的自定义 hooks 。通过这个自定义 hooks ，将带来的收获是：</p> <ul><li>通过自定义 hooks 控制监听 DOM 元素。</li> <li>分清自定义 hooks 依赖关系。</li></ul> <p><strong>编写</strong></p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">const</span> LogContext <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">createContext</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">useLog</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">/* 一些公共参数 */</span>
    <span class="token keyword">const</span> message <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">useContext</span><span class="token punctuation">(</span>LogContext<span class="token punctuation">)</span>
    <span class="token keyword">const</span> listenDOM <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">useRef</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span>

    <span class="token comment">/* 分清依赖关系 -&gt; message 改变，   */</span>
    <span class="token keyword">const</span> reportMessage <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">useCallback</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">data<span class="token punctuation">,</span>type</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>type<span class="token operator">===</span><span class="token string">'pv'</span><span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token comment">// pv 上报</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'组件 pv 上报'</span><span class="token punctuation">,</span>message<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>type <span class="token operator">===</span> <span class="token string">'click'</span><span class="token punctuation">)</span><span class="token punctuation">{</span>  <span class="token comment">// 点击上报</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'组件 click 上报'</span><span class="token punctuation">,</span>message<span class="token punctuation">,</span>data<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">[</span> message <span class="token punctuation">]</span><span class="token punctuation">)</span>

    React<span class="token punctuation">.</span><span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
        <span class="token keyword">const</span> <span class="token function-variable function">handleClick</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token function">reportMessage</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>target<span class="token punctuation">,</span><span class="token string">'click'</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>listenDOM<span class="token punctuation">.</span>current<span class="token punctuation">)</span><span class="token punctuation">{</span>
            listenDOM<span class="token punctuation">.</span>current<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">,</span>handleClick<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            listenDOM<span class="token punctuation">.</span>current <span class="token operator">&amp;&amp;</span> listenDOM<span class="token punctuation">.</span>current<span class="token punctuation">.</span><span class="token function">removeEventListener</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">,</span>handleClick<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">[</span> reportMessage  <span class="token punctuation">]</span><span class="token punctuation">)</span>

    <span class="token keyword">return</span> <span class="token punctuation">[</span> listenDOM <span class="token punctuation">,</span> reportMessage  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br></div></div><ul><li>用 <code>useContext</code> 获取埋点的公共信息。当公共信息改变，会统一更新。</li> <li>用 <code>useRef</code> 获取 DOM 元素。</li> <li>用 <code>useCallback</code> 缓存上报信息 reportMessage 方法，里面获取 useContext 内容。把 context 作为依赖项。当依赖项改变，重新声明 reportMessage 函数。</li> <li>用 <code>useEffect</code>监听 DOM 事件，把 reportMessage 作为依赖项，在 useEffect 中进行事件绑定，返回的销毁函数用于解除绑定。</li></ul> <p><strong>依赖关系：</strong> context 改变 -&gt; 让引入 context 的 reportMessage 重新声明 -&gt; 让绑定 DOM 事件监听的 useEffect 里面能够绑定最新的 reportMessage 。</p> <p>如果上述没有分清楚依赖项关系，那么 context 改变，会让 reportMessage 打印不到最新的 context 值。</p> <p><strong>使用</strong></p> <div class="language-js line-numbers-mode"><pre class="language-js"><code> <span class="token keyword">function</span> <span class="token function">Home</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">[</span> dom <span class="token punctuation">,</span> reportMessage  <span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useLog</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token operator">&lt;</span>div<span class="token operator">&gt;</span>
        <span class="token punctuation">{</span><span class="token comment">/* 监听内部点击 */</span><span class="token punctuation">}</span>
        <span class="token operator">&lt;</span>div ref<span class="token operator">=</span><span class="token punctuation">{</span>dom<span class="token punctuation">}</span> <span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>p<span class="token operator">&gt;</span> 《React进阶实践指南》<span class="token operator">&lt;</span><span class="token operator">/</span>p<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>button<span class="token operator">&gt;</span> 按钮 <span class="token function">one</span>   <span class="token punctuation">(</span>内部点击<span class="token punctuation">)</span> <span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>button<span class="token operator">&gt;</span> 按钮 <span class="token function">two</span>   <span class="token punctuation">(</span>内部点击<span class="token punctuation">)</span> <span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>button<span class="token operator">&gt;</span> 按钮 <span class="token function">three</span> <span class="token punctuation">(</span>内部点击<span class="token punctuation">)</span>  <span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
        <span class="token punctuation">{</span><span class="token comment">/* 外部点击 */</span><span class="token punctuation">}</span>
        <span class="token operator">&lt;</span>button  onClick<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>reportMessage<span class="token punctuation">)</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span> <span class="token operator">&gt;</span> 外部点击 <span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
<span class="token punctuation">}</span>
<span class="token keyword">const</span> Index <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">memo</span><span class="token punctuation">(</span>Home<span class="token punctuation">)</span> <span class="token comment">/*  阻断 useState 的更新效应  */</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">Root</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">[</span> value <span class="token punctuation">,</span> setValue <span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span>  <span class="token operator">&lt;</span>LogContext<span class="token punctuation">.</span>Provider value<span class="token operator">=</span><span class="token punctuation">{</span>value<span class="token punctuation">}</span> <span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>Index <span class="token operator">/</span><span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span> <span class="token function">setValue</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">name</span><span class="token operator">:</span><span class="token string">'《React进阶实践指南》'</span> <span class="token punctuation">,</span> <span class="token literal-property property">author</span><span class="token operator">:</span><span class="token string">'我不是外星人'</span>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">}</span> <span class="token operator">&gt;</span>点击<span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>LogContext<span class="token punctuation">.</span>Provider<span class="token operator">&gt;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><p>如上当 context 改变，能够达到正常上报的效果。有一个小细节，就是用 <code>React.memo</code> 来阻断 Root 组件改变 state 给 Home 组件带来的更新效应。</p> <h2 id="usequerytable"><a href="#usequerytable" class="header-anchor">#</a> useQueryTable</h2> <p>带查询的分页加载长列表</p> <p>useQueryTable 的设计主要分为两部分，分别为表格和查询表单。</p> <ul><li>表格设计：表格的数据状态层，改变分页方法，请求数据的方法。</li> <li>表单设计：表单的状态层，以及改变表单单元项的方法，重置表单重新请求数据。</li></ul> <p><strong>编写：</strong></p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">/**
 *
 * @param {*} defaultQuery  表单查询默认参数
 * @param {*} api           biaog
 */</span>
<span class="token keyword">function</span> <span class="token function">useQueryTable</span><span class="token punctuation">(</span><span class="token parameter">defaultQuery <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>api</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
   <span class="token comment">/* 保存查询表格表单信息 */</span>
   <span class="token keyword">const</span> formData <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">useRef</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
   <span class="token comment">/* 保存查询表格分页信息 */</span>
   <span class="token keyword">const</span> pagination <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">useRef</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
       <span class="token literal-property property">page</span><span class="token operator">:</span>defaultQuery<span class="token punctuation">.</span>page <span class="token operator">||</span> <span class="token number">1</span><span class="token punctuation">,</span>
       <span class="token literal-property property">pageSize</span><span class="token operator">:</span>defaultQuery<span class="token punctuation">.</span>pageSize <span class="token operator">||</span> <span class="token number">10</span>
   <span class="token punctuation">}</span><span class="token punctuation">)</span>

   <span class="token comment">/* 强制更新 */</span>
   <span class="token keyword">const</span> <span class="token punctuation">[</span><span class="token punctuation">,</span> forceUpdate<span class="token punctuation">]</span> <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">useState</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span>

   <span class="token comment">/* 请求表格数据 */</span>
   <span class="token keyword">const</span> <span class="token punctuation">[</span>tableData<span class="token punctuation">,</span> setTableData<span class="token punctuation">]</span> <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">useState</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
     <span class="token literal-property property">data</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
     <span class="token literal-property property">total</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
     <span class="token literal-property property">current</span><span class="token operator">:</span> <span class="token number">1</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

   <span class="token comment">/* 请求列表数据 */</span>
   <span class="token keyword">const</span> getList <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">useCallback</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">payload<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">}</span></span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>api<span class="token punctuation">)</span> <span class="token keyword">return</span>
        <span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">api</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token operator">...</span>defaultQuery<span class="token punctuation">,</span> <span class="token operator">...</span>payload<span class="token punctuation">,</span> <span class="token operator">...</span>pagination<span class="token punctuation">.</span>current<span class="token punctuation">,</span><span class="token operator">...</span>formData<span class="token punctuation">.</span>current<span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>data<span class="token punctuation">.</span>code <span class="token operator">==</span> <span class="token number">200</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">setTableData</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">list</span><span class="token operator">:</span>data<span class="token punctuation">.</span>list<span class="token punctuation">,</span><span class="token literal-property property">current</span><span class="token operator">:</span>data<span class="token punctuation">.</span>current<span class="token punctuation">,</span><span class="token literal-property property">total</span><span class="token operator">:</span>data<span class="token punctuation">.</span>total <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
   <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">[</span> api <span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token comment">/* 以api作为依赖项，当api改变，重新声明getList */</span>

    <span class="token comment">/* 改变表单单元项 */</span>
    <span class="token keyword">const</span> setFormItem <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">useCallback</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">key<span class="token punctuation">,</span>value</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">const</span> form <span class="token operator">=</span> formData<span class="token punctuation">.</span>current
        form<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> value
        <span class="token function">forceUpdate</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token comment">/* forceUpdate 每一次都能更新，不会造成 state 相等的情况 */</span>
   <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

   <span class="token comment">/* 重置表单 */</span>
   <span class="token keyword">const</span> reset <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">useCallback</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">const</span> current <span class="token operator">=</span> formData<span class="token punctuation">.</span>current
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> name <span class="token keyword">in</span> current<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            current<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">''</span>
        <span class="token punctuation">}</span>
        pagination<span class="token punctuation">.</span>current<span class="token punctuation">.</span>page <span class="token operator">=</span> defaultQuery<span class="token punctuation">.</span>page <span class="token operator">||</span> <span class="token number">1</span>
        pagination<span class="token punctuation">.</span>current<span class="token punctuation">.</span>pageSize <span class="token operator">=</span> defaultQuery<span class="token punctuation">.</span>pageSize <span class="token operator">||</span> <span class="token number">10</span>
        <span class="token comment">/* 请求数据  */</span>
        <span class="token function">getList</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
   <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">[</span> getList <span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token comment">/* getList 作为 reset 的依赖项  */</span>

   <span class="token comment">/* 处理分页逻辑 */</span>
   <span class="token keyword">const</span> handerChange <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">useCallback</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">page<span class="token punctuation">,</span>pageSize</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        pagination<span class="token punctuation">.</span>current <span class="token operator">=</span> <span class="token punctuation">{</span>
            page<span class="token punctuation">,</span>
            pageSize
        <span class="token punctuation">}</span>
        <span class="token function">getList</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
   <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">[</span> getList <span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token comment">/* getList 作为 handerChange 的依赖项  */</span>

   <span class="token comment">/* 初始化请求数据 */</span>
   React<span class="token punctuation">.</span><span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
       <span class="token function">getList</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
   <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

   <span class="token comment">/* 组合暴露参数 */</span>
   <span class="token keyword">return</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>  <span class="token comment">/* 组合表格状态 */</span>
           tableData<span class="token punctuation">,</span>
           handerChange<span class="token punctuation">,</span>
           getList<span class="token punctuation">,</span>
           <span class="token literal-property property">pagination</span><span class="token operator">:</span>pagination<span class="token punctuation">.</span>current
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>  <span class="token comment">/* 组合搜索表单状态 */</span>
            <span class="token literal-property property">formData</span><span class="token operator">:</span>formData<span class="token punctuation">.</span>current<span class="token punctuation">,</span>
            setFormItem<span class="token punctuation">,</span>
            reset
        <span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br></div></div><p><strong>设计分析：</strong></p> <p>接收参数 ：编写的自定义 hooks 接收两个参数。</p> <ul><li><code>defaultQuery</code>：表格的默认参数，有些业务表格，除了查询和分页之外，有一些独立的请求参数。</li> <li><code>api</code> ： api 为请求数据方法，内部用 <code>Promise</code> 封装处理。</li></ul> <p>数据层：</p> <ul><li>用第一个 useRef 保存查询表单信息 formData 。 第二个 useRef 保存表格的分页信息 pagination 。</li> <li>用第一个 useState 做<strong>受控表单组件更新视图</strong>的渲染函数。第二个 useState 保存并负责更新表格的状态。</li></ul> <p>控制层：控制层为<strong>控制表单表格整体联动</strong>的方法。</p> <ul><li>编写内部和对外公共方法 <code>getList</code>，方法内部使用 api 函数发起请求，通过 <code>setTableData</code> 改变表格数据层状态，用 <code>useCallback</code> 做优化缓存处理 。</li> <li>编写改变表单单元项的方法 <code>setFormItem</code>，这个方法主要给查询表单控件使用，内部改变 formData 属性，并通过 useState 更新组件，改变表单控件视图，用 <code>useCallback</code> 做优化缓存处理。</li> <li>编写重置表单的方法 <code>reset</code> ，reset 会清空 formData 属性和重置分页的信息。然后重新调用 getList 请求数据，用 <code>useCallback</code> 做优化缓存处理。</li> <li>编写给表格分页器提供的接口 <code>handerChange</code> 内部改变分页信息，然后重新请求数据，用 <code>useCallback</code> 做优化缓存处理。。</li> <li>用 useEffect 作为初始化请求表格数据的副作用。</li></ul> <p>返回状态：</p> <ul><li>通过数组把表单和表格的聚合状态暴露出去。</li></ul> <p>注意事项：</p> <ul><li>请求方法要与后端进行对齐，包括返回的参数结构，成功状态码等。</li> <li>属性的声明要与 UI 组件对齐，这里统一用的是 antd 里面的表格和表单控件。</li></ul> <p><strong>使用：</strong></p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">/* 模拟数据请求 */</span>
<span class="token keyword">function</span> <span class="token function">getTableData</span><span class="token punctuation">(</span><span class="token parameter">payload</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
        Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
            <span class="token keyword">const</span> <span class="token punctuation">{</span> list <span class="token punctuation">}</span> <span class="token operator">=</span> listData
            <span class="token keyword">const</span> arr <span class="token operator">=</span> <span class="token function">threeNumberRandom</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment">// 生成三个随机数 模拟数据交互</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'请求参数：'</span><span class="token punctuation">,</span>payload<span class="token punctuation">)</span>
            <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
                <span class="token operator">...</span>listData<span class="token punctuation">,</span>
                <span class="token literal-property property">list</span><span class="token operator">:</span><span class="token punctuation">[</span> list<span class="token punctuation">[</span>arr<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span>list<span class="token punctuation">[</span>arr<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span>list<span class="token punctuation">[</span>arr<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token punctuation">]</span><span class="token punctuation">,</span>
                <span class="token literal-property property">total</span><span class="token operator">:</span>list<span class="token punctuation">.</span>length<span class="token punctuation">,</span>
                <span class="token literal-property property">current</span><span class="token operator">:</span>payload<span class="token punctuation">.</span>page <span class="token operator">||</span> <span class="token number">1</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">Index</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">[</span> table<span class="token punctuation">,</span>form <span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useQueryTable</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">pageSize</span><span class="token operator">:</span><span class="token number">3</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>getTableData<span class="token punctuation">)</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> formData <span class="token punctuation">,</span>setFormItem <span class="token punctuation">,</span> reset  <span class="token punctuation">}</span> <span class="token operator">=</span> form
    <span class="token keyword">const</span> <span class="token punctuation">{</span> pagination <span class="token punctuation">,</span> tableData <span class="token punctuation">,</span> getList  <span class="token punctuation">,</span> handerChange <span class="token punctuation">}</span> <span class="token operator">=</span> table
    <span class="token keyword">return</span> <span class="token operator">&lt;</span>div style<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">{</span> <span class="token literal-property property">margin</span><span class="token operator">:</span><span class="token string">'30px'</span> <span class="token punctuation">}</span><span class="token punctuation">}</span> <span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>div style<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">{</span> <span class="token literal-property property">marginBottom</span><span class="token operator">:</span><span class="token string">'24px'</span> <span class="token punctuation">}</span><span class="token punctuation">}</span> <span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>Input onChange<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span> <span class="token function">setFormItem</span><span class="token punctuation">(</span><span class="token string">'name'</span><span class="token punctuation">,</span>e<span class="token punctuation">.</span>target<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">}</span>
                placeholder<span class="token operator">=</span><span class="token string">&quot;请输入名称&quot;</span>
                style<span class="token operator">=</span><span class="token punctuation">{</span>inputStyle<span class="token punctuation">}</span>
                value<span class="token operator">=</span><span class="token punctuation">{</span>formData<span class="token punctuation">.</span>name <span class="token operator">||</span> <span class="token string">''</span><span class="token punctuation">}</span>
            <span class="token operator">/</span><span class="token operator">&gt;</span>
             <span class="token operator">&lt;</span>Input onChange<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span> <span class="token function">setFormItem</span><span class="token punctuation">(</span><span class="token string">'price'</span><span class="token punctuation">,</span>e<span class="token punctuation">.</span>target<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">}</span>
                 placeholder<span class="token operator">=</span><span class="token string">&quot;请输入价格&quot;</span>
                 style<span class="token operator">=</span><span class="token punctuation">{</span>inputStyle<span class="token punctuation">}</span>
                 value<span class="token operator">=</span><span class="token punctuation">{</span>formData<span class="token punctuation">.</span>price <span class="token operator">||</span> <span class="token string">''</span><span class="token punctuation">}</span>
             <span class="token operator">/</span><span class="token operator">&gt;</span>
             <span class="token operator">&lt;</span>Select onChange<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">setFormItem</span><span class="token punctuation">(</span><span class="token string">'type'</span><span class="token punctuation">,</span>value<span class="token punctuation">)</span><span class="token punctuation">}</span>
                 placeholder<span class="token operator">=</span><span class="token string">&quot;请选择&quot;</span>
                 style<span class="token operator">=</span><span class="token punctuation">{</span>inputStyle<span class="token punctuation">}</span>
                 value<span class="token operator">=</span><span class="token punctuation">{</span>formData<span class="token punctuation">.</span>type<span class="token punctuation">}</span>
             <span class="token operator">&gt;</span>
                 <span class="token operator">&lt;</span>Option value<span class="token operator">=</span><span class="token string">&quot;1&quot;</span> <span class="token operator">&gt;</span>家电<span class="token operator">&lt;</span><span class="token operator">/</span>Option<span class="token operator">&gt;</span>
                 <span class="token operator">&lt;</span>Option value<span class="token operator">=</span><span class="token string">&quot;2&quot;</span> <span class="token operator">&gt;</span>生活用品<span class="token operator">&lt;</span><span class="token operator">/</span>Option<span class="token operator">&gt;</span>
             <span class="token operator">&lt;</span><span class="token operator">/</span>Select<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>button className<span class="token operator">=</span><span class="token string">&quot;searchbtn&quot;</span>
                onClick<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">getList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
            <span class="token operator">&gt;</span>提交<span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">&gt;</span>
             <span class="token operator">&lt;</span>button className<span class="token operator">=</span><span class="token string">&quot;concellbtn&quot;</span>
                 onClick<span class="token operator">=</span><span class="token punctuation">{</span>reset<span class="token punctuation">}</span>
             <span class="token operator">&gt;</span>重置<span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
        <span class="token punctuation">{</span><span class="token function">useCallback</span><span class="token punctuation">(</span> <span class="token operator">&lt;</span>Table
            columns<span class="token operator">=</span><span class="token punctuation">{</span>columns<span class="token punctuation">}</span>
            dataSource<span class="token operator">=</span><span class="token punctuation">{</span>tableData<span class="token punctuation">.</span>list<span class="token punctuation">}</span>
            height<span class="token operator">=</span><span class="token string">&quot;300px&quot;</span>
            onChange<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span> <span class="token function">handerChange</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>current<span class="token punctuation">,</span>res<span class="token punctuation">.</span>pageSize<span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">}</span>
            pagination<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">{</span> <span class="token operator">...</span>pagination<span class="token punctuation">,</span> <span class="token literal-property property">total</span><span class="token operator">:</span> tableData<span class="token punctuation">.</span>total <span class="token punctuation">,</span><span class="token literal-property property">current</span><span class="token operator">:</span>tableData<span class="token punctuation">.</span>current <span class="token punctuation">}</span><span class="token punctuation">}</span>
            rowKey<span class="token operator">=</span><span class="token string">&quot;id&quot;</span>
            <span class="token operator">/</span><span class="token operator">&gt;</span><span class="token punctuation">,</span><span class="token punctuation">[</span>tableData<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br></div></div><ul><li>整个查询表格逻辑层基本就一个自定义 hooks —— <code>useQueryTable</code> 就搞定了。</li> <li><code>getTableData</code> 模拟了数据交互过程 ，其内部的代码逻辑不必纠结 。</li> <li><code>useCallback</code> 对 Table 的 React element 做缓存处理，这样频繁的表单控件更新，不会让 Table 组件重新渲染。</li></ul> <h2 id="usecreatestore-useconnect"><a href="#usecreatestore-useconnect" class="header-anchor">#</a> useCreateStore | useConnect</h2> <p>用<strong>两个自定义 hooks 实现 <code>React-Redux</code> 基本功能</strong>。 一个是注入 Store 的 <code>useCreateStore</code> ，另外一个是负责订阅更新的 <code>useConnect</code> ，通过这个实践 demo ，将收获以下知识点：</p> <ul><li>如何将不同组件的自定义 hooks 建立通信，共享状态。</li> <li>合理编写自定义 hooks ， 分析 hooks 之间的依赖关系。</li></ul> <p>首先，看一下要实现的两个自定义 hooks 具体功能。</p> <ul><li><code>useCreateStore</code> 用于产生一个状态 Store ，通过 context 上下文传递 ，为了让每一个自定义 hooks <code>useConnect</code> 都能获取 context 里面的状态属性。</li> <li><code>useConnect</code> 使用这个自定义 hooks 的组件，可以获取改变状态的 dispatch 方法，还可以订阅 state ，被订阅的 state 发生变化，组件更新。</li></ul> <p><strong>如何让不同组件的自定义 hooks 共享状态并实现通信呢？</strong></p> <p>首先不同组件的自定义 hooks ，可以通过 <code>useContext</code> 获得共有状态，而且还需要实现状态管理和组件通信，那么就需要一个状态调度中心来统一做这些事，可以称之为 <code>ReduxHooksStore</code> ，它具体做的事情如下：</p> <ul><li>全局管理 state， state 变化，通知对应组件更新。</li> <li>收集使用 <code>useConnect</code> 组件的信息。组件销毁还要清除这些信息。</li> <li>维护并传递负责更新的 <code>dispatch</code> 方法。</li> <li>一些重要 api 要暴露给 context 上下文，传递给每一个 <code>useConnect</code>。</li></ul> <h4 id="usecreatestore-设计"><a href="#usecreatestore-设计" class="header-anchor">#</a> useCreateStore 设计</h4> <p>首先 <code>useCreateStore</code> 是在靠近根部组件的位置的， 而且全局只需要一个，目的就是创建一个 <code>Store</code> ，并通过 <code>Provider</code> 传递下去。</p> <p>使用：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> store <span class="token operator">=</span> <span class="token function">useCreateStore</span><span class="token punctuation">(</span> reducer <span class="token punctuation">,</span> initState <span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>参数：</p> <ul><li><code>reducer</code> ：全局 reducer，纯函数，传入 state 和 action ，返回新的 state 。</li> <li><code>initState</code> ： 初始化 state 。</li></ul> <p>返回值：为 store 暴露的主要功能函数。</p> <h4 id="store设计"><a href="#store设计" class="header-anchor">#</a> Store设计</h4> <p>Store 为上述所说的调度中心，接收全局 reducer ，内部维护状态 state ，负责通知更新 ，收集用 useConnect 的组件。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> Store <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReduxHooksStore</span><span class="token punctuation">(</span>reducer<span class="token punctuation">,</span>initState<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">exportStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>参数：接收两个参数，透传 useCreateStore 的参数。</p> <h4 id="useconnect设计"><a href="#useconnect设计" class="header-anchor">#</a> useConnect设计</h4> <p>使用 useConnect 的组件，将获得 dispatch 函数，用于更新 state ，还可以通过第一个参数订阅 state ，被订阅的 state 改变 ，会让组件更新。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 订阅 state 中的 number </span>
<span class="token keyword">const</span> <span class="token function-variable function">mapStoreToState</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">state</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">number</span><span class="token operator">:</span> state<span class="token punctuation">.</span>number  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> <span class="token punctuation">[</span> state <span class="token punctuation">,</span> dispatch <span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useConnect</span><span class="token punctuation">(</span>mapStoreToState<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>参数：</p> <ul><li><code>mapStoreToState</code>：将 Store 中 state ，映射到组件的 state 中，可以做视图渲染使用。</li> <li>如果没有第一个参数，那么只提供 <code>dispatch</code> 函数，不会订阅 state 变化带来的更新。</li></ul> <p>返回值：返回值是一个数组。</p> <ul><li>数组第一项：为映射的 state 的值。</li> <li>数组第二项：为改变 state 的 <code>dispatch</code> 函数。</li></ul> <h3 id="usecreatestore"><a href="#usecreatestore" class="header-anchor">#</a> useCreateStore</h3> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">const</span> ReduxContext <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">createContext</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span>
<span class="token comment">/* 用于产生 reduxHooks 的 store */</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">useCreateStore</span><span class="token punctuation">(</span><span class="token parameter">reducer<span class="token punctuation">,</span>initState</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
   <span class="token keyword">const</span> store <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">useRef</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span>
   <span class="token comment">/* 如果存在——不需要重新实例化 Store */</span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>store<span class="token punctuation">.</span>current<span class="token punctuation">)</span><span class="token punctuation">{</span>
       store<span class="token punctuation">.</span>current  <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReduxHooksStore</span><span class="token punctuation">(</span>reducer<span class="token punctuation">,</span>initState<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">exportStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
   <span class="token punctuation">}</span>
   <span class="token keyword">return</span> store<span class="token punctuation">.</span>current
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p><code>useCreateStore</code> 主要做的是：</p> <ul><li>接收 <code>reducer</code> 和 <code>initState</code> ，通过 ReduxHooksStore 产生一个 store ，不期望把 store 全部暴露给使用者，只需要暴露核心的方法，所以调用实例下的 <code>exportStore</code>抽离出核心方法。</li> <li>使用一个 <code>useRef</code> 保存核心方法，传递给 <code>Provider</code> 。</li></ul> <h3 id="_3-状态管理者-reduxhooksstore"><a href="#_3-状态管理者-reduxhooksstore" class="header-anchor">#</a> 3 状态管理者 —— ReduxHooksStore</h3> <p>接下来看一下核心状态 ReduxHooksStore 。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> unstable_batchedUpdates <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react-dom'</span>
<span class="token keyword">class</span> <span class="token class-name">ReduxHooksStore</span> <span class="token punctuation">{</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">reducer<span class="token punctuation">,</span>initState</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
       <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">'__ReduxHooksStore__'</span>
       <span class="token keyword">this</span><span class="token punctuation">.</span>id <span class="token operator">=</span> <span class="token number">0</span>
       <span class="token keyword">this</span><span class="token punctuation">.</span>reducer <span class="token operator">=</span> reducer
       <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> initState
       <span class="token keyword">this</span><span class="token punctuation">.</span>mapConnects <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">/* 需要对外传递的接口 */</span>
    <span class="token function-variable function">exportStore</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token punctuation">{</span>
            <span class="token literal-property property">dispatch</span><span class="token operator">:</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">dispatch</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token literal-property property">subscribe</span><span class="token operator">:</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token literal-property property">unSubscribe</span><span class="token operator">:</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">unSubscribe</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token literal-property property">getInitState</span><span class="token operator">:</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getInitState</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">/* 获取初始化 state */</span>
    <span class="token function-variable function">getInitState</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token parameter">mapStoreToState</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">mapStoreToState</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment">/* 更新需要更新的组件 */</span>
    <span class="token function-variable function">publicRender</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
        <span class="token function">unstable_batchedUpdates</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span> <span class="token comment">/* 批量更新 */</span>
            Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>mapConnects<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">name</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
                <span class="token keyword">const</span> <span class="token punctuation">{</span> update <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>mapConnects<span class="token punctuation">[</span>name<span class="token punctuation">]</span>
                <span class="token function">update</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">)</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment">/* 更新 state  */</span>
    <span class="token function-variable function">dispatch</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token parameter">action</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
       <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">reducer</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">,</span>action<span class="token punctuation">)</span>
       <span class="token comment">// 批量更新</span>
       <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">publicRender</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment">/* 注册每个 connect  */</span>
    <span class="token function-variable function">subscribe</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token parameter">connectCurrent</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
        <span class="token keyword">const</span> connectName <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token operator">++</span><span class="token keyword">this</span><span class="token punctuation">.</span>id<span class="token punctuation">)</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>mapConnects<span class="token punctuation">[</span>connectName<span class="token punctuation">]</span> <span class="token operator">=</span>  connectCurrent
        <span class="token keyword">return</span> connectName
    <span class="token punctuation">}</span>
    <span class="token comment">/* 解除绑定 */</span>
    <span class="token function-variable function">unSubscribe</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token parameter">connectName</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
        <span class="token keyword">delete</span> <span class="token keyword">this</span><span class="token punctuation">.</span>mapConnects<span class="token punctuation">[</span>connectName<span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br></div></div><h4 id="状态"><a href="#状态" class="header-anchor">#</a> 状态</h4> <ul><li><code>reducer</code>：这个 reducer 为全局的 reducer ，由 useCreateStore 传入。</li> <li><code>state</code>：全局保存的状态 state ，每次执行 reducer 会得到新的 state 。</li> <li><code>mapConnects</code>：里面保存每一个 useConnect 组件的更新函数。用于派发 state 改变带来的更新。</li></ul> <h4 id="方法"><a href="#方法" class="header-anchor">#</a> 方法</h4> <p><strong>负责初始化：</strong></p> <ul><li><code>getInitState</code>：这个方法给自定义 hooks 的 useConnect 使用，用于获取初始化的 state 。</li> <li><code>exportStore</code>：这个方法用于把 ReduxHooksStore 提供的核心方法传递给每一个 useConnect 。</li></ul> <p><strong>负责绑定｜解绑：</strong></p> <ul><li><code>subscribe</code>： 绑定每一个自定义 hooks useConnect 。</li> <li><code>unSubscribe</code>：解除绑定每一个 hooks 。</li></ul> <p><strong>负责更新：</strong></p> <ul><li><code>dispatch</code>：这个方法提供给业务组件层，每一个使用 useConnect 的组件可以通过 dispatch 方法改变 state ，内部原理是通过调用 reducer 产生一个新的 state 。</li> <li><code>publicRender</code>：当 state 改变需要通知每一个使用 useConnect 的组件，这个方法就是通知更新，至于组件需不需要更新，那是 useConnect 内部需要处理的事情，这里还有一个细节，就是考虑到 dispatch 的触发场景可以是异步状态下，所以用 React-DOM 中 unstable_batchedUpdates 开启批量更新原则。</li></ul> <h3 id="useconnect"><a href="#useconnect" class="header-anchor">#</a> useConnect</h3> <p>useConnect 是整个功能的核心部分，它要做的事情是获取最新的 <code>state</code> ，然后通过订阅函数 <code>mapStoreToState</code> 得到订阅的 state ，判断订阅的 state 是否发生变化。如果发生变化渲染最新的 state 。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">useConnect</span><span class="token punctuation">(</span><span class="token function-variable function">mapStoreToState</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">/* 获取 Store 内部的重要函数 */</span>
   <span class="token keyword">const</span> contextValue <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">useContext</span><span class="token punctuation">(</span>ReduxContext<span class="token punctuation">)</span>
   <span class="token keyword">const</span> <span class="token punctuation">{</span> getInitState <span class="token punctuation">,</span> subscribe <span class="token punctuation">,</span>unSubscribe <span class="token punctuation">,</span> dispatch <span class="token punctuation">}</span> <span class="token operator">=</span> contextValue
   <span class="token comment">/* 用于传递给业务组件的 state  */</span>
   <span class="token keyword">const</span> stateValue <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">useRef</span><span class="token punctuation">(</span><span class="token function">getInitState</span><span class="token punctuation">(</span>mapStoreToState<span class="token punctuation">)</span><span class="token punctuation">)</span>

   <span class="token comment">/* 渲染函数 */</span>
   <span class="token keyword">const</span> <span class="token punctuation">[</span> <span class="token punctuation">,</span> forceUpdate <span class="token punctuation">]</span> <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">useState</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
   <span class="token comment">/* 产生 */</span>
   <span class="token keyword">const</span> connectValue <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">useMemo</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
       <span class="token keyword">const</span> state <span class="token operator">=</span>  <span class="token punctuation">{</span>
           <span class="token comment">/* 用于比较一次 dispatch 中，新的 state 和 之前的state 是否发生变化  */</span>
           <span class="token literal-property property">cacheState</span><span class="token operator">:</span> stateValue<span class="token punctuation">.</span>current<span class="token punctuation">,</span>
           <span class="token comment">/* 更新函数 */</span>
           <span class="token function-variable function">update</span><span class="token operator">:</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">newState</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
               <span class="token comment">/* 获取订阅的 state */</span>
               <span class="token keyword">const</span> selectState <span class="token operator">=</span> <span class="token function">mapStoreToState</span><span class="token punctuation">(</span>newState<span class="token punctuation">)</span>
               <span class="token comment">/* 浅比较 state 是否发生变化，如果发生变化， */</span>
               <span class="token keyword">const</span> isEqual <span class="token operator">=</span> <span class="token function">shallowEqual</span><span class="token punctuation">(</span>state<span class="token punctuation">.</span>cacheState<span class="token punctuation">,</span>selectState<span class="token punctuation">)</span>
               state<span class="token punctuation">.</span>cacheState <span class="token operator">=</span> selectState
               stateValue<span class="token punctuation">.</span>current  <span class="token operator">=</span> selectState
               <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>isEqual<span class="token punctuation">)</span><span class="token punctuation">{</span>
                   <span class="token comment">/* 更新 */</span>
                   <span class="token function">forceUpdate</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
               <span class="token punctuation">}</span>
           <span class="token punctuation">}</span>
       <span class="token punctuation">}</span>
       <span class="token keyword">return</span> state
   <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">[</span> contextValue <span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token comment">// 将 contextValue 作为依赖项。</span>

   React<span class="token punctuation">.</span><span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
       <span class="token comment">/* 组件挂载——注册 connect */</span>
       <span class="token keyword">const</span> name <span class="token operator">=</span>  <span class="token function">subscribe</span><span class="token punctuation">(</span>connectValue<span class="token punctuation">)</span>
       <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token comment">/* 组件卸载 —— 解绑 connect */</span>
           <span class="token function">unSubscribe</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span>
       <span class="token punctuation">}</span>
   <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">[</span> connectValue <span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token comment">/* 将 connectValue 作为 useEffect 的依赖项 */</span>

   <span class="token keyword">return</span> <span class="token punctuation">[</span> stateValue<span class="token punctuation">.</span>current <span class="token punctuation">,</span> dispatch <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br></div></div><p><strong>初始化</strong></p> <ul><li>用 useContext 获取上下文中， ReduxHooksStore 提供的核心函数。</li> <li>用 useRef 来保存得到的最新的 state 。</li> <li>用 useState 产生一个更新函数 <code>forceUpdate</code> ，这个函数只是更新组件。</li></ul> <p><strong>注册｜解绑流程</strong></p> <ul><li>注册： 通过 <code>useEffect</code> 来向 ReduxHooksStore 中注册当前 useConnect 产生的 connectValue ，connectValue 是什么马上会讲到。subscribe 用于注册，会返回当前 connectValue 的唯一标识 name 。</li> <li>解绑：在 useEffect 的销毁函数中，可以用调用 unSubscribe 传入 name 来解绑当前的 connectValue</li></ul> <p><strong>connectValue是否更新组件</strong></p> <ul><li>connectValue ：真正地向 ReduxHooksStore 注册的状态，首先用 <code>useMemo</code> 来对 connectValue 做缓存，connectValue 为一个对象，里面的 cacheState 保留了上一次的 mapStoreToState 产生的 state ，还有一个负责更新的 update 函数。</li> <li><strong>更新流程</strong> ： 当触发 <code>dispatch</code> 在 ReduxHooksStore 中，会让每一个 connectValue 的 update 都执行， update 会触发映射函数 <code>mapStoreToState</code> 来得到当前组件想要的 state 内容。然后通过 <code>shallowEqual</code> 浅比较新老 state 是否发生变化，如果发生变化，那么更新组件。完成整个流程。</li> <li>shallowEqual ： 这个浅比较就是 React 里面的浅比较，在第 11 章已经讲了其流程，这里就不讲了。</li></ul> <p><strong>分清依赖关系</strong></p> <ul><li>首先自定义 hooks useConnect 的依赖关系是上下文 contextValue 改变，那么说明 store 发生变化，所以重新通过 useMemo 产生新的 connectValue 。<strong>所以 useMemo 依赖 contextValue。</strong></li> <li>connectValue 改变，那么需要解除原来的绑定关系，重新绑定。<strong>useEffect 依赖 connectValue。</strong></li></ul> <p><strong>局限性</strong></p> <p>整个 useConnect 有一些局限性，比如：</p> <ul><li>没有考虑 mapStoreToState 可变性，无法动态传入 mapStoreToState 。</li> <li>浅比较，不能深层次比较引用数据类型。</li></ul> <h3 id="使用与验证效果"><a href="#使用与验证效果" class="header-anchor">#</a> 使用与验证效果</h3> <p>接下来就是验证效果环节，我模拟了组件通信的场景。</p> <h4 id="根部组件注入-store"><a href="#根部组件注入-store" class="header-anchor">#</a> 根部组件注入 Store</h4> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> ReduxContext <span class="token punctuation">,</span> useConnect <span class="token punctuation">,</span> useCreateStore <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./hooks/useRedux'</span>
<span class="token keyword">function</span>  <span class="token function">Index</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">[</span> isShow <span class="token punctuation">,</span> setShow <span class="token punctuation">]</span> <span class="token operator">=</span>  React<span class="token punctuation">.</span><span class="token function">useState</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'index 渲染'</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token operator">&lt;</span>div<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>CompA <span class="token operator">/</span><span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>CompB <span class="token operator">/</span><span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>CompC <span class="token operator">/</span><span class="token operator">&gt;</span>
        <span class="token punctuation">{</span>isShow <span class="token operator">&amp;&amp;</span>  <span class="token operator">&lt;</span>CompD <span class="token operator">/</span><span class="token operator">&gt;</span><span class="token punctuation">}</span>
        <span class="token operator">&lt;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">setShow</span><span class="token punctuation">(</span><span class="token operator">!</span>isShow<span class="token punctuation">)</span><span class="token punctuation">}</span> <span class="token operator">&gt;</span>点击<span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">Root</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">const</span> store <span class="token operator">=</span> <span class="token function">useCreateStore</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">state<span class="token punctuation">,</span>action</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">const</span> <span class="token punctuation">{</span> type <span class="token punctuation">,</span> payload <span class="token punctuation">}</span> <span class="token operator">=</span>action
        <span class="token keyword">if</span><span class="token punctuation">(</span>type <span class="token operator">===</span> <span class="token string">'setA'</span> <span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token punctuation">{</span>
                <span class="token operator">...</span>state<span class="token punctuation">,</span>
                <span class="token literal-property property">mesA</span><span class="token operator">:</span>payload
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>type <span class="token operator">===</span> <span class="token string">'setB'</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token punctuation">{</span>
                <span class="token operator">...</span>state<span class="token punctuation">,</span>
                <span class="token literal-property property">mesB</span><span class="token operator">:</span>payload
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>type <span class="token operator">===</span> <span class="token string">'clear'</span><span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token comment">//清空</span>
            <span class="token keyword">return</span>  <span class="token punctuation">{</span> <span class="token literal-property property">mesA</span><span class="token operator">:</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token literal-property property">mesB</span><span class="token operator">:</span><span class="token string">''</span> <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span><span class="token punctuation">{</span>
            <span class="token keyword">return</span> state
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span> <span class="token literal-property property">mesA</span><span class="token operator">:</span><span class="token string">'111'</span><span class="token punctuation">,</span><span class="token literal-property property">mesB</span><span class="token operator">:</span><span class="token string">'111'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token operator">&lt;</span>div<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>ReduxContext<span class="token punctuation">.</span>Provider value<span class="token operator">=</span><span class="token punctuation">{</span>store<span class="token punctuation">}</span> <span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>Index<span class="token operator">/</span><span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span><span class="token operator">/</span>ReduxContext<span class="token punctuation">.</span>Provider<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br></div></div><p><strong>Root根组件</strong></p> <ul><li>通过 useCreateStore 创建一个 store ，传入 reducer 和 初始化的值 <code>{ mesA:'111',mesB:'111' }</code></li> <li>用 Provider 传递 store。</li></ul> <p><strong>Index组件</strong></p> <ul><li>有四个子组件 CompA ， CompB ，CompC ，CompD 。其中 CompD 是 动态挂载的。</li></ul> <h4 id="业务组件使用"><a href="#业务组件使用" class="header-anchor">#</a> 业务组件使用</h4> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">CompA</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">[</span> value <span class="token punctuation">,</span>setValue <span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> <span class="token punctuation">[</span>state <span class="token punctuation">,</span>dispatch <span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useConnect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">state</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">mesB</span> <span class="token operator">:</span> state<span class="token punctuation">.</span>mesB <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token operator">&lt;</span>div className<span class="token operator">=</span><span class="token string">&quot;component_box&quot;</span> <span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>p<span class="token operator">&gt;</span> 组件<span class="token constant">A</span><span class="token operator">&lt;</span><span class="token operator">/</span>p<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>p<span class="token operator">&gt;</span>组件<span class="token constant">B</span>对我说 ： <span class="token punctuation">{</span>state<span class="token punctuation">.</span>mesB<span class="token punctuation">}</span> <span class="token operator">&lt;</span><span class="token operator">/</span>p<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>input onChange<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token function">setValue</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>target<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">}</span>
            placeholder<span class="token operator">=</span><span class="token string">&quot;对B组件说&quot;</span>
        <span class="token operator">/</span><span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span> <span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">type</span><span class="token operator">:</span><span class="token string">'setA'</span> <span class="token punctuation">,</span><span class="token literal-property property">payload</span><span class="token operator">:</span>value <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">}</span> <span class="token operator">&gt;</span>确定<span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">CompB</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">[</span> value <span class="token punctuation">,</span>setValue <span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> <span class="token punctuation">[</span>state <span class="token punctuation">,</span>dispatch <span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useConnect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">state</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">mesA</span> <span class="token operator">:</span> state<span class="token punctuation">.</span>mesA <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token operator">&lt;</span>div className<span class="token operator">=</span><span class="token string">&quot;component_box&quot;</span> <span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>p<span class="token operator">&gt;</span> 组件<span class="token constant">B</span><span class="token operator">&lt;</span><span class="token operator">/</span>p<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>p<span class="token operator">&gt;</span>组件<span class="token constant">A</span>对我说 ： <span class="token punctuation">{</span>state<span class="token punctuation">.</span>mesA<span class="token punctuation">}</span> <span class="token operator">&lt;</span><span class="token operator">/</span>p<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>input onChange<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token function">setValue</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>target<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">}</span>
            placeholder<span class="token operator">=</span><span class="token string">&quot;对A组件说&quot;</span>
        <span class="token operator">/</span><span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span> <span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">type</span><span class="token operator">:</span><span class="token string">'setB'</span> <span class="token punctuation">,</span><span class="token literal-property property">payload</span><span class="token operator">:</span>value <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">}</span> <span class="token operator">&gt;</span>确定<span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">CompC</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">[</span>state  <span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useConnect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">state</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">mes1</span> <span class="token operator">:</span> state<span class="token punctuation">.</span>mesA<span class="token punctuation">,</span><span class="token literal-property property">mes2</span> <span class="token operator">:</span> state<span class="token punctuation">.</span>mesB <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token operator">&lt;</span>div className<span class="token operator">=</span><span class="token string">&quot;component_box&quot;</span> <span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>p<span class="token operator">&gt;</span>组件<span class="token constant">A</span> ： <span class="token punctuation">{</span>state<span class="token punctuation">.</span>mes1<span class="token punctuation">}</span> <span class="token operator">&lt;</span><span class="token operator">/</span>p<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>p<span class="token operator">&gt;</span>组件<span class="token constant">B</span> ： <span class="token punctuation">{</span>state<span class="token punctuation">.</span>mes2<span class="token punctuation">}</span> <span class="token operator">&lt;</span><span class="token operator">/</span>p<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">CompD</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">[</span> <span class="token punctuation">,</span>dispatch  <span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useConnect</span><span class="token punctuation">(</span> <span class="token punctuation">)</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'D 组件更新'</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token operator">&lt;</span>div className<span class="token operator">=</span><span class="token string">&quot;component_box&quot;</span> <span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span> <span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">type</span><span class="token operator">:</span><span class="token string">'clear'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">}</span> <span class="token operator">&gt;</span> 清空 <span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br></div></div><ul><li>CompA 和 CompB 模拟组件双向通信。</li> <li>CompC 组件接收 CompA 和 CompB 通信内容，并映射到 <code>mes1 ，mes2</code> 属性上。</li> <li>CompD 没有 mapStoreToState ，没有订阅 state ，state 变化组件不会更新，只是用 dispatch 清空状态。</li></ul></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/blog/react/react/react-diff.html" class="prev">
        React Diff 算法
      </a></span> <span class="next"><a href="/blog/react/react/react-context.html">
        React Context 原理
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----><!----><!----><!----></div></div>
    <script src="/blog/assets/js/app.f064466e.js" defer></script><script src="/blog/assets/js/2.dec2e75d.js" defer></script><script src="/blog/assets/js/1.5b9e135c.js" defer></script><script src="/blog/assets/js/147.2c1841e6.js" defer></script><script src="/blog/assets/js/20.badbb211.js" defer></script>
  </body>
</html>
