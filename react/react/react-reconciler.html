<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Reconciler 协调器 | 花帽子的博客</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="icon" href="/blog/logo.png">
    <link rel="manifest" href="/blog/manifest.json">
    <link rel="apple-touch-icon" href="/blog/images/icons/apple-icon-152x152.png">
    <meta name="description" content="我命由我不由天，学习吧少年">
    <meta name="theme-color" content="#3eaf7c">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="msapplication-TileImage" content="/icons/ms-icon-144x144.png">
    <meta name="msapplication-TileColor" content="#000000">
    
    <link rel="preload" href="/blog/assets/css/0.styles.1c8ccece.css" as="style"><link rel="preload" href="/blog/assets/js/app.a7755d5e.js" as="script"><link rel="preload" href="/blog/assets/js/2.8bf77cff.js" as="script"><link rel="preload" href="/blog/assets/js/112.84c095ab.js" as="script"><link rel="preload" href="/blog/assets/js/4.ff6074e9.js" as="script"><link rel="prefetch" href="/blog/assets/js/10.069cffea.js"><link rel="prefetch" href="/blog/assets/js/100.8fc98c1b.js"><link rel="prefetch" href="/blog/assets/js/101.cd25418f.js"><link rel="prefetch" href="/blog/assets/js/102.0b417359.js"><link rel="prefetch" href="/blog/assets/js/103.58546687.js"><link rel="prefetch" href="/blog/assets/js/104.4596f2f5.js"><link rel="prefetch" href="/blog/assets/js/105.7400ccb5.js"><link rel="prefetch" href="/blog/assets/js/106.8ae17345.js"><link rel="prefetch" href="/blog/assets/js/107.522ee48f.js"><link rel="prefetch" href="/blog/assets/js/108.08494100.js"><link rel="prefetch" href="/blog/assets/js/109.2000561c.js"><link rel="prefetch" href="/blog/assets/js/11.5068dbb8.js"><link rel="prefetch" href="/blog/assets/js/110.3474ddbe.js"><link rel="prefetch" href="/blog/assets/js/111.8a6d1533.js"><link rel="prefetch" href="/blog/assets/js/113.6b666b5d.js"><link rel="prefetch" href="/blog/assets/js/114.c717e6b3.js"><link rel="prefetch" href="/blog/assets/js/115.39da5adc.js"><link rel="prefetch" href="/blog/assets/js/116.763780e8.js"><link rel="prefetch" href="/blog/assets/js/117.00728cc9.js"><link rel="prefetch" href="/blog/assets/js/118.5c7a6636.js"><link rel="prefetch" href="/blog/assets/js/119.704dfc63.js"><link rel="prefetch" href="/blog/assets/js/12.084d40c3.js"><link rel="prefetch" href="/blog/assets/js/120.33999783.js"><link rel="prefetch" href="/blog/assets/js/121.6724c7f0.js"><link rel="prefetch" href="/blog/assets/js/122.a10e043f.js"><link rel="prefetch" href="/blog/assets/js/123.f7a01345.js"><link rel="prefetch" href="/blog/assets/js/124.b085b196.js"><link rel="prefetch" href="/blog/assets/js/125.3252c84a.js"><link rel="prefetch" href="/blog/assets/js/126.8113903e.js"><link rel="prefetch" href="/blog/assets/js/127.253249bd.js"><link rel="prefetch" href="/blog/assets/js/128.57a51340.js"><link rel="prefetch" href="/blog/assets/js/129.f1d967b4.js"><link rel="prefetch" href="/blog/assets/js/13.bdc2999d.js"><link rel="prefetch" href="/blog/assets/js/130.dc649b4f.js"><link rel="prefetch" href="/blog/assets/js/131.8c419560.js"><link rel="prefetch" href="/blog/assets/js/132.1278d3ce.js"><link rel="prefetch" href="/blog/assets/js/133.1c795fc1.js"><link rel="prefetch" href="/blog/assets/js/134.bb655422.js"><link rel="prefetch" href="/blog/assets/js/135.b63ad8fa.js"><link rel="prefetch" href="/blog/assets/js/136.f2cbbab8.js"><link rel="prefetch" href="/blog/assets/js/137.864b24ef.js"><link rel="prefetch" href="/blog/assets/js/138.cfba8e52.js"><link rel="prefetch" href="/blog/assets/js/139.7444a09a.js"><link rel="prefetch" href="/blog/assets/js/14.d3932fd0.js"><link rel="prefetch" href="/blog/assets/js/140.b2233930.js"><link rel="prefetch" href="/blog/assets/js/141.9aa49d8e.js"><link rel="prefetch" href="/blog/assets/js/142.b7532cf7.js"><link rel="prefetch" href="/blog/assets/js/143.d65ebca8.js"><link rel="prefetch" href="/blog/assets/js/144.2c748ea6.js"><link rel="prefetch" href="/blog/assets/js/145.579f6bdd.js"><link rel="prefetch" href="/blog/assets/js/146.f02dfafe.js"><link rel="prefetch" href="/blog/assets/js/147.eb67bd15.js"><link rel="prefetch" href="/blog/assets/js/148.5e62b912.js"><link rel="prefetch" href="/blog/assets/js/149.e13f4ec0.js"><link rel="prefetch" href="/blog/assets/js/15.5b444ffe.js"><link rel="prefetch" href="/blog/assets/js/150.fd6c74eb.js"><link rel="prefetch" href="/blog/assets/js/151.5d792c6f.js"><link rel="prefetch" href="/blog/assets/js/152.ac877913.js"><link rel="prefetch" href="/blog/assets/js/153.26698bd8.js"><link rel="prefetch" href="/blog/assets/js/154.ab72e6ff.js"><link rel="prefetch" href="/blog/assets/js/155.52199f9c.js"><link rel="prefetch" href="/blog/assets/js/156.e749f705.js"><link rel="prefetch" href="/blog/assets/js/157.60b51736.js"><link rel="prefetch" href="/blog/assets/js/158.db2e98d7.js"><link rel="prefetch" href="/blog/assets/js/159.145e5d6c.js"><link rel="prefetch" href="/blog/assets/js/16.49befed9.js"><link rel="prefetch" href="/blog/assets/js/160.7b813545.js"><link rel="prefetch" href="/blog/assets/js/161.3cb9e1d8.js"><link rel="prefetch" href="/blog/assets/js/162.804c4068.js"><link rel="prefetch" href="/blog/assets/js/163.b86b7055.js"><link rel="prefetch" href="/blog/assets/js/164.caed98c8.js"><link rel="prefetch" href="/blog/assets/js/165.fca724e7.js"><link rel="prefetch" href="/blog/assets/js/166.eed48ea2.js"><link rel="prefetch" href="/blog/assets/js/167.9ea80a92.js"><link rel="prefetch" href="/blog/assets/js/168.2133e57a.js"><link rel="prefetch" href="/blog/assets/js/169.0335555f.js"><link rel="prefetch" href="/blog/assets/js/17.37089c83.js"><link rel="prefetch" href="/blog/assets/js/170.afeee1ff.js"><link rel="prefetch" href="/blog/assets/js/171.90622dc2.js"><link rel="prefetch" href="/blog/assets/js/18.fd396b23.js"><link rel="prefetch" href="/blog/assets/js/19.e30f91c3.js"><link rel="prefetch" href="/blog/assets/js/20.61304a72.js"><link rel="prefetch" href="/blog/assets/js/21.d3cb4f88.js"><link rel="prefetch" href="/blog/assets/js/22.97267535.js"><link rel="prefetch" href="/blog/assets/js/23.b23738eb.js"><link rel="prefetch" href="/blog/assets/js/24.5ec6bbaa.js"><link rel="prefetch" href="/blog/assets/js/25.e2d15454.js"><link rel="prefetch" href="/blog/assets/js/26.bbc157a6.js"><link rel="prefetch" href="/blog/assets/js/27.795d8e56.js"><link rel="prefetch" href="/blog/assets/js/28.890f84d4.js"><link rel="prefetch" href="/blog/assets/js/29.d9b04fc8.js"><link rel="prefetch" href="/blog/assets/js/3.6c93b5c9.js"><link rel="prefetch" href="/blog/assets/js/30.7021199c.js"><link rel="prefetch" href="/blog/assets/js/31.f5a445a3.js"><link rel="prefetch" href="/blog/assets/js/32.22253148.js"><link rel="prefetch" href="/blog/assets/js/33.932120d7.js"><link rel="prefetch" href="/blog/assets/js/34.1092aa8a.js"><link rel="prefetch" href="/blog/assets/js/35.d91d092d.js"><link rel="prefetch" href="/blog/assets/js/36.27469084.js"><link rel="prefetch" href="/blog/assets/js/37.8fb98875.js"><link rel="prefetch" href="/blog/assets/js/38.c58f044b.js"><link rel="prefetch" href="/blog/assets/js/39.4cde7e38.js"><link rel="prefetch" href="/blog/assets/js/40.5748844d.js"><link rel="prefetch" href="/blog/assets/js/41.48c7e613.js"><link rel="prefetch" href="/blog/assets/js/42.b9520ca2.js"><link rel="prefetch" href="/blog/assets/js/43.c96d99f3.js"><link rel="prefetch" href="/blog/assets/js/44.d2b988f4.js"><link rel="prefetch" href="/blog/assets/js/45.06a5c553.js"><link rel="prefetch" href="/blog/assets/js/46.c3dc7516.js"><link rel="prefetch" href="/blog/assets/js/47.07eb8cfd.js"><link rel="prefetch" href="/blog/assets/js/48.4cff85b3.js"><link rel="prefetch" href="/blog/assets/js/49.73516eb5.js"><link rel="prefetch" href="/blog/assets/js/5.187e48eb.js"><link rel="prefetch" href="/blog/assets/js/50.3b64cda4.js"><link rel="prefetch" href="/blog/assets/js/51.c3a2700e.js"><link rel="prefetch" href="/blog/assets/js/52.af2b6ce1.js"><link rel="prefetch" href="/blog/assets/js/53.0ba26d99.js"><link rel="prefetch" href="/blog/assets/js/54.ec2af5d6.js"><link rel="prefetch" href="/blog/assets/js/55.dc9561d0.js"><link rel="prefetch" href="/blog/assets/js/56.c7535e98.js"><link rel="prefetch" href="/blog/assets/js/57.4430296b.js"><link rel="prefetch" href="/blog/assets/js/58.70248302.js"><link rel="prefetch" href="/blog/assets/js/59.4322e346.js"><link rel="prefetch" href="/blog/assets/js/6.539ab69c.js"><link rel="prefetch" href="/blog/assets/js/60.7bee13d5.js"><link rel="prefetch" href="/blog/assets/js/61.1c481ead.js"><link rel="prefetch" href="/blog/assets/js/62.83ce09c4.js"><link rel="prefetch" href="/blog/assets/js/63.8a8b5654.js"><link rel="prefetch" href="/blog/assets/js/64.5ac3a895.js"><link rel="prefetch" href="/blog/assets/js/65.b3111380.js"><link rel="prefetch" href="/blog/assets/js/66.6ab1555a.js"><link rel="prefetch" href="/blog/assets/js/67.c1858333.js"><link rel="prefetch" href="/blog/assets/js/68.0f8ce8fd.js"><link rel="prefetch" href="/blog/assets/js/69.394a9435.js"><link rel="prefetch" href="/blog/assets/js/7.c55f6e83.js"><link rel="prefetch" href="/blog/assets/js/70.a422d114.js"><link rel="prefetch" href="/blog/assets/js/71.8a4ef3c7.js"><link rel="prefetch" href="/blog/assets/js/72.b04595ae.js"><link rel="prefetch" href="/blog/assets/js/73.9ee93839.js"><link rel="prefetch" href="/blog/assets/js/74.25f6e946.js"><link rel="prefetch" href="/blog/assets/js/75.799b997e.js"><link rel="prefetch" href="/blog/assets/js/76.c48b908f.js"><link rel="prefetch" href="/blog/assets/js/77.7641197b.js"><link rel="prefetch" href="/blog/assets/js/78.ed27ff78.js"><link rel="prefetch" href="/blog/assets/js/79.34a5030b.js"><link rel="prefetch" href="/blog/assets/js/8.60aa9c8a.js"><link rel="prefetch" href="/blog/assets/js/80.fc11b137.js"><link rel="prefetch" href="/blog/assets/js/81.b284ea46.js"><link rel="prefetch" href="/blog/assets/js/82.21a84725.js"><link rel="prefetch" href="/blog/assets/js/83.31f93a7c.js"><link rel="prefetch" href="/blog/assets/js/84.955806fc.js"><link rel="prefetch" href="/blog/assets/js/85.0d8c9b9d.js"><link rel="prefetch" href="/blog/assets/js/86.bb112855.js"><link rel="prefetch" href="/blog/assets/js/87.45182a07.js"><link rel="prefetch" href="/blog/assets/js/88.3c5173e1.js"><link rel="prefetch" href="/blog/assets/js/89.08f874a1.js"><link rel="prefetch" href="/blog/assets/js/9.9ae7697d.js"><link rel="prefetch" href="/blog/assets/js/90.69b7234b.js"><link rel="prefetch" href="/blog/assets/js/91.6ae8dbf9.js"><link rel="prefetch" href="/blog/assets/js/92.834054d9.js"><link rel="prefetch" href="/blog/assets/js/93.23b604cc.js"><link rel="prefetch" href="/blog/assets/js/94.d18b3378.js"><link rel="prefetch" href="/blog/assets/js/95.82bf7e0d.js"><link rel="prefetch" href="/blog/assets/js/96.a9eefec5.js"><link rel="prefetch" href="/blog/assets/js/97.0f26ed6e.js"><link rel="prefetch" href="/blog/assets/js/98.835864c6.js"><link rel="prefetch" href="/blog/assets/js/99.55a39345.js">
    <link rel="stylesheet" href="/blog/assets/css/0.styles.1c8ccece.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/blog/" class="home-link router-link-active"><img src="/blog/logo.png" alt="花帽子的博客" class="logo"> <span class="site-name can-hide">花帽子的博客</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/blog/" class="nav-link">
  主页
</a></div><div class="nav-item"><a href="/blog/vue/" class="nav-link">
  Vue
</a></div><div class="nav-item"><a href="/blog/react/" class="nav-link router-link-active">
  React
</a></div><div class="nav-item"><a href="/blog/css/" class="nav-link">
  CSS
</a></div><div class="nav-item"><a href="/blog/javascript/" class="nav-link">
  JS&amp;TS
</a></div><div class="nav-item"><a href="/blog/node/" class="nav-link">
  Node
</a></div><div class="nav-item"><a href="/blog/devops/" class="nav-link">
  前端工程化
</a></div><div class="nav-item"><a href="/blog/mobile/" class="nav-link">
  泛客户端
</a></div><div class="nav-item"><a href="/blog/framework/" class="nav-link">
  架构&amp;方案
</a></div><div class="nav-item"><a href="/blog/code/" class="nav-link">
  算法&amp;编程
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="GitHub" class="dropdown-title"><span class="title">GitHub</span> <span class="arrow down"></span></button> <button type="button" aria-label="GitHub" class="mobile-dropdown-title"><span class="title">GitHub</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/jonny-wei" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub地址
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/blog/" class="nav-link">
  主页
</a></div><div class="nav-item"><a href="/blog/vue/" class="nav-link">
  Vue
</a></div><div class="nav-item"><a href="/blog/react/" class="nav-link router-link-active">
  React
</a></div><div class="nav-item"><a href="/blog/css/" class="nav-link">
  CSS
</a></div><div class="nav-item"><a href="/blog/javascript/" class="nav-link">
  JS&amp;TS
</a></div><div class="nav-item"><a href="/blog/node/" class="nav-link">
  Node
</a></div><div class="nav-item"><a href="/blog/devops/" class="nav-link">
  前端工程化
</a></div><div class="nav-item"><a href="/blog/mobile/" class="nav-link">
  泛客户端
</a></div><div class="nav-item"><a href="/blog/framework/" class="nav-link">
  架构&amp;方案
</a></div><div class="nav-item"><a href="/blog/code/" class="nav-link">
  算法&amp;编程
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="GitHub" class="dropdown-title"><span class="title">GitHub</span> <span class="arrow down"></span></button> <button type="button" aria-label="GitHub" class="mobile-dropdown-title"><span class="title">GitHub</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/jonny-wei" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub地址
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>React</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/react/" aria-current="page" class="sidebar-link">React JSX</a></li><li><a href="/blog/react/warmup/react-component.html" class="sidebar-link">React 组件及通信</a></li><li><a href="/blog/react/warmup/react-state.html" class="sidebar-link">React State</a></li><li><a href="/blog/react/warmup/react-props.html" class="sidebar-link">React Props</a></li><li><a href="/blog/react/warmup/react-lifecycle.html" class="sidebar-link">React 生命周期</a></li><li><a href="/blog/react/warmup/react-ref.html" class="sidebar-link">React Ref</a></li><li><a href="/blog/react/warmup/react-context.html" class="sidebar-link">React Context</a></li><li><a href="/blog/react/warmup/react-css.html" class="sidebar-link">React 中 CSS 的模块化</a></li><li><a href="/blog/react/warmup/react-hoc.html" class="sidebar-link">React HOC</a></li><li><a href="/blog/react/warmup/react-render.html" class="sidebar-link">React 渲染优化</a></li><li><a href="/blog/react/warmup/react-router.html" class="sidebar-link">React Router</a></li><li><a href="/blog/react/warmup/react-redux.html" class="sidebar-link">React Rudex</a></li><li><a href="/blog/react/warmup/react-mobx.html" class="sidebar-link">React Mobx</a></li><li><a href="/blog/react/warmup/react-transition.html" class="sidebar-link">V18 - Transition</a></li><li><a href="/blog/react/warmup/react-suspense.html" class="sidebar-link">V18 - Suspense</a></li><li><a href="/blog/react/warmup/react-useMutableSource.html" class="sidebar-link">V18 - useMutableSource</a></li><li><a href="/blog/react/warmup/react-keepalive.html" class="sidebar-link">实现 keepAlive</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>React源码解析</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/react/react/react-version.html" class="sidebar-link">React 不同版本间的区别</a></li><li><a href="/blog/react/react/react-scheduler.html" class="sidebar-link">Scheduler 调度器</a></li><li><a href="/blog/react/react/react-reconciler.html" aria-current="page" class="active sidebar-link">Reconciler 协调器</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/react/react/react-reconciler.html#fiber" class="sidebar-link">Fiber</a></li><li class="sidebar-sub-header"><a href="/blog/react/react/react-reconciler.html#fiber更新机制" class="sidebar-link">Fiber更新机制</a></li><li class="sidebar-sub-header"><a href="/blog/react/react/react-reconciler.html#两大阶段" class="sidebar-link">两大阶段</a></li></ul></li><li><a href="/blog/react/react/react-priority.html" class="sidebar-link">React 优先级模型</a></li><li><a href="/blog/react/react/react-fiber.html" class="sidebar-link">React Fiber</a></li><li><a href="/blog/react/react/react-diff.html" class="sidebar-link">React Diff 算法</a></li><li><a href="/blog/react/react/react-hooks.html" class="sidebar-link">React Hooks 理解</a></li><li><a href="/blog/react/react/react-lifecycle.html" class="sidebar-link">React 生命周期</a></li><li><a href="/blog/react/react/react-context.html" class="sidebar-link">React Context 原理</a></li><li><a href="/blog/react/react/react-event.html" class="sidebar-link">React 事件系统</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="reconciler-协调器"><a href="#reconciler-协调器" class="header-anchor">#</a> Reconciler 协调器</h1> <ul><li>什么是fiber ? Fiber 架构解决了什么问题？</li> <li>Fiber root 和 root fiber 有什么区别？</li> <li>不同fiber 之间如何建立起关联的？</li> <li>React 调和流程？</li> <li>两大阶段 commit 和 render 都做了哪些事情？</li> <li>什么是双缓冲树？ 有什么作用？</li> <li>Fiber 深度遍历流程？</li> <li>Fiber的调和能中断吗？ 如何中断？</li></ul> <h2 id="fiber"><a href="#fiber" class="header-anchor">#</a> Fiber</h2> <p><strong>什么是fiber</strong></p> <p>fiber 架构，目的就是解决大型 React 应用卡顿；fiber 在 React 中是最小粒度的执行单元，无论 React 还是 Vue ，在遍历更新每一个节点的时候都不是用的真实 DOM ，都是采用虚拟 DOM ，所以可以理解成 fiber 就是 React 的虚拟 DOM 。</p> <p><strong>为什么要用fiber</strong></p> <p>在 <code>Reactv15</code> 以及之前的版本，React 对于虚拟 DOM 是采用递归方式遍历更新的，比如一次更新，就会从应用根部递归更新，递归一旦开始，中途无法中断，随着项目越来越复杂，层级越来越深，导致更新的时间越来越长，给前端交互上的体验就是卡顿。</p> <p><code>Reactv16</code> 为了解决卡顿问题引入了 fiber ，为什么它能解决卡顿，更新 fiber 的过程叫做 <code>Reconciler</code>（调和器），每一个 fiber 都可以作为一个执行单元来处理，所以每一个 fiber 可以根据自身的过期时间<code>expirationTime</code>（ v17 版本叫做优先级 <code>lane</code> ）来判断是否还有空间时间执行更新，如果没有时间更新，就要把主动权交给浏览器去渲染，做一些动画，重排（ reflow ），重绘 repaints 之类的事情，这样就能给用户感觉不是很卡。然后等浏览器空余时间，在通过 <code>scheduler</code> （调度器），再次恢复执行单元上来，这样就能本质上中断了渲染，提高了用户体验。</p> <h3 id="element-fiber-dom-之间关系"><a href="#element-fiber-dom-之间关系" class="header-anchor">#</a> element,fiber,dom 之间关系</h3> <p>首先必须需要弄明白 React.element ，fiber 和真实 DOM 三者是什么关系。</p> <ul><li>element 是 React 视图层在代码层级上的表象，也就是开发者写的 jsx 语法，写的元素结构，都会被创建成 element 对象的形式。上面保存了 props ， children 等信息。</li> <li>DOM 是元素在浏览器上给用户直观的表象。</li> <li>fiber 可以说是是 element 和真实 DOM 之间的交流枢纽站，一方面每一个类型 element 都会有一个与之对应的 fiber 类型，element 变化引起更新流程都是通过 fiber 层面做一次调和改变，然后对于元素，形成新的 DOM 做视图渲染。</li></ul> <p><img src="/blog/images/react/reconciler1.png" alt="reconciler"></p> <p>首先先来看一下 element 与 fiber 之间的对应关系：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">const</span> FunctionComponent <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>       <span class="token comment">// 对应函数组件</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> ClassComponent <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>          <span class="token comment">// 对应的类组件</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> IndeterminateComponent <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>  <span class="token comment">// 初始化的时候不知道是函数组件还是类组件 </span>
<span class="token keyword">export</span> <span class="token keyword">const</span> HostRoot <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>                <span class="token comment">// Root Fiber 可以理解为跟元素 ， 通过reactDom.render()产生的根元素</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> HostPortal <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span>              <span class="token comment">// 对应  ReactDOM.createPortal 产生的 Portal </span>
<span class="token keyword">export</span> <span class="token keyword">const</span> HostComponent <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>           <span class="token comment">// dom 元素 比如 &lt;div&gt;</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> HostText <span class="token operator">=</span> <span class="token number">6</span><span class="token punctuation">;</span>                <span class="token comment">// 文本节点</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> Fragment <span class="token operator">=</span> <span class="token number">7</span><span class="token punctuation">;</span>                <span class="token comment">// 对应 &lt;React.Fragment&gt; </span>
<span class="token keyword">export</span> <span class="token keyword">const</span> Mode <span class="token operator">=</span> <span class="token number">8</span><span class="token punctuation">;</span>                    <span class="token comment">// 对应 &lt;React.StrictMode&gt;   </span>
<span class="token keyword">export</span> <span class="token keyword">const</span> ContextConsumer <span class="token operator">=</span> <span class="token number">9</span><span class="token punctuation">;</span>         <span class="token comment">// 对应 &lt;Context.Consumer&gt;</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> ContextProvider <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>        <span class="token comment">// 对应 &lt;Context.Provider&gt;</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> ForwardRef <span class="token operator">=</span> <span class="token number">11</span><span class="token punctuation">;</span>             <span class="token comment">// 对应 React.ForwardRef</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> Profiler <span class="token operator">=</span> <span class="token number">12</span><span class="token punctuation">;</span>               <span class="token comment">// 对应 &lt;Profiler/ &gt;</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> SuspenseComponent <span class="token operator">=</span> <span class="token number">13</span><span class="token punctuation">;</span>      <span class="token comment">// 对应 &lt;Suspense&gt;</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> MemoComponent <span class="token operator">=</span> <span class="token number">14</span><span class="token punctuation">;</span>          <span class="token comment">// 对应 React.memo 返回的组件</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><h3 id="fiber-保存的信息"><a href="#fiber-保存的信息" class="header-anchor">#</a> fiber 保存的信息</h3> <p>fiber 作为 element 和真实 DOM 元素的沟通枢纽，那么一个 fiber 上到底保存了那些信息呢？</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">FiberNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>

  <span class="token keyword">this</span><span class="token punctuation">.</span>tag <span class="token operator">=</span> tag<span class="token punctuation">;</span>                  <span class="token comment">// fiber 标签 证明是什么类型fiber。</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>key <span class="token operator">=</span> key<span class="token punctuation">;</span>                  <span class="token comment">// key调和子节点时候用到。 </span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>type <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>                <span class="token comment">// dom元素是对应的元素类型，比如div，组件指向组件对应的类或者函数。  </span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>stateNode <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>           <span class="token comment">// 指向对应的真实dom元素，类组件指向组件实例，可以被ref获取。</span>
 
  <span class="token keyword">this</span><span class="token punctuation">.</span>return <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>              <span class="token comment">// 指向父级fiber</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>child <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>               <span class="token comment">// 指向子级fiber</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>sibling <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>             <span class="token comment">// 指向兄弟fiber </span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>index <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>                  <span class="token comment">// 索引</span>

  <span class="token keyword">this</span><span class="token punctuation">.</span>ref <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>                 <span class="token comment">// ref指向，ref函数，或者ref对象。</span>

  <span class="token keyword">this</span><span class="token punctuation">.</span>pendingProps <span class="token operator">=</span> pendingProps<span class="token punctuation">;</span><span class="token comment">// 在一次更新中，代表element创建</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>memoizedProps <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>       <span class="token comment">// 记录上一次更新完毕后的props</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>updateQueue <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>         <span class="token comment">// 类组件存放setState更新队列，函数组件存放</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>memoizedState <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>       <span class="token comment">// 类组件保存state信息，函数组件保存hooks信息，dom元素为null</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>dependencies <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>        <span class="token comment">// context或是时间的依赖项</span>

  <span class="token keyword">this</span><span class="token punctuation">.</span>mode <span class="token operator">=</span> mode<span class="token punctuation">;</span>                <span class="token comment">//描述fiber树的模式，比如 ConcurrentMode 模式</span>

  <span class="token keyword">this</span><span class="token punctuation">.</span>effectTag <span class="token operator">=</span> NoEffect<span class="token punctuation">;</span>       <span class="token comment">// effect标签，用于收集effectList</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>nextEffect <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>          <span class="token comment">// 指向下一个effect</span>

  <span class="token keyword">this</span><span class="token punctuation">.</span>firstEffect <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>         <span class="token comment">// 第一个effect</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>lastEffect <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>          <span class="token comment">// 最后一个effect</span>

  <span class="token keyword">this</span><span class="token punctuation">.</span>expirationTime <span class="token operator">=</span> NoWork<span class="token punctuation">;</span>    <span class="token comment">// 通过不同过期时间，判断任务是否过期， 在v17版本用lane表示。</span>

  <span class="token keyword">this</span><span class="token punctuation">.</span>alternate <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>           <span class="token comment">//双缓存树，指向缓存的fiber。更新阶段，两颗树互相交替。</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br></div></div><h3 id="fiber-节点间的关联"><a href="#fiber-节点间的关联" class="header-anchor">#</a> fiber 节点间的关联</h3> <p>对于每一个 element 都会对应一个 fiber ，每一个 fiber 是通过 return ， child ，sibling 三个属性建立起联系的。</p> <ul><li>return： 指向父级 Fiber 节点。</li> <li>child： 指向子 Fiber 节点。</li> <li>sibling：指向兄弟 fiber 节点。</li></ul> <p>比如项目中元素结构是这样的：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">Index</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span><span class="token punctuation">{</span>
   state<span class="token operator">=</span><span class="token punctuation">{</span> number<span class="token operator">:</span><span class="token number">666</span> <span class="token punctuation">}</span> 
   <span class="token function-variable function">handleClick</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
     <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
         number<span class="token operator">:</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>number <span class="token operator">+</span> <span class="token number">1</span>
     <span class="token punctuation">}</span><span class="token punctuation">)</span>
   <span class="token punctuation">}</span>
   <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
     <span class="token keyword">return</span> <span class="token operator">&lt;</span>div<span class="token operator">&gt;</span>
       hello，world
       <span class="token operator">&lt;</span>p <span class="token operator">&gt;</span> 《React进阶实践指南》 <span class="token punctuation">{</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>number <span class="token punctuation">}</span> 👍  <span class="token operator">&lt;</span><span class="token operator">/</span>p<span class="token operator">&gt;</span>
       <span class="token operator">&lt;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{</span> <span class="token keyword">this</span><span class="token punctuation">.</span>handleClick <span class="token punctuation">}</span> <span class="token operator">&gt;</span>点赞<span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">&gt;</span>
     <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><h2 id="fiber更新机制"><a href="#fiber更新机制" class="header-anchor">#</a> Fiber更新机制</h2> <h3 id="初始化"><a href="#初始化" class="header-anchor">#</a> 初始化</h3> <p><strong>第一步：创建 fiberRoo t和 rootFiber</strong></p> <ul><li><code>fiberRoot</code>：首次构建应用， 创建一个 fiberRoot ，作为整个 React 应用的根基。</li> <li><code>rootFiber</code>： 如下通过 ReactDOM.render 渲染出来的，如上 Index 可以作为一个 rootFiber。一个 React 应用可以有多 ReactDOM.render 创建的 rootFiber ，但是只能有一个 fiberRoot（应用根节点）。</li></ul> <div class="language-js line-numbers-mode"><pre class="language-js"><code>ReactDOM<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token operator">&lt;</span>Index<span class="token operator">/</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'app'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>第一次挂载的过程中，会将 fiberRoot 和 rootFiber 建立起关联。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// react-reconciler/src/ReactFiberRoot.js</span>
<span class="token keyword">function</span> <span class="token function">createFiberRoot</span><span class="token punctuation">(</span><span class="token parameter">containerInfo<span class="token punctuation">,</span>tag</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">/* 创建一个root */</span>
    <span class="token keyword">const</span> root <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FiberRootNode</span><span class="token punctuation">(</span>containerInfo<span class="token punctuation">,</span>tag<span class="token punctuation">)</span>
    <span class="token keyword">const</span> rootFiber <span class="token operator">=</span> <span class="token function">createHostRootFiber</span><span class="token punctuation">(</span>tag<span class="token punctuation">)</span><span class="token punctuation">;</span>
    root<span class="token punctuation">.</span>current <span class="token operator">=</span> rootFiber
    <span class="token keyword">return</span> root
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p><strong>第二步：workInProgress和current</strong></p> <p>经过第一步的处理，开始到正式渲染阶段，会进入 <code>beginwork</code> 流程，在讲渲染流程之前，要先弄明白两个概念：</p> <ul><li><code>workInProgress</code> 是：正在内存中构建的 Fiber 树称为 <code>workInProgress Fiber 树</code>。在一次更新中，所有的更新都是发生在 <code>workInProgress</code> 树上。在一次更新之后，<code>workInProgress 树</code>上的状态是最新的状态，那么它将变成 <code>current 树</code>用于渲染视图。</li> <li><code>current</code>：正在视图层渲染的树叫做 <code>current 树</code>。</li></ul> <p>接下来会到 <code>rootFiber</code> 的渲染流程，首先会复用当前 current 树（ rootFiber ）的 <code>alternate</code> 作为 <code>workInProgress</code> ，如果没有 alternate （初始化的 rootFiber 是没有 alternate ），那么会创建一个 fiber 作为 <code>workInProgress</code> 。会用 <code>alternate</code> 将新创建的 <code>workInProgress</code> 与 <code>current</code> 树建立起关联。这个关联过程只有初始化第一次创建 <code>alternate</code> 时候进行。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>currentFiber<span class="token punctuation">.</span>alternate <span class="token operator">=</span> workInProgressFiber
workInProgressFiber<span class="token punctuation">.</span>alternate <span class="token operator">=</span> currentFiber
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p><strong>第三步：深度调和子节点，渲染视图</strong></p> <p>接下来会按照上述第二步，在新创建的 alternates 上，完成整个 fiber 树的遍历，包括 fiber 的创建。最后会以 workInProgress 作为最新的渲染树，fiberRoot 的 current 指针指向 workInProgress 使其变为 current Fiber 树。到此完成初始化流程。</p> <h3 id="更新"><a href="#更新" class="header-anchor">#</a> 更新</h3> <p>更新时，重新创建一颗 <code>workInProgresss 树</code>，复用当前 current 树上的 <code>alternate</code> ，作为新的 <code>workInProgress</code> ，由于初始化 rootfiber 有 <code>alternate</code> ，所以对于剩余的子节点，React 还需要创建一份，和 <code>current 树</code>上的 fiber 建立起 <code>alternate</code> 关联。渲染完毕后，<code>workInProgresss</code> 再次变成 <code>current 树</code>。</p> <h3 id="双缓冲树"><a href="#双缓冲树" class="header-anchor">#</a> 双缓冲树</h3> <p>canvas 绘制动画的时候，如果上一帧计算量比较大，导致清除上一帧画面到绘制当前帧画面之间有较长间隙，就会出现白屏。为了解决这个问题，canvas 在内存中绘制当前动画，绘制完毕后直接用当前帧替换上一帧画面，由于省去了两帧替换间的计算时间，不会出现从白屏到出现画面的闪烁情况。这种在内存中构建并直接替换的技术叫做<strong>双缓存</strong>。</p> <p>React 用 workInProgress 树(内存中构建的树) 和 current (渲染树) 来实现更新逻辑。双缓存一个在内存中构建，一个渲染视图，两颗树用 alternate 指针相互指向，在下一次渲染的时候，直接复用缓存树做为下一次渲染树，上一次的渲染树又作为缓存树，这样可以防止只用一颗树更新状态的丢失的情况，又加快了 DOM 节点的替换与更新。</p> <h2 id="两大阶段"><a href="#两大阶段" class="header-anchor">#</a> 两大阶段</h2> <h3 id="render-阶段"><a href="#render-阶段" class="header-anchor">#</a> render 阶段</h3> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// react-reconciler/src/ReactFiberWorkLoop.js</span>
<span class="token keyword">function</span> <span class="token function">workLoop</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>workInProgress <span class="token operator">!==</span> <span class="token keyword">null</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
      workInProgress <span class="token operator">=</span> <span class="token function">performUnitOfWork</span><span class="token punctuation">(</span>workInProgress<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>上述已经说了，每一个 fiber 可以看作一个执行的单元，在调和过程中，每一个发生更新的 fiber 都会作为一次 workInProgress 。那么 workLoop 就是执行每一个单元的调度器，如果渲染没有被中断，那么 workLoop 会遍历一遍 fiber 树。 performUnitOfWork 包括两个阶段 beginWork 和 completeWork 。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// react-reconciler/src/ReactFiberWorkLoop.js</span>
<span class="token keyword">function</span> <span class="token function">performUnitOfWork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    next <span class="token operator">=</span> <span class="token function">beginWork</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> unitOfWork<span class="token punctuation">,</span> renderExpirationTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>next <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       next <span class="token operator">=</span> <span class="token function">completeUnitOfWork</span><span class="token punctuation">(</span>unitOfWork<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p><code>beginWork</code>：是向下调和的过程。就是由 fiberRoot 按照 child 指针逐层向下调和，期间会执行函数组件，实例类组件，diff 调和子节点，打不同effectTag。</p> <p><code>completeUnitOfWork</code>：是向上归并的过程，如果有兄弟节点，会返回 sibling兄弟，没有返回 return 父级，一直返回到 fiebrRoot ，期间可以形成effectList，对于初始化流程会创建 DOM ，对于 DOM 元素进行事件收集，处理style，className等。</p> <p>这么一上一下，构成了整个 fiber 树的调和。</p> <h4 id="向下调和-beginwork"><a href="#向下调和-beginwork" class="header-anchor">#</a> 向下调和 beginWork</h4> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// react-reconciler/src/ReactFiberBeginWork.js</span>
<span class="token keyword">function</span> <span class="token function">beginWork</span><span class="token punctuation">(</span><span class="token parameter">current<span class="token punctuation">,</span>workInProgress</span><span class="token punctuation">)</span><span class="token punctuation">{</span>

    <span class="token keyword">switch</span><span class="token punctuation">(</span>workInProgress<span class="token punctuation">.</span>tag<span class="token punctuation">)</span><span class="token punctuation">{</span>
       <span class="token keyword">case</span> IndeterminateComponent<span class="token operator">:</span><span class="token punctuation">{</span><span class="token comment">// 初始化的时候不知道是函数组件还是类组件 </span>
           <span class="token comment">//....</span>
       <span class="token punctuation">}</span>
       <span class="token keyword">case</span> FunctionComponent<span class="token operator">:</span> <span class="token punctuation">{</span><span class="token comment">//对应函数组件</span>
           <span class="token comment">//....</span>
       <span class="token punctuation">}</span>
       <span class="token keyword">case</span> ClassComponent<span class="token operator">:</span><span class="token punctuation">{</span>  <span class="token comment">//类组件</span>
           <span class="token comment">//...</span>
       <span class="token punctuation">}</span>
       <span class="token keyword">case</span> HostComponent<span class="token operator">:</span><span class="token punctuation">{</span>
           <span class="token comment">//...  </span>
       <span class="token punctuation">}</span>
       <span class="token operator">...</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p>总结 beginWork 作用如下：</p> <ul><li>对于组件，执行部分生命周期，执行 render ，得到最新的 children 。</li> <li>向下遍历调和 children ，复用 oldFiber ( diff 算法)，diff 流程在第十二章已经讲过了。</li> <li>打不同的副作用标签 effectTag ，比如类组件的生命周期，或者元素的增加，删除，更新。</li></ul> <p><strong>reconcileChildren</strong></p> <p>接下来看一下 React 是如何调和子节点的：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// react-reconciler/src/ReactFiberBeginWork.js</span>
<span class="token keyword">function</span> <span class="token function">reconcileChildren</span><span class="token punctuation">(</span><span class="token parameter">current<span class="token punctuation">,</span>workInProgress</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>current <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>  <span class="token comment">/* 初始化子代fiber  */</span>
        workInProgress<span class="token punctuation">.</span>child <span class="token operator">=</span> <span class="token function">mountChildFibers</span><span class="token punctuation">(</span>workInProgress<span class="token punctuation">,</span><span class="token keyword">null</span><span class="token punctuation">,</span>nextChildren<span class="token punctuation">,</span>renderExpirationTime<span class="token punctuation">)</span>
   <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>  <span class="token comment">/* 更新流程，diff children将在这里进行。 */</span>
        workInProgress<span class="token punctuation">.</span>child <span class="token operator">=</span> <span class="token function">reconcileChildFibers</span><span class="token punctuation">(</span>workInProgress<span class="token punctuation">,</span>current<span class="token punctuation">.</span>child<span class="token punctuation">,</span>nextChildren<span class="token punctuation">,</span>renderExpirationTime<span class="token punctuation">)</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p><strong>EffectTag</strong> 我列举几个常用的 effectTag 。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">const</span> Placement <span class="token operator">=</span> <span class="token comment">/*             */</span> <span class="token number">0b0000000000010</span><span class="token punctuation">;</span>  <span class="token comment">// 插入节点</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> Update <span class="token operator">=</span> <span class="token comment">/*                */</span> <span class="token number">0b0000000000100</span><span class="token punctuation">;</span>  <span class="token comment">// 更新fiber</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> Deletion <span class="token operator">=</span> <span class="token comment">/*              */</span> <span class="token number">0b0000000001000</span><span class="token punctuation">;</span>  <span class="token comment">// 删除fiebr</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> Snapshot <span class="token operator">=</span> <span class="token comment">/*              */</span> <span class="token number">0b0000100000000</span><span class="token punctuation">;</span>  <span class="token comment">// 快照</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> Passive <span class="token operator">=</span> <span class="token comment">/*               */</span> <span class="token number">0b0001000000000</span><span class="token punctuation">;</span>  <span class="token comment">// useEffect的副作用</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> Callback <span class="token operator">=</span> <span class="token comment">/*              */</span> <span class="token number">0b0000000100000</span><span class="token punctuation">;</span>  <span class="token comment">// setState的 callback</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> Ref <span class="token operator">=</span> <span class="token comment">/*                   */</span> <span class="token number">0b0000010000000</span><span class="token punctuation">;</span>  <span class="token comment">// ref</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h4 id="向上归并-completeunitofwork"><a href="#向上归并-completeunitofwork" class="header-anchor">#</a> 向上归并 completeUnitOfWork</h4> <p>completeUnitOfWork 的流程是自下向上的，那么 completeUnitOfWork 过程主要做写什么呢？</p> <ul><li>首先 completeUnitOfWork 会将 effectTag 的 Fiber 节点会被保存在一条被称为 effectList 的单向链表中。在 commit 阶段，将不再需要遍历每一个 fiber ，只需要执行更新 effectList 就可以了。</li> <li>completeWork 阶段对于组件处理 context ；对于元素标签初始化，会创建真实 DOM ，将子孙 DOM 节点插入刚生成的 DOM 节点中；会触发 diffProperties 处理 props ，比如事件收集，style，className 处理。</li></ul> <h3 id="commit阶段"><a href="#commit阶段" class="header-anchor">#</a> commit阶段</h3> <p>commit 阶段做的事情是：</p> <ul><li>一方面是对一些生命周期和副作用钩子的处理，比如 componentDidMount ，函数组件的 useEffect ，useLayoutEffect ；</li> <li>另一方面就是在一次更新中，添加节点（ <code>Placement</code> ），更新节点（ <code>Update</code> ），删除节点（ <code>Deletion</code> ），还有就是一些细节的处理，比如 ref 的处理。</li></ul> <p>commit 细分可以分为：</p> <ul><li><code>Before mutation</code> 阶段（执行 DOM 操作前）；</li> <li><code>mutation</code> 阶段（执行 DOM 操作）；</li> <li><code>layout</code> 阶段（执行 DOM 操作后）</li></ul> <h4 id="before-mutation"><a href="#before-mutation" class="header-anchor">#</a> Before mutation</h4> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">commitBeforeMutationEffects</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>nextEffect <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> effectTag <span class="token operator">=</span> nextEffect<span class="token punctuation">.</span>effectTag<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>effectTag <span class="token operator">&amp;</span> Snapshot<span class="token punctuation">)</span> <span class="token operator">!==</span> NoEffect<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> current <span class="token operator">=</span> nextEffect<span class="token punctuation">.</span>alternate<span class="token punctuation">;</span>
      <span class="token comment">// 调用getSnapshotBeforeUpdates</span>
      <span class="token function">commitBeforeMutationEffectOnFiber</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> nextEffect<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>effectTag <span class="token operator">&amp;</span> Passive<span class="token punctuation">)</span> <span class="token operator">!==</span> NoEffect<span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token function">scheduleCallback</span><span class="token punctuation">(</span>NormalPriority<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token function">flushPassiveEffects</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    nextEffect <span class="token operator">=</span> nextEffect<span class="token punctuation">.</span>nextEffect<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p>Before mutation 阶段做的事主要有以下内容：</p> <ul><li>因为 Before mutation 还没修改真实的 DOM ，是获取 DOM 快照的最佳时期，如果是类组件有 getSnapshotBeforeUpdate ，那么会执行这个生命周期。</li> <li>会异步调用 useEffect ，在生命周期章节讲到 useEffect 是采用异步调用的模式，其目的就是防止同步执行时阻塞浏览器做视图渲染。</li></ul> <h4 id="mutation"><a href="#mutation" class="header-anchor">#</a> Mutation</h4> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">commitMutationEffects</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>nextEffect <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>effectTag <span class="token operator">&amp;</span> Ref<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">/* 置空Ref */</span>
            <span class="token keyword">const</span> current <span class="token operator">=</span> nextEffect<span class="token punctuation">.</span>alternate<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>current <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">commitDetachRef</span><span class="token punctuation">(</span>current<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">switch</span> <span class="token punctuation">(</span>primaryEffectTag<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">case</span> Placement<span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token comment">//  新增元素</span>
            <span class="token keyword">case</span> Update<span class="token operator">:</span><span class="token punctuation">{</span><span class="token punctuation">}</span>     <span class="token comment">//  更新元素</span>
            <span class="token keyword">case</span> Deletion<span class="token operator">:</span><span class="token punctuation">{</span><span class="token punctuation">}</span>   <span class="token comment">//  删除元素</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> 
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>mutation 阶段做的事情有：</p> <ul><li>置空 ref ，在 ref 章节讲到对于 ref 的处理。</li> <li>对新增元素，更新元素，删除元素。进行真实的 DOM 操作。</li></ul> <h4 id="layout"><a href="#layout" class="header-anchor">#</a> Layout</h4> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">commitLayoutEffects</span><span class="token punctuation">(</span><span class="token parameter">root</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
     <span class="token keyword">while</span> <span class="token punctuation">(</span>nextEffect <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">const</span> effectTag <span class="token operator">=</span> nextEffect<span class="token punctuation">.</span>effectTag<span class="token punctuation">;</span>
          <span class="token function">commitLayoutEffectOnFiber</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span>current<span class="token punctuation">,</span>nextEffect<span class="token punctuation">,</span>committedExpirationTime<span class="token punctuation">)</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>effectTag <span class="token operator">&amp;</span> Ref<span class="token punctuation">)</span> <span class="token punctuation">{</span>
             <span class="token function">commitAttachRef</span><span class="token punctuation">(</span>nextEffect<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
     <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>Layout 阶段 DOM 已经更新完毕，Layout 做的事情有：</p> <ul><li>commitLayoutEffectOnFiber 对于类组件，会执行生命周期，setState 的callback，对于函数组件会执行 useLayoutEffect 钩子。</li> <li>如果有 ref ，会重新赋值 ref 。</li></ul> <p>commit 阶段主要做的事就是执行 effectList，更新 DOM，执行生命周期，获取 ref 等操作。</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/blog/react/react/react-scheduler.html" class="prev">
        Scheduler 调度器
      </a></span> <span class="next"><a href="/blog/react/react/react-priority.html">
        React 优先级模型
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----><!----><!----><!----></div></div>
    <script src="/blog/assets/js/app.a7755d5e.js" defer></script><script src="/blog/assets/js/2.8bf77cff.js" defer></script><script src="/blog/assets/js/112.84c095ab.js" defer></script><script src="/blog/assets/js/4.ff6074e9.js" defer></script>
  </body>
</html>
