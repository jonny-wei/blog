<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>React 事件系统 | 花帽子的博客</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="icon" href="/blog/logo.png">
    <link rel="manifest" href="/blog/manifest.json">
    <link rel="apple-touch-icon" href="/blog/images/icons/apple-icon-152x152.png">
    <meta name="description" content="我命由我不由天，学习吧少年">
    <meta name="theme-color" content="#3eaf7c">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="msapplication-TileImage" content="/icons/ms-icon-144x144.png">
    <meta name="msapplication-TileColor" content="#000000">
    
    <link rel="preload" href="/blog/assets/css/0.styles.cdf5c1fc.css" as="style"><link rel="preload" href="/blog/assets/js/app.382adc38.js" as="script"><link rel="preload" href="/blog/assets/js/2.8bf77cff.js" as="script"><link rel="preload" href="/blog/assets/js/90.80fd91f4.js" as="script"><link rel="preload" href="/blog/assets/js/5.8fc7a0b0.js" as="script"><link rel="preload" href="/blog/assets/js/4.ff6074e9.js" as="script"><link rel="prefetch" href="/blog/assets/js/10.bb8f2a3c.js"><link rel="prefetch" href="/blog/assets/js/100.8f6403d0.js"><link rel="prefetch" href="/blog/assets/js/101.0e44d62f.js"><link rel="prefetch" href="/blog/assets/js/102.55e2cab2.js"><link rel="prefetch" href="/blog/assets/js/103.a8a9f034.js"><link rel="prefetch" href="/blog/assets/js/104.44eb89f4.js"><link rel="prefetch" href="/blog/assets/js/105.cd03742e.js"><link rel="prefetch" href="/blog/assets/js/106.d8d006b4.js"><link rel="prefetch" href="/blog/assets/js/107.73e33c97.js"><link rel="prefetch" href="/blog/assets/js/108.026c0f13.js"><link rel="prefetch" href="/blog/assets/js/109.6f93014a.js"><link rel="prefetch" href="/blog/assets/js/11.a7d9cfd9.js"><link rel="prefetch" href="/blog/assets/js/110.b38d33ad.js"><link rel="prefetch" href="/blog/assets/js/111.ee268e7a.js"><link rel="prefetch" href="/blog/assets/js/112.acd5c895.js"><link rel="prefetch" href="/blog/assets/js/113.063a2d68.js"><link rel="prefetch" href="/blog/assets/js/114.54de37b8.js"><link rel="prefetch" href="/blog/assets/js/115.7cd7ee39.js"><link rel="prefetch" href="/blog/assets/js/116.5a75d6d7.js"><link rel="prefetch" href="/blog/assets/js/117.ba376585.js"><link rel="prefetch" href="/blog/assets/js/118.248c62f8.js"><link rel="prefetch" href="/blog/assets/js/119.251d1d42.js"><link rel="prefetch" href="/blog/assets/js/12.49fbfd25.js"><link rel="prefetch" href="/blog/assets/js/120.f113eccb.js"><link rel="prefetch" href="/blog/assets/js/121.1a1e243f.js"><link rel="prefetch" href="/blog/assets/js/122.26dc83d6.js"><link rel="prefetch" href="/blog/assets/js/123.3edada49.js"><link rel="prefetch" href="/blog/assets/js/124.9c4916c2.js"><link rel="prefetch" href="/blog/assets/js/125.1997e5b8.js"><link rel="prefetch" href="/blog/assets/js/126.6d972267.js"><link rel="prefetch" href="/blog/assets/js/127.077b6b68.js"><link rel="prefetch" href="/blog/assets/js/128.837fd635.js"><link rel="prefetch" href="/blog/assets/js/129.07ecc063.js"><link rel="prefetch" href="/blog/assets/js/13.ce865bfd.js"><link rel="prefetch" href="/blog/assets/js/130.dde647ab.js"><link rel="prefetch" href="/blog/assets/js/131.c1ebeeb8.js"><link rel="prefetch" href="/blog/assets/js/132.88dc06e3.js"><link rel="prefetch" href="/blog/assets/js/133.117a6363.js"><link rel="prefetch" href="/blog/assets/js/134.9039104b.js"><link rel="prefetch" href="/blog/assets/js/135.b21f0746.js"><link rel="prefetch" href="/blog/assets/js/136.c8b90264.js"><link rel="prefetch" href="/blog/assets/js/137.c0a3f380.js"><link rel="prefetch" href="/blog/assets/js/138.41292518.js"><link rel="prefetch" href="/blog/assets/js/139.ed10fc2d.js"><link rel="prefetch" href="/blog/assets/js/14.c1143665.js"><link rel="prefetch" href="/blog/assets/js/140.4c5db38d.js"><link rel="prefetch" href="/blog/assets/js/141.57137067.js"><link rel="prefetch" href="/blog/assets/js/142.e1af6d2f.js"><link rel="prefetch" href="/blog/assets/js/143.aacf28e6.js"><link rel="prefetch" href="/blog/assets/js/144.f56a4cd1.js"><link rel="prefetch" href="/blog/assets/js/145.7cb44aa6.js"><link rel="prefetch" href="/blog/assets/js/146.77e4f1ae.js"><link rel="prefetch" href="/blog/assets/js/147.be8edab0.js"><link rel="prefetch" href="/blog/assets/js/148.639355f4.js"><link rel="prefetch" href="/blog/assets/js/149.22ce7862.js"><link rel="prefetch" href="/blog/assets/js/15.e7169853.js"><link rel="prefetch" href="/blog/assets/js/150.1ce3114d.js"><link rel="prefetch" href="/blog/assets/js/151.a7a50ef1.js"><link rel="prefetch" href="/blog/assets/js/16.30bc75bf.js"><link rel="prefetch" href="/blog/assets/js/17.4a5c95c8.js"><link rel="prefetch" href="/blog/assets/js/18.4b3bc12e.js"><link rel="prefetch" href="/blog/assets/js/19.782e0265.js"><link rel="prefetch" href="/blog/assets/js/20.b9a879ce.js"><link rel="prefetch" href="/blog/assets/js/21.2a5a58aa.js"><link rel="prefetch" href="/blog/assets/js/22.d0203066.js"><link rel="prefetch" href="/blog/assets/js/23.a86e122b.js"><link rel="prefetch" href="/blog/assets/js/24.15128497.js"><link rel="prefetch" href="/blog/assets/js/25.0b372a80.js"><link rel="prefetch" href="/blog/assets/js/26.20b2db4e.js"><link rel="prefetch" href="/blog/assets/js/27.a2be4fae.js"><link rel="prefetch" href="/blog/assets/js/28.637dc8e3.js"><link rel="prefetch" href="/blog/assets/js/29.a23f46c2.js"><link rel="prefetch" href="/blog/assets/js/3.6c93b5c9.js"><link rel="prefetch" href="/blog/assets/js/30.b5f4332f.js"><link rel="prefetch" href="/blog/assets/js/31.6cc127cb.js"><link rel="prefetch" href="/blog/assets/js/32.38bf6e69.js"><link rel="prefetch" href="/blog/assets/js/33.6b0c1eb0.js"><link rel="prefetch" href="/blog/assets/js/34.9b5e2f23.js"><link rel="prefetch" href="/blog/assets/js/35.30c4b6b8.js"><link rel="prefetch" href="/blog/assets/js/36.f4389aa7.js"><link rel="prefetch" href="/blog/assets/js/37.3db06d67.js"><link rel="prefetch" href="/blog/assets/js/38.86240fe9.js"><link rel="prefetch" href="/blog/assets/js/39.ab47e328.js"><link rel="prefetch" href="/blog/assets/js/40.d3f6bac4.js"><link rel="prefetch" href="/blog/assets/js/41.0ebef756.js"><link rel="prefetch" href="/blog/assets/js/42.b661aa44.js"><link rel="prefetch" href="/blog/assets/js/43.09532d31.js"><link rel="prefetch" href="/blog/assets/js/44.3825a357.js"><link rel="prefetch" href="/blog/assets/js/45.d55755f5.js"><link rel="prefetch" href="/blog/assets/js/46.646a96cf.js"><link rel="prefetch" href="/blog/assets/js/47.09b8ffe3.js"><link rel="prefetch" href="/blog/assets/js/48.00183e8b.js"><link rel="prefetch" href="/blog/assets/js/49.d72b19d8.js"><link rel="prefetch" href="/blog/assets/js/50.b930bbcb.js"><link rel="prefetch" href="/blog/assets/js/51.700abaf6.js"><link rel="prefetch" href="/blog/assets/js/52.a6b0c696.js"><link rel="prefetch" href="/blog/assets/js/53.c89943f9.js"><link rel="prefetch" href="/blog/assets/js/54.ada6f757.js"><link rel="prefetch" href="/blog/assets/js/55.f92e48ec.js"><link rel="prefetch" href="/blog/assets/js/56.4e06efe5.js"><link rel="prefetch" href="/blog/assets/js/57.bf6536fc.js"><link rel="prefetch" href="/blog/assets/js/58.eddfeb6d.js"><link rel="prefetch" href="/blog/assets/js/59.63604290.js"><link rel="prefetch" href="/blog/assets/js/6.e80c5c8e.js"><link rel="prefetch" href="/blog/assets/js/60.d18b687c.js"><link rel="prefetch" href="/blog/assets/js/61.4667bfde.js"><link rel="prefetch" href="/blog/assets/js/62.2c4bd3bc.js"><link rel="prefetch" href="/blog/assets/js/63.531a8e1c.js"><link rel="prefetch" href="/blog/assets/js/64.cb242155.js"><link rel="prefetch" href="/blog/assets/js/65.bbf10cc7.js"><link rel="prefetch" href="/blog/assets/js/66.bcfb75c2.js"><link rel="prefetch" href="/blog/assets/js/67.30231f74.js"><link rel="prefetch" href="/blog/assets/js/68.1d3fb605.js"><link rel="prefetch" href="/blog/assets/js/69.ba331a58.js"><link rel="prefetch" href="/blog/assets/js/7.fd1464a3.js"><link rel="prefetch" href="/blog/assets/js/70.061f17dd.js"><link rel="prefetch" href="/blog/assets/js/71.f6e93b09.js"><link rel="prefetch" href="/blog/assets/js/72.5d2acfcd.js"><link rel="prefetch" href="/blog/assets/js/73.ac5f9329.js"><link rel="prefetch" href="/blog/assets/js/74.831c9f94.js"><link rel="prefetch" href="/blog/assets/js/75.01b882ca.js"><link rel="prefetch" href="/blog/assets/js/76.5209eb88.js"><link rel="prefetch" href="/blog/assets/js/77.8947ed08.js"><link rel="prefetch" href="/blog/assets/js/78.b4c84da1.js"><link rel="prefetch" href="/blog/assets/js/79.8ef29c5e.js"><link rel="prefetch" href="/blog/assets/js/8.60aa9c8a.js"><link rel="prefetch" href="/blog/assets/js/80.afc3726e.js"><link rel="prefetch" href="/blog/assets/js/81.fe0ac560.js"><link rel="prefetch" href="/blog/assets/js/82.cccfefb8.js"><link rel="prefetch" href="/blog/assets/js/83.9e3dcaf5.js"><link rel="prefetch" href="/blog/assets/js/84.5ed6a37b.js"><link rel="prefetch" href="/blog/assets/js/85.66e6807d.js"><link rel="prefetch" href="/blog/assets/js/86.28884ef6.js"><link rel="prefetch" href="/blog/assets/js/87.880571db.js"><link rel="prefetch" href="/blog/assets/js/88.1a79f4fa.js"><link rel="prefetch" href="/blog/assets/js/89.5042139f.js"><link rel="prefetch" href="/blog/assets/js/9.9ae7697d.js"><link rel="prefetch" href="/blog/assets/js/91.70cdf876.js"><link rel="prefetch" href="/blog/assets/js/92.218a56d4.js"><link rel="prefetch" href="/blog/assets/js/93.eafe17b3.js"><link rel="prefetch" href="/blog/assets/js/94.22d0ab37.js"><link rel="prefetch" href="/blog/assets/js/95.745542d6.js"><link rel="prefetch" href="/blog/assets/js/96.aaef3be4.js"><link rel="prefetch" href="/blog/assets/js/97.d0a642c0.js"><link rel="prefetch" href="/blog/assets/js/98.09a972ed.js"><link rel="prefetch" href="/blog/assets/js/99.9c69be59.js">
    <link rel="stylesheet" href="/blog/assets/css/0.styles.cdf5c1fc.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/blog/" class="home-link router-link-active"><img src="/blog/logo.png" alt="花帽子的博客" class="logo"> <span class="site-name can-hide">花帽子的博客</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/blog/" class="nav-link">
  主页
</a></div><div class="nav-item"><a href="/blog/vue/" class="nav-link">
  Vue
</a></div><div class="nav-item"><a href="/blog/react/" class="nav-link router-link-active">
  React
</a></div><div class="nav-item"><a href="/blog/css/" class="nav-link">
  CSS
</a></div><div class="nav-item"><a href="/blog/javascript/" class="nav-link">
  JS&amp;TS
</a></div><div class="nav-item"><a href="/blog/node/" class="nav-link">
  Node
</a></div><div class="nav-item"><a href="/blog/devops/" class="nav-link">
  前端工程化
</a></div><div class="nav-item"><a href="/blog/mobile/" class="nav-link">
  泛客户端
</a></div><div class="nav-item"><a href="/blog/framework/" class="nav-link">
  架构&amp;解决方案
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="GitHub" class="dropdown-title"><span class="title">GitHub</span> <span class="arrow down"></span></button> <button type="button" aria-label="GitHub" class="mobile-dropdown-title"><span class="title">GitHub</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/jonny-wei" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub地址
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/blog/" class="nav-link">
  主页
</a></div><div class="nav-item"><a href="/blog/vue/" class="nav-link">
  Vue
</a></div><div class="nav-item"><a href="/blog/react/" class="nav-link router-link-active">
  React
</a></div><div class="nav-item"><a href="/blog/css/" class="nav-link">
  CSS
</a></div><div class="nav-item"><a href="/blog/javascript/" class="nav-link">
  JS&amp;TS
</a></div><div class="nav-item"><a href="/blog/node/" class="nav-link">
  Node
</a></div><div class="nav-item"><a href="/blog/devops/" class="nav-link">
  前端工程化
</a></div><div class="nav-item"><a href="/blog/mobile/" class="nav-link">
  泛客户端
</a></div><div class="nav-item"><a href="/blog/framework/" class="nav-link">
  架构&amp;解决方案
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="GitHub" class="dropdown-title"><span class="title">GitHub</span> <span class="arrow down"></span></button> <button type="button" aria-label="GitHub" class="mobile-dropdown-title"><span class="title">GitHub</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/jonny-wei" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub地址
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>React秘籍</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/react/" aria-current="page" class="sidebar-link">React 秘籍</a></li><li><a href="/blog/react/warmup/react-jsx.html" class="sidebar-link">React JSX</a></li><li><a href="/blog/react/warmup/react-component.html" class="sidebar-link">React 组件及通信</a></li><li><a href="/blog/react/warmup/react-state.html" class="sidebar-link">React State</a></li><li><a href="/blog/react/warmup/react-props.html" class="sidebar-link">React Props</a></li><li><a href="/blog/react/warmup/react-lifecycle.html" class="sidebar-link">React 生命周期</a></li><li><a href="/blog/react/warmup/react-ref.html" class="sidebar-link">React Ref</a></li><li><a href="/blog/react/warmup/react-context.html" class="sidebar-link">React Context</a></li><li><a href="/blog/react/warmup/react-css.html" class="sidebar-link">React 中 CSS 的模块化</a></li><li><a href="/blog/react/warmup/react-hoc.html" class="sidebar-link">React HOC</a></li><li><a href="/blog/react/warmup/react-render.html" class="sidebar-link">React 渲染优化</a></li><li><a href="/blog/react/warmup/react-router.html" class="sidebar-link">React Router</a></li><li><a href="/blog/react/warmup/react-redux.html" class="sidebar-link">React Rudex</a></li><li><a href="/blog/react/warmup/react-mobx.html" class="sidebar-link">React Mobx</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>React源码解析</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/react/react/react-version.html" class="sidebar-link">React 不同版本间的区别</a></li><li><a href="/blog/react/react/react-reconciler.html" class="sidebar-link">Reconciler 协调器</a></li><li><a href="/blog/react/react/react-scheduler.html" class="sidebar-link">Scheduler 调度器</a></li><li><a href="/blog/react/react/react-priority.html" class="sidebar-link">React 优先级模型</a></li><li><a href="/blog/react/react/react-fiber.html" class="sidebar-link">React Fiber</a></li><li><a href="/blog/react/react/react-diff.html" class="sidebar-link">React Diff 算法</a></li><li><a href="/blog/react/react/react-hooks.html" class="sidebar-link">React Hooks 理解</a></li><li><a href="/blog/react/react/react-lifecycle.html" class="sidebar-link">React 生命周期</a></li><li><a href="/blog/react/react/react-event.html" aria-current="page" class="active sidebar-link">React 事件系统</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/react/react/react-event.html#事件冒泡和捕获" class="sidebar-link">事件冒泡和捕获</a></li><li class="sidebar-sub-header"><a href="/blog/react/react/react-event.html#事件合成" class="sidebar-link">事件合成</a></li><li class="sidebar-sub-header"><a href="/blog/react/react/react-event.html#事件插件机制" class="sidebar-link">事件插件机制</a></li><li class="sidebar-sub-header"><a href="/blog/react/react/react-event.html#事件绑定" class="sidebar-link">事件绑定</a></li><li class="sidebar-sub-header"><a href="/blog/react/react/react-event.html#事件触发" class="sidebar-link">事件触发</a></li><li class="sidebar-sub-header"><a href="/blog/react/react/react-event.html#阻止事件冒泡" class="sidebar-link">阻止事件冒泡</a></li><li class="sidebar-sub-header"><a href="/blog/react/react/react-event.html#v18-事件系统" class="sidebar-link">V18 事件系统</a></li><li class="sidebar-sub-header"><a href="/blog/react/react/react-event.html#小结" class="sidebar-link">小结</a></li><li class="sidebar-sub-header"><a href="/blog/react/react/react-event.html#问题" class="sidebar-link">问题</a></li></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="react-事件系统"><a href="#react-事件系统" class="header-anchor">#</a> React 事件系统</h1> <ul><li>React 为什么有自己的事件系统？</li> <li>什么是事件合成 ？</li> <li>如何实现的批量更新？</li> <li>事件系统如何模拟冒泡和捕获阶段？</li> <li>如何通过 dom 元素找到与之匹配的 fiber？</li> <li>为什么不能用 return false 来阻止事件的默认行为？</li> <li>事件是绑定在真实的dom上吗？如何不是绑定在哪里？</li> <li>V17 对事件系统有哪些改变？</li></ul> <p>React 为什么要写出一套自己的事件系统呢？</p> <ol><li><p>首先，对于不同的浏览器，对事件存在不同的兼容性，React 想实现一个兼容全浏览器的框架， 为了实现这个目标就需要创建一个兼容全浏览器的事件系统，以此抹平不同浏览器的差异。</p></li> <li><p>其次，v17 之前 React 事件都是绑定在 document 上，v17 之后 React 把事件绑定在应用对应的容器 container 上，将事件绑定在同一容器统一管理，防止很多事件直接绑定在原生的 DOM 元素上。造成一些不可控的情况。由于不是绑定在真实的 DOM 上，所以 React 需要模拟一套事件流：<code>事件捕获-&gt; 事件源 -&gt; 事件冒泡</code>，也包括重写一下事件源对象 event 。</p></li> <li><p>最后，这种事件系统，大部分处理逻辑都在底层处理了，这对后期的 ssr 和跨端支持度很高。</p></li></ol> <h2 id="事件冒泡和捕获"><a href="#事件冒泡和捕获" class="header-anchor">#</a> 事件冒泡和捕获</h2> <ul><li>冒泡阶段：开发者正常给 React 绑定的事件比如 onClick，onChange，默认会在模拟冒泡阶段执行。</li> <li>捕获阶段：如果想要在捕获阶段执行可以将事件后面加上 Capture 后缀，比如 onClickCapture，onChangeCapture。</li></ul> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">Index</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token function-variable function">handleClick</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'模拟冒泡阶段执行'</span><span class="token punctuation">)</span> <span class="token punctuation">}</span> 
    <span class="token keyword">const</span> <span class="token function-variable function">handleClickCapture</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'模拟捕获阶段执行'</span><span class="token punctuation">)</span> <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token operator">&lt;</span>div<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{</span> handleClick  <span class="token punctuation">}</span> onClickCapture<span class="token operator">=</span><span class="token punctuation">{</span> handleClickCapture <span class="token punctuation">}</span>  <span class="token operator">&gt;</span>点击<span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>React 中如果想要阻止事件向上冒泡，可以用 <code>e.stopPropagation()</code>:</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">Index</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token function-variable function">handleClick</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        e<span class="token punctuation">.</span><span class="token function">stopPropagation</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">/* 阻止事件冒泡，handleFatherClick 事件讲不在触发 */</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">const</span> <span class="token function-variable function">handleFatherClick</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'冒泡到父级'</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token operator">&lt;</span>div onClick<span class="token operator">=</span><span class="token punctuation">{</span> handleFatherClick <span class="token punctuation">}</span> <span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>div onClick<span class="token operator">=</span><span class="token punctuation">{</span> handleClick <span class="token punctuation">}</span> <span class="token operator">&gt;</span>点击<span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>React 阻止冒泡和原生事件中的写法差不多，当如上 handleClick上 阻止冒泡，父级元素的 handleFatherClick 将不再执行，但是底层原理完全不同</p> <p>React 阻止默认行为和原生的事件也有一些区别。</p> <p>原生事件： <code>e.preventDefault()</code> 和 <code>return false</code> 可以用来阻止事件默认行为，由于在 React 中给元素的事件并不是真正的事件处理函数。所以导致 <code>return false</code> 方法在 React 应用中完全失去了作用。</p> <p>React 事件在 React 应用中，可以用 <code>e.preventDefault()</code> 阻止事件默认行为，这个方法并非是原生事件的 <code>preventDefault</code> ，由于 React 事件源 e 也是独立组建的，所以 <code>preventDefault</code> 也是单独处理的。</p> <h2 id="事件合成"><a href="#事件合成" class="header-anchor">#</a> 事件合成</h2> <p>React 事件系统可分为三个部分：</p> <ul><li>第一个部分是事件合成系统，初始化会注册不同的事件插件。</li> <li>第二个就是在一次渲染过程中，对事件标签中事件的收集，向 container 注册事件。</li> <li>第三个就是一次用户交互，事件触发，到事件执行一系列过程。</li></ul> <p>什么叫事件合成？</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">Index</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token function-variable function">handleClick</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token operator">&lt;</span>div <span class="token operator">&gt;</span>
     <span class="token operator">&lt;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{</span> handleClick <span class="token punctuation">}</span> <span class="token operator">&gt;</span>点击<span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>上面在 button 元素绑定的事件中，没有找到 handleClick 事件。但是在 document 上绑定一个 onclick 事件。于是如下将应用中再添加一个 input 并绑定一个 onChange 事件</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">Index</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token function-variable function">handleClick</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token keyword">const</span> <span class="token function-variable function">handleChange</span> <span class="token operator">=</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token operator">&lt;</span>div <span class="token operator">&gt;</span>
     <span class="token operator">&lt;</span>input onChange<span class="token operator">=</span><span class="token punctuation">{</span> handleChange <span class="token punctuation">}</span>  <span class="token operator">/</span><span class="token operator">&gt;</span>
     <span class="token operator">&lt;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{</span> handleClick <span class="token punctuation">}</span> <span class="token operator">&gt;</span>点击<span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>在 input 上还是没有找到绑定的事件 handleChange ，但是 document 的事件多了 blur，change ，focus ，keydown，keyup 等事件。</p> <ul><li>React 的事件不是绑定在元素上的，而是统一绑定在顶部容器上，在 v17 之前是绑定在 document 上的，在 v17 改成了 app 容器上。这样更利于一个 html 下存在多个应用（微前端）。</li> <li>绑定事件并不是一次性绑定所有事件，比如发现了 onClick 事件，就会绑定 click 事件，比如发现 onChange 事件，会绑定 <code>[blur，change ，focus ，keydown，keyup]</code>多个事件。</li> <li>React 事件合成的概念：React 应用中，元素绑定的事件并不是原生事件，而是React 合成的事件，比如 onClick 是由 click 合成，onChange 是由 blur ，change ，focus 等多个事件合成。</li></ul> <h2 id="事件插件机制"><a href="#事件插件机制" class="header-anchor">#</a> 事件插件机制</h2> <p>React 有一种事件插件机制，比如上述 onClick 和 onChange ，会有不同的事件插件 SimpleEventPlugin ，ChangeEventPlugin 处理</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> registrationNameModules <span class="token operator">=</span> <span class="token punctuation">{</span>
    onBlur<span class="token operator">:</span> SimpleEventPlugin<span class="token punctuation">,</span>
    onClick<span class="token operator">:</span> SimpleEventPlugin<span class="token punctuation">,</span>
    onClickCapture<span class="token operator">:</span> SimpleEventPlugin<span class="token punctuation">,</span>
    onChange<span class="token operator">:</span> ChangeEventPlugin<span class="token punctuation">,</span>
    onChangeCapture<span class="token operator">:</span> ChangeEventPlugin<span class="token punctuation">,</span>
    onMouseEnter<span class="token operator">:</span> EnterLeaveEventPlugin<span class="token punctuation">,</span>
    onMouseLeave<span class="token operator">:</span> EnterLeaveEventPlugin<span class="token punctuation">,</span>
    <span class="token operator">...</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>registrationNameModules 记录了 React 事件（比如 onBlur ）和与之对应的处理插件的映射，比如上述的 onClick ，就会用 SimpleEventPlugin 插件处理，onChange 就会用 ChangeEventPlugin 处理。应用于事件触发阶段，根据不同事件使用不同的插件。</p> <p>registrationNameDependencies 这个对象保存了 React 事件和原生事件对应关系，这就解释了为什么上述只写了一个 onChange ，会有很多原生事件绑定在 document 上。在事件绑定阶段，如果发现有 React 事件，比如 onChange ，就会找到对应的原生事件数组，逐一绑定。</p> <h2 id="事件绑定"><a href="#事件绑定" class="header-anchor">#</a> 事件绑定</h2> <p>事件绑定，就是在 React 处理 props 时候，如果遇到事件比如 onClick ，就会通过 addEventListener 注册原生事件</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">Index</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token function-variable function">handleClick</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'点击事件'</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> <span class="token function-variable function">handleChange</span> <span class="token operator">=</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>'change事件<span class="token punctuation">)</span>
  <span class="token keyword">return</span> <span class="token operator">&lt;</span>div <span class="token operator">&gt;</span>
     <span class="token operator">&lt;</span>input onChange<span class="token operator">=</span><span class="token punctuation">{</span> handleChange <span class="token punctuation">}</span>  <span class="token operator">/</span><span class="token operator">&gt;</span>
     <span class="token operator">&lt;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{</span> handleClick <span class="token punctuation">}</span> <span class="token operator">&gt;</span>点击<span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>对于如上结构，最后 onChange 和 onClick 会保存在对应 DOM 元素类型 fiber 对象（ hostComponent ）的 memoizedProps 属性上，如上结构会变成这样。</p> <p><img src="/images/react/%E4%BA%8B%E4%BB%B6%E7%B3%BB%E7%BB%9F1.png" alt="事件系统1"></p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// react-dom/src/client/ReactDOMComponent.js</span>
<span class="token keyword">function</span> <span class="token function">diffProperties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">/* 判断当前的 propKey 是不是 React合成事件 */</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>registrationNameModules<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">(</span>propKey<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
         <span class="token comment">/* 这里多个函数简化了，如果是合成事件， 传入成事件名称 onClick ，向document注册事件  */</span>
         <span class="token function">legacyListenToEvent</span><span class="token punctuation">(</span>registrationName<span class="token punctuation">,</span> document）<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p><code>diffProperties</code> 函数在 diff props 如果发现是合成事件( onClick ) 就会调用 <code>legacyListenToEvent</code> 函数。注册事件监听器。接下来看一下 <code>legacyListenToEvent</code> 是如何注册事件的。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// react-dom/src/events/DOMLegacyEventPluginSystem.js</span>
<span class="token keyword">function</span> <span class="token function">legacyListenToEvent</span><span class="token punctuation">(</span><span class="token parameter">registrationName，mountAt</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
   <span class="token keyword">const</span> dependencies <span class="token operator">=</span> registrationNameDependencies<span class="token punctuation">[</span>registrationName<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// 根据 onClick 获取  onClick 依赖的事件数组 [ 'click' ]。</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> dependencies<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> dependency <span class="token operator">=</span> dependencies<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token comment">//  addEventListener 绑定事件监听器</span>
    <span class="token operator">...</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>这个就是应用上述 <code>registrationNameDependencies</code> 对 React 合成事件，分别绑定原生事件的事件监听器。比如发现是 onChange ，那么取出 <code>['blur', 'change', 'click', 'focus', 'input', 'keydown', 'keyup', 'selectionchange']</code> 遍历绑定。</p> <p>绑定在 document 的事件处理函数是如上写的handleChange，handleClick 吗？</p> <p>答案是否定的，绑定在 document 的事件，是 React 统一的事件处理函数 dispatchEvent ，React 需要一个统一流程去代理事件逻辑，包括 React 批量更新等逻辑。</p> <p>只要是 React 事件触发，首先执行的就是 dispatchEvent ，那么有的同学会问，dispatchEvent 是如何知道是什么事件触发的呢？实际在注册的时候，就已经通过 bind ，把参数绑定给 dispatchEvent 了。</p> <h2 id="事件触发"><a href="#事件触发" class="header-anchor">#</a> 事件触发</h2> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">Index</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token function-variable function">handleClick1</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> <span class="token function-variable function">handleClick2</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> <span class="token function-variable function">handleClick3</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> <span class="token function-variable function">handleClick4</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token operator">&lt;</span>div onClick<span class="token operator">=</span><span class="token punctuation">{</span> handleClick3 <span class="token punctuation">}</span>  onClickCapture<span class="token operator">=</span><span class="token punctuation">{</span> handleClick4 <span class="token punctuation">}</span>  <span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{</span> handleClick1 <span class="token punctuation">}</span>  onClickCapture<span class="token operator">=</span><span class="token punctuation">{</span> handleClick2 <span class="token punctuation">}</span>  <span class="token operator">&gt;</span>点击<span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>如果上述点击按钮，触发点击事件，那么在 React 系统中，整个流程会是这个样子的：</p> <h3 id="第一步-批量更新"><a href="#第一步-批量更新" class="header-anchor">#</a> 第一步：批量更新</h3> <p>首先上面讲到执行 dispatchEvent ，dispatchEvent 执行会传入真实的事件源 button 元素本身。通过元素可以找到 button 对应的 fiber ，fiber 和原生 DOM 之间是如何建立起联系的呢？</p> <p>React 在初始化真实 DOM 的时候，用一个随机的 key internalInstanceKey 指针指向了当前 DOM 对应的 fiber 对象，fiber 对象用 stateNode 指向了当前的 DOM 元素。</p> <p><img src="/images/react/%E4%BA%8B%E4%BB%B6%E7%B3%BB%E7%BB%9F2.png" alt="事件系统2"></p> <p>接下来就是批量更新环节：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// react-dom/src/events/ReactDOMUpdateBatching.js</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">batchedEventUpdates</span><span class="token punctuation">(</span><span class="token parameter">fn<span class="token punctuation">,</span>a</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    isBatchingEventUpdates <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span> <span class="token comment">//打开批量更新开关</span>
    <span class="token keyword">try</span><span class="token punctuation">{</span>
       <span class="token function">fn</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span>  <span class="token comment">// 事件在这里执行</span>
    <span class="token punctuation">}</span><span class="token keyword">finally</span><span class="token punctuation">{</span>
        isBatchingEventUpdates <span class="token operator">=</span> <span class="token boolean">false</span> <span class="token comment">//关闭批量更新开关</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p><img src="/images/react/%E4%BA%8B%E4%BB%B6%E7%B3%BB%E7%BB%9F3.png" alt="事件系统3"></p> <h3 id="第二步-合成事件源"><a href="#第二步-合成事件源" class="header-anchor">#</a> 第二步：合成事件源</h3> <p>接下来会通过 onClick 找到对应的处理插件 SimpleEventPlugin ，合成新的事件源 e ，里面包含了 preventDefault 和 stopPropagation 等方法。</p> <p><img src="/images/react/%E4%BA%8B%E4%BB%B6%E7%B3%BB%E7%BB%9F4.png" alt="事件系统4"></p> <h3 id="第三步-形成事件执行队列"><a href="#第三步-形成事件执行队列" class="header-anchor">#</a> 第三步：形成事件执行队列</h3> <p>在第一步通过原生 DOM 获取到对应的 fiber ，接着会从这个 fiber 向上遍历，遇到元素类型 fiber ，就会收集事件，用一个数组收集事件：</p> <ul><li>如果遇到捕获阶段事件 onClickCapture ，就会 unshift 放在数组前面。以此模拟事件捕获阶段。</li> <li>如果遇到冒泡阶段事件 onClick ，就会 push 到数组后面，模拟事件冒泡阶段。</li> <li>一直收集到最顶端 app ，形成执行队列，在接下来阶段，依次执行队列里面的函数。</li></ul> <div class="language-js line-numbers-mode"><pre class="language-js"><code> <span class="token keyword">while</span> <span class="token punctuation">(</span>instance <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span>stateNode<span class="token punctuation">,</span> tag<span class="token punctuation">}</span> <span class="token operator">=</span> instance<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>tag <span class="token operator">===</span> HostComponent <span class="token operator">&amp;&amp;</span> stateNode <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">/* DOM 元素 */</span>
        <span class="token keyword">const</span> currentTarget <span class="token operator">=</span> stateNode<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>captured <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">/* 事件捕获 */</span>
            <span class="token comment">/* 在事件捕获阶段,真正的事件处理函数 */</span>
            <span class="token keyword">const</span> captureListener <span class="token operator">=</span> <span class="token function">getListener</span><span class="token punctuation">(</span>instance<span class="token punctuation">,</span> captured<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// onClickCapture</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>captureListener <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">/* 对应发生在事件捕获阶段的处理函数，逻辑是将执行函数unshift添加到队列的最前面 */</span>
                dispatchListeners<span class="token punctuation">.</span><span class="token function">unshift</span><span class="token punctuation">(</span>captureListener<span class="token punctuation">)</span><span class="token punctuation">;</span>
                
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>bubbled <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">/* 事件冒泡 */</span>
            <span class="token comment">/* 事件冒泡阶段，真正的事件处理函数，逻辑是将执行函数push到执行队列的最后面 */</span>
            <span class="token keyword">const</span> bubbleListener <span class="token operator">=</span> <span class="token function">getListener</span><span class="token punctuation">(</span>instance<span class="token punctuation">,</span> bubbled<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// </span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>bubbleListener <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                dispatchListeners<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>bubbleListener<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// onClick</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    instance <span class="token operator">=</span> instance<span class="token punctuation">.</span>return<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><p>那么如上点击一次按钮，4个事件执行顺序是这样的：</p> <ul><li>首先第一次收集是在 button 上，handleClick1 冒泡事件 push 处理，handleClick2 捕获事件 unshift 处理。形成结构 [ handleClick2 , handleClick1 ]</li> <li>然后接着向上收集，遇到父级，收集父级 div 上的事件，handleClick3 冒泡事件 push 处理，handleClick4 捕获事件 unshift 处理。[handleClick4, handleClick2 , handleClick1,handleClick3 ]</li> <li>依次执行数组里面的事件，所以打印 4 2 1 3。</li></ul> <p><img src="/images/react/%E4%BA%8B%E4%BB%B6%E7%B3%BB%E7%BB%9F5.png" alt="事件系统5"></p> <h2 id="阻止事件冒泡"><a href="#阻止事件冒泡" class="header-anchor">#</a> 阻止事件冒泡</h2> <p>那么 React 是如何阻止事件冒泡的呢。来看一下事件队列是怎么执行的。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// legacy-events/EventBatching.js</span>
<span class="token keyword">function</span> <span class="token function">runEventsInBatch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">const</span> dispatchListeners <span class="token operator">=</span> event<span class="token punctuation">.</span>_dispatchListeners<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>dispatchListeners<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> dispatchListeners<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>event<span class="token punctuation">.</span><span class="token function">isPropagationStopped</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">/* 判断是否已经阻止事件冒泡 */</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>    
      dispatchListeners<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span> <span class="token comment">/* 执行真正的处理函数 及handleClick1... */</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>对于上述队列 <code>[handleClick4, handleClick2 , handleClick1, handleClick3 ]</code></p> <p>假设在上述队列中，<code>handleClick2</code> 中调用 <code>e.stopPropagation()</code>，那么事件源里将有状态证明此次事件已经停止冒泡，那么下次遍历的时候， <code>event.isPropagationStopped()</code>就会返回 true ，所以跳出循环，<code>handleClick1</code>, <code>handleClick3</code> 将不再执行，模拟了阻止事件冒泡的过程。</p> <h2 id="v18-事件系统"><a href="#v18-事件系统" class="header-anchor">#</a> V18 事件系统 <span class="badge tip" style="vertical-align:top;" data-v-15b7b770>v18</span></h2> <h3 id="背景"><a href="#背景" class="header-anchor">#</a> 背景</h3> <p>在上几节中，我们讲到了老版本的事件原理，老版本的事件原理有一个问题就是，捕获阶段和冒泡阶段的事件都是模拟的，本质上都是在冒泡阶段执行的，比如如下例子中：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">Index</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">const</span> refObj <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">useRef</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span>
    <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
        <span class="token keyword">const</span> <span class="token function-variable function">handler</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'事件监听'</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        refObj<span class="token punctuation">.</span>current<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">,</span>handler<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            refObj<span class="token punctuation">.</span>current<span class="token punctuation">.</span><span class="token function">removeEventListener</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">,</span>handler<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> <span class="token function-variable function">handleClick</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
       console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'冒泡阶段执行'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">const</span> <span class="token function-variable function">handleCaptureClick</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
       console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'捕获阶段执行'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span>  <span class="token operator">&lt;</span>button ref<span class="token operator">=</span><span class="token punctuation">{</span>refObj<span class="token punctuation">}</span> onClick<span class="token operator">=</span><span class="token punctuation">{</span>handleClick<span class="token punctuation">}</span> onClickCapture<span class="token operator">=</span><span class="token punctuation">{</span>handleCaptureClick<span class="token punctuation">}</span> <span class="token operator">&gt;</span>点击<span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">&gt;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p>如上通过 onClick，onClickCapture 和原生的 DOM 监听器给元素 button 绑定了三个事件处理函数，那么当触发一次点击事件的时候，处理函数的执行，老版本打印顺序为：</p> <p>老版本事件系统：<code>事件监听 -&gt; 捕获阶段执行 -&gt; 冒泡阶段执行</code></p> <p>但是老版本的事件系统，一定程度上，不符合事件流的执行时机，但是在新版本 v18 的事件系统中，这个问题得以解决。</p> <p>新版本事件系统：<code>捕获阶段执行 -&gt; 事件监听 -&gt; 冒泡阶段执行</code></p> <h3 id="事件绑定-事件初始化"><a href="#事件绑定-事件初始化" class="header-anchor">#</a> 事件绑定 —— 事件初始化</h3> <p>在 React 新版的事件系统中，在 createRoot 会一口气向外层容器上注册完全部事件:</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// react-dom/client.js</span>
<span class="token keyword">function</span> <span class="token function">createRoot</span><span class="token punctuation">(</span><span class="token parameter">container<span class="token punctuation">,</span> options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">/* 省去和事件无关的代码，通过如下方法注册事件 */</span>
    <span class="token function">listenToAllSupportedEvents</span><span class="token punctuation">(</span>rootContainerElement<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>在 createRoot 中，通过 listenToAllSupportedEvents 注册事件:</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// react-dom/src/events/DOMPluginEventSystem.js</span>
<span class="token keyword">function</span> <span class="token function">listenToAllSupportedEvents</span><span class="token punctuation">(</span><span class="token parameter">rootContainerElement</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">/* allNativeEvents 是一个 set 集合，保存了大多数的浏览器事件 */</span>
    allNativeEvents<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">domEventName</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>domEventName <span class="token operator">!==</span> <span class="token string">'selectionchange'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token comment">/* nonDelegatedEvents 保存了 js 中，不冒泡的事件 */</span> 
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>nonDelegatedEvents<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>domEventName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">/* 在冒泡阶段绑定事件 */</span> 
          <span class="token function">listenToNativeEvent</span><span class="token punctuation">(</span>domEventName<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> rootContainerElement<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">/* 在捕获阶段绑定事件 */</span>
        <span class="token function">listenToNativeEvent</span><span class="token punctuation">(</span>domEventName<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> rootContainerElement<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p><code>listenToAllSupportedEvents</code> 这个方法比较核心，主要目的就是通过 <code>listenToNativeEvent</code> 绑定浏览器事件，这里引出了两个常量，<code>allNativeEvents</code> 和 <code>nonDelegatedEvents</code> ，它们分别代表的意思如下：</p> <ul><li>allNativeEvents：allNativeEvents 是一个 set 集合，保存了 81 个浏览器常用事件。</li> <li>nonDelegatedEvents ：这个也是一个集合，保存了浏览器中不会冒泡的事件，一般指的是媒体事件，比如 pause，play，playing 等，还有一些特殊事件，比如 cancel ，close，invalid，load，scroll 。</li></ul> <p>接下来如果事件是不冒泡的，那么会执行一次，<code>listenToNativeEvent</code>，第二个参数为 true 。 如果是常规的事件，那么会执行两次 <code>listenToNativeEvent</code>，分别在冒泡和捕获阶段绑定事件。那么 listenToNativeEvent 就是事件监听，这个函数这里给它精简化，listenToNativeEvent 主要逻辑如下:</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> listener <span class="token operator">=</span> <span class="token function">dispatchEvent</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span>domEventName<span class="token punctuation">,</span><span class="token operator">...</span><span class="token punctuation">)</span>
<span class="token keyword">if</span><span class="token punctuation">(</span>isCapturePhaseListener<span class="token punctuation">)</span><span class="token punctuation">{</span>
    target<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span>eventType<span class="token punctuation">,</span> dispatchEvent<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
    target<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span>eventType<span class="token punctuation">,</span> dispatchEvent<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p><code>isCapturePhaseListener</code> 就是 <code>listenToNativeEvent</code> 的第二个参数，target 为 DOM 对象。<code>dispatchEvent</code> 为统一的事件监听函数。</p> <p>如上可以看到 listenToNativeEvent 本质上就是向原生 DOM 中去注册事件，上面还有一个细节，就是 dispatchEvent 已经通过 bind 的方式将事件名称等信息保存下来了。经过这第一步，在初始化阶段，就已经注册了很多的事件监听器了。</p> <p>此时如果发生一次点击事件，就会触发两次 dispatchEvent ：</p> <ul><li>第一次捕获阶段的点击事件</li> <li>第二次冒泡阶段的点击事件</li></ul> <h3 id="事件触发-2"><a href="#事件触发-2" class="header-anchor">#</a> 事件触发</h3> <p>当触发一次点击事件，会发生什么，首先就是执行 dispatchEvent 事件，dispatchEvent 保留核心的代码如下：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token function">batchedUpdates</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">dispatchEventsForPlugins</span><span class="token punctuation">(</span>domEventName<span class="token punctuation">,</span> eventSystemFlags<span class="token punctuation">,</span> nativeEvent<span class="token punctuation">,</span> ancestorInst<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p><code>dispatchEvent</code> 如果是正常的事件，就会通过 <code>batchedUpdates</code> 来处理 <code>dispatchEventsForPlugins</code> ，<code>batchedUpdates</code> 是批量更新的逻辑，在之前的章节中已经讲到通过这种方式来让更新变成可控的。所有的矛头都指向了 <code>dispatchEventsForPlugins</code>:</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">dispatchEventsForPlugins</span><span class="token punctuation">(</span><span class="token parameter">domEventName<span class="token punctuation">,</span> eventSystemFlags<span class="token punctuation">,</span> nativeEvent<span class="token punctuation">,</span> targetInst<span class="token punctuation">,</span> targetContainer</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">/* 找到发生事件的元素——事件源 */</span>  
  <span class="token keyword">var</span> nativeEventTarget <span class="token operator">=</span> <span class="token function">getEventTarget</span><span class="token punctuation">(</span>nativeEvent<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">/* 待更新队列 */</span>
  <span class="token keyword">var</span> dispatchQueue <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token comment">/* 找到待执行的事件 */</span>
  <span class="token function">extractEvents</span><span class="token punctuation">(</span>dispatchQueue<span class="token punctuation">,</span> domEventName<span class="token punctuation">,</span> targetInst<span class="token punctuation">,</span> nativeEvent<span class="token punctuation">,</span> nativeEventTarget<span class="token punctuation">,</span> eventSystemFlags<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">/* 执行事件 */</span>
  <span class="token function">processDispatchQueue</span><span class="token punctuation">(</span>dispatchQueue<span class="token punctuation">,</span> eventSystemFlags<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>这个函数非常重要，首先通过 <code>getEventTarget</code> 找到发生事件的元素，也就是事件源。然后创建一个待更新的事件队列，接下来通过 <code>extractEvents</code> 找到待更新的事件，然后通过 <code>processDispatchQueue</code> 执行事件。</p> <p>先举一个例子如下：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">Index</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token function-variable function">handleClick</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
       console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'冒泡阶段执行'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">const</span> <span class="token function-variable function">handleCaptureClick</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
       console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'捕获阶段执行'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">const</span> <span class="token function-variable function">handleParentClick</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'div 点击事件'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span>  <span class="token operator">&lt;</span>div onClick<span class="token operator">=</span><span class="token punctuation">{</span>handleParentClick<span class="token punctuation">}</span> <span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{</span>handleClick<span class="token punctuation">}</span> onClickCapture<span class="token operator">=</span><span class="token punctuation">{</span>handleCaptureClick<span class="token punctuation">}</span> <span class="token operator">&gt;</span>点击<span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>如上的例子，有一个 div 和 button 均绑定了一个正常的点击事件 ，div 是 button 的父元素，除此之外 button 绑定了一个在捕获阶段执行的点击事件。当点击按钮，触发一次点击事件的时候，如果 nativeEventTarget 本质上就是发生点击事件的 button 对应的 DOM 元素。那么第一个问题就是 dispatchQueue 是什么？ extractEvents 有如何处理的 dispatchQueue。</p> <p>发生点击事件，通过上面我们知道，会触发两次 dispatchEvents，第一次是捕获阶段，第二次是冒泡阶段。</p> <p>产生一次事件就会向 dispatchQueue 放入一个对象，对象中有两个状态，一个是 event ，一个是 listeners。那么这两个东西是如何来的呢？</p> <p>event 是通过事件插件合成的事件源 event，在 React 事件系统中，事件源也不是原生的事件源，而是 React 自己创建的事件源对象。对于不同的事件类型，会创建不同的事件源对象。本质上是在 extractEvents 函数中，有这么一段处理逻辑：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code> <span class="token keyword">var</span> SyntheticEventCtor <span class="token operator">=</span> SyntheticEvent<span class="token punctuation">;</span>
 <span class="token comment">/* 针对不同的事件，处理不同的事件源 */</span>
 <span class="token keyword">switch</span> <span class="token punctuation">(</span>domEventName<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">case</span> <span class="token string">'keydown'</span><span class="token operator">:</span>
    <span class="token keyword">case</span> <span class="token string">'keyup'</span><span class="token operator">:</span>
      SyntheticEventCtor <span class="token operator">=</span> SyntheticKeyboardEvent<span class="token punctuation">;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> <span class="token string">'focusin'</span><span class="token operator">:</span>
      reactEventType <span class="token operator">=</span> <span class="token string">'focus'</span><span class="token punctuation">;</span>
      SyntheticEventCtor <span class="token operator">=</span> SyntheticFocusEvent<span class="token punctuation">;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token operator">...</span><span class="token punctuation">.</span>    
 <span class="token punctuation">}</span>
<span class="token comment">/* 找到事件监听者，也就是我们 onClick 绑定的事件处理函数 */</span> 
<span class="token keyword">var</span> _listeners <span class="token operator">=</span> <span class="token function">accumulateSinglePhaseListeners</span><span class="token punctuation">(</span>targetInst<span class="token punctuation">,</span> reactName<span class="token punctuation">,</span> nativeEvent<span class="token punctuation">.</span>type<span class="token punctuation">,</span> inCapturePhase<span class="token punctuation">,</span> accumulateTargetOnly<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">/* 向 dispatchQueue 添加 event 和 listeners  */</span>
<span class="token keyword">if</span><span class="token punctuation">(</span>_listeners<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">var</span> _event <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SyntheticEventCtor</span><span class="token punctuation">(</span>reactName<span class="token punctuation">,</span> reactEventType<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> nativeEvent<span class="token punctuation">,</span> nativeEventTarget<span class="token punctuation">)</span><span class="token punctuation">;</span>
    dispatchQueue<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        event<span class="token operator">:</span> _event<span class="token punctuation">,</span>
        listeners<span class="token operator">:</span> _listeners
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><p>如上可以看到，首先根据不同事件类型，选用不同的构造函数，通过 new 的方式去合成不同事件源对象。上面还有一个细节就是 _listeners 是什么？_listeners 本质上也是一个对象，里面有三个属性。</p> <ul><li>currentTarget：发生事件的 DOM 元素。</li> <li>instance ： button 对应的 fiber 元素。</li> <li>listener ：一个数组，存放绑定的事件处理函数本身，上面 demo 中就是绑定给 onClick，onClickCapture 的函数。</li></ul> <p>接下来可以通过 DOM 元素找到对应的 fiber，找到元素对应的 fiber 之后，也就能找到 props 事件了。但是这里有一个细节，就是 listener 可以有多个，比如如上捕获阶段的 listener 只有一个，而冒泡阶段的 listener 有两个，这是因为 div button 上都有 onClick 事件。</p> <p>当发生一次点击事件，React 会根据事件源对应的 fiber 对象，根据 return指针向上遍历，收集所有相同的事件，比如是 onClick，那就收集父级元素的所有 onClick 事件，比如是 onClickCapture，那就收集父级的所有 onClickCapture。</p> <p>得到了 dispatchQueue 之后，就需要 processDispatchQueue 执行事件了，这个函数的内部会经历两次遍历：</p> <ul><li>第一次遍历 dispatchQueue，通常情况下，只有一个事件类型，所有 dispatchQueue 中只有一个元素。</li> <li>接下来会遍历每一个元素的 listener，执行 listener 的时候有一个特点：</li></ul> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">/* 如果在捕获阶段执行。 */</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>inCapturePhase<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> dispatchListeners<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">var</span> _dispatchListeners$i <span class="token operator">=</span> dispatchListeners<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span>
          instance <span class="token operator">=</span> _dispatchListeners$i<span class="token punctuation">.</span>instance<span class="token punctuation">,</span>
          currentTarget <span class="token operator">=</span> _dispatchListeners$i<span class="token punctuation">.</span>currentTarget<span class="token punctuation">,</span>
          listener <span class="token operator">=</span> _dispatchListeners$i<span class="token punctuation">.</span>listener<span class="token punctuation">;</span>
     
      
      <span class="token keyword">if</span> <span class="token punctuation">(</span>instance <span class="token operator">!==</span> previousInstance <span class="token operator">&amp;&amp;</span> event<span class="token punctuation">.</span><span class="token function">isPropagationStopped</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      
      <span class="token comment">/* 执行事件 */</span>
      <span class="token function">executeDispatch</span><span class="token punctuation">(</span>event<span class="token punctuation">,</span> listener<span class="token punctuation">,</span> currentTarget<span class="token punctuation">)</span><span class="token punctuation">;</span>
      previousInstance <span class="token operator">=</span> instance<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> _i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> _i <span class="token operator">&lt;</span> dispatchListeners<span class="token punctuation">.</span>length<span class="token punctuation">;</span> _i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">var</span> _dispatchListeners$_i <span class="token operator">=</span> dispatchListeners<span class="token punctuation">[</span>_i<span class="token punctuation">]</span><span class="token punctuation">,</span>
          _instance <span class="token operator">=</span> _dispatchListeners$_i<span class="token punctuation">.</span>instance<span class="token punctuation">,</span>
          _currentTarget <span class="token operator">=</span> _dispatchListeners$_i<span class="token punctuation">.</span>currentTarget<span class="token punctuation">,</span>
          _listener <span class="token operator">=</span> _dispatchListeners$_i<span class="token punctuation">.</span>listener<span class="token punctuation">;</span>
      
      <span class="token keyword">if</span> <span class="token punctuation">(</span>_instance <span class="token operator">!==</span> previousInstance <span class="token operator">&amp;&amp;</span> event<span class="token punctuation">.</span><span class="token function">isPropagationStopped</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">/* 执行事件 */</span>
      <span class="token function">executeDispatch</span><span class="token punctuation">(</span>event<span class="token punctuation">,</span> _listener<span class="token punctuation">,</span> _currentTarget<span class="token punctuation">)</span><span class="token punctuation">;</span>
      previousInstance <span class="token operator">=</span> _instance<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br></div></div><p>如上在 executeDispatch 会负责执行事件处理函数，也就是上面的 handleClick ，handleParentClick 等。这个有一个区别就是，如果是捕获阶段执行的函数，那么 listener 数组中函数，会从后往前执行，如果是冒泡阶段执行的函数，会从前往后执行，用这个模拟出冒泡阶段先子后父，捕获阶段先父后子。</p> <p>还有一个细节就是如果触发了阻止冒泡事件，上述讲到事件源是 React 内部自己创建的，所以如果一个事件中执行了 e.stopPropagation ，那么事件源中就能感知得到，接下来就可以通过 event.isPropagationStopped 来判断是否阻止冒泡，如果组织，那么就会退出，这样就模拟了事件流的执行过程，以及阻止事件冒泡。</p> <h2 id="小结"><a href="#小结" class="header-anchor">#</a> 小结</h2> <p><img src="/images/react/%E4%BA%8B%E4%BB%B6%E7%B3%BB%E7%BB%9F6.png" alt="事件系统6"></p> <h2 id="问题"><a href="#问题" class="header-anchor">#</a> 问题</h2> <h3 id="q1-为什么要用不同的事件插件处理不同的-react-事件"><a href="#q1-为什么要用不同的事件插件处理不同的-react-事件" class="header-anchor">#</a> Q1. 为什么要用不同的事件插件处理不同的 React 事件?</h3> <p>首先对于不同的事件，有不同的处理逻辑；对应的事件源对象也有所不同，React 的事件和事件源是自己合成的，所以对于不同事件需要不同的事件插件处理。</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/blog/react/react/react-lifecycle.html" class="prev">
        React 生命周期
      </a></span> <!----></p></div> </main></div><div class="global-ui"><!----><!----><!----><!----></div></div>
    <script src="/blog/assets/js/app.382adc38.js" defer></script><script src="/blog/assets/js/2.8bf77cff.js" defer></script><script src="/blog/assets/js/90.80fd91f4.js" defer></script><script src="/blog/assets/js/5.8fc7a0b0.js" defer></script><script src="/blog/assets/js/4.ff6074e9.js" defer></script>
  </body>
</html>
