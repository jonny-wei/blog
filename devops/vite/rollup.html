<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Rollup 打包 | 前端那些事儿</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="icon" href="/blog/logo.png">
    <link rel="manifest" href="/blog/manifest.json">
    <link rel="apple-touch-icon" href="/blog/images/icons/apple-icon-152x152.png">
    <meta name="description" content="我命由我不由天，学习吧少年">
    <meta name="theme-color" content="#3eaf7c">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="msapplication-TileImage" content="/icons/ms-icon-144x144.png">
    <meta name="msapplication-TileColor" content="#000000">
    
    <link rel="preload" href="/blog/assets/css/0.styles.1c8ccece.css" as="style"><link rel="preload" href="/blog/assets/js/app.7addad61.js" as="script"><link rel="preload" href="/blog/assets/js/2.8bf77cff.js" as="script"><link rel="preload" href="/blog/assets/js/87.b5684eee.js" as="script"><link rel="preload" href="/blog/assets/js/4.ff6074e9.js" as="script"><link rel="prefetch" href="/blog/assets/js/10.a09e5ce0.js"><link rel="prefetch" href="/blog/assets/js/100.fdb06d7a.js"><link rel="prefetch" href="/blog/assets/js/101.2ecb29f9.js"><link rel="prefetch" href="/blog/assets/js/102.12f90002.js"><link rel="prefetch" href="/blog/assets/js/103.8dbca0be.js"><link rel="prefetch" href="/blog/assets/js/104.77a412cc.js"><link rel="prefetch" href="/blog/assets/js/105.5188937d.js"><link rel="prefetch" href="/blog/assets/js/106.ccaa117e.js"><link rel="prefetch" href="/blog/assets/js/107.b31c1965.js"><link rel="prefetch" href="/blog/assets/js/108.e86992b6.js"><link rel="prefetch" href="/blog/assets/js/109.a6efa443.js"><link rel="prefetch" href="/blog/assets/js/11.a397ecc9.js"><link rel="prefetch" href="/blog/assets/js/110.981b210b.js"><link rel="prefetch" href="/blog/assets/js/111.1739110b.js"><link rel="prefetch" href="/blog/assets/js/112.e8bbcacf.js"><link rel="prefetch" href="/blog/assets/js/113.8bcc2263.js"><link rel="prefetch" href="/blog/assets/js/114.9f6740c3.js"><link rel="prefetch" href="/blog/assets/js/115.27d4705a.js"><link rel="prefetch" href="/blog/assets/js/116.325c74dc.js"><link rel="prefetch" href="/blog/assets/js/117.d1f7b198.js"><link rel="prefetch" href="/blog/assets/js/118.4016cdf2.js"><link rel="prefetch" href="/blog/assets/js/119.b803778e.js"><link rel="prefetch" href="/blog/assets/js/12.755ca593.js"><link rel="prefetch" href="/blog/assets/js/120.dad17fa6.js"><link rel="prefetch" href="/blog/assets/js/121.9564c76e.js"><link rel="prefetch" href="/blog/assets/js/122.2d89d0bb.js"><link rel="prefetch" href="/blog/assets/js/123.6ea767d8.js"><link rel="prefetch" href="/blog/assets/js/124.71aebebd.js"><link rel="prefetch" href="/blog/assets/js/125.68c37a39.js"><link rel="prefetch" href="/blog/assets/js/126.d245e6df.js"><link rel="prefetch" href="/blog/assets/js/127.88c22f9c.js"><link rel="prefetch" href="/blog/assets/js/128.466aa034.js"><link rel="prefetch" href="/blog/assets/js/129.d3e9f656.js"><link rel="prefetch" href="/blog/assets/js/13.d57293ef.js"><link rel="prefetch" href="/blog/assets/js/130.8d0afd20.js"><link rel="prefetch" href="/blog/assets/js/131.3617498d.js"><link rel="prefetch" href="/blog/assets/js/132.4feb4448.js"><link rel="prefetch" href="/blog/assets/js/133.61a51cb8.js"><link rel="prefetch" href="/blog/assets/js/134.9ad5668b.js"><link rel="prefetch" href="/blog/assets/js/135.56af067e.js"><link rel="prefetch" href="/blog/assets/js/136.f51ee05f.js"><link rel="prefetch" href="/blog/assets/js/137.b893633d.js"><link rel="prefetch" href="/blog/assets/js/138.e45edb3f.js"><link rel="prefetch" href="/blog/assets/js/139.7937142a.js"><link rel="prefetch" href="/blog/assets/js/14.f411e934.js"><link rel="prefetch" href="/blog/assets/js/140.6705b88d.js"><link rel="prefetch" href="/blog/assets/js/141.8fa621ff.js"><link rel="prefetch" href="/blog/assets/js/142.ef8686d8.js"><link rel="prefetch" href="/blog/assets/js/143.9d1fafdc.js"><link rel="prefetch" href="/blog/assets/js/144.a093fae5.js"><link rel="prefetch" href="/blog/assets/js/145.e987fb25.js"><link rel="prefetch" href="/blog/assets/js/146.68f96a2f.js"><link rel="prefetch" href="/blog/assets/js/147.2e09ddda.js"><link rel="prefetch" href="/blog/assets/js/148.a0d5fe0a.js"><link rel="prefetch" href="/blog/assets/js/149.7c020cb0.js"><link rel="prefetch" href="/blog/assets/js/15.9c15f645.js"><link rel="prefetch" href="/blog/assets/js/150.c3981405.js"><link rel="prefetch" href="/blog/assets/js/151.ac3c8f3d.js"><link rel="prefetch" href="/blog/assets/js/152.0b4a7100.js"><link rel="prefetch" href="/blog/assets/js/153.1be383a2.js"><link rel="prefetch" href="/blog/assets/js/154.1467aae1.js"><link rel="prefetch" href="/blog/assets/js/155.ca1b9506.js"><link rel="prefetch" href="/blog/assets/js/156.cfc433c8.js"><link rel="prefetch" href="/blog/assets/js/157.c8d210cc.js"><link rel="prefetch" href="/blog/assets/js/158.7c111193.js"><link rel="prefetch" href="/blog/assets/js/159.c63f7b68.js"><link rel="prefetch" href="/blog/assets/js/16.9f550045.js"><link rel="prefetch" href="/blog/assets/js/160.e1979eb0.js"><link rel="prefetch" href="/blog/assets/js/161.f7cf10bb.js"><link rel="prefetch" href="/blog/assets/js/162.49e6db2a.js"><link rel="prefetch" href="/blog/assets/js/163.107f8ca7.js"><link rel="prefetch" href="/blog/assets/js/164.9915a2d5.js"><link rel="prefetch" href="/blog/assets/js/165.586a6e9a.js"><link rel="prefetch" href="/blog/assets/js/166.23be60a1.js"><link rel="prefetch" href="/blog/assets/js/167.683a3bbe.js"><link rel="prefetch" href="/blog/assets/js/168.1924c48a.js"><link rel="prefetch" href="/blog/assets/js/169.5a7d509f.js"><link rel="prefetch" href="/blog/assets/js/17.19060e6e.js"><link rel="prefetch" href="/blog/assets/js/170.85b1b609.js"><link rel="prefetch" href="/blog/assets/js/171.77364db1.js"><link rel="prefetch" href="/blog/assets/js/172.e1bb724d.js"><link rel="prefetch" href="/blog/assets/js/173.2c883436.js"><link rel="prefetch" href="/blog/assets/js/174.79efb98b.js"><link rel="prefetch" href="/blog/assets/js/175.cd6bc58f.js"><link rel="prefetch" href="/blog/assets/js/176.8ba34185.js"><link rel="prefetch" href="/blog/assets/js/177.b8c83189.js"><link rel="prefetch" href="/blog/assets/js/178.6ed760cd.js"><link rel="prefetch" href="/blog/assets/js/179.d6169f6c.js"><link rel="prefetch" href="/blog/assets/js/18.900fbea6.js"><link rel="prefetch" href="/blog/assets/js/180.79f8a8a6.js"><link rel="prefetch" href="/blog/assets/js/181.05a1ff58.js"><link rel="prefetch" href="/blog/assets/js/182.5d197998.js"><link rel="prefetch" href="/blog/assets/js/183.90ab4de7.js"><link rel="prefetch" href="/blog/assets/js/184.2df18168.js"><link rel="prefetch" href="/blog/assets/js/19.cde4fd51.js"><link rel="prefetch" href="/blog/assets/js/20.1f157ccc.js"><link rel="prefetch" href="/blog/assets/js/21.33723470.js"><link rel="prefetch" href="/blog/assets/js/22.bb5e5226.js"><link rel="prefetch" href="/blog/assets/js/23.780a4b5c.js"><link rel="prefetch" href="/blog/assets/js/24.d530e1ef.js"><link rel="prefetch" href="/blog/assets/js/25.cde12e95.js"><link rel="prefetch" href="/blog/assets/js/26.9dfa5035.js"><link rel="prefetch" href="/blog/assets/js/27.6dd809ae.js"><link rel="prefetch" href="/blog/assets/js/28.e74a93ce.js"><link rel="prefetch" href="/blog/assets/js/29.65fb9b36.js"><link rel="prefetch" href="/blog/assets/js/3.6c93b5c9.js"><link rel="prefetch" href="/blog/assets/js/30.1dfd6b11.js"><link rel="prefetch" href="/blog/assets/js/31.9aaedbe9.js"><link rel="prefetch" href="/blog/assets/js/32.0fc56b09.js"><link rel="prefetch" href="/blog/assets/js/33.346738a5.js"><link rel="prefetch" href="/blog/assets/js/34.16e2861f.js"><link rel="prefetch" href="/blog/assets/js/35.63a02487.js"><link rel="prefetch" href="/blog/assets/js/36.b403dafe.js"><link rel="prefetch" href="/blog/assets/js/37.c910b090.js"><link rel="prefetch" href="/blog/assets/js/38.6acffc56.js"><link rel="prefetch" href="/blog/assets/js/39.e912870f.js"><link rel="prefetch" href="/blog/assets/js/40.13d4fa86.js"><link rel="prefetch" href="/blog/assets/js/41.31c2ac75.js"><link rel="prefetch" href="/blog/assets/js/42.e74ac801.js"><link rel="prefetch" href="/blog/assets/js/43.1e0d84e6.js"><link rel="prefetch" href="/blog/assets/js/44.1d223ded.js"><link rel="prefetch" href="/blog/assets/js/45.e4e851a3.js"><link rel="prefetch" href="/blog/assets/js/46.fa87da0d.js"><link rel="prefetch" href="/blog/assets/js/47.0e064cd9.js"><link rel="prefetch" href="/blog/assets/js/48.c9333944.js"><link rel="prefetch" href="/blog/assets/js/49.96430641.js"><link rel="prefetch" href="/blog/assets/js/5.43999584.js"><link rel="prefetch" href="/blog/assets/js/50.7ca3a37d.js"><link rel="prefetch" href="/blog/assets/js/51.f4eb6fe0.js"><link rel="prefetch" href="/blog/assets/js/52.7c9856ad.js"><link rel="prefetch" href="/blog/assets/js/53.2c3f6763.js"><link rel="prefetch" href="/blog/assets/js/54.de38c7b0.js"><link rel="prefetch" href="/blog/assets/js/55.5c29b694.js"><link rel="prefetch" href="/blog/assets/js/56.16b39cf4.js"><link rel="prefetch" href="/blog/assets/js/57.2eab0d79.js"><link rel="prefetch" href="/blog/assets/js/58.b0be9b9f.js"><link rel="prefetch" href="/blog/assets/js/59.2a0384a1.js"><link rel="prefetch" href="/blog/assets/js/6.539ab69c.js"><link rel="prefetch" href="/blog/assets/js/60.8de67cc1.js"><link rel="prefetch" href="/blog/assets/js/61.0888d3d5.js"><link rel="prefetch" href="/blog/assets/js/62.ac809286.js"><link rel="prefetch" href="/blog/assets/js/63.1f371405.js"><link rel="prefetch" href="/blog/assets/js/64.36acf479.js"><link rel="prefetch" href="/blog/assets/js/65.69b716ea.js"><link rel="prefetch" href="/blog/assets/js/66.84f1ef02.js"><link rel="prefetch" href="/blog/assets/js/67.3b488dfe.js"><link rel="prefetch" href="/blog/assets/js/68.46b1651d.js"><link rel="prefetch" href="/blog/assets/js/69.c10aa0bc.js"><link rel="prefetch" href="/blog/assets/js/7.c55f6e83.js"><link rel="prefetch" href="/blog/assets/js/70.182dbf33.js"><link rel="prefetch" href="/blog/assets/js/71.06c7ab0c.js"><link rel="prefetch" href="/blog/assets/js/72.90f4505a.js"><link rel="prefetch" href="/blog/assets/js/73.29297dc1.js"><link rel="prefetch" href="/blog/assets/js/74.ca3deb61.js"><link rel="prefetch" href="/blog/assets/js/75.f1b52d2e.js"><link rel="prefetch" href="/blog/assets/js/76.306a2cd1.js"><link rel="prefetch" href="/blog/assets/js/77.3a9c7c83.js"><link rel="prefetch" href="/blog/assets/js/78.0fa8468f.js"><link rel="prefetch" href="/blog/assets/js/79.00b9d3da.js"><link rel="prefetch" href="/blog/assets/js/8.60aa9c8a.js"><link rel="prefetch" href="/blog/assets/js/80.b4466696.js"><link rel="prefetch" href="/blog/assets/js/81.d5fd9b7e.js"><link rel="prefetch" href="/blog/assets/js/82.e92c728c.js"><link rel="prefetch" href="/blog/assets/js/83.cb8ecaaa.js"><link rel="prefetch" href="/blog/assets/js/84.ddb8e755.js"><link rel="prefetch" href="/blog/assets/js/85.967df080.js"><link rel="prefetch" href="/blog/assets/js/86.4561dd98.js"><link rel="prefetch" href="/blog/assets/js/88.8051fea2.js"><link rel="prefetch" href="/blog/assets/js/89.04bcab6b.js"><link rel="prefetch" href="/blog/assets/js/9.9ae7697d.js"><link rel="prefetch" href="/blog/assets/js/90.122922c6.js"><link rel="prefetch" href="/blog/assets/js/91.146ad202.js"><link rel="prefetch" href="/blog/assets/js/92.da270216.js"><link rel="prefetch" href="/blog/assets/js/93.6eccacb2.js"><link rel="prefetch" href="/blog/assets/js/94.5cbff1b6.js"><link rel="prefetch" href="/blog/assets/js/95.c56eb679.js"><link rel="prefetch" href="/blog/assets/js/96.a78bbfc1.js"><link rel="prefetch" href="/blog/assets/js/97.ac9bdd59.js"><link rel="prefetch" href="/blog/assets/js/98.e88ee46f.js"><link rel="prefetch" href="/blog/assets/js/99.5ac721c4.js">
    <link rel="stylesheet" href="/blog/assets/css/0.styles.1c8ccece.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/blog/" class="home-link router-link-active"><img src="/blog/logo.png" alt="前端那些事儿" class="logo"> <span class="site-name can-hide">前端那些事儿</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/blog/" class="nav-link">
  主页
</a></div><div class="nav-item"><a href="/blog/base/" class="nav-link">
  前端基础
</a></div><div class="nav-item"><a href="/blog/vue/" class="nav-link">
  Vue
</a></div><div class="nav-item"><a href="/blog/react/" class="nav-link">
  React
</a></div><div class="nav-item"><a href="/blog/node/" class="nav-link">
  Node
</a></div><div class="nav-item"><a href="/blog/devops/" class="nav-link router-link-active">
  前端工程化
</a></div><div class="nav-item"><a href="/blog/mobile/" class="nav-link">
  泛客户端
</a></div><div class="nav-item"><a href="/blog/architecture/" class="nav-link">
  架构&amp;方案
</a></div><div class="nav-item"><a href="/blog/code/" class="nav-link">
  算法&amp;编程
</a></div><div class="nav-item"><a href="/blog/weekly/" class="nav-link">
  前端周刊
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="GitHub" class="dropdown-title"><span class="title">GitHub</span> <span class="arrow down"></span></button> <button type="button" aria-label="GitHub" class="mobile-dropdown-title"><span class="title">GitHub</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/jonny-wei" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://github.com/jonny-wei/sushi-js" target="_blank" rel="noopener noreferrer" class="nav-link external">
  JS 寿司
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/blog/" class="nav-link">
  主页
</a></div><div class="nav-item"><a href="/blog/base/" class="nav-link">
  前端基础
</a></div><div class="nav-item"><a href="/blog/vue/" class="nav-link">
  Vue
</a></div><div class="nav-item"><a href="/blog/react/" class="nav-link">
  React
</a></div><div class="nav-item"><a href="/blog/node/" class="nav-link">
  Node
</a></div><div class="nav-item"><a href="/blog/devops/" class="nav-link router-link-active">
  前端工程化
</a></div><div class="nav-item"><a href="/blog/mobile/" class="nav-link">
  泛客户端
</a></div><div class="nav-item"><a href="/blog/architecture/" class="nav-link">
  架构&amp;方案
</a></div><div class="nav-item"><a href="/blog/code/" class="nav-link">
  算法&amp;编程
</a></div><div class="nav-item"><a href="/blog/weekly/" class="nav-link">
  前端周刊
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="GitHub" class="dropdown-title"><span class="title">GitHub</span> <span class="arrow down"></span></button> <button type="button" aria-label="GitHub" class="mobile-dropdown-title"><span class="title">GitHub</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/jonny-wei" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://github.com/jonny-wei/sushi-js" target="_blank" rel="noopener noreferrer" class="nav-link external">
  JS 寿司
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Webpack</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/devops/" aria-current="page" class="sidebar-link">Webpack 常用配置</a></li><li><a href="/blog/devops/webpack/building.html" class="sidebar-link">构建流程与原理</a></li><li><a href="/blog/devops/webpack/dependency-graph.html" class="sidebar-link">模块依赖关系</a></li><li><a href="/blog/devops/webpack/chunk.html" class="sidebar-link">产物打包逻辑</a></li><li><a href="/blog/devops/webpack/compile.html" class="sidebar-link">模块编译及运行时</a></li><li><a href="/blog/devops/webpack/hmr.html" class="sidebar-link">HMR 热更新</a></li><li><a href="/blog/devops/webpack/loader.html" class="sidebar-link">Webpack Loader</a></li><li><a href="/blog/devops/webpack/plugin.html" class="sidebar-link">Webpack Plugin</a></li><li><a href="/blog/devops/webpack/module-federation.html" class="sidebar-link">模块联邦</a></li><li><a href="/blog/devops/webpack/cache.html" class="sidebar-link">持久化缓存</a></li><li><a href="/blog/devops/webpack/parallel.html" class="sidebar-link">并行构建</a></li><li><a href="/blog/devops/webpack/split-chunks.html" class="sidebar-link">分包策略</a></li><li><a href="/blog/devops/webpack/compress.html" class="sidebar-link">代码压缩</a></li><li><a href="/blog/devops/webpack/tree-shaking.html" class="sidebar-link">Tree Shaking</a></li><li><a href="/blog/devops/webpack/others.html" class="sidebar-link">Webpack 相关</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Vite</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/devops/vite/esm.html" class="sidebar-link">模块化规范</a></li><li><a href="/blog/devops/vite/css.html" class="sidebar-link">CSS 工程化</a></li><li><a href="/blog/devops/vite/prebuild.html" class="sidebar-link">依赖预构建</a></li><li><a href="/blog/devops/vite/engines.html" class="sidebar-link">双引擎架构</a></li><li><a href="/blog/devops/vite/rollup.html" aria-current="page" class="active sidebar-link">Rollup 打包</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/devops/vite/rollup.html#常用配置" class="sidebar-link">常用配置</a></li><li class="sidebar-sub-header"><a href="/blog/devops/vite/rollup.html#javascript-api-方式调用" class="sidebar-link">JavaScript API 方式调用</a></li><li class="sidebar-sub-header"><a href="/blog/devops/vite/rollup.html#插件机制" class="sidebar-link">插件机制</a></li><li class="sidebar-sub-header"><a href="/blog/devops/vite/rollup.html#插件开发" class="sidebar-link">插件开发</a></li></ul></li><li><a href="/blog/devops/vite/building.html" class="sidebar-link">Vite 构建原理</a></li><li><a href="/blog/devops/vite/plugin.html" class="sidebar-link">Vite Plugin</a></li><li><a href="/blog/devops/vite/hmr.html" class="sidebar-link">Vite HMR 热更新</a></li><li><a href="/blog/devops/vite/ssr.html" class="sidebar-link">SSR 工程化</a></li><li><a href="/blog/devops/vite/legacy.html" class="sidebar-link">兼容性问题</a></li><li><a href="/blog/devops/vite/split-code.html" class="sidebar-link">代码分割</a></li><li><a href="/blog/devops/vite/vite-news.html" class="sidebar-link">Vite 新特性</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>性能优化</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/devops/performance/indicator.html" class="sidebar-link">性能指标与采集</a></li><li><a href="/blog/devops/performance/webpack.html" class="sidebar-link">打包方面优化</a></li><li><a href="/blog/devops/performance/network.html" class="sidebar-link">网络方面优化</a></li><li><a href="/blog/devops/performance/render.html" class="sidebar-link">渲染方面优化</a></li><li><a href="/blog/devops/performance/code.html" class="sidebar-link">代码方面优化</a></li><li><a href="/blog/devops/performance/analysis.html" class="sidebar-link">打包性能分析工具</a></li><li><a href="/blog/devops/performance/optimization.html" class="sidebar-link">指标性能优化</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>代码与包管理</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/devops/git/git.html" class="sidebar-link">Git</a></li><li><a href="/blog/devops/git/package.html" class="sidebar-link">认识 package.json</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="rollup-打包"><a href="#rollup-打包" class="header-anchor">#</a> Rollup 打包</h1> <p>Rollup 是一款基于 ES Module 模块规范实现的 JavaScript 打包工具，在前端社区中赫赫有名，同时也在 Vite 的架构体系中发挥着重要作用。不仅是 Vite 生产环境下的打包工具，其插件机制也被 Vite 所兼容，可以说是 Vite 的构建基石。</p> <h2 id="常用配置"><a href="#常用配置" class="header-anchor">#</a> 常用配置</h2> <h3 id="多产物配置"><a href="#多产物配置" class="header-anchor">#</a> 多产物配置</h3> <p>在打包 JavaScript 类库的场景中，我们通常需要对外暴露出不同格式的产物供他人使用，不仅包括 ESM，也需要包括诸如CommonJS、UMD等格式，保证良好的兼容性。那么，同一份入口文件，如何让 Rollup 给我们打包出不一样格式的产物呢？</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// rollup.config.js</span>
<span class="token comment">/**
 * @type { import('rollup').RollupOptions }
 */</span>
<span class="token keyword">const</span> buildOptions <span class="token operator">=</span> <span class="token punctuation">{</span>
  input<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;src/index.js&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token comment">// 将 output 改造成一个数组</span>
  output<span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      dir<span class="token operator">:</span> <span class="token string">&quot;dist/es&quot;</span><span class="token punctuation">,</span>
      format<span class="token operator">:</span> <span class="token string">&quot;esm&quot;</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      dir<span class="token operator">:</span> <span class="token string">&quot;dist/cjs&quot;</span><span class="token punctuation">,</span>
      format<span class="token operator">:</span> <span class="token string">&quot;cjs&quot;</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> buildOptions<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><h3 id="多入口配置"><a href="#多入口配置" class="header-anchor">#</a> 多入口配置</h3> <p>除了多产物配置，Rollup 中也支持多入口配置，将 input 设置为一个数组或者一个对象：</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token punctuation">{</span>
  input<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;src/index.js&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;src/util.js&quot;</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>
<span class="token comment">// 或者</span>
<span class="token punctuation">{</span>
  input<span class="token operator">:</span> <span class="token punctuation">{</span>
    index<span class="token operator">:</span> <span class="token string">&quot;src/index.js&quot;</span><span class="token punctuation">,</span>
    util<span class="token operator">:</span> <span class="token string">&quot;src/util.js&quot;</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><h3 id="自定义output配置"><a href="#自定义output配置" class="header-anchor">#</a> 自定义output配置</h3> <p>input的使用，主要用来声明入口，可以配置成字符串、数组或者对象，使用比较简单。而output与之相对，用来配置输出的相关信息，常用的配置项如下:</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code>output<span class="token operator">:</span> <span class="token punctuation">{</span>
  <span class="token comment">// 产物输出目录</span>
  dir<span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'dist'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token comment">// 以下三个配置项都可以使用这些占位符:</span>
  <span class="token comment">// 1. [name]: 去除文件后缀后的文件名</span>
  <span class="token comment">// 2. [hash]: 根据文件名和文件内容生成的 hash 值</span>
  <span class="token comment">// 3. [format]: 产物模块格式，如 es、cjs</span>
  <span class="token comment">// 4. [extname]: 产物后缀名(带`.`)</span>
  <span class="token comment">// 入口模块的输出文件名</span>
  entryFileNames<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">[name].js</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
  <span class="token comment">// 非入口模块(如动态 import)的输出文件名</span>
  chunkFileNames<span class="token operator">:</span> <span class="token string">'chunk-[hash].js'</span><span class="token punctuation">,</span>
  <span class="token comment">// 静态资源文件输出文件名</span>
  assetFileNames<span class="token operator">:</span> <span class="token string">'assets/[name]-[hash][extname]'</span><span class="token punctuation">,</span>
  <span class="token comment">// 产物输出格式，包括`amd`、`cjs`、`es`、`iife`、`umd`、`system`</span>
  format<span class="token operator">:</span> <span class="token string">'cjs'</span><span class="token punctuation">,</span>
  <span class="token comment">// 是否生成 sourcemap 文件</span>
  sourcemap<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token comment">// 如果是打包出 iife/umd 格式，需要对外暴露出一个全局变量，通过 name 配置变量名</span>
  name<span class="token operator">:</span> <span class="token string">'MyBundle'</span><span class="token punctuation">,</span>
  <span class="token comment">// 全局变量声明</span>
  globals<span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token comment">// 项目中可以直接用`$`代替`jquery`</span>
    jquery<span class="token operator">:</span> <span class="token string">'$'</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><h3 id="依赖-external"><a href="#依赖-external" class="header-anchor">#</a> 依赖 external</h3> <p>对于某些第三方包，有时候我们不想让 Rollup 进行打包，也可以通过 external 进行外部化:</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token punctuation">{</span>
  external<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'react'</span><span class="token punctuation">,</span> <span class="token string">'react-dom'</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>在 SSR 构建或者使用 ESM CDN 的场景中，这个配置将非常有用。</p> <h3 id="接入插件能力"><a href="#接入插件能力" class="header-anchor">#</a> 接入插件能力</h3> <p>在 Rollup 的日常使用中，我们难免会遇到一些 Rollup 本身不支持的场景，比如兼容 CommonJS 打包、注入环境变量、配置路径别名、压缩产物代码 等等。这个时候就需要我们引入相应的 Rollup 插件了。</p> <p>虽然 Rollup 能够打包输出出 CommonJS 格式的产物，但对于输入给 Rollup 的代码并不支持 CommonJS，仅仅支持 ESM。但目前为止，还是有不少第三方依赖只有 CommonJS 格式产物而并未提供 ESM 产物。因此，我们需要引入额外的插件去解决这个问题。</p> <p>首先需要安装两个核心的插件包:</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code>pnpm i @rollup<span class="token operator">/</span>plugin<span class="token operator">-</span>node<span class="token operator">-</span>resolve @rollup<span class="token operator">/</span>plugin<span class="token operator">-</span>commonjs 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><ul><li>@rollup/plugin-node-resolve是为了允许我们加载第三方依赖，否则像import React from 'react' 的依赖导入语句将不会被 Rollup 识别。</li> <li>@rollup/plugin-commonjs 的作用是将 CommonJS 格式的代码转换为 ESM 格式</li></ul> <p>然后让我们在配置文件中导入这些插件:</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// rollup.config.js</span>
<span class="token keyword">import</span> resolve <span class="token keyword">from</span> <span class="token string">&quot;@rollup/plugin-node-resolve&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> commonjs <span class="token keyword">from</span> <span class="token string">&quot;@rollup/plugin-commonjs&quot;</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * @type { import('rollup').RollupOptions }
 */</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>
  input<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;src/index.js&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  output<span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      dir<span class="token operator">:</span> <span class="token string">&quot;dist/es&quot;</span><span class="token punctuation">,</span>
      format<span class="token operator">:</span> <span class="token string">&quot;esm&quot;</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      dir<span class="token operator">:</span> <span class="token string">&quot;dist/cjs&quot;</span><span class="token punctuation">,</span>
      format<span class="token operator">:</span> <span class="token string">&quot;cjs&quot;</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token comment">// 通过 plugins 参数添加插件</span>
  plugins<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">commonjs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><p>比较常用的 Rollup 插件库:</p> <ul><li><a href="https://link.juejin.cn/?target=https%3A%2F%2Fgithub.com%2Frollup%2Fplugins%2Ftree%2Fmaster%2Fpackages%2Fjson" target="_blank" rel="noopener noreferrer">@rollup/plugin-json<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>： 支持.json的加载，并配合rollup的Tree Shaking机制去掉未使用的部分，进行按需打包。</li> <li><a href="https://link.juejin.cn/?target=https%3A%2F%2Fgithub.com%2Frollup%2Fplugins%2Ftree%2Fmaster%2Fpackages%2Fbabel" target="_blank" rel="noopener noreferrer">@rollup/plugin-babel<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>：在 Rollup 中使用 Babel 进行 JS 代码的语法转译。</li> <li><a href="https://link.juejin.cn/?target=https%3A%2F%2Fgithub.com%2Frollup%2Fplugins%2Ftree%2Fmaster%2Fpackages%2Ftypescript" target="_blank" rel="noopener noreferrer">@rollup/plugin-typescript<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>: 支持使用 TypeScript 开发。</li> <li><a href="https://link.juejin.cn/?target=https%3A%2F%2Fgithub.com%2Frollup%2Fplugins%2Ftree%2Fmaster%2Fpackages%2Falias" target="_blank" rel="noopener noreferrer">@rollup/plugin-alias<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>：支持别名配置。</li> <li><a href="https://link.juejin.cn/?target=https%3A%2F%2Fgithub.com%2Frollup%2Fplugins%2Ftree%2Fmaster%2Fpackages%2Freplace" target="_blank" rel="noopener noreferrer">@rollup/plugin-replace<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>：在 Rollup 进行变量字符串的替换。</li> <li><a href="https://link.juejin.cn/?target=https%3A%2F%2Fgithub.com%2Fbtd%2Frollup-plugin-visualizer" target="_blank" rel="noopener noreferrer">rollup-plugin-visualizer<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>: 对 Rollup 打包产物进行分析，自动生成产物体积可视化分析图。</li></ul> <h2 id="javascript-api-方式调用"><a href="#javascript-api-方式调用" class="header-anchor">#</a> JavaScript API 方式调用</h2> <p>通过<code>Rollup</code>的配置文件结合<code>rollup -c</code>完成了 Rollup 的打包过程，但有些场景下我们需要基于 Rollup 定制一些打包过程，配置文件就不够灵活了，这时候我们需要用到对应 JavaScript API 来调用 Rollup，主要分为<code>rollup.rollup</code>和<code>rollup.watch</code>两个 API。</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// build.js</span>
<span class="token keyword">const</span> rollup <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;rollup&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 常用 inputOptions 配置</span>
<span class="token keyword">const</span> inputOptions <span class="token operator">=</span> <span class="token punctuation">{</span>
  input<span class="token operator">:</span> <span class="token string">&quot;./src/index.js&quot;</span><span class="token punctuation">,</span>
  external<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  plugins<span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> outputOptionsList <span class="token operator">=</span> <span class="token punctuation">[</span>
  <span class="token comment">// 常用 outputOptions 配置</span>
  <span class="token punctuation">{</span>
    dir<span class="token operator">:</span> <span class="token string">'dist/es'</span><span class="token punctuation">,</span>
    entryFileNames<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">[name].[hash].js</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
    chunkFileNames<span class="token operator">:</span> <span class="token string">'chunk-[hash].js'</span><span class="token punctuation">,</span>
    assetFileNames<span class="token operator">:</span> <span class="token string">'assets/[name]-[hash][extname]'</span><span class="token punctuation">,</span>
    format<span class="token operator">:</span> <span class="token string">'es'</span><span class="token punctuation">,</span>
    sourcemap<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    globals<span class="token operator">:</span> <span class="token punctuation">{</span>
      lodash<span class="token operator">:</span> <span class="token string">'_'</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 省略其它的输出配置</span>
<span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> bundle<span class="token punctuation">;</span>
  <span class="token keyword">let</span> buildFailed <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token comment">// 1. 调用 rollup.rollup 生成 bundle 对象</span>
    bundle <span class="token operator">=</span> <span class="token keyword">await</span> rollup<span class="token punctuation">.</span><span class="token function">rollup</span><span class="token punctuation">(</span>inputOptions<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> outputOptions <span class="token keyword">of</span> outputOptionsList<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 2. 拿到 bundle 对象，根据每一份输出配置，调用 generate 和 write 方法分别生成和写入产物</span>
      <span class="token keyword">const</span> <span class="token punctuation">{</span> output <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">await</span> bundle<span class="token punctuation">.</span><span class="token function">generate</span><span class="token punctuation">(</span>outputOptions<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">await</span> bundle<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>outputOptions<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    buildFailed <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>bundle<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 最后调用 bundle.close 方法结束打包</span>
    <span class="token keyword">await</span> bundle<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  process<span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span>buildFailed <span class="token operator">?</span> <span class="token number">1</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br></div></div><p>主要的执行步骤如下:</p> <ol><li>通过 rollup.rollup方法，传入 inputOptions，生成 bundle 对象；</li> <li>调用 bundle 对象的 generate 和 write 方法，传入outputOptions，分别完成产物和生成和磁盘写入。</li> <li>调用 bundle 对象的 close 方法来结束打包。</li></ol> <p>除了通过 <code>rollup.rollup</code> 完成一次性打包，我们也可以通过 <code>rollup.watch</code> 来完成 <code>watch</code> 模式下的打包，即每次源文件变动后自动进行重新打包。你可以新建 <code>watch.js</code> 文件，内容入下:</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// watch.js</span>
<span class="token keyword">const</span> rollup <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;rollup&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> watcher <span class="token operator">=</span> rollup<span class="token punctuation">.</span><span class="token function">watch</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token comment">// 和 rollup 配置文件中的属性基本一致，只不过多了`watch`配置</span>
  input<span class="token operator">:</span> <span class="token string">&quot;./src/index.js&quot;</span><span class="token punctuation">,</span>
  output<span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      dir<span class="token operator">:</span> <span class="token string">&quot;dist/es&quot;</span><span class="token punctuation">,</span>
      format<span class="token operator">:</span> <span class="token string">&quot;esm&quot;</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      dir<span class="token operator">:</span> <span class="token string">&quot;dist/cjs&quot;</span><span class="token punctuation">,</span>
      format<span class="token operator">:</span> <span class="token string">&quot;cjs&quot;</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  watch<span class="token operator">:</span> <span class="token punctuation">{</span>
    exclude<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;node_modules/**&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    include<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;src/**&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 监听 watch 各种事件</span>
watcher<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&quot;restart&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;重新构建...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

watcher<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&quot;change&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">id</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;发生变动的模块id: &quot;</span><span class="token punctuation">,</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

watcher<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&quot;event&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>e<span class="token punctuation">.</span>code <span class="token operator">===</span> <span class="token string">&quot;BUNDLE_END&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;打包信息:&quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br></div></div><h2 id="插件机制"><a href="#插件机制" class="header-anchor">#</a> 插件机制</h2> <p>对于一个真实的项目构建场景来说，我们还需要考虑到模块打包之外的问题，比如<strong>路径别名(alias)</strong> 、<strong>全局变量注入</strong>和<strong>代码压缩</strong>等等。因此 ，Rollup 设计出了一套完整的<strong>插件机制</strong>，将自身的核心逻辑与插件逻辑分离，让你能按需引入插件功能，提高了 Rollup 自身的可扩展性。</p> <h3 id="rollup-整体构建"><a href="#rollup-整体构建" class="header-anchor">#</a> Rollup 整体构建</h3> <p>Rollup 内部主要经历了 Build 和 Output 两大阶段：</p> <p><img src="/blog/images/devops/rollup1.png" alt="rollup1"></p> <p>首先，Build 阶段主要负责创建模块依赖图，初始化各个模块的 AST 以及模块之间的依赖关系。经过 Build 阶段的 bundle 对象其实并没有进行模块的打包，这个对象的作用在于存储各个模块的内容及依赖关系，同时暴露 generate 和 write 方法，以进入到后续的 Output 阶段。所以，真正进行打包的过程会在 Output 阶段进行，即在bundle对象的 generate 或者 write 方法中进行。</p> <p>因此，<strong>对于一次完整的构建过程而言，</strong> <strong>Rollup</strong> <strong>会先进入到 Build 阶段，解析各模块的内容及依赖关系，然后进入</strong>Output<strong>阶段，完成打包及输出的过程</strong>。对于不同的阶段，Rollup 插件会有不同的插件工作流程，接下来我们就来拆解一下 Rollup 插件在 Build 和 Output 两个阶段的详细工作流程。</p> <h3 id="插件-hook-类型"><a href="#插件-hook-类型" class="header-anchor">#</a> 插件 Hook 类型</h3> <p>不同插件 Hook 的类型，这些类型代表了不同插件的执行特点，是我们理解 Rollup 插件工作流的基础。</p> <p>实际上，插件的各种 Hook 可以根据这两个构建阶段分为两类: Build Hook 与 Output Hook。</p> <ul><li>Build Hook即在Build阶段执行的钩子函数，在这个阶段主要进行模块代码的转换、AST 解析以及模块依赖的解析，那么这个阶段的 Hook 对于代码的操作粒度一般为模块级别，也就是单文件级别。</li> <li>Ouput Hook(官方称为Output Generation Hook)，则主要进行代码的打包，对于代码而言，操作粒度一般为 chunk级别(一个 chunk 通常指很多文件打包到一起的产物)。</li></ul> <p>除了根据构建阶段可以将 Rollup 插件进行分类，根据不同的 Hook 执行方式也会有不同的分类，主要包括Async、Sync、Parallel、Squential、First这五种。</p> <p>1.<strong>Async &amp; Sync</strong></p> <p>首先是Async和Sync钩子函数，两者其实是相对的，分别代表异步和同步的钩子函数，两者最大的区别在于同步钩子里面不能有异步逻辑，而异步钩子可以有。</p> <ol start="2"><li><strong>Parallel</strong></li></ol> <p>这里指并行的钩子函数。如果有多个插件实现了这个钩子的逻辑，一旦有钩子函数是异步逻辑，则并发执行钩子函数，不会等待当前钩子完成(底层使用 Promise.all)。比如对于Build阶段的buildStart钩子，它的执行时机其实是在构建刚开始的时候，各个插件可以在这个钩子当中做一些状态的初始化操作，但其实插件之间的操作并不是相互依赖的，也就是可以并发执行，从而提升构建性能。反之，对于需要<strong>依赖其他插件处理结果</strong>的情况就不适合用 Parallel 钩子了，比如 transform。</p> <ol start="3"><li><strong>Sequential</strong></li></ol> <p><strong>Sequential</strong> 指串行的钩子函数。这种 Hook 往往适用于插件间处理结果相互依赖的情况，前一个插件 Hook 的返回值作为后续插件的入参，这种情况就需要等待前一个插件执行完 Hook，获得其执行结果，然后才能进行下一个插件相应 Hook 的调用，如transform。</p> <ol start="4"><li><strong>First</strong></li></ol> <p>如果有多个插件实现了这个 Hook，那么 Hook 将依次运行，直到返回一个非 null 或非 undefined 的值为止。比较典型的 Hook 是 resolveId，一旦有插件的 resolveId 返回了一个路径，将停止执行后续插件的 resolveId 逻辑。</p> <h3 id="build-阶段工作流"><a href="#build-阶段工作流" class="header-anchor">#</a> Build 阶段工作流</h3> <p>对于 Build 阶段，插件 Hook 的调用流程如下图所示：</p> <p><img src="/blog/images/devops/rollup2.png" alt="rollup2"></p> <p>分析 <code>Build Hooks</code> 的工作流程：</p> <ol><li>首先经历 <code>options</code> 钩子进行配置的转换，得到处理后的配置对象。</li> <li>随之 Rollup 会调用 <code>buildStart</code> 钩子，正式开始构建流程。</li> <li>Rollup 先进入到 <code>resolveId</code> 钩子中解析文件路径。(从 input 配置指定的入口文件开始)。</li> <li>Rollup 通过调用 <code>load</code> 钩子加载模块内容。</li> <li>紧接着 Rollup 执行所有的 <code>transform</code> 钩子来对模块内容进行进行自定义的转换，比如 babel 转译。</li> <li>现在 Rollup 拿到最后的模块内容，进行 AST 分析，得到所有的 import 内容，调用 <code>moduleParsed</code> 钩子:
<ul><li>如果是普通的 <code>import</code>，则执行 <code>resolveId</code> 钩子，继续回到步骤3。</li> <li>如果是动态 <code>import</code>，则执行 <code>resolveDynamicImport</code> 钩子解析路径，如果解析成功，则回到步骤 4 加载模块，否则回到步骤 3 通过 <code>resolveId</code> 解析路径。</li></ul></li> <li>直到所有的 <code>import</code> 都解析完毕，Rollup 执行 <code>buildEnd</code> 钩子，<code>Build</code> 阶段结束。</li></ol> <p>当然，在 Rollup 解析路径的时候，即执行 <code>resolveId</code> 或者 <code>resolveDynamicImport</code> 的时候，有些路径可能会被标记为 <code>external</code>，也就是说不参加 Rollup 打包过程，这个时候就不会进行 <code>load</code>、<code>transform</code> 等等后续的处理了。<code>watchChange</code> 和 <code>closeWatcher</code> 这两个 Hook，这里其实是对应了 rollup 的 <code>watch</code> 模式。当你使用 <code>rollup --watch</code> 指令或者在配置文件配有 <code>watch: true</code> 的属性时，代表开启了 Rollup 的 <code>watch</code> 打包模式，这个时候 Rollup 内部会初始化一个 <code>watcher</code> 对象，当文件内容发生变化时，<code>watcher</code> 对象会自动触发 <code>watchChange</code> 钩子执行并对项目进行重新构建。在当前<strong>打包过程结束</strong>时，Rollup 会自动清除 <code>watcher</code> 对象调用 <code>closeWacher</code> 钩子。</p> <h3 id="output-阶段工作流"><a href="#output-阶段工作流" class="header-anchor">#</a> Output 阶段工作流</h3> <p><img src="/blog/images/devops/rollup3.png" alt="rollup3"></p> <ol><li>执行所有插件的 <code>outputOptions</code> 钩子函数，对 <code>output</code> 配置进行转换。</li> <li>执行 <code>renderStart</code>，并发执行 renderStart 钩子，正式开始打包。</li> <li>并发执行所有插件的<code>banner</code>、<code>footer</code>、<code>intro</code>、<code>outro</code> 钩子(底层用 Promise.all 包裹所有的这四种钩子函数)，这四个钩子功能很简单，就是往打包产物的固定位置(比如头部和尾部)插入一些自定义的内容，比如协议声明内容、项目介绍等等。</li> <li>从入口模块开始扫描，针对动态 import 语句执行 <code>renderDynamicImport</code>钩子，来自定义动态 import 的内容。</li> <li>对每个即将生成的 <code>chunk</code>，执行 <code>augmentChunkHash</code>钩子，来决定是否更改 chunk 的哈希值，在 <code>watch</code> 模式下即可能会多次打包的场景下，这个钩子会比较适用。</li> <li>如果没有遇到 <code>import.meta</code> 语句，则进入下一步，否则:
<ul><li><strong>6.1</strong> 对于 <code>import.meta.url</code> 语句调用 <code>resolveFileUrl</code> 来自定义 url 解析逻辑</li> <li><strong>6.2</strong> 对于其他<code>import.meta</code> 属性，则调用 <code>resolveImportMeta</code> 来进行自定义的解析。</li></ul></li> <li>接着 Rollup 会生成所有 chunk 的内容，针对每个 chunk 会依次调用插件的<code>renderChunk</code>方法进行自定义操作，也就是说，在这里时候你可以直接操作打包产物了。</li> <li>随后会调用 <code>generateBundle</code> 钩子，这个钩子的入参里面会包含所有的打包产物信息，包括 <code>chunk</code> (打包后的代码)、<code>asset</code>(最终的静态资源文件)。你可以在这里删除一些 chunk 或者 asset，最终这些内容将不会作为产物输出。</li> <li>前面提到了<code>rollup.rollup</code>方法会返回一个<code>bundle</code>对象，这个对象是包含<code>generate</code>和<code>write</code>两个方法，两个方法唯一的区别在于后者会将代码写入到磁盘中，同时会触发<code>writeBundle</code>钩子，传入所有的打包产物信息，包括 chunk 和 asset，和 <code>generateBundle</code>钩子非常相似。不过值得注意的是，这个钩子执行的时候，产物已经输出了，而 generateBundle 执行的时候产物还并没有输出。顺序如下图所示:</li></ol> <p><img src="/blog/images/devops/rollup4.png" alt="rollup4"></p> <ol start="10"><li>当上述的<code>bundle</code>的<code>close</code>方法被调用时，会触发<code>closeBundle</code>钩子，到这里 Output 阶段正式结束。</li></ol> <div class="custom-block danger"><p class="custom-block-title">注意</p> <p>当打包过程中任何阶段出现错误，会触发 renderError 钩子，然后执行closeBundle钩子结束打包。</p></div> <h2 id="插件开发"><a href="#插件开发" class="header-anchor">#</a> 插件开发</h2> <p>实际上开发 Rollup 插件就是在编写一个个 Hook 函数，你可以理解为一个 Rollup 插件基本就是各种 Hook 函数的组合。</p> <ol><li><strong>路径解析: resolveId</strong></li></ol> <p>resolveId 钩子一般用来解析模块路径，为<code>Async + First</code>类型即<code>异步优先</code>的钩子。这里我们拿官方的 <a href="https://link.juejin.cn/?target=https%3A%2F%2Fgithub.com%2Frollup%2Fplugins%2Fblob%2Fmaster%2Fpackages%2Falias%2Fsrc%2Findex.ts" target="_blank" rel="noopener noreferrer">alias 插件<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 来说明，这个插件用法演示如下:</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// rollup.config.js</span>
<span class="token keyword">import</span> alias <span class="token keyword">from</span> <span class="token string">'@rollup/plugin-alias'</span><span class="token punctuation">;</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  input<span class="token operator">:</span> <span class="token string">'src/index.js'</span><span class="token punctuation">,</span>
  output<span class="token operator">:</span> <span class="token punctuation">{</span>
    dir<span class="token operator">:</span> <span class="token string">'output'</span><span class="token punctuation">,</span>
    format<span class="token operator">:</span> <span class="token string">'cjs'</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  plugins<span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token function">alias</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      entries<span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token comment">// 将把 import xxx from 'module-a' </span>
        <span class="token comment">// 转换为 import xxx from './module-a'</span>
        <span class="token punctuation">{</span> find<span class="token operator">:</span> <span class="token string">'module-a'</span><span class="token punctuation">,</span> replacement<span class="token operator">:</span> <span class="token string">'./module-a.js'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">]</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>插件的代码简化后如下:</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token function">alias</span><span class="token punctuation">(</span><span class="token parameter">options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 获取 entries 配置</span>
  <span class="token keyword">const</span> entries <span class="token operator">=</span> <span class="token function">getEntries</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    <span class="token comment">// 传入三个参数，当前模块路径、引用当前模块的模块路径、其余参数</span>
    <span class="token function">resolveId</span><span class="token punctuation">(</span><span class="token parameter">importee<span class="token punctuation">,</span> importer<span class="token punctuation">,</span> resolveOptions</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 先检查能不能匹配别名规则</span>
      <span class="token keyword">const</span> matchedEntry <span class="token operator">=</span> entries<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">entry</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">matches</span><span class="token punctuation">(</span>entry<span class="token punctuation">.</span>find<span class="token punctuation">,</span> importee<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 如果不能匹配替换规则，或者当前模块是入口模块，则不会继续后面的别名替换流程</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>matchedEntry <span class="token operator">||</span> <span class="token operator">!</span>importerId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// return null 后，当前的模块路径会交给下一个插件处理</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// 正式替换路径</span>
      <span class="token keyword">const</span> updatedId <span class="token operator">=</span> <span class="token function">normalizeId</span><span class="token punctuation">(</span>
        importee<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>matchedEntry<span class="token punctuation">.</span>find<span class="token punctuation">,</span> matchedEntry<span class="token punctuation">.</span>replacement<span class="token punctuation">)</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 每个插件执行时都会绑定一个上下文对象作为 this</span>
      <span class="token comment">// 这里的 this.resolve 会执行所有插件(除当前插件外)的 resolveId 钩子</span>
      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>
        updatedId<span class="token punctuation">,</span>
        importer<span class="token punctuation">,</span>
        Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span><span class="token punctuation">{</span> skipSelf<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> resolveOptions<span class="token punctuation">)</span>
      <span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolved</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token comment">// 替换后的路径即 updateId 会经过别的插件进行处理</span>
        <span class="token keyword">let</span> finalResult<span class="token operator">:</span> PartialResolvedId <span class="token operator">|</span> <span class="token keyword">null</span> <span class="token operator">=</span> resolved<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>finalResult<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// 如果其它插件没有处理这个路径，则直接返回 updateId</span>
          finalResult <span class="token operator">=</span> <span class="token punctuation">{</span> id<span class="token operator">:</span> updatedId <span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> finalResult<span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br></div></div><p>从这里你可以看到 resolveId 钩子函数的一些常用使用方式，它的入参分别是<code>当前模块路径</code>、<code>引用当前模块的模块路径</code>、<code>解析参数</code>，返回值可以是 null、string 或者一个对象，我们分情况讨论。</p> <ul><li>返回值为 null 时，会默认交给下一个插件的 resolveId 钩子处理。</li> <li>返回值为 string 时，则停止后续插件的处理。这里为了让替换后的路径能被其他插件处理，特意调用了 this.resolve 来交给其它插件处理，否则将不会进入到其它插件的处理。</li> <li>返回值为一个对象，也会停止后续插件的处理，不过这个对象就可以包含<a href="https://link.juejin.cn/?target=https%3A%2F%2Frollupjs.org%2Fguide%2Fen%2F%23resolveid" target="_blank" rel="noopener noreferrer">更多的信息<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>了，包括解析后的路径、是否被 enternal、是否需要 tree-shaking 等等，不过大部分情况下返回一个 string 就够用了。</li></ul> <h3 id="load"><a href="#load" class="header-anchor">#</a> load</h3> <p>load 为<code>Async + First</code>类型，即<strong>异步优先</strong>的钩子，和<code>resolveId</code>类似。它的作用是通过 resolveId 解析后的路径来加载模块内容。这里，我们以官方的 <a href="https://link.juejin.cn/?target=https%3A%2F%2Fgithub.com%2Frollup%2Fplugins%2Fblob%2Fmaster%2Fpackages%2Fimage%2Fsrc%2Findex.js" target="_blank" rel="noopener noreferrer">image 插件<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 为例来介绍一下 load 钩子的使用。源码简化后如下所示:</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> mimeTypes <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token string">'.jpg'</span><span class="token operator">:</span> <span class="token string">'image/jpeg'</span><span class="token punctuation">,</span>
  <span class="token comment">// 后面图片类型省略</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">image</span><span class="token punctuation">(</span><span class="token parameter">opts <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> options <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> defaults<span class="token punctuation">,</span> opts<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    name<span class="token operator">:</span> <span class="token string">'image'</span><span class="token punctuation">,</span>
    <span class="token function">load</span><span class="token punctuation">(</span><span class="token parameter">id</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> mime <span class="token operator">=</span> mimeTypes<span class="token punctuation">[</span><span class="token function">extname</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mime<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 如果不是图片类型，返回 null，交给下一个插件处理</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// 加载图片具体内容</span>
      <span class="token keyword">const</span> isSvg <span class="token operator">=</span> mime <span class="token operator">===</span> mimeTypes<span class="token punctuation">[</span><span class="token string">'.svg'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> format <span class="token operator">=</span> isSvg <span class="token operator">?</span> <span class="token string">'utf-8'</span> <span class="token operator">:</span> <span class="token string">'base64'</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> source <span class="token operator">=</span> <span class="token function">readFileSync</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> format<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">[\r\n]+</span><span class="token regex-delimiter">/</span><span class="token regex-flags">gm</span></span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> dataUri <span class="token operator">=</span> <span class="token function">getDataUri</span><span class="token punctuation">(</span><span class="token punctuation">{</span> format<span class="token punctuation">,</span> isSvg<span class="token punctuation">,</span> mime<span class="token punctuation">,</span> source <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> code <span class="token operator">=</span> options<span class="token punctuation">.</span>dom <span class="token operator">?</span> <span class="token function">domTemplate</span><span class="token punctuation">(</span><span class="token punctuation">{</span> dataUri <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">constTemplate</span><span class="token punctuation">(</span><span class="token punctuation">{</span> dataUri <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">return</span> code<span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><p>从中可以看到，load 钩子的入参是模块 id，返回值一般是 null、string 或者一个对象：</p> <ul><li>如果返回值为 null，则交给下一个插件处理；</li> <li>如果返回值为 string 或者对象，则终止后续插件的处理，如果是对象可以包含 SourceMap、AST 等<a href="https://link.juejin.cn/?target=https%3A%2F%2Frollupjs.org%2Fguide%2Fen%2F%23load" target="_blank" rel="noopener noreferrer">更详细的信息<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。</li></ul> <h3 id="代码转换-transform"><a href="#代码转换-transform" class="header-anchor">#</a> 代码转换: transform</h3> <p><code>transform</code> 钩子也是非常常见的一个钩子函数，为<code>Async + Sequential</code>类型，也就是<code>异步串行</code>钩子，作用是对加载后的模块内容进行自定义的转换。我们以官方的 <code>replace</code> 插件为例，这个插件的使用方式如下:</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// rollup.config.js</span>
<span class="token keyword">import</span> replace <span class="token keyword">from</span> <span class="token string">'@rollup/plugin-replace'</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  input<span class="token operator">:</span> <span class="token string">'src/index.js'</span><span class="token punctuation">,</span>
  output<span class="token operator">:</span> <span class="token punctuation">{</span>
    dir<span class="token operator">:</span> <span class="token string">'output'</span><span class="token punctuation">,</span>
    format<span class="token operator">:</span> <span class="token string">'cjs'</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  plugins<span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token comment">// 将会把代码中所有的 __TEST__ 替换为 1</span>
    <span class="token function">replace</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      __TEST__<span class="token operator">:</span> <span class="token number">1</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>内部实现也并不复杂，主要通过字符串替换来实现，核心逻辑简化如下:</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">import</span> MagicString <span class="token keyword">from</span> <span class="token string">'magic-string'</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">replace</span><span class="token punctuation">(</span><span class="token parameter">options <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    name<span class="token operator">:</span> <span class="token string">'replace'</span><span class="token punctuation">,</span>
    <span class="token function">transform</span><span class="token punctuation">(</span><span class="token parameter">code<span class="token punctuation">,</span> id</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 省略一些边界情况的处理</span>
      <span class="token comment">// 执行代码替换的逻辑，并生成最后的代码和 SourceMap</span>
      <span class="token keyword">return</span> <span class="token function">executeReplacement</span><span class="token punctuation">(</span>code<span class="token punctuation">,</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">executeReplacement</span><span class="token punctuation">(</span><span class="token parameter">code<span class="token punctuation">,</span> id</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> magicString <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MagicString</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 通过 magicString.overwrite 方法实现字符串替换</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">codeHasReplacements</span><span class="token punctuation">(</span>code<span class="token punctuation">,</span> id<span class="token punctuation">,</span> magicString<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token punctuation">{</span> code<span class="token operator">:</span> magicString<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isSourceMapEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    result<span class="token punctuation">.</span>map <span class="token operator">=</span> magicString<span class="token punctuation">.</span><span class="token function">generateMap</span><span class="token punctuation">(</span><span class="token punctuation">{</span> hires<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 返回一个带有 code 和 map 属性的对象</span>
  <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br></div></div><p><a href="https://link.juejin.cn/?target=https%3A%2F%2Frollupjs.org%2Fguide%2Fen%2F%23transform" target="_blank" rel="noopener noreferrer">transform 钩子<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>的入参分别为<code>模块代码</code>、<code>模块 ID</code>，返回一个包含 <code>code</code>(代码内容) 和 <code>map</code>(SourceMap 内容) 属性的对象，当然也可以返回 null 来跳过当前插件的 transform 处理。需要注意的是，<strong>当前插件返回的代码会作为下一个插件 transform 钩子的第一个入参</strong>，实现类似于瀑布流的处理。</p> <h3 id="chunk-级代码修改-renderchunk"><a href="#chunk-级代码修改-renderchunk" class="header-anchor">#</a> Chunk 级代码修改: renderChunk</h3> <p>这里我们继续以 <code>replace</code>插件举例，在这个插件中，也同样实现了 renderChunk 钩子函数:</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">replace</span><span class="token punctuation">(</span><span class="token parameter">options <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    name<span class="token operator">:</span> <span class="token string">'replace'</span><span class="token punctuation">,</span>
    <span class="token function">transform</span><span class="token punctuation">(</span><span class="token parameter">code<span class="token punctuation">,</span> id</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// transform 代码省略</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function">renderChunk</span><span class="token punctuation">(</span><span class="token parameter">code<span class="token punctuation">,</span> chunk</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> id <span class="token operator">=</span> chunk<span class="token punctuation">.</span>fileName<span class="token punctuation">;</span>
      <span class="token comment">// 省略一些边界情况的处理</span>
      <span class="token comment">// 拿到 chunk 的代码及文件名，执行替换逻辑</span>
      <span class="token keyword">return</span> <span class="token function">executeReplacement</span><span class="token punctuation">(</span>code<span class="token punctuation">,</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>可以看到这里 replace 插件为了替换结果更加准确，在 renderChunk 钩子中又进行了一次替换，因为后续的插件仍然可能在 transform 中进行模块内容转换，进而可能出现符合替换规则的字符串。</p> <p>这里我们把关注点放到 renderChunk 函数本身，可以看到有两个入参，分别为 <code>chunk 代码内容</code>、<a href="https://link.juejin.cn/?target=https%3A%2F%2Frollupjs.org%2Fguide%2Fen%2F%23generatebundle" target="_blank" rel="noopener noreferrer">chunk 元信息<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>，返回值跟 <code>transform</code> 钩子类似，既可以返回包含 code 和 map 属性的对象，也可以通过返回 null 来跳过当前钩子的处理。</p> <h3 id="产物生成最后一步-generatebundle"><a href="#产物生成最后一步-generatebundle" class="header-anchor">#</a> 产物生成最后一步: generateBundle</h3> <p>generateBundle 也是<code>异步串行</code>的钩子，你可以在这个钩子里面自定义删除一些无用的 chunk 或者静态资源，或者自己添加一些文件。这里我们以 Rollup 官方的<code>html</code>插件来具体说明，这个插件的作用是通过拿到 Rollup 打包后的资源来生成包含这些资源的 HTML 文件，源码简化后如下所示:</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">html</span><span class="token punctuation">(</span><span class="token parameter">opts<span class="token operator">:</span> RollupHtmlOptions <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span><span class="token punctuation">)</span><span class="token operator">:</span> Plugin <span class="token punctuation">{</span>
  <span class="token comment">// 初始化配置</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    name<span class="token operator">:</span> <span class="token string">'html'</span><span class="token punctuation">,</span>
    <span class="token keyword">async</span> <span class="token function">generateBundle</span><span class="token punctuation">(</span><span class="token parameter">output<span class="token operator">:</span> NormalizedOutputOptions<span class="token punctuation">,</span> bundle<span class="token operator">:</span> OutputBundle</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 省略一些边界情况的处理</span>
      <span class="token comment">// 1. 获取打包后的文件</span>
      <span class="token keyword">const</span> files <span class="token operator">=</span> <span class="token function">getFiles</span><span class="token punctuation">(</span>bundle<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 2. 组装 HTML，插入相应 meta、link 和 script 标签</span>
      <span class="token keyword">const</span> source <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">template</span><span class="token punctuation">(</span><span class="token punctuation">{</span> attributes<span class="token punctuation">,</span> bundle<span class="token punctuation">,</span> files<span class="token punctuation">,</span> meta<span class="token punctuation">,</span> publicPath<span class="token punctuation">,</span> title<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 3. 通过上下文对象的 emitFile 方法，输出 html 文件</span>
      <span class="token keyword">const</span> htmlFile<span class="token operator">:</span> EmittedAsset <span class="token operator">=</span> <span class="token punctuation">{</span>
        type<span class="token operator">:</span> <span class="token string">'asset'</span><span class="token punctuation">,</span>
        source<span class="token punctuation">,</span>
        name<span class="token operator">:</span> <span class="token string">'Rollup HTML Asset'</span><span class="token punctuation">,</span>
        fileName
      <span class="token punctuation">}</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">emitFile</span><span class="token punctuation">(</span>htmlFile<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><p>相信从插件的具体实现中，你也能感受到这个钩子的强大作用了。入参分别为<code>output 配置</code>、<a href="https://link.juejin.cn/?target=https%3A%2F%2Frollupjs.org%2Fguide%2Fen%2F%23generatebundle" target="_blank" rel="noopener noreferrer">所有打包产物的元信息对象<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>，通过操作元信息对象你可以删除一些不需要的 chunk 或者静态资源，也可以通过 插件上下文对象的<code>emitFile</code>方法输出自定义文件。</p> <p>Rollup 的插件开发整体上是非常简洁和灵活的，总结为以下几个方面:</p> <ul><li><strong>插件逻辑集中管理</strong>。各个阶段的 Hook 都可以放在一个插件中编写，比如上述两个 Webpack 的 Loader 和 Plugin 功能在 Rollup 只需要用一个插件，分别通过 transform 和 renderChunk 两个 Hook 来实现。</li> <li><strong>插件 API 简洁，符合直觉</strong>。Rollup 插件基本上只需要返回一个包含 name 和各种钩子函数的对象即可，也就是声明一个 name 属性，然后写几个钩子函数即可。</li> <li><strong>插件间的互相调用</strong>。比如刚刚介绍的<code>alias</code>插件，可以通过插件上下文对象的<code>resolve</code>方法，继续调用其它插件的 <code>resolveId</code>钩子，类似的还有<code>load</code>方法，这就大大增加了插件的灵活性。</li></ul></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/blog/devops/vite/engines.html" class="prev">
        双引擎架构
      </a></span> <span class="next"><a href="/blog/devops/vite/building.html">
        Vite 构建原理
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----><!----><!----><!----></div></div>
    <script src="/blog/assets/js/app.7addad61.js" defer></script><script src="/blog/assets/js/2.8bf77cff.js" defer></script><script src="/blog/assets/js/87.b5684eee.js" defer></script><script src="/blog/assets/js/4.ff6074e9.js" defer></script>
  </body>
</html>
