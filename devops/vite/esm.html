<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>模块化规范 | 前端那些事儿</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="icon" href="/blog/logo.png">
    <link rel="manifest" href="/blog/manifest.json">
    <link rel="apple-touch-icon" href="/blog/images/icons/apple-icon-152x152.png">
    <meta name="description" content="我命由我不由天，学习吧少年">
    <meta name="theme-color" content="#3eaf7c">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="msapplication-TileImage" content="/icons/ms-icon-144x144.png">
    <meta name="msapplication-TileColor" content="#000000">
    
    <link rel="preload" href="/blog/assets/css/0.styles.cdf5c1fc.css" as="style"><link rel="preload" href="/blog/assets/js/app.868312f0.js" as="script"><link rel="preload" href="/blog/assets/js/2.8bf77cff.js" as="script"><link rel="preload" href="/blog/assets/js/80.25ff7a89.js" as="script"><link rel="preload" href="/blog/assets/js/4.ff6074e9.js" as="script"><link rel="prefetch" href="/blog/assets/js/10.a09e5ce0.js"><link rel="prefetch" href="/blog/assets/js/100.e3a242e7.js"><link rel="prefetch" href="/blog/assets/js/101.a50880ee.js"><link rel="prefetch" href="/blog/assets/js/102.ceee255d.js"><link rel="prefetch" href="/blog/assets/js/103.11acae7b.js"><link rel="prefetch" href="/blog/assets/js/104.cd6393f3.js"><link rel="prefetch" href="/blog/assets/js/105.3cf7234e.js"><link rel="prefetch" href="/blog/assets/js/106.4c9c6385.js"><link rel="prefetch" href="/blog/assets/js/107.e55e8e93.js"><link rel="prefetch" href="/blog/assets/js/108.cd3d7fb1.js"><link rel="prefetch" href="/blog/assets/js/109.c79bf5b8.js"><link rel="prefetch" href="/blog/assets/js/11.423e07d5.js"><link rel="prefetch" href="/blog/assets/js/110.a321d6ba.js"><link rel="prefetch" href="/blog/assets/js/111.3fc50044.js"><link rel="prefetch" href="/blog/assets/js/112.3854f67b.js"><link rel="prefetch" href="/blog/assets/js/113.64d6781b.js"><link rel="prefetch" href="/blog/assets/js/114.f1cf04e3.js"><link rel="prefetch" href="/blog/assets/js/115.efe5e545.js"><link rel="prefetch" href="/blog/assets/js/116.c14f1baa.js"><link rel="prefetch" href="/blog/assets/js/117.916666eb.js"><link rel="prefetch" href="/blog/assets/js/118.607d2004.js"><link rel="prefetch" href="/blog/assets/js/119.a6712499.js"><link rel="prefetch" href="/blog/assets/js/12.755ca593.js"><link rel="prefetch" href="/blog/assets/js/120.ff74821a.js"><link rel="prefetch" href="/blog/assets/js/121.118a259e.js"><link rel="prefetch" href="/blog/assets/js/122.4713ca01.js"><link rel="prefetch" href="/blog/assets/js/123.995a2136.js"><link rel="prefetch" href="/blog/assets/js/124.ae9596cb.js"><link rel="prefetch" href="/blog/assets/js/125.fa7948f2.js"><link rel="prefetch" href="/blog/assets/js/126.d0a16252.js"><link rel="prefetch" href="/blog/assets/js/127.5db8f129.js"><link rel="prefetch" href="/blog/assets/js/128.0f76c2da.js"><link rel="prefetch" href="/blog/assets/js/129.a1144962.js"><link rel="prefetch" href="/blog/assets/js/13.102809a8.js"><link rel="prefetch" href="/blog/assets/js/130.8fd2a57a.js"><link rel="prefetch" href="/blog/assets/js/131.04d1d944.js"><link rel="prefetch" href="/blog/assets/js/132.a29ab56c.js"><link rel="prefetch" href="/blog/assets/js/133.4a84397c.js"><link rel="prefetch" href="/blog/assets/js/134.51c64127.js"><link rel="prefetch" href="/blog/assets/js/135.bde9500e.js"><link rel="prefetch" href="/blog/assets/js/136.77d9fc24.js"><link rel="prefetch" href="/blog/assets/js/137.02a49a0e.js"><link rel="prefetch" href="/blog/assets/js/138.6a7b69e5.js"><link rel="prefetch" href="/blog/assets/js/139.8275fcee.js"><link rel="prefetch" href="/blog/assets/js/14.ae35c0e2.js"><link rel="prefetch" href="/blog/assets/js/140.6bb0993e.js"><link rel="prefetch" href="/blog/assets/js/141.8c997d0d.js"><link rel="prefetch" href="/blog/assets/js/142.f077e399.js"><link rel="prefetch" href="/blog/assets/js/143.899cf715.js"><link rel="prefetch" href="/blog/assets/js/144.08086f0b.js"><link rel="prefetch" href="/blog/assets/js/145.966233ad.js"><link rel="prefetch" href="/blog/assets/js/146.c15208ca.js"><link rel="prefetch" href="/blog/assets/js/147.858ba9b8.js"><link rel="prefetch" href="/blog/assets/js/148.8313c415.js"><link rel="prefetch" href="/blog/assets/js/149.19be8ad2.js"><link rel="prefetch" href="/blog/assets/js/15.e8e667f5.js"><link rel="prefetch" href="/blog/assets/js/150.e89c8fa1.js"><link rel="prefetch" href="/blog/assets/js/151.eca0b8b7.js"><link rel="prefetch" href="/blog/assets/js/152.f5de7046.js"><link rel="prefetch" href="/blog/assets/js/153.47002439.js"><link rel="prefetch" href="/blog/assets/js/154.2d0ce988.js"><link rel="prefetch" href="/blog/assets/js/155.2a2cc386.js"><link rel="prefetch" href="/blog/assets/js/156.f8e97b06.js"><link rel="prefetch" href="/blog/assets/js/157.5d08a880.js"><link rel="prefetch" href="/blog/assets/js/158.d67bad77.js"><link rel="prefetch" href="/blog/assets/js/159.b9a8745b.js"><link rel="prefetch" href="/blog/assets/js/16.3db06b2a.js"><link rel="prefetch" href="/blog/assets/js/160.0d28d645.js"><link rel="prefetch" href="/blog/assets/js/161.f4a99385.js"><link rel="prefetch" href="/blog/assets/js/162.e9a228ce.js"><link rel="prefetch" href="/blog/assets/js/163.591c5f9a.js"><link rel="prefetch" href="/blog/assets/js/164.8f12f210.js"><link rel="prefetch" href="/blog/assets/js/165.9733b50e.js"><link rel="prefetch" href="/blog/assets/js/166.cd1099a3.js"><link rel="prefetch" href="/blog/assets/js/167.395f7f91.js"><link rel="prefetch" href="/blog/assets/js/168.cdc23b02.js"><link rel="prefetch" href="/blog/assets/js/169.ccd7a91e.js"><link rel="prefetch" href="/blog/assets/js/17.090d5e84.js"><link rel="prefetch" href="/blog/assets/js/170.fd04f733.js"><link rel="prefetch" href="/blog/assets/js/171.3aec6d98.js"><link rel="prefetch" href="/blog/assets/js/172.2b2d7eb7.js"><link rel="prefetch" href="/blog/assets/js/173.e3933c8f.js"><link rel="prefetch" href="/blog/assets/js/174.c97e4800.js"><link rel="prefetch" href="/blog/assets/js/175.eff3398b.js"><link rel="prefetch" href="/blog/assets/js/176.ca3a264c.js"><link rel="prefetch" href="/blog/assets/js/177.312618e0.js"><link rel="prefetch" href="/blog/assets/js/178.51484ab5.js"><link rel="prefetch" href="/blog/assets/js/179.4537bea5.js"><link rel="prefetch" href="/blog/assets/js/18.bbfd6946.js"><link rel="prefetch" href="/blog/assets/js/180.5fb5a7a5.js"><link rel="prefetch" href="/blog/assets/js/181.b4cc74a9.js"><link rel="prefetch" href="/blog/assets/js/182.7d8b01ed.js"><link rel="prefetch" href="/blog/assets/js/19.6d66b58c.js"><link rel="prefetch" href="/blog/assets/js/20.7c6d391e.js"><link rel="prefetch" href="/blog/assets/js/21.78cd78b7.js"><link rel="prefetch" href="/blog/assets/js/22.ad4292c9.js"><link rel="prefetch" href="/blog/assets/js/23.03ff0779.js"><link rel="prefetch" href="/blog/assets/js/24.f3e50cb8.js"><link rel="prefetch" href="/blog/assets/js/25.9686fd3a.js"><link rel="prefetch" href="/blog/assets/js/26.df774ace.js"><link rel="prefetch" href="/blog/assets/js/27.1dbbfd02.js"><link rel="prefetch" href="/blog/assets/js/28.618079e9.js"><link rel="prefetch" href="/blog/assets/js/29.c886b257.js"><link rel="prefetch" href="/blog/assets/js/3.6c93b5c9.js"><link rel="prefetch" href="/blog/assets/js/30.62fa3d28.js"><link rel="prefetch" href="/blog/assets/js/31.aa6386dc.js"><link rel="prefetch" href="/blog/assets/js/32.918e32d8.js"><link rel="prefetch" href="/blog/assets/js/33.fcd37f83.js"><link rel="prefetch" href="/blog/assets/js/34.e6433036.js"><link rel="prefetch" href="/blog/assets/js/35.9265e369.js"><link rel="prefetch" href="/blog/assets/js/36.c97ebf18.js"><link rel="prefetch" href="/blog/assets/js/37.2ea10112.js"><link rel="prefetch" href="/blog/assets/js/38.89bb41c1.js"><link rel="prefetch" href="/blog/assets/js/39.4a8ce10e.js"><link rel="prefetch" href="/blog/assets/js/40.295af0e1.js"><link rel="prefetch" href="/blog/assets/js/41.b07cb41d.js"><link rel="prefetch" href="/blog/assets/js/42.67df98c9.js"><link rel="prefetch" href="/blog/assets/js/43.9fd9b784.js"><link rel="prefetch" href="/blog/assets/js/44.d6e6e5cd.js"><link rel="prefetch" href="/blog/assets/js/45.277ecef3.js"><link rel="prefetch" href="/blog/assets/js/46.ec88394f.js"><link rel="prefetch" href="/blog/assets/js/47.21dd8fd6.js"><link rel="prefetch" href="/blog/assets/js/48.2873a04a.js"><link rel="prefetch" href="/blog/assets/js/49.35e4e6cc.js"><link rel="prefetch" href="/blog/assets/js/5.db99d33d.js"><link rel="prefetch" href="/blog/assets/js/50.8e31f6a0.js"><link rel="prefetch" href="/blog/assets/js/51.490ec77e.js"><link rel="prefetch" href="/blog/assets/js/52.af122f8c.js"><link rel="prefetch" href="/blog/assets/js/53.6019b36f.js"><link rel="prefetch" href="/blog/assets/js/54.046439d0.js"><link rel="prefetch" href="/blog/assets/js/55.f0c25685.js"><link rel="prefetch" href="/blog/assets/js/56.d17fc406.js"><link rel="prefetch" href="/blog/assets/js/57.4fad3854.js"><link rel="prefetch" href="/blog/assets/js/58.ac3ba90c.js"><link rel="prefetch" href="/blog/assets/js/59.8e4b871c.js"><link rel="prefetch" href="/blog/assets/js/6.e80c5c8e.js"><link rel="prefetch" href="/blog/assets/js/60.0fc1ba5d.js"><link rel="prefetch" href="/blog/assets/js/61.aa0af91b.js"><link rel="prefetch" href="/blog/assets/js/62.6121017d.js"><link rel="prefetch" href="/blog/assets/js/63.907bf205.js"><link rel="prefetch" href="/blog/assets/js/64.3be63f54.js"><link rel="prefetch" href="/blog/assets/js/65.22749bec.js"><link rel="prefetch" href="/blog/assets/js/66.4ce5bd01.js"><link rel="prefetch" href="/blog/assets/js/67.d675188b.js"><link rel="prefetch" href="/blog/assets/js/68.0bf52e03.js"><link rel="prefetch" href="/blog/assets/js/69.d59a7017.js"><link rel="prefetch" href="/blog/assets/js/7.fd1464a3.js"><link rel="prefetch" href="/blog/assets/js/70.96a53f7b.js"><link rel="prefetch" href="/blog/assets/js/71.05dc604c.js"><link rel="prefetch" href="/blog/assets/js/72.f4afe294.js"><link rel="prefetch" href="/blog/assets/js/73.cdb13f02.js"><link rel="prefetch" href="/blog/assets/js/74.711c5877.js"><link rel="prefetch" href="/blog/assets/js/75.86330a86.js"><link rel="prefetch" href="/blog/assets/js/76.ebcc797a.js"><link rel="prefetch" href="/blog/assets/js/77.695950de.js"><link rel="prefetch" href="/blog/assets/js/78.c0ed554b.js"><link rel="prefetch" href="/blog/assets/js/79.ffd6a6fa.js"><link rel="prefetch" href="/blog/assets/js/8.60aa9c8a.js"><link rel="prefetch" href="/blog/assets/js/81.7971d80b.js"><link rel="prefetch" href="/blog/assets/js/82.74d9a76f.js"><link rel="prefetch" href="/blog/assets/js/83.c64e86e6.js"><link rel="prefetch" href="/blog/assets/js/84.82f91f55.js"><link rel="prefetch" href="/blog/assets/js/85.1ce9f5ce.js"><link rel="prefetch" href="/blog/assets/js/86.4b858d16.js"><link rel="prefetch" href="/blog/assets/js/87.a34efa7b.js"><link rel="prefetch" href="/blog/assets/js/88.58ba2a2a.js"><link rel="prefetch" href="/blog/assets/js/89.ba75e547.js"><link rel="prefetch" href="/blog/assets/js/9.9ae7697d.js"><link rel="prefetch" href="/blog/assets/js/90.bea485ab.js"><link rel="prefetch" href="/blog/assets/js/91.783e0fb4.js"><link rel="prefetch" href="/blog/assets/js/92.743873bf.js"><link rel="prefetch" href="/blog/assets/js/93.8ada8ca4.js"><link rel="prefetch" href="/blog/assets/js/94.64ffea6d.js"><link rel="prefetch" href="/blog/assets/js/95.09c103f6.js"><link rel="prefetch" href="/blog/assets/js/96.ae941bb8.js"><link rel="prefetch" href="/blog/assets/js/97.7701f686.js"><link rel="prefetch" href="/blog/assets/js/98.31b72843.js"><link rel="prefetch" href="/blog/assets/js/99.ef3bb4ef.js">
    <link rel="stylesheet" href="/blog/assets/css/0.styles.cdf5c1fc.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/blog/" class="home-link router-link-active"><img src="/blog/logo.png" alt="前端那些事儿" class="logo"> <span class="site-name can-hide">前端那些事儿</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/blog/" class="nav-link">
  主页
</a></div><div class="nav-item"><a href="/blog/base/" class="nav-link">
  前端基础
</a></div><div class="nav-item"><a href="/blog/vue/" class="nav-link">
  Vue
</a></div><div class="nav-item"><a href="/blog/react/" class="nav-link">
  React
</a></div><div class="nav-item"><a href="/blog/node/" class="nav-link">
  Node
</a></div><div class="nav-item"><a href="/blog/devops/" class="nav-link router-link-active">
  前端工程化
</a></div><div class="nav-item"><a href="/blog/mobile/" class="nav-link">
  泛客户端
</a></div><div class="nav-item"><a href="/blog/architecture/" class="nav-link">
  架构&amp;方案
</a></div><div class="nav-item"><a href="/blog/code/" class="nav-link">
  算法&amp;编程
</a></div><div class="nav-item"><a href="/blog/weekly/" class="nav-link">
  前端周刊
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="GitHub" class="dropdown-title"><span class="title">GitHub</span> <span class="arrow down"></span></button> <button type="button" aria-label="GitHub" class="mobile-dropdown-title"><span class="title">GitHub</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/jonny-wei" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub地址
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/blog/" class="nav-link">
  主页
</a></div><div class="nav-item"><a href="/blog/base/" class="nav-link">
  前端基础
</a></div><div class="nav-item"><a href="/blog/vue/" class="nav-link">
  Vue
</a></div><div class="nav-item"><a href="/blog/react/" class="nav-link">
  React
</a></div><div class="nav-item"><a href="/blog/node/" class="nav-link">
  Node
</a></div><div class="nav-item"><a href="/blog/devops/" class="nav-link router-link-active">
  前端工程化
</a></div><div class="nav-item"><a href="/blog/mobile/" class="nav-link">
  泛客户端
</a></div><div class="nav-item"><a href="/blog/architecture/" class="nav-link">
  架构&amp;方案
</a></div><div class="nav-item"><a href="/blog/code/" class="nav-link">
  算法&amp;编程
</a></div><div class="nav-item"><a href="/blog/weekly/" class="nav-link">
  前端周刊
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="GitHub" class="dropdown-title"><span class="title">GitHub</span> <span class="arrow down"></span></button> <button type="button" aria-label="GitHub" class="mobile-dropdown-title"><span class="title">GitHub</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/jonny-wei" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub地址
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Webpack</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/devops/" aria-current="page" class="sidebar-link">Webpack 常用配置</a></li><li><a href="/blog/devops/webpack/building.html" class="sidebar-link">构建流程与原理</a></li><li><a href="/blog/devops/webpack/dependency-graph.html" class="sidebar-link">模块依赖关系</a></li><li><a href="/blog/devops/webpack/chunk.html" class="sidebar-link">产物打包逻辑</a></li><li><a href="/blog/devops/webpack/compile.html" class="sidebar-link">模块编译及运行时</a></li><li><a href="/blog/devops/webpack/hmr.html" class="sidebar-link">HMR 热更新</a></li><li><a href="/blog/devops/webpack/loader.html" class="sidebar-link">Webpack Loader</a></li><li><a href="/blog/devops/webpack/plugin.html" class="sidebar-link">Webpack Plugin</a></li><li><a href="/blog/devops/webpack/module-federation.html" class="sidebar-link">模块联邦</a></li><li><a href="/blog/devops/webpack/cache.html" class="sidebar-link">持久化缓存</a></li><li><a href="/blog/devops/webpack/parallel.html" class="sidebar-link">并行构建</a></li><li><a href="/blog/devops/webpack/split-chunks.html" class="sidebar-link">分包策略</a></li><li><a href="/blog/devops/webpack/compress.html" class="sidebar-link">代码压缩</a></li><li><a href="/blog/devops/webpack/tree-shaking.html" class="sidebar-link">Tree Shaking</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Vite</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/devops/vite/esm.html" aria-current="page" class="active sidebar-link">模块化规范</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/devops/vite/esm.html#iife-立即执行函数" class="sidebar-link">IIFE(立即执行函数)</a></li><li class="sidebar-sub-header"><a href="/blog/devops/vite/esm.html#commonjs-规范" class="sidebar-link">CommonJS 规范</a></li><li class="sidebar-sub-header"><a href="/blog/devops/vite/esm.html#amd-规范" class="sidebar-link">AMD 规范</a></li><li class="sidebar-sub-header"><a href="/blog/devops/vite/esm.html#umd-规范" class="sidebar-link">UMD 规范</a></li><li class="sidebar-sub-header"><a href="/blog/devops/vite/esm.html#es-module" class="sidebar-link">ES Module</a></li><li class="sidebar-sub-header"><a href="/blog/devops/vite/esm.html#pure-esm" class="sidebar-link">Pure ESM</a></li><li class="sidebar-sub-header"><a href="/blog/devops/vite/esm.html#新一代的基础库打包器" class="sidebar-link">新一代的基础库打包器</a></li></ul></li><li><a href="/blog/devops/vite/css.html" class="sidebar-link">CSS 工程化</a></li><li><a href="/blog/devops/vite/prebuild.html" class="sidebar-link">依赖预构建</a></li><li><a href="/blog/devops/vite/engines.html" class="sidebar-link">双引擎架构</a></li><li><a href="/blog/devops/vite/rollup.html" class="sidebar-link">Rollup 打包</a></li><li><a href="/blog/devops/vite/building.html" class="sidebar-link">Vite 构建原理</a></li><li><a href="/blog/devops/vite/plugin.html" class="sidebar-link">Vite Plugin</a></li><li><a href="/blog/devops/vite/hmr.html" class="sidebar-link">Vite HMR 热更新</a></li><li><a href="/blog/devops/vite/ssr.html" class="sidebar-link">SSR 工程化</a></li><li><a href="/blog/devops/vite/legacy.html" class="sidebar-link">兼容性问题</a></li><li><a href="/blog/devops/vite/split-code.html" class="sidebar-link">代码分割</a></li><li><a href="/blog/devops/vite/vite-news.html" class="sidebar-link">Vite 新特性</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>性能优化</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/devops/performance/network.html" class="sidebar-link">网络层面优化</a></li><li><a href="/blog/devops/performance/webpack.html" class="sidebar-link">构建层面优化</a></li><li><a href="/blog/devops/performance/render.html" class="sidebar-link">渲染层面优化</a></li><li><a href="/blog/devops/performance/code.html" class="sidebar-link">代码层面优化</a></li><li><a href="/blog/devops/performance/analysis.html" class="sidebar-link">性能分析</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="模块化规范"><a href="#模块化规范" class="header-anchor">#</a> 模块化规范</h1> <h2 id="iife-立即执行函数"><a href="#iife-立即执行函数" class="header-anchor">#</a> IIFE(立即执行函数)</h2> <p>相比于<code>命名空间</code>的模块化手段，<code>IIFE</code>实现的模块化安全性要更高，对于模块作用域的区分更加彻底。</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token comment">// module-a.js</span>
<span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> data <span class="token operator">=</span> <span class="token string">&quot;moduleA&quot;</span><span class="token punctuation">;</span>

  <span class="token keyword">function</span> <span class="token function">method</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data <span class="token operator">+</span> <span class="token string">&quot;execute&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  window<span class="token punctuation">.</span>moduleA <span class="token operator">=</span> <span class="token punctuation">{</span>
    method<span class="token operator">:</span> method<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// module-b.js</span>
<span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> data <span class="token operator">=</span> <span class="token string">&quot;moduleB&quot;</span><span class="token punctuation">;</span>

  <span class="token keyword">function</span> <span class="token function">method</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data <span class="token operator">+</span> <span class="token string">&quot;execute&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  window<span class="token punctuation">.</span>moduleB <span class="token operator">=</span> <span class="token punctuation">{</span>
    method<span class="token operator">:</span> method<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// index.html</span>
<span class="token operator">&lt;</span><span class="token operator">!</span><span class="token constant">DOCTYPE</span> html<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>html lang<span class="token operator">=</span><span class="token string">&quot;en&quot;</span><span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>head<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>meta charset<span class="token operator">=</span><span class="token string">&quot;UTF-8&quot;</span> <span class="token operator">/</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>meta http<span class="token operator">-</span>equiv<span class="token operator">=</span><span class="token string">&quot;X-UA-Compatible&quot;</span> content<span class="token operator">=</span><span class="token string">&quot;IE=edge&quot;</span> <span class="token operator">/</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>meta name<span class="token operator">=</span><span class="token string">&quot;viewport&quot;</span> content<span class="token operator">=</span><span class="token string">&quot;width=device-width, initial-scale=1.0&quot;</span> <span class="token operator">/</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>title<span class="token operator">&gt;</span>Document<span class="token operator">&lt;</span><span class="token operator">/</span>title<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span><span class="token operator">/</span>head<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>body<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>script src<span class="token operator">=</span><span class="token string">&quot;./module-a.js&quot;</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>script src<span class="token operator">=</span><span class="token string">&quot;./module-b.js&quot;</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>script<span class="token operator">&gt;</span>
      <span class="token comment">// 此时 window 上已经绑定了 moduleA 和 moduleB</span>
      <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>moduleA<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
      moduleB<span class="token punctuation">.</span><span class="token function">method</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span><span class="token operator">/</span>body<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>html<span class="token operator">&gt;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br></div></div><p>每个<code>IIFE</code> 即<code>立即执行函数</code>都会创建一个私有的作用域，在私有作用域中的变量外界是无法访问的，只有模块内部的方法才能访问。拿上述的<code>module-a</code>来说，对于其中的 <code>data</code>变量，我们只能在模块内部的 <code>method</code> 函数中通过闭包访问，而在其它模块中无法直接访问。这就是模块<code>私有成员</code>功能，避免模块私有成员被其他模块非法篡改，相比于<code>命名空间</code>的实现方式更加安全。</p> <p>但实际上，无论是<code>命名空间</code>还是<code>IIFE</code>，都是为了解决全局变量所带来的命名冲突及作用域不明确的问题，而并没有真正解决另外一个问题——<strong>模块加载</strong>。如果模块间存在依赖关系，那么 script 标签的加载顺序就需要受到严格的控制，一旦顺序不对，则很有可能产生运行时 Bug。</p> <h2 id="commonjs-规范"><a href="#commonjs-规范" class="header-anchor">#</a> CommonJS 规范</h2> <p>CommonJS 是业界最早正式提出的 JavaScript 模块规范，主要用于服务端，随着 Node.js 越来越普及，这个规范也被业界广泛应用。对于模块规范而言，一般会包含 2 方面内容:</p> <ul><li>统一的模块化代码规范</li> <li>实现自动加载模块的加载器(也称<code>loader</code>)</li></ul> <p>使用 <code>require</code> 来导入一个模块，用 <code>module.exports</code> 来导出一个模块。实际上 Node.js 内部会有相应的 loader 转译模块代码，最后模块代码会被处理成下面这样:</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">exports<span class="token punctuation">,</span> require<span class="token punctuation">,</span> module<span class="token punctuation">,</span> __filename<span class="token punctuation">,</span> __dirname</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 执行模块代码</span>
  <span class="token comment">// 返回 exports 对象</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>对 CommonJS 而言，一方面它定义了一套完整的模块化代码规范，另一方面 Node.js 为之实现了自动加载模块的 loader，看上去是一个很不错的模块规范，但也存在一些问题:</p> <ol><li>模块加载器由 Node.js 提供，依赖了 Node.js 本身的功能实现，比如文件系统，如果 CommonJS 模块直接放到浏览器中是无法执行的。当然, 业界也产生了 <a href="https://link.juejin.cn/?target=https%3A%2F%2Fgithub.com%2Fbrowserify%2Fbrowserify" target="_blank" rel="noopener noreferrer">browserify<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 这种打包工具来支持打包 CommonJS 模块，从而顺利在浏览器中执行，相当于社区实现了一个第三方的 loader。</li> <li>CommonJS 本身约定以同步的方式进行模块加载，这种加载机制放在服务端是没问题的，一来模块都在本地，不需要进行网络 IO，二来只有服务启动时才会加载模块，而服务通常启动后会一直运行，所以对服务的性能并没有太大的影响。但如果这种加载机制放到浏览器端，会带来明显的性能问题。它会产生大量同步的模块请求，浏览器要等待响应返回后才能继续解析模块。也就是说，<strong>模块请求会造成浏览器 JS 解析过程的阻塞</strong>，导致页面加载速度缓慢。</li></ol> <p>CommonJS 是一个不太适合在浏览器中运行的模块规范。</p> <h2 id="amd-规范"><a href="#amd-规范" class="header-anchor">#</a> AMD 规范</h2> <p><code>AMD</code>全称为<code>Asynchronous Module Definition</code>，即异步模块定义规范。模块根据这个规范，在浏览器环境中会被异步加载，而不会像 CommonJS 规范进行同步加载，也就不会产生同步请求导致的浏览器解析过程阻塞的问题了。</p> <p>在 AMD 规范当中，我们可以通过 define 去定义或加载一个模块，比如上面的 <code>main</code> 模块和<code>print</code>模块，如果模块需要导出一些成员需要通过在定义模块的函数中 return 出去(参考 <code>print</code> 模块)，如果当前模块依赖了一些其它的模块则可以通过 define 的第一个参数来声明依赖(参考<code>main</code>模块)，这样模块的代码执行之前浏览器会先<strong>加载依赖模块</strong>。</p> <p>过 require 与 define 的区别在于前者只能加载模块，而<code>不能定义一个模块</code>。由于没有得到浏览器的原生支持，AMD 规范需要由第三方的 loader 来实现，最经典的就是 <a href="https://link.juejin.cn/?target=https%3A%2F%2Fgithub.com%2Frequirejs%2Frequirejs" target="_blank" rel="noopener noreferrer">requireJS<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 库了，它完整实现了 AMD 规范，至今仍然有不少项目在使用。</p> <p>不过 AMD 规范使用起来稍显复杂，代码阅读和书写都比较困难。因此，这个规范并不能成为前端模块化的终极解决方案，仅仅是社区中提出的一个妥协性的方案，关于新的模块化规范的探索，业界从仍未停止脚步。同期出现的规范当中也有 CMD 规范，这个规范是由淘宝出品的<code>SeaJS</code>实现的，解决的问题和 AMD 一样。不过随着社区的不断发展，SeaJS 已经被<code>requireJS</code>兼容了。</p> <h2 id="umd-规范"><a href="#umd-规范" class="header-anchor">#</a> UMD 规范</h2> <p><code>UMD</code> (Universal Module Definition)规范，其实它并不算一个新的规范，只是兼容 AMD 和 CommonJS 的一个模块化方案，可以同时运行在浏览器和 Node.js 环境。顺便提一句，后面将要介绍的 ES Module 也具备这种跨平台的能力。</p> <h2 id="es-module"><a href="#es-module" class="header-anchor">#</a> ES Module</h2> <p><code>ES6 Module</code> 也被称作 <code>ES Module</code>(或 <code>ESM</code>)， 是由 ECMAScript 官方提出的模块化规范，作为一个官方提出的规范，<code>ES Module</code> 已经得到了现代浏览器的内置支持。在现代浏览器中，如果在 HTML 中加入含有<code>type=&quot;module&quot;</code>属性的 script 标签，那么浏览器会按照 ES Module 规范来进行依赖加载和模块解析，这也是 Vite 在开发阶段实现 no-bundle 的原因，由于模块加载的任务交给了浏览器，即使不打包也可以顺利运行模块代码。</p> <p>大家可能会担心 ES Module 的兼容性问题，其实 ES Module 的浏览器兼容性如今已经相当好了，覆盖了 90% 以上的浏览器份额。不仅如此，一直以 CommonJS 作为模块标准的 Node.js 也紧跟 ES Module 的发展步伐，从 <code>12.20</code> 版本开始<a href="https://link.juejin.cn/?target=https%3A%2F%2Fnodejs.org%2Fapi%2Fesm.html%23modules-ecmascript-modules" target="_blank" rel="noopener noreferrer">正式支持<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>原生 ES Module。也就是说，如今 ES Module 能够同时在浏览器与 Node.js 环境中执行，拥有天然的跨平台能力。</p> <h3 id="esm-高级特性"><a href="#esm-高级特性" class="header-anchor">#</a> ESM 高级特性</h3> <h4 id="import-map"><a href="#import-map" class="header-anchor">#</a> import map</h4> <p>在浏览器中我们可以使用包含type=&quot;module&quot;属性的script标签来加载 ES 模块，而模块路径主要包含三种:</p> <ul><li>绝对路径，如 <a href="https://cdn.skypack.dev/react" target="_blank" rel="noopener noreferrer">https://cdn.skypack.dev/react<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li>相对路径，如 ./module-a</li> <li>bare import 即直接写一个第三方包名，如 react、lodash</li></ul> <p>对于前两种模块路径浏览器是原生支持的，而对于 bare import，在 Node.js 能直接执行，因为 Node.js 的路径解析算法会从项目的 node_modules 找到第三方包的模块路径，但是放在浏览器中无法直接执行。而这种写法在日常开发的过程又极为常见，除了将 bare import 手动替换为一个绝对路径，还有其它的解决方案吗？</p> <p>现代浏览器内置的 import map 就是为了解决上述的问题，我们可以用一个简单的例子来使用这个特性:</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token operator">&lt;</span><span class="token operator">!</span><span class="token constant">DOCTYPE</span> html<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>html lang<span class="token operator">=</span><span class="token string">&quot;en&quot;</span><span class="token operator">&gt;</span>

<span class="token operator">&lt;</span>head<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>meta charset<span class="token operator">=</span><span class="token string">&quot;UTF-8&quot;</span><span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>meta http<span class="token operator">-</span>equiv<span class="token operator">=</span><span class="token string">&quot;X-UA-Compatible&quot;</span> content<span class="token operator">=</span><span class="token string">&quot;IE=edge&quot;</span><span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>meta name<span class="token operator">=</span><span class="token string">&quot;viewport&quot;</span> content<span class="token operator">=</span><span class="token string">&quot;width=device-width, initial-scale=1.0&quot;</span><span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>title<span class="token operator">&gt;</span>Document<span class="token operator">&lt;</span><span class="token operator">/</span>title<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>head<span class="token operator">&gt;</span>

<span class="token operator">&lt;</span>body<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>div id<span class="token operator">=</span><span class="token string">&quot;root&quot;</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>script type<span class="token operator">=</span><span class="token string">&quot;importmap&quot;</span><span class="token operator">&gt;</span>
  <span class="token punctuation">{</span>
    <span class="token string">&quot;imports&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token string">&quot;react&quot;</span><span class="token operator">:</span> <span class="token string">&quot;https://cdn.skypack.dev/react&quot;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>

  <span class="token operator">&lt;</span>script type<span class="token operator">=</span><span class="token string">&quot;module&quot;</span><span class="token operator">&gt;</span>
    <span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>React<span class="token punctuation">)</span>
  <span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>body<span class="token operator">&gt;</span>

<span class="token operator">&lt;</span><span class="token operator">/</span>html<span class="token operator">&gt;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br></div></div><p>在支持 import map的浏览器中，在遇到type=&quot;importmap&quot;的 script 标签时，浏览器会记录下第三方包的路径映射表，在遇到bare import时会根据这张表拉取远程的依赖代码。如上述的例子中，我们使用 skypack这个第三方的 ESM CDN 服务，通过<a href="https://cdn.skypack.dev/react%E8%BF%99%E4%B8%AA%E5%9C%B0%E5%9D%80%E6%88%91%E4%BB%AC%E5%8F%AF%E4%BB%A5%E6%8B%BF%E5%88%B0" target="_blank" rel="noopener noreferrer">https://cdn.skypack.dev/react这个地址我们可以拿到<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> React 的 ESM 格式产物。</p> <p>import map特性虽然简洁方便，但浏览器的兼容性却是个大问题。它只能兼容市面上 68% 左右的浏览器份额，而反观type=&quot;module&quot;的兼容性(兼容 95% 以上的浏览器)，import map的兼容性实属不太乐观。但幸运的是，社区已经有了对应的 Polyfill 解决方案——<a href="https://link.juejin.cn/?target=https%3A%2F%2Fgithub.com%2Fguybedford%2Fes-module-shims" target="_blank" rel="noopener noreferrer">es-module-shims<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>，完整地实现了包含 import map在内的各大 ESM 特性，还包括:</p> <ol><li>dynamic import。即动态导入，部分老版本的 Firefox 和 Edge 不支持。</li> <li>import.meta和import.meta.url。当前模块的元信息，类似 Node.js 中的 __dirname、__filename。</li> <li>modulepreload。以前我们会在 link 标签中加上 rel=&quot;preload&quot; 来进行资源预加载，即在浏览器解析 HTML 之前就开始加载资源，现在对于 ESM 也有对应的modulepreload来支持这个行为。</li> <li>JSON Modules和 CSS Modules，即通过如下方式来引入json或者css</li></ol> <p>值得一提的是，es-module-shims 基于 wasm 实现，性能并不差，相比浏览器原生的行为没有明显的性能下降。</p> <h4 id="nodejs-包导入导出策略"><a href="#nodejs-包导入导出策略" class="header-anchor">#</a> Nodejs 包导入导出策略</h4> <p>在 Node.js 中(&gt;=12.20 版本)有一般如下几种方式可以使用原生 ES Module:</p> <ul><li>文件以 .mjs 结尾；</li> <li>package.json 中声明type: &quot;module&quot;。</li></ul> <p>那么，Nodejs 在处理 ES Module 导入导出的时候，如果是处理 npm 包级别的情况，其中的细节可能比你想象中更加复杂：</p> <p>main和 exports属性。这两个属性均来自于package.json，并且根据 Node 官方的 resolve 算法(<a href="https://link.juejin.cn/?target=http%3A%2F%2Fnodejs.cn%2Fapi%2Fesm.html%23resolver-algorithm-specification" target="_blank" rel="noopener noreferrer">查看详情<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>)，exports 的优先级比 main 更高，也就是说如果你同时设置了这两个属性，那么 exports会优先生效。需要重点梳理的是exports属性，它包含了多种导出形式: 默认导出、子路径导出和条件导出，这些导出形式如以下的代码所示:</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// package.json</span>
<span class="token punctuation">{</span>
  <span class="token string">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;package-a&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;module&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;exports&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token comment">// 默认导出，使用方式: import a from 'package-a'</span>
    <span class="token string">&quot;.&quot;</span><span class="token operator">:</span> <span class="token string">&quot;./dist/index.js&quot;</span><span class="token punctuation">,</span>
    <span class="token comment">// 子路径导出，使用方式: import d from 'package-a/dist'</span>
    <span class="token string">&quot;./dist&quot;</span><span class="token operator">:</span> <span class="token string">&quot;./dist/index.js&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;./dist/*&quot;</span><span class="token operator">:</span> <span class="token string">&quot;./dist/*&quot;</span><span class="token punctuation">,</span> <span class="token comment">// 这里可以使用 `*` 导出目录下所有的文件</span>
    <span class="token comment">// 条件导出，区分 ESM 和 CommonJS 引入的情况</span>
    <span class="token string">&quot;./main&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token string">&quot;import&quot;</span><span class="token operator">:</span> <span class="token string">&quot;./main.js&quot;</span><span class="token punctuation">,</span>
      <span class="token string">&quot;require&quot;</span><span class="token operator">:</span> <span class="token string">&quot;./main.cjs&quot;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p>条件导出可以包括如下常见的属性:</p> <ul><li>node: 在 Node.js 环境下适用，可以定义为嵌套条件导出</li> <li>import: 用于 import 方式导入的情况，如import(&quot;package-a&quot;);</li> <li>require: 用于 require 方式导入的情况，如require(&quot;package-a&quot;);</li> <li>default，兜底方案，如果前面的条件都没命中，则使用 default 导出的路径。</li></ul> <p>当然，条件导出还包含 types、browser、develoment、production 等属性，大家可以参考 Node.js 的<a href="https://link.juejin.cn/?target=https%3A%2F%2Fnodejs.org%2Fapi%2Fpackages.html%23conditional-exports" target="_blank" rel="noopener noreferrer">详情文档<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>，这里就不一一赘述了。</p> <h2 id="pure-esm"><a href="#pure-esm" class="header-anchor">#</a> Pure ESM</h2> <p>指的是一个是让 npm 包都提供 ESM 格式的产物，另一个是仅留下 ESM 产物，抛弃 CommonJS 等其它格式产物。</p> <p>Node.js 执行以上的原生 ESM 代码并没有问题，但反过来，如果你想在 CommonJS 中 require 一个 ES 模块，就行不通了。根本原因在于 require 是同步加载的，而 ES 模块本身具有异步加载的特性，因此两者天然互斥，即我们无法 require 一个 ES 模块。那是不是在 CommonJS 中无法引入 ES 模块了呢? 也不尽然，我们可以通过 dynamic import来引入。</p> <p>为了引入一个 ES 模块，我们必须要将原来同步的执行环境改为异步的，这就带来如下的几个问题:</p> <ol><li>如果执行环境不支持异步，CommonJS 将无法导入 ES 模块；</li> <li>jest 中不支持导入 ES 模块，测试会比较困难；</li> <li>在 tsc 中，对于 await import()语法会强制编译成 require的语法(<a href="https://link.juejin.cn/?target=https%3A%2F%2Fgithub.com%2Fmicrosoft%2FTypeScript%2Fissues%2F43329" target="_blank" rel="noopener noreferrer">详情<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>)，只能靠eval('await import()')绕过去。</li></ol> <h2 id="新一代的基础库打包器"><a href="#新一代的基础库打包器" class="header-anchor">#</a> 新一代的基础库打包器</h2> <p><code>tsup</code> 是一个基于 Esbuild 的基础库打包器，主打无配置(no config)打包。借助它我们可以轻易地打出 ESM 和 CommonJS 双格式的产物，并且可以任意使用与模块格式强相关的一些全局变量或者 API。<code>tsup</code> 在解决了双格式产物问题的同时，本身利用 Esbuild 进行打包，性能非常强悍，也能生成类型文件，同时也弥补了 Esbuild 没有类型系统的缺点</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/blog/devops/webpack/tree-shaking.html" class="prev">
        Tree Shaking
      </a></span> <span class="next"><a href="/blog/devops/vite/css.html">
        CSS 工程化
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----><!----><!----><!----></div></div>
    <script src="/blog/assets/js/app.868312f0.js" defer></script><script src="/blog/assets/js/2.8bf77cff.js" defer></script><script src="/blog/assets/js/80.25ff7a89.js" defer></script><script src="/blog/assets/js/4.ff6074e9.js" defer></script>
  </body>
</html>
