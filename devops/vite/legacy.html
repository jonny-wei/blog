<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>兼容性问题 | 前端那些事儿</title>
    <meta name="generator" content="VuePress 1.9.10">
    <link rel="icon" href="/blog/logo.png">
    <link rel="manifest" href="/blog/manifest.json">
    <link rel="apple-touch-icon" href="/blog/images/icons/apple-icon-152x152.png">
    <meta name="description" content="我命由我不由天，学习吧少年">
    <meta name="theme-color" content="#3eaf7c">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="msapplication-TileImage" content="/icons/ms-icon-144x144.png">
    <meta name="msapplication-TileColor" content="#000000">
    
    <link rel="preload" href="/blog/assets/css/0.styles.7b6e3ec2.css" as="style"><link rel="preload" href="/blog/assets/js/app.e9b7ea63.js" as="script"><link rel="preload" href="/blog/assets/js/2.dec2e75d.js" as="script"><link rel="preload" href="/blog/assets/js/1.5b9e135c.js" as="script"><link rel="preload" href="/blog/assets/js/103.849d9dd6.js" as="script"><link rel="preload" href="/blog/assets/js/20.badbb211.js" as="script"><link rel="prefetch" href="/blog/assets/js/10.cc7e09f3.js"><link rel="prefetch" href="/blog/assets/js/100.337ef741.js"><link rel="prefetch" href="/blog/assets/js/101.1257f2fc.js"><link rel="prefetch" href="/blog/assets/js/102.131f1e86.js"><link rel="prefetch" href="/blog/assets/js/104.552a90e6.js"><link rel="prefetch" href="/blog/assets/js/105.ac2e5d37.js"><link rel="prefetch" href="/blog/assets/js/106.7af79b20.js"><link rel="prefetch" href="/blog/assets/js/107.d6020f8b.js"><link rel="prefetch" href="/blog/assets/js/108.21caa9f0.js"><link rel="prefetch" href="/blog/assets/js/109.0eb1751c.js"><link rel="prefetch" href="/blog/assets/js/11.b60c9933.js"><link rel="prefetch" href="/blog/assets/js/110.8d2fbecf.js"><link rel="prefetch" href="/blog/assets/js/111.20943a01.js"><link rel="prefetch" href="/blog/assets/js/112.cab8e641.js"><link rel="prefetch" href="/blog/assets/js/113.f1eca1b4.js"><link rel="prefetch" href="/blog/assets/js/114.894abd93.js"><link rel="prefetch" href="/blog/assets/js/115.85624fa4.js"><link rel="prefetch" href="/blog/assets/js/116.c5a70ef7.js"><link rel="prefetch" href="/blog/assets/js/117.4453d953.js"><link rel="prefetch" href="/blog/assets/js/118.eefb56cd.js"><link rel="prefetch" href="/blog/assets/js/119.b14d6450.js"><link rel="prefetch" href="/blog/assets/js/12.c53283e7.js"><link rel="prefetch" href="/blog/assets/js/120.cbb7c7cd.js"><link rel="prefetch" href="/blog/assets/js/121.9b31b1a5.js"><link rel="prefetch" href="/blog/assets/js/122.f43b9cef.js"><link rel="prefetch" href="/blog/assets/js/123.257fe662.js"><link rel="prefetch" href="/blog/assets/js/124.4011ea82.js"><link rel="prefetch" href="/blog/assets/js/125.d1e8e0d9.js"><link rel="prefetch" href="/blog/assets/js/126.448fca54.js"><link rel="prefetch" href="/blog/assets/js/127.0f8042b6.js"><link rel="prefetch" href="/blog/assets/js/128.369941f3.js"><link rel="prefetch" href="/blog/assets/js/129.c409f907.js"><link rel="prefetch" href="/blog/assets/js/13.6bdc6b5d.js"><link rel="prefetch" href="/blog/assets/js/130.d645057b.js"><link rel="prefetch" href="/blog/assets/js/131.45ccfc83.js"><link rel="prefetch" href="/blog/assets/js/132.044b86a9.js"><link rel="prefetch" href="/blog/assets/js/133.ce9418b3.js"><link rel="prefetch" href="/blog/assets/js/134.c068e9d4.js"><link rel="prefetch" href="/blog/assets/js/135.cb875c47.js"><link rel="prefetch" href="/blog/assets/js/136.dded7b9f.js"><link rel="prefetch" href="/blog/assets/js/137.aa92a0ec.js"><link rel="prefetch" href="/blog/assets/js/138.c6ae5afe.js"><link rel="prefetch" href="/blog/assets/js/139.afd9803d.js"><link rel="prefetch" href="/blog/assets/js/14.c3201a23.js"><link rel="prefetch" href="/blog/assets/js/140.bfa6c1fe.js"><link rel="prefetch" href="/blog/assets/js/141.80ba11c6.js"><link rel="prefetch" href="/blog/assets/js/142.280c9b87.js"><link rel="prefetch" href="/blog/assets/js/143.84572423.js"><link rel="prefetch" href="/blog/assets/js/144.d60eabb4.js"><link rel="prefetch" href="/blog/assets/js/145.ee097aff.js"><link rel="prefetch" href="/blog/assets/js/146.1ee847d6.js"><link rel="prefetch" href="/blog/assets/js/147.0d80f645.js"><link rel="prefetch" href="/blog/assets/js/148.248ec39a.js"><link rel="prefetch" href="/blog/assets/js/149.abe65cfb.js"><link rel="prefetch" href="/blog/assets/js/15.a0b9e44e.js"><link rel="prefetch" href="/blog/assets/js/150.9b4cbf0f.js"><link rel="prefetch" href="/blog/assets/js/151.83597e3e.js"><link rel="prefetch" href="/blog/assets/js/152.4276f94d.js"><link rel="prefetch" href="/blog/assets/js/153.14722280.js"><link rel="prefetch" href="/blog/assets/js/154.dd293d18.js"><link rel="prefetch" href="/blog/assets/js/155.0ad6ffac.js"><link rel="prefetch" href="/blog/assets/js/156.765a7f18.js"><link rel="prefetch" href="/blog/assets/js/157.02f08cdb.js"><link rel="prefetch" href="/blog/assets/js/158.6e0bf1c0.js"><link rel="prefetch" href="/blog/assets/js/159.e50fb630.js"><link rel="prefetch" href="/blog/assets/js/16.491191e4.js"><link rel="prefetch" href="/blog/assets/js/160.479a263e.js"><link rel="prefetch" href="/blog/assets/js/161.3d7e9515.js"><link rel="prefetch" href="/blog/assets/js/162.45499727.js"><link rel="prefetch" href="/blog/assets/js/163.45bdc0ec.js"><link rel="prefetch" href="/blog/assets/js/164.eeb4f26d.js"><link rel="prefetch" href="/blog/assets/js/165.e8ec1a69.js"><link rel="prefetch" href="/blog/assets/js/166.09e4c5ba.js"><link rel="prefetch" href="/blog/assets/js/167.682e9c17.js"><link rel="prefetch" href="/blog/assets/js/168.a80229c6.js"><link rel="prefetch" href="/blog/assets/js/169.bacba512.js"><link rel="prefetch" href="/blog/assets/js/17.89ec8c57.js"><link rel="prefetch" href="/blog/assets/js/170.1cec8dd4.js"><link rel="prefetch" href="/blog/assets/js/171.0089fe1a.js"><link rel="prefetch" href="/blog/assets/js/172.ea5262e4.js"><link rel="prefetch" href="/blog/assets/js/173.7875bea9.js"><link rel="prefetch" href="/blog/assets/js/174.7aa99a96.js"><link rel="prefetch" href="/blog/assets/js/175.28492d4b.js"><link rel="prefetch" href="/blog/assets/js/176.c79421e2.js"><link rel="prefetch" href="/blog/assets/js/177.1a2283d9.js"><link rel="prefetch" href="/blog/assets/js/178.ad2555ad.js"><link rel="prefetch" href="/blog/assets/js/179.b576f82d.js"><link rel="prefetch" href="/blog/assets/js/18.b91f1411.js"><link rel="prefetch" href="/blog/assets/js/180.7aa47869.js"><link rel="prefetch" href="/blog/assets/js/181.b82bb8f4.js"><link rel="prefetch" href="/blog/assets/js/182.ed725fa4.js"><link rel="prefetch" href="/blog/assets/js/183.5a57b1b7.js"><link rel="prefetch" href="/blog/assets/js/184.850c643c.js"><link rel="prefetch" href="/blog/assets/js/185.a1629294.js"><link rel="prefetch" href="/blog/assets/js/186.4c59b35b.js"><link rel="prefetch" href="/blog/assets/js/187.b1ee21ec.js"><link rel="prefetch" href="/blog/assets/js/188.e6e1009d.js"><link rel="prefetch" href="/blog/assets/js/189.d4c24933.js"><link rel="prefetch" href="/blog/assets/js/19.cb1f17c8.js"><link rel="prefetch" href="/blog/assets/js/190.52af3d91.js"><link rel="prefetch" href="/blog/assets/js/191.daac205d.js"><link rel="prefetch" href="/blog/assets/js/192.8735a570.js"><link rel="prefetch" href="/blog/assets/js/193.0619ad3e.js"><link rel="prefetch" href="/blog/assets/js/194.83e05501.js"><link rel="prefetch" href="/blog/assets/js/195.d3c64566.js"><link rel="prefetch" href="/blog/assets/js/196.bff584ec.js"><link rel="prefetch" href="/blog/assets/js/197.2db9e539.js"><link rel="prefetch" href="/blog/assets/js/198.2cde63d5.js"><link rel="prefetch" href="/blog/assets/js/199.01c57daa.js"><link rel="prefetch" href="/blog/assets/js/200.c5041eec.js"><link rel="prefetch" href="/blog/assets/js/201.a3c96a9f.js"><link rel="prefetch" href="/blog/assets/js/202.c382b0c1.js"><link rel="prefetch" href="/blog/assets/js/203.56dd6c0b.js"><link rel="prefetch" href="/blog/assets/js/204.cd7bd9b2.js"><link rel="prefetch" href="/blog/assets/js/205.f8ba82b1.js"><link rel="prefetch" href="/blog/assets/js/206.1f62843b.js"><link rel="prefetch" href="/blog/assets/js/207.91b1d1d9.js"><link rel="prefetch" href="/blog/assets/js/208.e8d0fc56.js"><link rel="prefetch" href="/blog/assets/js/209.f4613282.js"><link rel="prefetch" href="/blog/assets/js/21.bf0041b7.js"><link rel="prefetch" href="/blog/assets/js/210.27d0e36b.js"><link rel="prefetch" href="/blog/assets/js/211.0dad5495.js"><link rel="prefetch" href="/blog/assets/js/212.6ff2cec6.js"><link rel="prefetch" href="/blog/assets/js/22.48390d4f.js"><link rel="prefetch" href="/blog/assets/js/23.35c4ba93.js"><link rel="prefetch" href="/blog/assets/js/24.5dc212cd.js"><link rel="prefetch" href="/blog/assets/js/25.01cde98b.js"><link rel="prefetch" href="/blog/assets/js/26.51647c2f.js"><link rel="prefetch" href="/blog/assets/js/27.b0efe319.js"><link rel="prefetch" href="/blog/assets/js/28.6ae36e8b.js"><link rel="prefetch" href="/blog/assets/js/29.09981e94.js"><link rel="prefetch" href="/blog/assets/js/3.cb0627fa.js"><link rel="prefetch" href="/blog/assets/js/30.bcafbd5b.js"><link rel="prefetch" href="/blog/assets/js/31.b99dc8e5.js"><link rel="prefetch" href="/blog/assets/js/32.aaa83642.js"><link rel="prefetch" href="/blog/assets/js/33.84478543.js"><link rel="prefetch" href="/blog/assets/js/34.fa4f18d6.js"><link rel="prefetch" href="/blog/assets/js/35.0835b775.js"><link rel="prefetch" href="/blog/assets/js/36.8f409625.js"><link rel="prefetch" href="/blog/assets/js/37.37e725fb.js"><link rel="prefetch" href="/blog/assets/js/38.f70df6b0.js"><link rel="prefetch" href="/blog/assets/js/39.c62ad3ad.js"><link rel="prefetch" href="/blog/assets/js/4.cbb57fa7.js"><link rel="prefetch" href="/blog/assets/js/40.fa1e4cd7.js"><link rel="prefetch" href="/blog/assets/js/41.b0b54a79.js"><link rel="prefetch" href="/blog/assets/js/42.38f97c50.js"><link rel="prefetch" href="/blog/assets/js/43.c0d731cf.js"><link rel="prefetch" href="/blog/assets/js/44.1ada494a.js"><link rel="prefetch" href="/blog/assets/js/45.f9f0d1d3.js"><link rel="prefetch" href="/blog/assets/js/46.f61ebf44.js"><link rel="prefetch" href="/blog/assets/js/47.1e3244f7.js"><link rel="prefetch" href="/blog/assets/js/48.d5d6e9cf.js"><link rel="prefetch" href="/blog/assets/js/49.874c0d73.js"><link rel="prefetch" href="/blog/assets/js/5.fe065607.js"><link rel="prefetch" href="/blog/assets/js/50.2bde8ac3.js"><link rel="prefetch" href="/blog/assets/js/51.e6c26277.js"><link rel="prefetch" href="/blog/assets/js/52.b5171a6c.js"><link rel="prefetch" href="/blog/assets/js/53.5e07287e.js"><link rel="prefetch" href="/blog/assets/js/54.33ff2540.js"><link rel="prefetch" href="/blog/assets/js/55.ec9542b6.js"><link rel="prefetch" href="/blog/assets/js/56.d99bf778.js"><link rel="prefetch" href="/blog/assets/js/57.6f4b13ff.js"><link rel="prefetch" href="/blog/assets/js/58.63a8354d.js"><link rel="prefetch" href="/blog/assets/js/59.af80b9ec.js"><link rel="prefetch" href="/blog/assets/js/6.68cda050.js"><link rel="prefetch" href="/blog/assets/js/60.63c1fc8d.js"><link rel="prefetch" href="/blog/assets/js/61.b3a0847f.js"><link rel="prefetch" href="/blog/assets/js/62.4ae929a2.js"><link rel="prefetch" href="/blog/assets/js/63.0f8029d4.js"><link rel="prefetch" href="/blog/assets/js/64.69daf65d.js"><link rel="prefetch" href="/blog/assets/js/65.cd1bf692.js"><link rel="prefetch" href="/blog/assets/js/66.5c506ec8.js"><link rel="prefetch" href="/blog/assets/js/67.e76ea4c3.js"><link rel="prefetch" href="/blog/assets/js/68.50e5e983.js"><link rel="prefetch" href="/blog/assets/js/69.d3d5ee70.js"><link rel="prefetch" href="/blog/assets/js/7.3b8d63a0.js"><link rel="prefetch" href="/blog/assets/js/70.9d2c5ae6.js"><link rel="prefetch" href="/blog/assets/js/71.1ff968ec.js"><link rel="prefetch" href="/blog/assets/js/72.a5c66acf.js"><link rel="prefetch" href="/blog/assets/js/73.beb7a9f7.js"><link rel="prefetch" href="/blog/assets/js/74.30f7ec1e.js"><link rel="prefetch" href="/blog/assets/js/75.50b2e636.js"><link rel="prefetch" href="/blog/assets/js/76.e4a2de98.js"><link rel="prefetch" href="/blog/assets/js/77.695fe053.js"><link rel="prefetch" href="/blog/assets/js/78.91e5a782.js"><link rel="prefetch" href="/blog/assets/js/79.b216b823.js"><link rel="prefetch" href="/blog/assets/js/80.c2247050.js"><link rel="prefetch" href="/blog/assets/js/81.f167f26a.js"><link rel="prefetch" href="/blog/assets/js/82.b4d5e9c9.js"><link rel="prefetch" href="/blog/assets/js/83.297d7d3d.js"><link rel="prefetch" href="/blog/assets/js/84.7f7e2cd1.js"><link rel="prefetch" href="/blog/assets/js/85.72b43fe6.js"><link rel="prefetch" href="/blog/assets/js/86.0b4102e0.js"><link rel="prefetch" href="/blog/assets/js/87.707e49df.js"><link rel="prefetch" href="/blog/assets/js/88.d3bd696a.js"><link rel="prefetch" href="/blog/assets/js/89.9c611b54.js"><link rel="prefetch" href="/blog/assets/js/90.001805e9.js"><link rel="prefetch" href="/blog/assets/js/91.3b5b43f2.js"><link rel="prefetch" href="/blog/assets/js/92.70cd30f9.js"><link rel="prefetch" href="/blog/assets/js/93.4e138a06.js"><link rel="prefetch" href="/blog/assets/js/94.0d5ed05c.js"><link rel="prefetch" href="/blog/assets/js/95.07a70e9a.js"><link rel="prefetch" href="/blog/assets/js/96.34b29a24.js"><link rel="prefetch" href="/blog/assets/js/97.af74319a.js"><link rel="prefetch" href="/blog/assets/js/98.f2f367d9.js"><link rel="prefetch" href="/blog/assets/js/99.a1c21720.js"><link rel="prefetch" href="/blog/assets/js/vendors~docsearch.bd3cdb54.js">
    <link rel="stylesheet" href="/blog/assets/css/0.styles.7b6e3ec2.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/blog/" class="home-link router-link-active"><img src="/blog/logo.png" alt="前端那些事儿" class="logo"> <span class="site-name can-hide">前端那些事儿</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/blog/" class="nav-link">
  主页
</a></div><div class="nav-item"><a href="/blog/base/" class="nav-link">
  前端基础
</a></div><div class="nav-item"><a href="/blog/vue/" class="nav-link">
  Vue
</a></div><div class="nav-item"><a href="/blog/react/" class="nav-link">
  React
</a></div><div class="nav-item"><a href="/blog/node/" class="nav-link">
  Node
</a></div><div class="nav-item"><a href="/blog/devops/" class="nav-link router-link-active">
  前端工程化
</a></div><div class="nav-item"><a href="/blog/mobile/" class="nav-link">
  泛客户端
</a></div><div class="nav-item"><a href="/blog/architecture/" class="nav-link">
  架构&amp;方案
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="GitHub" class="dropdown-title"><span class="title">GitHub</span> <span class="arrow down"></span></button> <button type="button" aria-label="GitHub" class="mobile-dropdown-title"><span class="title">GitHub</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/jonny-wei" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://github.com/jonny-wei/sushi-js" target="_blank" rel="noopener noreferrer" class="nav-link external">
  JS 寿司
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/blog/" class="nav-link">
  主页
</a></div><div class="nav-item"><a href="/blog/base/" class="nav-link">
  前端基础
</a></div><div class="nav-item"><a href="/blog/vue/" class="nav-link">
  Vue
</a></div><div class="nav-item"><a href="/blog/react/" class="nav-link">
  React
</a></div><div class="nav-item"><a href="/blog/node/" class="nav-link">
  Node
</a></div><div class="nav-item"><a href="/blog/devops/" class="nav-link router-link-active">
  前端工程化
</a></div><div class="nav-item"><a href="/blog/mobile/" class="nav-link">
  泛客户端
</a></div><div class="nav-item"><a href="/blog/architecture/" class="nav-link">
  架构&amp;方案
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="GitHub" class="dropdown-title"><span class="title">GitHub</span> <span class="arrow down"></span></button> <button type="button" aria-label="GitHub" class="mobile-dropdown-title"><span class="title">GitHub</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/jonny-wei" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://github.com/jonny-wei/sushi-js" target="_blank" rel="noopener noreferrer" class="nav-link external">
  JS 寿司
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Webpack</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/devops/" aria-current="page" class="sidebar-link">Webpack 常用配置</a></li><li><a href="/blog/devops/webpack/building.html" class="sidebar-link">构建流程与原理</a></li><li><a href="/blog/devops/webpack/dependency-graph.html" class="sidebar-link">模块依赖关系</a></li><li><a href="/blog/devops/webpack/chunk.html" class="sidebar-link">产物打包逻辑</a></li><li><a href="/blog/devops/webpack/compile.html" class="sidebar-link">模块编译及运行时</a></li><li><a href="/blog/devops/webpack/hmr.html" class="sidebar-link">HMR 热更新</a></li><li><a href="/blog/devops/webpack/loader.html" class="sidebar-link">Webpack Loader</a></li><li><a href="/blog/devops/webpack/plugin.html" class="sidebar-link">Webpack Plugin</a></li><li><a href="/blog/devops/webpack/module-federation.html" class="sidebar-link">模块联邦</a></li><li><a href="/blog/devops/webpack/cache.html" class="sidebar-link">持久化缓存</a></li><li><a href="/blog/devops/webpack/parallel.html" class="sidebar-link">并行构建</a></li><li><a href="/blog/devops/webpack/split-chunks.html" class="sidebar-link">分包策略</a></li><li><a href="/blog/devops/webpack/compress.html" class="sidebar-link">代码压缩</a></li><li><a href="/blog/devops/webpack/tree-shaking.html" class="sidebar-link">Tree Shaking</a></li><li><a href="/blog/devops/webpack/others.html" class="sidebar-link">Webpack 相关</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Vite</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/devops/vite/esm.html" class="sidebar-link">模块化规范</a></li><li><a href="/blog/devops/vite/css.html" class="sidebar-link">CSS 工程化</a></li><li><a href="/blog/devops/vite/prebuild.html" class="sidebar-link">依赖预构建</a></li><li><a href="/blog/devops/vite/engines.html" class="sidebar-link">双引擎架构</a></li><li><a href="/blog/devops/vite/rollup.html" class="sidebar-link">Rollup 打包</a></li><li><a href="/blog/devops/vite/building.html" class="sidebar-link">Vite 构建原理</a></li><li><a href="/blog/devops/vite/plugin.html" class="sidebar-link">Vite Plugin</a></li><li><a href="/blog/devops/vite/hmr.html" class="sidebar-link">Vite HMR 热更新</a></li><li><a href="/blog/devops/vite/ssr.html" class="sidebar-link">SSR 工程化</a></li><li><a href="/blog/devops/vite/legacy.html" aria-current="page" class="active sidebar-link">兼容性问题</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/devops/vite/legacy.html#底层工具链" class="sidebar-link">底层工具链</a></li><li class="sidebar-sub-header"><a href="/blog/devops/vite/legacy.html#vite-语法降级与-polyfill-注入" class="sidebar-link">Vite 语法降级与 Polyfill 注入</a></li></ul></li><li><a href="/blog/devops/vite/split-code.html" class="sidebar-link">代码分割</a></li><li><a href="/blog/devops/vite/mini.html" class="sidebar-link">Vite Mini 实现</a></li><li><a href="/blog/devops/vite/vite-news.html" class="sidebar-link">Vite 新特性</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>性能优化</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/devops/performance/indicator.html" class="sidebar-link">性能指标与采集</a></li><li><a href="/blog/devops/performance/webpack.html" class="sidebar-link">打包方面优化</a></li><li><a href="/blog/devops/performance/network.html" class="sidebar-link">网络方面优化</a></li><li><a href="/blog/devops/performance/render.html" class="sidebar-link">渲染方面优化</a></li><li><a href="/blog/devops/performance/code.html" class="sidebar-link">代码方面优化</a></li><li><a href="/blog/devops/performance/analysis.html" class="sidebar-link">打包性能分析工具</a></li><li><a href="/blog/devops/performance/optimization.html" class="sidebar-link">指标性能优化</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>代码与包管理</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/devops/git/git.html" class="sidebar-link">Git</a></li><li><a href="/blog/devops/git/package.html" class="sidebar-link">认识 package.json</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="兼容性问题"><a href="#兼容性问题" class="header-anchor">#</a> 兼容性问题</h1> <p>通过 Vite 构建我们完全可以兼容各种低版本浏览器，打包出既支持现代(<code>Modern</code>)浏览器又支持旧版(<code>Legacy</code>)浏览器的产物。接下来分析为什么在 Vite 中能够彻底解决低版本浏览器的兼容性问题，以及通过什么手段解决，需要借助哪些 JS 的工具和生态？</p> <p>某些低版本浏览器并没有提供 <code>Promise</code> 语法环境以及对象和数组的各种 API，甚至不支持箭头函数语法，代码直接报错，从而导致线上白屏事故的发生，尤其是需要兼容到<code>IE 11</code>、<code>iOS 9</code>以及<code>Android 4.4</code>的场景中很容易会遇到。</p> <p>旧版浏览器的语法兼容问题主要分两类: <strong>语法降级问题</strong>和 <strong>Polyfill 缺失问题</strong>。前者比较好理解，比如某些浏览器不支持箭头函数，我们就需要将其转换为<code>function(){}</code>语法；而对后者来说，<code>Polyfill</code>本身可以翻译为<code>垫片</code>，也就是为浏览器提前注入一些 API 的实现代码，如<code>Object.entries</code>方法的实现，这样可以保证产物可以正常使用这些 API，防止报错。</p> <p>这两类问题本质上是通过前端的编译工具链(如<code>Babel</code>)及 JS 的基础 Polyfill 库(如<code>corejs</code>)来解决的，不会跟具体的构建工具所绑定。也就是说，对于这些本质的解决方案，在其它的构建工具(如 Webpack)能使用，在 Vite 当中也完全可以使用。</p> <h2 id="底层工具链"><a href="#底层工具链" class="header-anchor">#</a> 底层工具链</h2> <h3 id="工具"><a href="#工具" class="header-anchor">#</a> 工具</h3> <p>解决上述提到的两类语法兼容问题，主要需要用到两方面的工具，分别包括:</p> <ul><li><strong>编译时工具</strong>。代表工具有<code>@babel/preset-env</code>和<code>@babel/plugin-transform-runtime</code>。</li> <li><strong>运行时基础库</strong>。代表库包括<code>core-js</code>和<code>regenerator-runtime</code>。</li></ul> <p><strong>编译时工具</strong>的作用是在代码编译阶段进行<strong>语法降级</strong>及<strong>添加 <code>polyfill</code> 代码的引用语句</strong>，如:</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token keyword">import</span> <span class="token string">&quot;core-js/modules/es6.set.js&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>由于这些工具只是编译阶段用到，运行时并不需要，我们需要将其放入<code>package.json</code>中的<code>devDependencies</code>中。</p> <p>而<strong>运行时基础库</strong>是根据 <code>ESMAScript</code>官方语言规范提供各种<code>Polyfill</code>实现代码，主要包括<code>core-js</code>和<code>regenerator-runtime</code>两个基础库，不过在 babel 中也会有一些上层的封装，包括：</p> <ul><li><a href="https://link.juejin.cn/?target=https%3A%2F%2Fbabeljs.io%2Fdocs%2Fen%2Fbabel-polyfill" target="_blank" rel="noopener noreferrer">@babel/polyfill<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://link.juejin.cn/?target=https%3A%2F%2Fbabeljs.io%2Fdocs%2Fen%2Fbabel-runtime" target="_blank" rel="noopener noreferrer">@babel/runtime<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://link.juejin.cn/?target=https%3A%2F%2Fbabeljs.io%2Fdocs%2Fen%2Fbabel-runtime-corejs2" target="_blank" rel="noopener noreferrer">@babel/runtime-corejs2<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://link.juejin.cn/?target=https%3A%2F%2Fbabeljs.io%2Fdocs%2Fen%2Fbabel-runtime-corejs3" target="_blank" rel="noopener noreferrer">@babel/runtime-corejs3<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 看似各种运行时库眼花缭乱，其实都是<code>core-js</code>和<code>regenerator-runtime</code>不同版本的封装罢了(<code>@babel/runtime</code>是个特例，不包含 core-js 的 Polyfill)。这类库是项目运行时必须要使用到的，因此一定要放到<code>package.json</code>中的<code>dependencies</code>中。</li></ul> <h3 id="实践"><a href="#实践" class="header-anchor">#</a> 实践</h3> <ul><li><code>@babel/cli</code>: 为 babel 官方的脚手架工具，很适合我们练习用。</li> <li><code>@babel/core</code>: babel 核心编译库。</li> <li><code>@babel/preset-env</code>: babel 的预设工具集，基本为 babel 必装的库。</li></ul> <div class="language-js line-numbers-mode"><pre class="language-js"><code>pnpm i @babel<span class="token operator">/</span>cli @babel<span class="token operator">/</span>core @babel<span class="token operator">/</span>preset<span class="token operator">-</span>env

<span class="token comment">// .babelrc.json</span>
<span class="token punctuation">{</span>
  <span class="token string-property property">&quot;presets&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">[</span>
      <span class="token string">&quot;@babel/preset-env&quot;</span><span class="token punctuation">,</span> 
      <span class="token punctuation">{</span>
        <span class="token comment">// 指定兼容的浏览器版本</span>
        <span class="token string-property property">&quot;targets&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token string-property property">&quot;ie&quot;</span><span class="token operator">:</span> <span class="token string">&quot;11&quot;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token comment">// 基础库 core-js 的版本，一般指定为最新的大版本</span>
        <span class="token string-property property">&quot;corejs&quot;</span><span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span>
        <span class="token comment">// Polyfill 注入策略，后文详细介绍</span>
        <span class="token string-property property">&quot;useBuiltIns&quot;</span><span class="token operator">:</span> <span class="token string">&quot;usage&quot;</span><span class="token punctuation">,</span>
        <span class="token comment">// 不将 ES 模块语法转换为其他模块语法</span>
        <span class="token string-property property">&quot;modules&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><p>Browserslist 是一个帮助我们设置目标浏览器的工具，不光是 Babel 用到，其他的编译工具如<code>postcss-preset-env</code>、<code>autoprefix</code>中都有所应用。对于<code>Browserslist</code>的配置内容，你既可以放到 Babel 这种特定工具当中，也可以在<code>package.json</code>中通过<code>browserslist</code>声明:</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token comment">// package.json</span>
<span class="token punctuation">{</span> 
  <span class="token string-property property">&quot;browserslist&quot;</span><span class="token operator">:</span> <span class="token string">&quot;ie &gt;= 11&quot;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>或者通过<code>.browserslistrc</code>进行声明:</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token comment">// .browserslistrc</span>
ie <span class="token operator">&gt;=</span> <span class="token number">11</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>在实际的项目中，一般我们可以将使用下面这些<strong>最佳实践集合</strong>来描述不同的浏览器类型，减轻配置负担:</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token comment">// 现代浏览器</span>
last <span class="token number">2</span> versions and since <span class="token number">2018</span> and <span class="token operator">&gt;</span> <span class="token number">0.5</span><span class="token operator">%</span>
<span class="token comment">// 兼容低版本 PC 浏览器</span>
<span class="token constant">IE</span> <span class="token operator">&gt;=</span> <span class="token number">11</span><span class="token punctuation">,</span> <span class="token operator">&gt;</span> <span class="token number">0.5</span><span class="token operator">%</span><span class="token punctuation">,</span> not dead
<span class="token comment">// 兼容低版本移动端浏览器</span>
iOS <span class="token operator">&gt;=</span> <span class="token number">9</span><span class="token punctuation">,</span> Android <span class="token operator">&gt;=</span> <span class="token number">4.4</span><span class="token punctuation">,</span> last <span class="token number">2</span> versions<span class="token punctuation">,</span> <span class="token operator">&gt;</span> <span class="token number">0.2</span><span class="token operator">%</span><span class="token punctuation">,</span> not dead
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>对于这些配置对应的具体浏览器列表，大家可以去 <a href="https://link.juejin.cn/?target=https%3A%2F%2Fbrowserslist.dev" target="_blank" rel="noopener noreferrer">browserslist.dev<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 站点查看。</p> <p>Babel 已经根据<code>目标浏览器</code>的配置为我们添加了大量的 Polyfill 代码，<code>index.js</code>文件简单的几行代码被编译成近 300 行。实际上，Babel 所做的事情就是将你的<code>import &quot;core-js&quot;</code>代码替换成了产物中的这些具体模块的导入代码。</p> <p>但这个配置有一个问题，即无法做到按需导入，上面的产物代码其实有大部分的 Polyfill 的代码我们并没有用到。Polyfill 代码主要来自 <code>corejs</code> 和 <code>regenerator-runtime</code>，因此如果要运行起来，必须要装这两个库。可以发现 Polyfill 的代码精简了许多，真正地实现了按需 Polyfill 导入。因此，在实际的使用当中，还是推荐大家尽量使用<code>useBuiltIns: &quot;usage&quot;</code>，进行按需的 Polyfill 注入。</p> <p>我们来梳理一下，上面我们利用<code>@babel/preset-env</code>进行了目标浏览器语法的降级和<code>Polyfill</code>注入，同时用到了<code>core-js</code>和<code>regenerator-runtime</code>两个核心的运行时库。但<code>@babel/preset-env</code> 的方案也存在一定局限性:</p> <ul><li>如果使用新特性，往往是通过基础库(如 core-js)往全局环境添加 Polyfill，如果是开发应用没有任何问题，如果是开发第三方工具库，则很可能会对<strong>全局空间造成污染</strong>。</li> <li>很多工具函数的实现代码(如上面示例中的<code>_defineProperty</code>方法)，会在许多文件中重现出现，造成<strong>文件体积冗余</strong>。</li></ul> <h3 id="更优的-polyfill-注入方案-transform-runtime"><a href="#更优的-polyfill-注入方案-transform-runtime" class="header-anchor">#</a> 更优的 Polyfill 注入方案: transform-runtime</h3> <p>接下来要介绍的<code>transform-runtime</code>方案，就是为了解决<code>@babel/preset-env</code>的种种局限性。需要提前说明的是，<code>transform-runtime</code>方案可以作为<code>@babel/preset-env</code>中<code>useBuiltIns</code>配置的替代品，也就是说，一旦使用<code>transform-runtime</code>方案，你应该把<code>useBuiltIns</code>属性设为 <code>false</code>。</p> <p>首先安装必要的依赖:</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code>pnpm i <span class="token decorator"><span class="token at operator">@</span><span class="token function">babel</span></span><span class="token operator">/</span>plugin<span class="token operator">-</span>transform<span class="token operator">-</span>runtime <span class="token operator">-</span><span class="token constant">D</span>
pnpm i <span class="token decorator"><span class="token at operator">@</span><span class="token function">babel</span></span><span class="token operator">/</span>runtime<span class="token operator">-</span>corejs3 <span class="token operator">-</span><span class="token constant">S</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>我解释一下这两个依赖的作用: 前者是编译时工具，用来转换语法和添加 Polyfill，后者是运行时基础库，封装了<code>core-js</code>、<code>regenerator-runtime</code>和各种语法转换用到的<code>工具函数</code>。</p> <div class="custom-block tip"><p class="custom-block-title">补充</p> <p><code>core-js</code> 有三种产物，分别是<code>core-js</code>、<code>core-js-pure</code>和<code>core-js-bundle</code>。第一种是全局 Polyfill 的做法，@babel/preset-env 就是用的这种产物；第二种不会把 Polyfill 注入到全局环境，可以按需引入；第三种是打包好的版本，包含所有的 Polyfill，不太常用。<code>@babel/runtime-corejs3</code> 使用的是第二种产物。</p></div> <p><code>.babelrc.json</code>作如下的配置:</p> <div class="language-json line-numbers-mode"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;plugins&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token comment">// 添加 transform-runtime 插件</span>
    <span class="token punctuation">[</span>
      <span class="token string">&quot;@babel/plugin-transform-runtime&quot;</span><span class="token punctuation">,</span> 
      <span class="token punctuation">{</span>
        <span class="token property">&quot;corejs&quot;</span><span class="token operator">:</span> <span class="token number">3</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token property">&quot;presets&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">[</span>
      <span class="token string">&quot;@babel/preset-env&quot;</span><span class="token punctuation">,</span> 
      <span class="token punctuation">{</span>
        <span class="token property">&quot;targets&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">&quot;ie&quot;</span><span class="token operator">:</span> <span class="token string">&quot;11&quot;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token property">&quot;corejs&quot;</span><span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span>
        <span class="token comment">// 关闭 @babel/preset-env 默认的 Polyfill 注入</span>
        <span class="token property">&quot;useBuiltIns&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
        <span class="token property">&quot;modules&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><p>经过对比我们不难发现，<code>transform-runtime</code> 一方面能够让我们在代码中使用<code>非全局版本</code>的 Polyfill，这样就避免全局空间的污染，这也得益于 <code>core-js</code> 的 pure 版本产物特性；另一方面对于<code>asyncToGeneator</code>这类的工具函数，它也将其转换成了一段引入语句，不再将完整的实现放到文件中，节省了编译后文件的体积。</p> <p>另外，<code>transform-runtime</code>方案引用的基础库也发生了变化，不再是直接引入<code>core-js</code>和<code>regenerator-runtime</code>，而是引入<code>@babel/runtime-corejs3</code>。</p> <h2 id="vite-语法降级与-polyfill-注入"><a href="#vite-语法降级与-polyfill-注入" class="header-anchor">#</a> Vite 语法降级与 Polyfill 注入</h2> <p>Vite 官方已经为我们封装好了一个开箱即用的方案: <code>@vitejs/plugin-legacy</code>，我们可以基于它来解决项目语法的浏览器兼容问题。这个插件内部同样使用 <code>@babel/preset-env</code> 以及 <code>core-js</code>等一系列基础库来进行语法降级和 Polyfill 注入，因此我觉得对于上文所介绍的底层工具链的掌握是必要的，否则无法理解插件内部所做的事情，真正遇到问题时往往会不知所措。</p> <p>首先让我们来安装一下官方的插件:</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code>pnpm i <span class="token decorator"><span class="token at operator">@</span><span class="token function">vitejs</span></span><span class="token operator">/</span>plugin<span class="token operator">-</span>legacy <span class="token operator">-</span><span class="token constant">D</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>随后在项目中使用它:</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token comment">// vite.config.ts</span>
<span class="token keyword">import</span> legacy <span class="token keyword">from</span> <span class="token string">'@vitejs/plugin-legacy'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> defineConfig <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'vite'</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token function">defineConfig</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  plugins<span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token comment">// 省略其它插件</span>
    <span class="token function">legacy</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token comment">// 设置目标浏览器，browserslist 配置语法</span>
      targets<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'ie &gt;= 11'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>我们同样可以通过<code>targets</code>指定目标浏览器，这个参数在插件内部会透传给<code>@babel/preset-env</code>。相比一般的打包过程，多出了<code>index-legacy.js</code>、<code>vendor-legacy.js</code>以及<code>polyfills-legacy.js</code>三份产物文件。</p> <p>通过官方的<code>legacy</code>插件， Vite 会分别打包出<code>Modern</code>模式和<code>Legacy</code>模式的产物，然后将两种产物插入同一个 HTML 里面，<code>Modern</code>产物被放到 <code>type=&quot;module&quot;</code>的 script 标签中，而<code>Legacy</code>产物则被放到带有 <a href="https://link.juejin.cn/?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fen-US%2Fdocs%2FWeb%2FHTML%2FElement%2Fscript%23attr-nomodule" target="_blank" rel="noopener noreferrer">nomodule<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 的 script 标签中。浏览器的加载策略如下图所示:</p> <p><img src="/blog/images/devops/vite-legacy1.png" alt="vite-legacy1"></p> <p>这样产物便就能够同时放到现代浏览器和不支持<code>type=&quot;module&quot;</code>的低版本浏览器当中执行。当然，在具体的代码语法层面，插件还需要考虑语法降级和 Polyfill 按需注入的问题，接下来我们就来分析一下 Vite 的官方<code>legacy</code>插件是如何解决这些问题的。</p> <h3 id="插件执行原理"><a href="#插件执行原理" class="header-anchor">#</a> 插件执行原理</h3> <p>官方的 legacy 插件是一个相对复杂度比较高的插件，直接看源码可能会很难理解，这里我梳理了画了一张简化后的流程图，接下来我们就根据这张流程图来一一拆解这个插件在各个钩子阶段到底做了些什么。</p> <p><img src="/blog/images/devops/vite-legacy2.png" alt="vite-legacy2"></p> <p>首先是在<code>configResolved</code>钩子中调整了<code>output</code>属性，这么做的目的是让 Vite 底层使用的打包引擎 Rollup 能另外打包出一份<code>Legacy 模式</code>的产物，实现代码如下:</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token keyword">const</span> <span class="token function-variable function">createLegacyOutput</span> <span class="token operator">=</span> <span class="token punctuation">(</span>options <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    <span class="token operator">...</span>options<span class="token punctuation">,</span>
    <span class="token comment">// system 格式产物</span>
    format<span class="token operator">:</span> <span class="token string">'system'</span><span class="token punctuation">,</span>
    <span class="token comment">// 转换效果: index.[hash].js -&gt; index-legacy.[hash].js</span>
    entryFileNames<span class="token operator">:</span> <span class="token function">getLegacyOutputFileName</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span>entryFileNames<span class="token punctuation">)</span><span class="token punctuation">,</span>
    chunkFileNames<span class="token operator">:</span> <span class="token function">getLegacyOutputFileName</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span>chunkFileNames<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> <span class="token punctuation">{</span> rollupOptions <span class="token punctuation">}</span> <span class="token operator">=</span> config<span class="token punctuation">.</span>build
<span class="token keyword">const</span> <span class="token punctuation">{</span> output <span class="token punctuation">}</span> <span class="token operator">=</span> rollupOptions
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token builtin">Array</span><span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>output<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  rollupOptions<span class="token punctuation">.</span>output <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token operator">...</span>output<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>createLegacyOutput<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">...</span>output<span class="token punctuation">]</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
  rollupOptions<span class="token punctuation">.</span>output <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token function">createLegacyOutput</span><span class="token punctuation">(</span>output<span class="token punctuation">)</span><span class="token punctuation">,</span> output <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>接着，在<code>renderChunk</code>阶段，插件会对 Legacy 模式产物进行语法转译和 Polyfill 收集，值得注意的是，这里并不会真正注入<code>Polyfill</code>，而仅仅只是收集<code>Polyfill</code>，:</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token punctuation">{</span>
  <span class="token function">renderChunk</span><span class="token punctuation">(</span>raw<span class="token punctuation">,</span> chunk<span class="token punctuation">,</span> opts<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 1. 使用 babel + @babel/preset-env 进行语法转换与 Polyfill 注入</span>
    <span class="token comment">// 2. 由于此时已经打包后的 Chunk 已经生成</span>
    <span class="token comment">//   这里需要去掉 babel 注入的 import 语句，并记录所需的 Polyfill</span>
    <span class="token comment">// 3. 最后的 Polyfill 代码将会在 generateBundle 阶段生成</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>由于场景是应用打包，这里直接使用 @babel/preset-env 的<code>useBuiltIns: 'usage'</code>来进行全局 Polyfill 的收集是比较标准的做法。</p> <p>回到 Vite 构建的主流程中，接下来会进入<code>generateChunk</code>钩子阶段，现在 Vite 会对之前收集到的<code>Polyfill</code>进行统一的打包，实现也比较精妙，主要逻辑集中在<code>buildPolyfillChunk</code>函数中:</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token comment">// 打包 Polyfill 代码</span>
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">buildPolyfillChunk</span><span class="token punctuation">(</span>
  name<span class="token punctuation">,</span>
  imports
  bundle<span class="token punctuation">,</span>
  facadeToChunkMap<span class="token punctuation">,</span>
  buildOptions<span class="token punctuation">,</span>
  externalSystemJS
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> <span class="token punctuation">{</span> minify<span class="token punctuation">,</span> assetsDir <span class="token punctuation">}</span> <span class="token operator">=</span> buildOptions
  minify <span class="token operator">=</span> minify <span class="token operator">?</span> <span class="token string">'terser'</span> <span class="token operator">:</span> <span class="token boolean">false</span>
  <span class="token comment">// 调用 Vite 的 build API 进行打包</span>
  <span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token comment">// 根路径设置为插件所在目录</span>
    <span class="token comment">// 由于插件的依赖包含`core-js`、`regenerator-runtime`这些运行时基础库</span>
    <span class="token comment">// 因此这里 Vite 可以正常解析到基础 Polyfill 库的路径</span>
    root<span class="token operator">:</span> __dirname<span class="token punctuation">,</span>
    write<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    <span class="token comment">// 这里的插件实现了一个虚拟模块</span>
    <span class="token comment">// Vite 对于 polyfillId 会返回所有 Polyfill 的引入语句</span>
    plugins<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token function">polyfillsPlugin</span><span class="token punctuation">(</span>imports<span class="token punctuation">,</span> externalSystemJS<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    build<span class="token operator">:</span> <span class="token punctuation">{</span>
      rollupOptions<span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token comment">// 访问 polyfillId</span>
        input<span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token comment">// name 暂可视作`polyfills-legacy`</span>
          <span class="token comment">// pofyfillId 为一个虚拟模块，经过插件处理后会拿到所有 Polyfill 的引入语句</span>
          <span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token operator">:</span> polyfillId
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 拿到 polyfill 产物 chunk</span>
  <span class="token keyword">const</span> _polyfillChunk <span class="token operator">=</span> <span class="token builtin">Array</span><span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span> <span class="token operator">?</span> res<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">:</span> res
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span><span class="token string">'output'</span> <span class="token keyword">in</span> _polyfillChunk<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span>
  <span class="token keyword">const</span> polyfillChunk <span class="token operator">=</span> _polyfillChunk<span class="token punctuation">.</span>output<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
  <span class="token comment">// 后续做两件事情:</span>
  <span class="token comment">// 1. 记录 polyfill chunk 的文件名，方便后续插入到 Modern 模式产物的 HTML 中；</span>
  <span class="token comment">// 2. 在 bundle 对象上手动添加 polyfill 的 chunk，保证产物写到磁盘中</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br></div></div><p>因此，你可以理解为这个函数的作用即通过 <code>vite build</code> 对<code>renderChunk</code>中收集到 polyfill 代码进行打包，生成一个单独的 chunk。</p> <div class="custom-block tip"><p class="custom-block-title">注意</p> <p><code>polyfill chunk</code> 中除了包含一些 <code>core-js</code> 和 <code>regenerator-runtime</code> 的相关代码，也包含了 <code>SystemJS</code> 的实现代码，你可以将其理解为 ESM 的加载器，实现了在旧版浏览器下的模块加载能力。</p></div> <p>现在我们已经能够拿到 Legacy 模式的产物文件名及 Polyfill Chunk 的文件名，那么就可以通过<code>transformIndexHtml</code>钩子来将这些产物插入到 HTML 的结构中:</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token punctuation">{</span>
  <span class="token function">transformIndexHtml</span><span class="token punctuation">(</span>html<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 1. 插入 Polyfill chunk 对应的 &lt;script nomodule&gt; 标签</span>
    <span class="token comment">// 2. 插入 Legacy 产物入口文件对应的 &lt;script nomodule&gt; 标签</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/blog/devops/vite/ssr.html" class="prev">
        SSR 工程化
      </a></span> <span class="next"><a href="/blog/devops/vite/split-code.html">
        代码分割
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----><!----><!----><!----></div></div>
    <script src="/blog/assets/js/app.e9b7ea63.js" defer></script><script src="/blog/assets/js/2.dec2e75d.js" defer></script><script src="/blog/assets/js/1.5b9e135c.js" defer></script><script src="/blog/assets/js/103.849d9dd6.js" defer></script><script src="/blog/assets/js/20.badbb211.js" defer></script>
  </body>
</html>
