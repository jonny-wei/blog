<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>SSR 工程化 | 前端那些事儿</title>
    <meta name="generator" content="VuePress 1.9.10">
    <link rel="icon" href="/blog/logo.png">
    <link rel="manifest" href="/blog/manifest.json">
    <link rel="apple-touch-icon" href="/blog/images/icons/apple-icon-152x152.png">
    <meta name="description" content="我命由我不由天，学习吧少年">
    <meta name="theme-color" content="#3eaf7c">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="msapplication-TileImage" content="/icons/ms-icon-144x144.png">
    <meta name="msapplication-TileColor" content="#000000">
    
    <link rel="preload" href="/blog/assets/css/0.styles.f0017422.css" as="style"><link rel="preload" href="/blog/assets/js/app.f064466e.js" as="script"><link rel="preload" href="/blog/assets/js/2.dec2e75d.js" as="script"><link rel="preload" href="/blog/assets/js/1.5b9e135c.js" as="script"><link rel="preload" href="/blog/assets/js/113.d7cac620.js" as="script"><link rel="preload" href="/blog/assets/js/20.badbb211.js" as="script"><link rel="prefetch" href="/blog/assets/js/10.cc7e09f3.js"><link rel="prefetch" href="/blog/assets/js/100.092e3032.js"><link rel="prefetch" href="/blog/assets/js/101.a01f5a9d.js"><link rel="prefetch" href="/blog/assets/js/102.354eb4d9.js"><link rel="prefetch" href="/blog/assets/js/103.551b01d6.js"><link rel="prefetch" href="/blog/assets/js/104.4195509f.js"><link rel="prefetch" href="/blog/assets/js/105.5bcfb334.js"><link rel="prefetch" href="/blog/assets/js/106.4d5cd4f9.js"><link rel="prefetch" href="/blog/assets/js/107.56728416.js"><link rel="prefetch" href="/blog/assets/js/108.238ec3f7.js"><link rel="prefetch" href="/blog/assets/js/109.f692a551.js"><link rel="prefetch" href="/blog/assets/js/11.b60c9933.js"><link rel="prefetch" href="/blog/assets/js/110.d9eafe6c.js"><link rel="prefetch" href="/blog/assets/js/111.9786ad77.js"><link rel="prefetch" href="/blog/assets/js/112.c095d75c.js"><link rel="prefetch" href="/blog/assets/js/114.b45e47bc.js"><link rel="prefetch" href="/blog/assets/js/115.6231612c.js"><link rel="prefetch" href="/blog/assets/js/116.7a3e466d.js"><link rel="prefetch" href="/blog/assets/js/117.b0193462.js"><link rel="prefetch" href="/blog/assets/js/118.ca6cc5f7.js"><link rel="prefetch" href="/blog/assets/js/119.a272e5e9.js"><link rel="prefetch" href="/blog/assets/js/12.c53283e7.js"><link rel="prefetch" href="/blog/assets/js/120.e411196d.js"><link rel="prefetch" href="/blog/assets/js/121.25dc3fe6.js"><link rel="prefetch" href="/blog/assets/js/122.7298b7a6.js"><link rel="prefetch" href="/blog/assets/js/123.f2992c18.js"><link rel="prefetch" href="/blog/assets/js/124.e82e9f6c.js"><link rel="prefetch" href="/blog/assets/js/125.dc111900.js"><link rel="prefetch" href="/blog/assets/js/126.6169b7ee.js"><link rel="prefetch" href="/blog/assets/js/127.ac83a046.js"><link rel="prefetch" href="/blog/assets/js/128.7da5e812.js"><link rel="prefetch" href="/blog/assets/js/129.b7120c7a.js"><link rel="prefetch" href="/blog/assets/js/13.6bdc6b5d.js"><link rel="prefetch" href="/blog/assets/js/130.4b4024eb.js"><link rel="prefetch" href="/blog/assets/js/131.915eca3b.js"><link rel="prefetch" href="/blog/assets/js/132.a72163a9.js"><link rel="prefetch" href="/blog/assets/js/133.80240bab.js"><link rel="prefetch" href="/blog/assets/js/134.59a9c10e.js"><link rel="prefetch" href="/blog/assets/js/135.55b14adc.js"><link rel="prefetch" href="/blog/assets/js/136.7f5d49d2.js"><link rel="prefetch" href="/blog/assets/js/137.d874e123.js"><link rel="prefetch" href="/blog/assets/js/138.ecaa45d9.js"><link rel="prefetch" href="/blog/assets/js/139.ca36818f.js"><link rel="prefetch" href="/blog/assets/js/14.c3201a23.js"><link rel="prefetch" href="/blog/assets/js/140.313b4b35.js"><link rel="prefetch" href="/blog/assets/js/141.fabdffe8.js"><link rel="prefetch" href="/blog/assets/js/142.a43fa987.js"><link rel="prefetch" href="/blog/assets/js/143.163b1e09.js"><link rel="prefetch" href="/blog/assets/js/144.fc4e0adb.js"><link rel="prefetch" href="/blog/assets/js/145.daf7f222.js"><link rel="prefetch" href="/blog/assets/js/146.615ab8bc.js"><link rel="prefetch" href="/blog/assets/js/147.2c1841e6.js"><link rel="prefetch" href="/blog/assets/js/148.b91d11d4.js"><link rel="prefetch" href="/blog/assets/js/149.14e85f73.js"><link rel="prefetch" href="/blog/assets/js/15.a0b9e44e.js"><link rel="prefetch" href="/blog/assets/js/150.cfc330ab.js"><link rel="prefetch" href="/blog/assets/js/151.ebf83a39.js"><link rel="prefetch" href="/blog/assets/js/152.0a73be52.js"><link rel="prefetch" href="/blog/assets/js/153.8343bfc8.js"><link rel="prefetch" href="/blog/assets/js/154.a1a2eb79.js"><link rel="prefetch" href="/blog/assets/js/155.f698eea1.js"><link rel="prefetch" href="/blog/assets/js/156.a811446e.js"><link rel="prefetch" href="/blog/assets/js/157.0dbe96cb.js"><link rel="prefetch" href="/blog/assets/js/158.6a9a1c38.js"><link rel="prefetch" href="/blog/assets/js/159.9286efb1.js"><link rel="prefetch" href="/blog/assets/js/16.491191e4.js"><link rel="prefetch" href="/blog/assets/js/160.baa0ba8a.js"><link rel="prefetch" href="/blog/assets/js/161.e33c0e8b.js"><link rel="prefetch" href="/blog/assets/js/162.54cf777a.js"><link rel="prefetch" href="/blog/assets/js/163.7ee5e5cb.js"><link rel="prefetch" href="/blog/assets/js/164.cfb88055.js"><link rel="prefetch" href="/blog/assets/js/165.15a2bb66.js"><link rel="prefetch" href="/blog/assets/js/166.6e3d209a.js"><link rel="prefetch" href="/blog/assets/js/167.4c0d455c.js"><link rel="prefetch" href="/blog/assets/js/168.5120246b.js"><link rel="prefetch" href="/blog/assets/js/169.8736d1ee.js"><link rel="prefetch" href="/blog/assets/js/17.89ec8c57.js"><link rel="prefetch" href="/blog/assets/js/170.21af58b6.js"><link rel="prefetch" href="/blog/assets/js/171.0e3f28f1.js"><link rel="prefetch" href="/blog/assets/js/172.7cfd3207.js"><link rel="prefetch" href="/blog/assets/js/173.a2dac462.js"><link rel="prefetch" href="/blog/assets/js/174.d176a202.js"><link rel="prefetch" href="/blog/assets/js/175.a3bde410.js"><link rel="prefetch" href="/blog/assets/js/176.f1f211e6.js"><link rel="prefetch" href="/blog/assets/js/177.ea36edee.js"><link rel="prefetch" href="/blog/assets/js/178.3315e121.js"><link rel="prefetch" href="/blog/assets/js/179.dcab2bcc.js"><link rel="prefetch" href="/blog/assets/js/18.b91f1411.js"><link rel="prefetch" href="/blog/assets/js/180.9317de32.js"><link rel="prefetch" href="/blog/assets/js/181.1f7dc615.js"><link rel="prefetch" href="/blog/assets/js/182.3f627730.js"><link rel="prefetch" href="/blog/assets/js/183.0aae9e4d.js"><link rel="prefetch" href="/blog/assets/js/184.02e612bc.js"><link rel="prefetch" href="/blog/assets/js/185.69086931.js"><link rel="prefetch" href="/blog/assets/js/186.bd208371.js"><link rel="prefetch" href="/blog/assets/js/187.36617b89.js"><link rel="prefetch" href="/blog/assets/js/188.1218d015.js"><link rel="prefetch" href="/blog/assets/js/189.eb1628e7.js"><link rel="prefetch" href="/blog/assets/js/19.cb1f17c8.js"><link rel="prefetch" href="/blog/assets/js/190.c2837a50.js"><link rel="prefetch" href="/blog/assets/js/191.de4c52a2.js"><link rel="prefetch" href="/blog/assets/js/192.fe63255b.js"><link rel="prefetch" href="/blog/assets/js/193.0cd0acb5.js"><link rel="prefetch" href="/blog/assets/js/194.c768d736.js"><link rel="prefetch" href="/blog/assets/js/195.96aee012.js"><link rel="prefetch" href="/blog/assets/js/196.e710792c.js"><link rel="prefetch" href="/blog/assets/js/197.76ca820f.js"><link rel="prefetch" href="/blog/assets/js/198.5a39c6b2.js"><link rel="prefetch" href="/blog/assets/js/199.5a40ce24.js"><link rel="prefetch" href="/blog/assets/js/200.caed4672.js"><link rel="prefetch" href="/blog/assets/js/201.9548a796.js"><link rel="prefetch" href="/blog/assets/js/202.01cd4db0.js"><link rel="prefetch" href="/blog/assets/js/203.2c0f5719.js"><link rel="prefetch" href="/blog/assets/js/204.1fd518d5.js"><link rel="prefetch" href="/blog/assets/js/205.8e640cc0.js"><link rel="prefetch" href="/blog/assets/js/206.8e05dadc.js"><link rel="prefetch" href="/blog/assets/js/207.9d91e0f0.js"><link rel="prefetch" href="/blog/assets/js/208.871c410a.js"><link rel="prefetch" href="/blog/assets/js/209.c989e52c.js"><link rel="prefetch" href="/blog/assets/js/21.bf0041b7.js"><link rel="prefetch" href="/blog/assets/js/210.ec861054.js"><link rel="prefetch" href="/blog/assets/js/211.d97e0d8f.js"><link rel="prefetch" href="/blog/assets/js/212.41aa6b33.js"><link rel="prefetch" href="/blog/assets/js/213.6beb6476.js"><link rel="prefetch" href="/blog/assets/js/214.ecb9407f.js"><link rel="prefetch" href="/blog/assets/js/215.dc28f7ea.js"><link rel="prefetch" href="/blog/assets/js/216.ef219cb8.js"><link rel="prefetch" href="/blog/assets/js/217.b1bc396a.js"><link rel="prefetch" href="/blog/assets/js/22.48390d4f.js"><link rel="prefetch" href="/blog/assets/js/23.35c4ba93.js"><link rel="prefetch" href="/blog/assets/js/24.cc3b12df.js"><link rel="prefetch" href="/blog/assets/js/25.632a83cc.js"><link rel="prefetch" href="/blog/assets/js/26.dc0735bf.js"><link rel="prefetch" href="/blog/assets/js/27.cc85ad1c.js"><link rel="prefetch" href="/blog/assets/js/28.8db05f53.js"><link rel="prefetch" href="/blog/assets/js/29.fb4096e5.js"><link rel="prefetch" href="/blog/assets/js/3.cb0627fa.js"><link rel="prefetch" href="/blog/assets/js/30.17850991.js"><link rel="prefetch" href="/blog/assets/js/31.242683bb.js"><link rel="prefetch" href="/blog/assets/js/32.bf429371.js"><link rel="prefetch" href="/blog/assets/js/33.6ba2a392.js"><link rel="prefetch" href="/blog/assets/js/34.97963f66.js"><link rel="prefetch" href="/blog/assets/js/35.e732926b.js"><link rel="prefetch" href="/blog/assets/js/36.f59db662.js"><link rel="prefetch" href="/blog/assets/js/37.2adb7b7a.js"><link rel="prefetch" href="/blog/assets/js/38.0e4f5d2b.js"><link rel="prefetch" href="/blog/assets/js/39.bc8bdb2d.js"><link rel="prefetch" href="/blog/assets/js/4.cbb57fa7.js"><link rel="prefetch" href="/blog/assets/js/40.fd3db312.js"><link rel="prefetch" href="/blog/assets/js/41.3df10542.js"><link rel="prefetch" href="/blog/assets/js/42.24c30e2f.js"><link rel="prefetch" href="/blog/assets/js/43.b77505bf.js"><link rel="prefetch" href="/blog/assets/js/44.2fe040db.js"><link rel="prefetch" href="/blog/assets/js/45.d1ff2718.js"><link rel="prefetch" href="/blog/assets/js/46.ac4c50a9.js"><link rel="prefetch" href="/blog/assets/js/47.be6cf846.js"><link rel="prefetch" href="/blog/assets/js/48.49c3bebf.js"><link rel="prefetch" href="/blog/assets/js/49.66813cef.js"><link rel="prefetch" href="/blog/assets/js/5.fe065607.js"><link rel="prefetch" href="/blog/assets/js/50.a59a1e39.js"><link rel="prefetch" href="/blog/assets/js/51.a7690724.js"><link rel="prefetch" href="/blog/assets/js/52.cec8f88e.js"><link rel="prefetch" href="/blog/assets/js/53.5a7e2462.js"><link rel="prefetch" href="/blog/assets/js/54.28a6163c.js"><link rel="prefetch" href="/blog/assets/js/55.ab7cb738.js"><link rel="prefetch" href="/blog/assets/js/56.43a18261.js"><link rel="prefetch" href="/blog/assets/js/57.9e6af602.js"><link rel="prefetch" href="/blog/assets/js/58.592a495a.js"><link rel="prefetch" href="/blog/assets/js/59.0077967c.js"><link rel="prefetch" href="/blog/assets/js/6.68cda050.js"><link rel="prefetch" href="/blog/assets/js/60.61e93e53.js"><link rel="prefetch" href="/blog/assets/js/61.70b9139c.js"><link rel="prefetch" href="/blog/assets/js/62.b9e107be.js"><link rel="prefetch" href="/blog/assets/js/63.27a4a598.js"><link rel="prefetch" href="/blog/assets/js/64.89c0e1b1.js"><link rel="prefetch" href="/blog/assets/js/65.29b44d0e.js"><link rel="prefetch" href="/blog/assets/js/66.503fbcc3.js"><link rel="prefetch" href="/blog/assets/js/67.9060f240.js"><link rel="prefetch" href="/blog/assets/js/68.3616a779.js"><link rel="prefetch" href="/blog/assets/js/69.ddb99194.js"><link rel="prefetch" href="/blog/assets/js/7.3b8d63a0.js"><link rel="prefetch" href="/blog/assets/js/70.ef2df8e0.js"><link rel="prefetch" href="/blog/assets/js/71.92541e1d.js"><link rel="prefetch" href="/blog/assets/js/72.187dd3c8.js"><link rel="prefetch" href="/blog/assets/js/73.5af024ef.js"><link rel="prefetch" href="/blog/assets/js/74.28b44d4b.js"><link rel="prefetch" href="/blog/assets/js/75.d9f3b129.js"><link rel="prefetch" href="/blog/assets/js/76.e710d0f9.js"><link rel="prefetch" href="/blog/assets/js/77.59bee4e8.js"><link rel="prefetch" href="/blog/assets/js/78.3e5da7b2.js"><link rel="prefetch" href="/blog/assets/js/79.b588307d.js"><link rel="prefetch" href="/blog/assets/js/80.944e9246.js"><link rel="prefetch" href="/blog/assets/js/81.1abf4136.js"><link rel="prefetch" href="/blog/assets/js/82.8a6dc316.js"><link rel="prefetch" href="/blog/assets/js/83.49fe7db4.js"><link rel="prefetch" href="/blog/assets/js/84.99eb528d.js"><link rel="prefetch" href="/blog/assets/js/85.31f56ab1.js"><link rel="prefetch" href="/blog/assets/js/86.01130ae0.js"><link rel="prefetch" href="/blog/assets/js/87.0c38021a.js"><link rel="prefetch" href="/blog/assets/js/88.95dd3549.js"><link rel="prefetch" href="/blog/assets/js/89.c1fa1707.js"><link rel="prefetch" href="/blog/assets/js/90.790bbd0b.js"><link rel="prefetch" href="/blog/assets/js/91.8bd2e080.js"><link rel="prefetch" href="/blog/assets/js/92.7c81c7c2.js"><link rel="prefetch" href="/blog/assets/js/93.9f5209e3.js"><link rel="prefetch" href="/blog/assets/js/94.70ee66b4.js"><link rel="prefetch" href="/blog/assets/js/95.235343c1.js"><link rel="prefetch" href="/blog/assets/js/96.eb5c2704.js"><link rel="prefetch" href="/blog/assets/js/97.b1e3b815.js"><link rel="prefetch" href="/blog/assets/js/98.9b37860e.js"><link rel="prefetch" href="/blog/assets/js/99.746f24e0.js"><link rel="prefetch" href="/blog/assets/js/vendors~docsearch.bd3cdb54.js">
    <link rel="stylesheet" href="/blog/assets/css/0.styles.f0017422.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/blog/" class="home-link router-link-active"><img src="/blog/logo.png" alt="前端那些事儿" class="logo"> <span class="site-name can-hide">前端那些事儿</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/blog/" class="nav-link">
  主页
</a></div><div class="nav-item"><a href="/blog/base/" class="nav-link">
  前端基础
</a></div><div class="nav-item"><a href="/blog/vue/" class="nav-link">
  Vue
</a></div><div class="nav-item"><a href="/blog/react/" class="nav-link">
  React
</a></div><div class="nav-item"><a href="/blog/devops/" class="nav-link router-link-active">
  前端工程化
</a></div><div class="nav-item"><a href="/blog/mobile/" class="nav-link">
  泛客户端
</a></div><div class="nav-item"><a href="/blog/architecture/" class="nav-link">
  架构与方案
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="GitHub" class="dropdown-title"><span class="title">GitHub</span> <span class="arrow down"></span></button> <button type="button" aria-label="GitHub" class="mobile-dropdown-title"><span class="title">GitHub</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/jonny-wei" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://github.com/jonny-wei/sushi-js" target="_blank" rel="noopener noreferrer" class="nav-link external">
  JS 寿司
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/blog/" class="nav-link">
  主页
</a></div><div class="nav-item"><a href="/blog/base/" class="nav-link">
  前端基础
</a></div><div class="nav-item"><a href="/blog/vue/" class="nav-link">
  Vue
</a></div><div class="nav-item"><a href="/blog/react/" class="nav-link">
  React
</a></div><div class="nav-item"><a href="/blog/devops/" class="nav-link router-link-active">
  前端工程化
</a></div><div class="nav-item"><a href="/blog/mobile/" class="nav-link">
  泛客户端
</a></div><div class="nav-item"><a href="/blog/architecture/" class="nav-link">
  架构与方案
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="GitHub" class="dropdown-title"><span class="title">GitHub</span> <span class="arrow down"></span></button> <button type="button" aria-label="GitHub" class="mobile-dropdown-title"><span class="title">GitHub</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/jonny-wei" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://github.com/jonny-wei/sushi-js" target="_blank" rel="noopener noreferrer" class="nav-link external">
  JS 寿司
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Webpack</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/devops/" aria-current="page" class="sidebar-link">Webpack 常用配置</a></li><li><a href="/blog/devops/webpack/building.html" class="sidebar-link">构建流程与原理</a></li><li><a href="/blog/devops/webpack/dependency-graph.html" class="sidebar-link">模块依赖关系</a></li><li><a href="/blog/devops/webpack/chunk.html" class="sidebar-link">产物打包逻辑</a></li><li><a href="/blog/devops/webpack/compile.html" class="sidebar-link">模块编译及运行时</a></li><li><a href="/blog/devops/webpack/hmr.html" class="sidebar-link">HMR 热更新</a></li><li><a href="/blog/devops/webpack/loader.html" class="sidebar-link">Webpack Loader</a></li><li><a href="/blog/devops/webpack/plugin.html" class="sidebar-link">Webpack Plugin</a></li><li><a href="/blog/devops/webpack/module-federation.html" class="sidebar-link">模块联邦</a></li><li><a href="/blog/devops/webpack/cache.html" class="sidebar-link">持久化缓存</a></li><li><a href="/blog/devops/webpack/parallel.html" class="sidebar-link">并行构建</a></li><li><a href="/blog/devops/webpack/split-chunks.html" class="sidebar-link">分包策略</a></li><li><a href="/blog/devops/webpack/compress.html" class="sidebar-link">代码压缩</a></li><li><a href="/blog/devops/webpack/tree-shaking.html" class="sidebar-link">Tree Shaking</a></li><li><a href="/blog/devops/webpack/others.html" class="sidebar-link">Webpack 相关</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Vite</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/devops/vite/esm.html" class="sidebar-link">模块化规范</a></li><li><a href="/blog/devops/vite/css.html" class="sidebar-link">CSS 工程化</a></li><li><a href="/blog/devops/vite/prebuild.html" class="sidebar-link">依赖预构建</a></li><li><a href="/blog/devops/vite/engines.html" class="sidebar-link">双引擎架构</a></li><li><a href="/blog/devops/vite/rollup.html" class="sidebar-link">Rollup 打包</a></li><li><a href="/blog/devops/vite/building.html" class="sidebar-link">Vite 构建原理</a></li><li><a href="/blog/devops/vite/plugin.html" class="sidebar-link">Vite Plugin</a></li><li><a href="/blog/devops/vite/hmr.html" class="sidebar-link">Vite HMR 热更新</a></li><li><a href="/blog/devops/vite/ssr.html" aria-current="page" class="active sidebar-link">SSR 工程化</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/devops/vite/ssr.html#理解-ssr" class="sidebar-link">理解 SSR</a></li><li class="sidebar-sub-header"><a href="/blog/devops/vite/ssr.html#ssr-生命周期" class="sidebar-link">SSR 生命周期</a></li><li class="sidebar-sub-header"><a href="/blog/devops/vite/ssr.html#搭建-ssr-项目" class="sidebar-link">搭建 SSR 项目</a></li><li class="sidebar-sub-header"><a href="/blog/devops/vite/ssr.html#工程化问题" class="sidebar-link">工程化问题</a></li><li class="sidebar-sub-header"><a href="/blog/devops/vite/ssr.html#小结" class="sidebar-link">小结</a></li></ul></li><li><a href="/blog/devops/vite/legacy.html" class="sidebar-link">兼容性问题</a></li><li><a href="/blog/devops/vite/split-code.html" class="sidebar-link">代码分割</a></li><li><a href="/blog/devops/vite/mini.html" class="sidebar-link">Vite Mini 实现</a></li><li><a href="/blog/devops/vite/vite-news.html" class="sidebar-link">Vite 新特性</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>性能优化</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/devops/performance/indicator.html" class="sidebar-link">性能指标与采集</a></li><li><a href="/blog/devops/performance/webpack.html" class="sidebar-link">打包方面优化</a></li><li><a href="/blog/devops/performance/network.html" class="sidebar-link">网络方面优化</a></li><li><a href="/blog/devops/performance/render.html" class="sidebar-link">渲染方面优化</a></li><li><a href="/blog/devops/performance/code.html" class="sidebar-link">代码方面优化</a></li><li><a href="/blog/devops/performance/analysis.html" class="sidebar-link">打包性能分析工具</a></li><li><a href="/blog/devops/performance/optimization.html" class="sidebar-link">指标性能优化</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>代码与包管理</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/devops/git/git.html" class="sidebar-link">Git</a></li><li><a href="/blog/devops/git/package.html" class="sidebar-link">包管理 及 package.json</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="ssr-工程化"><a href="#ssr-工程化" class="header-anchor">#</a> SSR 工程化</h1> <h2 id="理解-ssr"><a href="#理解-ssr" class="header-anchor">#</a> 理解 SSR</h2> <p>回顾一下浏览器的渲染流程，在 CSR 中完整的页面内容本质上通过 JS 代码执行之后才能够渲染。这主要会导致两个方面的问题:</p> <ul><li><strong>首屏加载速度比较慢</strong>。首屏加载需要依赖 JS 的执行，下载和执行 JS 都可能是非常耗时的操作，尤其是在一些网络不佳的场景，或者性能敏感的低端机下。</li> <li><strong>对 SEO(搜索引擎优化) 不友好</strong>。页面 HTML 没有具体的页面内容，导致搜索引擎爬虫无法获取关键词信息，导致网站排名受到影响。</li></ul> <p>那么 SSR 是如何解决这些问题的呢？</p> <p>在 SSR 的场景下，服务端生成好<strong>完整的 HTML 内容</strong>，直接返回给浏览器，浏览器能够根据 HTML 渲染出完整的首屏内容，而不需要依赖 JS 的加载，这样一方面能够降低首屏渲染的时间，另一方面也能将完整的页面内容展现给搜索引擎的爬虫，利于 SEO。</p> <p>当然，SSR 中只能生成页面的内容和结构，并不能完成事件绑定，因此需要在浏览器中执行 CSR 的 JS 脚本，完成事件绑定，让页面拥有交互的能力，这个过程被称作<code>hydrate</code>(翻译为<code>注水</code>或者<code>激活</code>)。同时，像这样服务端渲染 + 客户端 hydrate 的应用也被称为<code>同构应用</code>。</p> <h2 id="ssr-生命周期"><a href="#ssr-生命周期" class="header-anchor">#</a> SSR 生命周期</h2> <p>前面我们提到了 SSR 会在服务端(这里主要指 Node.js 端)提前渲染出完整的 HTML 内容，那这是如何做到的呢？</p> <p>首先需要保证前端的代码经过编译后放到服务端中能够正常执行，其次在服务端渲染前端组件，生成并组装应用的 HTML。这就涉及到 SSR 应用的两大生命周期: <code>构建时</code>和<code>运行时</code>，我们不妨来仔细梳理一下。</p> <p>我们先来看看<code>构建时</code>需要做哪些事情:</p> <ol><li><strong>解决模块加载问题</strong>。在原有的构建过程之外，需要加入<code>SSR 构建</code>的过程 ，具体来说，我们需要另外生成一份 <code>CommonJS</code> 格式的产物，使之能在 Node.js 正常加载。当然，随着 Node.js 本身对 ESM 的支持越来越成熟，我们也可以复用前端 ESM 格式的代码，Vite 在开发阶段进行 SSR 构建也是这样的思路。</li></ol> <p><img src="/blog/images/devops/vite-ssr1.png" alt="vite-ssr1"></p> <ol start="2"><li><strong>移除样式代码的引入</strong>。直接引入一行 css 在服务端其实是无法执行的，因为 Node.js 并不能解析 CSS 的内容。但 <code>CSS Modules</code> 的情况除外，如下所示:</li></ol> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token keyword">import</span> styles <span class="token keyword">from</span> <span class="token string">'./index.module.css'</span>

<span class="token comment">// 这里的 styles 是一个对象，如{ &quot;container&quot;: &quot;xxx&quot; }，而不是 CSS 代码</span>
<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>styles<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><ol start="3"><li><strong>依赖外部化(external)</strong>。对于某些第三方依赖我们并不需要使用构建后的版本，而是直接从 <code>node_modules</code> 中读取，比如 <code>react-dom</code>，这样在 <code>SSR 构建</code>的过程中将不会构建这些依赖，从而极大程度上加速 SSR 的构建。</li></ol> <p>对于 SSR 的运行时，一般可以拆分为比较固定的生命周期阶段，简单来讲可以整理为以下几个核心的阶段:</p> <p><img src="/blog/images/devops/vite-ssr2.png" alt="vite-ssr2"></p> <ul><li><strong>加载 SSR 入口模块</strong>。在这个阶段，我们需要确定 SSR 构建产物的入口，即组件的入口在哪里，并加载对应的模块。</li> <li><strong>进行数据预取</strong>。这时候 Node 侧会通过查询数据库或者网络请求来获取应用所需的数据。</li> <li><strong>渲染组件</strong>。这个阶段为 SSR 的核心，主要将第 <code>1</code> 步中加载的组件渲染成 HTML 字符串或者 Stream 流。</li> <li><strong>HTML 拼接</strong>。在组件渲染完成之后，我们需要拼接完整的 HTML 字符串，并将其作为响应返回给浏览器。</li></ul> <p>SSR 其实是<code>构建</code>和<code>运行时</code>互相配合才能实现的，也就是说，仅靠构建工具是不够的，写一个 Vite 插件严格意义上无法实现 SSR 的能力，我们需要对 Vite 的构建流程做一些整体的调整，并且加入一些服务端运行时的逻辑才能实现。那么接下来，我们就以具体的代码示例来讲解如何在 Vite 中完成 SSR 工程的搭建。</p> <h2 id="搭建-ssr-项目"><a href="#搭建-ssr-项目" class="header-anchor">#</a> 搭建 SSR 项目</h2> <h3 id="ssr-构建-api"><a href="#ssr-构建-api" class="header-anchor">#</a> SSR 构建 API</h3> <p>首先 Vite 作为一个构建工具，是如何支持 SSR 构建的呢？换句话说，它是如何让前端的代码也能顺利在 Node.js 中成功跑起来的呢？</p> <p>可以分为两种情况，在开发环境下，Vite 依然秉承 ESM 模块按需加载即 <code>no-bundle</code>的理念，对外提供了<code>ssrLoadModule</code> API，你可以无需打包项目，将入口文件的路径传入<code>ssrLoadModule</code> 即可:</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token comment">// 加载服务端入口模块</span>
<span class="token keyword">const</span> xxx <span class="token operator">=</span> <span class="token keyword">await</span> vite<span class="token punctuation">.</span><span class="token function">ssrLoadModule</span><span class="token punctuation">(</span><span class="token string">'/src/entry-server.tsx'</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>而在生产环境下，Vite 会默认进行打包，对于 SSR 构建输出 CommonJS 格式的产物。我们可以在<code>package.json</code>中加入这样类似的构建指令:</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token punctuation">{</span>
  <span class="token string-property property">&quot;build:ssr&quot;</span><span class="token operator">:</span> <span class="token string">&quot;vite build --ssr 服务端入口路径&quot;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>这样 Vite 会专门为 SSR 打包出一份构建产物。因此你可以看到，大部分 SSR 构建时的事情，Vite 已经帮我们提供了开箱即用的方案，我们后续直接使用即可。</p> <h3 id="项目骨架搭建"><a href="#项目骨架搭建" class="header-anchor">#</a> 项目骨架搭建</h3> <p>接下来我们正式开始 SSR 项目的搭建，你可以通过脚手架初始化一个<code>react+ts</code>的项目:</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>npm init vite
pnpm i
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>删除项目自带的<code>src/main.ts</code>，然后在 src 目录下新建<code>entry-client.tsx</code>和<code>entry-server.tsx</code>两个入口文件:</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token comment">// entry-client.ts</span>
<span class="token comment">// 客户端入口文件</span>
<span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">'react'</span>
<span class="token keyword">import</span> ReactDOM <span class="token keyword">from</span> <span class="token string">'react-dom'</span>
<span class="token keyword">import</span> <span class="token string">'./index.css'</span>
<span class="token keyword">import</span> App <span class="token keyword">from</span> <span class="token string">'./App'</span>

ReactDOM<span class="token punctuation">.</span><span class="token function">hydrate</span><span class="token punctuation">(</span>
  <span class="token operator">&lt;</span>React<span class="token punctuation">.</span>StrictMode<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>App <span class="token operator">/</span><span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span><span class="token operator">/</span>React<span class="token punctuation">.</span>StrictMode<span class="token operator">&gt;</span><span class="token punctuation">,</span>
  document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'root'</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span>

<span class="token comment">// entry-server.ts</span>
<span class="token comment">// 导出 SSR 组件入口</span>
<span class="token keyword">import</span> App <span class="token keyword">from</span> <span class="token string">&quot;./App&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token string">'./index.css'</span>

<span class="token keyword">function</span> <span class="token function">ServerEntry</span><span class="token punctuation">(</span>props<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&lt;</span>App<span class="token operator">/</span><span class="token operator">&gt;</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token punctuation">{</span> ServerEntry <span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><p>我们以 Express 框架为例来实现 Node 后端服务，后续的 SSR 逻辑会接入到这个服务中。当然你需要安装以下的依赖:</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code>pnpm i express <span class="token operator">-</span><span class="token constant">S</span>
pnpm i <span class="token decorator"><span class="token at operator">@</span><span class="token function">types</span></span><span class="token operator">/</span>express <span class="token operator">-</span><span class="token constant">D</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>接着新建<code>src/ssr-server/index.ts</code>:</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token comment">// src/ssr-server/index.ts</span>
<span class="token comment">// 后端服务</span>
<span class="token keyword">import</span> express <span class="token keyword">from</span> <span class="token string">'express'</span><span class="token punctuation">;</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">createServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  
  app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Node 服务器已启动~'</span><span class="token punctuation">)</span>
    <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'http://localhost:3000'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">createServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>然后你可以在<code>package.json</code>中添加如下的 <code>scripts</code>:</p> <div class="language-json line-numbers-mode"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;scripts&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token comment">// 开发阶段启动 SSR 的后端服务</span>
    <span class="token property">&quot;dev&quot;</span><span class="token operator">:</span> <span class="token string">&quot;nodemon --watch src/ssr-server --exec 'esno src/ssr-server/index.ts'&quot;</span><span class="token punctuation">,</span>
    <span class="token comment">// 打包客户端产物和 SSR 产物</span>
    <span class="token property">&quot;build&quot;</span><span class="token operator">:</span> <span class="token string">&quot;npm run build:client &amp;&amp; npm run build:server&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;build:client&quot;</span><span class="token operator">:</span> <span class="token string">&quot;vite build --outDir dist/client&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;build:server&quot;</span><span class="token operator">:</span> <span class="token string">&quot;vite build --ssr src/entry-server.tsx --outDir dist/server&quot;</span><span class="token punctuation">,</span>
    <span class="token comment">// 生产环境预览 SSR 效果</span>
    <span class="token property">&quot;preview&quot;</span><span class="token operator">:</span> <span class="token string">&quot;NODE_ENV=production esno src/ssr-server/index.ts&quot;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>其中设计到两个额外的工具，给大家解释一下:</p> <ul><li><code>nodemon</code>: 一个监听文件变化自动重启 Node 服务的工具。</li> <li><code>esno</code>: 类似 <code>ts-node</code> 的工具，用来执行 ts 文件，底层基于 Esbuild 实现。</li></ul> <p>同时你也需要安装这两个依赖:</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code>pnpm i esno nodemon <span class="token operator">-</span><span class="token constant">D</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>OK，现在我们就基本上搭建好了基本的项目骨架，接下里我们专注于 SSR 运行时的实现逻辑即可。</p> <h3 id="ssr-运行时实现"><a href="#ssr-运行时实现" class="header-anchor">#</a> SSR 运行时实现</h3> <p>SSR 作为一种特殊的后端服务，我们可以将其封装成一个中间件的形式，如以下的代码所示:</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token keyword">import</span> express<span class="token punctuation">,</span> <span class="token punctuation">{</span> RequestHandler<span class="token punctuation">,</span> Express <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'express'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> ViteDevServer <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'vite'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> isProd <span class="token operator">=</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">===</span> <span class="token string">'production'</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> cwd <span class="token operator">=</span> process<span class="token punctuation">.</span><span class="token function">cwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">createSsrMiddleware</span><span class="token punctuation">(</span>app<span class="token operator">:</span> Express<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span>RequestHandler<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> vite<span class="token operator">:</span> ViteDevServer <span class="token operator">|</span> <span class="token keyword">null</span> <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isProd<span class="token punctuation">)</span> <span class="token punctuation">{</span> 
    vite <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token punctuation">(</span><span class="token keyword">await</span> <span class="token keyword">import</span><span class="token punctuation">(</span><span class="token string">'vite'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      root<span class="token operator">:</span> process<span class="token punctuation">.</span><span class="token function">cwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      server<span class="token operator">:</span> <span class="token punctuation">{</span>
        middlewareMode<span class="token operator">:</span> <span class="token string">'ssr'</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token comment">// 注册 Vite Middlewares</span>
    <span class="token comment">// 主要用来处理客户端资源</span>
    app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>vite<span class="token punctuation">.</span>middlewares<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token keyword">async</span> <span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// SSR 的逻辑</span>
    <span class="token comment">// 1. 加载服务端入口模块</span>
    <span class="token comment">// 2. 数据预取</span>
    <span class="token comment">// 3. 「核心」渲染组件</span>
    <span class="token comment">// 4. 拼接 HTML，返回响应</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">createServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 加入 Vite SSR 中间件</span>
  app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token keyword">await</span> <span class="token function">createSsrMiddleware</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Node 服务器已启动~'</span><span class="token punctuation">)</span>
    <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'http://localhost:3000'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">createServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br></div></div><p>接下来我们把焦点放在中间件内 SSR 的逻辑实现上，首先实现第一步即<code>加载服务端入口模块</code>:</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">loadSsrEntryModule</span><span class="token punctuation">(</span>vite<span class="token operator">:</span> ViteDevServer <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 生产模式下直接 require 打包后的产物</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>isProd<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> entryPath <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>cwd<span class="token punctuation">,</span> <span class="token string">'dist/server/entry-server.js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">require</span><span class="token punctuation">(</span>entryPath<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> 
  <span class="token comment">// 开发环境下通过 no-bundle 方式加载</span>
  <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> entryPath <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>cwd<span class="token punctuation">,</span> <span class="token string">'src/entry-server.tsx'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> vite<span class="token operator">!</span><span class="token punctuation">.</span><span class="token function">ssrLoadModule</span><span class="token punctuation">(</span>entryPath<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>中间件内的逻辑如下:</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">createSsrMiddleware</span><span class="token punctuation">(</span>app<span class="token operator">:</span> Express<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span>RequestHandler<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// 省略前面的代码</span>
  <span class="token keyword">return</span> <span class="token keyword">async</span> <span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> url <span class="token operator">=</span> req<span class="token punctuation">.</span>originalUrl<span class="token punctuation">;</span>
    <span class="token comment">// 1. 服务端入口加载</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> ServerEntry <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">loadSsrEntryModule</span><span class="token punctuation">(</span>vite<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// ...</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>接下来我们来实现服务端的数据预取操作，你可以在<code>entry-server.tsx</code>中添加一个简单的获取数据的函数:</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token keyword">export</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">fetchData</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span> user<span class="token operator">:</span> <span class="token string">'xxx'</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>然后在 SSR 中间件中完成数据预取的操作:</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token comment">// src/ssr-server/index.ts</span>
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">createSsrMiddleware</span><span class="token punctuation">(</span>app<span class="token operator">:</span> Express<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span>RequestHandler<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// 省略前面的代码</span>
  <span class="token keyword">return</span> <span class="token keyword">async</span> <span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> url <span class="token operator">=</span> req<span class="token punctuation">.</span>originalUrl<span class="token punctuation">;</span>
    <span class="token comment">// 1. 服务端入口加载</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> ServerEntry<span class="token punctuation">,</span> fetchData <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">loadSsrEntryModule</span><span class="token punctuation">(</span>vite<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 2. 预取数据</span>
    <span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fetchData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>接着我们进入到核心的组件渲染阶段:</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token comment">// src/ssr-server/index.ts</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> renderToString <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react-dom/server'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">createSsrMiddleware</span><span class="token punctuation">(</span>app<span class="token operator">:</span> Express<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span>RequestHandler<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// 省略前面的代码</span>
  <span class="token keyword">return</span> <span class="token keyword">async</span> <span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> url <span class="token operator">=</span> req<span class="token punctuation">.</span>originalUrl<span class="token punctuation">;</span>
    <span class="token comment">// 1. 服务端入口加载</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> ServerEntry<span class="token punctuation">,</span> fetchData <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">loadSsrEntryModule</span><span class="token punctuation">(</span>vite<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 2. 预取数据</span>
    <span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fetchData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 3. 组件渲染 -&gt; 字符串</span>
    <span class="token keyword">const</span> appHtml <span class="token operator">=</span> <span class="token function">renderToString</span><span class="token punctuation">(</span>React<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span>ServerEntry<span class="token punctuation">,</span> <span class="token punctuation">{</span> data <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>由于在第一步之后我们拿到了入口组件，现在可以调用前端框架的<code>renderToString</code>API 将组件渲染为字符串，组件的具体内容便就此生成了。</p> <p>OK，目前我们已经拿到了组件的 HTML 以及预取的数据，接下来我们在根目录下的 HTML 中提供相应的插槽，方便内容的替换:</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token comment">// index.html</span>
<span class="token operator">&lt;</span><span class="token operator">!</span><span class="token constant">DOCTYPE</span> html<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>html lang<span class="token operator">=</span><span class="token string">&quot;en&quot;</span><span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>head<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>meta charset<span class="token operator">=</span><span class="token string">&quot;UTF-8&quot;</span> <span class="token operator">/</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>link rel<span class="token operator">=</span><span class="token string">&quot;icon&quot;</span> type<span class="token operator">=</span><span class="token string">&quot;image/svg+xml&quot;</span> href<span class="token operator">=</span><span class="token string">&quot;/src/favicon.svg&quot;</span> <span class="token operator">/</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>meta name<span class="token operator">=</span><span class="token string">&quot;viewport&quot;</span> content<span class="token operator">=</span><span class="token string">&quot;width=device-width, initial-scale=1.0&quot;</span> <span class="token operator">/</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>title<span class="token operator">&gt;</span>Vite App<span class="token operator">&lt;</span><span class="token operator">/</span>title<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span><span class="token operator">/</span>head<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>body<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>div id<span class="token operator">=</span><span class="token string">&quot;root&quot;</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span> <span class="token constant">SSR_APP</span> <span class="token operator">--</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>script type<span class="token operator">=</span><span class="token string">&quot;module&quot;</span> src<span class="token operator">=</span><span class="token string">&quot;/src/entry-client.tsx&quot;</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span> <span class="token constant">SSR_DATA</span> <span class="token operator">--</span><span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span><span class="token operator">/</span>body<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>html<span class="token operator">&gt;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>紧接着我们在 SSR 中间件中补充 HTML 拼接的逻辑:</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token comment">// src/ssr-server/index.ts</span>
<span class="token keyword">function</span> <span class="token function">resolveTemplatePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> isProd <span class="token operator">?</span>
    path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>cwd<span class="token punctuation">,</span> <span class="token string">'dist/client/index.html'</span><span class="token punctuation">)</span> <span class="token operator">:</span>
    path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>cwd<span class="token punctuation">,</span> <span class="token string">'index.html'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">createSsrMiddleware</span><span class="token punctuation">(</span>app<span class="token operator">:</span> Express<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span>RequestHandler<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// 省略之前的代码</span>
  <span class="token keyword">return</span> <span class="token keyword">async</span> <span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> url <span class="token operator">=</span> req<span class="token punctuation">.</span>originalUrl<span class="token punctuation">;</span>
    <span class="token comment">// 省略前面的步骤</span>
    <span class="token comment">// 4. 拼接完整 HTML 字符串，返回客户端</span>
    <span class="token keyword">const</span> templatePath <span class="token operator">=</span> <span class="token function">resolveTemplatePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> template <span class="token operator">=</span> <span class="token keyword">await</span> fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span>templatePath<span class="token punctuation">,</span> <span class="token string">'utf-8'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 开发模式下需要注入 HMR、环境变量相关的代码，因此需要调用 vite.transformIndexHtml</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isProd <span class="token operator">&amp;&amp;</span> vite<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      template <span class="token operator">=</span> <span class="token keyword">await</span> vite<span class="token punctuation">.</span><span class="token function">transformIndexHtml</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> template<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">const</span> html <span class="token operator">=</span> template
      <span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token string">'&lt;!-- SSR_APP --&gt;'</span><span class="token punctuation">,</span> appHtml<span class="token punctuation">)</span>
      <span class="token comment">// 注入数据标签，用于客户端 hydrate</span>
      <span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>
        <span class="token string">'&lt;!-- SSR_DATA --&gt;'</span><span class="token punctuation">,</span>
        <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;script&gt;window.__SSR_DATA__=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&lt;/script&gt;</span><span class="token template-punctuation string">`</span></span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">'Content-Type'</span><span class="token punctuation">,</span> <span class="token string">'text/html'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span>html<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br></div></div><p>在拼接 HTML 的逻辑中，除了添加页面的具体内容，同时我们也注入了一个挂载全局数据的<code>script</code>标签，这是用来干什么的呢？</p> <p>在 SSR 的基本概念中我们就提到过，为了激活页面的交互功能，我们需要执行 CSR 的 JavaScript 代码来进行 hydrate 操作，而客户端 hydrate 的时候需要和服务端<code>同步预取后的数据</code>，保证页面渲染的结果和服务端渲染一致，因此，我们刚刚注入的数据 script 标签便派上用场了。由于全局的 window 上挂载服务端预取的数据，我们可以在<code>entry-client.tsx</code>也就是客户端渲染入口中拿到这份数据，并进行 hydrate:</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">'react'</span>
<span class="token keyword">import</span> ReactDOM <span class="token keyword">from</span> <span class="token string">'react-dom'</span>
<span class="token keyword">import</span> <span class="token string">'./index.css'</span>
<span class="token keyword">import</span> App <span class="token keyword">from</span> <span class="token string">'./App'</span>

<span class="token comment">// @ts-ignore</span>
<span class="token keyword">const</span> data <span class="token operator">=</span> window<span class="token punctuation">.</span>__SSR_DATA__<span class="token punctuation">;</span>

ReactDOM<span class="token punctuation">.</span><span class="token function">hydrate</span><span class="token punctuation">(</span>
  <span class="token operator">&lt;</span>React<span class="token punctuation">.</span>StrictMode<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>App data<span class="token operator">=</span><span class="token punctuation">{</span>data<span class="token punctuation">}</span><span class="token operator">/</span><span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span><span class="token operator">/</span>React<span class="token punctuation">.</span>StrictMode<span class="token operator">&gt;</span><span class="token punctuation">,</span>
  document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'root'</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>现在，我们基本开发完了 SSR 核心的逻辑。</p> <h3 id="生产环境的-csr-资源处理"><a href="#生产环境的-csr-资源处理" class="header-anchor">#</a> 生产环境的 CSR 资源处理</h3> <p>如果你现在执行<code>npm run build</code>及<code>npm run preview</code>进行生产环境的预览，会发现 SSR 可以正常返回内容，但所有的静态资源及 CSR 的代码都失效了。不过开发阶段并没有这个问题，这是因为对于开发阶段的静态资源 Vite Dev Server 的中间件已经帮我们处理了，而生产环境所有的资源都已经打包完成，我们需要启用单独的静态资源服务来承载这些资源。这里你可以<code>serve-static</code>中间件来完成这个服务，首先安装对应第三方包:</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code>pnpm i serve<span class="token operator">-</span><span class="token keyword">static</span> <span class="token operator">-</span><span class="token constant">S</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>接着我们到 server 端注册:</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token comment">// 过滤出页面请求</span>
<span class="token keyword">function</span> <span class="token function">matchPageUrl</span><span class="token punctuation">(</span>url<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>url <span class="token operator">===</span> <span class="token string">'/'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">createSsrMiddleware</span><span class="token punctuation">(</span>app<span class="token operator">:</span> Express<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span>RequestHandler<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">async</span> <span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> url <span class="token operator">=</span> req<span class="token punctuation">.</span>originalUrl<span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">matchPageUrl</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 走静态资源的处理</span>
        <span class="token keyword">return</span> <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// SSR 的逻辑省略</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>e<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      vite<span class="token operator">?.</span><span class="token function">ssrFixStacktrace</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
      res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">createServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 加入 Vite SSR 中间件</span>
  app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token keyword">await</span> <span class="token function">createSsrMiddleware</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 注册中间件，生产环境端处理客户端资源</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>isProd<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">serve</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>cwd<span class="token punctuation">,</span> <span class="token string">'dist/client'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 省略其它代码</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br></div></div><p>这样一来，我们就解决了生产环境下静态资源失效的问题。不过，一般情况下，我们会将静态资源部上传到 CDN 上，并且将 Vite 的 <code>base</code> 配置为域名前缀，这样我们可以通过 CDN 直接访问到静态资源，而不需要加上服务端的处理。不过作为本地的生产环境预览而言，<code>serve-static</code>还是一个不错的静态资源处理手段。</p> <h2 id="工程化问题"><a href="#工程化问题" class="header-anchor">#</a> 工程化问题</h2> <h3 id="路由管理"><a href="#路由管理" class="header-anchor">#</a> 路由管理</h3> <p>在 SPA 场景下，对于不同的前端框架，一般会有不同的路由管理方案，如 Vue 中的 <code>vue-router</code>、React 的<code>react-router</code>。不过归根结底，路由方案在 SSR 过程中所完成的功能都是差不多的:</p> <ol><li>告诉框架现在渲染哪个路由。在 Vue 中我们可以通过 <code>router.push</code> 确定即将渲染的路由，React 中则通过 <code>StaticRouter</code> 配合<code>location</code>参数来完成。</li> <li>设置 <code>base</code> 前缀。规定路径的前缀，如<code>vue-router</code> 中 <a href="https://link.juejin.cn/?target=https%3A%2F%2Frouter.vuejs.org%2Fzh%2Fguide%2Fmigration%2F%23%E7%A7%BB%E5%8A%A8%E4%BA%86-base-%E9%85%8D%E7%BD%AE" target="_blank" rel="noopener noreferrer">base 参数<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>、<code>react-router</code>中<code>StaticRouter</code>组件的 <a href="https://link.juejin.cn/?target=https%3A%2F%2Fv5.reactrouter.com%2Fweb%2Fapi%2FStaticRouter" target="_blank" rel="noopener noreferrer">basename<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。</li></ol> <h3 id="全局状态管理"><a href="#全局状态管理" class="header-anchor">#</a> 全局状态管理</h3> <p>对于全局的状态管理而言，对于不同的框架也有不同的生态和方案，比如 Vue 中的 <a href="https://link.juejin.cn/?target=https%3A%2F%2Fvuex.vuejs.org%2F" target="_blank" rel="noopener noreferrer">Vuex<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>、<a href="https://link.juejin.cn/?target=https%3A%2F%2Fpinia.vuejs.org%2F" target="_blank" rel="noopener noreferrer">Pinia<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>，React 中的 <a href="https://link.juejin.cn/?target=https%3A%2F%2Fredux.js.org%2Fintroduction%2Fgetting-started" target="_blank" rel="noopener noreferrer">Redux<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>、<a href="https://link.juejin.cn/?target=https%3A%2F%2Frecoiljs.org%2Fzh-hans%2F" target="_blank" rel="noopener noreferrer">Recoil<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。接入 SSR 的思路也比较简单，在<code>预取数据</code>阶段初始化服务端的 <code>store</code> ，将异步获取的数据存入 <code>store</code> 中，然后在 <code>拼接 HTML</code>阶段将数据从 store 中取出放到数据 script 标签中，最后在客户端 hydrate 的时候通过 window 即可访问到预取数据。需要注意的服务端处理许多不同的请求，对于每个请求都需要<strong>分别</strong>初始化 store，即一个请求一个 store，不然会造成全局状态污染的问题。</p> <h3 id="csr-降级"><a href="#csr-降级" class="header-anchor">#</a> CSR 降级</h3> <p>在某些比较极端的情况下，我们需要降级到 CSR，也就是客户端渲染。一般而言包括如下的降级场景:</p> <ul><li><ol><li>服务器端<strong>预取数据</strong>失败，需要降级到客户端获取数据。</li></ol></li> <li><ol><li>服务器出现异常，需要返回<strong>兜底的 CSR 模板</strong>，完全降级为 CSR。</li></ol></li> <li><ol><li>本地<strong>开发调试</strong>，有时需要跳过 SSR，仅进行 CSR。</li></ol></li></ul> <p>对于第一种情况，在客户端入口文件中需要有重新获取数据的逻辑，我们可以进行这样的补充:</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token comment">// entry-client.tsx</span>
<span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">'react'</span>
<span class="token keyword">import</span> ReactDOM <span class="token keyword">from</span> <span class="token string">'react-dom'</span>
<span class="token keyword">import</span> <span class="token string">'./index.css'</span>
<span class="token keyword">import</span> App <span class="token keyword">from</span> <span class="token string">'./App'</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">fetchData</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 客户端获取数据</span>
<span class="token punctuation">}</span>


<span class="token keyword">async</span> fucntion <span class="token function">hydrate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> data<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>window<span class="token punctuation">.</span>__SSR_DATA__<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    data <span class="token operator">=</span> window<span class="token punctuation">.</span>__SSR_DATA__<span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// 降级逻辑 </span>
    data <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fetchData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 也可简化为 const data = window.__SSR_DATA__ ?? await fetchData();</span>
  ReactDOM<span class="token punctuation">.</span><span class="token function">hydrate</span><span class="token punctuation">(</span>
    <span class="token operator">&lt;</span>React<span class="token punctuation">.</span>StrictMode<span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span>App data<span class="token operator">=</span><span class="token punctuation">{</span>data<span class="token punctuation">}</span><span class="token operator">/</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>React<span class="token punctuation">.</span>StrictMode<span class="token operator">&gt;</span><span class="token punctuation">,</span>
    document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'root'</span><span class="token punctuation">)</span>
  <span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br></div></div><p>对于第二种场景，即<code>服务器执行出错</code>，我们可以在之前的 SSR 中间件逻辑追加 catch 逻辑:</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">createSsrMiddleware</span><span class="token punctuation">(</span>app<span class="token operator">:</span> Express<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span>RequestHandler<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">async</span> <span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token comment">// SSR 的逻辑省略</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>e<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      vite<span class="token operator">?.</span><span class="token function">ssrFixStacktrace</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 在这里返回浏览器 CSR 模板内容</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>对于第三种情况，我们可以通过通过 <code>?csr</code> 的 url query 参数来强制跳过 SSR，在 SSR 中间件添加如下逻辑:</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">createSsrMiddleware</span><span class="token punctuation">(</span>app<span class="token operator">:</span> Express<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span>RequestHandler<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">async</span> <span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>req<span class="token punctuation">.</span>query<span class="token operator">?.</span>csr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 响应 CSR 模板内容</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// SSR 的逻辑省略</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>e<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      vite<span class="token operator">?.</span><span class="token function">ssrFixStacktrace</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><h3 id="浏览器-api-兼容"><a href="#浏览器-api-兼容" class="header-anchor">#</a> 浏览器 API 兼容</h3> <p>由于 Node.js 中不能使用浏览器里面诸如 <code>window</code>、<code>document</code>之类的 API，因此一旦在服务端执行到这样的 API 会报错。那么如何来解决这个问题呢？</p> <p>首先我们可以通过<code>import.meta.env.SSR</code>这个 Vite 内置的环境变量来判断是否处于 SSR 环境，以此来规避业务代码在服务端出现浏览器的 API:</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">import</span><span class="token punctuation">.</span>meta<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">SSR</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 服务端执行的逻辑</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
  <span class="token comment">// 在此可以访问浏览器的 API</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>当然，我们也可以通过 polyfill 的方式，在 Node 中注入浏览器的 API，使这些 API 能够正常运行起来，解决如上的问题。我推荐使用一个比较成熟的 polyfill 库 <code>jsdom</code>，使用方式如下:</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token keyword">const</span> jsdom <span class="token operator">=</span> <span class="token keyword">require</span><span class="token punctuation">(</span><span class="token string">'jsdom'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> window <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token constant">JSDOM</span></span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;!DOCTYPE html&gt;&lt;p&gt;Hello world&lt;/p&gt;</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> document <span class="token punctuation">}</span> <span class="token operator">=</span> window<span class="token punctuation">;</span>
<span class="token comment">// 挂载到 node 全局</span>
global<span class="token punctuation">.</span>window <span class="token operator">=</span> window<span class="token punctuation">;</span>
global<span class="token punctuation">.</span>document <span class="token operator">=</span> document<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h3 id="自定义-head"><a href="#自定义-head" class="header-anchor">#</a> 自定义 Head</h3> <p>在 SSR 的过程中，我们虽然可以在决定组件的内容，即<code>&lt;div id=&quot;root&quot;&gt;&lt;/div&gt;</code>这个容器 div 中的内容，但对于 HTML 中<code>head</code>的内容我们无法根据<strong>组件的内部状态</strong>来决定，比如对于一个直播间的页面，我们需要在服务端渲染出 title 标签，title 的内容是不同主播的直播间名称，不能在代码中写死，这种情况怎么办？</p> <p>React 生态中的 <a href="https://link.juejin.cn/?target=https%3A%2F%2Fgithub.com%2Fnfl%2Freact-helmet" target="_blank" rel="noopener noreferrer">react-helmet<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 以及 Vue 生态中的 <a href="https://link.juejin.cn/?target=https%3A%2F%2Fgithub.com%2Fnuxt%2Fvue-meta" target="_blank" rel="noopener noreferrer">vue-meta<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 库就是为了解决这样的问题，让我们可以直接在组件中写一些 Head 标签，然后在服务端能够拿到组件内部的状态。这里我以一个<code>react-helmet</code>例子来说明:</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token comment">// 前端组件逻辑</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Helmet <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;react-helmet&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">App</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> data <span class="token punctuation">}</span> <span class="token operator">=</span> props<span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    <span class="token operator">&lt;</span>div<span class="token operator">&gt;</span>
       <span class="token operator">&lt;</span>Helmet<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>title<span class="token operator">&gt;</span><span class="token punctuation">{</span> data<span class="token punctuation">.</span>user <span class="token punctuation">}</span>的页面<span class="token operator">&lt;</span><span class="token operator">/</span>title<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>link rel<span class="token operator">=</span><span class="token string">&quot;canonical&quot;</span> href<span class="token operator">=</span><span class="token string">&quot;http://mysite.com/example&quot;</span> <span class="token operator">/</span><span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span><span class="token operator">/</span>Helmet<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">// 服务端逻辑</span>
<span class="token keyword">import</span> Helmet <span class="token keyword">from</span> <span class="token string">'react-helmet'</span><span class="token punctuation">;</span>

<span class="token comment">// renderToString 执行之后</span>
<span class="token keyword">const</span> helmet <span class="token operator">=</span> Helmet<span class="token punctuation">.</span><span class="token function">renderStatic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;title 内容: &quot;</span><span class="token punctuation">,</span> helmet<span class="token punctuation">.</span>title<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;link 内容: &quot;</span><span class="token punctuation">,</span> helmet<span class="token punctuation">.</span>link<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><p>如此一来，我们就能根据组件的状态确定 Head 内容，然后在<code>拼接 HTML</code>阶段将这些内容插入到模板中。</p> <h3 id="流式渲染"><a href="#流式渲染" class="header-anchor">#</a> 流式渲染</h3> <p>在不同前端框架的底层都实现了流式渲染的能力，即边渲染边响应，而不是等整个组件树渲染完毕之后再响应，这么做可以让响应提前到达浏览器，提升首屏的加载性能。Vue 中的 <a href="https://link.juejin.cn/?target=https%3A%2F%2Fwww.npmjs.com%2Fpackage%2F%40vue%2Fserver-renderer" target="_blank" rel="noopener noreferrer">renderToNodeStream<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 和 React 中的 <a href="https://link.juejin.cn/?target=https%3A%2F%2Freactjs.org%2Fdocs%2Freact-dom-server.html%23rendertonodestream" target="_blank" rel="noopener noreferrer">renderToNodeStream<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 都实现了流式渲染的能力, 大致的使用方式如下:</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> renderToNodeStream <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react-dom/server'</span><span class="token punctuation">;</span>

<span class="token comment">// 返回一个 Nodejs 的 Stream 对象</span>
<span class="token keyword">const</span> stream <span class="token operator">=</span> <span class="token function">renderToNodeStream</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> html <span class="token operator">=</span> <span class="token string">''</span>

stream<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'data'</span><span class="token punctuation">,</span> data <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  html <span class="token operator">+=</span> data<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token comment">// 发送响应</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

stream<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'end'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>html<span class="token punctuation">)</span> <span class="token comment">// 渲染完成</span>
  <span class="token comment">// 发送响应</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

stream<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'error'</span><span class="token punctuation">,</span> err <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// 错误处理</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p>不过，流式渲染在我们带来首屏性能提升的同时，也给我们带来了一些限制: <strong>如果我们需要在 HTML 中填入一些与组件状态相关的内容，则不能使用流式渲染</strong>。比如<code>react-helmet</code>中自定义的 head 内容，即便在渲染组件的时候收集到了 head 信息，但在流式渲染中，此时 HTML 的 head 部分已经发送给浏览器了，而这部分响应内容已经无法更改，因此 <code>react-helmet</code> 在 SSR 过程中将会失效。</p> <h3 id="ssr-缓存"><a href="#ssr-缓存" class="header-anchor">#</a> SSR 缓存</h3> <p>SSR 是一种典型的 CPU 密集型操作，为了尽可能降低线上机器的负载，设置缓存是一个非常重要的环节。在 SSR 运行时，缓存的内容可以分为这么几个部分:</p> <ul><li><code>文件读取缓存</code>。尽可能避免多次重复读磁盘的操作，每次磁盘 IO 尽可能地复用缓存结果。如下代码所示:</li></ul> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token keyword">function</span> <span class="token function">createMemoryFsRead</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> fileContentMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token keyword">async</span> <span class="token punctuation">(</span>filePath<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> cacheResult <span class="token operator">=</span> fileContentMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>filePath<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>cacheResult<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> cacheResult<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">const</span> fileContent <span class="token operator">=</span> <span class="token keyword">await</span> fs<span class="token punctuation">.</span><span class="token function">readFile</span><span class="token punctuation">(</span>filePath<span class="token punctuation">)</span><span class="token punctuation">;</span>
    fileContentMap<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>filePath<span class="token punctuation">,</span> fileContent<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> fileContent<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> memoryFsRead <span class="token operator">=</span> <span class="token function">createMemoryFsRead</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">memoryFsRead</span><span class="token punctuation">(</span><span class="token string">'file1'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 直接复用缓存</span>
<span class="token function">memoryFsRead</span><span class="token punctuation">(</span><span class="token string">'file1'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><ul><li><code>预取数据缓存</code>。对于某些实时性不高的接口数据，我们可以采取缓存的策略，在下次相同的请求进来时复用之前预取数据的结果，这样预取数据过程的各种 IO 消耗，也可以一定程度上减少首屏时间。</li> <li><code>HTML 渲染缓存</code>。拼接完成的<code>HTML</code>内容是缓存的重点，如果能将这部分进行缓存，那么下次命中缓存之后，将可以节省 <code>renderToString</code>、<code>HTML 拼接</code>等一系列的消耗，服务端的性能收益会比较明显。</li></ul> <p>对于以上的缓存内容，具体的缓存位置可以是：</p> <ul><li><code>服务器内存</code>。如果是放到内存中，需要考虑缓存淘汰机制，防止内存过大导致服务宕机，一个典型的缓存淘汰方案是 <a href="https://link.juejin.cn/?target=https%3A%2F%2Fgithub.com%2Fisaacs%2Fnode-lru-cache" target="_blank" rel="noopener noreferrer">lru-cache<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> (基于 LRU 算法)。</li> <li><a href="https://link.juejin.cn/?target=https%3A%2F%2Fgithub.com%2Fredis%2Fnode-redis" target="_blank" rel="noopener noreferrer">Redis 数据库<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>，相当于以传统后端服务器的设计思路来处理缓存。</li> <li>CDN 服务。我们可以将页面内容缓存到 CDN 服务上，在下一次相同的请求进来时，使用 CDN 上的缓存内容，而不用消费源服务器的资源。对于 CDN 上的 SSR 缓存，大家可以通过阅读<a href="https://juejin.cn/post/6887884087915184141#heading-8" target="_blank" rel="noopener noreferrer">这篇文章<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>深入了解。</li></ul> <p>需要补充的是，Vue 中另外实现了<a href="https://link.juejin.cn/?target=https%3A%2F%2Fssr.vuejs.org%2Fzh%2Fguide%2Fcaching.html%23%E7%BB%84%E4%BB%B6%E7%BA%A7%E5%88%AB%E7%BC%93%E5%AD%98-component-level-caching" target="_blank" rel="noopener noreferrer">组件级别的缓存<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>，这部分缓存一般放在内存中，可以实现更细粒度的 SSR 缓存。</p> <h3 id="性能监控"><a href="#性能监控" class="header-anchor">#</a> 性能监控</h3> <p>在实际的 SSR 项目中，我们时常会遇到一些 SSR 线上性能问题，如果没有一个完整的性能监控机制，那么将很难发现和排查问题。对于 SSR 性能数据，有一些比较通用的指标:</p> <ul><li>SSR 产物加载时间</li> <li>数据预取的时间</li> <li>组件渲染的时间</li> <li>服务端接受请求到响应的完整时间</li> <li>SSR 缓存命中情况</li> <li>SSR 成功率、错误日志</li></ul> <p>我们可以通过<code>perf_hooks</code>来完成数据的采集，如下代码所示:</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> performance<span class="token punctuation">,</span> PerformanceObserver <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'perf_hooks'</span><span class="token punctuation">;</span>

<span class="token comment">// 初始化监听器逻辑</span>
<span class="token keyword">const</span> perfObserver <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PerformanceObserver</span><span class="token punctuation">(</span><span class="token punctuation">(</span>items<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  items<span class="token punctuation">.</span><span class="token function">getEntries</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>entry <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> 
    <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'[performance]'</span><span class="token punctuation">,</span> entry<span class="token punctuation">.</span>name<span class="token punctuation">,</span> entry<span class="token punctuation">.</span>duration<span class="token punctuation">.</span><span class="token function">toFixed</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'ms'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  performance<span class="token punctuation">.</span><span class="token function">clearMarks</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

perfObserver<span class="token punctuation">.</span><span class="token function">observe</span><span class="token punctuation">(</span><span class="token punctuation">{</span> entryTypes<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;measure&quot;</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// 接下来我们在 SSR 进行打点</span>
<span class="token comment">// 以 renderToString  为例</span>
performance<span class="token punctuation">.</span><span class="token function">mark</span><span class="token punctuation">(</span><span class="token string">'render-start'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// renderToString 代码省略</span>
performance<span class="token punctuation">.</span><span class="token function">mark</span><span class="token punctuation">(</span><span class="token string">'render-end'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
performance<span class="token punctuation">.</span><span class="token function">measure</span><span class="token punctuation">(</span><span class="token string">'renderToString'</span><span class="token punctuation">,</span> <span class="token string">'render-start'</span><span class="token punctuation">,</span> <span class="token string">'render-end'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>同样的，我们可以将其它阶段的指标通过上述的方式收集起来，作为性能日志；另一方面，在生产环境下，我们一般需要结合具体的性能监控平台，对上述的各项指标进行打点上报，完成线上的 SSR 性能监控服务。</p> <h3 id="ssg-isr-spr"><a href="#ssg-isr-spr" class="header-anchor">#</a> SSG/ISR/SPR</h3> <p>有时候对于一些静态站点(如博客、文档)，不涉及到动态变化的数据，因此我们并不需要用上服务端渲染。此时只需要在构建阶段产出完整的 HTML 进行部署即可，这种构建阶段生成 HTML 的做法也叫<code>SSG</code>(Static Site Generation，静态站点生成)。</p> <p>SSG 与 SSR 最大的区别就是产出 HTML 的时间点从 SSR <code>运行时</code>变成了<code>构建时</code>，但核心的生命周期流程并没有发生变化:</p> <p><img src="/blog/images/devops/vite-ssr3.png" alt="vite-ssr3"></p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token comment">// scripts/ssg.ts</span>
<span class="token comment">// 以下的工具函数均可以从 SSR 流程复用</span>
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">ssg</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 1. 加载服务端入口</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> ServerEntry<span class="token punctuation">,</span> fetchData <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">loadSsrEntryModule</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 2. 数据预取</span>
  <span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fetchData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 3. 组件渲染</span>
  <span class="token keyword">const</span> appHtml <span class="token operator">=</span> <span class="token function">renderToString</span><span class="token punctuation">(</span>React<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span>ServerEntry<span class="token punctuation">,</span> <span class="token punctuation">{</span> data <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 4. HTML 拼接</span>
  <span class="token keyword">const</span> template <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">resolveTemplatePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> templateHtml <span class="token operator">=</span> <span class="token keyword">await</span> fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span>template<span class="token punctuation">,</span> <span class="token string">'utf-8'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> html <span class="token operator">=</span> templateHtml
  <span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token string">'&lt;!-- SSR_APP --&gt;'</span><span class="token punctuation">,</span> appHtml<span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>
    <span class="token string">'&lt;!-- SSR_DATA --&gt;'</span><span class="token punctuation">,</span>
    <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;script&gt;window.__SSR_DATA__=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&lt;/script&gt;</span><span class="token template-punctuation string">`</span></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token comment">// 最后，我们需要将 HTML 的内容写到磁盘中，将其作为构建产物</span>
  fs<span class="token punctuation">.</span><span class="token function">mkdirSync</span><span class="token punctuation">(</span><span class="token string">'./dist/client'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> recursive<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  fs<span class="token punctuation">.</span><span class="token function">writeFileSync</span><span class="token punctuation">(</span><span class="token string">'./dist/client/index.html'</span><span class="token punctuation">,</span> html<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">ssg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><p>接着你可以在<code>package.json</code>中加入这样一段 npm scripts:</p> <div class="language-json line-numbers-mode"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;scripts&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;build:ssg&quot;</span><span class="token operator">:</span> <span class="token string">&quot;npm run build &amp;&amp; NODE_ENV=production esno scripts/ssg.ts&quot;</span>  
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>这样我们便初步实现了 SSG 的逻辑。当然，除了 SSG，业界还流传着一些其它的渲染模式，诸如<code>SPR</code>、<code>ISR</code>，听起来比较高大上，但实际上只是 SSR 和 SSG 所衍生出来的新功能罢了，这里简单给大家解释一下:</p> <ul><li><code>SPR</code>即<code>Serverless Pre Render</code>，即把 SSR 的服务部署到 Serverless(FaaS) 环境中，实现服务器实例的自动扩缩容，降低服务器运维的成本。</li> <li><code>ISR</code>即<code>Incremental Site Rendering</code>，即增量站点渲染，将一部分的 SSG 逻辑从构建时搬到了 <code>SSR</code> 运行时，解决的是大量页面 SSG 构建耗时长的问题。</li></ul> <h2 id="小结"><a href="#小结" class="header-anchor">#</a> 小结</h2> <p>首先，我给你介绍了 SSR 的基本概念，先分析传统的 CSR 到底存在哪些问题，然后介绍 SSR 是如何解决这些问题的。接着我给你分析了 SSR 应用的生命周期，主要包含<code>构建时</code>和<code>运行时</code>两个部分，带你从宏观上了解了要实现 SSR 究竟需要做哪些事情。当然，光介绍概念是远远不够的，在接下来的时间，我用具体的项目示例带你一步步搭建起了一个简单的 SSR 工程，借助 <code>Vite</code>实现了<code>客户端产物</code>与<code>SSR 产物</code>的构建，然后通过 SSR 中间件的开发实现了 SSR 运行时的逻辑，包括<code>加载服务端入口</code>、<code>数据预取</code>、<code>组件渲染</code>和<code>HTML 拼接</code>这四个核心的步骤。</p> <p>虽然说基于示例代码我们可以搭建 Vite 的 SSR 项目，但面对实际的开发场景，我们仍然需要考虑诸多的工程化问题。其中包括<code>路由管理</code>、<code>状态管理</code>、<code>CSR 降级</code>、<code>浏览器 API 的 SSR 兼容</code>、<code>自定义 Head</code>、<code>流式渲染</code>、<code>SSR 缓存</code>、<code>性能监控</code>以及更多的预渲染模式<code>SSG/SPR/ISR</code>。</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/blog/devops/vite/hmr.html" class="prev">
        Vite HMR 热更新
      </a></span> <span class="next"><a href="/blog/devops/vite/legacy.html">
        兼容性问题
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----><!----><!----><!----></div></div>
    <script src="/blog/assets/js/app.f064466e.js" defer></script><script src="/blog/assets/js/2.dec2e75d.js" defer></script><script src="/blog/assets/js/1.5b9e135c.js" defer></script><script src="/blog/assets/js/113.d7cac620.js" defer></script><script src="/blog/assets/js/20.badbb211.js" defer></script>
  </body>
</html>
