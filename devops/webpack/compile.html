<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>模块编译及运行时 | 前端那些事儿</title>
    <meta name="generator" content="VuePress 1.9.10">
    <link rel="icon" href="/blog/logo.png">
    <link rel="manifest" href="/blog/manifest.json">
    <link rel="apple-touch-icon" href="/blog/images/icons/apple-icon-152x152.png">
    <meta name="description" content="我命由我不由天，学习吧少年">
    <meta name="theme-color" content="#3eaf7c">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="msapplication-TileImage" content="/icons/ms-icon-144x144.png">
    <meta name="msapplication-TileColor" content="#000000">
    
    <link rel="preload" href="/blog/assets/css/0.styles.76cb5f71.css" as="style"><link rel="preload" href="/blog/assets/js/app.88ac7007.js" as="script"><link rel="preload" href="/blog/assets/js/2.dc7ae5f9.js" as="script"><link rel="preload" href="/blog/assets/js/1.70fc1187.js" as="script"><link rel="preload" href="/blog/assets/js/113.fe84b5c8.js" as="script"><link rel="preload" href="/blog/assets/js/20.36f36c92.js" as="script"><link rel="prefetch" href="/blog/assets/js/10.8765323e.js"><link rel="prefetch" href="/blog/assets/js/100.bf26d8d4.js"><link rel="prefetch" href="/blog/assets/js/101.976d4f86.js"><link rel="prefetch" href="/blog/assets/js/102.14eedb5b.js"><link rel="prefetch" href="/blog/assets/js/103.665dad0b.js"><link rel="prefetch" href="/blog/assets/js/104.b2228b10.js"><link rel="prefetch" href="/blog/assets/js/105.3065c3be.js"><link rel="prefetch" href="/blog/assets/js/106.0133a069.js"><link rel="prefetch" href="/blog/assets/js/107.f41f32d0.js"><link rel="prefetch" href="/blog/assets/js/108.f6e93fc5.js"><link rel="prefetch" href="/blog/assets/js/109.ac02adbe.js"><link rel="prefetch" href="/blog/assets/js/11.2cc42d06.js"><link rel="prefetch" href="/blog/assets/js/110.38736bc0.js"><link rel="prefetch" href="/blog/assets/js/111.2173c68d.js"><link rel="prefetch" href="/blog/assets/js/112.5cae8bd8.js"><link rel="prefetch" href="/blog/assets/js/114.49455f09.js"><link rel="prefetch" href="/blog/assets/js/115.6ae25dee.js"><link rel="prefetch" href="/blog/assets/js/116.324f1790.js"><link rel="prefetch" href="/blog/assets/js/117.6b0050af.js"><link rel="prefetch" href="/blog/assets/js/118.207d3e3e.js"><link rel="prefetch" href="/blog/assets/js/119.7fa62ef5.js"><link rel="prefetch" href="/blog/assets/js/12.75981b02.js"><link rel="prefetch" href="/blog/assets/js/120.08404f50.js"><link rel="prefetch" href="/blog/assets/js/121.33252574.js"><link rel="prefetch" href="/blog/assets/js/122.379d9f46.js"><link rel="prefetch" href="/blog/assets/js/123.44ca9fc9.js"><link rel="prefetch" href="/blog/assets/js/124.df07e24c.js"><link rel="prefetch" href="/blog/assets/js/125.87d50edb.js"><link rel="prefetch" href="/blog/assets/js/126.9ed4dca9.js"><link rel="prefetch" href="/blog/assets/js/127.c819299b.js"><link rel="prefetch" href="/blog/assets/js/128.403981e1.js"><link rel="prefetch" href="/blog/assets/js/129.d6710d57.js"><link rel="prefetch" href="/blog/assets/js/13.0209b501.js"><link rel="prefetch" href="/blog/assets/js/130.3900fd4f.js"><link rel="prefetch" href="/blog/assets/js/131.14fc533c.js"><link rel="prefetch" href="/blog/assets/js/132.8fe0776f.js"><link rel="prefetch" href="/blog/assets/js/133.b503545b.js"><link rel="prefetch" href="/blog/assets/js/134.f744876e.js"><link rel="prefetch" href="/blog/assets/js/135.f6fbd562.js"><link rel="prefetch" href="/blog/assets/js/136.21426a2b.js"><link rel="prefetch" href="/blog/assets/js/137.ea5cfd63.js"><link rel="prefetch" href="/blog/assets/js/138.f74ec496.js"><link rel="prefetch" href="/blog/assets/js/139.3683fadb.js"><link rel="prefetch" href="/blog/assets/js/14.099935e4.js"><link rel="prefetch" href="/blog/assets/js/140.ba7a28b9.js"><link rel="prefetch" href="/blog/assets/js/141.4e4bf6f9.js"><link rel="prefetch" href="/blog/assets/js/142.a29d4427.js"><link rel="prefetch" href="/blog/assets/js/143.1f2bdec3.js"><link rel="prefetch" href="/blog/assets/js/144.89b915bc.js"><link rel="prefetch" href="/blog/assets/js/145.1751462f.js"><link rel="prefetch" href="/blog/assets/js/146.922091df.js"><link rel="prefetch" href="/blog/assets/js/147.9fb489f5.js"><link rel="prefetch" href="/blog/assets/js/148.4f02d6be.js"><link rel="prefetch" href="/blog/assets/js/149.33a1be32.js"><link rel="prefetch" href="/blog/assets/js/15.1742d511.js"><link rel="prefetch" href="/blog/assets/js/150.2b09a871.js"><link rel="prefetch" href="/blog/assets/js/151.40682293.js"><link rel="prefetch" href="/blog/assets/js/152.309a2016.js"><link rel="prefetch" href="/blog/assets/js/153.c4a96cdb.js"><link rel="prefetch" href="/blog/assets/js/154.75d51a65.js"><link rel="prefetch" href="/blog/assets/js/155.14d8f889.js"><link rel="prefetch" href="/blog/assets/js/156.b9d6a6b0.js"><link rel="prefetch" href="/blog/assets/js/157.bb8d8303.js"><link rel="prefetch" href="/blog/assets/js/158.3557d807.js"><link rel="prefetch" href="/blog/assets/js/159.ec2b7c53.js"><link rel="prefetch" href="/blog/assets/js/16.fd5c64c0.js"><link rel="prefetch" href="/blog/assets/js/160.7c5ba294.js"><link rel="prefetch" href="/blog/assets/js/161.f2f9c93c.js"><link rel="prefetch" href="/blog/assets/js/162.7636ea8a.js"><link rel="prefetch" href="/blog/assets/js/163.468fb0c6.js"><link rel="prefetch" href="/blog/assets/js/164.ae0637d2.js"><link rel="prefetch" href="/blog/assets/js/165.6f204368.js"><link rel="prefetch" href="/blog/assets/js/166.b915eab1.js"><link rel="prefetch" href="/blog/assets/js/167.feb43552.js"><link rel="prefetch" href="/blog/assets/js/168.9eee96b9.js"><link rel="prefetch" href="/blog/assets/js/169.d2228021.js"><link rel="prefetch" href="/blog/assets/js/17.eaa22719.js"><link rel="prefetch" href="/blog/assets/js/170.b0104490.js"><link rel="prefetch" href="/blog/assets/js/171.72b5b5a1.js"><link rel="prefetch" href="/blog/assets/js/172.0c674282.js"><link rel="prefetch" href="/blog/assets/js/173.5c228a59.js"><link rel="prefetch" href="/blog/assets/js/174.2767000c.js"><link rel="prefetch" href="/blog/assets/js/175.24bc60de.js"><link rel="prefetch" href="/blog/assets/js/176.35b74147.js"><link rel="prefetch" href="/blog/assets/js/177.6ca34089.js"><link rel="prefetch" href="/blog/assets/js/178.f501c8d2.js"><link rel="prefetch" href="/blog/assets/js/179.ee06ff18.js"><link rel="prefetch" href="/blog/assets/js/18.4d04ed8a.js"><link rel="prefetch" href="/blog/assets/js/180.6989133a.js"><link rel="prefetch" href="/blog/assets/js/181.481e9d65.js"><link rel="prefetch" href="/blog/assets/js/182.a80546b8.js"><link rel="prefetch" href="/blog/assets/js/183.521e36e6.js"><link rel="prefetch" href="/blog/assets/js/184.edbfff0d.js"><link rel="prefetch" href="/blog/assets/js/185.3f599628.js"><link rel="prefetch" href="/blog/assets/js/186.36b513a4.js"><link rel="prefetch" href="/blog/assets/js/187.058fc2c7.js"><link rel="prefetch" href="/blog/assets/js/188.79114cb6.js"><link rel="prefetch" href="/blog/assets/js/189.97e0be42.js"><link rel="prefetch" href="/blog/assets/js/19.16f8a8f3.js"><link rel="prefetch" href="/blog/assets/js/190.e2c38d0c.js"><link rel="prefetch" href="/blog/assets/js/191.49371655.js"><link rel="prefetch" href="/blog/assets/js/192.a197326e.js"><link rel="prefetch" href="/blog/assets/js/193.c53bca00.js"><link rel="prefetch" href="/blog/assets/js/194.b62998c6.js"><link rel="prefetch" href="/blog/assets/js/195.a077fe40.js"><link rel="prefetch" href="/blog/assets/js/196.114f7c20.js"><link rel="prefetch" href="/blog/assets/js/197.a467f715.js"><link rel="prefetch" href="/blog/assets/js/198.5c2fb1ca.js"><link rel="prefetch" href="/blog/assets/js/199.027cc7a7.js"><link rel="prefetch" href="/blog/assets/js/200.7049a079.js"><link rel="prefetch" href="/blog/assets/js/201.4e0f0fc6.js"><link rel="prefetch" href="/blog/assets/js/202.a030b087.js"><link rel="prefetch" href="/blog/assets/js/203.4672ffcf.js"><link rel="prefetch" href="/blog/assets/js/21.5ff741b6.js"><link rel="prefetch" href="/blog/assets/js/22.4c0a24e0.js"><link rel="prefetch" href="/blog/assets/js/23.6e07f643.js"><link rel="prefetch" href="/blog/assets/js/24.af9e309d.js"><link rel="prefetch" href="/blog/assets/js/25.c4741912.js"><link rel="prefetch" href="/blog/assets/js/26.979c135a.js"><link rel="prefetch" href="/blog/assets/js/27.0e523d5c.js"><link rel="prefetch" href="/blog/assets/js/28.1eca3035.js"><link rel="prefetch" href="/blog/assets/js/29.4f51c83f.js"><link rel="prefetch" href="/blog/assets/js/3.d7509571.js"><link rel="prefetch" href="/blog/assets/js/30.dbfb29cd.js"><link rel="prefetch" href="/blog/assets/js/31.33f6f4a7.js"><link rel="prefetch" href="/blog/assets/js/32.bad38436.js"><link rel="prefetch" href="/blog/assets/js/33.0622c4c3.js"><link rel="prefetch" href="/blog/assets/js/34.03bf07bc.js"><link rel="prefetch" href="/blog/assets/js/35.4582d9ee.js"><link rel="prefetch" href="/blog/assets/js/36.1d9b5dca.js"><link rel="prefetch" href="/blog/assets/js/37.713433a4.js"><link rel="prefetch" href="/blog/assets/js/38.336404fc.js"><link rel="prefetch" href="/blog/assets/js/39.f599088d.js"><link rel="prefetch" href="/blog/assets/js/4.73bf4225.js"><link rel="prefetch" href="/blog/assets/js/40.734debda.js"><link rel="prefetch" href="/blog/assets/js/41.35d5ace2.js"><link rel="prefetch" href="/blog/assets/js/42.872f64cf.js"><link rel="prefetch" href="/blog/assets/js/43.df862bb9.js"><link rel="prefetch" href="/blog/assets/js/44.56928ac0.js"><link rel="prefetch" href="/blog/assets/js/45.6454f828.js"><link rel="prefetch" href="/blog/assets/js/46.e6238789.js"><link rel="prefetch" href="/blog/assets/js/47.55621bd4.js"><link rel="prefetch" href="/blog/assets/js/48.29d90b0b.js"><link rel="prefetch" href="/blog/assets/js/49.6bc15464.js"><link rel="prefetch" href="/blog/assets/js/5.ecec2a91.js"><link rel="prefetch" href="/blog/assets/js/50.8869ad2a.js"><link rel="prefetch" href="/blog/assets/js/51.a9216b6c.js"><link rel="prefetch" href="/blog/assets/js/52.4017fa9a.js"><link rel="prefetch" href="/blog/assets/js/53.2a3d3e6b.js"><link rel="prefetch" href="/blog/assets/js/54.a60d1a2e.js"><link rel="prefetch" href="/blog/assets/js/55.1bf58772.js"><link rel="prefetch" href="/blog/assets/js/56.475fd425.js"><link rel="prefetch" href="/blog/assets/js/57.77076362.js"><link rel="prefetch" href="/blog/assets/js/58.7ac1d37a.js"><link rel="prefetch" href="/blog/assets/js/59.c59d0c49.js"><link rel="prefetch" href="/blog/assets/js/6.0172243e.js"><link rel="prefetch" href="/blog/assets/js/60.4ae0b0ba.js"><link rel="prefetch" href="/blog/assets/js/61.4f784b43.js"><link rel="prefetch" href="/blog/assets/js/62.d2465a03.js"><link rel="prefetch" href="/blog/assets/js/63.870bfe38.js"><link rel="prefetch" href="/blog/assets/js/64.1df3ecdf.js"><link rel="prefetch" href="/blog/assets/js/65.4d18ebd9.js"><link rel="prefetch" href="/blog/assets/js/66.7673dfd2.js"><link rel="prefetch" href="/blog/assets/js/67.478ccbce.js"><link rel="prefetch" href="/blog/assets/js/68.a1733588.js"><link rel="prefetch" href="/blog/assets/js/69.a7d0677b.js"><link rel="prefetch" href="/blog/assets/js/7.f1797797.js"><link rel="prefetch" href="/blog/assets/js/70.1f01bf10.js"><link rel="prefetch" href="/blog/assets/js/71.66939d5c.js"><link rel="prefetch" href="/blog/assets/js/72.7900bcdf.js"><link rel="prefetch" href="/blog/assets/js/73.7f8066ca.js"><link rel="prefetch" href="/blog/assets/js/74.2b28f89c.js"><link rel="prefetch" href="/blog/assets/js/75.af97f519.js"><link rel="prefetch" href="/blog/assets/js/76.75646650.js"><link rel="prefetch" href="/blog/assets/js/77.1b4579d3.js"><link rel="prefetch" href="/blog/assets/js/78.d2e23619.js"><link rel="prefetch" href="/blog/assets/js/79.14cc166d.js"><link rel="prefetch" href="/blog/assets/js/80.4fd27dbe.js"><link rel="prefetch" href="/blog/assets/js/81.5e950666.js"><link rel="prefetch" href="/blog/assets/js/82.1318afe3.js"><link rel="prefetch" href="/blog/assets/js/83.a84fa4bf.js"><link rel="prefetch" href="/blog/assets/js/84.94e707bd.js"><link rel="prefetch" href="/blog/assets/js/85.650c44b4.js"><link rel="prefetch" href="/blog/assets/js/86.6768c292.js"><link rel="prefetch" href="/blog/assets/js/87.f1e82e72.js"><link rel="prefetch" href="/blog/assets/js/88.17f551e7.js"><link rel="prefetch" href="/blog/assets/js/89.d12afbed.js"><link rel="prefetch" href="/blog/assets/js/90.92e44c0e.js"><link rel="prefetch" href="/blog/assets/js/91.e9597067.js"><link rel="prefetch" href="/blog/assets/js/92.1641d853.js"><link rel="prefetch" href="/blog/assets/js/93.bd05d341.js"><link rel="prefetch" href="/blog/assets/js/94.c6c1e860.js"><link rel="prefetch" href="/blog/assets/js/95.0388a977.js"><link rel="prefetch" href="/blog/assets/js/96.7041224d.js"><link rel="prefetch" href="/blog/assets/js/97.112b03da.js"><link rel="prefetch" href="/blog/assets/js/98.28186c50.js"><link rel="prefetch" href="/blog/assets/js/99.6796a4e4.js"><link rel="prefetch" href="/blog/assets/js/vendors~docsearch.cdf71c8e.js">
    <link rel="stylesheet" href="/blog/assets/css/0.styles.76cb5f71.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/blog/" class="home-link router-link-active"><img src="/blog/logo.png" alt="前端那些事儿" class="logo"> <span class="site-name can-hide">前端那些事儿</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/blog/" class="nav-link">
  主页
</a></div><div class="nav-item"><a href="/blog/base/" class="nav-link">
  前端基础
</a></div><div class="nav-item"><a href="/blog/vue/" class="nav-link">
  Vue
</a></div><div class="nav-item"><a href="/blog/react/" class="nav-link">
  React
</a></div><div class="nav-item"><a href="/blog/node/" class="nav-link">
  Node
</a></div><div class="nav-item"><a href="/blog/devops/" class="nav-link router-link-active">
  前端工程化
</a></div><div class="nav-item"><a href="/blog/mobile/" class="nav-link">
  泛客户端
</a></div><div class="nav-item"><a href="/blog/architecture/" class="nav-link">
  架构&amp;方案
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="GitHub" class="dropdown-title"><span class="title">GitHub</span> <span class="arrow down"></span></button> <button type="button" aria-label="GitHub" class="mobile-dropdown-title"><span class="title">GitHub</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/jonny-wei" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://github.com/jonny-wei/sushi-js" target="_blank" rel="noopener noreferrer" class="nav-link external">
  JS 寿司
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/blog/" class="nav-link">
  主页
</a></div><div class="nav-item"><a href="/blog/base/" class="nav-link">
  前端基础
</a></div><div class="nav-item"><a href="/blog/vue/" class="nav-link">
  Vue
</a></div><div class="nav-item"><a href="/blog/react/" class="nav-link">
  React
</a></div><div class="nav-item"><a href="/blog/node/" class="nav-link">
  Node
</a></div><div class="nav-item"><a href="/blog/devops/" class="nav-link router-link-active">
  前端工程化
</a></div><div class="nav-item"><a href="/blog/mobile/" class="nav-link">
  泛客户端
</a></div><div class="nav-item"><a href="/blog/architecture/" class="nav-link">
  架构&amp;方案
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="GitHub" class="dropdown-title"><span class="title">GitHub</span> <span class="arrow down"></span></button> <button type="button" aria-label="GitHub" class="mobile-dropdown-title"><span class="title">GitHub</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/jonny-wei" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://github.com/jonny-wei/sushi-js" target="_blank" rel="noopener noreferrer" class="nav-link external">
  JS 寿司
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Webpack</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/devops/" aria-current="page" class="sidebar-link">Webpack 常用配置</a></li><li><a href="/blog/devops/webpack/building.html" class="sidebar-link">构建流程与原理</a></li><li><a href="/blog/devops/webpack/dependency-graph.html" class="sidebar-link">模块依赖关系</a></li><li><a href="/blog/devops/webpack/chunk.html" class="sidebar-link">产物打包逻辑</a></li><li><a href="/blog/devops/webpack/compile.html" aria-current="page" class="active sidebar-link">模块编译及运行时</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/devops/webpack/compile.html#模块转译" class="sidebar-link">模块转译</a></li><li class="sidebar-sub-header"><a href="/blog/devops/webpack/compile.html#模块转译主流程" class="sidebar-link">模块转译主流程</a></li><li class="sidebar-sub-header"><a href="/blog/devops/webpack/compile.html#小结" class="sidebar-link">小结</a></li></ul></li><li><a href="/blog/devops/webpack/hmr.html" class="sidebar-link">HMR 热更新</a></li><li><a href="/blog/devops/webpack/loader.html" class="sidebar-link">Webpack Loader</a></li><li><a href="/blog/devops/webpack/plugin.html" class="sidebar-link">Webpack Plugin</a></li><li><a href="/blog/devops/webpack/module-federation.html" class="sidebar-link">模块联邦</a></li><li><a href="/blog/devops/webpack/cache.html" class="sidebar-link">持久化缓存</a></li><li><a href="/blog/devops/webpack/parallel.html" class="sidebar-link">并行构建</a></li><li><a href="/blog/devops/webpack/split-chunks.html" class="sidebar-link">分包策略</a></li><li><a href="/blog/devops/webpack/compress.html" class="sidebar-link">代码压缩</a></li><li><a href="/blog/devops/webpack/tree-shaking.html" class="sidebar-link">Tree Shaking</a></li><li><a href="/blog/devops/webpack/others.html" class="sidebar-link">Webpack 相关</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Vite</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/devops/vite/esm.html" class="sidebar-link">模块化规范</a></li><li><a href="/blog/devops/vite/css.html" class="sidebar-link">CSS 工程化</a></li><li><a href="/blog/devops/vite/prebuild.html" class="sidebar-link">依赖预构建</a></li><li><a href="/blog/devops/vite/engines.html" class="sidebar-link">双引擎架构</a></li><li><a href="/blog/devops/vite/rollup.html" class="sidebar-link">Rollup 打包</a></li><li><a href="/blog/devops/vite/building.html" class="sidebar-link">Vite 构建原理</a></li><li><a href="/blog/devops/vite/plugin.html" class="sidebar-link">Vite Plugin</a></li><li><a href="/blog/devops/vite/hmr.html" class="sidebar-link">Vite HMR 热更新</a></li><li><a href="/blog/devops/vite/ssr.html" class="sidebar-link">SSR 工程化</a></li><li><a href="/blog/devops/vite/legacy.html" class="sidebar-link">兼容性问题</a></li><li><a href="/blog/devops/vite/split-code.html" class="sidebar-link">代码分割</a></li><li><a href="/blog/devops/vite/vite-news.html" class="sidebar-link">Vite 新特性</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>性能优化</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/devops/performance/indicator.html" class="sidebar-link">性能指标与采集</a></li><li><a href="/blog/devops/performance/webpack.html" class="sidebar-link">打包方面优化</a></li><li><a href="/blog/devops/performance/network.html" class="sidebar-link">网络方面优化</a></li><li><a href="/blog/devops/performance/render.html" class="sidebar-link">渲染方面优化</a></li><li><a href="/blog/devops/performance/code.html" class="sidebar-link">代码方面优化</a></li><li><a href="/blog/devops/performance/analysis.html" class="sidebar-link">打包性能分析工具</a></li><li><a href="/blog/devops/performance/optimization.html" class="sidebar-link">指标性能优化</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>代码与包管理</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/devops/git/git.html" class="sidebar-link">Git</a></li><li><a href="/blog/devops/git/package.html" class="sidebar-link">认识 package.json</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="模块编译及运行时"><a href="#模块编译及运行时" class="header-anchor">#</a> 模块编译及运行时</h1> <p>回顾前几节，Webpack 运行过程中首先会根据 <code>Module</code> 之间的引用关系构建 <code>ModuleGraph</code> 对象；接下来按照若干内置规则将 <code>Module</code> 组织进不同 <code>Chunk</code> 对象中，形成 <code>ChunkGraph</code> 关系图。</p> <p>接着，构建流程将来到最后一个重要步骤：生成产物代码，这个过程会将所有 <code>Module</code> 内容一一转换为适当的产物代码形态，并以 <code>Chunk</code> 为单位合并 <code>Module</code> 产物代码，之后根据 <code>Module</code> 中出现的特性依赖，补充相应运行时代码，最终构建出我们日常所见的 Webpack Bundle 代码文件。</p> <h2 id="模块转译"><a href="#模块转译" class="header-anchor">#</a> 模块转译</h2> <p>Webpack 的打包功能并不是将原始文件代码“复制-粘贴”到产物文件那么简单，为了确保代码能在不同环境 —— 多种版本的浏览器、Node、Electron 等正常运行，构建时需要对模块源码适当做一些转换操作，这一点在大多数构建产物的内容中都有所体现。</p> <p><img src="/blog/images/devops/compile1.png" alt="compile1"></p> <h2 id="模块转译主流程"><a href="#模块转译主流程" class="header-anchor">#</a> 模块转译主流程</h2> <p>剖析模块转译、运行时依赖分析、产物合并的具体实现逻辑。</p> <p><code>compilation.seal</code> 函数内会调用 <code>buildChunkGraph</code> 生成 Chunk 依赖关系图，之后 Webpack 就可以分析出：</p> <ul><li>需要输出那些 Chunk；</li> <li>每个 Chunk 包含那些 Module，以及每个 Module 经过 Loader 翻译后的代码内容；</li> <li>Chunk 与 Chunk 之间的父子依赖关系。</li></ul> <p>在此之后 <code>seal</code> 函数会开始触发一堆优化钩子，借助插件对 ChunkGraph 做诸如合并、拆分、删除无效 Chunk 等优化操作，并在最后调用 <a href="https://link.juejin.cn/?target=https%3A%2F%2Fgithub1s.com%2Fwebpack%2Fwebpack%2Fblob%2FHEAD%2Flib%2FCompilation.js%23L3160-L3162" target="_blank" rel="noopener noreferrer">compilation.codeGeneration<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 方法：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">Compilation</span> <span class="token punctuation">{</span>
  <span class="token function">seal</span><span class="token punctuation">(</span><span class="token parameter">callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 初始化 ChunkGraph、ChunkGroup 对象</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token punctuation">[</span>name<span class="token punctuation">,</span> <span class="token punctuation">{</span> dependencies<span class="token punctuation">,</span> includeDependencies<span class="token punctuation">,</span> options <span class="token punctuation">}</span><span class="token punctuation">]</span> <span class="token keyword">of</span> <span class="token keyword">this</span><span class="token punctuation">.</span>entries<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// ...</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token punctuation">[</span>name<span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token literal-property property">options</span><span class="token operator">:</span> <span class="token punctuation">{</span> dependOn<span class="token punctuation">,</span> runtime <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">]</span> <span class="token keyword">of</span> <span class="token keyword">this</span><span class="token punctuation">.</span>entries<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// ...</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 构建 ChunkGroup</span>
    <span class="token function">buildChunkGraph</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> chunkGraphInit<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 执行诸多优化钩子</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span><span class="token function">optimize</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// ...</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>optimizeTree<span class="token punctuation">.</span><span class="token function">callAsync</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>chunks<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>modules<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token comment">// ...</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>optimizeChunkModules<span class="token punctuation">.</span><span class="token function">callAsync</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>chunks<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>modules<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token comment">// ...</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span><span class="token function">beforeCodeGeneration</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token comment">// 开始生成最终产物代码</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">codeGeneration</span><span class="token punctuation">(</span><span class="token comment">/* ... */</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br></div></div><p><code>codeGeneration</code> 方法负责生成最终的资产代码，主要流程：</p> <p><img src="/blog/images/devops/compile2.png" alt="compile2"></p> <ul><li><p><strong>单模块转译</strong>：这一步主要用于计算模块实际输出代码，遍历 compilation.modules 数组，<a href="https://link.juejin.cn/?target=https%3A%2F%2Fgithub1s.com%2Fwebpack%2Fwebpack%2Fblob%2FHEAD%2Flib%2FCompilation.js%23L3326-L3327" target="_blank" rel="noopener noreferrer">调用<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> module 对象的 <a href="https://link.juejin.cn/?target=https%3A%2F%2Fgithub1s.com%2Fwebpack%2Fwebpack%2Fblob%2FHEAD%2Flib%2FNormalModule.js%23L1172-L1173" target="_blank" rel="noopener noreferrer">codeGeneration<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 方法，执行模块转译计算：</p> <ul><li><p><a href="https://link.juejin.cn/?target=https%3A%2F%2Fgithub1s.com%2Fwebpack%2Fwebpack%2Fblob%2FHEAD%2Flib%2FNormalModule.js%23L1204-L1205" target="_blank" rel="noopener noreferrer">调用<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> JavascriptGenerator 的 <a href="https://link.juejin.cn/?target=https%3A%2F%2Fgithub1s.com%2Fwebpack%2Fwebpack%2Fblob%2FHEAD%2Flib%2Fjavascript%2FJavascriptGenerator.js%23L89-L90" target="_blank" rel="noopener noreferrer">generate<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 方法；</p></li> <li><p><a href="https://link.juejin.cn/?target=https%3A%2F%2Fgithub1s.com%2Fwebpack%2Fwebpack%2Fblob%2FHEAD%2Flib%2Fjavascript%2FJavascriptGenerator.js%23L111-L112" target="_blank" rel="noopener noreferrer">遍历<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> module 对象的 dependencies 与 presentationalDependencies 数组；</p></li> <li><p><a href="https://link.juejin.cn/?target=https%3A%2F%2Fgithub1s.com%2Fwebpack%2Fwebpack%2Fblob%2FHEAD%2Flib%2Fjavascript%2FJavascriptGenerator.js%23L206-L207" target="_blank" rel="noopener noreferrer">执行<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 每个数组项 dependeny 对象对应的 template.apply 方法，方法中视情况可能产生三种副作用：</p> <ul><li>直接修改模块 source 数据，如 <a href="https://link.juejin.cn/?target=https%3A%2F%2Fgithub1s.com%2Fwebpack%2Fwebpack%2Fblob%2FHEAD%2Flib%2Fdependencies%2FConstDependency.js%23L100-L101" target="_blank" rel="noopener noreferrer">ConstDependency.Template<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>；</li> <li>将结果记录到 initFragments 数组如 <a href="https://link.juejin.cn/?target=https%3A%2F%2Fgithub1s.com%2Fwebpack%2Fwebpack%2Fblob%2FHEAD%2Flib%2Fdependencies%2FHarmonyExportSpecifierDependency.js%23L97-L99" target="_blank" rel="noopener noreferrer">HarmonyExportSpecifierDependency<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>；</li> <li>将运行时依赖记录到 runtimeRequirements 数组如 <a href="https://link.juejin.cn/?target=https%3A%2F%2Fgithub1s.com%2Fwebpack%2Fwebpack%2Fblob%2FHEAD%2Flib%2Fdependencies%2FHarmonyImportDependency.js%23L105-L106" target="_blank" rel="noopener noreferrer">HarmonyImportDependency<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。</li></ul></li></ul></li> <li><p><strong>收集运行时依赖</strong>：计算模块运行时，首先调用 compilation.processRuntimeRequirements 方法，将上一步生成的 runtimeRequirements 数组一一转换为 RuntimeModule 对象，并挂载到 ChunkGroup 中。</p></li> <li><p><strong>模块合并</strong>：调用 compilation.createChunkAssets 方法，以 Chunk 为单位，将相应的所有 module 及 runtimeModule 按规则塞进「<strong>产物框架</strong>」 中，最终合并输出成完整的 Bundle 文件。</p></li></ul> <p>这些就是 Webpack 最终消费 ModuleGraph 与 ChunkGraph，生成最终产物代码的关键过程，总结而言，就是先遍历所有模块依赖对象，收集模块编译结果与运行时依赖，之后将这些内容合并在一起输出为 Bundle 文件。</p> <h3 id="单模块转译"><a href="#单模块转译" class="header-anchor">#</a> 单模块转译</h3> <p>「<strong>模块转译</strong>」 操作从 <code>module.codeGeneration</code> 调用开始，对应到上述流程图的：</p> <p><img src="/blog/images/devops/compile3.png" alt="compile3"></p> <p>这个过程首先调用 <code>JavascriptGenerator.generate</code> 函数，遍历模块的 <code>dependencies</code> 数组，依次调用依赖对象对应的 <code>Template</code> 子类 <code>apply</code> 方法更新模块内容，说起来有点绕，我将重要步骤抽取为如下伪代码：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">JavascriptGenerator</span> <span class="token punctuation">{</span>
    <span class="token function">generate</span><span class="token punctuation">(</span><span class="token parameter">module<span class="token punctuation">,</span> generateContext</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 先取出 module 的原始代码内容</span>
        <span class="token keyword">const</span> source <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReplaceSource</span><span class="token punctuation">(</span>module<span class="token punctuation">.</span><span class="token function">originalSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">const</span> <span class="token punctuation">{</span> dependencies<span class="token punctuation">,</span> presentationalDependencies <span class="token punctuation">}</span> <span class="token operator">=</span> module<span class="token punctuation">;</span>
        <span class="token keyword">const</span> initFragments <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> dependency <span class="token keyword">of</span> <span class="token punctuation">[</span><span class="token operator">...</span>dependencies<span class="token punctuation">,</span> <span class="token operator">...</span>presentationalDependencies<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 找到 dependency 对应的 template</span>
            <span class="token keyword">const</span> template <span class="token operator">=</span> generateContext<span class="token punctuation">.</span>dependencyTemplates<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>dependency<span class="token punctuation">.</span>constructor<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 调用 template.apply，传入 source、initFragments</span>
            <span class="token comment">// 在 apply 函数可以直接修改 source 内容，或者更改 initFragments 数组，影响后续转译逻辑</span>
            <span class="token function">template</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>dependency<span class="token punctuation">,</span> source<span class="token punctuation">,</span> <span class="token punctuation">{</span>initFragments<span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 遍历完毕后，调用 InitFragment.addToSource 合并 source 与 initFragments</span>
        <span class="token keyword">return</span> InitFragment<span class="token punctuation">.</span><span class="token function">addToSource</span><span class="token punctuation">(</span>source<span class="token punctuation">,</span> initFragments<span class="token punctuation">,</span> generateContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// Dependency 子类</span>
<span class="token keyword">class</span> <span class="token class-name">xxxDependency</span> <span class="token keyword">extends</span> <span class="token class-name">Dependency</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token comment">// Dependency 子类对应的 Template 定义</span>
<span class="token keyword">const</span> xxxDependency<span class="token punctuation">.</span>Template <span class="token operator">=</span> <span class="token keyword">class</span> <span class="token class-name">xxxDependencyTemplate</span> <span class="token keyword">extends</span> <span class="token class-name">Template</span> <span class="token punctuation">{</span>
    <span class="token function">apply</span><span class="token punctuation">(</span><span class="token parameter">dep<span class="token punctuation">,</span> source<span class="token punctuation">,</span> <span class="token punctuation">{</span>initFragments<span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 1. 直接操作 source，更改模块代码</span>
        source<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>dep<span class="token punctuation">.</span>range<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> dep<span class="token punctuation">.</span>range<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">'some thing'</span><span class="token punctuation">)</span>
        <span class="token comment">// 2. 通过添加 InitFragment 实例，补充代码</span>
        initFragments<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">xxxInitFragment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br></div></div><p>从上述伪代码可以看出，<code>JavascriptGenerator.generate</code> 函数的逻辑相对比较固化：</p> <ol><li>初始化 <code>source</code>、<code>initFragments</code> 等变量；</li> <li>遍历 <code>module</code> 对象的依赖数组，找到每个 <code>dependency</code> 对应的 <code>template</code> 对象，调用 <code>template.apply</code> 函数修改模块内容；</li> <li>调用 <code>InitFragment.addToSource</code> 方法，合并 <code>source</code> 与 <code>initFragments</code> 数组，生成最终结果。</li></ol> <p>这里的重点是 <code>JavascriptGenerator.generate</code> 函数并不操作 <code>module</code> 源码，它仅仅提供一个执行框架，真正处理模块内容转译的逻辑都在 <code>xxxDependencyTemplate</code> 对象的 <code>apply</code> 函数实现。</p> <p>每个 <code>Dependency</code> 子类都会挂载一个 <code>Template</code> 子类，且通常这两个类都会写在同一个文件中，例如 <a href="https://link.juejin.cn/?target=https%3A%2F%2Fgithub1s.com%2Fwebpack%2Fwebpack%2Fblob%2FHEAD%2Flib%2Fdependencies%2FConstDependency.js%23L83-L84" target="_blank" rel="noopener noreferrer">ConstDependency<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 与 <code>ConstDependencyTemplate</code>；<code>NullDependency</code> 与 <code>NullDependencyTemplate</code>。</p> <p>Webpack 从「构建」(make) 阶段开始，就会通过 <code>Dependency</code> 子类记录不同情况下模块之间的依赖关系；到「封装」(seal) 阶段再通过 <code>Template</code> 子类修改 <code>module</code> 代码，最终 <code>Module</code>、<code>Template</code>、 <code>JavascriptGenerator</code>、<code>Dependency</code> 四个关键类形成如下交互关系：</p> <p><img src="/blog/images/devops/compile4.png" alt="compile4"></p> <p><code>Template</code> 对象会通过三种方法影响产物代码：</p> <ul><li>直接操作 <code>source</code> 对象，修改模块代码，该对象最初的内容等于模块的源码，经过多个 <code>Template.apply</code> 函数流转后逐渐被替换成新的代码形式；</li> <li>操作 <code>initFragments</code> 数组，在模块源码之外插入补充代码片段；</li> <li>将运行时依赖记录到 <code>runtimeRequirements</code> 数组。</li></ul> <p>其中第 1、2 种操作所产生的副作用，最终都会被传入 <code>InitFragment.addToSource</code> 函数，合并成最终结果。</p> <h4 id="通过-source-修改模块代码"><a href="#通过-source-修改模块代码" class="header-anchor">#</a> 通过 source 修改模块代码</h4> <p><a href="https://link.juejin.cn/?target=https%3A%2F%2Fgithub.com%2Fwebpack%2Fwebpack-sources" target="_blank" rel="noopener noreferrer">webpack-sources<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 是 Webpack 中用于编辑字符串的一套工具类库，它提供了一系列代码编辑方法，包括：</p> <ul><li>字符串合并、替换、插入等；</li> <li>模块代码缓存、sourcemap 映射、hash 计算等。</li></ul> <p>Webpack 内部以及社区的很多插件、loader 都会使用 <a href="https://link.juejin.cn/?target=https%3A%2F%2Fgithub.com%2Fwebpack%2Fwebpack-sources" target="_blank" rel="noopener noreferrer">webpack-sources<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 库编辑代码内容，包括上文介绍的 <code>Template.apply</code> 体系。逻辑上，在启动模块代码生成流程时，Webpack 会先用模块原始内容<a href="https://link.juejin.cn/?target=https%3A%2F%2Fgithub1s.com%2Fwebpack%2Fwebpack%2Fblob%2FHEAD%2Flib%2Fjavascript%2FJavascriptGenerator.js%23L95-L96" target="_blank" rel="noopener noreferrer">初始化<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> <code>Source</code> 对象，即：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> source <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReplaceSource</span><span class="token punctuation">(</span>module<span class="token punctuation">.</span><span class="token function">originalSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>之后，不同 <code>Dependency</code> 子类按序、按需更改 <code>source</code> 内容。</p> <p>举个例子，对于下面这段简单代码：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">import</span> bar <span class="token keyword">from</span> <span class="token string">&quot;./bar&quot;</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>bar<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>会产生 <code>HarmonyImportSpecifierDependency</code> 与 <code>ConstDependency</code> 两个依赖对象，之后：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">import</span> bar <span class="token keyword">from</span> <span class="token string">&quot;./bar&quot;</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>bar<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 首先，HarmonyImportSpecifierDependency 替换导入变量名：</span>
<span class="token keyword">import</span> bar <span class="token keyword">from</span> <span class="token string">&quot;./bar&quot;</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>_bar__WEBPACK_IMPORTED_MODULE_1__<span class="token punctuation">[</span><span class="token string">&quot;default&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 之后，ConstDependency 删除模块导入语句：</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>_bar__WEBPACK_IMPORTED_MODULE_1__<span class="token punctuation">[</span><span class="token string">&quot;default&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>可以看出，这部分逻辑的效果与 Babel 类似，会直接修改模块源码，实现语言层面的向下兼容。但这还不够，还需要将这段代码包裹进 Webpack 的模块框架中，这部分工作将由 <code>initFragments</code> 数组完成。</p> <h4 id="initfragments-数组的作用"><a href="#initfragments-数组的作用" class="header-anchor">#</a> initFragments 数组的作用</h4> <p>除直接操作 <code>source</code> 外，<code>Template.apply</code> 中还可能通过 <code>initFragments</code> 数组达成修改模块产物的效果。<code>initFragments</code> 数组项为 <a href="https://link.juejin.cn/?target=https%3A%2F%2Fgithub1s.com%2Fwebpack%2Fwebpack%2Fblob%2FHEAD%2Flib%2FInitFragment.js" target="_blank" rel="noopener noreferrer">InitFragment<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 子类实例，它们带有两个关键函数：<code>getContent</code>、<code>getEndContent</code>，分别用于获取代码片段的头尾部分。</p> <p>模块代码合并操作主要就是用 initFragments 数组一层一层包裹住模块代码 source，而两者都在 Template.apply 层面维护。还是上面那个简单例子，经过这段 Template 处理后，最终转化为：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">import</span> bar <span class="token keyword">from</span> <span class="token string">&quot;./bar&quot;</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>bar<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 首先，HarmonyImportSpecifierDependency 替换导入变量名：</span>
<span class="token keyword">import</span> bar <span class="token keyword">from</span> <span class="token string">&quot;./bar&quot;</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>_bar__WEBPACK_IMPORTED_MODULE_1__<span class="token punctuation">[</span><span class="token string">&quot;default&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 之后，ConstDependency 删除模块导入语句：</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>_bar__WEBPACK_IMPORTED_MODULE_1__<span class="token punctuation">[</span><span class="token string">&quot;default&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 经过 ConditionalInitFragment 处理：</span>
<span class="token comment">/* harmony import */</span> <span class="token keyword">var</span> _bar__WEBPACK_IMPORTED_MODULE_1__ <span class="token operator">=</span> <span class="token function">__webpack_require__</span><span class="token punctuation">(</span><span class="token comment">/*! ./bar */</span> <span class="token string">&quot;./src/bar.js&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>_bar__WEBPACK_IMPORTED_MODULE_1__<span class="token punctuation">[</span><span class="token string">&quot;default&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>简单总结一下，Webpack 生成 ModuleGraph 与 ChunkGraph 后，会立即开始遍历所有 Dependency 对象，依次调用对象的静态方法 template.apply 修改 module 代码，最后再将所有变更后的 source 与模块脚手架 initFragments 合并为最终产物，完成从单个模块的源码形态到产物形态的转变。</p> <h3 id="收集运行时模块"><a href="#收集运行时模块" class="header-anchor">#</a> 收集运行时模块</h3> <p>为了正常、正确运行业务项目，Webpack 需要将开发者编写的业务代码以及支撑、调配这些业务代码的 <strong>运行时</strong> 一并打包到产物（bundle）中。例如：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// a.js</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token string">'a module'</span><span class="token punctuation">;</span>

<span class="token comment">// index.js</span>
<span class="token keyword">import</span> name <span class="token keyword">from</span> <span class="token string">'./a'</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p><img src="/blog/images/devops/compile5.png" alt="compile5"></p> <p>可以看出，整个 Bundle 被包裹在一个立即执行函数中，函数内部从上到下依次定义：</p> <ul><li><code>__webpack_modules__</code> 对象，包含了除入口外的所有模块，如示例中的 <code>a.js</code> 模块；</li> <li><code>__webpack_module_cache__</code> 对象，用于存储被引用过的模块；</li> <li><code>__webpack_require__</code> 函数，实现模块引用(require) 逻辑；</li> <li><code>__webpack_require__.d</code> ，工具函数，实现将模块导出的内容附加的模块对象上；</li> <li><code>__webpack_require__.o</code> ，工具函数，判断对象属性用；</li> <li><code>__webpack_require__.r</code> ，工具函数，在 ESM 模式下声明 ESM 模块标识；</li> <li>最后的 IIFE，对应 entry 模块即上述示例的 <code>index.js</code> ，用于启动整个应用。</li></ul> <p>上述函数、对象构成了 Webpack 运行时最基本的能力 —— 模块化，假如代码中用到更多 Webpack 特性，则会相应地注入更多运行时模块代码，例如：</p> <ul><li>使用异步加载时，注入 <code>__webpack_require__.e</code>、<code>__webpack_require__.f</code> 等模块；</li> <li>使用 HMR 时，注入 <code>__webpack_require__.hmrF</code>、<code>webpack/runtime/hot</code> 等模块。</li></ul> <p>那么，Webpack 是如何收集运行时依赖，并将之合并到最终产物中的呢？</p> <h4 id="收集运行时依赖"><a href="#收集运行时依赖" class="header-anchor">#</a> 收集运行时依赖</h4> <p>早在「构建」阶段，Webpack 就已经开始在持续收集运行时依赖，例如，在一个非常简单的模块导入语句中：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">import</span> bar <span class="token keyword">from</span> <span class="token string">'./bar'</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>Webpack 在处理上述代码 AST 时，会相应生成多个依赖对象，比较重要的有：</p> <ul><li><code>HarmonyImportSideEffectDependency</code>：主要的 Dependency 对象，Webpack 会为该对象创建相应的 <code>NormalModule</code> 实例，从而递归处理新模块代码；</li> <li><a href="https://link.juejin.cn/?target=https%3A%2F%2Fgithub1s.com%2Fwebpack%2Fwebpack%2Fblob%2FHEAD%2Flib%2Fdependencies%2FHarmonyCompatibilityDependency.js%23L72-L73" target="_blank" rel="noopener noreferrer">HarmonyCompatibilityDependency<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>：运行时模块依赖，对应的 <a href="https://link.juejin.cn/?target=https%3A%2F%2Fgithub1s.com%2Fwebpack%2Fwebpack%2Fblob%2FHEAD%2Flib%2Fdependencies%2FHarmonyCompatibilityDependency.js%23L72-L73" target="_blank" rel="noopener noreferrer">Template.apply<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 函数会在生成代码时记录相应运行时需求。</li></ul> <p>本质上，这是一个基于静态代码分析的方式收集依赖的过程。当所有模块处理完毕，收集到所有运行时依赖，进入 <code>codeGeneration</code> 函数后，Webpack 会进一步将这些依赖对象挂载到 Chunk 中：</p> <p><img src="/blog/images/devops/compile6.png" alt="compile6"></p> <p>这个过程集中 <code>compilation.processRuntimeRequirements</code> 函数，函数中包含三次循环：</p> <ul><li>第一次循环遍历所有 module，收集所有 module 的 runtime 依赖；</li> <li>第二次循环遍历所有 chunk，将 chunk 下所有 module 的 runtime 统一收录到 chunk 中；</li> <li>第三次循环遍历所有 runtime chunk，收集其对应的子 chunk 下所有 runtime 依赖，之后遍历所有依赖并发布 <code>runtimeRequirementInTree</code> 钩子，（主要是） <code>RuntimePlugin</code> 插件订阅该钩子并根据依赖类型创建对应的 <code>RuntimeModule</code> 子类实例。</li></ul> <h4 id="第一次循环-收集模块依赖"><a href="#第一次循环-收集模块依赖" class="header-anchor">#</a> 第一次循环：收集模块依赖</h4> <p>在上述「模块转译主流程」中，我们聊到 <code>Template.apply</code> 函数可能修改模块的 <code>runtimeRequirements</code> 数组，最终形成如下结构：</p> <p><img src="/blog/images/devops/compile7.png" alt="compile7"></p> <p>这个过程相当于将模块的 Runtime Dependency 都转化为 <code>__webpack_require__</code> 等枚举值，并调用 <code>compilation.processRuntimeRequirements</code> 进入第一重循环，将上述 <code>runtimeRequirements</code> 数组 <a href="https://link.juejin.cn/?target=https%3A%2F%2Fgithub1s.com%2Fwebpack%2Fwebpack%2Fblob%2FHEAD%2Flib%2FCompilation.js%23L3447-L3448" target="_blank" rel="noopener noreferrer">挂载<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 到 <code>ChunkGraph</code> 对象中。</p> <h4 id="第二次循环-整合-chunk-依赖"><a href="#第二次循环-整合-chunk-依赖" class="header-anchor">#</a> 第二次循环：整合 chunk 依赖</h4> <p>第一次循环针对 module 收集依赖，第二次循环则遍历 chunk 数组，收集将其对应所有 module 的 runtime 依赖，例如：</p> <p><img src="/blog/images/devops/compile8.png" alt="compile8"></p> <p>示例图中，<code>module a</code> 包含两个运行时依赖；<code>module b</code> 包含一个运行时依赖，则经过第二次循环整合后，对应的 <code>chunk</code> 会包含两个模块所包含的三个运行时依赖。</p> <h4 id="第三次循环-依赖标识转-runtimemodule-对象"><a href="#第三次循环-依赖标识转-runtimemodule-对象" class="header-anchor">#</a> 第三次循环：依赖标识转 RuntimeModule 对象</h4> <p>源码中，第三次循环的代码最少但逻辑最复杂，大致上执行三个操作：</p> <ul><li>遍历所有 runtime chunk，收集其所有子 chunk 的 runtime 依赖；</li> <li>为该 runtime chunk 下的所有依赖发布 <code>runtimeRequirementInTree</code> 钩子；</li> <li><code>RuntimePlugin</code> 监听钩子，并根据 runtime 依赖的标识信息创建对应的 <code>RuntimeModule</code> 子类对象，并将对象加入到 <code>ModuleDepedencyGraph</code> /<code>ChunkGraph</code> 体系中管理。</li></ul> <p>至此，runtime 依赖完成了从 module 内容解析，到收集，到创建依赖对应的 <code>Module</code> 子类，再将 <code>Module</code> 加入到 <code>ModuleDepedencyGraph</code> /<code>ChunkGraph</code> 体系的全流程，业务代码及运行时代码对应的模块依赖关系图完全 ready，可以准备进入下一阶段 —— 合并最终产物。</p> <h3 id="合并最终产物"><a href="#合并最终产物" class="header-anchor">#</a> 合并最终产物</h3> <p>讲完单个模块转译以及运行时模块收集过程后就是合并最终产物：</p> <p><img src="/blog/images/devops/compile9.png" alt="compile9"></p> <p>流程图中，<code>compilation.codeGeneration</code> 函数执行完毕 —— 也就是模块转译阶段完成后，模块的转译结果会一一保存到 <code>compilation.codeGenerationResults</code> 对象中，之后会启动一个新的执行流程 —— <strong>模块合并打包</strong>。</p> <p><strong>模块合并打包</strong>过程会将 chunk 对应的 module 及 runtimeModule 按规则塞进<strong>模板框架</strong>中，最终合并输出成完整的 bundle 文件，例如上例中：</p> <p><img src="/blog/images/devops/compile10.png" alt="compile10"></p> <p>示例右边 bundle 文件中，红框框出来的部分为用户代码文件及运行时模块生成的产物，其余部分撑起了一个 IIFE 形式的运行框架，即为模板框架，也就是：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> <span class="token comment">// webpackBootstrap</span>
    <span class="token string">&quot;use strict&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> __webpack_modules__ <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">{</span>
        <span class="token string-property property">&quot;module-a&quot;</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">__unused_webpack_module<span class="token punctuation">,</span> __webpack_exports__<span class="token punctuation">,</span> __webpack_require__</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token comment">// ! module 代码，</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token string-property property">&quot;module-b&quot;</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">__unused_webpack_module<span class="token punctuation">,</span> __webpack_exports__<span class="token punctuation">,</span> __webpack_require__</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token comment">// ! module 代码，</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// The module cache</span>
    <span class="token keyword">var</span> __webpack_module_cache__ <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token comment">// The require function</span>
    <span class="token keyword">function</span> <span class="token function">__webpack_require__</span><span class="token punctuation">(</span><span class="token parameter">moduleId</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// ! webpack CMD 实现</span>
    <span class="token punctuation">}</span>
    <span class="token comment">/************************************************************************/</span>
    <span class="token comment">// ! 各种 runtime</span>
    <span class="token comment">/************************************************************************/</span>
    <span class="token keyword">var</span> __webpack_exports__ <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token comment">// This entry need to be wrapped in an IIFE because it need to be isolated against other modules in the chunk.</span>
    <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token comment">// ! entry 模块</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><p>运行框架包含如下关键部分：</p> <ul><li>最外层是一个 IIFE 包裹；</li> <li>一个记录了除 <code>entry</code> 外的其它模块代码的 <code>__webpack_modules__</code> 对象，对象的 key 为模块标志符；值为模块转译后的代码；</li> <li>一个极度简化的 CMD 实现： <code>__webpack_require__</code> 函数；</li> <li>最后，一个包裹了 <code>entry</code> 代码的 IIFE 函数。</li></ul> <p><strong>模块转译</strong> 是将 <code>module</code> 转译为可以在宿主环境如浏览器上运行的代码形式；<strong>收集运行时模块</strong> 负责决定整个 Bundle 需要的骨架代码；而 <strong>模块合并</strong> 操作则串联这些 <code>modules</code> ，使之整体符合开发预期，能够正常运行整个应用逻辑。接下来，我们揭晓这部分代码的生成原理。</p> <p><strong>模块合并主流程：</strong></p> <p>在 <code>compilation.codeGeneration</code> 执行完毕，即所有用户代码模块做完转译，运行时模块都收集完毕作后，<code>seal</code> 函数调用 <code>compilation.createChunkAssets</code> 函数，触发 <code>renderManifest</code> 钩子，<code>JavascriptModulesPlugin</code> 插件监听到这个钩子消息后开始组装 bundle，伪代码：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// Webpack 5</span>
<span class="token comment">// lib/Compilation.js</span>
<span class="token keyword">class</span> <span class="token class-name">Compilation</span> <span class="token punctuation">{</span>
  <span class="token function">seal</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 先把所有模块的代码都转译，准备好</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>codeGenerationResults <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">codeGeneration</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>modules<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 1. 调用 createChunkAssets</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">createChunkAssets</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">createChunkAssets</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 遍历 chunks ，为每个 chunk 执行 render 操作</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> chunk <span class="token keyword">of</span> <span class="token keyword">this</span><span class="token punctuation">.</span>chunks<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 2. 触发 renderManifest 钩子</span>
      <span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span><span class="token function">renderManifest</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
        chunk<span class="token punctuation">,</span>
        <span class="token literal-property property">codeGenerationResults</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>codeGenerationResults<span class="token punctuation">,</span>
        <span class="token operator">...</span>others<span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 提交组装结果</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">emitAsset</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">...</span>others<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// lib/javascript/JavascriptModulesPlugin.js</span>
<span class="token keyword">class</span> <span class="token class-name">JavascriptModulesPlugin</span> <span class="token punctuation">{</span>
  <span class="token function">apply</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    compiler<span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>compilation<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">&quot;JavascriptModulesPlugin&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">compilation</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      compilation<span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>renderManifest<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">&quot;JavascriptModulesPlugin&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">result<span class="token punctuation">,</span> options</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token comment">// JavascriptModulesPlugin 插件中通过 renderManifest 钩子返回组装函数 render</span>
          <span class="token keyword">const</span> <span class="token function-variable function">render</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
            <span class="token comment">// render 内部根据 chunk 内容，选择使用模板 `renderMain` 或 `renderChunk`</span>
            <span class="token comment">// 3. 监听钩子，返回打包函数</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">renderMain</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>

          result<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span> render <span class="token comment">/* arguments */</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">return</span> result<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">renderMain</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">/*  */</span><span class="token punctuation">}</span>

  <span class="token function">renderChunk</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">/*  */</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br></div></div><p>这里的核心逻辑是，<code>compilation</code> 以 <code>renderManifest</code> 钩子方式对外发布 bundle 打包需求； <code>JavascriptModulesPlugin</code> 监听这个钩子，按照 chunk 的内容特性，调用不同的打包函数。</p> <p><code>JavascriptModulesPlugin</code> 内置的打包函数有：</p> <ul><li><code>renderMain</code>：打包主 chunk 时使用；</li> <li><code>renderChunk</code>：打包子 chunk ，如异步模块 chunk 时使用。</li></ul> <p>两个打包函数实现的逻辑接近，都是按顺序拼接各个模块，下面简单介绍下 <code>renderMain</code> 的实现。</p> <p><strong><code>JavascriptModulesPlugin.renderMain</code> 函数：</strong><code>renderMain</code> 函数涉及比较多场景判断，伪代码如下：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">JavascriptModulesPlugin</span> <span class="token punctuation">{</span>
  <span class="token function">renderMain</span><span class="token punctuation">(</span><span class="token parameter">renderContext<span class="token punctuation">,</span> hooks<span class="token punctuation">,</span> compilation</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> chunk<span class="token punctuation">,</span> chunkGraph<span class="token punctuation">,</span> runtimeTemplate <span class="token punctuation">}</span> <span class="token operator">=</span> renderContext<span class="token punctuation">;</span>

    <span class="token keyword">const</span> source <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcatSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// ...</span>
    <span class="token comment">// 1. 先计算出 bundle CMD 核心代码，包含：</span>
    <span class="token comment">//      - &quot;var __webpack_module_cache__ = {};&quot; 语句</span>
    <span class="token comment">//      - &quot;__webpack_require__&quot; 函数</span>
    <span class="token keyword">const</span> bootstrap <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">renderBootstrap</span><span class="token punctuation">(</span>renderContext<span class="token punctuation">,</span> hooks<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 2. 计算出当前 chunk 下，除 entry 外其它模块的代码</span>
    <span class="token keyword">const</span> chunkModules <span class="token operator">=</span> Template<span class="token punctuation">.</span><span class="token function">renderChunkModules</span><span class="token punctuation">(</span>
      renderContext<span class="token punctuation">,</span>
      inlinedModules
        <span class="token operator">?</span> allModules<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">m</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token operator">!</span>inlinedModules<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>m<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token operator">:</span> allModules<span class="token punctuation">,</span>
      <span class="token punctuation">(</span><span class="token parameter">module</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">renderModule</span><span class="token punctuation">(</span>
          module<span class="token punctuation">,</span>
          renderContext<span class="token punctuation">,</span>
          hooks<span class="token punctuation">,</span>
          allStrict <span class="token operator">?</span> <span class="token string">&quot;strict&quot;</span> <span class="token operator">:</span> <span class="token boolean">true</span>
        <span class="token punctuation">)</span><span class="token punctuation">,</span>
      prefix
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 3. 计算出运行时模块代码</span>
    <span class="token keyword">const</span> runtimeModules <span class="token operator">=</span>
      renderContext<span class="token punctuation">.</span>chunkGraph<span class="token punctuation">.</span><span class="token function">getChunkRuntimeModulesInOrder</span><span class="token punctuation">(</span>chunk<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 4. 重点来了，开始拼接 bundle</span>
    <span class="token comment">// 4.1 首先，合并核心 CMD 实现，即上述 bootstrap 代码</span>
    <span class="token keyword">const</span> beforeStartup <span class="token operator">=</span> Template<span class="token punctuation">.</span><span class="token function">asString</span><span class="token punctuation">(</span>bootstrap<span class="token punctuation">.</span>beforeStartup<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;\n&quot;</span><span class="token punctuation">;</span>
    source<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>
      <span class="token keyword">new</span> <span class="token class-name">PrefixSource</span><span class="token punctuation">(</span>
        prefix<span class="token punctuation">,</span>
        useSourceMap
          <span class="token operator">?</span> <span class="token keyword">new</span> <span class="token class-name">OriginalSource</span><span class="token punctuation">(</span>beforeStartup<span class="token punctuation">,</span> <span class="token string">&quot;webpack/before-startup&quot;</span><span class="token punctuation">)</span>
          <span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">RawSource</span><span class="token punctuation">(</span>beforeStartup<span class="token punctuation">)</span>
      <span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 4.2 合并 runtime 模块代码</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>runtimeModules<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> module <span class="token keyword">of</span> runtimeModules<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        compilation<span class="token punctuation">.</span>codeGeneratedModules<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>module<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 4.3 合并除 entry 外其它模块代码</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> m <span class="token keyword">of</span> chunkModules<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> renderedModule <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">renderModule</span><span class="token punctuation">(</span>m<span class="token punctuation">,</span> renderContext<span class="token punctuation">,</span> hooks<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      source<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>renderedModule<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 4.4 合并 entry 模块代码</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>
      hasEntryModules <span class="token operator">&amp;&amp;</span>
      runtimeRequirements<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>RuntimeGlobals<span class="token punctuation">.</span>returnExportsFromRuntime<span class="token punctuation">)</span>
    <span class="token punctuation">)</span> <span class="token punctuation">{</span>
      source<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>prefix<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">return __webpack_exports__;\n</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> source<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br></div></div><p>核心逻辑为：</p> <ul><li>先计算出 bundle CMD 代码，即 <code>__webpack_require__</code> 函数；</li> <li>计算出当前 chunk 下，除 entry 外其它模块代码 <code>chunkModules</code>；</li> <li>计算出运行时模块代码；</li> <li>开始执行合并操作，子步骤有：
<ul><li>合并 CMD 代码；</li> <li>合并 runtime 模块代码；</li> <li>遍历 <code>chunkModules</code> 变量，合并除 entry 外其它模块代码；</li> <li>合并 entry 模块代码。</li></ul></li> <li>返回结果。</li></ul> <p>总结：先计算出不同组成部分的产物形态，之后按顺序拼接打包，输出合并后的版本。</p> <p>至此，Webpack 完成 bundle 的转译、打包流程，后续调用 <code>compilation.emitAsset</code>，将产物内容输出到 <code>output</code> 指定的路径即可，Webpack 单次编译打包过程就结束了。</p> <h2 id="小结"><a href="#小结" class="header-anchor">#</a> 小结</h2> <ul><li>Webpack 构建过程可以简单划分为 Init、Make、Seal 三个阶段；</li> <li>Init 阶段负责初始化 Webpack 内部若干插件与状态，逻辑比较简单；</li> <li>Make 阶段解决资源读入问题，这个阶段会从 Entry —— 入口模块开始，递归读入、解析所有模块内容，并根据模块之间的依赖关系构建 ModuleGraph —— 模块关系图对象；</li> <li>Seal 阶段更复杂：
<ul><li>一方面，根据 ModuleGraph 构建 ChunkGraph；</li> <li>另一方面，开始遍历 ChunkGraph，转译每一个模块代码；</li> <li>最后，将所有模块与模块运行时依赖合并为最终输出的 Bundle —— 资产文件。</li></ul></li></ul></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/blog/devops/webpack/chunk.html" class="prev">
        产物打包逻辑
      </a></span> <span class="next"><a href="/blog/devops/webpack/hmr.html">
        HMR 热更新
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----><!----><!----><!----></div></div>
    <script src="/blog/assets/js/app.88ac7007.js" defer></script><script src="/blog/assets/js/2.dc7ae5f9.js" defer></script><script src="/blog/assets/js/1.70fc1187.js" defer></script><script src="/blog/assets/js/113.fe84b5c8.js" defer></script><script src="/blog/assets/js/20.36f36c92.js" defer></script>
  </body>
</html>
