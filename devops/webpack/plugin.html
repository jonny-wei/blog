<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Webpack Plugin | 前端那些事儿</title>
    <meta name="generator" content="VuePress 1.9.10">
    <link rel="icon" href="/blog/logo.png">
    <link rel="manifest" href="/blog/manifest.json">
    <link rel="apple-touch-icon" href="/blog/images/icons/apple-icon-152x152.png">
    <meta name="description" content="我命由我不由天，学习吧少年">
    <meta name="theme-color" content="#3eaf7c">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="msapplication-TileImage" content="/icons/ms-icon-144x144.png">
    <meta name="msapplication-TileColor" content="#000000">
    
    <link rel="preload" href="/blog/assets/css/0.styles.f0017422.css" as="style"><link rel="preload" href="/blog/assets/js/app.59e6d68a.js" as="script"><link rel="preload" href="/blog/assets/js/2.dec2e75d.js" as="script"><link rel="preload" href="/blog/assets/js/1.5b9e135c.js" as="script"><link rel="preload" href="/blog/assets/js/127.070347f6.js" as="script"><link rel="preload" href="/blog/assets/js/20.badbb211.js" as="script"><link rel="prefetch" href="/blog/assets/js/10.cc7e09f3.js"><link rel="prefetch" href="/blog/assets/js/100.b63af24f.js"><link rel="prefetch" href="/blog/assets/js/101.26398b0c.js"><link rel="prefetch" href="/blog/assets/js/102.12f95af1.js"><link rel="prefetch" href="/blog/assets/js/103.74ccb38f.js"><link rel="prefetch" href="/blog/assets/js/104.f84b4594.js"><link rel="prefetch" href="/blog/assets/js/105.3ada386b.js"><link rel="prefetch" href="/blog/assets/js/106.a0d0f2b2.js"><link rel="prefetch" href="/blog/assets/js/107.d6d3cd73.js"><link rel="prefetch" href="/blog/assets/js/108.cb6fac0d.js"><link rel="prefetch" href="/blog/assets/js/109.c50862b2.js"><link rel="prefetch" href="/blog/assets/js/11.b60c9933.js"><link rel="prefetch" href="/blog/assets/js/110.81f0314b.js"><link rel="prefetch" href="/blog/assets/js/111.8376ee58.js"><link rel="prefetch" href="/blog/assets/js/112.c0d12038.js"><link rel="prefetch" href="/blog/assets/js/113.c21e05b1.js"><link rel="prefetch" href="/blog/assets/js/114.88b4ccf2.js"><link rel="prefetch" href="/blog/assets/js/115.33fe24ec.js"><link rel="prefetch" href="/blog/assets/js/116.9cb72e38.js"><link rel="prefetch" href="/blog/assets/js/117.b9430f57.js"><link rel="prefetch" href="/blog/assets/js/118.7bc5c3d8.js"><link rel="prefetch" href="/blog/assets/js/119.c3a595db.js"><link rel="prefetch" href="/blog/assets/js/12.c53283e7.js"><link rel="prefetch" href="/blog/assets/js/120.162d18a5.js"><link rel="prefetch" href="/blog/assets/js/121.38fd3c8d.js"><link rel="prefetch" href="/blog/assets/js/122.5daeabf9.js"><link rel="prefetch" href="/blog/assets/js/123.53be21a6.js"><link rel="prefetch" href="/blog/assets/js/124.abadd615.js"><link rel="prefetch" href="/blog/assets/js/125.692beb96.js"><link rel="prefetch" href="/blog/assets/js/126.4c5b391f.js"><link rel="prefetch" href="/blog/assets/js/128.acdbcf7c.js"><link rel="prefetch" href="/blog/assets/js/129.ecec9539.js"><link rel="prefetch" href="/blog/assets/js/13.6bdc6b5d.js"><link rel="prefetch" href="/blog/assets/js/130.678ca2e8.js"><link rel="prefetch" href="/blog/assets/js/131.2e7f6aec.js"><link rel="prefetch" href="/blog/assets/js/132.fc32efa3.js"><link rel="prefetch" href="/blog/assets/js/133.7d82b717.js"><link rel="prefetch" href="/blog/assets/js/134.1850dd5c.js"><link rel="prefetch" href="/blog/assets/js/135.0d9b9a23.js"><link rel="prefetch" href="/blog/assets/js/136.691de1f8.js"><link rel="prefetch" href="/blog/assets/js/137.310d57a5.js"><link rel="prefetch" href="/blog/assets/js/138.19f72c84.js"><link rel="prefetch" href="/blog/assets/js/139.491a74e1.js"><link rel="prefetch" href="/blog/assets/js/14.c3201a23.js"><link rel="prefetch" href="/blog/assets/js/140.d8a4d673.js"><link rel="prefetch" href="/blog/assets/js/141.aeec2aed.js"><link rel="prefetch" href="/blog/assets/js/142.3d2315bf.js"><link rel="prefetch" href="/blog/assets/js/143.cd8ac794.js"><link rel="prefetch" href="/blog/assets/js/144.d4dc20a5.js"><link rel="prefetch" href="/blog/assets/js/145.e680c035.js"><link rel="prefetch" href="/blog/assets/js/146.843cbd89.js"><link rel="prefetch" href="/blog/assets/js/147.17003cf1.js"><link rel="prefetch" href="/blog/assets/js/148.e74a6d07.js"><link rel="prefetch" href="/blog/assets/js/149.d81b780c.js"><link rel="prefetch" href="/blog/assets/js/15.a0b9e44e.js"><link rel="prefetch" href="/blog/assets/js/150.cf1bb55f.js"><link rel="prefetch" href="/blog/assets/js/151.88cc7c0c.js"><link rel="prefetch" href="/blog/assets/js/152.815e6190.js"><link rel="prefetch" href="/blog/assets/js/153.b015a4c4.js"><link rel="prefetch" href="/blog/assets/js/154.c0618ec5.js"><link rel="prefetch" href="/blog/assets/js/155.7d7d51ae.js"><link rel="prefetch" href="/blog/assets/js/156.8733e684.js"><link rel="prefetch" href="/blog/assets/js/157.1bcaa452.js"><link rel="prefetch" href="/blog/assets/js/158.6a27d59b.js"><link rel="prefetch" href="/blog/assets/js/159.658d1e7b.js"><link rel="prefetch" href="/blog/assets/js/16.491191e4.js"><link rel="prefetch" href="/blog/assets/js/160.ad3bc230.js"><link rel="prefetch" href="/blog/assets/js/161.3f371219.js"><link rel="prefetch" href="/blog/assets/js/162.6aa0796d.js"><link rel="prefetch" href="/blog/assets/js/163.4293de4b.js"><link rel="prefetch" href="/blog/assets/js/164.2c4d15ea.js"><link rel="prefetch" href="/blog/assets/js/165.9f8004d8.js"><link rel="prefetch" href="/blog/assets/js/166.273c2c00.js"><link rel="prefetch" href="/blog/assets/js/167.a990ce0f.js"><link rel="prefetch" href="/blog/assets/js/168.92e32817.js"><link rel="prefetch" href="/blog/assets/js/169.1cbc230d.js"><link rel="prefetch" href="/blog/assets/js/17.89ec8c57.js"><link rel="prefetch" href="/blog/assets/js/170.bf2a8d53.js"><link rel="prefetch" href="/blog/assets/js/171.c2b6a965.js"><link rel="prefetch" href="/blog/assets/js/172.6c9ee7bf.js"><link rel="prefetch" href="/blog/assets/js/173.11e5764e.js"><link rel="prefetch" href="/blog/assets/js/174.202d7c26.js"><link rel="prefetch" href="/blog/assets/js/175.c268a285.js"><link rel="prefetch" href="/blog/assets/js/176.4e85758b.js"><link rel="prefetch" href="/blog/assets/js/177.3608e43d.js"><link rel="prefetch" href="/blog/assets/js/178.d90b8fcd.js"><link rel="prefetch" href="/blog/assets/js/179.ee8fce39.js"><link rel="prefetch" href="/blog/assets/js/18.b91f1411.js"><link rel="prefetch" href="/blog/assets/js/180.94295080.js"><link rel="prefetch" href="/blog/assets/js/181.b65499ea.js"><link rel="prefetch" href="/blog/assets/js/182.b9cae6df.js"><link rel="prefetch" href="/blog/assets/js/183.5334c8a3.js"><link rel="prefetch" href="/blog/assets/js/184.83e9e65a.js"><link rel="prefetch" href="/blog/assets/js/185.47e2a72b.js"><link rel="prefetch" href="/blog/assets/js/186.789c2b50.js"><link rel="prefetch" href="/blog/assets/js/187.ef716075.js"><link rel="prefetch" href="/blog/assets/js/188.fb14d94e.js"><link rel="prefetch" href="/blog/assets/js/189.af7be37c.js"><link rel="prefetch" href="/blog/assets/js/19.cb1f17c8.js"><link rel="prefetch" href="/blog/assets/js/190.dadd2059.js"><link rel="prefetch" href="/blog/assets/js/191.b8b27ab6.js"><link rel="prefetch" href="/blog/assets/js/192.7ff53284.js"><link rel="prefetch" href="/blog/assets/js/193.0e72f1c7.js"><link rel="prefetch" href="/blog/assets/js/194.c741247f.js"><link rel="prefetch" href="/blog/assets/js/195.06b6a4c1.js"><link rel="prefetch" href="/blog/assets/js/196.cb44416c.js"><link rel="prefetch" href="/blog/assets/js/197.aca0e0ae.js"><link rel="prefetch" href="/blog/assets/js/198.40fddab3.js"><link rel="prefetch" href="/blog/assets/js/199.31ddcecb.js"><link rel="prefetch" href="/blog/assets/js/200.37c27a7e.js"><link rel="prefetch" href="/blog/assets/js/201.38df7733.js"><link rel="prefetch" href="/blog/assets/js/202.bbf6735d.js"><link rel="prefetch" href="/blog/assets/js/203.e33d8a55.js"><link rel="prefetch" href="/blog/assets/js/204.b4ee9e03.js"><link rel="prefetch" href="/blog/assets/js/205.16f979d5.js"><link rel="prefetch" href="/blog/assets/js/206.d7c864f1.js"><link rel="prefetch" href="/blog/assets/js/207.150d8c5d.js"><link rel="prefetch" href="/blog/assets/js/208.69712489.js"><link rel="prefetch" href="/blog/assets/js/209.a8393cdc.js"><link rel="prefetch" href="/blog/assets/js/21.bf0041b7.js"><link rel="prefetch" href="/blog/assets/js/210.2bf50412.js"><link rel="prefetch" href="/blog/assets/js/211.587f0909.js"><link rel="prefetch" href="/blog/assets/js/212.a031f8a0.js"><link rel="prefetch" href="/blog/assets/js/213.9f686e69.js"><link rel="prefetch" href="/blog/assets/js/214.85f0ef23.js"><link rel="prefetch" href="/blog/assets/js/215.df6b88a4.js"><link rel="prefetch" href="/blog/assets/js/216.e247c8d4.js"><link rel="prefetch" href="/blog/assets/js/217.f29af104.js"><link rel="prefetch" href="/blog/assets/js/218.1dd8802c.js"><link rel="prefetch" href="/blog/assets/js/22.48390d4f.js"><link rel="prefetch" href="/blog/assets/js/23.35c4ba93.js"><link rel="prefetch" href="/blog/assets/js/24.36b663f1.js"><link rel="prefetch" href="/blog/assets/js/25.8a4f7dd6.js"><link rel="prefetch" href="/blog/assets/js/26.3a3f8d13.js"><link rel="prefetch" href="/blog/assets/js/27.067ef541.js"><link rel="prefetch" href="/blog/assets/js/28.ab227016.js"><link rel="prefetch" href="/blog/assets/js/29.50e2c405.js"><link rel="prefetch" href="/blog/assets/js/3.cb0627fa.js"><link rel="prefetch" href="/blog/assets/js/30.470a659f.js"><link rel="prefetch" href="/blog/assets/js/31.46150093.js"><link rel="prefetch" href="/blog/assets/js/32.bf429371.js"><link rel="prefetch" href="/blog/assets/js/33.31cfb662.js"><link rel="prefetch" href="/blog/assets/js/34.1d4b19f5.js"><link rel="prefetch" href="/blog/assets/js/35.e732926b.js"><link rel="prefetch" href="/blog/assets/js/36.37c07a11.js"><link rel="prefetch" href="/blog/assets/js/37.8c24ade8.js"><link rel="prefetch" href="/blog/assets/js/38.adac6090.js"><link rel="prefetch" href="/blog/assets/js/39.29b696d0.js"><link rel="prefetch" href="/blog/assets/js/4.cbb57fa7.js"><link rel="prefetch" href="/blog/assets/js/40.25ac0cfe.js"><link rel="prefetch" href="/blog/assets/js/41.6d52a7c7.js"><link rel="prefetch" href="/blog/assets/js/42.900e233a.js"><link rel="prefetch" href="/blog/assets/js/43.8edaefcf.js"><link rel="prefetch" href="/blog/assets/js/44.7064b832.js"><link rel="prefetch" href="/blog/assets/js/45.4162f35e.js"><link rel="prefetch" href="/blog/assets/js/46.853ffd2d.js"><link rel="prefetch" href="/blog/assets/js/47.be6cf846.js"><link rel="prefetch" href="/blog/assets/js/48.0e03fcff.js"><link rel="prefetch" href="/blog/assets/js/49.351df526.js"><link rel="prefetch" href="/blog/assets/js/5.fe065607.js"><link rel="prefetch" href="/blog/assets/js/50.dbf30f84.js"><link rel="prefetch" href="/blog/assets/js/51.aa1502f1.js"><link rel="prefetch" href="/blog/assets/js/52.051274ec.js"><link rel="prefetch" href="/blog/assets/js/53.f2e699e0.js"><link rel="prefetch" href="/blog/assets/js/54.28a6163c.js"><link rel="prefetch" href="/blog/assets/js/55.bd439c79.js"><link rel="prefetch" href="/blog/assets/js/56.895d9536.js"><link rel="prefetch" href="/blog/assets/js/57.0e8f4e7f.js"><link rel="prefetch" href="/blog/assets/js/58.592a495a.js"><link rel="prefetch" href="/blog/assets/js/59.807d909e.js"><link rel="prefetch" href="/blog/assets/js/6.68cda050.js"><link rel="prefetch" href="/blog/assets/js/60.ce08768a.js"><link rel="prefetch" href="/blog/assets/js/61.2c33a76a.js"><link rel="prefetch" href="/blog/assets/js/62.ad4d32f6.js"><link rel="prefetch" href="/blog/assets/js/63.ef7a1c14.js"><link rel="prefetch" href="/blog/assets/js/64.74a6341a.js"><link rel="prefetch" href="/blog/assets/js/65.29b44d0e.js"><link rel="prefetch" href="/blog/assets/js/66.02ce144f.js"><link rel="prefetch" href="/blog/assets/js/67.6020d42f.js"><link rel="prefetch" href="/blog/assets/js/68.249d1600.js"><link rel="prefetch" href="/blog/assets/js/69.e1d857c7.js"><link rel="prefetch" href="/blog/assets/js/7.3b8d63a0.js"><link rel="prefetch" href="/blog/assets/js/70.ef2df8e0.js"><link rel="prefetch" href="/blog/assets/js/71.070fff66.js"><link rel="prefetch" href="/blog/assets/js/72.2dc92d35.js"><link rel="prefetch" href="/blog/assets/js/73.07008de9.js"><link rel="prefetch" href="/blog/assets/js/74.5061c878.js"><link rel="prefetch" href="/blog/assets/js/75.8cc6fda1.js"><link rel="prefetch" href="/blog/assets/js/76.8b3739b7.js"><link rel="prefetch" href="/blog/assets/js/77.a37537ca.js"><link rel="prefetch" href="/blog/assets/js/78.45288a2b.js"><link rel="prefetch" href="/blog/assets/js/79.fa24985a.js"><link rel="prefetch" href="/blog/assets/js/80.a8e14c69.js"><link rel="prefetch" href="/blog/assets/js/81.bf1b2ea9.js"><link rel="prefetch" href="/blog/assets/js/82.d4807a66.js"><link rel="prefetch" href="/blog/assets/js/83.7ffb6487.js"><link rel="prefetch" href="/blog/assets/js/84.150cff7e.js"><link rel="prefetch" href="/blog/assets/js/85.31f56ab1.js"><link rel="prefetch" href="/blog/assets/js/86.e3d004f2.js"><link rel="prefetch" href="/blog/assets/js/87.7ad2b4a6.js"><link rel="prefetch" href="/blog/assets/js/88.962e38e9.js"><link rel="prefetch" href="/blog/assets/js/89.6652b576.js"><link rel="prefetch" href="/blog/assets/js/90.f2a0d2ed.js"><link rel="prefetch" href="/blog/assets/js/91.1896f07b.js"><link rel="prefetch" href="/blog/assets/js/92.5b0606ae.js"><link rel="prefetch" href="/blog/assets/js/93.de577040.js"><link rel="prefetch" href="/blog/assets/js/94.97f1188b.js"><link rel="prefetch" href="/blog/assets/js/95.c4580227.js"><link rel="prefetch" href="/blog/assets/js/96.61c82c05.js"><link rel="prefetch" href="/blog/assets/js/97.cb7da797.js"><link rel="prefetch" href="/blog/assets/js/98.bab7d49d.js"><link rel="prefetch" href="/blog/assets/js/99.a46ccd97.js"><link rel="prefetch" href="/blog/assets/js/vendors~docsearch.bd3cdb54.js">
    <link rel="stylesheet" href="/blog/assets/css/0.styles.f0017422.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/blog/" class="home-link router-link-active"><img src="/blog/logo.png" alt="前端那些事儿" class="logo"> <span class="site-name can-hide">前端那些事儿</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/blog/" class="nav-link">
  主页
</a></div><div class="nav-item"><a href="/blog/base/" class="nav-link">
  前端基础
</a></div><div class="nav-item"><a href="/blog/vue/" class="nav-link">
  Vue
</a></div><div class="nav-item"><a href="/blog/react/" class="nav-link">
  React
</a></div><div class="nav-item"><a href="/blog/devops/" class="nav-link router-link-active">
  前端工程化
</a></div><div class="nav-item"><a href="/blog/mobile/" class="nav-link">
  泛客户端
</a></div><div class="nav-item"><a href="/blog/architecture/" class="nav-link">
  架构与方案
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="GitHub" class="dropdown-title"><span class="title">GitHub</span> <span class="arrow down"></span></button> <button type="button" aria-label="GitHub" class="mobile-dropdown-title"><span class="title">GitHub</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/jonny-wei" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://github.com/jonny-wei/sushi-js" target="_blank" rel="noopener noreferrer" class="nav-link external">
  JS 寿司
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/blog/" class="nav-link">
  主页
</a></div><div class="nav-item"><a href="/blog/base/" class="nav-link">
  前端基础
</a></div><div class="nav-item"><a href="/blog/vue/" class="nav-link">
  Vue
</a></div><div class="nav-item"><a href="/blog/react/" class="nav-link">
  React
</a></div><div class="nav-item"><a href="/blog/devops/" class="nav-link router-link-active">
  前端工程化
</a></div><div class="nav-item"><a href="/blog/mobile/" class="nav-link">
  泛客户端
</a></div><div class="nav-item"><a href="/blog/architecture/" class="nav-link">
  架构与方案
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="GitHub" class="dropdown-title"><span class="title">GitHub</span> <span class="arrow down"></span></button> <button type="button" aria-label="GitHub" class="mobile-dropdown-title"><span class="title">GitHub</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/jonny-wei" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://github.com/jonny-wei/sushi-js" target="_blank" rel="noopener noreferrer" class="nav-link external">
  JS 寿司
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Webpack</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/devops/" aria-current="page" class="sidebar-link">Webpack 常用配置</a></li><li><a href="/blog/devops/webpack/building.html" class="sidebar-link">构建流程与原理</a></li><li><a href="/blog/devops/webpack/dependency-graph.html" class="sidebar-link">模块依赖关系</a></li><li><a href="/blog/devops/webpack/chunk.html" class="sidebar-link">产物打包逻辑</a></li><li><a href="/blog/devops/webpack/compile.html" class="sidebar-link">模块编译及运行时</a></li><li><a href="/blog/devops/webpack/hmr.html" class="sidebar-link">HMR 热更新</a></li><li><a href="/blog/devops/webpack/loader.html" class="sidebar-link">Webpack Loader</a></li><li><a href="/blog/devops/webpack/plugin.html" aria-current="page" class="active sidebar-link">Webpack Plugin</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/devops/webpack/plugin.html#理解-plugin" class="sidebar-link">理解 Plugin</a></li><li class="sidebar-sub-header"><a href="/blog/devops/webpack/plugin.html#实例分析" class="sidebar-link">实例分析</a></li><li class="sidebar-sub-header"><a href="/blog/devops/webpack/plugin.html#插件架构" class="sidebar-link">插件架构</a></li><li class="sidebar-sub-header"><a href="/blog/devops/webpack/plugin.html#tapable-浅析" class="sidebar-link">Tapable 浅析</a></li><li class="sidebar-sub-header"><a href="/blog/devops/webpack/plugin.html#hook-类型汇总" class="sidebar-link">Hook 类型汇总</a></li><li class="sidebar-sub-header"><a href="/blog/devops/webpack/plugin.html#hook-动态编译" class="sidebar-link">Hook 动态编译</a></li><li class="sidebar-sub-header"><a href="/blog/devops/webpack/plugin.html#小结" class="sidebar-link">小结</a></li></ul></li><li><a href="/blog/devops/webpack/module-federation.html" class="sidebar-link">模块联邦</a></li><li><a href="/blog/devops/webpack/cache.html" class="sidebar-link">持久化缓存</a></li><li><a href="/blog/devops/webpack/parallel.html" class="sidebar-link">并行构建</a></li><li><a href="/blog/devops/webpack/split-chunks.html" class="sidebar-link">分包策略</a></li><li><a href="/blog/devops/webpack/compress.html" class="sidebar-link">代码压缩</a></li><li><a href="/blog/devops/webpack/tree-shaking.html" class="sidebar-link">Tree Shaking</a></li><li><a href="/blog/devops/webpack/others.html" class="sidebar-link">Webpack 相关</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Vite</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/devops/vite/esm.html" class="sidebar-link">模块化规范</a></li><li><a href="/blog/devops/vite/css.html" class="sidebar-link">CSS 工程化</a></li><li><a href="/blog/devops/vite/prebuild.html" class="sidebar-link">依赖预构建</a></li><li><a href="/blog/devops/vite/engines.html" class="sidebar-link">双引擎架构</a></li><li><a href="/blog/devops/vite/rollup.html" class="sidebar-link">Rollup 打包</a></li><li><a href="/blog/devops/vite/building.html" class="sidebar-link">Vite 构建原理</a></li><li><a href="/blog/devops/vite/plugin.html" class="sidebar-link">Vite Plugin</a></li><li><a href="/blog/devops/vite/hmr.html" class="sidebar-link">Vite HMR 热更新</a></li><li><a href="/blog/devops/vite/ssr.html" class="sidebar-link">SSR 工程化</a></li><li><a href="/blog/devops/vite/legacy.html" class="sidebar-link">兼容性问题</a></li><li><a href="/blog/devops/vite/split-code.html" class="sidebar-link">代码分割</a></li><li><a href="/blog/devops/vite/mini.html" class="sidebar-link">Vite Mini 实现</a></li><li><a href="/blog/devops/vite/vite-news.html" class="sidebar-link">Vite 新特性</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>性能优化</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/devops/performance/indicator.html" class="sidebar-link">性能指标与采集</a></li><li><a href="/blog/devops/performance/webpack.html" class="sidebar-link">打包方面优化</a></li><li><a href="/blog/devops/performance/network.html" class="sidebar-link">网络方面优化</a></li><li><a href="/blog/devops/performance/render.html" class="sidebar-link">渲染方面优化</a></li><li><a href="/blog/devops/performance/code.html" class="sidebar-link">代码方面优化</a></li><li><a href="/blog/devops/performance/analysis.html" class="sidebar-link">打包性能分析工具</a></li><li><a href="/blog/devops/performance/optimization.html" class="sidebar-link">指标性能优化</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>代码与包管理</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/devops/git/git.html" class="sidebar-link">Git</a></li><li><a href="/blog/devops/git/package.html" class="sidebar-link">包管理 及 package.json</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="webpack-plugin"><a href="#webpack-plugin" class="header-anchor">#</a> Webpack Plugin</h1> <h2 id="理解-plugin"><a href="#理解-plugin" class="header-anchor">#</a> 理解 Plugin</h2> <p>Webpack Plugin 其实就是一个普通的函数，在该函数中需要我们定制一个 apply 方法。当 Webpack 内部进行插件挂载时会执行 apply 函数。我们可以在 apply 方法中订阅各种生命周期钩子，当到达对应的时间点时就会执行。</p> <p>插件通常是一个带有 <code>apply</code> 函数的类。Webpack 在启动时会调用插件对象的 <code>apply</code> 函数，并以参数方式传递核心对象 <code>compiler</code> ，以此为起点，插件内可以注册 <code>compiler</code> 对象及其子对象的钩子(<a href="https://link.juejin.cn/?target=https%3A%2F%2Fwebpack.js.org%2Fapi%2Fplugins%2F" target="_blank" rel="noopener noreferrer">Hook<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>)回调，例如：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">SomePlugin</span> <span class="token punctuation">{</span>
  <span class="token function">apply</span><span class="token punctuation">(</span><span class="token parameter">compiler</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    compiler<span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>thisCompilation<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">&quot;SomePlugin&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">compilation</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      compilation<span class="token punctuation">.</span><span class="token function">addModule</span><span class="token punctuation">(</span><span class="token comment">/* ... */</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>示例中的 <code>compiler</code> 为 Hook 挂载的对象；<code>thisCompilation</code> 为 Hook 名称；后面调用的 <code>tap</code> 为调用方式，支持 <code>tap/tapAsync/tapPromise</code> 等。</p> <p>在 Webpack 运行过程中，随着构建流程的推进会触发各个钩子回调，并传入上下文参数(例如上例回调函数中的 <code>compilation</code> 对象)，插件可以通过调用上下文接口、修改上下文状态等方式「篡改」构建逻辑，从而将扩展代码「勾入」到 Webpack 构建流程中。</p> <p>基于 Hook 这一设计，开发插件时我们需要重点关注两个问题：</p> <ol><li>针对插件需求，我们应该使用什么钩子？</li> <li>选定钩子后，我怎么跟上下文参数交互？</li></ol> <h3 id="什么时候触发什么构子"><a href="#什么时候触发什么构子" class="header-anchor">#</a> 什么时候触发什么构子</h3> <p>Webpack5 暴露了多达 200+ 个 Hook，基本上覆盖了整个构建流程的所有环节 —— 这也就意味着通过编写插件，我们几乎可以改写 Webpack 的所有执行逻辑。问题是，我们在什么情况下该用什么钩子？这就需要了解 Webpack 内部几个核心对象，以及各对象下 Hook 的触发时机，例如：</p> <ul><li><a href="https://link.juejin.cn/?target=https%3A%2F%2Fwebpack.js.org%2Fapi%2Fcompiler-hooks%2F" target="_blank" rel="noopener noreferrer">Compiler<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>：全局构建管理器，Webpack 启动后会首先创建 <code>compiler</code> 对象，负责管理配置信息、Loader、Plugin 等。从启动构建到结束，<code>compiler</code> 大致上会触发如下钩子：</li></ul> <p><img src="/blog/images/devops/plugin1.png" alt="plugin1"></p> <ul><li><a href="https://link.juejin.cn/?target=https%3A%2F%2Fwebpack.js.org%2Fapi%2Fcompilation-hooks%2F" target="_blank" rel="noopener noreferrer">Compilation<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>：单次构建过程的管理器，负责遍历模块，执行编译操作；当 <code>watch = true</code> 时，每次文件变更触发重新编译，都会创建一个新的 <code>compilation</code> 对象；<code>compilation</code> 生命周期中主要触发如下钩子：</li></ul> <p><img src="/blog/images/devops/plugin2.png" alt="plugin2"></p> <ul><li>此外，还有 <a href="https://link.juejin.cn/?target=https%3A%2F%2Fwebpack.js.org%2Fapi%2Fnormalmodulefactory-hooks%2F" target="_blank" rel="noopener noreferrer">Module<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>、Resolver、<a href="https://link.juejin.cn/?target=https%3A%2F%2Fwebpack.js.org%2Fapi%2Fparser%2F" target="_blank" rel="noopener noreferrer">Parser<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>、Generator 等关键类型，也都相应暴露了许多 Hook。</li></ul> <p>由此可见，Webpack Hook 与构建流程强相关，使用时结合上面流程图分析 Hook 对应的流程环节，以及这个环节主要完成了什么工作，可以借助 Hook 做出哪些修改。</p> <h3 id="使用-hook-上下文接口"><a href="#使用-hook-上下文接口" class="header-anchor">#</a> 使用 Hook 上下文接口</h3> <p>Webpack Hook 有两个重点，一是上面介绍的触发时机；二是触发时传递的上下文参数。例如：</p> <ul><li><code>compiler.hooks.compilation</code>：
<ul><li>时机：Webpack 刚启动完，创建出 <code>compilation</code> 对象后触发；</li> <li>参数：当前编译的 <code>compilation</code> 对象。</li></ul></li> <li><code>compiler.hooks.make</code>：
<ul><li>时机：正式开始构建时触发；</li> <li>参数：同样是当前编译的 <code>compilation</code> 对象。</li></ul></li> <li><code>compilation.hooks.optimizeChunks</code>：
<ul><li>时机： <code>seal</code> 函数中，<code>chunk</code> 集合构建完毕后触发；</li> <li>参数：<code>chunks</code> 集合与 <code>chunkGroups</code> 集合。</li></ul></li> <li><code>compiler.hooks.done</code>：
<ul><li>时机：编译完成后触发；</li> <li>参数： <code>stats</code> 对象，包含编译过程中的各类统计信息。</li></ul></li></ul> <p>每个钩子传递的上下文参数不同，但主要包含如下几种类型(以 Webpack5 为例)：</p> <ul><li>complation 对象：构建管理器，使用率非常高，主要提供了一系列与单次构建相关的接口，包括：
<ul><li><code>addModule</code>：用于添加模块，例如 Module 遍历出依赖之后，就会调用该接口将新模块添加到构建需求中；</li> <li><code>addEntry</code>：添加新的入口模块，效果与直接定义 <code>entry</code> 配置相似；</li> <li><code>emitAsset</code>：用于添加产物文件，效果与 Loader Context 的 <code>emitAsset</code> 相同；</li> <li><code>getDependencyReference</code>：从给定模块返回对依赖项的引用，常用于计算模块引用关系；</li> <li>等等。</li></ul></li> <li>compiler 对象：全局构建管理器，提供如下接口：
<ul><li><code>createChildCompiler</code>：创建子 <code>compiler</code> 对象，子对象将继承原始 Compiler 对象的所有配置数据；</li> <li><code>createCompilation</code>：创建 <code>compilation</code> 对象，可以借此实现并行编译；</li> <li><code>close</code>：结束编译；</li> <li><code>getCache</code>：获取缓存接口，可借此复用 Webpack5 的缓存功能；</li> <li><code>getInfrastructureLogger</code>：获取<a href="https://link.juejin.cn/?target=https%3A%2F%2Fwebpack.js.org%2Fconfiguration%2Fother-options%2F%23infrastructurelogging" target="_blank" rel="noopener noreferrer">日志对象<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>；</li> <li>等等。</li></ul></li> <li>module 对象：资源模块，有诸如<code>NormalModule/RawModule/ContextModule</code>等子类型，其中 <code>NormalModule</code> 使用频率较高，提供如下接口：
<ul><li><code>identifier</code>：读取模块的唯一标识符；</li> <li><code>getCurrentLoader</code>：获取当前正在执行的 Loader 对象；</li> <li><code>originalSource</code>：读取模块原始内容；</li> <li><code>serialize/deserialize</code>：模块序列化与反序列化函数，用于实现持久化缓存，一般不需要调用；</li> <li><code>issuer</code>：模块的引用者；</li> <li><code>isEntryModule</code>：用于判断该模块是否为入口文件；</li> <li>等等。</li></ul></li> <li>chunk 对象：模块封装容器，提供如下接口：
<ul><li><code>addModule</code>：添加模块，之后该模块会与 Chunk 中其它模块一起打包，生成最终产物；</li> <li><code>removeModule</code>：删除模块；</li> <li><code>containsModule</code>：判断是否包含某个特定模块；</li> <li><code>size</code>：推断最终构建出的产物大小；</li> <li><code>hasRuntime</code>：判断 Chunk 中是否包含运行时代码；</li> <li><code>updateHash</code>：计算 Hash 值。</li></ul></li> <li><a href="https://link.juejin.cn/?target=https%3A%2F%2Fwebpack.js.org%2Fapi%2Fstats%2F" target="_blank" rel="noopener noreferrer">stats<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 对象：构建过程收集到的统计信息，包括模块构建耗时、模块依赖关系、产物文件列表等。</li></ul> <h2 id="实例分析"><a href="#实例分析" class="header-anchor">#</a> 实例分析</h2> <h3 id="imagemin-webpack-plugin"><a href="#imagemin-webpack-plugin" class="header-anchor">#</a> imagemin-webpack-plugin</h3> <p>如何遍历、修改最终产物文件？</p> <p><a href="https://link.juejin.cn/?target=https%3A%2F%2Fgithub1s.com%2FKlathmon%2Fimagemin-webpack-plugin" target="_blank" rel="noopener noreferrer">imagemin-webpack-plugin<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 是一个用于实现图像压缩的插件，它会在 Webpack 完成前置的代码分析构建，提交(<a href="https://link.juejin.cn/?target=https%3A%2F%2Fwebpack.js.org%2Fapi%2Fcompiler-hooks%2F%23emit" target="_blank" rel="noopener noreferrer">emit<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>)产物时，找出所有图片资源并调用 <a href="https://link.juejin.cn/?target=https%3A%2F%2Fgithub.com%2Fimagemin%2Fimagemin" target="_blank" rel="noopener noreferrer">imagemin<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 压缩图像。核心逻辑：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">ImageminPlugin</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">options <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// init options</span>
  <span class="token punctuation">}</span>

  <span class="token function">apply</span><span class="token punctuation">(</span><span class="token parameter">compiler</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
    <span class="token keyword">const</span> <span class="token function-variable function">onEmit</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">compilation<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token comment">// ...</span>
      <span class="token keyword">await</span> Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
        <span class="token operator">...</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">optimizeWebpackImages</span><span class="token punctuation">(</span>throttle<span class="token punctuation">,</span> compilation<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token operator">...</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">optimizeExternalImages</span><span class="token punctuation">(</span>throttle<span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    compiler<span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>emit<span class="token punctuation">.</span><span class="token function">tapAsync</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>constructor<span class="token punctuation">.</span>name<span class="token punctuation">,</span> onEmit<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">optimizeWebpackImages</span><span class="token punctuation">(</span><span class="token parameter">throttle<span class="token punctuation">,</span> compilation</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

  <span class="token function">optimizeExternalImages</span><span class="token punctuation">(</span><span class="token parameter">throttle</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><p>上述代码主要用到 <code>compiler.hooks.emit</code> 钩子，该钩子在 Webpack 完成代码构建与打包操作，准备将产物发送到输出目录之前执行，我们可以在此修改产物内容，如上例 <code>optimizeWebpackImages</code> 函数：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">ImageminPlugin</span> <span class="token punctuation">{</span>
  <span class="token function">optimizeWebpackImages</span><span class="token punctuation">(</span><span class="token parameter">throttle<span class="token punctuation">,</span> compilation</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span>
        <span class="token comment">// 用于判断是否对特定文件做图像压缩操作</span>
        testFunction<span class="token punctuation">,</span>
        <span class="token comment">// 缓存目录</span>
        cacheFolder
      <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>options
  
    <span class="token comment">// 遍历 `assets` 产物数组</span>
      <span class="token keyword">return</span> <span class="token function">map</span><span class="token punctuation">(</span>compilation<span class="token punctuation">.</span>assets<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">asset<span class="token punctuation">,</span> filename</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">throttle</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token comment">// 读取产物内容</span>
        <span class="token keyword">const</span> assetSource <span class="token operator">=</span> asset<span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">testFunction</span><span class="token punctuation">(</span>filename<span class="token punctuation">,</span> assetSource<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// 尝试从缓存中读取</span>
          <span class="token keyword">let</span> optimizedImageBuffer <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">getFromCacheIfPossible</span><span class="token punctuation">(</span>cacheFolder<span class="token punctuation">,</span> assetSource<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token comment">// 调用 `imagemin` 压缩图片</span>
            <span class="token keyword">return</span> <span class="token function">optimizeImage</span><span class="token punctuation">(</span>assetSource<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">)</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span>
  
          <span class="token comment">// 之后，使用优化版本替换原始文件</span>
          compilation<span class="token punctuation">.</span>assets<span class="token punctuation">[</span>filename<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RawSource</span><span class="token punctuation">(</span>optimizedImageBuffer<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><p>这里面的关键逻辑是：</p> <ol><li>遍历 <code>compilation.assets</code> 产物列表，调用 <code>asset.source()</code> 方法读取产物内容；</li> <li>调用 <code>imagemin</code> 压缩图片；</li> <li>修改 <code>compilation.assets</code>，使用优化后的图片 <code>RawSource</code> 对象替换原始 <code>asset</code> 对象。</li></ol> <p>至此完成文件压缩操作。</p> <div class="custom-block tip"><p class="custom-block-title">提示</p> <p><code>Source</code> 是 Webpack 内代表资源内容的类，由 <a href="https://link.juejin.cn/?target=https%3A%2F%2Fgithub1s.com%2Fwebpack%2Fwebpack-sources%2Fblob%2FHEAD%2Flib%2Findex.js" target="_blank" rel="noopener noreferrer">webpack-source<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 库实现，支持 <code>RawSource/ConcatSource</code> 等子类型，用于实现文件读写、合并、修改、Sourcemap 等操作。</p></div> <h3 id="eslint-webpack-plugin"><a href="#eslint-webpack-plugin" class="header-anchor">#</a> eslint-webpack-plugin</h3> <p>如何提交错误日志?</p> <p><a href="https://link.juejin.cn/?target=https%3A%2F%2Fgithub1s.com%2Fwebpack-contrib%2Feslint-webpack-plugin" target="_blank" rel="noopener noreferrer">eslint-webpack-plugin<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 是一个基于 ESLint 实现的代码风格检查插件，它的实现比较巧妙，一是使用多个 Hook，在不同时间点执行 Lint 检查；二是复用 Webpack 内置的 <code>error/warn</code> 方法提交代码风格问题。核心逻辑：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">ESLintWebpackPlugin</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">options <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
  <span class="token punctuation">}</span>

  <span class="token function">apply</span><span class="token punctuation">(</span><span class="token parameter">compiler</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    compiler<span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>run<span class="token punctuation">.</span><span class="token function">tapPromise</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>key<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">c</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> options<span class="token punctuation">,</span> wanted<span class="token punctuation">,</span> exclude<span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">async</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token parameter">compiler<span class="token punctuation">,</span> options<span class="token punctuation">,</span> wanted<span class="token punctuation">,</span> exclude</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    compiler<span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>compilation<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>key<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">compilation</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token punctuation">(</span><span class="token punctuation">{</span> lint<span class="token punctuation">,</span> report<span class="token punctuation">,</span> threads <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">linter</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>key<span class="token punctuation">,</span> options<span class="token punctuation">,</span> compilation<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">const</span> files <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

      <span class="token comment">// 单个模块成功编译后触发</span>
      compilation<span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>succeedModule<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>key<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> resource <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token comment">// 判断是否需要检查该文件</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>
          <span class="token function">isMatch</span><span class="token punctuation">(</span>file<span class="token punctuation">,</span> wanted<span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">dot</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
          <span class="token operator">!</span><span class="token function">isMatch</span><span class="token punctuation">(</span>file<span class="token punctuation">,</span> exclude<span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">dot</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">lint</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// 所有模块构建完毕后触发</span>
      compilation<span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>finishModules<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>key<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>files<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> threads <span class="token operator">&lt;=</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">lint</span><span class="token punctuation">(</span>files<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// 等待检查结果</span>
      compilation<span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>additionalAssets<span class="token punctuation">.</span><span class="token function">tapPromise</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>key<span class="token punctuation">,</span> processResults<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">processResults</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br></div></div><p>代码用到如下 Hook：</p> <ul><li><code>compiler.hooks.compilation</code>：Compiler 环境初始化完毕，创建出 <code>compilation</code> 对象，准备开始执行构建前触发；</li> <li><code>compilation.hooks.succeedModule</code>：Webpack 完成单个「模块」的读入、运行 Loader、AST 分析、依赖分析等操作后触发；</li> <li><code>compilation.hooks.finishModules</code>：Webpack 完成「所有」模块的读入、运行 Loader、依赖分析等操作后触发；</li> <li><code>compilation.hooks.additionalAssets</code>：构建、打包完毕后触发，通常用于为编译创建附加资产。</li></ul> <p>其中，比较重要的是借助 <code>compilation.hooks.succeedModule</code> 钩子，在每个模块处理完毕之后立即通过 <code>lint</code> 函数添加非阻塞代码检查任务，相比于过去的 <a href="https://link.juejin.cn/?target=https%3A%2F%2Fwww.npmjs.com%2Fpackage%2Feslint-loader" target="_blank" rel="noopener noreferrer">eslint-loader<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 的阻塞式执行，这种方式能够提高 ESLint 的并发度，效率更高。</p> <p>其次，借助 <code>compilation.hooks.additionalAssets</code> 钩子，在所有模块处理完毕后读取检查结果 —— 即 <code>processResults</code> 函数，核心代码：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">processResults</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> errors<span class="token punctuation">,</span> warnings <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">report</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>warnings <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>options<span class="token punctuation">.</span>failOnWarning<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    compilation<span class="token punctuation">.</span>warnings<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>warnings<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>warnings <span class="token operator">&amp;&amp;</span> options<span class="token punctuation">.</span>failOnWarning<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    compilation<span class="token punctuation">.</span>errors<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>warnings<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>errors <span class="token operator">&amp;&amp;</span> options<span class="token punctuation">.</span>failOnError<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    compilation<span class="token punctuation">.</span>errors<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>errors<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>errors <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>options<span class="token punctuation">.</span>failOnError<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    compilation<span class="token punctuation">.</span>warnings<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>errors<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>代码读取 ESLint 执行结果(<code>report</code> 函数)，并使用 <code>compilation</code> 的 <code>errors</code> 与 <code>warnings</code> 数组提交错误/警告信息，这种方式只会输出错误信息，不会中断编译流程</p> <h3 id="defineplugin"><a href="#defineplugin" class="header-anchor">#</a> DefinePlugin</h3> <p>插件中如何与 AST 结构交互?</p> <p><a href="https://link.juejin.cn/?target=https%3A%2F%2Fgithub1s.com%2Fwebpack%2Fwebpack" target="_blank" rel="noopener noreferrer">DefinePlugin<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 是 Webpack 官方实现的，用于构建时注入预定义常量的插件，先简单回顾一下<a href="https://link.juejin.cn/?target=https%3A%2F%2Fwebpack.js.org%2Fplugins%2Fdefine-plugin%2F" target="_blank" rel="noopener noreferrer">用法<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>，如：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token punctuation">{</span> DefinePlugin <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;webpack&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> baseConfig <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
  <span class="token literal-property property">plugins</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token keyword">new</span> <span class="token class-name">DefinePlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token constant">PROD</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      <span class="token constant">VERSION</span><span class="token operator">:</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token string">&quot;12.13.0&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>之后，Webpack 会帮我们替换掉代码中所有 <code>DefinePlugin</code> 声明的属性值，例如：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 源码：</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token constant">PROD</span><span class="token punctuation">,</span> <span class="token constant">VERSION</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 构建结果：</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token string">&quot;5fa3b9&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p><code>DefinePlugin</code> 的 <a href="https://link.juejin.cn/?target=https%3A%2F%2Fgithub1s.com%2Fwebpack%2Fwebpack%2Fblob%2FHEAD%2Flib%2FDefinePlugin.js" target="_blank" rel="noopener noreferrer">底层实现<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 比较复杂，需要遍历 AST 找出变量名对应的代码位置之后再做替换，插件核心结构：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">DefinePlugin</span> <span class="token punctuation">{</span>
  <span class="token function">apply</span><span class="token punctuation">(</span><span class="token parameter">compiler</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    compiler<span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>compilation<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span>
      <span class="token string">&quot;DefinePlugin&quot;</span><span class="token punctuation">,</span>
      <span class="token punctuation">(</span><span class="token parameter">compilation<span class="token punctuation">,</span> <span class="token punctuation">{</span> normalModuleFactory <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> <span class="token function-variable function">handler</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">parser</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token comment">// 递归处理 `DefinePlugin` 参数</span>
          <span class="token keyword">const</span> <span class="token function-variable function">walkDefinitions</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">definitions<span class="token punctuation">,</span> prefix</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>definitions<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">key</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
              <span class="token keyword">const</span> code <span class="token operator">=</span> definitions<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span>
              <span class="token keyword">if</span> <span class="token punctuation">(</span>isObject <span class="token comment">/*...*/</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// 递归处理对象属性</span>
                <span class="token function">walkDefinitions</span><span class="token punctuation">(</span>code<span class="token punctuation">,</span> prefix <span class="token operator">+</span> key <span class="token operator">+</span> <span class="token string">&quot;.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">applyObjectDefine</span><span class="token punctuation">(</span>prefix <span class="token operator">+</span> key<span class="token punctuation">,</span> code<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
              <span class="token punctuation">}</span>
              <span class="token function">applyDefineKey</span><span class="token punctuation">(</span>prefix<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token function">applyDefine</span><span class="token punctuation">(</span>prefix <span class="token operator">+</span> key<span class="token punctuation">,</span> code<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span><span class="token punctuation">;</span>

          <span class="token comment">// 替换基本类型的表达式值</span>
          <span class="token keyword">const</span> <span class="token function-variable function">applyDefine</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">key<span class="token punctuation">,</span> code</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isTypeof<span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token comment">// 借助 expression 钩子替换内容</span>
              parser<span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>expression<span class="token punctuation">.</span><span class="token function">for</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">&quot;DefinePlugin&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">expr</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                <span class="token comment">/*...*/</span>
              <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// 处理 `'typeof window': JSON.stringify('object'),` 场景</span>
            parser<span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>typeof<span class="token punctuation">.</span><span class="token function">for</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">&quot;DefinePlugin&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">expr</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
              <span class="token comment">/*...*/</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span><span class="token punctuation">;</span>

          <span class="token comment">// 替换引用类型的表达式值</span>
          <span class="token keyword">const</span> <span class="token function-variable function">applyObjectDefine</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">key<span class="token punctuation">,</span> obj</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token comment">// ...</span>
            parser<span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>expression<span class="token punctuation">.</span><span class="token function">for</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">&quot;DefinePlugin&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">expr</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
              <span class="token comment">/*...*/</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span><span class="token punctuation">;</span>

          <span class="token function">walkDefinitions</span><span class="token punctuation">(</span>definitions<span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>

        <span class="token comment">// 监听 `parser` 钩子</span>
        normalModuleFactory<span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>parser
          <span class="token punctuation">.</span><span class="token function">for</span><span class="token punctuation">(</span><span class="token string">&quot;javascript/auto&quot;</span><span class="token punctuation">)</span>
          <span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">&quot;DefinePlugin&quot;</span><span class="token punctuation">,</span> handler<span class="token punctuation">)</span><span class="token punctuation">;</span>
        normalModuleFactory<span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>parser
          <span class="token punctuation">.</span><span class="token function">for</span><span class="token punctuation">(</span><span class="token string">&quot;javascript/dynamic&quot;</span><span class="token punctuation">)</span>
          <span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">&quot;DefinePlugin&quot;</span><span class="token punctuation">,</span> handler<span class="token punctuation">)</span><span class="token punctuation">;</span>
        normalModuleFactory<span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>parser
          <span class="token punctuation">.</span><span class="token function">for</span><span class="token punctuation">(</span><span class="token string">&quot;javascript/esm&quot;</span><span class="token punctuation">)</span>
          <span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">&quot;DefinePlugin&quot;</span><span class="token punctuation">,</span> handler<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> DefinePlugin<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br></div></div><p>核心逻辑：</p> <ol><li>使用 <code>normalModuleFactory.hooks.parser</code> 钩子(上例 48 行)，在 Webpack 创建出代码解析器 <code>Parser</code> 对象后执行 <code>handler</code> 函数。注意，此时还没有执行代码转 AST 操作；</li> <li><code>walkDefinitions</code> 函数中递归遍历 <code>DefinePlugin</code> 参数对象，为每一个属性注册 <code>parser.hooks.expression</code> 钩子回调，该钩子会在 Webpack 遍历 AST 过程遇到表达式语句时触发；</li> <li>在 <code>parser.hooks.expression</code> 回调中创建新的 <code>Dependency</code> 对象，调用 <a href="https://link.juejin.cn/?target=https%3A%2F%2Fgithub1s.com%2Fwebpack%2Fwebpack%2Fblob%2FHEAD%2Flib%2FModule.js%23L494" target="_blank" rel="noopener noreferrer">addPresentationalDependency<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 添加为模块依赖：</li></ol> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token function-variable function">toConstantDependency</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">parser<span class="token punctuation">,</span> value<span class="token punctuation">,</span> runtimeRequirements</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token function">constDependency</span><span class="token punctuation">(</span><span class="token parameter">expr</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> dep <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConstDependency</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> expr<span class="token punctuation">.</span>range<span class="token punctuation">,</span> runtimeRequirements<span class="token punctuation">)</span><span class="token punctuation">;</span>
    dep<span class="token punctuation">.</span>loc <span class="token operator">=</span> expr<span class="token punctuation">.</span>loc<span class="token punctuation">;</span>
    <span class="token comment">// 创建静态依赖对象，替换 loc 指定位置内容</span>
    parser<span class="token punctuation">.</span>state<span class="token punctuation">.</span>module<span class="token punctuation">.</span><span class="token function">addPresentationalDependency</span><span class="token punctuation">(</span>dep<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">applyDefine</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">key<span class="token punctuation">,</span> code</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  parser<span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>expression<span class="token punctuation">.</span><span class="token function">for</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">&quot;DefinePlugin&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">expr</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> strCode <span class="token operator">=</span> <span class="token function">toCode</span><span class="token punctuation">(</span><span class="token comment">/*...*/</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token comment">/*...*/</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">/*...*/</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token function">toConstantDependency</span><span class="token punctuation">(</span>parser<span class="token punctuation">,</span> strCode<span class="token punctuation">)</span><span class="token punctuation">(</span>expr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><p>之后，Webpack 会借助 Template 接口将上述 <code>Dependency</code> 打包进 Chunk 中，替换对应位置(<code>loc</code>)代码。</p> <p>这一个功能效果看起来简单，但实现特别复杂的例子，底层需要使用 Parser 钩子遍历 AST 结构，之后借助 Dependency 声明代码依赖，最后借助 Template 替换代码内容，过程中已经涉及到许多 Webpack 底层对象。</p> <h2 id="插件架构"><a href="#插件架构" class="header-anchor">#</a> 插件架构</h2> <p>插件架构至少需要解决三个方面的问题：</p> <ul><li><strong>接口</strong>：需要提供一套逻辑接入方法，让开发者能够将代码插入特定环节，变更原始逻辑；</li> <li><strong>输入</strong>：如何将上下文信息高效传导给插件；</li> <li><strong>输出</strong>：插件内部通过何种方式影响整套运行体系。</li></ul> <p>针对这些问题，webpack 基于 <a href="https://link.juejin.cn/?target=https%3A%2F%2Fgithub.com%2Fwebpack%2Ftapable" target="_blank" rel="noopener noreferrer">tapable<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 实现了：</p> <ol><li>编译过程的特定节点以钩子形式，通知插件此刻正在发生什么事情；</li> <li>通过 tapable 提供的回调机制，以参数方式传递上下文信息；</li> <li>在上下文参数对象中附带了很多存在 Side Effect 的交互接口，插件可以通过这些接口改变。</li></ol> <p>这一切都离不开 tapable，举例来说：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">Compiler</span> <span class="token punctuation">{</span>
  <span class="token comment">// 在构造函数中，先初始化钩子对象</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>hooks <span class="token operator">=</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">thisCompilation</span><span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">SyncHook</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">&quot;compilation&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;params&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">compile</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 特定时机触发特定钩子</span>
    <span class="token keyword">const</span> compilation <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Compilation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span><span class="token function">thisCompilation</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>compilation<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p><code>Compiler</code> 类型内部定义了 <code>thisCompilation</code> 钩子，并在 <code>compilation</code> 创建完毕后发布事件消息，插件开发者就可以基于这个钩子获取到最新创建出的 <code>compilation</code> 对象：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">SomePlugin</span> <span class="token punctuation">{</span>
  <span class="token function">apply</span><span class="token punctuation">(</span><span class="token parameter">compiler</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    compiler<span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>thisCompilation<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">&quot;SomePlugin&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">compilation<span class="token punctuation">,</span> params</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token comment">// 上下文信息： compilation、params</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>钩子回调传递的 <code>compilation/params</code> 参数，就是 Webpack 希望传递给插件的上下文信息，也是插件能拿到的输入。不同钩子会传递不同的上下文对象，这一点在钩子被创建的时候就定下来了，比如：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">Compiler</span> <span class="token punctuation">{</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>hooks <span class="token operator">=</span> <span class="token punctuation">{</span>
            <span class="token comment">/** @type {SyncBailHook&lt;Compilation&gt;} */</span>
            <span class="token literal-property property">shouldEmit</span><span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">SyncBailHook</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">&quot;compilation&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token comment">/** @type {AsyncSeriesHook&lt;Stats&gt;} */</span>
            <span class="token literal-property property">done</span><span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">AsyncSeriesHook</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">&quot;stats&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token comment">/** @type {AsyncSeriesHook&lt;&gt;} */</span>
            <span class="token literal-property property">additionalPass</span><span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">AsyncSeriesHook</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token comment">/** @type {AsyncSeriesHook&lt;Compiler&gt;} */</span>
            <span class="token literal-property property">beforeRun</span><span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">AsyncSeriesHook</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">&quot;compiler&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token comment">/** @type {AsyncSeriesHook&lt;Compiler&gt;} */</span>
            <span class="token literal-property property">run</span><span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">AsyncSeriesHook</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">&quot;compiler&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token comment">/** @type {AsyncSeriesHook&lt;Compilation&gt;} */</span>
            <span class="token literal-property property">emit</span><span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">AsyncSeriesHook</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">&quot;compilation&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token comment">/** @type {AsyncSeriesHook&lt;string, Buffer&gt;} */</span>
            <span class="token literal-property property">assetEmitted</span><span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">AsyncSeriesHook</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">&quot;file&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;content&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token comment">/** @type {AsyncSeriesHook&lt;Compilation&gt;} */</span>
            <span class="token literal-property property">afterEmit</span><span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">AsyncSeriesHook</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">&quot;compilation&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><ul><li><code>shouldEmit</code> 会被传入 <code>compilation</code> 参数；</li> <li><code>done</code> 会被传入 <code>stats</code> 参数；</li> <li>……</li></ul> <p>这一设计贯穿 Webpack 整个执行过程，几乎无处不在，我们可以借此介入 Webpack 的运行逻辑。</p> <p>插件架构的精髓又在于其灵活多变的 Hook 体系，可以说，只有真正掌握 Hook 底层设计与实现逻辑，深入理解不同 Hook 的运行特性与用法，才能灵活处理各种问题，更快更好地编写出 Webpack 插件。</p> <h2 id="tapable-浅析"><a href="#tapable-浅析" class="header-anchor">#</a> Tapable 浅析</h2> <p>Webpack 的插件体系是一种基于 <a href="https://link.juejin.cn/?target=https%3A%2F%2Fgithub.com%2Fwebpack%2Ftapable" target="_blank" rel="noopener noreferrer">Tapable<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 实现的强耦合架构，它在特定时机触发钩子时会附带上足够的上下文信息，插件定义的钩子回调中，能也只能与这些上下文背后的数据结构、接口交互产生 side effect，进而影响到编译状态和后续流程。</p> <p><a href="https://link.juejin.cn/?target=https%3A%2F%2Fgithub.com%2Fwebpack%2Ftapable" target="_blank" rel="noopener noreferrer">Tapable<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 是 Webpack 插件架构的核心支架，但它的代码量其实很少，本质上就是围绕着 <code>订阅/发布</code> 模式叠加各种特化逻辑，适配 Webpack 体系下复杂的事件源-处理器之间交互需求，比如：</p> <ul><li>有些场景需要支持将前一个处理器的结果传入下一个回调处理器；</li> <li>有些场景需要支持异步并行调用这些回调处理器。</li></ul> <p>先简单看看 Tapable 的用法：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token punctuation">{</span> SyncHook <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;tapable&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 1. 创建钩子实例</span>
<span class="token keyword">const</span> sleep <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SyncHook</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 2. 调用订阅接口注册回调</span>
sleep<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">&quot;test&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;callback A&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 3. 调用发布接口触发回调</span>
<span class="token function">sleep</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 运行结果：</span>
<span class="token comment">// callback A</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>使用 Tapable 时通常需要经历三个步骤：</p> <ul><li>创建钩子实例，如上例第 4 行；</li> <li>调用订阅接口注册回调，包括：<code>tap</code>、<code>tapAsync</code>、<code>tapPromise</code>，如上例第 7 行；</li> <li>调用发布接口触发回调，包括：<code>call</code>、<code>callAsync</code>、<code>promise</code>，如上例第 12 行。</li></ul> <p>Webpack 内部的钩子大体上都遵循上面三个步骤，只是在某些钩子中还可以使用异步风格的 <code>tapAsync/callAsync</code>、promise 风格 <code>tapPromise/promise</code>，具体使用哪一类函数与钩子类型有关。</p> <h2 id="hook-类型汇总"><a href="#hook-类型汇总" class="header-anchor">#</a> Hook 类型汇总</h2> <p>Tabable 提供如下类型的钩子：</p> <table><thead><tr><th>名称</th> <th>简介</th> <th>统计</th></tr></thead> <tbody><tr><td><code>SyncHook</code></td> <td>同步钩子</td> <td>Webpack 共出现 71 次，如 <code>Compiler.hooks.compilation</code></td></tr> <tr><td><code>SyncBailHook</code></td> <td>同步熔断钩子</td> <td>Webpack 共出现 66 次，如 <code>Compiler.hooks.shouldEmit</code></td></tr> <tr><td><code>SyncWaterfallHook</code></td> <td>同步瀑布流钩子</td> <td>Webpack 共出现 37 次，如 <code>Compilation.hooks.assetPath</code></td></tr> <tr><td><code>SyncLoopHook</code></td> <td>同步循环钩子</td> <td>Webpack 中未使用</td></tr> <tr><td><code>AsyncParallelHook</code></td> <td>异步并行钩子</td> <td>Webpack 仅出现 1 次：<code>Compiler.hooks.make</code></td></tr> <tr><td><code>AsyncParallelBailHook</code></td> <td>异步并行熔断钩子</td> <td>Webpack 中未使用</td></tr> <tr><td><code>AsyncSeriesHook</code></td> <td>异步串行钩子</td> <td>Webpack 共出现 16 次，如 <code>Compiler.hooks.done</code></td></tr> <tr><td><code>AsyncSeriesBailHook</code></td> <td>异步串行熔断钩子</td> <td>Webpack 中未使用</td></tr> <tr><td><code>AsyncSeriesLoopHook</code></td> <td>异步串行循环钩子</td> <td>Webpack 中未使用</td></tr> <tr><td><code>AsyncSeriesWaterfallHook</code></td> <td>异步串行瀑布流钩子</td> <td>Webpack 共出现 5 次，如 <code>NormalModuleFactory.hooks.beforeResolve</code></td></tr></tbody></table> <p>类型虽多，但整体遵循两种分类规则：</p> <ul><li>按回调逻辑，分为：
<ul><li>基本类型，名称不带 <code>Waterfall/Bail/Loop</code> 关键字：与通常 <code>订阅/回调</code> 模式相似，按钩子注册顺序，逐次调用回调；</li> <li><code>waterfall</code> 类型：前一个回调的返回值会被带入下一个回调；</li> <li><code>bail</code> 类型：逐次调用回调，若有任何一个回调返回非 <code>undefined</code> 值，则终止后续调用；</li> <li><code>loop</code> 类型：逐次、循环调用，直到所有回调函数都返回 <code>undefined</code> 。</li></ul></li> <li>按执行回调的并行方式，分为：
<ul><li><code>sync</code> ：同步执行，启动后会按次序逐个执行回调，支持 <code>call/tap</code> 调用语句；</li> <li><code>async</code> ：异步执行，支持传入 callback 或 promise 风格的异步回调函数，支持 <code>callAsync/tapAsync</code> 、<code>promise/tapPromise</code> 两种调用语句。</li></ul></li></ul> <p>所有钩子都可以按名称套进这两条规则里面，对插件开发者来说不同类型的钩子会直接影响到回调函数的写法，以及插件与其他插件的互通关系，但是有一些基本能力、概念是通用的：<code>tap/call</code>、<code>intercept</code>、<code>context</code>、动态编译等。</p> <p>Tapable 合计提供了 10 种钩子，支持同步、异步、熔断、循环、waterfall 等功能特性，以此支撑起 Webpack 复杂的构建需求。虽然多数情况下我们不需要手动调用 Tapable，但编写插件时可以借助这些知识，识别 Hook 类型与执行特性后，正确地调用，正确地实现交互。</p> <h2 id="hook-动态编译"><a href="#hook-动态编译" class="header-anchor">#</a> Hook 动态编译</h2> <p>Webpack 中用到的 Hook 子类都已介绍完毕，不同 Hook 适用于不同场景，解决不同问题，而它们底层都基于 Tapable 的“动态编译”实现，可以说，理解了动态编译，也就掌握了 Tapable 的核心实现逻辑。</p> <p>动态编译是一个非常大胆的设计，不同 Hook 所谓的同步、异步、bail、waterfall、loop 等回调规则都是 Tapable 根据 Hook 类型、参数、回调队列等参数，调用 <code>new Function</code> 语句动态拼装出一段控制执行流程的 JavaScript 代码实现控制的。例如：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token punctuation">{</span> SyncHook <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;tapable&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> sleep <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SyncHook</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

sleep<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">&quot;test&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;callback A&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">sleep</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>调用 <code>sleep.call</code> 时，Tapable 内部处理流程大致为：</p> <p><img src="/blog/images/devops/plugin3.png" alt="plugin3"></p> <p>编译过程主要涉及三个实体：</p> <ul><li><code>tapable/lib/SyncHook.js</code> ：定义 <code>SyncHook</code> 的入口文件；</li> <li><code>tapable/lib/Hook.js</code> ：<code>SyncHook</code> 只是一个代理接口，内部实际上调用了 <code>Hook</code> 类，由 <code>Hook</code> 负责实现钩子的逻辑（其它钩子也是一样的套路）；</li> <li><code>tapable/lib/HookCodeFactory.js</code> ：动态编译出 <code>call</code>、<code>callAsync</code>、<code>promise</code> 函数内容的工厂类，注意，其他钩子也都会用到 <code>HookCodeFactory</code> 工厂函数。</li></ul> <p><code>SyncHook</code> （其他钩子类似)）调用 <code>call</code> 后，<code>Hook</code> 基类收集上下文信息并调用 <code>createCall</code> 及子类传入的 <code>compiler</code> 函数；<code>compiler</code> 调用 <code>HookCodeFactory</code> 进而使用 <code>new Function</code> 方法动态拼接出回调执行函数。上面例子对应的生成函数：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token function">anonymous</span><span class="token punctuation">(</span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token string">&quot;use strict&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> _context<span class="token punctuation">;</span>
<span class="token keyword">var</span> _x <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_x<span class="token punctuation">;</span>
<span class="token keyword">var</span> _fn0 <span class="token operator">=</span> _x<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token function">_fn0</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>那么问题来了，通过 <code>new Function</code>、<code>eval</code> 等方式实现的动态编译，存在诸如性能、安全性等方面的问题，所以社区很少见到类似的设计，真的有必要用这种方式实现 Hook 吗？</p> <p>这放在 <code>SyncHook</code> 这种简单场景确实大可不必，但若是更复杂的 Hook，如 <code>AsyncSeriesWaterfallHook</code>：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token punctuation">{</span> AsyncSeriesWaterfallHook <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;tapable&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> sleep <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AsyncSeriesWaterfallHook</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

sleep<span class="token punctuation">.</span><span class="token function">tapAsync</span><span class="token punctuation">(</span><span class="token string">&quot;test1&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span> cb</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">执行 A 回调： 参数 name=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">cb</span><span class="token punctuation">(</span><span class="token keyword">undefined</span><span class="token punctuation">,</span> <span class="token string">&quot;tecvan2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

sleep<span class="token punctuation">.</span><span class="token function">tapAsync</span><span class="token punctuation">(</span><span class="token string">&quot;test&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span> cb</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">执行 B 回调： 参数 name=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">cb</span><span class="token punctuation">(</span><span class="token keyword">undefined</span><span class="token punctuation">,</span> <span class="token string">&quot;tecvan3&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

sleep<span class="token punctuation">.</span><span class="token function">tapAsync</span><span class="token punctuation">(</span><span class="token string">&quot;test&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span> cb</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">执行 C 回调： 参数 name=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">cb</span><span class="token punctuation">(</span><span class="token keyword">undefined</span><span class="token punctuation">,</span> <span class="token string">&quot;tecvan4&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

sleep<span class="token punctuation">.</span><span class="token function">callAsync</span><span class="token punctuation">(</span><span class="token string">&quot;tecvan&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> name</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">回调结束， name=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 运行结果：</span>
<span class="token comment">// 执行 A 回调： 参数 name=tecvan</span>
<span class="token comment">// 执行 B 回调： 参数 name=tecvan2</span>
<span class="token comment">// 执行 C 回调： 参数 name=tecvan3</span>
<span class="token comment">// 回调结束， name=tecvan4</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br></div></div><p><code>AsyncSeriesWaterfallHook</code> 的特点是异步 + 串行 + 前一个回调的返回值会传入下一个回调，对应生成函数：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token function">anonymous</span><span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span> _callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token string">&quot;use strict&quot;</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> _context<span class="token punctuation">;</span>
  <span class="token keyword">var</span> _x <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_x<span class="token punctuation">;</span>
  <span class="token keyword">function</span> <span class="token function">_next1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> _fn2 <span class="token operator">=</span> _x<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token function">_fn2</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">_err2<span class="token punctuation">,</span> _result2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>_err2<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">_callback</span><span class="token punctuation">(</span>_err2<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>_result2 <span class="token operator">!==</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          name <span class="token operator">=</span> _result2<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">_callback</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">function</span> <span class="token function">_next0</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> _fn1 <span class="token operator">=</span> _x<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token function">_fn1</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">_err1<span class="token punctuation">,</span> _result1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>_err1<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">_callback</span><span class="token punctuation">(</span>_err1<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>_result1 <span class="token operator">!==</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          name <span class="token operator">=</span> _result1<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">_next1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">var</span> _fn0 <span class="token operator">=</span> _x<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token function">_fn0</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">_err0<span class="token punctuation">,</span> _result0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>_err0<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">_callback</span><span class="token punctuation">(</span>_err0<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>_result0 <span class="token operator">!==</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        name <span class="token operator">=</span> _result0<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token function">_next0</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br></div></div><p>核心逻辑：</p> <ul><li>生成函数将回调队列各个项封装为 <code>_next0/_next1</code> 函数，这些 <code>next</code> 函数内在逻辑高度相似；</li> <li>按回调定义的顺序，逐次执行，上一个回调结束后，才调用下一个回调，例如生成代码中的第39行、27行。</li></ul> <p>相比于用递归、循环之类的手段实现 <code>AsyncSeriesWaterfallHook</code>，这段动态生成的函数逻辑确实会更清晰，更容易理解，这种场景下用动态编译，确实是一个不错的选择。</p> <h3 id="高级特性-intercept"><a href="#高级特性-intercept" class="header-anchor">#</a> 高级特性 Intercept</h3> <p>除了通常的 <code>tap/call</code> 之外，tapable 还提供了简易的中间件机制 —— <code>intercept</code> 接口，例如</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> sleep <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SyncHook</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

sleep<span class="token punctuation">.</span><span class="token function">intercept</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">&quot;test&quot;</span><span class="token punctuation">,</span>
  <span class="token literal-property property">context</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;before call&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function">loop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;before loop&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function">tap</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;before each callback&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function">register</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;every time call tap&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p><code>intercept</code> 支持注册如下类型的中间件：</p> <table><thead><tr><th></th> <th>签名</th> <th>解释</th></tr></thead> <tbody><tr><td><code>call</code></td> <td><code>(...args) =&gt; void</code></td> <td>调用 <code>call/callAsync/promise</code> 时触发</td></tr> <tr><td><code>tap</code></td> <td><code>(tap: Tap) =&gt; void</code></td> <td>调用 <code>call</code> 类函数后，每次调用回调之前触发</td></tr> <tr><td><code>loop</code></td> <td><code>(...args) =&gt; void</code></td> <td>仅 <code>loop</code> 型的钩子有效，在循环开始之前触发</td></tr> <tr><td><code>register</code></td> <td><code>(tap: Tap) =&gt; Tap | undefined</code></td> <td>调用 <code>tap/tapAsync/tapPromise</code> 时触发</td></tr></tbody></table> <p>其中 <code>register</code> 在每次调用 <code>tap</code> 时被调用；其他三种中间件的触发时机大致如下：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>  <span class="token keyword">var</span> _context<span class="token punctuation">;</span>
  <span class="token keyword">const</span> callbacks <span class="token operator">=</span> <span class="token punctuation">[</span>fn1<span class="token punctuation">,</span> fn2<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> _interceptors <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>interceptors<span class="token punctuation">;</span>
  <span class="token comment">// 调用 call 函数，立即触发</span>
  _interceptors<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">intercept</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">intercept</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>_context<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> _loop<span class="token punctuation">;</span>
  <span class="token keyword">var</span> cursor <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword">do</span> <span class="token punctuation">{</span>
    _loop <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token comment">// 每次循环开始时触发 `loop`</span>
    _interceptors<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">intercept</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> intercept<span class="token punctuation">.</span><span class="token function">loop</span><span class="token punctuation">(</span>_context<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 触发 `tap`</span>
    <span class="token keyword">var</span> _fn0 <span class="token operator">=</span> callbacks<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    _interceptors<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">intercept</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> intercept<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span>_context<span class="token punctuation">,</span> _fn0<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> _result0 <span class="token operator">=</span> <span class="token function">_fn0</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>_result0 <span class="token operator">!==</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      _loop <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token keyword">var</span> _fn1 <span class="token operator">=</span> callbacks<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token comment">// 再次触发 `tap`</span>
      _interceptors<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">intercept</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> intercept<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span>_context<span class="token punctuation">,</span> _fn1<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">var</span> _result1 <span class="token operator">=</span> <span class="token function">_fn1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>_result1 <span class="token operator">!==</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        _loop <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>_loop<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br></div></div><p><code>intercept</code> 特性在 Webpack 内主要被用作进度提示，如 <code>Webpack/lib/ProgressPlugin.js</code> 插件中，分别对 <code>compiler.hooks.emit</code> 、<code>compiler.hooks.afterEmit</code> 钩子应用了记录进度的中间件函数。其他类型的插件应用较少。</p> <h3 id="高级特性-hookmap"><a href="#高级特性-hookmap" class="header-anchor">#</a> 高级特性 - HookMap</h3> <p>Tapable 还有一个值得注意的特性 —— <code>HookMap</code>，它提供了一种集合操作能力，能够降低创建与使用的复杂度，用法比较简单：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token punctuation">{</span> SyncHook<span class="token punctuation">,</span> HookMap <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;tapable&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> sleep <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HookMap</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">new</span> <span class="token class-name">SyncHook</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 通过 for 函数过滤集合中的特定钩子</span>
sleep<span class="token punctuation">.</span><span class="token function">for</span><span class="token punctuation">(</span><span class="token string">&quot;statement&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">&quot;test&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;callback for statement&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 触发 statement 类型的钩子</span>
sleep<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;statement&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p><code>HookMap</code> 能够用于实现的动态获取钩子功能，例如在 Webpack 的 <code>lib/parser.js</code> 文件中，<code>parser</code> 文件主要完成将资源内容解析为 AST 集合，之后遍历 AST 并以 <code>HookMap</code> 方式对外通知遍历到的内容。</p> <p>例如，遇到表达式的时候触发 <code>Parser.hooks.expression</code> 钩子，问题是 AST 结构和内容都很复杂，如果所有情景都以独立的钩子实现，那代码量会急剧膨胀。这种场景就很适合用 <code>HookMap</code> 解决，以 <code>expression</code> 为例：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">Parser</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>hooks <span class="token operator">=</span> <span class="token punctuation">{</span>
      <span class="token comment">// 定义钩子</span>
      <span class="token comment">// 这里用到 HookMap ，所以不需要提前遍历枚举所有 expression 场景</span>
      <span class="token literal-property property">expression</span><span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">HookMap</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">new</span> <span class="token class-name">SyncBailHook</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">&quot;expression&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">//   不同场景下触发钩子</span>
  <span class="token function">walkMemberExpression</span><span class="token punctuation">(</span><span class="token parameter">expression</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> exprName <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getNameForExpression</span><span class="token punctuation">(</span>expression<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>exprName <span class="token operator">&amp;&amp;</span> exprName<span class="token punctuation">.</span>free<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 触发特定类型的钩子</span>
      <span class="token keyword">const</span> expressionHook <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>expression<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>exprName<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>expressionHook <span class="token operator">!==</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token function">expressionHook</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>expression<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">===</span> <span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// ...</span>
  <span class="token punctuation">}</span>

  <span class="token function">walkThisExpression</span><span class="token punctuation">(</span><span class="token parameter">expression</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> expressionHook <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>expression<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;this&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>expressionHook <span class="token operator">!==</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">expressionHook</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>expression<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br></div></div><p>上例代码第 15、25 行都通过 <code>this.hooks.expression.get(xxx)</code> 语句动态获取对应钩子实例，之后再调用 <code>call</code> 触发。HookMap 的消费逻辑与普通 Hook 类似，只需要增加 <code>for</code> 函数过滤出你实际监听的 Hook 实例即可，如：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 钩子消费逻辑</span>
<span class="token comment">// 选取 CommonJsStuffPlugin 仅起示例作用</span>
<span class="token keyword">class</span> <span class="token class-name">CommonJsStuffPlugin</span> <span class="token punctuation">{</span>
  <span class="token function">apply</span><span class="token punctuation">(</span><span class="token parameter">compiler</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    compiler<span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>compilation<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span>
      <span class="token string">&quot;CommonJsStuffPlugin&quot;</span><span class="token punctuation">,</span>
      <span class="token punctuation">(</span><span class="token parameter">compilation<span class="token punctuation">,</span> <span class="token punctuation">{</span> normalModuleFactory <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> <span class="token function-variable function">handler</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">parser<span class="token punctuation">,</span> parserOptions</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token comment">// 通过 for 精确消费钩子</span>
          parser<span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>expression
            <span class="token punctuation">.</span><span class="token function">for</span><span class="token punctuation">(</span><span class="token string">&quot;require.main.require&quot;</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span>
              <span class="token string">&quot;CommonJsStuffPlugin&quot;</span><span class="token punctuation">,</span>
              ParserHelpers<span class="token punctuation">.</span><span class="token function">expressionIsUnsupported</span><span class="token punctuation">(</span>
                parser<span class="token punctuation">,</span>
                <span class="token string">&quot;require.main.require is not supported by Webpack.&quot;</span>
              <span class="token punctuation">)</span>
            <span class="token punctuation">)</span><span class="token punctuation">;</span>
          parser<span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>expression
            <span class="token punctuation">.</span><span class="token function">for</span><span class="token punctuation">(</span><span class="token string">&quot;module.parent.require&quot;</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span>
              <span class="token string">&quot;CommonJsStuffPlugin&quot;</span><span class="token punctuation">,</span>
              ParserHelpers<span class="token punctuation">.</span><span class="token function">expressionIsUnsupported</span><span class="token punctuation">(</span>
                parser<span class="token punctuation">,</span>
                <span class="token string">&quot;module.parent.require is not supported by Webpack.&quot;</span>
              <span class="token punctuation">)</span>
            <span class="token punctuation">)</span><span class="token punctuation">;</span>
          parser<span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>expression
            <span class="token punctuation">.</span><span class="token function">for</span><span class="token punctuation">(</span><span class="token string">&quot;require.main&quot;</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span>
              <span class="token string">&quot;CommonJsStuffPlugin&quot;</span><span class="token punctuation">,</span>
              ParserHelpers<span class="token punctuation">.</span><span class="token function">toConstantDependencyWithWebpackRequire</span><span class="token punctuation">(</span>
                parser<span class="token punctuation">,</span>
                <span class="token string">&quot;__Webpack_require__.c[__Webpack_require__.s]&quot;</span>
              <span class="token punctuation">)</span>
            <span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token comment">// ...</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br></div></div><p>借助这种能力我们就不需要为每一种情况都单独创建 Hook，只需要在使用时动态创建、获取对应实例即可，能有效降低开发与维护成本。</p> <h2 id="小结"><a href="#小结" class="header-anchor">#</a> 小结</h2> <p>Webpack 的插件体系与平常所见的 <code>订阅/发布</code> 模式差别很大，是一种非常强耦合的设计，Hook 回调由 Webpack 决定何时，以何种方式执行；而在 Hook 回调内部可以通过调用上下文 API 、修改上下文状态等方式，对 Webpack 原定流程产生 Side Effect。</p> <p>由此可见，编写插件时大部分工作都围绕 Hook 展开，因此我们需要理解构建过程中的不同环节会触发什么 Hook、对应传递什么上下文参数、如何与上下文参数对象交互等，而学习这些知识最高效的方式，我认为是阅读、分析各种开源插件源码。例如文章中提及的：</p> <ul><li>从 <code>imagemin-webpack-plugin</code> 学习：如何借助 <code>assets</code> 数组修改最终产物内容；</li> <li>从 <code>eslint-webpack-plugin</code> 学习：如何提交错误信息；</li> <li>从 <code>DefinePlugin</code> 学习：如何与 AST 结构交互。</li></ul> <p>为了应对构建场景下各种复杂需求，Webpack 内部使用了多种类型的 Hook，分别用于实现同步、异步、熔断、串行、并行的流程逻辑，开发插件时需要注意识别 Hook 类型，据此做出正确的调用与交互逻辑。</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/blog/devops/webpack/loader.html" class="prev">
        Webpack Loader
      </a></span> <span class="next"><a href="/blog/devops/webpack/module-federation.html">
        模块联邦
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----><!----><!----><!----></div></div>
    <script src="/blog/assets/js/app.59e6d68a.js" defer></script><script src="/blog/assets/js/2.dec2e75d.js" defer></script><script src="/blog/assets/js/1.5b9e135c.js" defer></script><script src="/blog/assets/js/127.070347f6.js" defer></script><script src="/blog/assets/js/20.badbb211.js" defer></script>
  </body>
</html>
