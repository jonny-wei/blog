<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Webpack Loader | 花帽子的博客</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="icon" href="/blog/logo.png">
    <link rel="manifest" href="/blog/manifest.json">
    <link rel="apple-touch-icon" href="/blog/images/icons/apple-icon-152x152.png">
    <meta name="description" content="我命由我不由天，学习吧少年">
    <meta name="theme-color" content="#3eaf7c">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="msapplication-TileImage" content="/icons/ms-icon-144x144.png">
    <meta name="msapplication-TileColor" content="#000000">
    
    <link rel="preload" href="/blog/assets/css/0.styles.1c8ccece.css" as="style"><link rel="preload" href="/blog/assets/js/app.b3209530.js" as="script"><link rel="preload" href="/blog/assets/js/2.8bf77cff.js" as="script"><link rel="preload" href="/blog/assets/js/47.7ca653b7.js" as="script"><link rel="preload" href="/blog/assets/js/4.ff6074e9.js" as="script"><link rel="prefetch" href="/blog/assets/js/10.59bd7815.js"><link rel="prefetch" href="/blog/assets/js/100.858b44e3.js"><link rel="prefetch" href="/blog/assets/js/101.4b99c6f8.js"><link rel="prefetch" href="/blog/assets/js/102.f9d8aa03.js"><link rel="prefetch" href="/blog/assets/js/103.e2f065c1.js"><link rel="prefetch" href="/blog/assets/js/104.be1b57f6.js"><link rel="prefetch" href="/blog/assets/js/105.de6e3141.js"><link rel="prefetch" href="/blog/assets/js/106.e177ad64.js"><link rel="prefetch" href="/blog/assets/js/107.522ee48f.js"><link rel="prefetch" href="/blog/assets/js/108.2c07eae1.js"><link rel="prefetch" href="/blog/assets/js/109.1026bd2f.js"><link rel="prefetch" href="/blog/assets/js/11.cbbf834d.js"><link rel="prefetch" href="/blog/assets/js/110.3474ddbe.js"><link rel="prefetch" href="/blog/assets/js/111.8a6d1533.js"><link rel="prefetch" href="/blog/assets/js/112.345ee884.js"><link rel="prefetch" href="/blog/assets/js/113.42a44a95.js"><link rel="prefetch" href="/blog/assets/js/114.109d57f9.js"><link rel="prefetch" href="/blog/assets/js/115.d345e8e8.js"><link rel="prefetch" href="/blog/assets/js/116.56372cc1.js"><link rel="prefetch" href="/blog/assets/js/117.b991c624.js"><link rel="prefetch" href="/blog/assets/js/118.0cfc10e8.js"><link rel="prefetch" href="/blog/assets/js/119.f41389ff.js"><link rel="prefetch" href="/blog/assets/js/12.f09b152a.js"><link rel="prefetch" href="/blog/assets/js/120.c5d2ac90.js"><link rel="prefetch" href="/blog/assets/js/121.140f91a1.js"><link rel="prefetch" href="/blog/assets/js/122.5dc82921.js"><link rel="prefetch" href="/blog/assets/js/123.181b897d.js"><link rel="prefetch" href="/blog/assets/js/124.fbea5e13.js"><link rel="prefetch" href="/blog/assets/js/125.76905808.js"><link rel="prefetch" href="/blog/assets/js/126.bb28c67f.js"><link rel="prefetch" href="/blog/assets/js/127.58fa443d.js"><link rel="prefetch" href="/blog/assets/js/128.dc852f53.js"><link rel="prefetch" href="/blog/assets/js/129.7b8d33ae.js"><link rel="prefetch" href="/blog/assets/js/13.f1214399.js"><link rel="prefetch" href="/blog/assets/js/130.645c45d5.js"><link rel="prefetch" href="/blog/assets/js/131.4102269c.js"><link rel="prefetch" href="/blog/assets/js/132.94e89735.js"><link rel="prefetch" href="/blog/assets/js/133.b1e0aaeb.js"><link rel="prefetch" href="/blog/assets/js/134.2d878fe6.js"><link rel="prefetch" href="/blog/assets/js/135.547140ec.js"><link rel="prefetch" href="/blog/assets/js/136.8cd08a0c.js"><link rel="prefetch" href="/blog/assets/js/137.864b24ef.js"><link rel="prefetch" href="/blog/assets/js/138.5c88ccec.js"><link rel="prefetch" href="/blog/assets/js/139.31c79a50.js"><link rel="prefetch" href="/blog/assets/js/14.d085f628.js"><link rel="prefetch" href="/blog/assets/js/140.b9ec5d6a.js"><link rel="prefetch" href="/blog/assets/js/141.9aa49d8e.js"><link rel="prefetch" href="/blog/assets/js/142.b7532cf7.js"><link rel="prefetch" href="/blog/assets/js/143.ac9fcc86.js"><link rel="prefetch" href="/blog/assets/js/144.566a7621.js"><link rel="prefetch" href="/blog/assets/js/145.5ded4805.js"><link rel="prefetch" href="/blog/assets/js/146.addd9e67.js"><link rel="prefetch" href="/blog/assets/js/147.e60b30d5.js"><link rel="prefetch" href="/blog/assets/js/148.3214b821.js"><link rel="prefetch" href="/blog/assets/js/149.323bdbc9.js"><link rel="prefetch" href="/blog/assets/js/15.5b042421.js"><link rel="prefetch" href="/blog/assets/js/150.0133d123.js"><link rel="prefetch" href="/blog/assets/js/151.87634cad.js"><link rel="prefetch" href="/blog/assets/js/152.b0197ea0.js"><link rel="prefetch" href="/blog/assets/js/153.e119408f.js"><link rel="prefetch" href="/blog/assets/js/154.df0f5c6a.js"><link rel="prefetch" href="/blog/assets/js/155.27382c94.js"><link rel="prefetch" href="/blog/assets/js/156.efeb2e06.js"><link rel="prefetch" href="/blog/assets/js/157.6b314ec4.js"><link rel="prefetch" href="/blog/assets/js/158.d74b0b58.js"><link rel="prefetch" href="/blog/assets/js/159.fb1a2ffb.js"><link rel="prefetch" href="/blog/assets/js/16.d0cca31c.js"><link rel="prefetch" href="/blog/assets/js/160.9c4aa3de.js"><link rel="prefetch" href="/blog/assets/js/161.528d482f.js"><link rel="prefetch" href="/blog/assets/js/162.e524056a.js"><link rel="prefetch" href="/blog/assets/js/163.6cde151b.js"><link rel="prefetch" href="/blog/assets/js/164.065addff.js"><link rel="prefetch" href="/blog/assets/js/165.757e480b.js"><link rel="prefetch" href="/blog/assets/js/166.339496a6.js"><link rel="prefetch" href="/blog/assets/js/17.7d627321.js"><link rel="prefetch" href="/blog/assets/js/18.cf67db1a.js"><link rel="prefetch" href="/blog/assets/js/19.aaf720d3.js"><link rel="prefetch" href="/blog/assets/js/20.2a683d98.js"><link rel="prefetch" href="/blog/assets/js/21.7d63b327.js"><link rel="prefetch" href="/blog/assets/js/22.c64711a7.js"><link rel="prefetch" href="/blog/assets/js/23.b23738eb.js"><link rel="prefetch" href="/blog/assets/js/24.50023b4e.js"><link rel="prefetch" href="/blog/assets/js/25.e5d71466.js"><link rel="prefetch" href="/blog/assets/js/26.b262f9d3.js"><link rel="prefetch" href="/blog/assets/js/27.df70c5e4.js"><link rel="prefetch" href="/blog/assets/js/28.59714010.js"><link rel="prefetch" href="/blog/assets/js/29.63a13b59.js"><link rel="prefetch" href="/blog/assets/js/3.6c93b5c9.js"><link rel="prefetch" href="/blog/assets/js/30.b2202a30.js"><link rel="prefetch" href="/blog/assets/js/31.95707786.js"><link rel="prefetch" href="/blog/assets/js/32.a217e37c.js"><link rel="prefetch" href="/blog/assets/js/33.a41a393b.js"><link rel="prefetch" href="/blog/assets/js/34.5f125b33.js"><link rel="prefetch" href="/blog/assets/js/35.d91d092d.js"><link rel="prefetch" href="/blog/assets/js/36.cd6b2a6d.js"><link rel="prefetch" href="/blog/assets/js/37.b96aeb1c.js"><link rel="prefetch" href="/blog/assets/js/38.c58f044b.js"><link rel="prefetch" href="/blog/assets/js/39.614d5d15.js"><link rel="prefetch" href="/blog/assets/js/40.5e5f0850.js"><link rel="prefetch" href="/blog/assets/js/41.19130b01.js"><link rel="prefetch" href="/blog/assets/js/42.b9520ca2.js"><link rel="prefetch" href="/blog/assets/js/43.dd91c09f.js"><link rel="prefetch" href="/blog/assets/js/44.c64d18ba.js"><link rel="prefetch" href="/blog/assets/js/45.664d1516.js"><link rel="prefetch" href="/blog/assets/js/46.907b5d06.js"><link rel="prefetch" href="/blog/assets/js/48.6de388b2.js"><link rel="prefetch" href="/blog/assets/js/49.21ca9c2f.js"><link rel="prefetch" href="/blog/assets/js/5.2328d578.js"><link rel="prefetch" href="/blog/assets/js/50.3b64cda4.js"><link rel="prefetch" href="/blog/assets/js/51.1dacae85.js"><link rel="prefetch" href="/blog/assets/js/52.8f2954df.js"><link rel="prefetch" href="/blog/assets/js/53.a5abc8a9.js"><link rel="prefetch" href="/blog/assets/js/54.c496f635.js"><link rel="prefetch" href="/blog/assets/js/55.757c6215.js"><link rel="prefetch" href="/blog/assets/js/56.43a8d14c.js"><link rel="prefetch" href="/blog/assets/js/57.562dd3c3.js"><link rel="prefetch" href="/blog/assets/js/58.70248302.js"><link rel="prefetch" href="/blog/assets/js/59.bc34be66.js"><link rel="prefetch" href="/blog/assets/js/6.539ab69c.js"><link rel="prefetch" href="/blog/assets/js/60.0b62463e.js"><link rel="prefetch" href="/blog/assets/js/61.1358ca4f.js"><link rel="prefetch" href="/blog/assets/js/62.5b29d313.js"><link rel="prefetch" href="/blog/assets/js/63.fe6cc3c9.js"><link rel="prefetch" href="/blog/assets/js/64.5ac3a895.js"><link rel="prefetch" href="/blog/assets/js/65.437a2860.js"><link rel="prefetch" href="/blog/assets/js/66.20bf2a93.js"><link rel="prefetch" href="/blog/assets/js/67.68461294.js"><link rel="prefetch" href="/blog/assets/js/68.3dddf877.js"><link rel="prefetch" href="/blog/assets/js/69.516021b5.js"><link rel="prefetch" href="/blog/assets/js/7.c55f6e83.js"><link rel="prefetch" href="/blog/assets/js/70.a0523390.js"><link rel="prefetch" href="/blog/assets/js/71.8b6cd8c5.js"><link rel="prefetch" href="/blog/assets/js/72.69d25064.js"><link rel="prefetch" href="/blog/assets/js/73.2598099d.js"><link rel="prefetch" href="/blog/assets/js/74.c3b702b6.js"><link rel="prefetch" href="/blog/assets/js/75.cc0e9553.js"><link rel="prefetch" href="/blog/assets/js/76.a218436f.js"><link rel="prefetch" href="/blog/assets/js/77.1a9b67f2.js"><link rel="prefetch" href="/blog/assets/js/78.823b26bf.js"><link rel="prefetch" href="/blog/assets/js/79.15f0377a.js"><link rel="prefetch" href="/blog/assets/js/8.60aa9c8a.js"><link rel="prefetch" href="/blog/assets/js/80.8cebe95c.js"><link rel="prefetch" href="/blog/assets/js/81.785a38ab.js"><link rel="prefetch" href="/blog/assets/js/82.e4b6977a.js"><link rel="prefetch" href="/blog/assets/js/83.a2ae2280.js"><link rel="prefetch" href="/blog/assets/js/84.6cfbf6ea.js"><link rel="prefetch" href="/blog/assets/js/85.b199eee3.js"><link rel="prefetch" href="/blog/assets/js/86.fc0402d0.js"><link rel="prefetch" href="/blog/assets/js/87.1f039e64.js"><link rel="prefetch" href="/blog/assets/js/88.e08e74ea.js"><link rel="prefetch" href="/blog/assets/js/89.26656b6b.js"><link rel="prefetch" href="/blog/assets/js/9.1dc34dd8.js"><link rel="prefetch" href="/blog/assets/js/90.c88f580e.js"><link rel="prefetch" href="/blog/assets/js/91.68f8b3e7.js"><link rel="prefetch" href="/blog/assets/js/92.35735724.js"><link rel="prefetch" href="/blog/assets/js/93.ced12c21.js"><link rel="prefetch" href="/blog/assets/js/94.214330bd.js"><link rel="prefetch" href="/blog/assets/js/95.82bf7e0d.js"><link rel="prefetch" href="/blog/assets/js/96.a9eefec5.js"><link rel="prefetch" href="/blog/assets/js/97.24abbf05.js"><link rel="prefetch" href="/blog/assets/js/98.18e30f0b.js"><link rel="prefetch" href="/blog/assets/js/99.b7954e4e.js">
    <link rel="stylesheet" href="/blog/assets/css/0.styles.1c8ccece.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/blog/" class="home-link router-link-active"><img src="/blog/logo.png" alt="花帽子的博客" class="logo"> <span class="site-name can-hide">花帽子的博客</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/blog/" class="nav-link">
  主页
</a></div><div class="nav-item"><a href="/blog/vue/" class="nav-link">
  Vue
</a></div><div class="nav-item"><a href="/blog/react/" class="nav-link">
  React
</a></div><div class="nav-item"><a href="/blog/css/" class="nav-link">
  CSS
</a></div><div class="nav-item"><a href="/blog/javascript/" class="nav-link">
  JS&amp;TS
</a></div><div class="nav-item"><a href="/blog/node/" class="nav-link">
  Node
</a></div><div class="nav-item"><a href="/blog/devops/" class="nav-link router-link-active">
  前端工程化
</a></div><div class="nav-item"><a href="/blog/mobile/" class="nav-link">
  泛客户端
</a></div><div class="nav-item"><a href="/blog/framework/" class="nav-link">
  架构&amp;方案
</a></div><div class="nav-item"><a href="/blog/code/" class="nav-link">
  算法&amp;编程
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="GitHub" class="dropdown-title"><span class="title">GitHub</span> <span class="arrow down"></span></button> <button type="button" aria-label="GitHub" class="mobile-dropdown-title"><span class="title">GitHub</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/jonny-wei" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub地址
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/blog/" class="nav-link">
  主页
</a></div><div class="nav-item"><a href="/blog/vue/" class="nav-link">
  Vue
</a></div><div class="nav-item"><a href="/blog/react/" class="nav-link">
  React
</a></div><div class="nav-item"><a href="/blog/css/" class="nav-link">
  CSS
</a></div><div class="nav-item"><a href="/blog/javascript/" class="nav-link">
  JS&amp;TS
</a></div><div class="nav-item"><a href="/blog/node/" class="nav-link">
  Node
</a></div><div class="nav-item"><a href="/blog/devops/" class="nav-link router-link-active">
  前端工程化
</a></div><div class="nav-item"><a href="/blog/mobile/" class="nav-link">
  泛客户端
</a></div><div class="nav-item"><a href="/blog/framework/" class="nav-link">
  架构&amp;方案
</a></div><div class="nav-item"><a href="/blog/code/" class="nav-link">
  算法&amp;编程
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="GitHub" class="dropdown-title"><span class="title">GitHub</span> <span class="arrow down"></span></button> <button type="button" aria-label="GitHub" class="mobile-dropdown-title"><span class="title">GitHub</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/jonny-wei" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub地址
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Webpack</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/devops/" aria-current="page" class="sidebar-link">Webpack 常用配置</a></li><li><a href="/blog/devops/webpack/building.html" class="sidebar-link">构建流程与原理</a></li><li><a href="/blog/devops/webpack/dependency-graph.html" class="sidebar-link">模块依赖关系</a></li><li><a href="/blog/devops/webpack/chunk.html" class="sidebar-link">产物打包逻辑</a></li><li><a href="/blog/devops/webpack/compile.html" class="sidebar-link">模块编译及运行时</a></li><li><a href="/blog/devops/webpack/hmr.html" class="sidebar-link">HMR 热更新</a></li><li><a href="/blog/devops/webpack/loader.html" aria-current="page" class="active sidebar-link">Webpack Loader</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/devops/webpack/loader.html#loader-理解" class="sidebar-link">Loader 理解</a></li><li class="sidebar-sub-header"><a href="/blog/devops/webpack/loader.html#loader-开发" class="sidebar-link">Loader 开发</a></li><li class="sidebar-sub-header"><a href="/blog/devops/webpack/loader.html#loader-链式调用模型" class="sidebar-link">Loader 链式调用模型</a></li><li class="sidebar-sub-header"><a href="/blog/devops/webpack/loader.html#loader-辅助工具" class="sidebar-link">Loader 辅助工具</a></li><li class="sidebar-sub-header"><a href="/blog/devops/webpack/loader.html#vue-loader-原理" class="sidebar-link">vue-loader 原理</a></li><li class="sidebar-sub-header"><a href="/blog/devops/webpack/loader.html#小结" class="sidebar-link">小结</a></li></ul></li><li><a href="/blog/devops/webpack/plugin.html" class="sidebar-link">Webpack Plugin</a></li><li><a href="/blog/devops/webpack/module-federation.html" class="sidebar-link">模块联邦</a></li><li><a href="/blog/devops/webpack/cache.html" class="sidebar-link">持久化缓存</a></li><li><a href="/blog/devops/webpack/parallel.html" class="sidebar-link">并行构建</a></li><li><a href="/blog/devops/webpack/split-chunks.html" class="sidebar-link">分包策略</a></li><li><a href="/blog/devops/webpack/compress.html" class="sidebar-link">代码压缩</a></li><li><a href="/blog/devops/webpack/tree-shaking.html" class="sidebar-link">Tree Shaking</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Vite</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/devops/vite/esm.html" class="sidebar-link">模块化规范</a></li><li><a href="/blog/devops/vite/css.html" class="sidebar-link">CSS 工程化</a></li><li><a href="/blog/devops/vite/prebuild.html" class="sidebar-link">依赖预构建</a></li><li><a href="/blog/devops/vite/engines.html" class="sidebar-link">双引擎架构</a></li><li><a href="/blog/devops/vite/rollup.html" class="sidebar-link">Rollup 打包</a></li><li><a href="/blog/devops/vite/building.html" class="sidebar-link">Vite 构建原理</a></li><li><a href="/blog/devops/vite/plugin.html" class="sidebar-link">Vite Plugin</a></li><li><a href="/blog/devops/vite/hmr.html" class="sidebar-link">Vite HMR 热更新</a></li><li><a href="/blog/devops/vite/ssr.html" class="sidebar-link">SSR 工程化</a></li><li><a href="/blog/devops/vite/legacy.html" class="sidebar-link">兼容性问题</a></li><li><a href="/blog/devops/vite/split-code.html" class="sidebar-link">代码分割</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>性能优化</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/devops/performance/network.html" class="sidebar-link">网络层面优化</a></li><li><a href="/blog/devops/performance/webpack.html" class="sidebar-link">构建层面优化</a></li><li><a href="/blog/devops/performance/render.html" class="sidebar-link">渲染层面优化</a></li><li><a href="/blog/devops/performance/code.html" class="sidebar-link">代码层面优化</a></li><li><a href="/blog/devops/performance/analysis.html" class="sidebar-link">性能分析</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="webpack-loader"><a href="#webpack-loader" class="header-anchor">#</a> Webpack Loader</h1> <p>如何扩展 Webpack？有两种主流方式:</p> <ul><li>Loader —— 主要负责将资源内容翻译成 Webpack 能够理解、处理的 JavaScript 代码</li> <li>Plugin —— 深度介入 Webpack 构建过程，重塑 构建逻辑</li></ul> <h2 id="loader-理解"><a href="#loader-理解" class="header-anchor">#</a> Loader 理解</h2> <p>Loader 通常是一种 mapping 函数形式，接收原始代码内容，返回翻译结果。在 Webpack 进入构建阶段后，首先会通过 IO 接口读取文件内容，之后调用 <a href="https://link.juejin.cn/?target=https%3A%2F%2Fgithub.com%2Fwebpack%2Floader-runner" target="_blank" rel="noopener noreferrer">LoaderRunner<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 并将文件内容以 <code>source</code> 参数形式传递到 Loader 数组，<code>source</code> 数据在 Loader 数组内可能会经过若干次形态转换，最终以标准 JavaScript 代码提交给 Webpack 主流程，以此实现内容翻译功能。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">source<span class="token punctuation">,</span> sourceMap<span class="token operator">?</span><span class="token punctuation">,</span> data<span class="token operator">?</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> source<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>Loader 接收三个参数，分别为：</p> <ul><li><code>source</code>：资源输入，对于第一个执行的 Loader 为资源文件的内容；后续执行的 Loader 则为前一个 Loader 的执行结果，可能是字符串，也可能是代码的 AST 结构；</li> <li><code>sourceMap</code>: 可选参数，代码的 <a href="https://link.juejin.cn/?target=https%3A%2F%2Fsourcemap.com%2F" target="_blank" rel="noopener noreferrer">sourcemap<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 结构；</li> <li><code>data</code>: 可选参数，其它需要在 Loader 链中传递的信息，比如 <a href="https://link.juejin.cn/?target=https%3A%2F%2Fgithub.com%2Fposthtml%2Fposthtml-loader" target="_blank" rel="noopener noreferrer">posthtml/posthtml-loader<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 就会通过这个参数传递额外的 AST 对象。</li></ul> <p>经过模块化包装之后，这段文本内容变成 Webpack 可以理解的 JavaScript，其它 Module 也就能引用、使用它了。</p> <p>需要注意，Loader 中执行的各种资源内容转译操作通常都是 CPU 密集型 —— 这放在 JavaScript 单线程架构下可能导致性能问题；又或者异步 Loader 会挂起后续的加载器队列直到异步 Loader 触发回调，稍微不注意就可能导致整个加载器链条的执行时间过长。</p> <p>为此，Webpack 默认会缓存 Loader 的执行结果直到资源或资源依赖发生变化，开发者需要对此有个基本的理解，必要时可以通过 <code>this.cachable</code> 显式声明不作缓存：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">source</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">cacheable</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// ...</span>
  <span class="token keyword">return</span> output<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h2 id="loader-开发"><a href="#loader-开发" class="header-anchor">#</a> Loader 开发</h2> <h3 id="使用上下文接口"><a href="#使用上下文接口" class="header-anchor">#</a> 使用上下文接口</h3> <p>除了作为内容转换器外，Loader 运行过程还可以通过一些<a href="https://link.juejin.cn/?target=https%3A%2F%2Fwebpack.js.org%2Fapi%2Floaders%2F%23thisaddcontextdependency" target="_blank" rel="noopener noreferrer">上下文接口<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>，<strong>有限制</strong>地影响 Webpack 编译过程，从而产生内容转换之外的副作用。上下文接口将在运行 Loader 时以 <code>this</code> 方式注入到 Loader 函数：</p> <p><img src="/blog/images/devops/loader1.png" alt="loader1"></p> <p>Webpack 官网对 <a href="https://link.juejin.cn/?target=https%3A%2F%2Fwebpack.js.org%2Fapi%2Floaders%2F%23the-loader-context" target="_blank" rel="noopener noreferrer">Loader Context<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 已经有比较详细的说明，下面介绍几种常用接口</p> <ul><li><code>fs</code>：Compilation 对象的 <code>inputFileSystem</code> 属性，我们可以通过这个对象获取更多资源文件的内容；</li> <li><code>resource</code>：当前文件路径；</li> <li><code>resourceQuery</code>：文件请求参数，例如 <code>import &quot;./a?foo=bar&quot;</code> 的 <code>resourceQuery</code> 值为 <code>?foo=bar</code>；</li> <li><code>callback</code>：可用于返回多个结果；</li> <li><code>getOptions</code>：用于获取当前 Loader 的配置对象；</li> <li><code>async</code>：用于声明这是一个异步 Loader，开发者需要通过 <code>async</code> 接口返回的 <code>callback</code> 函数传递处理结果；</li> <li><code>emitWarning</code>：添加警告；</li> <li><code>emitError</code>：添加错误信息，注意这不会中断 Webpack 运行；</li> <li><code>emitFile</code>：用于直接写出一个产物文件，例如 <code>file-loader</code> 依赖该接口写出 Chunk 之外的产物；</li> <li><code>addDependency</code>：将 <code>dep</code> 文件添加为编译依赖，当 <code>dep</code> 文件内容发生变化时，会触发当前文件的重新构建；</li></ul> <h3 id="取消-loader-缓存"><a href="#取消-loader-缓存" class="header-anchor">#</a> 取消 Loader 缓存</h3> <p>Loader 中执行的各种资源内容转译操作通常都是 CPU 密集型 —— 这放在 JavaScript 单线程架构下可能导致性能问题；又或者异步 Loader 会挂起后续的加载器队列直到异步 Loader 触发回调，稍微不注意就可能导致整个加载器链条的执行时间过长。</p> <p>为此，Webpack 默认会缓存 Loader 的执行结果直到模块或模块所依赖的其它资源发生变化，我们也可以通过 <code>this.cacheable</code> 接口显式关闭缓存</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">source</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">cacheable</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// ...</span>
  <span class="token keyword">return</span> output<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h3 id="在-loader-中返回多个结果"><a href="#在-loader-中返回多个结果" class="header-anchor">#</a> 在 Loader 中返回多个结果</h3> <p>简单的 Loader 可直接 <code>return</code> 语句返回处理结果，复杂场景还可以通过 <code>callback</code> 接口返回更多信息，供下游 Loader 或者 Webpack 本身使用</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">loader</span><span class="token punctuation">(</span><span class="token parameter">content<span class="token punctuation">,</span> map</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
  linter<span class="token punctuation">.</span><span class="token function">printOutput</span><span class="token punctuation">(</span>linter<span class="token punctuation">.</span><span class="token function">lint</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">callback</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> content<span class="token punctuation">,</span> map<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>通过 <code>this.callback(null, content, map)</code> 语句，同时返回转译后的内容与 sourcemap 内容。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">callback</span><span class="token punctuation">(</span>
    <span class="token comment">// 异常信息，Loader 正常运行时传递 null 值即可</span>
    err<span class="token operator">:</span> Error <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    <span class="token comment">// 转译结果</span>
    content<span class="token operator">:</span> string <span class="token operator">|</span> Buffer<span class="token punctuation">,</span>
    <span class="token comment">// 源码的 sourcemap 信息</span>
    sourceMap<span class="token operator">?</span><span class="token operator">:</span> SourceMap<span class="token punctuation">,</span>
    <span class="token comment">// 任意需要在 Loader 间传递的值</span>
    <span class="token comment">// 经常用来传递 ast 对象，避免重复解析</span>
    data<span class="token operator">?</span><span class="token operator">:</span> any
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h3 id="在-loader-返回异步结果"><a href="#在-loader-返回异步结果" class="header-anchor">#</a> 在 Loader 返回异步结果</h3> <p>涉及到异步或 CPU 密集操作时，Loader 中还可以以异步形式返回处理结果，例如 <a href="https://link.juejin.cn/?target=https%3A%2F%2Fgithub.com%2Fwebpack-contrib%2Fless-loader" target="_blank" rel="noopener noreferrer">webpack-contrib/less-loader<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 的核心逻辑：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">import</span> less <span class="token keyword">from</span> <span class="token string">&quot;less&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">lessLoader</span><span class="token punctuation">(</span><span class="token parameter">source</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 1. 获取异步回调函数</span>
  <span class="token keyword">const</span> callback <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">async</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// ...</span>

  <span class="token keyword">let</span> result<span class="token punctuation">;</span>

  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token comment">// 2. 调用less 将模块内容转译为 css</span>
    result <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>implementation <span class="token operator">||</span> less<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> lessOptions<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">const</span> <span class="token punctuation">{</span> css<span class="token punctuation">,</span> imports <span class="token punctuation">}</span> <span class="token operator">=</span> result<span class="token punctuation">;</span>

  <span class="token comment">// ...</span>

  <span class="token comment">// 3. 转译结束，返回结果</span>
  <span class="token function">callback</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> css<span class="token punctuation">,</span> map<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> lessLoader<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><p>在 less-loader 中，包含三个重要逻辑：</p> <ul><li>调用 <code>this.async</code> 获取异步回调函数，此时 Webpack 会将该 Loader 标记为异步加载器，会挂起当前执行队列直到 <code>callback</code> 被触发；</li> <li>调用 <code>less</code> 库将 less 资源转译为标准 css；</li> <li>调用异步回调 <code>callback</code> 返回处理结果。</li></ul> <h3 id="在-loader-中直接写出文件"><a href="#在-loader-中直接写出文件" class="header-anchor">#</a> 在 Loader 中直接写出文件</h3> <p>Loader Context 的 <code>emitFile</code> 接口可用于直接写出新的产物文件，例如在 <code>file-loader</code> 中：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">loader</span><span class="token punctuation">(</span><span class="token parameter">content</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> options <span class="token operator">=</span> <span class="token function">getOptions</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">validate</span><span class="token punctuation">(</span>schema<span class="token punctuation">,</span> options<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    name<span class="token operator">:</span> <span class="token string">'File Loader'</span><span class="token punctuation">,</span>
    baseDataPath<span class="token operator">:</span> <span class="token string">'options'</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// ...</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> options<span class="token punctuation">.</span>emitFile <span class="token operator">===</span> <span class="token string">'undefined'</span> <span class="token operator">||</span> options<span class="token punctuation">.</span>emitFile<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">emitFile</span><span class="token punctuation">(</span>outputPath<span class="token punctuation">,</span> content<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> assetInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">const</span> esModule <span class="token operator">=</span>
    <span class="token keyword">typeof</span> options<span class="token punctuation">.</span>esModule <span class="token operator">!==</span> <span class="token string">'undefined'</span> <span class="token operator">?</span> options<span class="token punctuation">.</span>esModule <span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>esModule <span class="token operator">?</span> <span class="token string">'export default'</span> <span class="token operator">:</span> <span class="token string">'module.exports ='</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>publicPath<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">;</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> raw <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><p>借助 <code>emitFile</code> 接口，我们能够在 Webpack 构建主流程之外提交更多产物，这有时候是必要的，除上面提到的 <code>file-loader</code> 外，<code>response-loader</code> 、<code>mermaid-loader</code> 等也依赖于 <code>emitFile</code> 实现构建功能。</p> <h3 id="在-loader-中添加额外依赖"><a href="#在-loader-中添加额外依赖" class="header-anchor">#</a> 在 Loader 中添加额外依赖</h3> <p>Loader Context 的 <code>addDependency</code> 接口用于添加额外的文件依赖，当这些依赖发生变化时，也会触发重新构建，例如在 <code>less-loader</code> 中包含这样一段代码：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    result <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>implementation <span class="token operator">||</span> less<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> lessOptions<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">const</span> <span class="token punctuation">{</span> css<span class="token punctuation">,</span> imports <span class="token punctuation">}</span> <span class="token operator">=</span> result<span class="token punctuation">;</span>

  imports<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">addDependency</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">normalize</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>代码中首先调用 <code>less</code> 库编译文件内容，之后遍历所有 <code>@import</code> 语句(<code>result.imports</code> 数组)，调用 <code>this.addDependency</code> 函数将 import 到的文件都注册为依赖，此后这些资源文件发生变化时都会触发重新编译。</p> <p>为什么 <code>less-loader</code> 需要这么处理？因为 <code>less</code> 工具本身已经会递归所有 Less 文件树，一次性将所有 <code>.less</code> 文件打包在一起，例如在 <code>a.less</code> 中 <code>@import (less) './b.less'</code> ，a、b 文件会被 <code>less</code> 打包在一起。这里面的文件依赖对 Webpack 来说是无感知的，如果不用 <code>addDependency</code> 显式声明依赖，后续 <code>b.less</code> 文件的变化不会触发 <code>a.less</code> 重新构建，不符合预期啊。</p> <p>所以，<code>addDependency</code> 接口适用于那些 Webpack 无法理解隐式文件依赖的场景。除上例 <code>less-loader</code>，<code>babel-loader</code> 也是一个特别经典的案例。在 <code>babel-loader</code> 内部会添加对 Babel 配置文件如 <code>.babelrc</code> 的依赖，当 <code>.babelrc</code> 内容发生变化时，也会触发 <code>babel-loader</code> 重新运行。</p> <p>此外，Loader Context 还提供了下面几个与依赖处理相关的接口：</p> <ul><li><code>addContextDependency(directory: String)</code>：添加文件目录依赖，目录下内容变更时会触发文件变更；</li> <li><code>addMissingDependency(file: String)</code>：用于添加文件依赖，效果与 <code>addDependency</code> 类似；</li> <li><code>clearDependencies()</code>：清除所有文件依赖。</li></ul> <h3 id="处理二进制资源"><a href="#处理二进制资源" class="header-anchor">#</a> 处理二进制资源</h3> <p>有时候我们期望以二进制方式读入资源文件，例如在 <code>file-loader</code>、<code>image-loader</code> 等场景中，此时只需要添加 <code>export const raw = true</code> 语句即可，如：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">loader</span><span class="token punctuation">(</span><span class="token parameter">source</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">/* ... */</span><span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> raw <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>之后，<code>loader</code> 函数中获取到的第一个参数 <code>source</code> 将会是 Buffer 对象形式的二进制内容。</p> <h3 id="在-loader-中处理日志"><a href="#在-loader-中处理日志" class="header-anchor">#</a> 在 Loader 中处理日志</h3> <p>Webpack 内置了一套 <a href="https://link.juejin.cn/?target=https%3A%2F%2Fwebpack.js.org%2Fconfiguration%2Fother-options%2F%23infrastructurelogging" target="_blank" rel="noopener noreferrer">infrastructureLogging<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 接口，专门用于处理 Webpack 内部及各种第三方组件的日志需求，与 <a href="https://link.juejin.cn/?target=https%3A%2F%2Fgithub.com%2Flog4js-node%2Flog4js-node" target="_blank" rel="noopener noreferrer">log4js<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>、<a href="https://link.juejin.cn/?target=https%3A%2F%2Fgithub.com%2Fwinstonjs%2Fwinston" target="_blank" rel="noopener noreferrer">winston<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 等日志工具类似，<a href="https://link.juejin.cn/?target=https%3A%2F%2Fwebpack.js.org%2Fconfiguration%2Fother-options%2F%23infrastructurelogging" target="_blank" rel="noopener noreferrer">infrastructureLogging<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 也提供了根据日志分级筛选展示功能，从而将日志的写逻辑与输出逻辑解耦。</p> <p>因此，在编写 Loader 时也应该尽可能复用 Webpack 内置的这套 Logging 规则，方法很简单，只需使用 Loader Context 的 <a href="https://link.juejin.cn/?target=https%3A%2F%2Fv4.webpack.js.org%2Fapi%2Floaders%2F%23logging" target="_blank" rel="noopener noreferrer">getLogger<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 接口</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">loader</span><span class="token punctuation">(</span><span class="token parameter">source</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> logger <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getLogger</span><span class="token punctuation">(</span><span class="token string">&quot;xxx-loader&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 使用适当的 logging 接口</span>
  <span class="token comment">// 支持：verbose/log/info/warn/error</span>
  logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;information&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> source<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p><code>getLogger</code> 返回的 <code>logger</code> 对象支持 <code>verbose/log/info/warn/error</code> 五种级别的日志，最终用户可以通过 <a href="https://link.juejin.cn/?target=https%3A%2F%2Fwebpack.js.org%2Fconfiguration%2Fother-options%2F%23level" target="_blank" rel="noopener noreferrer">infrastructureLogging.level<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 配置项筛选不同日志内容</p> <h3 id="在-loader-中上报异常"><a href="#在-loader-中上报异常" class="header-anchor">#</a> 在 Loader 中上报异常</h3> <ul><li>一般应尽量使用 <code>logger.error</code>，减少对用户的打扰；</li> <li>对于需要明确警示用户的错误，优先使用 <code>this.emitError</code>；</li> <li>对于已经严重到不能继续往下编译的错误，使用 <code>callback</code> 。</li></ul> <h2 id="loader-链式调用模型"><a href="#loader-链式调用模型" class="header-anchor">#</a> Loader 链式调用模型</h2> <p>举个例子，为了读取 <code>less</code> 文件，我们通常需要同时配置多个加载器：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  module<span class="token operator">:</span> <span class="token punctuation">{</span>
    rules<span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">{</span>
        test<span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\.less$</span><span class="token regex-delimiter">/</span><span class="token regex-flags">i</span></span><span class="token punctuation">,</span>
        use<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;style-loader&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;css-loader&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;less-loader&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>示例针对 <code>.less</code> 后缀的文件设定了 less、css、style 三个 Loader，Webpack 启动后会以一种所谓“链式调用”的方式按 <code>use</code> 数组顺序从后到前调用 Loader：</p> <p><img src="/blog/images/devops/loader2.png" alt="loader2"></p> <ul><li>首先调用 <code>less-loader</code> 将 Less 代码转译为 CSS 代码；</li> <li>将 <code>less-loader</code> 结果传入 <code>css-loader</code>，进一步将 CSS 内容包装成类似 <code>module.exports = &quot;${css}&quot;</code> 的 JavaScript 代码片段；</li> <li>将 <code>css-loader</code> 结果传入 <code>style-loader</code>，在运行时调用 injectStyle 等函数，将内容注入到页面的 <code>&lt;style&gt;</code> 标签。</li></ul> <p>三个 Loader 分别完成内容转化工作的一部分，形成从右到左的执行链条。链式调用这种设计有两个好处，一是保持单个 Loader 的单一职责，一定程度上降低代码的复杂度；二是细粒度的功能能够被组装成复杂而灵活的处理链条，提升单个 Loader 的可复用性。</p> <p>不过，这只是链式调用的一部分，这里面有两个问题：</p> <ul><li>Loader 链条一旦启动之后，需要所有 Loader 都执行完毕才会结束，没有中断的机会 —— 除非显式抛出异常；</li> <li>某些场景下并不需要关心资源的具体内容，但 Loader 需要在 source 内容被读取出来之后才会执行。</li></ul> <p>为了解决这两个问题，Webpack 在 Loader 基础上叠加了 <code>pitch</code> 的概念。</p> <h3 id="什么是-pitch"><a href="#什么是-pitch" class="header-anchor">#</a> 什么是 pitch</h3> <p>Webpack 允许在 Loader 函数上挂载名为 <code>pitch</code> 的函数，运行时 pitch 会比 Loader 本身更早执行</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token function-variable function">loader</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">source</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'后执行'</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> source<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

loader<span class="token punctuation">.</span><span class="token function-variable function">pitch</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">requestString</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'先执行'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> loader
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>Pitch 函数的完整签名</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">pitch</span><span class="token punctuation">(</span>
    <span class="token parameter">remainingRequest<span class="token operator">:</span> string<span class="token punctuation">,</span> previousRequest<span class="token operator">:</span> string<span class="token punctuation">,</span> data <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span>
<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><ul><li><code>remainingRequest</code> : 当前 loader 之后的资源请求字符串；</li> <li><code>previousRequest</code> : 在执行当前 loader 之前经历过的 loader 列表；</li> <li><code>data</code> : 与 Loader 函数的 <code>data</code> 相同，用于传递需要在 Loader 传播的信息。</li></ul> <h3 id="pitch-函数调度逻辑"><a href="#pitch-函数调度逻辑" class="header-anchor">#</a> pitch 函数调度逻辑</h3> <p>Loader 链条执行过程分三个阶段：</p> <ul><li>pitch、解析资源、执行，设计上与 DOM 的事件模型非常相似，pitch 对应到捕获阶段；</li> <li>执行对应到冒泡阶段；</li> <li>而两个阶段之间 Webpack 会执行资源内容的读取、解析操作，对应 DOM 事件模型的 AT_TARGET 阶段：</li></ul> <p><img src="/blog/images/devops/loader3.png" alt="loader3"></p> <p><code>pitch</code> 阶段按配置顺序从左到右逐个执行 <code>loader.pitch</code> 函数(如果有的话)，开发者可以在 <code>pitch</code> 返回任意值中断后续的链路的执行：</p> <p><img src="/blog/images/devops/loader4.png" alt="loader4"></p> <p>那么为什么要设计 pitch 这一特性呢？<strong>阻断</strong>！</p> <p>回顾一下前面提到过的 less 加载链条：</p> <ul><li><code>less-loader</code> ：将 less 规格的内容转换为标准 css；</li> <li><code>css-loader</code> ：将 css 内容包裹为 JavaScript 模块；</li> <li><code>style-loader</code> ：将 JavaScript 模块的导出结果以 <code>link</code> 、<code>style</code> 标签等方式挂载到 html 中，让 css 代码能够正确运行在浏览器上。</li></ul> <p>实际上， <code>style-loader</code> 只是负责让 CSS 在浏览器环境下跑起来，并不需要关心具体内容，很适合用 pitch 来处理：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// ...</span>
<span class="token comment">// Loader 本身不作任何处理</span>
<span class="token keyword">const</span> <span class="token function-variable function">loaderApi</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// pitch 中根据参数拼接模块代码</span>
loaderApi<span class="token punctuation">.</span><span class="token function-variable function">pitch</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">loader</span><span class="token punctuation">(</span><span class="token parameter">remainingRequest</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">//...</span>

  <span class="token keyword">switch</span> <span class="token punctuation">(</span>injectType<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">case</span> <span class="token string">'linkTag'</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>
        esModule
          <span class="token operator">?</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">...</span><span class="token template-punctuation string">`</span></span>
          <span class="token comment">// 引入 runtime 模块</span>
          <span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">var api = require(</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>loaderUtils<span class="token punctuation">.</span><span class="token function">stringifyRequest</span><span class="token punctuation">(</span>
              <span class="token keyword">this</span><span class="token punctuation">,</span>
              <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">!</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'runtime/injectStylesIntoLinkTag.js'</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>
            <span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">);
            // 引入 css 模块
            var content = require(</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>loaderUtils<span class="token punctuation">.</span><span class="token function">stringifyRequest</span><span class="token punctuation">(</span>
              <span class="token keyword">this</span><span class="token punctuation">,</span>
              <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">!!</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>remainingRequest<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>
            <span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">);

            content = content.__esModule ? content.default : content;</span><span class="token template-punctuation string">`</span></span>
      <span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> // ...</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">case</span> <span class="token string">'lazyStyleTag'</span><span class="token operator">:</span>
    <span class="token keyword">case</span> <span class="token string">'lazySingletonStyleTag'</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token comment">//...</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">case</span> <span class="token string">'styleTag'</span><span class="token operator">:</span>
    <span class="token keyword">case</span> <span class="token string">'singletonStyleTag'</span><span class="token operator">:</span>
    <span class="token keyword">default</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token comment">// ...</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> loaderApi<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br></div></div><p>关键点：</p> <ul><li><p><code>loaderApi</code> 为空函数，不做任何处理；</p></li> <li><p><code>loaderApi.pitch</code>中拼接结果，导出的代码包含：</p> <ul><li>引入运行时模块 <code>runtime/injectStylesIntoLinkTag.js</code>；</li> <li>复用 <code>remainingRequest</code> 参数，重新引入 css 文件。</li></ul></li></ul> <p>运行后，关键结果大致如：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> api <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'xxx/style-loader/lib/runtime/injectStylesIntoLinkTag.js'</span><span class="token punctuation">)</span>
<span class="token keyword">var</span> content <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'!!css-loader!less-loader!./xxx.less'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>注意了，到这里 style-loader 的 pitch 函数返回这一段内容，后续的 Loader 就不会继续执行，当前调用链条中断了：</p> <p><img src="/blog/images/devops/loader5.png" alt="loader5"></p> <p>之后，Webpack 继续解析、构建 style-loader 返回的结果，遇到 inline loader 语句：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> content <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'!!css-loader!less-loader!./xxx.less'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>所以从 Webpack 的角度看，对同一个文件实际调用了两次 loader 链，第一次在 style-loader 的 pitch 中断，第二次根据 inline loader 的内容跳过了 style-loader。</p> <h2 id="loader-辅助工具"><a href="#loader-辅助工具" class="header-anchor">#</a> Loader 辅助工具</h2> <p>Loader 辅助工具，包括：</p> <ul><li>了解 <code>loader-utils</code>，并使用 <code>loader-utils</code> 拼接文件名；</li> <li>了解 <code>schema-tiles</code>，以及其背后的 <code>ajv</code> 库与 JSON-Schema 协议，学习使用 <code>schema-utils</code> 实现参数校验。</li></ul> <h3 id="使用-schema-utils"><a href="#使用-schema-utils" class="header-anchor">#</a> 使用 schema-utils</h3> <p>Webpack，以及 Webpack 生态下的诸多 Loader、Plugin 基本上都会提供若干“<strong>配置项</strong>”，供用户调整组件的运行逻辑，这些组件内部通常都会使用 <a href="https://link.juejin.cn/?target=https%3A%2F%2Fwww.npmjs.com%2Fpackage%2Fschema-utils" target="_blank" rel="noopener noreferrer">schema-utils<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 工具库校验用户传入的配置是否满足要求。</p> <p>编写配置对象的 Schema 描述，例如：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// options.json</span>
<span class="token punctuation">{</span>
  <span class="token string">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;object&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;properties&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;name&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token string">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;boolean&quot;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token string">&quot;required&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token string">&quot;additionalProperties&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>在 Loader 中调用 schema-utils 校验配置对象</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> validate <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;schema-utils&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> schema <span class="token keyword">from</span> <span class="token string">&quot;./options.json&quot;</span><span class="token punctuation">;</span>

<span class="token comment">// 调用 schema-utils 完成校验</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">loader</span><span class="token punctuation">(</span><span class="token parameter">source</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> options <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getOptions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">validate</span><span class="token punctuation">(</span>schema<span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> source<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// Webpack5 之后还可以借助 Loader Context 的 `getOptions` 接口完成校验</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">loader</span><span class="token punctuation">(</span><span class="token parameter">source</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> options <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getOptions</span><span class="token punctuation">(</span>schema<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> source<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p><code>schema-utils</code> 的校验能力很强，能够完美支撑起 Webpack 生态下非常复杂的参数校验需求，底层主要依赖于 <a href="https://link.juejin.cn/?target=https%3A%2F%2Fajv.js.org%2Fguide%2Fgetting-started.html" target="_blank" rel="noopener noreferrer">ajv<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 。</p> <p>Webpack 官方选择 <code>ajv</code> 作用配置参数的校验工具，并将其二次封装为 <code>schema-utils</code> 库，供 Webpack 生态下的诸多 Loader、Plugin 使用。而上面介绍的基础类型、类型校验、复合校验规则等内容是 <code>ajv</code> 非常基础且重要的知识点，三者协作组成 <code>ajv</code> 校验 <code>schema</code> 的框架结构，除此之外还有许多增强 Schema 表述能力的增强指令，包括：<code>$data</code>、<code>$ref</code>、<code>definitions</code> 等，篇幅关系这里不一一列举。同学们也可以参考 Webpack 官方编写的 <a href="https://link.juejin.cn/?target=https%3A%2F%2Fgithub1s.com%2Fwebpack%2Fwebpack%2Fblob%2FHEAD%2Fschemas%2FWebpackOptions.json" target="_blank" rel="noopener noreferrer">Schema 文件<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>，学习各种校验规则的写法。</p> <h3 id="使用-loader-utils"><a href="#使用-loader-utils" class="header-anchor">#</a> 使用 loader-utils</h3> <p>在 Webpack5 之前，<a href="https://link.juejin.cn/?target=https%3A%2F%2Fgithub.com%2Fwebpack%2Floader-utils" target="_blank" rel="noopener noreferrer">loader-utils<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 是一个非常重要的 Loader 开发辅助工具，为开发者提供了诸如 <code>getOptions/getCurrentRequest/parseQuery</code> 等核心接口，这些接口被诸多 Loader 广泛使用，到 Webpack5 之后干脆将这部分能力迁移到 Loader Context，致使 <code>loader-utils</code> 被大幅裁减简化。</p> <p>被裁减后的 <code>loader-utils</code> 仅保留了四个接口：</p> <ul><li><code>urlToRequest</code>：用于将模块路径转换为文件路径的工具函数；</li> <li><code>isUrlRequest</code>：用于判定字符串是否为模块请求路径；</li> <li><code>getHashDigest</code>：用于计算内容 Hash 值；</li> <li><code>interpolateName</code>：用于拼接文件名的模板工具；</li></ul> <h2 id="vue-loader-原理"><a href="#vue-loader-原理" class="header-anchor">#</a> vue-loader 原理</h2> <p><code>vue-loader</code> 是一个综合性很强的示例，它借助 Webpack 与组件的一系列特性巧妙地解决了：如何区分 Vue SFC 不同代码块，并复用其它 Loader 处理不同区块的内容？</p> <p>先从结构说起，<code>vue-loader</code> 内部实际上包含了三个组件：</p> <ul><li><code>lib/index.js</code> 定义的 Normal Loader，负责将 Vue SFC 不同区块转化为 JavaScript <code>import</code> 语句，具体逻辑下面细讲；</li> <li><code>lib/loaders/pitcher.js</code> 定义的 Pitch Loader，负责遍历的 <code>rules</code> 数组，拼接出完整的行内引用路径；</li> <li><code>lib/plugin.js</code> 定义的插件，负责初始化编译环境，如复制原始 <code>rules</code> 配置等；</li></ul> <p>三者协作共同完成对 SFC 的处理，使用时需要用户同时注册 Normal Loader 和 Plugin，如：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> VueLoaderPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;vue-loader/lib/plugin&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  module<span class="token operator">:</span> <span class="token punctuation">{</span>
    rules<span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">{</span>
        test<span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">.vue$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span>
        use<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span> loader<span class="token operator">:</span> <span class="token string">&quot;vue-loader&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  plugins<span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token keyword">new</span> <span class="token class-name">VueLoaderPlugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p><code>vue-loader</code> 运行过程大致上可以划分为两个阶段：</p> <ol><li>预处理阶段：动态修改 Webpack 配置，注入 <code>vue-loader</code> 专用的一系列 <code>module.rules</code>；</li> <li>内容处理阶段：Normal Loader 配合 Pitch Loader 完成文件内容转译。</li></ol> <h3 id="预处理阶段"><a href="#预处理阶段" class="header-anchor">#</a> 预处理阶段</h3> <p><code>vue-loader</code> 插件会在 <code>apply</code> 函数中动态修改 Webpack 配置，核心代码如下：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">VueLoaderPlugin</span> <span class="token punctuation">{</span>
  <span class="token function">apply</span> <span class="token punctuation">(</span><span class="token parameter">compiler</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>

    <span class="token keyword">const</span> rules <span class="token operator">=</span> compiler<span class="token punctuation">.</span>options<span class="token punctuation">.</span>module<span class="token punctuation">.</span>rules
    <span class="token comment">// ...</span>

    <span class="token keyword">const</span> clonedRules <span class="token operator">=</span> rules
      <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token parameter">r</span> <span class="token operator">=&gt;</span> r <span class="token operator">!==</span> rawVueRules<span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">rawRule</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">cloneRule</span><span class="token punctuation">(</span>rawRule<span class="token punctuation">,</span> refs<span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token comment">// ...</span>

    <span class="token comment">// global pitcher (responsible for injecting template compiler loader &amp; CSS</span>
    <span class="token comment">// post loader)</span>
    <span class="token keyword">const</span> pitcher <span class="token operator">=</span> <span class="token punctuation">{</span>
      loader<span class="token operator">:</span> require<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'./loaders/pitcher'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function-variable function">resourceQuery</span><span class="token operator">:</span> <span class="token parameter">query</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>query<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token boolean">false</span> <span class="token punctuation">}</span>
        <span class="token keyword">const</span> parsed <span class="token operator">=</span> qs<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>query<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> parsed<span class="token punctuation">.</span>vue <span class="token operator">!=</span> <span class="token keyword">null</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// ...</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// replace original rules</span>
    compiler<span class="token punctuation">.</span>options<span class="token punctuation">.</span>module<span class="token punctuation">.</span>rules <span class="token operator">=</span> <span class="token punctuation">[</span>
      pitcher<span class="token punctuation">,</span>
      <span class="token operator">...</span>clonedRules<span class="token punctuation">,</span>
      <span class="token operator">...</span>rules
    <span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">cloneRule</span> <span class="token punctuation">(</span><span class="token parameter">rawRule<span class="token punctuation">,</span> refs</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> VueLoaderPlugin
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br></div></div><p>拆开来看，插件主要完成两个任务：</p> <ol><li><p>初始化并注册 Pitch Loader：代码第16行，定义pitcher对象，指定loader路径为 <code>require.resolve('./loaders/pitcher')</code> ，并将pitcher注入到 <code>rules</code> 数组首位。这种动态注入的好处是用户不用关注 —— 不去看源码根本不知道还有一个 pitcher loader，而且能保证 pitcher 能在其他 rule 之前执行，确保运行顺序。</p></li> <li><p>复制 <code>rules</code> 配置：代码第8行遍历 <code>compiler.options.module.rules</code> 数组，也就是用户提供的  Webpack  配置中的 <code>module.rules</code> 项，对每个rule执行 <code>cloneRule</code> 方法复制规则对象。</p></li></ol> <p>之后，将  Webpack  配置修改为 <code>[pitcher, ...clonedRules, ...rules]</code></p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  module<span class="token operator">:</span> <span class="token punctuation">{</span>
    rules<span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">{</span>
        test<span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">.vue$</span><span class="token regex-delimiter">/</span><span class="token regex-flags">i</span></span><span class="token punctuation">,</span>
        use<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span> loader<span class="token operator">:</span> <span class="token string">&quot;vue-loader&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">{</span>
        test<span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\.css$</span><span class="token regex-delimiter">/</span><span class="token regex-flags">i</span></span><span class="token punctuation">,</span>
        use<span class="token operator">:</span> <span class="token punctuation">[</span>MiniCssExtractPlugin<span class="token punctuation">.</span>loader<span class="token punctuation">,</span> <span class="token string">&quot;css-loader&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">{</span>
        test<span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\.js$</span><span class="token regex-delimiter">/</span><span class="token regex-flags">i</span></span><span class="token punctuation">,</span>
        exclude<span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">node_modules</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span>
        use<span class="token operator">:</span> <span class="token punctuation">{</span>
          loader<span class="token operator">:</span> <span class="token string">&quot;babel-loader&quot;</span><span class="token punctuation">,</span>
          options<span class="token operator">:</span> <span class="token punctuation">{</span>
            presets<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">&quot;@babel/preset-env&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> targets<span class="token operator">:</span> <span class="token string">&quot;defaults&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  plugins<span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token keyword">new</span> <span class="token class-name">VueLoaderPlugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token keyword">new</span> <span class="token class-name">MiniCssExtractPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span> filename<span class="token operator">:</span> <span class="token string">&quot;[name].css&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br></div></div><p>这里定义了三个 rule，分别对应 vue、js、css 文件。经过 plugin 转换之后的结果大概为：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  module<span class="token operator">:</span> <span class="token punctuation">{</span>
    rules<span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">{</span>
        loader<span class="token operator">:</span> <span class="token string">&quot;/node_modules/vue-loader/lib/loaders/pitcher.js&quot;</span><span class="token punctuation">,</span>
        <span class="token function-variable function">resourceQuery</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        options<span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">{</span>
        <span class="token function-variable function">resource</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token function-variable function">resourceQuery</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        use<span class="token operator">:</span> <span class="token punctuation">[</span>
          <span class="token punctuation">{</span>
            loader<span class="token operator">:</span> <span class="token string">&quot;/node_modules/mini-css-extract-plugin/dist/loader.js&quot;</span><span class="token punctuation">,</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token punctuation">{</span> loader<span class="token operator">:</span> <span class="token string">&quot;css-loader&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">{</span>
        <span class="token function-variable function">resource</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token function-variable function">resourceQuery</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        exclude<span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">node_modules</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span>
        use<span class="token operator">:</span> <span class="token punctuation">[</span>
          <span class="token punctuation">{</span>
            loader<span class="token operator">:</span> <span class="token string">&quot;babel-loader&quot;</span><span class="token punctuation">,</span>
            options<span class="token operator">:</span> <span class="token punctuation">{</span>
              presets<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">&quot;@babel/preset-env&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> targets<span class="token operator">:</span> <span class="token string">&quot;defaults&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            ident<span class="token operator">:</span> <span class="token string">&quot;clonedRuleSet-2[0].rules[0].use&quot;</span><span class="token punctuation">,</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">{</span>
        test<span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\.vue$</span><span class="token regex-delimiter">/</span><span class="token regex-flags">i</span></span><span class="token punctuation">,</span>
        use<span class="token operator">:</span> <span class="token punctuation">[</span>
          <span class="token punctuation">{</span> loader<span class="token operator">:</span> <span class="token string">&quot;vue-loader&quot;</span><span class="token punctuation">,</span> options<span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> ident<span class="token operator">:</span> <span class="token string">&quot;vue-loader-options&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">{</span>
        test<span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\.css$</span><span class="token regex-delimiter">/</span><span class="token regex-flags">i</span></span><span class="token punctuation">,</span>
        use<span class="token operator">:</span> <span class="token punctuation">[</span>
          <span class="token punctuation">{</span>
            loader<span class="token operator">:</span> <span class="token string">&quot;/node_modules/mini-css-extract-plugin/dist/loader.js&quot;</span><span class="token punctuation">,</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token punctuation">{</span> loader<span class="token operator">:</span> <span class="token string">&quot;css-loader&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">{</span>
        test<span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\.vue$</span><span class="token regex-delimiter">/</span><span class="token regex-flags">i</span></span><span class="token punctuation">,</span>
        exclude<span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">node_modules</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span>
        use<span class="token operator">:</span> <span class="token punctuation">[</span>
          <span class="token punctuation">{</span>
            loader<span class="token operator">:</span> <span class="token string">&quot;babel-loader&quot;</span><span class="token punctuation">,</span>
            options<span class="token operator">:</span> <span class="token punctuation">{</span>
              presets<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">&quot;@babel/preset-env&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> targets<span class="token operator">:</span> <span class="token string">&quot;defaults&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            ident<span class="token operator">:</span> <span class="token string">&quot;clonedRuleSet-2[0].rules[0].use&quot;</span><span class="token punctuation">,</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br></div></div><p>转换之后生成6个rule，按定义的顺序分别为：</p> <ol><li>针对 <code>xx.vue&amp;vue</code> 格式路径生效的规则，只用了 <code>vue-loader</code> 的 Pitch 作为 Loader；</li> <li>被复制的 CSS 处理规则，<code>use</code> 数组与开发者定义的规则相同；</li> <li>被复制的 JS 处理规则，<code>use</code> 数组也跟开发者定义的规则相同；</li> <li>开发者定义的 <code>vue-loader</code> 规则，内容及配置都不变；</li> <li>开发者定义的css规则，用到 <code>css-loader</code>、<code>mini-css-extract-plugin loader</code>；</li> <li>开发者定义的js规则，用到 <code>babel-loader</code>。</li></ol> <p>可以看到，第2、3项是从开发者提供的配置中复制过来的，内容相似，只是 <code>cloneRule</code> 在复制过程会给这些规则重新定义 <code>resourceQuery</code> 函数：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">cloneRule</span> <span class="token punctuation">(</span><span class="token parameter">rawRule<span class="token punctuation">,</span> refs</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> rules <span class="token operator">=</span> ruleSetCompiler<span class="token punctuation">.</span><span class="token function">compileRules</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">clonedRuleSet-</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token operator">++</span>uid<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>
      rules<span class="token operator">:</span> <span class="token punctuation">[</span>rawRule<span class="token punctuation">]</span>
    <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span> refs<span class="token punctuation">)</span>
  
    <span class="token keyword">const</span> conditions <span class="token operator">=</span> rules<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>rules
      <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">rule</span> <span class="token operator">=&gt;</span> rule<span class="token punctuation">.</span>conditions<span class="token punctuation">)</span>
      <span class="token comment">// shallow flat</span>
      <span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">prev<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> prev<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>next<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

    <span class="token comment">// ...</span>
  
    <span class="token keyword">const</span> res <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> rawRule<span class="token punctuation">,</span> <span class="token punctuation">{</span>
      <span class="token function-variable function">resource</span><span class="token operator">:</span> <span class="token parameter">resources</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        currentResource <span class="token operator">=</span> resources
        <span class="token keyword">return</span> <span class="token boolean">true</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token function-variable function">resourceQuery</span><span class="token operator">:</span> <span class="token parameter">query</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>query<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token boolean">false</span> <span class="token punctuation">}</span>
        <span class="token keyword">const</span> parsed <span class="token operator">=</span> qs<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>query<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>parsed<span class="token punctuation">.</span>vue <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">return</span> <span class="token boolean">false</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>conditions<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">return</span> <span class="token boolean">false</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 用import路径的lang参数测试是否适用于当前rule</span>
        <span class="token keyword">const</span> fakeResourcePath <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>currentResource<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>parsed<span class="token punctuation">.</span>lang<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> condition <span class="token keyword">of</span> conditions<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// add support for resourceQuery</span>
          <span class="token keyword">const</span> request <span class="token operator">=</span> condition<span class="token punctuation">.</span>property <span class="token operator">===</span> <span class="token string">'resourceQuery'</span> <span class="token operator">?</span> query <span class="token operator">:</span> fakeResourcePath
          <span class="token keyword">if</span> <span class="token punctuation">(</span>condition <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>condition<span class="token punctuation">.</span><span class="token function">fn</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token comment">// ...</span>
  
    <span class="token keyword">return</span> res
  <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br></div></div><p><code>cloneRule</code> 内部定义的 <code>resourceQuery</code> 函数对应 <a href="https://link.juejin.cn/?target=https%3A%2F%2Fwebpack.js.org%2Fconfiguration%2Fmodule%2F%23ruleresourcequery" target="_blank" rel="noopener noreferrer">module.rules.resourceQuery<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 配置项，与我们经常用的 <code>test</code> 差不多，都用于判断资源路径是否适用这个rule。这里 <code>resourceQuery</code> 核心逻辑就是取出路径中的lang参数，伪造一个以 <code>lang</code> 结尾的路径，传入rule的condition中测试路径名对该rule是否生效，例如下面这种会命中 <code>/\.js$/i</code> 规则：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">import</span> script <span class="token keyword">from</span> <span class="token string">&quot;./index.vue?vue&amp;type=script&amp;lang=js&amp;&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><code>vue-loader</code> 正是基于这一规则，为不同内容块 (css/js/template) 匹配、复用用户所提供的 rule 设置。</p> <h3 id="内容处理阶段"><a href="#内容处理阶段" class="header-anchor">#</a> 内容处理阶段</h3> <p>插件处理完配置，webpack 运行起来之后，Vue SFC 文件会被多次传入不同的 Loader，经历多次中间形态变换之后才产出最终的 js 结果，大致上可以分为如下步骤：</p> <ol><li>路径命中 <code>/\.vue$/i</code> 规则，调用 <code>vue-loader</code> 生成中间结果 A；</li> <li>结果 A 命中 <code>xx.vue?vue</code> 规则，调用 <code>vue-loader</code> Pitch Loader 生成中间结果 B；</li> <li>结果 B 命中具体 Loader，直接调用 Loader 做处理。</li></ol> <p>过程大致为：</p> <p><img src="/blog/images/devops/loader6.png" alt="loader6"></p> <p>举个转换过程的例子：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 原始代码</span>
<span class="token keyword">import</span> xx <span class="token keyword">from</span> <span class="token string">'./index.vue'</span><span class="token punctuation">;</span>
<span class="token comment">// 第一步，命中 vue-loader，转换为：</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> render<span class="token punctuation">,</span> staticRenderFns <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;./index.vue?vue&amp;type=template&amp;id=2964abc9&amp;scoped=true&amp;&quot;</span>
<span class="token keyword">import</span> script <span class="token keyword">from</span> <span class="token string">&quot;./index.vue?vue&amp;type=script&amp;lang=js&amp;&quot;</span>
<span class="token keyword">export</span> <span class="token operator">*</span> <span class="token keyword">from</span> <span class="token string">&quot;./index.vue?vue&amp;type=script&amp;lang=js&amp;&quot;</span>
<span class="token keyword">import</span> style0 <span class="token keyword">from</span> <span class="token string">&quot;./index.vue?vue&amp;type=style&amp;index=0&amp;id=2964abc9&amp;scoped=true&amp;lang=css&amp;&quot;</span>

<span class="token comment">// 第二步，命中 pitcher，转换为：</span>
<span class="token keyword">export</span> <span class="token operator">*</span> <span class="token keyword">from</span> <span class="token string">&quot;-!../../node_modules/vue-loader/lib/loaders/templateLoader.js??vue-loader-options!../../node_modules/vue-loader/lib/index.js??vue-loader-options!./index.vue?vue&amp;type=template&amp;id=2964abc9&amp;scoped=true&amp;&quot;</span>
<span class="token keyword">import</span> mod <span class="token keyword">from</span> <span class="token string">&quot;-!../../node_modules/babel-loader/lib/index.js??clonedRuleSet-2[0].rules[0].use!../../node_modules/vue-loader/lib/index.js??vue-loader-options!./index.vue?vue&amp;type=script&amp;lang=js&amp;&quot;</span><span class="token punctuation">;</span> 
<span class="token keyword">export</span> <span class="token keyword">default</span> mod<span class="token punctuation">;</span> <span class="token keyword">export</span> <span class="token operator">*</span> <span class="token keyword">from</span> <span class="token string">&quot;-!../../node_modules/babel-loader/lib/index.js??clonedRuleSet-2[0].rules[0].use!../../node_modules/vue-loader/lib/index.js??vue-loader-options!./index.vue?vue&amp;type=script&amp;lang=js&amp;&quot;</span>
<span class="token keyword">export</span> <span class="token operator">*</span> <span class="token keyword">from</span> <span class="token string">&quot;-!../../node_modules/mini-css-extract-plugin/dist/loader.js!../../node_modules/css-loader/dist/cjs.js!../../node_modules/vue-loader/lib/loaders/stylePostLoader.js!../../node_modules/vue-loader/lib/index.js??vue-loader-options!./index.vue?vue&amp;type=style&amp;index=0&amp;id=2964abc9&amp;scoped=true&amp;lang=css&amp;&quot;</span>

<span class="token comment">// 第三步，根据行内路径规则按序调用loader</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>每一步的细节，请继续往下看。</p> <h3 id="第一次执行-vue-loader"><a href="#第一次执行-vue-loader" class="header-anchor">#</a> 第一次执行 vue-loader</h3> <p>在运行阶段，根据配置规则， Webpack 首先将原始的 SFC 内容传入 <code>vue-loader</code>，例如对于下面的代码：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// main.js</span>
<span class="token keyword">import</span> xx <span class="token keyword">from</span> <span class="token string">'index.vue'</span><span class="token punctuation">;</span>

<span class="token comment">// index.vue 代码</span>
<span class="token operator">&lt;</span>template<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">&quot;root&quot;</span><span class="token operator">&gt;</span>hello world<span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>template<span class="token operator">&gt;</span>

<span class="token operator">&lt;</span>script<span class="token operator">&gt;</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>
  <span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function">mounted</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;hello world&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>

<span class="token operator">&lt;</span>style scoped<span class="token operator">&gt;</span>
<span class="token punctuation">.</span>root <span class="token punctuation">{</span>
  font<span class="token operator">-</span>size<span class="token operator">:</span> <span class="token number">12</span>px<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>style<span class="token operator">&gt;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><p>此时<strong>第一次</strong>执行 vue-loader ，执行如下逻辑：</p> <ol><li>调用 <code>@vue/component-compiler-utils</code> 包的parse函数，将SFC 文本解析为AST对象；</li> <li>遍历 AST 对象属性，转换为特殊的引用路径；</li> <li>返回转换结果。</li></ol> <p>对于上述 <code>index.vue</code> 内容，转换结果为：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> render<span class="token punctuation">,</span> staticRenderFns <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;./index.vue?vue&amp;type=template&amp;id=2964abc9&amp;scoped=true&amp;&quot;</span>
<span class="token keyword">import</span> script <span class="token keyword">from</span> <span class="token string">&quot;./index.vue?vue&amp;type=script&amp;lang=js&amp;&quot;</span>
<span class="token keyword">export</span> <span class="token operator">*</span> <span class="token keyword">from</span> <span class="token string">&quot;./index.vue?vue&amp;type=script&amp;lang=js&amp;&quot;</span>
<span class="token keyword">import</span> style0 <span class="token keyword">from</span> <span class="token string">&quot;./index.vue?vue&amp;type=style&amp;index=0&amp;id=2964abc9&amp;scoped=true&amp;lang=css&amp;&quot;</span>


<span class="token comment">/* normalize component */</span>
<span class="token keyword">import</span> normalizer <span class="token keyword">from</span> <span class="token string">&quot;!../../node_modules/vue-loader/lib/runtime/componentNormalizer.js&quot;</span>
<span class="token keyword">var</span> component <span class="token operator">=</span> <span class="token function">normalizer</span><span class="token punctuation">(</span>
  script<span class="token punctuation">,</span>
  render<span class="token punctuation">,</span>
  staticRenderFns<span class="token punctuation">,</span>
  <span class="token boolean">false</span><span class="token punctuation">,</span>
  <span class="token keyword">null</span><span class="token punctuation">,</span>
  <span class="token string">&quot;2964abc9&quot;</span><span class="token punctuation">,</span>
  <span class="token keyword">null</span>
  
<span class="token punctuation">)</span>

<span class="token operator">...</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> component<span class="token punctuation">.</span>exports
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><p>注意，这里并没有真的处理 block 里面的内容，而是简单地针对不同类型的内容块生成 import 语句：</p> <ul><li>Script：<code>&quot;./index.vue?vue&amp;type=script&amp;lang=js&amp;&quot;</code></li> <li>Template: <code>&quot;./index.vue?vue&amp;type=template&amp;id=2964abc9&amp;scoped=true&amp;&quot;</code></li> <li>Style: <code>&quot;./index.vue?vue&amp;type=style&amp;index=0&amp;id=2964abc9&amp;scoped=true&amp;lang=css&amp;&quot;</code></li></ul> <p>这些路径都对应原始的 <code>.vue</code> 路径基础上增加了 <code>vue</code> 标志符及 type、lang 等参数。</p> <h4 id="执行-pitch-loader"><a href="#执行-pitch-loader" class="header-anchor">#</a> 执行 Pitch Loader</h4> <p>如前所述，<code>vue-loader</code> 插件会在预处理阶段插入带 <code>resourceQuery</code> 函数的 Pitch Loader：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> pitcher <span class="token operator">=</span> <span class="token punctuation">{</span>
  loader<span class="token operator">:</span> require<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'./loaders/pitcher'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token function-variable function">resourceQuery</span><span class="token operator">:</span> <span class="token parameter">query</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>query<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token boolean">false</span> <span class="token punctuation">}</span>
    <span class="token keyword">const</span> parsed <span class="token operator">=</span> qs<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>query<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> parsed<span class="token punctuation">.</span>vue <span class="token operator">!=</span> <span class="token keyword">null</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>其中， <code>resourceQuery</code> 函数命中 <code>xx.vue?vue</code> 格式的路径，也就是说上面 <code>vue-loader</code> 转换后的 import 路径会被 Pitch Loader 命中，做进一步处理。Pitch Loader 的逻辑比较简单，做的事情也只是转换 import 路径：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> qs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'querystring'</span><span class="token punctuation">)</span>
<span class="token operator">...</span>

<span class="token keyword">const</span> <span class="token function-variable function">dedupeESLintLoader</span> <span class="token operator">=</span> <span class="token parameter">loaders</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token operator">...</span><span class="token punctuation">}</span>

<span class="token keyword">const</span> <span class="token function-variable function">shouldIgnoreCustomBlock</span> <span class="token operator">=</span> <span class="token parameter">loaders</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token operator">...</span><span class="token punctuation">}</span>

<span class="token comment">// 正常的loader阶段，直接返回结果</span>
module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token parameter">code</span> <span class="token operator">=&gt;</span> code

module<span class="token punctuation">.</span>exports<span class="token punctuation">.</span><span class="token function-variable function">pitch</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">remainingRequest</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> options <span class="token operator">=</span> loaderUtils<span class="token punctuation">.</span><span class="token function">getOptions</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> cacheDirectory<span class="token punctuation">,</span> cacheIdentifier <span class="token punctuation">}</span> <span class="token operator">=</span> options
  <span class="token comment">// 关注点1： 通过解析 resourceQuery 获取loader参数</span>
  <span class="token keyword">const</span> query <span class="token operator">=</span> qs<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>resourceQuery<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

  <span class="token keyword">let</span> loaders <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>loaders

  <span class="token comment">// if this is a language block request, eslint-loader may get matched</span>
  <span class="token comment">// multiple times</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>query<span class="token punctuation">.</span>type<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// if this is an inline block, since the whole file itself is being linted,</span>
    <span class="token comment">// remove eslint-loader to avoid duplicate linting.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\.vue$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>resourcePath<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      loaders <span class="token operator">=</span> loaders<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token parameter">l</span> <span class="token operator">=&gt;</span> <span class="token operator">!</span><span class="token function">isESLintLoader</span><span class="token punctuation">(</span>l<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// This is a src import. Just make sure there's not more than 1 instance</span>
      <span class="token comment">// of eslint present.</span>
      loaders <span class="token operator">=</span> <span class="token function">dedupeESLintLoader</span><span class="token punctuation">(</span>loaders<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// remove self</span>
  loaders <span class="token operator">=</span> loaders<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>isPitcher<span class="token punctuation">)</span>

  <span class="token comment">// do not inject if user uses null-loader to void the type (#1239)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>loaders<span class="token punctuation">.</span><span class="token function">some</span><span class="token punctuation">(</span>isNullLoader<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">const</span> <span class="token function-variable function">genRequest</span> <span class="token operator">=</span> <span class="token parameter">loaders</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token operator">...</span> 
  <span class="token punctuation">}</span>

  <span class="token comment">// Inject style-post-loader before css-loader for scoped CSS and trimming</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>query<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">style</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> cssLoaderIndex <span class="token operator">=</span> loaders<span class="token punctuation">.</span><span class="token function">findIndex</span><span class="token punctuation">(</span>isCSSLoader<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>cssLoaderIndex <span class="token operator">&gt;</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token operator">...</span>
      <span class="token keyword">return</span> query<span class="token punctuation">.</span>module
        <span class="token operator">?</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">export { default } from  </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>request<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">; export * from </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>request<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>
        <span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">export * from </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>request<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// for templates: inject the template compiler &amp; optional cache</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>query<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">template</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token operator">...</span>
    <span class="token comment">// console.log(request)</span>
    <span class="token comment">// the template compiler uses esm exports</span>
    <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">export * from </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>request<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>
  <span class="token punctuation">}</span>

  <span class="token comment">// if a custom block has no other matching loader other than vue-loader itself</span>
  <span class="token comment">// or cache-loader, we should ignore it</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>query<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">custom</span><span class="token template-punctuation string">`</span></span> <span class="token operator">&amp;&amp;</span> <span class="token function">shouldIgnoreCustomBlock</span><span class="token punctuation">(</span>loaders<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token template-punctuation string">`</span></span>
  <span class="token punctuation">}</span>

  <span class="token keyword">const</span> request <span class="token operator">=</span> <span class="token function">genRequest</span><span class="token punctuation">(</span>loaders<span class="token punctuation">)</span>
  <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">import mod from </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>request<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">; export default mod; export * from </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>request<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br></div></div><p>核心功能是遍历用户定义的rule数组，拼接出完整的行内引用路径，例如：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 开发代码：</span>
<span class="token keyword">import</span> xx <span class="token keyword">from</span> <span class="token string">'index.vue'</span>
<span class="token comment">// 第一步，通过vue-loader转换成带参数的路径</span>
<span class="token keyword">import</span> script <span class="token keyword">from</span> <span class="token string">&quot;./index.vue?vue&amp;type=script&amp;lang=js&amp;&quot;</span>
<span class="token comment">// 第二步，在 pitcher 中解读loader数组的配置，并将路径转换成完整的行内路径格式</span>
<span class="token keyword">import</span> mod <span class="token keyword">from</span> <span class="token string">&quot;-!../../node_modules/babel-loader/lib/index.js??clonedRuleSet-2[0].rules[0].use!../../node_modules/vue-loader/lib/index.js??vue-loader-options!./index.vue?vue&amp;type=script&amp;lang=js&amp;&quot;</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h3 id="第二次执行-vue-loader"><a href="#第二次执行-vue-loader" class="header-anchor">#</a> 第二次执行 vue-loader</h3> <p>通过上面 <code>vue-loader</code> -&gt; Pitch Loader 处理后，会得到一个新的行内路径，例如：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">import</span> mod <span class="token keyword">from</span> <span class="token string">&quot;-!../../node_modules/babel-loader/lib/index.js??clonedRuleSet-2[0].rules[0].use!../../node_modules/vue-loader/lib/index.js??vue-loader-options!./index.vue?vue&amp;type=script&amp;lang=js&amp;&quot;</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>以这个 import 语句为例，之后 Webpack 会按照下述逻辑运行：</p> <ul><li>调用 <code>vue-loader</code> 处理 <code>index.js</code> 文件；</li> <li>调用 <code>babel-loader</code> 处理上一步返回的内容。</li></ul> <p>这就给了 <code>vue-loader</code> 第二次执行的机会，再回过头来看看 <code>vue-loader</code> 的代码：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">source</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>

  <span class="token keyword">const</span> <span class="token punctuation">{</span>
    target<span class="token punctuation">,</span>
    request<span class="token punctuation">,</span>
    minimize<span class="token punctuation">,</span>
    sourceMap<span class="token punctuation">,</span>
    rootContext<span class="token punctuation">,</span>
    resourcePath<span class="token punctuation">,</span>
    resourceQuery <span class="token operator">=</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span> <span class="token operator">=</span> loaderContext<span class="token punctuation">;</span>
  <span class="token comment">// ...</span>

  <span class="token keyword">const</span> descriptor <span class="token operator">=</span> <span class="token function">parse</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    source<span class="token punctuation">,</span>
    compiler<span class="token operator">:</span> options<span class="token punctuation">.</span>compiler <span class="token operator">||</span> <span class="token function">loadTemplateCompiler</span><span class="token punctuation">(</span>loaderContext<span class="token punctuation">)</span><span class="token punctuation">,</span>
    filename<span class="token punctuation">,</span>
    sourceRoot<span class="token punctuation">,</span>
    needMap<span class="token operator">:</span> sourceMap<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// if the query has a type field, this is a language block request</span>
  <span class="token comment">// e.g. foo.vue?type=template&amp;id=xxxxx</span>
  <span class="token comment">// and we will return early</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>incomingQuery<span class="token punctuation">.</span>type<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">selectBlock</span><span class="token punctuation">(</span>
      descriptor<span class="token punctuation">,</span>
      loaderContext<span class="token punctuation">,</span>
      incomingQuery<span class="token punctuation">,</span>
      <span class="token operator">!</span><span class="token operator">!</span>options<span class="token punctuation">.</span>appendExtension
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">//...</span>
  <span class="token keyword">return</span> code<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span>exports<span class="token punctuation">.</span>VueLoaderPlugin <span class="token operator">=</span> plugin<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br></div></div><p>第二次运行时由于路径已经带上了 <code>type</code> 参数，会命中上面第26行的判断语句，进入 <code>selectBlock</code> 函数，这个函数的逻辑很简单：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">selectBlock</span> <span class="token punctuation">(</span>
  <span class="token parameter">descriptor<span class="token punctuation">,</span>
  loaderContext<span class="token punctuation">,</span>
  query<span class="token punctuation">,</span>
  appendExtension</span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// template</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>query<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">template</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>appendExtension<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      loaderContext<span class="token punctuation">.</span>resourcePath <span class="token operator">+=</span> <span class="token string">'.'</span> <span class="token operator">+</span> <span class="token punctuation">(</span>descriptor<span class="token punctuation">.</span>template<span class="token punctuation">.</span>lang <span class="token operator">||</span> <span class="token string">'html'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    loaderContext<span class="token punctuation">.</span><span class="token function">callback</span><span class="token punctuation">(</span>
      <span class="token keyword">null</span><span class="token punctuation">,</span>
      descriptor<span class="token punctuation">.</span>template<span class="token punctuation">.</span>content<span class="token punctuation">,</span>
      descriptor<span class="token punctuation">.</span>template<span class="token punctuation">.</span>map
    <span class="token punctuation">)</span>
    <span class="token keyword">return</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// script</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>query<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">script</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>appendExtension<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      loaderContext<span class="token punctuation">.</span>resourcePath <span class="token operator">+=</span> <span class="token string">'.'</span> <span class="token operator">+</span> <span class="token punctuation">(</span>descriptor<span class="token punctuation">.</span>script<span class="token punctuation">.</span>lang <span class="token operator">||</span> <span class="token string">'js'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    loaderContext<span class="token punctuation">.</span><span class="token function">callback</span><span class="token punctuation">(</span>
      <span class="token keyword">null</span><span class="token punctuation">,</span>
      descriptor<span class="token punctuation">.</span>script<span class="token punctuation">.</span>content<span class="token punctuation">,</span>
      descriptor<span class="token punctuation">.</span>script<span class="token punctuation">.</span>map
    <span class="token punctuation">)</span>
    <span class="token keyword">return</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// styles</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>query<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">style</span><span class="token template-punctuation string">`</span></span> <span class="token operator">&amp;&amp;</span> query<span class="token punctuation">.</span>index <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> style <span class="token operator">=</span> descriptor<span class="token punctuation">.</span>styles<span class="token punctuation">[</span>query<span class="token punctuation">.</span>index<span class="token punctuation">]</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>appendExtension<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      loaderContext<span class="token punctuation">.</span>resourcePath <span class="token operator">+=</span> <span class="token string">'.'</span> <span class="token operator">+</span> <span class="token punctuation">(</span>style<span class="token punctuation">.</span>lang <span class="token operator">||</span> <span class="token string">'css'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    loaderContext<span class="token punctuation">.</span><span class="token function">callback</span><span class="token punctuation">(</span>
      <span class="token keyword">null</span><span class="token punctuation">,</span>
      style<span class="token punctuation">.</span>content<span class="token punctuation">,</span>
      style<span class="token punctuation">.</span>map
    <span class="token punctuation">)</span>
    <span class="token keyword">return</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// custom</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>query<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">'custom'</span> <span class="token operator">&amp;&amp;</span> query<span class="token punctuation">.</span>index <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> block <span class="token operator">=</span> descriptor<span class="token punctuation">.</span>customBlocks<span class="token punctuation">[</span>query<span class="token punctuation">.</span>index<span class="token punctuation">]</span>
    loaderContext<span class="token punctuation">.</span><span class="token function">callback</span><span class="token punctuation">(</span>
      <span class="token keyword">null</span><span class="token punctuation">,</span>
      block<span class="token punctuation">.</span>content<span class="token punctuation">,</span>
      block<span class="token punctuation">.</span>map
    <span class="token punctuation">)</span>
    <span class="token keyword">return</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br></div></div><p>至此，就可以完成从 Vue SFC 文件中抽取特定 Block 内容，并复用用户定义的其它 Loader 加载这些 Block。</p> <p>综上，我们可以将 <code>vue-loader</code> 的核心逻辑总结为：</p> <ol><li>首先给原始文件路径增加不同的参数，后续配合 <code>resourceQuery</code> 参数就可以分开处理这些内容，这样的实现相比于一次性处理，逻辑更清晰简洁，更容易理解；</li> <li>经过 Normal Loader、Pitch Loader 两个阶段后，SFC 内容会被转化为 <code>import xxx from '!-babel-loader!vue-loader?xxx'</code> 格式的引用路径，以此复用用户配置。</li></ol> <h2 id="小结"><a href="#小结" class="header-anchor">#</a> 小结</h2> <ul><li>Loader 主要负责将资源内容转译为 Webpack 能够理解、处理的标准 JavaScript 形式，所以通常需要做 Loader 内通过 <code>return</code>/<code>this.callback</code> 方式返回翻译结果；</li> <li>Loader Context 提供了许多实用接口，我们可以借助这些接口读取上下文信息，或改变 Webpack 运行状态(相当于产生 Side Effect，例如通过 <code>emitFile</code> 接口)；</li> <li>假若我们开发的 Loader 需要对外提供配置选项，建议使用 <code>schema-utils</code> 校验配置参数是否合法；</li> <li>假若 Loader 需要生成额外的资源文件，建议使用 <code>loader-utils</code> 拼接产物路径；</li> <li>执行时，Webpack 会按照 <code>use</code> 定义的顺序从前到后执行 Pitch Loader，从后到前执行 Normal Loader，我们可以将一些预处理逻辑放在 Pitch 中(如 <code>vue-loader</code>)；</li></ul></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/blog/devops/webpack/hmr.html" class="prev">
        HMR 热更新
      </a></span> <span class="next"><a href="/blog/devops/webpack/plugin.html">
        Webpack Plugin
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----><!----><!----><!----></div></div>
    <script src="/blog/assets/js/app.b3209530.js" defer></script><script src="/blog/assets/js/2.8bf77cff.js" defer></script><script src="/blog/assets/js/47.7ca653b7.js" defer></script><script src="/blog/assets/js/4.ff6074e9.js" defer></script>
  </body>
</html>
