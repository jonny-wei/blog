<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Webpack 相关 | 前端那些事儿</title>
    <meta name="generator" content="VuePress 1.9.10">
    <link rel="icon" href="/blog/logo.png">
    <link rel="manifest" href="/blog/manifest.json">
    <link rel="apple-touch-icon" href="/blog/images/icons/apple-icon-152x152.png">
    <meta name="description" content="我命由我不由天，学习吧少年">
    <meta name="theme-color" content="#3eaf7c">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="msapplication-TileImage" content="/icons/ms-icon-144x144.png">
    <meta name="msapplication-TileColor" content="#000000">
    
    <link rel="preload" href="/blog/assets/css/0.styles.f0017422.css" as="style"><link rel="preload" href="/blog/assets/js/app.41ab4ac0.js" as="script"><link rel="preload" href="/blog/assets/js/2.dec2e75d.js" as="script"><link rel="preload" href="/blog/assets/js/1.5b9e135c.js" as="script"><link rel="preload" href="/blog/assets/js/127.df3fbc12.js" as="script"><link rel="preload" href="/blog/assets/js/20.badbb211.js" as="script"><link rel="prefetch" href="/blog/assets/js/10.cc7e09f3.js"><link rel="prefetch" href="/blog/assets/js/100.59df3461.js"><link rel="prefetch" href="/blog/assets/js/101.cd12a926.js"><link rel="prefetch" href="/blog/assets/js/102.ac04f52a.js"><link rel="prefetch" href="/blog/assets/js/103.3af098c4.js"><link rel="prefetch" href="/blog/assets/js/104.95f08932.js"><link rel="prefetch" href="/blog/assets/js/105.51d5c599.js"><link rel="prefetch" href="/blog/assets/js/106.c36d37bb.js"><link rel="prefetch" href="/blog/assets/js/107.65ac35b9.js"><link rel="prefetch" href="/blog/assets/js/108.6280764a.js"><link rel="prefetch" href="/blog/assets/js/109.170a9b02.js"><link rel="prefetch" href="/blog/assets/js/11.b60c9933.js"><link rel="prefetch" href="/blog/assets/js/110.489315f4.js"><link rel="prefetch" href="/blog/assets/js/111.7001a037.js"><link rel="prefetch" href="/blog/assets/js/112.c5825e87.js"><link rel="prefetch" href="/blog/assets/js/113.b2e95945.js"><link rel="prefetch" href="/blog/assets/js/114.32860076.js"><link rel="prefetch" href="/blog/assets/js/115.84165f18.js"><link rel="prefetch" href="/blog/assets/js/116.f8ba423b.js"><link rel="prefetch" href="/blog/assets/js/117.77f6ca17.js"><link rel="prefetch" href="/blog/assets/js/118.51424c74.js"><link rel="prefetch" href="/blog/assets/js/119.769451af.js"><link rel="prefetch" href="/blog/assets/js/12.c53283e7.js"><link rel="prefetch" href="/blog/assets/js/120.133672bc.js"><link rel="prefetch" href="/blog/assets/js/121.75fdfed1.js"><link rel="prefetch" href="/blog/assets/js/122.777a3a3e.js"><link rel="prefetch" href="/blog/assets/js/123.e9084f07.js"><link rel="prefetch" href="/blog/assets/js/124.e1ea02a6.js"><link rel="prefetch" href="/blog/assets/js/125.1e9d4cf9.js"><link rel="prefetch" href="/blog/assets/js/126.b901aabd.js"><link rel="prefetch" href="/blog/assets/js/128.56fa0da4.js"><link rel="prefetch" href="/blog/assets/js/129.967a6118.js"><link rel="prefetch" href="/blog/assets/js/13.6bdc6b5d.js"><link rel="prefetch" href="/blog/assets/js/130.a8ee1510.js"><link rel="prefetch" href="/blog/assets/js/131.a4636541.js"><link rel="prefetch" href="/blog/assets/js/132.8edf7dff.js"><link rel="prefetch" href="/blog/assets/js/133.88f7b1f4.js"><link rel="prefetch" href="/blog/assets/js/134.b3a2005a.js"><link rel="prefetch" href="/blog/assets/js/135.9b590269.js"><link rel="prefetch" href="/blog/assets/js/136.81b09335.js"><link rel="prefetch" href="/blog/assets/js/137.7592d9f8.js"><link rel="prefetch" href="/blog/assets/js/138.9165d13e.js"><link rel="prefetch" href="/blog/assets/js/139.b6f78c29.js"><link rel="prefetch" href="/blog/assets/js/14.c3201a23.js"><link rel="prefetch" href="/blog/assets/js/140.92e6e554.js"><link rel="prefetch" href="/blog/assets/js/141.1ba7e022.js"><link rel="prefetch" href="/blog/assets/js/142.01b4cd1a.js"><link rel="prefetch" href="/blog/assets/js/143.22a5c2e5.js"><link rel="prefetch" href="/blog/assets/js/144.b3350428.js"><link rel="prefetch" href="/blog/assets/js/145.97cbdcb8.js"><link rel="prefetch" href="/blog/assets/js/146.3864cb47.js"><link rel="prefetch" href="/blog/assets/js/147.bc3fd878.js"><link rel="prefetch" href="/blog/assets/js/148.74b01566.js"><link rel="prefetch" href="/blog/assets/js/149.7e01e7a9.js"><link rel="prefetch" href="/blog/assets/js/15.a0b9e44e.js"><link rel="prefetch" href="/blog/assets/js/150.0d9290ef.js"><link rel="prefetch" href="/blog/assets/js/151.9364550c.js"><link rel="prefetch" href="/blog/assets/js/152.705da1b4.js"><link rel="prefetch" href="/blog/assets/js/153.20a0e01c.js"><link rel="prefetch" href="/blog/assets/js/154.314a51db.js"><link rel="prefetch" href="/blog/assets/js/155.7188da21.js"><link rel="prefetch" href="/blog/assets/js/156.f3568a61.js"><link rel="prefetch" href="/blog/assets/js/157.1b67520b.js"><link rel="prefetch" href="/blog/assets/js/158.dcfdaf89.js"><link rel="prefetch" href="/blog/assets/js/159.777613f3.js"><link rel="prefetch" href="/blog/assets/js/16.491191e4.js"><link rel="prefetch" href="/blog/assets/js/160.3e1dc20c.js"><link rel="prefetch" href="/blog/assets/js/161.8f675fb2.js"><link rel="prefetch" href="/blog/assets/js/162.621bdaed.js"><link rel="prefetch" href="/blog/assets/js/163.5e134e2e.js"><link rel="prefetch" href="/blog/assets/js/164.e0958eb9.js"><link rel="prefetch" href="/blog/assets/js/165.dbce16c1.js"><link rel="prefetch" href="/blog/assets/js/166.5adac212.js"><link rel="prefetch" href="/blog/assets/js/167.abb1e76a.js"><link rel="prefetch" href="/blog/assets/js/168.8fcf9af4.js"><link rel="prefetch" href="/blog/assets/js/169.44097da4.js"><link rel="prefetch" href="/blog/assets/js/17.89ec8c57.js"><link rel="prefetch" href="/blog/assets/js/170.351a1780.js"><link rel="prefetch" href="/blog/assets/js/171.52aec2d3.js"><link rel="prefetch" href="/blog/assets/js/172.30dab0a4.js"><link rel="prefetch" href="/blog/assets/js/173.aa81e120.js"><link rel="prefetch" href="/blog/assets/js/174.e58ef7f0.js"><link rel="prefetch" href="/blog/assets/js/175.47059761.js"><link rel="prefetch" href="/blog/assets/js/176.0afd5c25.js"><link rel="prefetch" href="/blog/assets/js/177.cb0a46b0.js"><link rel="prefetch" href="/blog/assets/js/178.b4dd86da.js"><link rel="prefetch" href="/blog/assets/js/179.94ffa8b2.js"><link rel="prefetch" href="/blog/assets/js/18.b91f1411.js"><link rel="prefetch" href="/blog/assets/js/180.23b616e3.js"><link rel="prefetch" href="/blog/assets/js/181.8e64c67d.js"><link rel="prefetch" href="/blog/assets/js/182.335f6f83.js"><link rel="prefetch" href="/blog/assets/js/183.c3a0fec5.js"><link rel="prefetch" href="/blog/assets/js/184.3f7a1d73.js"><link rel="prefetch" href="/blog/assets/js/185.892b6ea9.js"><link rel="prefetch" href="/blog/assets/js/186.77e0b7ff.js"><link rel="prefetch" href="/blog/assets/js/187.02d69278.js"><link rel="prefetch" href="/blog/assets/js/188.883dd8b7.js"><link rel="prefetch" href="/blog/assets/js/189.5633083c.js"><link rel="prefetch" href="/blog/assets/js/19.cb1f17c8.js"><link rel="prefetch" href="/blog/assets/js/190.d3bb609f.js"><link rel="prefetch" href="/blog/assets/js/191.5a9fb197.js"><link rel="prefetch" href="/blog/assets/js/192.5e5bee70.js"><link rel="prefetch" href="/blog/assets/js/193.fa9740bb.js"><link rel="prefetch" href="/blog/assets/js/194.1d1dadab.js"><link rel="prefetch" href="/blog/assets/js/195.b4d73a36.js"><link rel="prefetch" href="/blog/assets/js/196.582f6b94.js"><link rel="prefetch" href="/blog/assets/js/197.7d9a9096.js"><link rel="prefetch" href="/blog/assets/js/198.d078f860.js"><link rel="prefetch" href="/blog/assets/js/199.568ecfbf.js"><link rel="prefetch" href="/blog/assets/js/200.3ff24e17.js"><link rel="prefetch" href="/blog/assets/js/201.4b0b5a95.js"><link rel="prefetch" href="/blog/assets/js/202.aa0eca9d.js"><link rel="prefetch" href="/blog/assets/js/203.035984a9.js"><link rel="prefetch" href="/blog/assets/js/204.196be674.js"><link rel="prefetch" href="/blog/assets/js/205.0f81699b.js"><link rel="prefetch" href="/blog/assets/js/206.cb8e1f5b.js"><link rel="prefetch" href="/blog/assets/js/207.e022396a.js"><link rel="prefetch" href="/blog/assets/js/208.f3230c62.js"><link rel="prefetch" href="/blog/assets/js/209.92015cd4.js"><link rel="prefetch" href="/blog/assets/js/21.bf0041b7.js"><link rel="prefetch" href="/blog/assets/js/210.64a6d8b7.js"><link rel="prefetch" href="/blog/assets/js/211.74ce075e.js"><link rel="prefetch" href="/blog/assets/js/212.3595b5ac.js"><link rel="prefetch" href="/blog/assets/js/213.9f9afdac.js"><link rel="prefetch" href="/blog/assets/js/214.14875542.js"><link rel="prefetch" href="/blog/assets/js/215.76cf1e09.js"><link rel="prefetch" href="/blog/assets/js/216.c3283539.js"><link rel="prefetch" href="/blog/assets/js/217.71a089eb.js"><link rel="prefetch" href="/blog/assets/js/218.e5b96a8e.js"><link rel="prefetch" href="/blog/assets/js/219.d606121f.js"><link rel="prefetch" href="/blog/assets/js/22.48390d4f.js"><link rel="prefetch" href="/blog/assets/js/220.6bbbef56.js"><link rel="prefetch" href="/blog/assets/js/221.15df4558.js"><link rel="prefetch" href="/blog/assets/js/222.2c51cfe0.js"><link rel="prefetch" href="/blog/assets/js/223.5b2848c8.js"><link rel="prefetch" href="/blog/assets/js/224.80566daa.js"><link rel="prefetch" href="/blog/assets/js/23.35c4ba93.js"><link rel="prefetch" href="/blog/assets/js/24.cc3b12df.js"><link rel="prefetch" href="/blog/assets/js/25.632a83cc.js"><link rel="prefetch" href="/blog/assets/js/26.8ee6fdf8.js"><link rel="prefetch" href="/blog/assets/js/27.067ef541.js"><link rel="prefetch" href="/blog/assets/js/28.9d3cf283.js"><link rel="prefetch" href="/blog/assets/js/29.1585b3e4.js"><link rel="prefetch" href="/blog/assets/js/3.cb0627fa.js"><link rel="prefetch" href="/blog/assets/js/30.478b21d2.js"><link rel="prefetch" href="/blog/assets/js/31.6ae5d6bc.js"><link rel="prefetch" href="/blog/assets/js/32.e0a6568c.js"><link rel="prefetch" href="/blog/assets/js/33.32a5bc4c.js"><link rel="prefetch" href="/blog/assets/js/34.8505495a.js"><link rel="prefetch" href="/blog/assets/js/35.9587506d.js"><link rel="prefetch" href="/blog/assets/js/36.1142671d.js"><link rel="prefetch" href="/blog/assets/js/37.fe0b4168.js"><link rel="prefetch" href="/blog/assets/js/38.35e98df7.js"><link rel="prefetch" href="/blog/assets/js/39.01fc841b.js"><link rel="prefetch" href="/blog/assets/js/4.cbb57fa7.js"><link rel="prefetch" href="/blog/assets/js/40.5d83aef7.js"><link rel="prefetch" href="/blog/assets/js/41.42bcfcb2.js"><link rel="prefetch" href="/blog/assets/js/42.22b2ea87.js"><link rel="prefetch" href="/blog/assets/js/43.07d0541b.js"><link rel="prefetch" href="/blog/assets/js/44.0c17513c.js"><link rel="prefetch" href="/blog/assets/js/45.b795f41c.js"><link rel="prefetch" href="/blog/assets/js/46.c885282c.js"><link rel="prefetch" href="/blog/assets/js/47.0453ff86.js"><link rel="prefetch" href="/blog/assets/js/48.15365f7f.js"><link rel="prefetch" href="/blog/assets/js/49.bc2afccd.js"><link rel="prefetch" href="/blog/assets/js/5.fe065607.js"><link rel="prefetch" href="/blog/assets/js/50.d0df511a.js"><link rel="prefetch" href="/blog/assets/js/51.b335c9bb.js"><link rel="prefetch" href="/blog/assets/js/52.22d13c9a.js"><link rel="prefetch" href="/blog/assets/js/53.bea77bac.js"><link rel="prefetch" href="/blog/assets/js/54.1e1ac697.js"><link rel="prefetch" href="/blog/assets/js/55.b8be440d.js"><link rel="prefetch" href="/blog/assets/js/56.43a66ebd.js"><link rel="prefetch" href="/blog/assets/js/57.c654e3f6.js"><link rel="prefetch" href="/blog/assets/js/58.a0879de6.js"><link rel="prefetch" href="/blog/assets/js/59.aa4f40f1.js"><link rel="prefetch" href="/blog/assets/js/6.68cda050.js"><link rel="prefetch" href="/blog/assets/js/60.fd3d88ca.js"><link rel="prefetch" href="/blog/assets/js/61.ea01bbda.js"><link rel="prefetch" href="/blog/assets/js/62.7b0619c0.js"><link rel="prefetch" href="/blog/assets/js/63.e8d268a6.js"><link rel="prefetch" href="/blog/assets/js/64.10f55bc1.js"><link rel="prefetch" href="/blog/assets/js/65.d830848d.js"><link rel="prefetch" href="/blog/assets/js/66.2d4e24b5.js"><link rel="prefetch" href="/blog/assets/js/67.365908b4.js"><link rel="prefetch" href="/blog/assets/js/68.0427eb67.js"><link rel="prefetch" href="/blog/assets/js/69.1d45db14.js"><link rel="prefetch" href="/blog/assets/js/7.3b8d63a0.js"><link rel="prefetch" href="/blog/assets/js/70.29b522ad.js"><link rel="prefetch" href="/blog/assets/js/71.ef1fef96.js"><link rel="prefetch" href="/blog/assets/js/72.3e6b54aa.js"><link rel="prefetch" href="/blog/assets/js/73.ed15ce54.js"><link rel="prefetch" href="/blog/assets/js/74.218d3182.js"><link rel="prefetch" href="/blog/assets/js/75.90e06085.js"><link rel="prefetch" href="/blog/assets/js/76.566bdd84.js"><link rel="prefetch" href="/blog/assets/js/77.4de2aa95.js"><link rel="prefetch" href="/blog/assets/js/78.34148706.js"><link rel="prefetch" href="/blog/assets/js/79.69934743.js"><link rel="prefetch" href="/blog/assets/js/80.9a834463.js"><link rel="prefetch" href="/blog/assets/js/81.7267fc04.js"><link rel="prefetch" href="/blog/assets/js/82.b2fd3d9e.js"><link rel="prefetch" href="/blog/assets/js/83.8affaec3.js"><link rel="prefetch" href="/blog/assets/js/84.8d0b241f.js"><link rel="prefetch" href="/blog/assets/js/85.16b15a0e.js"><link rel="prefetch" href="/blog/assets/js/86.ef5f7196.js"><link rel="prefetch" href="/blog/assets/js/87.d8d28b3d.js"><link rel="prefetch" href="/blog/assets/js/88.d70140a1.js"><link rel="prefetch" href="/blog/assets/js/89.4b9169f0.js"><link rel="prefetch" href="/blog/assets/js/90.bc378f70.js"><link rel="prefetch" href="/blog/assets/js/91.cf3aa87b.js"><link rel="prefetch" href="/blog/assets/js/92.689c049c.js"><link rel="prefetch" href="/blog/assets/js/93.7250eb45.js"><link rel="prefetch" href="/blog/assets/js/94.a4913a58.js"><link rel="prefetch" href="/blog/assets/js/95.c3b04445.js"><link rel="prefetch" href="/blog/assets/js/96.7bfe1936.js"><link rel="prefetch" href="/blog/assets/js/97.57cf5aa1.js"><link rel="prefetch" href="/blog/assets/js/98.6c66f747.js"><link rel="prefetch" href="/blog/assets/js/99.fa0cc9e5.js"><link rel="prefetch" href="/blog/assets/js/vendors~docsearch.bd3cdb54.js">
    <link rel="stylesheet" href="/blog/assets/css/0.styles.f0017422.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/blog/" class="home-link router-link-active"><img src="/blog/logo.png" alt="前端那些事儿" class="logo"> <span class="site-name can-hide">前端那些事儿</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/blog/" class="nav-link">
  主页
</a></div><div class="nav-item"><a href="/blog/base/" class="nav-link">
  前端基础
</a></div><div class="nav-item"><a href="/blog/vue/" class="nav-link">
  Vue
</a></div><div class="nav-item"><a href="/blog/react/" class="nav-link">
  React
</a></div><div class="nav-item"><a href="/blog/devops/" class="nav-link router-link-active">
  前端工程化
</a></div><div class="nav-item"><a href="/blog/mobile/" class="nav-link">
  泛客户端
</a></div><div class="nav-item"><a href="/blog/architecture/" class="nav-link">
  架构与方案
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="GitHub" class="dropdown-title"><span class="title">GitHub</span> <span class="arrow down"></span></button> <button type="button" aria-label="GitHub" class="mobile-dropdown-title"><span class="title">GitHub</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/jonny-wei" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://github.com/jonny-wei/sushi-js" target="_blank" rel="noopener noreferrer" class="nav-link external">
  JS 寿司
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/blog/" class="nav-link">
  主页
</a></div><div class="nav-item"><a href="/blog/base/" class="nav-link">
  前端基础
</a></div><div class="nav-item"><a href="/blog/vue/" class="nav-link">
  Vue
</a></div><div class="nav-item"><a href="/blog/react/" class="nav-link">
  React
</a></div><div class="nav-item"><a href="/blog/devops/" class="nav-link router-link-active">
  前端工程化
</a></div><div class="nav-item"><a href="/blog/mobile/" class="nav-link">
  泛客户端
</a></div><div class="nav-item"><a href="/blog/architecture/" class="nav-link">
  架构与方案
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="GitHub" class="dropdown-title"><span class="title">GitHub</span> <span class="arrow down"></span></button> <button type="button" aria-label="GitHub" class="mobile-dropdown-title"><span class="title">GitHub</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/jonny-wei" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://github.com/jonny-wei/sushi-js" target="_blank" rel="noopener noreferrer" class="nav-link external">
  JS 寿司
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Webpack</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/devops/" aria-current="page" class="sidebar-link">Webpack 常用配置</a></li><li><a href="/blog/devops/webpack/building.html" class="sidebar-link">构建流程与原理</a></li><li><a href="/blog/devops/webpack/dependency-graph.html" class="sidebar-link">模块依赖关系</a></li><li><a href="/blog/devops/webpack/chunk.html" class="sidebar-link">产物打包逻辑</a></li><li><a href="/blog/devops/webpack/compile.html" class="sidebar-link">模块编译及运行时</a></li><li><a href="/blog/devops/webpack/hmr.html" class="sidebar-link">HMR 热更新</a></li><li><a href="/blog/devops/webpack/loader.html" class="sidebar-link">Webpack Loader</a></li><li><a href="/blog/devops/webpack/plugin.html" class="sidebar-link">Webpack Plugin</a></li><li><a href="/blog/devops/webpack/module-federation.html" class="sidebar-link">模块联邦</a></li><li><a href="/blog/devops/webpack/cache.html" class="sidebar-link">持久化缓存</a></li><li><a href="/blog/devops/webpack/parallel.html" class="sidebar-link">并行构建</a></li><li><a href="/blog/devops/webpack/split-chunks.html" class="sidebar-link">分包策略</a></li><li><a href="/blog/devops/webpack/compress.html" class="sidebar-link">代码压缩</a></li><li><a href="/blog/devops/webpack/tree-shaking.html" class="sidebar-link">Tree Shaking</a></li><li><a href="/blog/devops/webpack/others.html" aria-current="page" class="active sidebar-link">Webpack 相关</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/devops/webpack/others.html#webpack-异步加载" class="sidebar-link">Webpack 异步加载</a></li><li class="sidebar-sub-header"><a href="/blog/devops/webpack/others.html#ast-及使用场景" class="sidebar-link">AST 及使用场景</a></li><li class="sidebar-sub-header"><a href="/blog/devops/webpack/others.html#文件监听及原理" class="sidebar-link">文件监听及原理</a></li><li class="sidebar-sub-header"><a href="/blog/devops/webpack/others.html#文件指纹与缓存" class="sidebar-link">文件指纹与缓存</a></li><li class="sidebar-sub-header"><a href="/blog/devops/webpack/others.html#前端部署流程与设计" class="sidebar-link">前端部署流程与设计</a></li></ul></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Vite</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/devops/vite/esm.html" class="sidebar-link">模块化规范</a></li><li><a href="/blog/devops/vite/css.html" class="sidebar-link">CSS 工程化</a></li><li><a href="/blog/devops/vite/prebuild.html" class="sidebar-link">依赖预构建</a></li><li><a href="/blog/devops/vite/engines.html" class="sidebar-link">双引擎架构</a></li><li><a href="/blog/devops/vite/rollup.html" class="sidebar-link">Rollup 打包</a></li><li><a href="/blog/devops/vite/building.html" class="sidebar-link">Vite 构建原理</a></li><li><a href="/blog/devops/vite/plugin.html" class="sidebar-link">Vite Plugin</a></li><li><a href="/blog/devops/vite/hmr.html" class="sidebar-link">Vite HMR 热更新</a></li><li><a href="/blog/devops/vite/ssr.html" class="sidebar-link">SSR 工程化</a></li><li><a href="/blog/devops/vite/legacy.html" class="sidebar-link">兼容性问题</a></li><li><a href="/blog/devops/vite/split-code.html" class="sidebar-link">代码分割</a></li><li><a href="/blog/devops/vite/mini.html" class="sidebar-link">Vite Mini 实现</a></li><li><a href="/blog/devops/vite/vite-news.html" class="sidebar-link">Vite 新特性</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>性能优化</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/devops/performance/indicator.html" class="sidebar-link">性能指标与采集</a></li><li><a href="/blog/devops/performance/webpack.html" class="sidebar-link">打包方面优化</a></li><li><a href="/blog/devops/performance/network.html" class="sidebar-link">网络方面优化</a></li><li><a href="/blog/devops/performance/render.html" class="sidebar-link">渲染方面优化</a></li><li><a href="/blog/devops/performance/code.html" class="sidebar-link">代码方面优化</a></li><li><a href="/blog/devops/performance/analysis.html" class="sidebar-link">打包性能分析工具</a></li><li><a href="/blog/devops/performance/optimization.html" class="sidebar-link">指标性能优化</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>代码与包管理</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/devops/git/git.html" class="sidebar-link">Git</a></li><li><a href="/blog/devops/git/package.html" class="sidebar-link">包管理 及 package.json</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="webpack-相关"><a href="#webpack-相关" class="header-anchor">#</a> Webpack 相关</h1> <h2 id="webpack-异步加载"><a href="#webpack-异步加载" class="header-anchor">#</a> Webpack 异步加载</h2> <p>Webpack 异步加载原理是实现路由懒加载的基础。</p> <ul><li>Webpack 懒加载有什么效果，如何达到懒加载的效果</li> <li>Webpack 默认分包及常用的代码分割方式</li> <li>Webpack 中懒加载的原理是什么</li></ul> <h3 id="什么是懒加载"><a href="#什么是懒加载" class="header-anchor">#</a> 什么是懒加载</h3> <p>懒加载或者按需加载，是一种很好的优化网页或应用的方式。这种方式实际上是先把你的代码在一些逻辑断点处分离开，然后在一些代码块中完成某些操作后，立即引用或即将引用另外一些新的代码块。这样加快了应用的初始加载速度，减轻了它的总体体积，因为某些代码块可能永远不会被加载。</p> <p>以 Vue 为例，Vue 是单页面应用，可能会有很多的路由引入 ，这样使用 webpcak 打包后的文件很大，当进入首页时，加载的资源过多，页面会出现白屏的情况，不利于用户体验。如果我们能把不同路由对应的组件分割成不同的代码块，然后当路由被访问的时候才加载对应的组件，这样就更加高效了。这样会大大提高首屏显示的速度，但是可能其他的页面的速度就会降下来。对于每个路由都使用懒加载的方式引入，则每个模块都会被单独打为一个 js，首屏只会加载当前模块引入的 js。</p> <p>所以，懒加载的本质实际上就是代码分离。把代码分离到不同的 bundle 中，然后按需加载或并行加载这些文件。</p> <h3 id="懒加载的实现"><a href="#懒加载的实现" class="header-anchor">#</a> 懒加载的实现</h3> <p>首先回顾 Webpack 的默认分包策略：</p> <ul><li>Entry Chunk：同一个 entry 下触达到的模块组织成一个 Chunk；</li> <li>Async Chunk：异步模块单独组织为一个 Chunk；</li> <li>Runtime Chunk：entry.runtime 不为空时，会将运行时模块单独组织成一个 Chunk。</li></ul> <p>但是默认的分包策略有个弊端：无法解决模块重复。如果多个 Chunk 同时包含同一个 Module，那么这个 Module 会被不受限制地重复打包进这些 Chunk。为此，经常配合 <code>SplitChunksPlugin</code> 实现更高效、智能地实现<strong>启发式分包。</strong></p> <p>而 Webpack 异步加载就是根据 Async  Chunk，当涉及到动态代码拆分时，Webpack 提供了两个类似的技术：</p> <ul><li>使用 Webpack 特定的 <code>require.ensure</code> -  不推荐，历史遗留</li> <li><code>import()</code> 语法实现动态导入 - 推荐</li></ul> <p><code>import()</code> 的语法十分简单。该函数只接受一个参数，就是<strong>引用模块的地址</strong>，并且<strong>使用 <code>promise</code> 式的回调获取加载的模块</strong>。在代码中所有被 <code>import()</code> 的模块，都将打成一个单独的模块，放在 <code>chunk</code> 存储的目录下。在浏览器运行到这一行代码时，就会自动请求这个资源，实现异步加载。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">import</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">views/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>component<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h4 id="vue-实现路由懒加载"><a href="#vue-实现路由懒加载" class="header-anchor">#</a> Vue 实现路由懒加载</h4> <ol><li>方式一：<code>() =&gt; import()</code></li></ol> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// import UserDetails from './views/UserDetails'</span>
<span class="token keyword">const</span> <span class="token function-variable function">UserDetails</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">import</span><span class="token punctuation">(</span><span class="token comment">/* webpackChunkName: &quot;group-user&quot; */</span> <span class="token string">'./UserDetails.vue'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> router <span class="token operator">=</span> <span class="token function">createRouter</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
  routes<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span> <span class="token literal-property property">path</span><span class="token operator">:</span> <span class="token string">'/users/:id'</span><span class="token punctuation">,</span> <span class="token literal-property property">component</span><span class="token operator">:</span> UserDetails <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p><code>component</code>  配置接收一个返回 Promise 组件的函数，Vue Router 只会在第一次进入页面时才会获取这个函数，然后使用缓存数据。这意味着你也可以使用更复杂的函数，只要它们返回一个 Promise</p> <ol start="2"><li>方式二：<code>(resolve) =&gt; require([], resolve)</code></li></ol> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> router <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Router</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  routes<span class="token operator">:</span> <span class="token punctuation">[</span>
   <span class="token punctuation">{</span>
     path<span class="token operator">:</span> <span class="token string">'/list'</span><span class="token punctuation">,</span>
     <span class="token function-variable function">component</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token comment">// 这里是你的模块 不用 import 去引入了</span>
        <span class="token function">require</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'@/components/list'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> resolve<span class="token punctuation">)</span>
     <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><ol start="3"><li>方式三：<code>require.ensure</code></li></ol> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token function-variable function">List</span> <span class="token operator">=</span> <span class="token parameter">resolve</span> <span class="token operator">=&gt;</span> require<span class="token punctuation">.</span><span class="token function">ensure</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'@/components/list'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">'list'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> router <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Router</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  routes<span class="token operator">:</span> <span class="token punctuation">[</span>
  <span class="token punctuation">{</span>
    path<span class="token operator">:</span> <span class="token string">'/list'</span><span class="token punctuation">,</span>
    component<span class="token operator">:</span> List<span class="token punctuation">,</span>
    name<span class="token operator">:</span> <span class="token string">'list'</span>
  <span class="token punctuation">}</span>
 <span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>使用 webpack 的 <code>require.ensure</code> 技术，也可以实现按需加载。 这种情况下，多个路由指定相同的 <code>chunkName</code>，会合并打包成一个js文件。</p> <h4 id="react-实现路由懒加载"><a href="#react-实现路由懒加载" class="header-anchor">#</a> React 实现路由懒加载</h4> <ol><li>方式一：<code>React.lazy() + Suspense</code></li></ol> <ul><li>通过 <code>React.lzay()</code>实现组件的动态加载</li> <li><code>import()</code>拆包</li> <li>优化性能不需要一次加载全部的 js 文件</li></ul> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> BrowserRouter <span class="token keyword">as</span> Router<span class="token punctuation">,</span> Route<span class="token punctuation">,</span> Switch <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react-router-dom'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> React<span class="token punctuation">,</span> <span class="token punctuation">{</span> Suspense<span class="token punctuation">,</span> lazy <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> Home <span class="token operator">=</span> <span class="token function">lazy</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">import</span><span class="token punctuation">(</span><span class="token string">'./routes/Home'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> UserManage <span class="token operator">=</span> <span class="token function">lazy</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">import</span><span class="token punctuation">(</span><span class="token string">'./routes/UserManage'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> AssetManage <span class="token operator">=</span> <span class="token function">lazy</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">import</span><span class="token punctuation">(</span><span class="token string">'./routes/AssetManage'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> AttendanceManage <span class="token operator">=</span> <span class="token function">lazy</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">import</span><span class="token punctuation">(</span><span class="token string">'./routes/AttendanceManage'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">App</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span>
  <span class="token operator">&lt;</span>Router<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>Suspense fallback<span class="token operator">=</span><span class="token punctuation">{</span><span class="token operator">&lt;</span>div<span class="token operator">&gt;</span>Loading<span class="token operator">...</span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span><span class="token punctuation">}</span><span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span>Switch<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>Route exact path<span class="token operator">=</span><span class="token string">&quot;/&quot;</span> component<span class="token operator">=</span><span class="token punctuation">{</span>Home<span class="token punctuation">}</span><span class="token operator">/</span><span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>Route path<span class="token operator">=</span><span class="token string">&quot;/userManage&quot;</span> component<span class="token operator">=</span><span class="token punctuation">{</span>UserManage<span class="token punctuation">}</span><span class="token operator">/</span><span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>Route path<span class="token operator">=</span><span class="token string">&quot;/assetManage&quot;</span> component<span class="token operator">=</span><span class="token punctuation">{</span>AssetManage<span class="token punctuation">}</span><span class="token operator">/</span><span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>Route path<span class="token operator">=</span><span class="token string">&quot;/attendanceManage&quot;</span> component<span class="token operator">=</span><span class="token punctuation">{</span>AttendanceManage<span class="token punctuation">}</span><span class="token operator">/</span><span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span><span class="token operator">/</span>Switch<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>Suspense<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span><span class="token operator">/</span>Router<span class="token operator">&gt;</span>
<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><ol start="2"><li>方式二：使用三方包 <code>react-loadable</code></li></ol> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">'react'</span>
<span class="token keyword">import</span> loadable <span class="token keyword">from</span> <span class="token string">'react-loadable'</span> <span class="token comment">// 引入这个 loadable，使用这个来加载路由</span>

<span class="token keyword">interface</span> <span class="token class-name">Router</span> <span class="token punctuation">{</span>
  name<span class="token operator">?</span><span class="token operator">:</span> string<span class="token punctuation">,</span>
  path<span class="token operator">:</span> string<span class="token punctuation">,</span>
  children<span class="token operator">?</span><span class="token operator">:</span> Array<span class="token operator">&lt;</span>Router<span class="token operator">&gt;</span><span class="token punctuation">,</span>
  component<span class="token operator">:</span> any
<span class="token punctuation">}</span>

<span class="token keyword">const</span> <span class="token function-variable function">LoadingTip</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token operator">&lt;</span>div<span class="token operator">&gt;</span>懒加载路由ing<span class="token operator">...</span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>

<span class="token keyword">const</span> <span class="token literal-property property">router</span><span class="token operator">:</span> Array<span class="token operator">&lt;</span>Router<span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token punctuation">[</span>
  <span class="token punctuation">{</span>
    path<span class="token operator">:</span> <span class="token string">'/'</span><span class="token punctuation">,</span>
    component<span class="token operator">:</span> <span class="token function">loadable</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token function-variable function">loader</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">import</span><span class="token punctuation">(</span><span class="token string">'@/views/home'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// 需要异步加载的路由</span>
      loading<span class="token operator">:</span> LoadingTip
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    path<span class="token operator">:</span> <span class="token string">'/about'</span><span class="token punctuation">,</span>
    component<span class="token operator">:</span> <span class="token function">loadable</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token function-variable function">loader</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">import</span><span class="token punctuation">(</span><span class="token string">'@/views/about'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      loading<span class="token operator">:</span> LoadingTip
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">]</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> router
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br></div></div><h3 id="懒加载实现原理"><a href="#懒加载实现原理" class="header-anchor">#</a> 懒加载实现原理</h3> <ol><li>将需要进行懒加载的模块打包成独立的文件（async chunk）</li> <li>借助函数来实现延迟执行模块的加载代码</li></ol> <p><strong><code>__webpack_require__.e</code>方法是实现懒加载的核心</strong>，在这个方法里面处理了三件事情。</p> <ul><li>使用 JSONP 模式加载路由对应的 js文件，也可以称为chunk。</li> <li>设置 chunk 加载的三种状态并缓存在<code>installedChunks</code>中，防止chunk重复加载。
<ul><li><code>installedChunks[chunkId]</code> 为 <code>0</code> ，代表该 chunk 已经加载完毕。</li> <li><code>installedChunks[chunkId]</code> 为 <code>undefined</code> ，代表该 chunk 加载失败、加载超时、从未加载过。</li> <li><code>installedChunks[chunkId]</code> 为 <code>Promise</code> 对象，代表该 chunk 正在加载。</li></ul></li> <li>处理 chunk 加载超时和加载出错的场景。</li></ul> <h4 id="懒加载的执行流程"><a href="#懒加载的执行流程" class="header-anchor">#</a> 懒加载的执行流程</h4> <ul><li>运行主程序，加载并执行主包代码</li> <li>点击加载异步模块（懒加载模块）</li> <li>拼接对应模块路径</li> <li>动态插入 script 标签</li> <li>执行 script 脚本，调用 webpackJsonpCallback 方法</li> <li>将懒加载模块注册到 <code>__webpack_modules__</code> 中</li> <li>调用模块</li></ul> <h2 id="ast-及使用场景"><a href="#ast-及使用场景" class="header-anchor">#</a> AST 及使用场景</h2> <h3 id="ast"><a href="#ast" class="header-anchor">#</a> AST</h3> <p>抽象语法树（Abstract Syntax Tree，AST）是源代码语法结构的一种抽象表示，它以树状的形式表现编程语言的语法结构，树上的每个节点都表示源代码中的一种结构。在代码语法的检查、代码风格的检查、代码的格式化、代码的高亮、代码错误提示、代码自动补全等等场景均有广泛的应用。</p> <ul><li><p>Parsing(解析过程)：这个过程要经<code>词法分析</code>、<code>语法分析</code>、<code>构建AST（抽象语法树）</code>一系列操作；</p></li> <li><p>Transformation（转化过程）：这个过程就是将上一步解析后的内容，按照编译器指定的规则进行处理，<code>形成一个新的表现形式</code>；</p></li> <li><p>Code Generation（代码生成）：将上一步处理好的内容<code>转化为新的代码</code>；</p></li></ul> <p><img src="/blog/images/devops/ast1.png" alt="ast1"></p> <h3 id="babel"><a href="#babel" class="header-anchor">#</a> Babel</h3> <ul><li><p><strong>解析（@babel/parse）</strong>：接收代码并输出 AST。 这个步骤分为两个阶段：词法分析（Lexical Analysis） 和 语法分析（Syntactic Analysis）。<code>code（字符串形式代码） -&gt; tokens（令牌流） -&gt; AST（抽象语法树）</code></p> <ul><li>词法分析阶段把字符串形式的代码转换为 令牌（tokens） 流。</li> <li>语法分析阶段会把一个令牌流转换成 AST 的形式。 这个阶段会使用令牌中的信息把它们转换成一个 AST 的表述结构，这样更易于后续的操作。</li></ul></li> <li><p><strong>转换（@babel/traverse）</strong>：接收 AST 并对其进行遍历，在此过程中对节点进行添加、更新及移除等操作。</p> <ul><li>Babel 提供了 <code>@babel/traverse</code>（遍历）方法维护这 AST 树的整体状态，并且可完成对其的替换，删除或者增加节点，这个方法的参数为原始 AST 和自定义的转换规则，返回结果为转换后的 AST。</li></ul></li> <li><p><strong>生成（@babel/generator）</strong>：把最终（经过一系列转换之后）的 AST 转换成字符串形式的代码，同时还会创建源码映射（source maps）。</p> <ul><li>深度优先遍历整个 AST，然后构建可以表示转换后代码的字符串。</li> <li>将修改后的 AST 转换成代码，生成过程可以对是否压缩以及是否删除注释等进行配置，并且支持 sourceMap。</li></ul></li></ul> <h3 id="按需加载原理"><a href="#按需加载原理" class="header-anchor">#</a> 按需加载原理</h3> <ul><li>babel-plugin-import</li> <li>babel-plugin-component</li></ul> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> Button <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;antd&quot;</span>
<span class="token comment">// 经插件转变为</span>
<span class="token keyword">import</span> Button <span class="token keyword">from</span> <span class="token string">&quot;antd/lib/Button&quot;</span>
<span class="token keyword">const</span> Button <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;antd/lib/Button&quot;</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><ul><li>第一步：在插件中拿到我们在插件调用时传递的参数<code>libraryName</code></li> <li>第二步：获取<code>import</code>节点，找出引入模块是<code>libraryName</code>的语句</li> <li>第三步：进行批量替换旧节点</li></ul> <h4 id="按需加载插件的实现"><a href="#按需加载插件的实现" class="header-anchor">#</a> 按需加载插件的实现</h4> <p>第一步：在插件中拿到我们在插件调用时传递的参数 libraryName</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> core <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;@babel/core&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//babel核心模块 核心转换引擎</span>
<span class="token keyword">let</span> types <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;@babel/types&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//用来生成或者判断节点的AST语法树的节点</span>

<span class="token comment">// 节点处理</span>
<span class="token keyword">const</span> visitor <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token function">ImportDeclaration</span><span class="token punctuation">(</span><span class="token parameter">path<span class="token punctuation">,</span> state</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> libraryName<span class="token punctuation">,</span> libraryDirectory <span class="token operator">=</span> <span class="token string">&quot;lib&quot;</span> <span class="token punctuation">}</span> <span class="token operator">=</span> state<span class="token punctuation">.</span>opts<span class="token punctuation">;</span> <span class="token comment">//获取选项中的支持的库的名称</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    visitor<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>第二步：获取 <code>import</code> 节点，找出引入模块是 <code>libraryName</code> 的语句</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> core <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;@babel/core&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//babel核心模块</span>
<span class="token keyword">let</span> types <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;@babel/types&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//用来生成或者判断节点的AST语法树的节点</span>

<span class="token keyword">const</span> visitor <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token function">ImportDeclaration</span><span class="token punctuation">(</span><span class="token parameter">path<span class="token punctuation">,</span> state</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> libraryName<span class="token punctuation">,</span> libraryDirectory <span class="token operator">=</span> <span class="token string">&quot;lib&quot;</span> <span class="token punctuation">}</span> <span class="token operator">=</span> state<span class="token punctuation">.</span>opts<span class="token punctuation">;</span> <span class="token comment">//获取选项中的支持的库的名称</span>
   
<span class="token operator">+</span>   <span class="token keyword">const</span> <span class="token punctuation">{</span> node <span class="token punctuation">}</span> <span class="token operator">=</span> path<span class="token punctuation">;</span> <span class="token comment">//获取节点</span>
<span class="token operator">+</span>   <span class="token keyword">const</span> <span class="token punctuation">{</span> specifiers <span class="token punctuation">}</span> <span class="token operator">=</span> node<span class="token punctuation">;</span> <span class="token comment">//获取批量导入声明数组</span>
<span class="token operator">+</span>   <span class="token comment">//如果当前的节点的模块名称是我们需要的库的名称，并且导入不是默认导入才会进来</span>
<span class="token operator">+</span>   <span class="token keyword">if</span> <span class="token punctuation">(</span>
<span class="token operator">+</span>     node<span class="token punctuation">.</span>source<span class="token punctuation">.</span>value <span class="token operator">===</span> libraryName <span class="token operator">&amp;&amp;</span>
<span class="token operator">+</span>     <span class="token operator">!</span>types<span class="token punctuation">.</span><span class="token function">isImportDefaultSpecifier</span><span class="token punctuation">(</span>specifiers<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token operator">+</span>   <span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token operator">+</span>     <span class="token comment">//xxx</span>
<span class="token operator">+</span>   <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    visitor<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><p>第三步：进行批量替换旧节点</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> core <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;@babel/core&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//babel核心模块</span>
<span class="token keyword">let</span> types <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;@babel/types&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//用来生成或者判断节点的AST语法树的节点</span>

<span class="token keyword">const</span> visitor <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token function">ImportDeclaration</span><span class="token punctuation">(</span><span class="token parameter">path<span class="token punctuation">,</span> state</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> libraryName<span class="token punctuation">,</span> libraryDirectory <span class="token operator">=</span> <span class="token string">&quot;lib&quot;</span> <span class="token punctuation">}</span> <span class="token operator">=</span> state<span class="token punctuation">.</span>opts<span class="token punctuation">;</span> <span class="token comment">//获取选项中的支持的库的名称</span>
    
    <span class="token keyword">const</span> <span class="token punctuation">{</span> node <span class="token punctuation">}</span> <span class="token operator">=</span> path<span class="token punctuation">;</span> <span class="token comment">//获取节点</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> specifiers <span class="token punctuation">}</span> <span class="token operator">=</span> node<span class="token punctuation">;</span> <span class="token comment">//获取批量导入声明数组</span>
    <span class="token comment">//如果当前的节点的模块名称是我们需要的库的名称，并且导入不是默认导入才会进来</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>
      node<span class="token punctuation">.</span>source<span class="token punctuation">.</span>value <span class="token operator">===</span> libraryName <span class="token operator">&amp;&amp;</span>
      <span class="token operator">!</span>types<span class="token punctuation">.</span><span class="token function">isImportDefaultSpecifier</span><span class="token punctuation">(</span>specifiers<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token operator">+</span>     <span class="token comment">//遍历批量导入声明数组</span>
<span class="token operator">+</span>     <span class="token keyword">const</span> declarations <span class="token operator">=</span> specifiers<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">specifier</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
<span class="token operator">+</span>       <span class="token comment">//返回一个importDeclaration节点，这里也可以用template</span>
<span class="token operator">+</span>       <span class="token keyword">return</span> types<span class="token punctuation">.</span><span class="token function">importDeclaration</span><span class="token punctuation">(</span>
<span class="token operator">+</span>         <span class="token comment">//导入声明importDefaultSpecifier flatten</span>
<span class="token operator">+</span>         <span class="token punctuation">[</span>types<span class="token punctuation">.</span><span class="token function">importDefaultSpecifier</span><span class="token punctuation">(</span>specifier<span class="token punctuation">.</span>local<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token operator">+</span>         <span class="token comment">//导入模块source lodash/flatten</span>
<span class="token operator">+</span>         types<span class="token punctuation">.</span><span class="token function">stringLiteral</span><span class="token punctuation">(</span>
<span class="token operator">+</span>           libraryDirectory
<span class="token operator">+</span>             <span class="token operator">?</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>libraryName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>libraryDirectory<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>specifier<span class="token punctuation">.</span>imported<span class="token punctuation">.</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>
<span class="token operator">+</span>             <span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>libraryName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>specifier<span class="token punctuation">.</span>imported<span class="token punctuation">.</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>
<span class="token operator">+</span>         <span class="token punctuation">)</span>
<span class="token operator">+</span>       <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">+</span>     <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">+</span>     path<span class="token punctuation">.</span><span class="token function">replaceWithMultiple</span><span class="token punctuation">(</span>declarations<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//替换当前节点</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    visitor<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br></div></div><h3 id="泛型场景"><a href="#泛型场景" class="header-anchor">#</a> 泛型场景</h3> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> join<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token punctuation">,</span> <span class="token constant">W</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>a<span class="token operator">:</span> <span class="token constant">T</span><span class="token punctuation">,</span> <span class="token literal-property property">b</span><span class="token operator">:</span> <span class="token constant">W</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
join <span class="token operator">&lt;</span> number<span class="token punctuation">,</span> string <span class="token operator">&gt;</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">&quot;2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>整体思路：</p> <ul><li>第一步：先获取实参类型数组（1,'2'的类型数组：<code>[number,string]</code>）</li> <li>第二步：获取函数调用时传递的泛型类型数组（<code>[number, string]</code>）</li> <li>第三步：拿到函数定义时的泛型 [ T , W ]，然后结合第二步将 T 赋值为 number，W 赋值为 string，得到数组 <code>[T=number,W=string]</code></li> <li>第四步：计算函数定义时的形参类型数组：此时 <code>a:number，b:string =&gt; [number,string]</code></li> <li>第五步：a 的形参类型跟 a 的实参类型进行比较，b 的形参类型跟b的实参类型进行比较</li></ul> <h2 id="文件监听及原理"><a href="#文件监听及原理" class="header-anchor">#</a> 文件监听及原理</h2> <p>Webpack 会<strong>轮询判断文件的最后编辑时间是否变化</strong>，当某个文件发生了变化，并不会立刻告诉监听者，而是先缓存起来，等 <code>aggregateTimeout</code>。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>module<span class="token punctuation">.</span>export <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token comment">// 默认 false，也就是不开启</span>
  <span class="token literal-property property">watch</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token comment">// 只有开启监听模式时，watchOptions 才有意义</span>
  <span class="token literal-property property">watchOptions</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token comment">// 默认为空，不监听的文件或者文件夹，支持正则匹配</span>
    <span class="token literal-property property">ignored</span><span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">node_modules</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span>
    <span class="token comment">// 监听到变化后会等 300ms 再去执行，默认 300ms</span>
    <span class="token literal-property property">aggregateTimeout</span><span class="token operator">:</span> <span class="token number">300</span><span class="token punctuation">,</span>
    <span class="token comment">// 判断文件是否发生变化是通过不停询问系统指定文件有没有变化实现的，默认每秒（1000ms）询问 1 次</span>
    <span class="token literal-property property">poll</span><span class="token operator">:</span> <span class="token number">1000</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>每次都要刷新，有没有方法监听变化后，<code>自动更新 -&gt; 热更新</code>。</p> <p>Webpack 轮询会调用 Node.js 里面的文件读取 API <code>fs</code> 这个模块来判断文件内容是否变化。</p> <h2 id="文件指纹与缓存"><a href="#文件指纹与缓存" class="header-anchor">#</a> 文件指纹与缓存</h2> <h3 id="文件指纹"><a href="#文件指纹" class="header-anchor">#</a> 文件指纹</h3> <p>如果不利用文件指纹是无法有效利用客户端级别的缓存，因为无法判断文件是否已更改。可以通过在文件名中包含哈希来实现缓存失效。</p> <p>文件指纹通常有两个用途：</p> <ul><li><strong>版本管理：</strong> 在发布版本时，通过文件指纹来区分 修改的文件 和 未修改的文件。</li> <li><strong>使用缓存：</strong> 未修改的文件，文件指纹保持不变，浏览器继续使用缓存访问。</li></ul> <p><strong>文件指纹策略作用于服务的增量更新</strong>。</p> <p>增量更新是指在进行更新操作时，只更新需要改变的地方，不需要更新或者已经更新过的地方则不会重复更新，增量更新与完全更新相对。这种更新的概念应用范围比较广泛，凡是需要进行数据更新的地方都会用到，如软件更新、数据库更新、杀毒软件的病毒库更新、CMS 更新和路由表更新等。</p> <p>Webpack 为此提供<strong>占位符</strong>。这些字符串用于将特定信息附加到 Webpack 输出。</p> <ul><li><code>[hash]</code>：和整个项目的构建相关，只要项目文件有修改，整个项目构建的 <code>hash</code> 值就会更改。即，<code>compilation</code> 实例的变化就会触发 Hash 的变化</li> <li><code>[chunkhash]</code>：和 Webpack 打包的 <code>chunk</code> 有关，不同的 <code>entry</code> 会生成不同的 <code>chunkhash</code> 值（由于采用 <code>chunkhash</code>，所以项目主入口文件 <code>main.js</code> 及其对应的依赖文件 <code>main.css</code> 由于被打包在同一个模块，所以共用相同的 <code>chunkhash</code>，但是公共库由于是不同的模块，所以有单独的 <code>chunkhash</code>，这样就保证了在线上构建时只要文件内容没哟 u 更改就不会重复构建）</li> <li><code>[contenthash]</code>：根据文件内容来定义 <code>hash</code>，文件内容不变，则 <code>contenthash</code> 不变。一个页面内的 JS 内容、CSS 内容都会拥有自己的 Contenthash，可以保持各自的独立更新。</li></ul> <p>前两者 <code>hash</code> 和 <code>chunkhash</code> 仅用于生产目的，因为哈希值在开发期间没有太大的用处。在实际在项目中，我们一般会把项目中的 css 都抽离出对应的 css 文件来加以引用。如果我们使用 <code>chunkhash</code>，当我们改了 css 代码之后，会发现 css 文件 hash 值改变的同时，js 文件的 hash 值也会改变。所以，要用 <code>contenthash</code> 。</p> <p>使用 <code>contenthash</code> 时，往往会增加一个小模块后，整体文件的 <code>hash</code> 都发生变化，原因为<code>Webpack</code> 的 <code>module.id</code> 默认基于解析顺序自增，从而引发缓存失效。具体可通过设置 <code>optimization.moduleIds</code> 设置为 <code>'deterministic'</code> 。</p> <h3 id="缓存实践"><a href="#缓存实践" class="header-anchor">#</a> 缓存实践</h3> <p>缓存的意义就在于<strong>减少请求</strong>，更多地使用本地的资源，给用户更好的体验的同时，也减轻服务器压力。所以，最佳实践，就应该是<strong>尽可能命中强缓存，同时，能在更新版本的时候让客户端的缓存失效</strong>。</p> <p>在更新版本之后，如何让用户第一时间使用最新的资源文件呢？机智的前端们想出了一个方法，在更新版本的时候，顺便把静态资源的路径改了，即，可以利用 webpack 的文件指纹策略。这样，就相当于第一次访问这些资源，就不会存在缓存的问题了。</p> <p>一个较为合理的缓存方案：</p> <ul><li>HTML 频繁更新的资源：使用协商缓存。
<ul><li>假设 html 使用了强缓存，当我们重新上线 css、js等文件，html文件(因为css改变了，所以html要重新引入css文件，因此html也要改并且重新上线)，但是 html 使用的是强缓存，在缓存期间浏览器直接从强缓存中读取html文件，以至于你重新上线了但是还是原来的 html，内容还是原来，必须要用户强制刷新才会有新内容出现，这就不合理。所以不能使用强缓存。</li></ul></li> <li>CSS、JS、图片等静态稳定资源：使用强缓存，且文件命名带上 hash 值。
<ul><li>更新资源发布路径以实现非覆盖式发布，使强缓存失效。</li> <li>利用版本号更新策略可行吗？<code>&lt;link rel=&quot;stylesheet&quot; href=&quot;/index.css?v=1.0.2&quot;&gt;</code>在后面加个版本号，因为每次 html 都会发送请求询问是否过期，所以就可以达到缓存更新效果。但是开发不可能就引用一个 css 文件，往往是多个的。每次修改一个css 文件，其余的版本也要跟着升级，没有必要。</li></ul></li></ul> <p>既然可以使用协商缓存的 Etag，那有必要使用文件指纹吗？</p> <ul><li><strong>缓存的意义</strong>。缓存的意义就在于<strong>减少请求</strong>，更多地使用本地的资源，给用户更好的体验的同时，也减轻服务器压力。所以，最佳实践，就应该是<strong>尽可能命中强缓存，同时，能在更新版本的时候让客户端的缓存失效</strong>，访问最新资源，那么就需要文件指纹、版本号等使强缓存失效的手段。</li> <li><strong>CSS、js、图片、字体等资源要做强缓存</strong>。利用 Webpack 合理分包加上文件指纹做到客户端的持久化缓存，不去解析 DNS，不去请求服务器，<strong>减小服务端压力的同时提高用户体验</strong>。所以，文件指纹用于资源路径更新使缓存失效，达到及时拉取最新资源的目的，使用文件指纹和 Etag 没什么关系。</li> <li><strong>分布式服务不使用 Etag</strong>。分布式服务，Etag 是关闭的，因为每台机器生成的 ETag 都会不一样。</li> <li><strong>持久换缓存做无覆盖式更新</strong>。CSS、js、图片、字体等资源不需要做协商缓存，不需要每次请求服务器询问资源是否新鲜。只需要 hrml 做协商缓存即可。若发布了最新资源，由于 html 中引用的资源的路径变了，会拉取最新资源，做无覆盖式更新。</li></ul> <p>总之一句话，<strong>为减少服务器请求，资源要尽可能做强缓存，而资源的更新需要利用文件指纹变更资源路径使强缓存失效，从而达到及时拉取到最新资源的目的。所以，文件指纹是为强缓存资源服务的，与协商缓存 Etag 无任何关系</strong>。</p> <h3 id="缓存更新问题"><a href="#缓存更新问题" class="header-anchor">#</a> 缓存更新问题</h3> <p>一个较为合理的缓存方案：</p> <ul><li>HTML 频繁更新的资源：使用协商缓存。</li> <li>CSS、JS、图片等静态稳定资源：使用强缓存，且文件命名带上 hash 值。</li></ul> <h4 id="缓存更新方式一-给静态资源加版本号-通过-query-加版本号-foo-css-v-002"><a href="#缓存更新方式一-给静态资源加版本号-通过-query-加版本号-foo-css-v-002" class="header-anchor">#</a> 缓存更新方式一：给静态资源加版本号 - 通过 <code>query</code> 加版本号：<code>foo.css?v=002</code></h4> <p>优点：统一加版本号的优点是简单粗暴快捷。
缺点：假如我们只想更新 foo.css，但 bar.css 缓存也失效了，又造成了带宽的浪费。</p> <h4 id="缓存更新方式二-将文件内容与版本号-url-绑定-通过-query-hash-精准缓存控制-foo-css-v-gesd8393"><a href="#缓存更新方式二-将文件内容与版本号-url-绑定-通过-query-hash-精准缓存控制-foo-css-v-gesd8393" class="header-anchor">#</a> 缓存更新方式二：将文件内容与版本号（URL）绑定 - 通过 <code>query-hash</code> 精准缓存控制：<code>foo.css?v=gesd8393</code></h4> <p>考虑极端情况。那就是：</p> <ol><li>先部署静态资源，部署期间访问时，会出现 V1 版本 HTML 访问到 V2 版本新静态资源，并按 <code>V1-hash</code> 缓存起来。</li> <li>先部署 HTML，部署期间访问时，会出现 V2 版本 HTML 访问到 V1 版本旧静态资源，并按 <code>V2-hash</code> 缓存起来。</li></ol> <p>上面方案的问题起源于静态资源只有一份，每次发布时都是<strong>覆盖式发布</strong>，导致页面与静态资源出现匹配错误的情况！解决问题方案也极其简单，使用<strong>非覆盖式发布</strong>：即将 <code>query-hash</code> 改为 <code>name-hash</code></p> <h4 id="缓存更新方式三-利用文件指纹并非覆盖式发布"><a href="#缓存更新方式三-利用文件指纹并非覆盖式发布" class="header-anchor">#</a> 缓存更新方式三：利用文件指纹并非覆盖式发布</h4> <p>每次部署时先全量部署静态资源，再灰度部署页面，此时，服务器上会存在多份 <code>foo.[$hash].css</code> 文件,就能比较完美的解决了缓存的问题。</p> <h2 id="前端部署流程与设计"><a href="#前端部署流程与设计" class="header-anchor">#</a> 前端部署流程与设计</h2> <h3 id="静态资源组织"><a href="#静态资源组织" class="header-anchor">#</a> 静态资源组织</h3> <ol><li>为了最大程度利用缓存，将页面入口(<code>HTML</code>)设置为协商缓存，将 <code>JavaScript</code>、<code>CSS</code> 等静态资源设置为永久强缓存。</li> <li>为了解决强缓存更新问题，将文件摘要（<code>hash</code>）作为资源路径(<code>URL</code>)构成的一部分。</li> <li>为了解决覆盖式发布引发的问题，采用 <code>name-hash</code> 而非 <code>query-hash</code> 的组织方式，具体需要配置 <code>Wbpack</code> 的 <code>output.filename</code> 为 <code>contenthash</code> 。</li> <li>为了解决 <code>Nginx</code> 目录存储过大 + 结合 <code>CDN</code> 提升访问速度，采用了 <code>Nginx 反向代理</code>+ 将静态资源上传到 <code>CDN</code>。</li> <li>为了上传 <code>CDN</code>，我们需要按环境动态构造 <code>publicPath</code> + 按环境构造 <code>CDN</code> 上传目录并上传。</li> <li>为了动态构造 <code>publicPath</code> 并且随构建过程插入到 <code>HTML</code> 中，采用 <code>Webpack-HTML-Plugin</code> 等插件，将编译好的带 <code>hash</code> + <code>publicPath</code> 的静态资源插入到 <code>HTML</code> 中。</li> <li>为了保证上传 <code>CDN</code> 的安全，我们需要一种机制管控上传 <code>CDN</code> 秘钥，而非简单的将秘钥写到代码 / <code>Dockerfile</code> 等明文文件中。</li></ol> <h3 id="自动化构建"><a href="#自动化构建" class="header-anchor">#</a> 自动化构建</h3> <ol><li>拉取远程仓库</li> <li>切换到 XX 分支</li> <li>代码安全检查（非必选）、单元测试等等</li> <li>安装 <code>npm/yarn</code> 依赖
<ul><li>设置 <code>node</code> 版本</li> <li>设置 <code>npm/yarn</code> 源</li> <li>安装依赖等</li></ul></li> <li>执行编译 &amp; 构建</li> <li>产物检查（比如检测打包后 <code>JS</code> 文件 / 图片大小、产物是否安全等，保证产物质量，非必选）</li> <li>人工卡点（非必选，如必须 <code>Leader</code> 审批通过才能继续）</li> <li>打包上传 <code>CDN</code></li> <li>自动化测试（非必选，<code>e2e</code>）</li> <li>配套剩余其他步骤</li> <li>通知构建完成</li></ol> <p>业界有一些解决方案：</p> <ul><li>保证环境一致性：<a href="https://link.juejin.cn?target=http%3A%2F%2Fwww.ruanyifeng.com%2Fblog%2F2018%2F02%2Fdocker-tutorial.html" target="_blank" rel="noopener noreferrer">Docker<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li>按流程构建：<a href="https://link.juejin.cn?target=https%3A%2F%2Fcloud.tencent.com%2Fdeveloper%2Farticle%2F1504850" target="_blank" rel="noopener noreferrer">Jenkins<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li>自动化构建触发：<a href="https://link.juejin.cn?target=https%3A%2F%2Fsegmentfault.com%2Fa%2F1190000015437514" target="_blank" rel="noopener noreferrer">Gitlab webhook<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 通知</li> <li>开始构建通知：依赖账号体系打通+ Gitlab Webhook</li> <li>构建完成通知：依赖账号体系打通</li></ul> <p>业界的大致实现，一般都为 Jenkins + Docker + GitlabWebHook。为了提升部署效率，100% 避免因部署出错，需要设计 &amp; 搭建自动化部署平台，以 Docker 等保证环境的一致性，以 Jenkins 等保证构建流程的串联。使用 es-build 等提升构建效率。</p> <h3 id="发布部署"><a href="#发布部署" class="header-anchor">#</a> 发布部署</h3> <p>前端发布服务应该包含：</p> <ul><li>环境隔离（环境标：测试、预发、生产）</li> <li>流量控制（小流量测试，ABTest、灰度上线）</li> <li>版本管理（秒级回滚、版本切换）</li></ul> <h4 id="环境隔离与流量控制的常见实现方案"><a href="#环境隔离与流量控制的常见实现方案" class="header-anchor">#</a> 环境隔离与流量控制的常见实现方案</h4> <p>我们的静态资源为非覆盖式发布，多次部署后，线上存在若干版本静态资源。实现<code>Pre</code>环境/灰度上线的思路则是：</p> <p>通过一定的机制，<strong>让特定用户访问特定静态资源版本</strong>，从而达到访问<code>Pre</code>/灰度上线的能力。</p> <h4 id="方案一-nginx-层动态转发"><a href="#方案一-nginx-层动态转发" class="header-anchor">#</a> 方案一： Nginx 层动态转发</h4> <p>静态资源部署多个版本后，开发者的通过 <code>ModHeader</code> 等浏览器插件，在<strong>请求中携带特定 Header</strong>（如xx-env=pre），在 Nginx 层消费该 Header 并动态转发到对应环境的静态资源上，实现访问不同环境下的静态资源。此时，除静态资源为特定版本外，所有环境都是生产环境，可以将变量范围控制在最小。</p> <p><img src="/blog/images/devops/cicd1.png" alt="cicd1"></p> <p>Nginx 可通过配置 rewrite 设置转发:</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>location /example <span class="token punctuation">{</span>
    rewrite ^ <span class="token variable">$cdn</span>/<span class="token variable">$http_x_xx_env</span>/index.html <span class="token builtin class-name">break</span><span class="token punctuation">;</span>
    proxy_pass <span class="token variable">$cdn</span>/prod/index.html<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment"># $http_x_xx_env 表示取自定义的 Request Header 字段 xx_env</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>优点：配置简单高效，适用于工程师。
缺点：每个用户都需要手动配置，不适用于移动端，且无法让特定用户被动精确访问某版本，配置 Header 成本过高。</p> <p>同理，也可以在 Nginx 层按一些其他规则处理，实现灰度上线的能力。</p> <ul><li>如通过一定随机数 rewrite，达到小范围随机灰度。</li> <li>获取 user-agent 并 rewrite，达到按浏览器定向灰度。</li> <li>通过 Nginx GeoIP 获取地域信息，达到按地域灰度。</li></ul> <p>但上述灰度方案配置复杂，而灰度比例 / 范围往往会配置较多，每次上线都需要运维登陆生产服务器修改，较容易出各种事故。故不推荐使用，仅供拓宽思路。</p> <h4 id="方案二-动态配置-服务端转发"><a href="#方案二-动态配置-服务端转发" class="header-anchor">#</a> 方案二：动态配置 + 服务端转发</h4> <p>而为了能随时随地调整灰度 / Pre 策略，而非依赖调整代码发版上线，此时引入配置中心的概念。</p> <p>配置中心：</p> <p>一般是独立的平台 / SDK，提供动态配置管理的解决方案，提供功能有配置管理、版本管理、权限管理、灰度发布等等。后端应用通过接口消费，故配置中心和后端解耦，可以随时修改调整配置而非重新发版。 配置中心一般是配置一个 JSON 对象。 配置中心JSON对象人工维护容易引发问题，故增加机器人来降低出错几率。</p> <p><img src="/blog/images/devops/cicd2.png" alt="cicd2"></p> <p>主要流程为：</p> <ol><li>前端部署多个版本静态资源到 CDN 上（问题？如何管控多版本静态资源？）。</li> <li>后端收到请求后，通过各种 Proxy 层将 Cookie 转换成用户信息。</li> <li>后端读取配置中心数据，依据用户信息判断给用户访问什么环境，加载具体环境 index.html</li> <li>后端返回给浏览器加工后的 index.html</li> <li>若需添加特定用户到 Pre 名单，只需调用机器人/Bot 等，修改配置中心，即可生效。</li></ol> <p>此时，一些小流量配置，AB实验，版本管理其实也可以通过该方案实施。</p> <p>优点：可以随时调整，不用后端发版，移动端也可生效。
缺点：</p> <ol><li>和服务端强绑定（要求用户信息，在所难免）。</li> <li>每次都需要从 <code>CDN</code> 加载 <code>HTML</code>， 有一定性能浪费。但若缓存 <code>HTML</code>，发版环节还要通知服务端，总体增加复杂度。</li> <li>若考虑 <code>CDN</code> 故障，服务端做 <code>CDN</code> 降级会增加复杂度。</li> <li>版本管理 / 小流量等为通用需求，而该方案每个后端应用都需要开发或接入。</li> <li>常见的配置中心又一般为 <code>JSON</code> 配置，比较简陋，和发版的多环境无法关联，依赖人为配置，有出错的风险（如发版 <code>v1.2501</code>，配置中心手动配置时手误改成了<code>v1.2051</code>）。</li></ol> <h4 id="前端发布服务实现与设计"><a href="#前端发布服务实现与设计" class="header-anchor">#</a> 前端发布服务实现与设计</h4> <p>上述只是几种环境管理，流量控制实现的几种常见方案，但在实际工程中或多或少有些缺陷。</p> <p>版本管理/小流量是前端部署的常见公共业务需求，应该和业务后端服务脱离，故这里提出一个新的公共服务，纯用于前端部署相关，此处将之称为 <code>Page Server</code>，用于具体的 <code>index.html</code> 文件管理 &amp; 承接 <code>Nginx</code> 流量或业务后端流量等。</p> <p>同时，鉴于版本管理、小流量策略等调整会特别频繁，每次调整不应该都登录服务器，故我们需要一个新的服务 &amp; 界面，用于操作管理版本、调整小流量等信息，并且与上述 <code>Page Server</code> 同步，此处我们将该服务称之为 <code>Page Config Web</code>。</p> <p><img src="/blog/images/devops/cicd3.png" alt="cic3"></p> <p>本质上来说，相当于有一个公用的中间服务，部署在多个集群上，与构建发布过程深度绑定，用于承接HTML 的流量，并通过 <code>Web</code> 站点设置小流量规则、版本等等，来满足多变的上线需求。
其中，<code>PageServer</code> 在承载 <code>HTML</code> 服务时，可做一些其他工作，比如：</p> <ol><li>SSR</li> <li>CDN 降级，用于 CDN 异常时直出 HTML 中将静态资源替换为可用的 CDN 站点。</li> <li>404 处理</li> <li>兜底页（比如服务出现故障，短时间内无法修复时出兜底）</li> <li>模板渲染（如做模板替换，将 query 替换到模板中等）</li> <li>特殊时期全局处理，如注入全局样式将页面全局置灰</li></ol> <p>PageConfig Web 和 PageServer 中有构建后的所有版本信息，理论上可以缓存每个版本的 HTML文件，并且为了优化性能，PageServer 中可将最新全量版本的 HTML 文件缓存到内存中，最大程度提升响应速度，其余版本存储到 Redis 等缓存中。</p> <p>下面以发布一个正式版本 v.1.0.2502 并且回滚过程为例：</p> <ol><li>代码合并，触发自动化构建，构建产物以环境（env）+版本（env） + 版本（env）+版本（version） + name-hash 方式组织，并上传到 CDN。</li> <li>构建完成后，构建脚本通知攻城狮同学、同步 PageServer、PageConfig Web 服务有新版本 v.1.0.2502 。</li> <li>攻城狮同学收到通知后，到 PageConfig Web 站点发布新版本 v.1.0.2502 （PRE），并为该版本配置 PRE 环境小流量规则，<code>xx-env = pre</code>。此时，只有设置特定 Header 才能访问该版本。</li> <li>若是 Nginx 直接转发，则攻城狮通过设置 Header 访问 PRE 版本。</li> <li>若是通过服务端转发，攻城狮通过配置中心设置 PRE 白名单，即可让用户访问 PRE 版本。</li> <li>在 PRE 版本验收完成后，攻城狮登录 PageConfig Web 站点，发布正式版本 v.1.0.2502 （不带小流量信息）。此时立即生效。</li> <li>生效后线上回归，发现有 bug，攻城狮立马登录 PageConfig Web 站点，将版本回滚为上一版本v.1.0.2501 。此时立即生效。</li></ol> <p>关于前端部署，能总结出下面几个原则/要求：</p> <ol><li><p>构建发布后，不应该被覆盖。</p></li> <li><p>构建发布后，静态资源应当永久保存在服务器/CDN 上，即只可读。</p></li> <li><p>静态资源组织上，每个版本应该按文件夹存储，做到资源收敛。这样假如真要删除时，可按版本删除。（如某个版本代码泄密）</p></li> <li><p>发布过程应该自动化，开发人员不应该直接接触服务器。</p></li> <li><p>版本切换时，也应当不接触服务器。</p></li> <li><p>版本切换能秒级生效。（如 v0.2 切换 v0.3，立即生效）。</p></li> <li><p>线上需要能同时生效多个版本，满足 AB 测试、灰度、PRE 环境等小流量需求。</p></li></ol> <h3 id="问题"><a href="#问题" class="header-anchor">#</a> 问题</h3> <h4 id="q1-如何避免前端上线-影响未刷新页面的用户"><a href="#q1-如何避免前端上线-影响未刷新页面的用户" class="header-anchor">#</a> Q1. 如何避免前端上线，影响未刷新页面的用户？</h4> <p>使用文件指纹方式组织静态资源，先上线静态资源，再上线 <code>HTML</code>。</p> <h4 id="q2-刚上线的版本发现有阻塞性-bug-如何做到秒级回滚-而非再次部署等-20-分钟甚至更久"><a href="#q2-刚上线的版本发现有阻塞性-bug-如何做到秒级回滚-而非再次部署等-20-分钟甚至更久" class="header-anchor">#</a> Q2. 刚上线的版本发现有阻塞性 bug，如何做到秒级回滚，而非再次部署等 20 分钟甚至更久？</h4> <p><code>HTML</code> 文件使用非覆盖方式存储在 <code>CDN</code> 上，搭建前端发布服务，对 HTML 按版本等做缓存加工处理。当需要回滚时，更改发布服务 <code>HTML</code> 指向即可。</p> <h4 id="q3-cdn-域名突然挂了-如何实现秒级-cdn-降级修补而非再次全部业务重新部署一次"><a href="#q3-cdn-域名突然挂了-如何实现秒级-cdn-降级修补而非再次全部业务重新部署一次" class="header-anchor">#</a> Q3. CDN 域名突然挂了，如何实现秒级 CDN 降级修补而非再次全部业务重新部署一次？</h4> <p>将静态资源传输到多个 <code>CDN</code> 上（分布式 CDN），并开发一个加载 <code>Script</code> 的 <code>SDK</code> 集成到 HTML 中。当发现 CDN 资源加载失败时，逐步降级 CDN 域名。在前端发布服务中，增加 HTML 文本处理环节，如增加 CDN 域名替换，发生异常时，在发布服务中一键设置即可。</p> <h4 id="q4-如何实现一套前端代码-发布成多套环境产物"><a href="#q4-如何实现一套前端代码-发布成多套环境产物" class="header-anchor">#</a> Q4. 如何实现一套前端代码，发布成多套环境产物？</h4> <p>使用环境变量，将当前环境、<code>CDN</code>、<code>CDN_HOST</code>、<code>Version</code>等注入环境变量中，构建时消费 &amp; 将产物上传不同的 <code>CDN</code> 即可。</p> <h4 id="q5-前端代码从-tsx-jsx-到部署上线被用户访问-中间大致会经历哪些过程"><a href="#q5-前端代码从-tsx-jsx-到部署上线被用户访问-中间大致会经历哪些过程" class="header-anchor">#</a> Q5.  前端代码从 tsx/jsx 到部署上线被用户访问，中间大致会经历哪些过程？</h4> <p>经历本地开发、远程构建打包部署、安全检查、上传 <code>CDN</code>、<code>Nginx</code>做流量转发、对静态资源做若干加工处理等过程。</p> <p><a href="https://juejin.cn/post/7017710911443959839" target="_blank" rel="noopener noreferrer">2021 年当我们聊前端部署时，我们在聊什么<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/blog/devops/webpack/tree-shaking.html" class="prev">
        Tree Shaking
      </a></span> <span class="next"><a href="/blog/devops/vite/esm.html">
        模块化规范
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----><!----><!----><!----></div></div>
    <script src="/blog/assets/js/app.41ab4ac0.js" defer></script><script src="/blog/assets/js/2.dec2e75d.js" defer></script><script src="/blog/assets/js/1.5b9e135c.js" defer></script><script src="/blog/assets/js/127.df3fbc12.js" defer></script><script src="/blog/assets/js/20.badbb211.js" defer></script>
  </body>
</html>
